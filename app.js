/* Phaser v3 */


// gyro.min.js

// **  * dat-gui JavaScript Controller Library  * http://code.google.com/p/dat-gui  * https://github.com/dataarts/dat.gui * Copyright 2011 Data Arts Team, Google Creative Lab  *  * Licensed under the Apache License, Version 2.0 (the "License");  * you may not use this file except in compliance with the License.  * You may obtain a copy of the License at   * http://www.apache.org/licenses/LICENSE-2.0

/*!  * Chart.js v2.8.0 * https://www.chartjs.org * (c) 2019 Chart.js Contributors * Released under the MIT License */

/* @preserve * Leaflet 1.7.1, a JS library for interactive maps. http://leafletjs.com * (c) 2010-2019 Vladimir Agafonkin, (c) 2010-2011 CloudMade */

// Mautic

	
// Google Tag Manager

// CodeFlask

// Prism language definition for LOGO






/*


app.js

JavaScript object to provide additional client-side features to AppShed apps.
Created by T Stauch
appshed.com


v1 (25-5-2016) First version
v1.1 (26-5-2016) Added some methods to set colors for Item Text and Background
v1.1.1 (02-06-2016) error handling, setInterval()
v1.1.2 (02-06-2016) app.addDevice()
v1.1.3 (10-06-2016) app.getRandomColor(), app.appendToVariable(), screen.setBackgroundColor
v1.1.4 (20-06-2016) Support for Device LocalIP usage
v1.1.5 (22-06-2016) Enhancements to Device class
v1.1.6 (02-07-2016) Support for IoT Board layouts
v1.1.7 (23-07-2016) Support for built-in LED, simpler device calling, stability improvements
v1.1.8 (10-08-2016) Support for findLocalDevices, blink LED
v1.2.1 (06-10-2016) aREST Pro support added. aREST local-and-cloud not supported
v1.2.2 (26-10-2016) Minor changes and additions
v1.2.3 (07-11-2016) Support for aREST Pro enhancements
v1.2.4 (12-11-2016) Send aREST Commands - multiple pin settings in one API call, servo support
v1.2.5 (15-12-2016) Tie device outputs to app variables to monitor values
v1.2.6 (20-12-2016) Event and Timer handling improvements
v1.2.7 (23-12-2016) Support for single device running a softAP (Access Point)
v1.2.8 (26-12-2016) Touch position, touchX, touchY, touchAngle etc.
v1.2.9 (11-01-2017) Logo commands
v1.3.0 (17-02-2017) Motion Driving
v1.3.1 (12-03-2017) Switching between AP and Cloud mode
v1.3.2 (29-03-2017) Loop function
v1.3.3 (01-04-2017) Form class added
v1.3.4 (05-04-2017) import (library), applyStyles, range/slider and other special inputs
v1.3.5 (09-04-2017) import improvements, accordion
v1.3.6 (17-04-2017) RGB LED, theme & import in Description
v1.3.7 (26-04-2017) Form localStorage save, aggregate functions
v1.3.8 (28-04-2017) Data Class, Aggregate, Email, Statistics, AppBuilder CSS, Blue light
v1.3.9 (05-05-2017) Data calculations, Data select, Data filters
v1.3.10 (07-05-2017) Data enhancements
v1.3.11 (14-05-2017) NeoPixel basic support
v1.3.12 (27-05-2017) UI enhancements
v1.3.13 (01-06-2017) Device supports Sketch 39 (getInfo() sends all pin values)
v1.3.14 (07-06-2017) Minor enhancements, PhoneGap/Cordova fixes
v1.3.15 (13-06-2017) AppBuilder UI enhancements
v1.3.16 (20-06-2017) Import and Theme stability enhancements
v1.3.17 (25-06-2017) app.log(), Mobile UI
v1.3.18 (30-06-2017) Mobile UI enhancements
v1.4.1 (10-07-2017) Included in UI for all users on load (no Custom JavaScript required), separated out CSS files
v1.4.2 (12-07-2017) device.togglePin(), app.ready
v1.4.3 (16-07-2017) Device.connect (with onConnected event)
v1.4.4 (17-07-2017) app.doScreenImports()
v1.4.5 (19-07-2017) moved to ./appbuilder, wrap all in window.addEvent
v1.4.6 (22-07-2017) bug fixing - Live site updated to include app.js 28-07-2017
v1.4.7 (28-07-2017) Bug fixes
v1.4.8 (01-08-2017) Connect to devices using local_ip, Device.tieAllPinsToVariables updated
v1.4.9 (01-08-2017) Device.tie() supports analog
v1.4.10 (05-08-2017) Item.addAction, hideTab(), showTab(), app.addClass(), app.removeClass(), core styles
v1.4.11 (15-08-2017) Bug fixes
v1.4.12 (30-08-2017) Phaser.io integration, doScreenOnload
v1.4.13 (09-09-2017) hideTabBar() fixed, app.loadScript() now with callback onload, app.onReady()
v1.4.14 (25-09-2017) Item.show(), Item.hide(), Item.isFormItem(), Item.getVariable(), Item.getVariableName()
v1.4.15 (28-09-2017) app.import - callback has timeout, app.repositionItems()
v1.4.16 (08-10-2017) Fixed Device.analogRead()
v1.4.17 (14-10-2017) .hidden-live, Screen.addItem, app.stopLoops()
v1.4.18 (19-10-2017) .template, Screen.addItem({template}), Item.setAction()
v1.4.19 (24-10-2017) coreStyles... Academy
v1.4.20 (25-10-2017) renamed Data.getData() to Data.rows(), JavaScript API Documentation started
v1.4.21 (25-10-2017) bug fixes: onLoad running multiple times, data.email
v1.4.22 (11-12-2017) expanding addItem template
v1.4.23 (11-02-2018) fixes to Item templates, minor bugs
v1.4.24 (12-04-2018) Board definitions stored in local storage, Item.getLargeImage(), Device.tiePinsToVariables default true
v1.4.25 (31-05-2018) Integrate Phaser, Joystick and Gyro, minify
v1.4.26 (02-06-2018) Restructure some game stuff , Improve Device performance and reconnecting
v1.4.27 (05-06-2018) addIotEvent, joystick and gyro enhancements
v1.4.28 (24-06-2018) loader fixes, Device.getPinLayout
v1.4.29 (29-07-2018) Game changes, keyboard control, Phaser styles, Device D0 support
v1.5 (18-08-2018) Improved support for Phaser and Device integration with Phaser
v1.5.1 (18-08-2018) Better support for Export web-app, Base64 joystick sounds, added app.assets, app.game.[sprite,spriteSheet,tileSprite,audio, etc], new AppShed Academy
v1.5.2 (10-10-2018) Game Maker IDE, Phaser 3
1.6.1 (31-10-2018) AppShed 3.0
1.6.2 (15-11-2018) Various Game Maker fixes, Firefox fixes /s regular expression
1.6.3 (18-11-2018) Go live, AppShed 3.0
1.6.4 (19-11-2018) Move to Open Street Map
3.0.1 (22-11-2018) Version change to match AppShed 3.0 release
3.0.2 (22-11-2018) Game changes to support Platformer
3.0.3 (28-11-2018) Fixes to Map (edit, delete)
3.0.4 (27-01-2019) Remove OpenStreetMap from app.js (loaded server side)
3.0.5 (05-02-2019) doScreenOnLoad not run in AppBuilder
3.0.6 (26-04-2019) Fixed  properties fieds, start stop, layout, indefinite spinner), joystick, pointer
3.0.7 (11-05-2019) object shortcut names, updated game tools
3.0.8 (15-05-2019) Academy course database search/browse, game items added to game from bottom up, GameObject.group as options
3.0.9 (19-05-2019) Process all game objects together (ensure correct layering), drop-downs for object selection (groups, events), Phaser 3.17.0, audio.allowSimultaneous
3.0.10 (31-05-2019) Game Maker enhancements, call functions function1() not function1.call(), params passed to funcs, fixed Text
3.0.11 (08-06-2019) Keyboard, pointer now in Events
3.0.12 (21-06-2019) Upgraded to Phaser 3.18
3.0.13 (04-07-2019) Minor fixes
3.0.14 (13-07-2019) Changes to Device.config.main props, added deviceorientation events
3.0.15 (01-12-2019) Game Maker UI and runtime fixes
3.0.16 (11-12-2019) Game Maker layering of groups and sprites in order, app.logo D1 etc support
3.0.17 (07-02-2020) IoT, Logo, Game Maker updates, logoLoop, Mautic, oee
3.0.18 (26-02-2020) Logo SERVO
3.0.19 (05-03-2020) app.A0 etc, app.device
3.0.20 (15-03-2020) academy ad changes, support pin naming convention e.g. pinD3 variable name
3.0.21 (30-05-2020) free trial tr
3.0.22 (07-08-2020) IoT Builder changes, new in-app settings, scan wifi for devices, device connection history
3.0.23 (24-10-2020) New Settings menu, Device Wifi config, Device security code, Update firmware, tie DHT pins to variables
3.0.24 (15-11-2020) OTA firmware updates, WiFi scanning
3.1.1 (10-12-2020) Improved app settings/devicve connectivity, app.config,
3.1.2 (03-01-2021) Game geometry objects
3.1.3 (08-04-2021) Updated to Leaflet 1.7.1, APP 4.0 beta, fix map bugs (preview, tab bar hidden, address search for EDU)
4.0.1 (24-04-2021) Updated UI for AppShed 4.0
4.0.2 (21-07-2021) Release 4.0 phase 1
4.0.3 (27-07-2021) Release 4.0 phase 2
4.0.4 (12-09-2021) Remove Map Point from Standard Screen, expand JavaScript editor, Blockly render fixed, Track courses/apps removed, Aviary removed, use Mutation observer instead of DomSubtreeModified, Secure https Web App and QR code
4.0.5 (21-10-2021) Bug fixes
4.0.6 (27-12-2021) Textarea requires .expand, app.iScroll()
4.0.7 (15-01-2022) CodeFlask for Logo, Help Icon, Publish alert app gallery visibility
4.0.8 (07-03-2022) CodeMirror syntax highlighting, Help Icon, Publish alert app gallery visibility
4.0.9 (14-03-2022) New Blockly editor 
4.0.10 (15-03-2022) Supporting test.appshed.com, Blockly upgrade to v7.2
4.0.11 (22-03-2022) New commands for iot firmware 70+, appjs_test in localStorage, fix AND/OR in logo, hover edit icons, Roboto font, new Courses link, cloud variables (socket), cloud variables, Warning messages in edit panel appjs_overrides
4.0.12 (07-10-2022) device.setPinMode using GPIO, Google Tag Manager GTM added, GTM events for app_initDone, app_popupContainer, AppShedUser enhanced with session API, mt-content divs
4.0.13 (17-12-2022) WebApp GTM tags, 
4.1 (22-12-2022) AppShed Automatins (asa-) AppShed Events (ase-)
4.2 (21-01-2023) Moodle Iomad EDU added
4.3 (10-02-2023) Launch config for Mautic Focus Items, DWC, ASA
4.4 (17-03-2023) Removed GPIO for aREST
4.5 (01-04-2023) UI enhancements
4.6 (30-04-2023) jQuery deepest plugin, resourcepanel, 
4.7 (19-05-2023) resourcepanel
4.8 (06-07-2023) jQuery bug deepest, Blockly editor items
4.9 (07-08-2023) Blockly inapp, course External Content
4.10 (24-09-23) iPad layout fix
4.11 (10-10-23) inAppBlockly WAIT LOOP, email verify and invalid, intro ASAs
4.12 (02-12-23) Email verifification
4.13 New QR generator, User CSV Check

HOW TO USE
app.js is available on all new apps built on AppShed. Use Custom JavaScript or JavaScript actions, prefixing everytihng with the app object
e.g. app.setBackground()


NOTES

Custom Class CustomClass
"hidden" - class to hide a tab, screen or item
"hidden-live" - hide something in the live (published) app, but visible in AppBuilder
"scroll-disabled" - add to a Screen to disabled scrolling.
"no-arrow" - add to a link to hide the navigate arrow
"title-hidden" - Hide the title field
"border-none" - remove the border - applies for Form Fields
"backgrdoun-transparent" - Set the background to be transaparent.Applies to Form Fields
"field-width-1-2" Set the width if the field within the Div. 1-2 1-4 2-4 3-4 4-4
"field-align-center" Align the field centrally within the item
"width-1-2" Set the width of the Item. 1-2 1-4 1-5 1-6 etc
"float-left" Float the item left
"float-right" Float the item to the right
"clear-left" Apply CSS clear: left to the item
"clear-right" Apply CSS clear: right to the item
"clear-both" Apply CSS clear: both to the item

Internal Custom Classes
"oee" - Only EDU editable
"oae" - Only Admin editable
__cloud - For variables, sync to cloud using socket

To automatically
import a library, add an `Item`, enter the library name into the `Text`
or `Title`
fields, and add a Custom Class "import".The library will be imported when the screen loads.It is advisable to put these `import Items`
on the home screen so they load when the app loads.


Custom JavaScript
To access the JavaScript code for the Action, find it in this object
appbuilder.app.api.phone.navigator.screenObj.javascripts[]
(Vitality, email ref 11-10-2018)
you can add/change javascript codes on current screen, 
this action not permanent, after screen refresh it will have original javascripts
each screen have javascripts object with key id of item and value actual javascripts
you can change any item to linktype jscode and href to needed jscode behind of key javascripts["key"] 
for example you can set javascript code by this line 
appbuilder.app.api.phone.navigator.screenObj.javascripts["customCodeForItem23123"] = "alert(\"js changed\")";
and set href on js action item to customCodeForItem23123  and it will show alert
Also you can get js code of any jscode item by accessing to object appbuilder.app.api.phone.navigator.screenObj.javascripts["item24150264"]   with needed itemId key


To use devices on Local LAN:
You can turn off the CSP for your entire browser in Firefox by disabling security.csp.enable in the about:config menu.
Disable security.mixed_content.block_active_content
WARNING: this will make your computer vulnerable to hacking, spam, viruses etc. Do this at your own risk.

IoT Builder & Layouts
Pins 40-46 on IoT Builder are mapped to analog pins for the device
i.e. pin 40 is mapped to A0, pin 41 to A1 ... A6
Pin 30 is mapped to D0 (since IOIO board has no pin 0)

LOGO
To show values from the board, use the DISPLAY command. 
This needs a form field named "logodisplay" that will show the values specified in  DISPLAY

EXPORT
Offline operation of the export (web-app) run from a local folder....
If a Board Layout for the device is assigned, this will not automatically be included in the export.
Manually create a file called "layoutlocal.js"
Add the following wrapper for the JSON:
    localStorage['layoutlocal']  = '..<JSON Code>..';
ALSO in index.html add the <script> tag to load this JSON... must happen BEFORE app.js
    <script src="layoutlocal.js"> .... then app.js script

iScroll
https://github.com/cubiq/iscroll

CodeFlask
To apply syntax highlighting on textarea, add the Custom Class "code"
The default language is js.
To apply a different language, add another Custom Class, e.g. language-css or language-logo
https://prismjs.com/

CodeMirror
Default version is 3.13, with no lint
Code to create editor (in default.js)
	var editor=CodeMirror.fromTextArea(document.getElementById('action_js'),
		{
			mode:document.getElementById('action_js').get("data-editor-type"),
			lineNumbers:!0,
			matchBrackets:!0,
			indentUnit:4,
			indentWithTabs:!0,
			enterMode:"keep",
			tabMode:"shift",
			readOnly:document.getElementById('action_js').get("readonly")}
	);
	document.getElementById('action_js').store("editor",editor)

Code to remove editor
document.getElementById('action_js').retrieve("editor").toTextArea()


Mautic / GTM
To track specific custom actions/events...?
https://forum.mautic.org/t/mautic-tracking-site-activities-other-than-page-view/18856/2
https://forum.mautic.org/t/mautic-tracking-site-activities-other-than-page-view/18856/4
Tracking custom events in Mautic https://www.youtube.com/watch?v=tODrdGpDPEY
https://github.com/leoschuler/gtag-mautic-event
Tracking gif has more functionality thatn mt()... e.g. annonymous users tracked with cookie
mtracking.gif?page_url=http%3a%2f%2fexample.com%2fyour_custom_page&page_title=some-cool-title&email=spam%40me.com&tags=ProductA,-ProductB
.mt-content divs for content.appshed.com landing pages/DWC

Supported Screen Size
Full AppBuilder UI, 
	min size: 1280 (tbc)


TO DO
from V1.1.5 it is not working in Android native app - needs fixing.
Query IOIO boards for setup https://iot-api.appshed.com/api/boards/4195/outputs
Docs https://iot-api.appshed.com/api/doc/
Change accelerometer to use https://github.com/tomgco/gyro.js

methods starting with _ are private methods


*/

window.appshed = {}; // global variable to hold some things outside of the app global. cannot use app.variable, as adding new tab resets app variables.
window.appshed["trExp"] = false; // will be tue once the users tr has exp

//window._app_trExp = false; // Need to save tr .
window._appjs_test = false; // If true then this is the test version of app.js

/* 
========================================================================================================
           START APPSHED
========================================================================================================
*/

// This is the launcher script. It will determine if appjs_test is required, then launch appshed

(() => {
	// use IIFE to declutter global scope

	try {
		// Make sure to capture the app when the event fires - will need it later
		window.addEvent("app", function (app) {
			window.app = app;
		});



        /*
            Update to Array.from() to handle Set iterable
            MooTools overwrites the native Array.from method
            This causes problems with Set iterable, which it cannot handle
            Causes things like Blockly to fail to generate code
        */
        var __mootoolsArrayFrom = Array.from;
        Array.from = function(a){
            var fArr = [];

            // For Set and Set Iterator objects, handle differently
            try {
                if(a && a!= undefined && 
                    (String(a.__proto__) == '[object Set]' || String(a.__proto__) == '[object Set Iterator]'))
                {
                    if(a.size > 0){
                        for(var i=0;i<a.size;a++){
                            fArr.push(a[i])
                        }
                    }
                }else{
                    fArr = __mootoolsArrayFrom(a);
                }
            } catch (error) {
                fArr = __mootoolsArrayFrom(a);
            }
            return fArr;
        }

		// on the test domain, redirect to the main domain with the querystring
		if (window.location.host.test(/test\.appshed\.com/)) {
			window.location.href =
				"https://appshed.com" +
				window.location.pathname +
				"?testappjs=1" +
				window.location.hash;
			return;
		}

		// Add query string parameters as an object to location
		window.location.params = new URLSearchParams(window.location.search);

		if (window.location.search.test(/testappjs=1/)) {
			localStorage["testappjs"] = 1;
		}
		if (window.location.search.test(/testappjs=0/)) {
			localStorage["testappjs"] = 0;
		}
		
		/* 
		========================================================================================================
				Global Functions (needed on page load)
		========================================================================================================
		*/

		window.app_hidePageLoadingMask = function () {
			// remove overflow css directive
			document.getElementsByTagName("body")[0].style.cssText = document
				.getElementsByTagName("body")[0]
				.style.cssText.replace(/overflow: hidden;/, "");
			const els = document.querySelectorAll(".mask-loading-container");
			els.forEach((el) => {
				el.remove();
			});
		};

		window.app_showPageLoadingMask = function (options) {
			var options = options || {};

			app_hidePageLoadingMask();

			var elemDiv = document.createElement("div");
			elemDiv.style.cssText =
				"position:absolute;width:100%;height:100%;left: 0px; top: 0px; z-index:2000;background:#fff;";
			elemDiv.className = "mask-loading-container";
			elemDiv.id = "page-loading-mask";

			var closeDiv = document.createElement("div");
			closeDiv.style.cssText =
				"position: absolute; top: 10px; right: 10px; cursor: pointer;";
			closeDiv.className = "mask-loading-close";
			closeDiv.innerText = "x";
			closeDiv.onclick = function () { 
				app_hidePageLoadingMask();
			};
			elemDiv.appendChild(closeDiv);

			// CSS
			elemDiv.style.cssText +=
				"opacity:" +
				(options.hasOwnProperty("opacity") ? options["opacity"] : "100") +
				"%";

			// Add mask, and stop scrolling
			document.body.appendChild(elemDiv);
			document.getElementsByTagName("body")[0].style.cssText +=
				"overflow: hidden;";

			// Message
			if (
				options.hasOwnProperty("showMessage") &&
				options.showMessage &&
				options.hasOwnProperty("messageHTML") &&
				options.messageHTML.length
			) {
				var elMessageC = document.createElement("div");
				elMessageC.style.cssText =
					"background-color: #0094d9; z-index: 2001; width: 200px; height: 100px; position: absolute; top: 50%; left: 50%; position: absolute;  transform: translate(-50%, -50%); border-radius: 14px; width: 50%; height: 50%; max-width: 720px; max-height: 300px;";
				elMessageC.className = "mask-loading-container";
				elMessageC.id = "page-loading-message";
				//elMessageC.innerHTML = '<div class="mask-loading-close" style="position: absolute; top: 10px; right: 10px">x</div>';

				var elMessageInner = document.createElement("div");
				elMessageInner.style.cssText =
					"position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);";
				elMessageInner.className = "mask-loading-message-inner";

				var elMessage = document.createElement("div");
				elMessage.style.cssText =
					"color: white;font-size: 14pt;line-height: 18pt;";
				elMessage.className = "mask-loading-message";
				elMessage.innerHTML = options.messageHTML;

				elMessageInner.appendChild(elMessage);
				elMessageC.appendChild(elMessageInner);
				document.body.appendChild(elMessageC);
			}

			// forceCloseTimeout
			if (
				options.hasOwnProperty("forceCloseTimeout") &&
				parseInt(options["forceCloseTimeout"]) > 0
			) {
				setTimeout(function () {
					app_hidePageLoadingMask();
				}, options["forceCloseTimeout"]);
			}
		}; // END app_showPageLoadingMask

		if (localStorage["testappjs"] == 1) {
			// if test is required
			// If this is  the test script
			if (window._appjs_test == true) {
				// Does the page mask need to be shown
				if (window.location.params.get("do-before-load") == "1") {
					// create and execute the function
					Function(localStorage["do-before-load-code"])();
				}

				// init AppShed again (this will set the test AppShed environment
				if (typeof app === "undefined") {
					window.addEvent("app", function (app) {
						_initAppShed(app);
					});
				} else {
					_initAppShed(app);
				}
			} else {
				// this is not the test script, but test is required, so load the test script
				var url =
					"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/test/appjs.js";
				// check if this link already present
				var currentlinks = document.getElementsByTagName("script");
				var exists = false;
				for (var j = 0; j < currentlinks.length; j++) {
					if (currentlinks[j].href == url || currentlinks[j].src == url) {
						exists = true;
					}
				}

				// inject a script element into the head
				if (!exists) {
					var fileref = document.createElement("script");
					fileref.setAttribute("type", "text/javascript");
					fileref.setAttribute("src", url);

					// capture the onload event
					fileref.onload = function () {};

					document.getElementsByTagName("head")[0].appendChild(fileref);
				}
			}
		} else {
			// test not required, so init the app

			// Does the page mask need to be shown
			if (window.location.params.get("do-before-load") == "1") {
				// create and execute the function
				Function(localStorage["do-before-load-code"])();
			}

			if (typeof app === "undefined") {
				window.addEvent("app", function (app) {
					_initAppShed(app);
				});
			} else {
				_initAppShed(app);
			}
		}
	} catch (error) {
		console.error("ERROR startup IIFE", error);
	}
})();

/* 
========================================================================================================
        app.js   Initializes  the AppShed app.js environment
========================================================================================================
*/

function _initAppShed(app) {
	try {
		/**
		 * The main object that contains everything that you use in app.js
		 *
		 * @class app
		 * @constructor
		 */

		window.app = app;

		// add the phone object
		//			var phoneOptions=document.getElementsByClassName("phone-container")[0].getOptionsFromClass("phone-options");
		//			app.phone = new appbuilder.app.Phone(phoneOptions);

		/**
		 * The version number of app.js
		 *
		 * @property version
		 * @type {String}
		 * @default "1.2.3"
		 */
		app.version = "4.13.7"; // The version number of this code

		/*		
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
______________________________________________________________________________________________________
____________
		*/

		/* app.config Holds the default config of the app. 
		This can be overwritten by Custom JavaScript
		by adding app.config with various properties to be used 
		e.g. app.config.statusIndicator.top = "10px";
		*/
		app._config = {
			statusIndicator: {
				top: "5px",
				right: "6px",
				background_color: "silver",
				border_color: "white",
				connected: {
					background_color: "#00ff00",
					border_color: "#006a12",
				},
				sending: {
					background_color: "aqua",
					border_color: "blue",
				},
			},
		};

		// APP Settings
		app._REQUIREJQUERYSCRIPTS = true;
		app._JQUERYHARDCODED = true;

		app._blockly2Workspace = null; // will save the Blockly2 object ehre
		// APP Properties
		app._actions = {}; // an object holding actions for each item. Each `key` is `idOrClassName`. Each value is an `Array`, allowing multiple actions to be stored for each `Item`
		app._ajaxqURL =
			"https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/files/ajaxqjs.js";
		app._ajaxTimeout = 4500; // default timeout for ajax queries
		app._appData = {}; // object to hold app data for other apps
		app._appIPAddresses = [];
		app._app_navigatorTop = 0;
		app._app_navigatorBottom = 0;
		app._app_settings_auto_open_callback = null; // will hold a callback function when the app settings is auto-opened
		app._app_settings_form_html = ""; // holds the HTML for the app settings form - used to extract various settings
		app._app_settings_form_jquery = null; // a jquery object made from a copy of the App Settings HTML form
		app._autoConnectDevices = true; // must the app attempt auto connecting devices
		app._autoConnectGotLocal = false;
		app._autoConnectHandle = null; // handle for the interval
		app._autoConnectInterval = 5000; // time interval for attempting auto connect
		app._autoConnectTimestamp = 0; // timestamp for that last connection attempt
		app._commonLANIPs = [
			"10.10.101.0",
			"192.168.187.0",
			"192.168.0.1",
			"192.168.1.1",
			"192.168.2.1",
			"10.0.0.1",
			"10.0.1.1",
			"10.1.1.1",
			"192.168.4.1",
			"192.168.43.1",
			"192.168.88.1",
			"192.168.10.1",
		]; // Array of common IP Address ranges IPAddress
		app._commonLANIPs = app._commonLANIPs.concat([
			"192.168.187.0",
			"10.10.100.0",
			"10.10.101.0",
		]); // Partner Factory Las.
		app._coursesFirstLoad = true; // after courses are loaded the first time, this will change to false
		app._cover1; // Used by app._openPopup
		app._cover2;
		app._currentItemId = null;
		app._currentScreen = null;
		app._currentHoverElement = null; // The DOM `Element` that is currently hovered over
		app._currentHoverItem = null; // The `Item` Object currently hovered over
		app._datasets = {}; // Object to hold all the datasets
		app._debug = true; // set to false to stop all console messages
		app._defaultAjaxTimeout = 1000; // Default timeout for Ajax requests
		app._defaultDevice = null;
		app.device; // holds the most recent device access using app.getDevice()
		app._deviceCallerFunctions =
			"attachDHT,clear,clearErrors,httpRequest,readStringEEPROM,reset,restart,setCode,setHttpUpdateBase,setWiFi,updateAvailable,updateFirmware,upxiqwkdhdga,writeStringEEPROM"; // Device functions that must go through /caller
		app._devices = {};
		app._deviceDelayBetweenInfo = 200; // the delay before calling getInfo after previous call done.
		app.disableSystemAlerts = true;
		app._DOMSubtreeModifiedChecked = 0; // the time when the subtree is checked
		app._DOMSubtreeModifiedInterval = 300; // the interval between subtree checking
		app._DOMSubtreeModifiediFramesPending = {}; // object to hold pending state for iframes that are being observed
		app._DOMSubtreeItemsModifiedInterval = 300; // the interval between subtree checking
		app._DOMSubtreeModifiedPending = false; // shows if a function call is pending
		app._DOMSubtreeItemsModifiedPending = false; // shows if a function call is pending
		app.events = {}; // holds the custom events, see APPSHED EVENTS ase-
		app._enableOrientationTracking = false; // indicates if the app should track orientation
		app._fieldIntervals = {}; // holds the ref to setInterval while polling field values
		//app._firstMapScreenDone = false; // Don't instantiate this, otherwise it is reset every time the app event fires. we only want it set once per screen load...set to true after the first map screen has been loaded
		app._firstMapScreenDone = false;
		app._firstScreenDone = false;
		app._formItemsCSSSelector =
			".screen input, .screen textarea, .screen .picker .picked, .screen .select .selected"; // The CSS Selectors to find all form Items
		app._formItemCSSSelector = "input, textarea, .picked, .selected"; // The CSS Selectors to find the form element for an individual Item
		app._formItemTypes = [
			"textbox",
			"textarea",
			"switch",
			"checkbox",
			"radio",
			"select",
			"picker",
			"capture",
		];
		app._gpioESP8266 = [16, 5, 4, 0, 2, 14, 12, 13, 15, 3, 1]; // GPIO values for the ESP89266

		app.gyro = {}; // holds the output of gyro.startTracking
		app._handler_arestScriptsInterval = null;
		app._handlerContextOpen = null; // holds the interval handler for checking context menu
		app._iframeContainerType = {}; // object to hold the current container type for each iframe
		app._importCallbackTimeout = 2000;
		app._importsDone = false;
		app._intervals = {}; // an object of all the Intervals started for the app using app.setInterval()
		app._ioBatchMode = true; // Send IO commands to devices in batches
		app._ioBatchTimeout = 100; // how long to wait while collecting IO commands (e.g. from multiple Blockly commands)
		app._ioMaxCommandsPerBatch = 4;
		app._isActiveTouchmove = false;
		app._isAPP40; // true when app40 (or later) is loaded
		app._iScroll; // holds the iScroll object
		app._items = {}; // Object to hold `Item` objects;
		app._itemsListType = ""; // holds the type of content in the Items List panel
		app._jqueryURL =
			"https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/files/jquery-320minjs.js";
		app._jqueryURL311 =
			"https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/files/jquery-311minjs.js";
		app._lastScreenId; // holder for the last screen that was accessed
		app._lastScreenInitTime; // holder for the time the last screen was init
		app._lastScrollRulesScreen = 0;
		app._latestAppHash = "#1/1"; // the default hash when appbuilder loads
		app._loadBlockly2ScriptsStart = false;
		app._loadBlockly2ScriptsDone = false; // true once all the scripts for Blockly2 have loaded
		app._log = []; // holds useful log info for the user
		app._loginHourUTC; // The UTC hour timestamp when the app init ran
		app._logMessagesSelectedDevice; // Holds the Device Object of the selected device to display in the logMessages popup
		app._logoLoopActive = false; // If true then the app.logoLoop runs on interval
		app._logoLoopDelay = 2000; // Delay between logo loops. Might be longer if request takes longer than this, as it will wait for completion
		app._logoLoopOnStartFn; // holds the function to call every time the loop runs
		app._logoLoopRunning = false;
		app._logoLoopLastRun; // Time when last logoLoop started
		app._logoLoopSettings = {}; // object containing settings for the logo loop.
		app._loopFunctions = []; // array of functions to call on loop
		app._loopTimeout = 100; // Time delay between loop calls
		app._mapbox_accessToken =
			"pk.eyJ1IjoiYXBwc2hlZGRldnRlYW0iLCJhIjoiY2pvb3ByOWduMTV6YTNxdXVzdmJwNmNnYiJ9.LNhsSp1fu3a0taJ1ert7Ng"; // Mapbox Open Street Map token
		app._onApp_id = 0; // Every time the window.addEvent('app' fires, save the app.id
		app._onceEditItem;
		app._onGameTools; // will hold a function ref to call when the Game Tools load
		app._onceGameTools; // will hold a function ref to call once when the Game Tools load, then clear the fn
		app._pinVariables = {}; // object to hold the variables that are linked to pins, e.g. pinD4
		app._popup1; // Used by app._openPopup
		app._popup2;
		app._popupContainerType = ""; // holds the type of content in the popup container (Edit and Tools Panel)
		app._popupContainerItemType = ""; // holds the item type of the item being edited
		app._popupWindowType = ""; // holds the type of popup window that has opened
		app._readyFunctions = [];
		app._readyFunctionsParams = [];
		app._responses = { identifier: [{ result: "done", a: "", b: "", c: "" }] }; // object to hold  responses from the method app._request(). Each "identifier" will contain an array of responses
		app._scanIPTimeout = 4000; // The timeout for requests when scanning local IP addresses.
		app.screen = null; // Holds the current screen object
		app._screen_el = null;
		app._screenOnLoadDone = false;
		app._screens = {}; // Object to hold `Screen` objects
		app._scripts = null;
		app._scriptLoaded_jquery = false;
		app._scriptLoaded_ajaxq = false;
		app._scriptLoading_ajaxq = false;
		app._scriptLoading_jquery = false;
		app._scriptsLoaded_arest = false;
		app.settings = {}; // holds the values from App Settings
		app.socket = null; // will hold the socket.io object when connected
		app._trExp; // Not used. See window._app_trExp. cannot use app. variable, as adding new tab resets app variables.
		app._trUIDone = false; // true after the tr UI has been applied
		app._url_boardWithPins = "https://iot-api.appshed.com/api/boards/withpins/";
		app.deviceMotionEvent = null;
		app.deviceOrientationAbsoluteEvent = null;
		app.deviceOrientationEvent = null;
		app.data = new AppShedData(); // Handles the data on the current screen
		app.id = null;
		app.isAdminUser = false; // true if this is an administrator
		app.isAppBuilder = document.getElementById("academy") !== null || false; // True if in the AppBuilder editor
		app.isPreview = false; // True if on the Preview screen
		app.isEDUActive = null; // True if they are a paid up EDU user
		app.isEDUIncomplete = null; // True if the EDU registration is incomplete (e.g. missing payment details)
		app.isEDUExpired = null; // True if the EDU subscription has expired
		app.isEDUPending = false; // true if the user came from  /academy/pending
		app.isEDUStudent = false;
		app.isEDUTeacher = false;
		app.isEDUUnpaid = null; // True if the EDU subscription is pending or expired (Dashboard is pending)
		app.isEDUUser = false;
		//app.isMobile_xxx; // Will be true when running on a supported mobile device (actual property is app.isMobile)
		app.isMobileEditor = false; // True when the editor switches to mobile mode
		//app.isPhoneGap_xxx; // Will be true when running on a phonegap platform (actual property is app.isPhoneGap)
		app.isSecure = String(window.location.href).search(/^https/) == 0; // True if the URL is https
		app.isStarter = false; // true if this is a Starter account (i.e not EDU or... TODO)
		app.isTrEDU = false; // true if currently a trial EDU
		app.isTouching = false;
		app.isWebApp = false; // True for web apps (like apps.appshed.com - but can be hosted elsewhere too)
		app.ready = false; // Will be true once initilisation complete
		app.touchStartX = 100; // The x coordinate of the touchStart point
		app.touchStartY = 100; // The y coordinate of the touchStart point
		app.touchX = 100; // The x coordinate of the current touch point
		app.touchY = 100; // The y coordinate of the current touch point
		app.touchAngle = 0; // The angle in degrees of the current touch point relative to touchStart
		app.user; // Holds the AppShedUser object

		// Properties that might already be set
		if (app.disableSystemAlerts === undefined) {
			app.disableSystemAlerts = false; // If true the system alerts won't display (messages for updates, offline etc)
		}

		/*		app._logoBuild70Commands = {
			FD : 9001,
			BK : 9002,
			LT : 9003,
			RT : 9004,
			ARCFL : 9005,
			ARCFR : 9006,
			ARCBL : 9007,
			ARCBR :908,
			ST : 9009,
			
			MAFD : 9011,
			MABK : 9012,
			MBFD : 9013,
			MBBK : 9014,
			WAIT   : 9050,
			DELAY  : 9051,
			
			D0 : 9060,
			D1 : 9061,
			D2 : 9062,
			D3 : 9063,
			D4 : 9064,
			D5 : 9065,
			D6 : 9066,
			D7 : 9067,
			D8 : 9068,
			D9 : 9069,
			
			READ_D0 : 9070,
			READ_D1 : 9071,
			READ_D2 : 9072,
			READ_D3 : 9073,
			READ_D4 : 9074,
			READ_D5 : 9075,
			READ_D7 : 9076,
			READ_D7 : 9077,
			READ_D8 : 9078,
			READ_D9 : 9079,
			
			A0 : 9080, 
			A1 : 9081, 
			A2 : 9082, 
			A3 : 9083, 
			A4 : 9084, 
			A5 : 9085, 
			A6 : 9086, 
			A7 : 9087, 
			A8 : 9088, 
			A9 : 9089, 
			
			READ_A0 : 9090, 
			READ_A1 : 9091, 
			READ_A2 : 9092, 
			READ_A3 : 9093, 
			READ_A4 : 9094, 
			READ_A5 : 9095, 
			READ_A6 : 9096, 
			READ_A7 : 9097, 
			READ_A8 : 9098, 
			READ_A9 : 9099, 
			
			
			CMD_IF_COND : 9100, // Simple IF condition has one argument, all CMD_CMP should be encapsulated in this. The code block should use a LABEL and BRANCH
			CMD_IF_NOT  : 9101, // has one argument which can be CMD_CMP or any other CMD_IF
			CMD_IF_OR   : 9102, // has two arguments each of them can either be a CMD_CMP or CMD_IF
			CMD_IF_AND  : 9103, // has two argument each of them can either be a CMD_CMP or CMD_IF
			
			CMD_CMP_NE   : 9110, // has two arguments, can be variable, READ_D0-D9, A0-A9
			CMD_CMP_EQ   : 9111, // has two arguments, can be variable, D0-D9, A0-A9
			CMD_CMP_GT   : 9112, // has two arguments, can be variable, D0-D9, A0-A9
			CMD_CMP_LT   : 9113, // has two arguments, can be variable, D0-D9, A0-A9
			CMD_CMP_GTEQ : 9114, // has two arguments, can be variable, D0-D9, A0-A9
			CMD_CMP_LTEQ : 9115, // has two arguments, can be variable, D0-D9, A0-A9
			
			// Some suggestions for future
			CMD_LABEL   : 9130,  // Will mark a return point for code
			CMD_BRANCH  : 9131, // To jump to a lable, Can be used to improve the Loop logic,
			CMD_GOTO    : 9132,   // To jump back and forth in numeric amounts of commands
			
			CMD_MAX     : 9999
		}
*/

		app.logoErrorMessages = {
			101: {
				short_description: "Statement queue is full",
				description: "",
				example: "",
			},
			102: {
				short_description: "Syntax error: command has no trailing semicolon",
				description: "",
				example: "",
			},
			103: {
				short_description: "Queue identificator not valid",
				description: "",
				example: "",
			},
			104: {
				short_description: "Command received by logo2() is too long",
				description: "",
				example: "",
			},
			105: {
				short_description: "Error in the statement (generic)",
				description: "",
				example: "",
			},
			106: {
				short_description: "Unknown statement",
				description: "",
				example: "",
			},
			107: {
				short_description:
					"Variable not found: its value can not be substituted",
				description: "",
				example: "",
			},
			111: {
				short_description:
					"Syntax error: odd number of brackets in function creation statement",
				description: "",
				example: "",
			},
			112: {
				short_description: "Function slots full",
				description: "",
				example: "",
			},
			113: {
				short_description: "Function name too long",
				description: "",
				example: "",
			},
			114: {
				short_description: "Function code too long",
				description: "",
				example: "",
			},
			115: {
				short_description: "Too many function parameters",
				description: "",
				example: "",
			},
			116: {
				short_description: "Function parameter too long",
				description: "",
				example: "",
			},
			117: {
				short_description: "Function parameter is missing :",
				description: "",
				example: "",
			},
			118: {
				short_description: "Function name not found in function call",
				description: "",
				example: "",
			},
			119: {
				short_description: "Variable as function param not exists",
				description: "",
				example: "",
			},
			120: {
				short_description: "No function found with this name",
				description: "",
				example: "",
			},
			121: {
				short_description: "Different number of function parameters: received",
				description: "",
				example: "",
			},
			122: {
				short_description: "Error during parameters retrieval",
				description: "",
				example: "",
			},
			131: {
				short_description: "WAIT/DELAY code too long",
				description: "",
				example: "",
			},
			132: {
				short_description: "Negative number not valid for WAIT/DELAY",
				description: "",
				example: "",
			},
			133: {
				short_description: "Variable not found in WAIT/DELAY command",
				description: "",
				example: "",
			},
			134: {
				short_description: "No number for WAIT/DELAY command",
				description: "",
				example: "",
			},
			135: {
				short_description: "Not valid name for WAIT/DELAY command",
				description: "",
				example: "",
			},
			136: {
				short_description: "WAIT/DELAY code is not a number",
				description: "",
				example: "",
			},
			141: {
				short_description: "Pin code too long",
				description: "",
				example: "",
			},
			142: {
				short_description: "Analog pin does not exists",
				description: "",
				example: "",
			},
			143: {
				short_description: "Digital pin does not exists",
				description: "",
				example: "",
			},
			144: {
				short_description: "No number for pin command",
				description: "",
				example: "",
			},
			145: {
				short_description: "Pin ID is not a digit (Dx)",
				description: "",
				example: "",
			},
			146: {
				short_description: "Pin code is not a number",
				description: "",
				example: "",
			},
			147: {
				short_description: "Inserted variable in pin command not existing",
				description: "",
				example: "",
			},
			148: {
				short_description: "Negative number in pin command not valid",
				description: "",
				example: "",
			},
			151: {
				short_description: "Servo code too long",
				description: "",
				example: "",
			},
			152: {
				short_description: "No number for Servo command",
				description: "",
				example: "",
			},
			153: {
				short_description: "Variable not found in Servo command",
				description: "",
				example: "",
			},
			154: {
				short_description: "Servo code is not a number",
				description: "",
				example: "",
			},
			155: {
				short_description: "Negative number not valid for Servo",
				description: "",
				example: "",
			},
			161: {
				short_description: "Var name too long",
				description: "",
				example: "",
			},
			162: {
				short_description: "Var code too long",
				description: "",
				example: "",
			},
			163: {
				short_description: "Code after variables substitution too long",
				description: "",
				example: "",
			},
			164: {
				short_description: "No var name found",
				description: "",
				example: "",
			},
			165: {
				short_description: "Var name should start with :",
				description: "",
				example: "",
			},
			166: {
				short_description: "No var code found",
				description: "",
				example: "",
			},
			167: {
				short_description: "No more space available for custom variable",
				description: "",
				example: "",
			},
			168: {
				short_description:
					"Variable not found: its value can not be substituted",
				description: "",
				example: "",
			},
			169: {
				short_description: "Make code too long",
				description: "",
				example: "",
			},
			170: {
				short_description: "Division by zero error in Make statement",
				description: "",
				example: "",
			},
			171: {
				short_description:
					"Illegal operation in the expression in Make statement",
				description: "",
				example: "",
			},
			181: {
				short_description: "If condition too long",
				description: "",
				example: "",
			},
			182: {
				short_description: "Error in the if condition",
				description: "",
				example: "",
			},
			183: {
				short_description:
					"Syntax error in the IF condition: more than 3 items",
				description: "",
				example: "",
			},
			184: {
				short_description: "IF Comparator not found",
				description: "",
				example: "",
			},
			185: {
				short_description: "Variable not found in the IF condition",
				description: "",
				example: "",
			},
			186: {
				short_description: "IF valid only with A0 pin",
				description: "",
				example: "",
			},
			187: {
				short_description: "IF valid only with D0-D8 pin",
				description: "",
				example: "",
			},
			188: {
				short_description: "Error comparing the IF condition",
				description: "",
				example: "",
			},
			191: {
				short_description: "Motor control code too long",
				description: "",
				example: "",
			},
			192: {
				short_description: "No number for Motor Control command",
				description: "",
				example: "",
			},
			193: {
				short_description: "Variable in Motor Control command not found",
				description: "",
				example: "",
			},
			194: {
				short_description: "Motor Control code is not a number",
				description: "",
				example: "",
			},
			195: {
				short_description: "Negative number not valid for Motor Control",
				description: "",
				example: "",
			},
			196: {
				short_description:
					"Number greater than 100 not valid for MAFD/MBFD/MABK/MBBK MOTOR CONTROL",
				description: "",
				example: "",
			},
			201: {
				short_description: "Repeat code too long",
				description: "",
				example: "",
			},
			202: {
				short_description: "Flattened Repeat body too long",
				description: "",
				example: "",
			},
			203: {
				short_description:
					"Too many repetitions requested or negative repetitions number",
				description: "",
				example: "",
			},
			204: {
				short_description:
					"Inserted value for number of Repeat is not a number",
				description: "",
				example: "",
			},
			205: {
				short_description: "Inserted variable for number of Repeat not exists",
				description: "",
				example: "",
			},
			206: {
				short_description: "Too many (more than 4) nested Repeat",
				description: "",
				example: "",
			},
			207: {
				short_description:
					"Syntax error: matching brackets mismatch in the Repeat statement",
				description: "",
				example: "",
			},
			500: {
				short_description: "Unrecognised characters in DISPLAY",
				description: "",
				example: "",
			},
			501: {
				short_description: "Cannot use variables in DISPLAY",
				description: "",
				example: "",
			},
			502: {
				short_description: "Reference error in DISPLAY",
				description: "",
				example: "",
			},
			503: {
				short_description: "Invalid or unexpected token in DISPLAY",
			},
		};

		/*
		app.warnings holds the definitions for the types of messages that can be logged 
		app.log() is used to log messages, which are saved in app._logs
		Messages can be warnings, erros or info messages
		*/
		app.warnings = {
			0: {
				type: 0,
				name: "General",
				initial: "There is an error in your code.",
				count: 0,
			},
			1: {
				type: 1,
				name: "JSON",
				initial: "Some of your JSON has errors.",
				count: 0,
			},
			2: {
				type: 2,
				name: "Game Setup",
				initial: "Your Game Setup has errors.",
				count: 0,
			},
			3: {
				type: 3,
				name: "Style",
				initial: "The Style object has errors.",
				count: 0,
			},
			4: {
				type: 4,
				name: "Keyboard",
				initial: "The Keyboard object has errors.",
				count: 0,
			},
			5: {
				type: 5,
				name: "Connection",
				initial: "A connection with another device/API/website has errors.",
				count: 0,
			},
			501: {
				type: 501,
				name: "JSON Info",
				initial: "JSON messages.",
				count: 0,
			},
			502: {
				type: 502,
				name: "Game Setup Info",
				initial: "Game Setup  messages.",
				count: 0,
			},
			503: {
				type: 503,
				name: "Style Info",
				initial: "Style messages.",
				count: 0,
			},
			504: {
				type: 504,
				name: "Keyboard Info",
				initial: "Keyboard messages.",
				count: 0,
			},
			505: {
				type: 505,
				name: "Connection Info",
				initial: "Connection messages.",
				count: 0,
			},
		};

		app._blockly2Toolbox = `
		<xml id="blockly2Toolbox" class="toolbox">
	<category name="AppShed">
	<block type="appshed_phone"></block>
	<block type="appshed_email"></block>
	<block type="appshed_showFile"></block>
	<block type="appshed_playSound"></block>
	<block type="appshed_showapp2"></block>
	<block type="appshed_showtab2"></block>
	<block type="appshed_showscreen2"></block>
	<block type="appshed_showremotescreen"></block>
	<block type="appshed_showweb"></block>
	<block type="appshed_showyoutube"></block>
	<block type="appshed_showvimeo"></block>
	<block type="appshed_showtwitter"></block>
	<block type="appshed_showfacebook"></block>
	<block type="appshed_showbbm"></block>
	<block type="appshed_back"></block>
	<block type="appshed_variable"></block>
	<block type="appshed_variableset"></block>
	<block type="appshed_runonce"></block>
	<block type="appshed_tabevent"></block>
	<block type="appshed_screenevent"></block>
	</category>
	
		<category name="Logic" colour="210">
		  <block type="controls_if"></block>
		  <block type="logic_compare"></block>
		  <block type="logic_operation"></block>
		  <block type="logic_negate"></block>
		  <block type="logic_boolean"></block>
		  <block type="logic_null"></block>
		  <block type="logic_ternary"></block>
		</category>
		<category name="Loops" colour="120">
		  <block type="controls_repeat_ext">
			<value name="TIMES">
			  <shadow type="math_number">
				<field name="NUM">10</field>
			  </shadow>
			</value>
		  </block>
		  <block type="controls_whileUntil"></block>
		  <block type="controls_for">
			<value name="FROM">
			  <shadow type="math_number">
				<field name="NUM">1</field>
			  </shadow>
			</value>
			<value name="TO">
			  <shadow type="math_number">
				<field name="NUM">10</field>
			  </shadow>
			</value>
			<value name="BY">
			  <shadow type="math_number">
				<field name="NUM">1</field>
			  </shadow>
			</value>
		  </block>
		  <block type="controls_forEach"></block>
		  <block type="controls_flow_statements"></block>
		</category>
		<category name="Math" colour="230">
		  <block type="math_number"></block>
		  <block type="math_arithmetic">
			<value name="A">
			  <shadow type="math_number">
				<field name="NUM">1</field>
			  </shadow>
			</value>
			<value name="B">
			  <shadow type="math_number">
				<field name="NUM">1</field>
			  </shadow>
			</value>
		  </block>
		  <block type="math_single">
			<value name="NUM">
			  <shadow type="math_number">
				<field name="NUM">9</field>
			  </shadow>
			</value>
		  </block>
		  <block type="math_trig">
			<value name="NUM">
			  <shadow type="math_number">
				<field name="NUM">45</field>
			  </shadow>
			</value>
		  </block>
		  <block type="math_constant"></block>
		  <block type="math_number_property">
			<value name="NUMBER_TO_CHECK">
			  <shadow type="math_number">
				<field name="NUM">0</field>
			  </shadow>
			</value>
		  </block>
		  <block type="math_round">
			<value name="NUM">
			  <shadow type="math_number">
				<field name="NUM">3.1</field>
			  </shadow>
			</value>
		  </block>
		  <block type="math_on_list"></block>
		  <block type="math_modulo">
			<value name="DIVIDEND">
			  <shadow type="math_number">
				<field name="NUM">64</field>
			  </shadow>
			</value>
			<value name="DIVISOR">
			  <shadow type="math_number">
				<field name="NUM">10</field>
			  </shadow>
			</value>
		  </block>
		  <block type="math_constrain">
			<value name="VALUE">
			  <shadow type="math_number">
				<field name="NUM">50</field>
			  </shadow>
			</value>
			<value name="LOW">
			  <shadow type="math_number">
				<field name="NUM">1</field>
			  </shadow>
			</value>
			<value name="HIGH">
			  <shadow type="math_number">
				<field name="NUM">100</field>
			  </shadow>
			</value>
		  </block>
		  <block type="math_random_int">
			<value name="FROM">
			  <shadow type="math_number">
				<field name="NUM">1</field>
			  </shadow>
			</value>
			<value name="TO">
			  <shadow type="math_number">
				<field name="NUM">100</field>
			  </shadow>
			</value>
		  </block>
		  <block type="math_random_float"></block>
		</category>
		<category name="Text" colour="160">
		  <block type="text"></block>
		  <block type="text_join"></block>
		  <block type="text_append">
			<value name="TEXT">
			  <shadow type="text"></shadow>
			</value>
		  </block>
		  <block type="text_length">
			<value name="VALUE">
			  <shadow type="text">
				<field name="TEXT">abc</field>
			  </shadow>
			</value>
		  </block>
		  <block type="text_isEmpty">
			<value name="VALUE">
			  <shadow type="text">
				<field name="TEXT"></field>
			  </shadow>
			</value>
		  </block>
		  <block type="text_indexOf">
			<value name="VALUE">
			  <block type="variables_get">
				<field name="VAR">text</field>
			  </block>
			</value>
			<value name="FIND">
			  <shadow type="text">
				<field name="TEXT">abc</field>
			  </shadow>
			</value>
		  </block>
		  <block type="text_charAt">
			<value name="VALUE">
			  <block type="variables_get">
				<field name="VAR">text</field>
			  </block>
			</value>
		  </block>
		  <block type="text_getSubstring">
			<value name="STRING">
			  <block type="variables_get">
				<field name="VAR">text</field>
			  </block>
			</value>
		  </block>
		  <block type="text_changeCase">
			<value name="TEXT">
			  <shadow type="text">
				<field name="TEXT">abc</field>
			  </shadow>
			</value>
		  </block>
		  <block type="text_trim">
			<value name="TEXT">
			  <shadow type="text">
				<field name="TEXT">abc</field>
			  </shadow>
			</value>
		  </block>
		  <block type="text_print">
			<value name="TEXT">
			  <shadow type="text">
				<field name="TEXT">abc</field>
			  </shadow>
			</value>
		  </block>
		  <block type="text_prompt_ext">
			<value name="TEXT">
			  <shadow type="text">
				<field name="TEXT">abc</field>
			  </shadow>
			</value>
		  </block>
		</category>
		<category name="Lists" colour="260">
		  <block type="lists_create_with">
			<mutation items="0"></mutation>
		  </block>
		  <block type="lists_create_with"></block>
		  <block type="lists_repeat">
			<value name="NUM">
			  <shadow type="math_number">
				<field name="NUM">5</field>
			  </shadow>
			</value>
		  </block>
		  <block type="lists_length"></block>
		  <block type="lists_isEmpty"></block>
		  <block type="lists_indexOf">
			<value name="VALUE">
			  <block type="variables_get">
				<field name="VAR">list</field>
			  </block>
			</value>
		  </block>
		  <block type="lists_getIndex">
			<value name="VALUE">
			  <block type="variables_get">
				<field name="VAR">list</field>
			  </block>
			</value>
		  </block>
		  <block type="lists_setIndex">
			<value name="LIST">
			  <block type="variables_get">
				<field name="VAR">list</field>
			  </block>
			</value>
		  </block>
		  <block type="lists_getSublist">
			<value name="LIST">
			  <block type="variables_get">
				<field name="VAR">list</field>
			  </block>
			</value>
		  </block>
		  <block type="lists_split">
			<value name="DELIM">
			  <shadow type="text">
				<field name="TEXT">,</field>
			  </shadow>
			</value>
		  </block>
		  <block type="lists_sort"></block>
		</category>
		<category name="Colour" colour="20">
		  <block type="colour_picker"></block>
		  <block type="colour_random"></block>
		  <block type="colour_rgb">
			<value name="RED">
			  <shadow type="math_number">
				<field name="NUM">100</field>
			  </shadow>
			</value>
			<value name="GREEN">
			  <shadow type="math_number">
				<field name="NUM">50</field>
			  </shadow>
			</value>
			<value name="BLUE">
			  <shadow type="math_number">
				<field name="NUM">0</field>
			  </shadow>
			</value>
		  </block>
		  <block type="colour_blend">
			<value name="COLOUR1">
			  <shadow type="colour_picker">
				<field name="COLOUR">#ff0000</field>
			  </shadow>
			</value>
			<value name="COLOUR2">
			  <shadow type="colour_picker">
				<field name="COLOUR">#3333ff</field>
			  </shadow>
			</value>
			<value name="RATIO">
			  <shadow type="math_number">
				<field name="NUM">0.5</field>
			  </shadow>
			</value>
		  </block>
		</category>
		<sep></sep>
	
		<category name="Game Objects" expanded="true" colour="255">
		  <category name="Setup" colour="60">
			  <block type="text"></block>
		  </category>
		  <category name="Sprites" colour="60">
			  <block type="text"></block>
		  </category>
		  <category name="Graphics" colour="60">
			  <block type="text"></block>
		  </category>
		  <category name="Events" colour="60">
			  <block type="text"></block>
		  </category>
		  <category name="Functions" colour="60">
			  <block type="text"></block>
		  </category>
		</category>
		<sep></sep>
	
		<category name="Phaser" expanded="false" colour="0">
		  <category name="Actions" colour="30">
		  </category>
		  <category name="Actions" colour="30">
		  </category>
		  <category name="Actions" colour="30">
		  </category>
		  <category name="Actions" colour="30">
		  </category>
		</category>
		<sep></sep>
	
		<category name="Variables" colour="330" custom="VARIABLE"></category>
		<category name="Functions" colour="290" custom="PROCEDURE"></category>
	  </xml>
	  `;

		///////////////////////////////////////
		// APP Methods
		///////////////////////////////////////

		app.addActions = function (arr) {
			// Adds actions to `Items`
			// `arr` is an `Array` of `descriptors` in the format:
			// `arr = [
			//    { idOrClassName: "" , actionType: "", handler: [ad-hoc function] }
			// ]`
			//
			// `idOrClassName` - this can be the `itemId`, the `DOM id` or a `Classname` for the item

			for (i = 0; i < arr.length; i++) {
				app.addAction(arr[i].idOrClassName, arr[i].handler);
			}

			return this;
		};

		app.addAction = function (idOrClassName, handler) {
			// Adds an action `handler` for `idOrClassName`
			// Multiple actions can be added for each `idOrClassName`
			// The `Item` does not need to exist on the current screen... i.e. this method can be called on init
			// Returns `this`
			// See if `_actions` is instantitated for this idOrClassName
			if (!this._actions[idOrClassName]) this._actions[idOrClassName] = [];

			// Add this to the array of actions
			this._actions[idOrClassName].push(
				handler.bind(app.getItem(idOrClassName))
			);

			return this;
		};

		/*
			Add the ASE Event Listeners ASE Object ASE Class Custom Events
		*/
		app._addEventListenersASE = function () {
			///////////////////////////////////////
			// APPSHED EVENTS ase- APP Events ASE
			///////////////////////////////////////
		
			/*
			We have a number of custom events that we create to handle behaviours in the app
			Events are dispatched using
					document.dispatchEvent(app.events['ase-popup-loaded']);
		
			*/
		
			var _eventDescriptors = [
				"ase-asa-end",
				"ase-asa-start",
				"ase-asa-step",
				"ase-course-frontpage",
				"ase-course-category",
				"ase-course-course",
                "ase-iframe-loaded",
				"ase-init-done",
				"ase-popup-loaded",
				"ase-screen-init-done",
				"ase-show-product-appbuilder",
				"ase-show-product-gamemaker",
				"ase-show-product-courses",
				"ase-user-init-done",
			];
		
			for (const eStr of _eventDescriptors) {
				app.events[eStr] = new Event(eStr);
		
				document.addEventListener(
					eStr,
					(e) => {
						var data = { event: e.type };
		
						try {
							if (e.type == "ase-asa-start") {
								//dataLayer.push({'event':e.type,'asa_key': app.asa.currentASA.key});
								data["asa_key"] = app.asa.currentASA.key;
							} else if (e.type == "ase-asa-step") {
								//dataLayer.push({'event':e.type,'asa_key': app.asa.currentASA.key,'step_key': app.asa.currentStep.key});
								data["asa_key"] = app.asa.currentASA.key;
								data["step_key"] = app.asa.currentStep.key;
							} else if (e.type == "ase-init-done") {
								// raise a GTM event, include basic user properties - nope, moved to ase-user-init-done
		
								app_hidePageLoadingMask();
							} else if (e.type == "ase-popup-loaded") {
								//NOTE for ase-popup-loaded there are many sub events
								//e.g. _handleAutomationEvents makes events like
								//	ase-popup-loaded-edit-item
								// raise a GTM event
								//dataLayer.push({'event':'app_popupContainer','popupContainerType':app._popupContainerType});
								data["popupContainerType"] = app._popupContainerType;
							} else if (e.type == "ase-user-init-done") {
								// raise a GTM event, include basic user properties
								//dataLayer.push({'event':e.type,'app_userId': app.getUser().getId(),'app_userEmail':app.getUser().getEmail(),'app_userName':app.getUser().getName()});
								data["app_userId"] = app.getUser().getId();
								data["app_userEmail"] = app.getUser().getEmail();
								data["app_userName"] = app.getUser().getName();
								data["app_userType"] = app.getUser().getType();
		
								// Load the resource panel
								app._resourcepanelInit();
							} else if (e.type == "ase-course-course") {
								//dataLayer.push({'event':e.type})
		
								// has the hint been shown? 
								/* now handled by max_restarts 
								if (localStorage["hint-resourcepanel-expand"] != "1") {
									localStorage["hint-resourcepanel-expand"] = "1";
									// show the hint
									app.asa.start("hint-resourcepanel-expand");
								}
								*/
							}
		
							// whatever the event, add to Mautic dataLayer
							dataLayer.push(data);
						} catch (error) {
							console.warn("ASE EventListener", e.type, error);
						}
		
						// Cannot call _handleAutomationEvents within this event handler (causes dispatch error), so do async using timeout
						setTimeout(() => {
							// check if any further automations must be handled
							app.asa._handleAutomationEvents(e.type);
						}, 1);
					},
					false
				);
			}
		};
		



		app.addCoreStyles = function () {
			// Add the core styles to the page
			// These can be used in the Custom Class field of the Styles tab for tabs, screens and items
			// Returns `this`

			// hide the second div on the Map screen... it's a Google Map overlay
			// Also, the Sliding element on Firefox ignores the following css rule , so need a workaround
			// 	.no-css3 & .sliding.hidden-left {		display: none;	}
			//
			// 	Deprecated
			//
			//app.addStyles(" #app"+app.id+" .screen.map .map-holder>div {     display: none; } #app"+app.id+" .screen.map .map-holder>div#map-div {     display: block; }  .ios7style .leaflet-control-zoom { margin-top: 70px; } .sliding.hidden-left {		display: none;	}" );

			// Accordion
			app.addStyles(
				"#app" +
					app.id +
					" .accordion .title{	line-height: 40px; } #app" +
					app.id +
					" .accordion.item{ 	margin-bottom: 0px; /* fix bootstrap style */ }  #app" +
					app.id +
					" .accordion.image-float-right .image-container{ 	float: right; }  #app" +
					app.id +
					" .accordion.image-20 .image{ 	width: 20px; }    #app" +
					app.id +
					" .accordion.image-40 .image{ 	width: 40px; }  #app" +
					app.id +
					" .accordion.image-rotate.item img.rotate { 	     -moz-transform: rotate(-90deg); /* Firefox */     -ms-transform: rotate(-90deg); /* IE */     -webkit-transform: rotate(-90deg); /* Safari, Chrome, iOS */     -o-transform: rotate(-90deg); /* Opera */     transform: rotate(-90deg);    }  #app" +
					app.id +
					" .accordion.image-rotate.item img{ 	-webkit-transition: all 0.5s ease-out 0.2s;      -moz-transition: all 0.5s ease-out 0.2s;      -o-transition: all 0.5s ease-out 0.2s;      transition: all 0.5s ease-out 0.2s;  }"
			);

			// logMessages
			app.addStyles(
				'#logMessages{color: white; z-index: 51;} #logMessages ._settingsClose{ display: block;position: absolute;top: 8px;right: 10px;width: 20px;height: 20px;background-size: 20px;padding-left: 0px;color: black;background-color: white;border-radius: 20px;line-height: 20px; cursor: pointer;} #logMessages ._settingsClose>div{padding-left: 7px;} #logMessages .header {     min-height: 30px;     border-bottom: 1px solid #565656;     text-align: center;     font-size: 14px;     margin-bottom: 10px;     margin-top: 5px; }   #logMessages .link {     background-color: #ffffff;     color: black;     margin-bottom: 10px;     padding: 5px;     border-radius: 3px; font-size: 11pt;   padding-left: 10px;   line-height: 1.7em; } #logMessages ._settingsSettings.panel .link:last-child {xxbackground-color: red !important; xxcolor: white;} #logMessages .link::after {content: ">" ;    float: right;} #logMessages .panel{display: none;} #logMessages .inner ._settingsBack { position: absolute;     top: 8px;    left: 0px; margin-left: 5px; border-radius: 11px; background-color: white; min-width: 22px; color: black; height: 22px; font-size: 12px;line-height: 22px; } #logMessages ._settingsBack>div {    padding-left: 7px;} #logMessages .panel {	padding-left: 10px; padding-right: 10px;} #logMessages .scrolling { overflow: auto; height: 445px; -webkit-overflow-scrolling: touch;} #logMessages .inner{ overflow: hidden; font-size: 8pt; margin-top: 0px; margin-left: 0px; height: 100%; left: 0px; top: 0px; right: 0px; width: 100%;} #logMessages input[type="checkbox"]{ zoom: 1.5;  margin-top: 0px;} #logMessages .inputContainer{margin-bottom: 20px;} #logMessages .gyroData>div {    width: 50%;    float: left;} .inputContainer button { padding: 5px 30px; border-radius: 15px; background-color: #494949; color: white; border: 1px solid white; } .inputContainer, .box { text-align: center;} #logMessages .blue { background-color: #3384fe;}  #logMessages .green { background-color: #529700;}   #logMessages .orange { background-color: #f89d1f;}  #logMessages .box {  border: 1px solid #8d8d8d; padding: 10px; margin-bottom: 20px;}  #logMessages .tag {  display: inline-block;  float: right;  padding: 3px;}  #statusIndicator {position: absolute; z-index: 50; width: 35px;height: 25px;} #statusIndicator .symbol {     font-size: 14px; padding: 3px; line-height: 12px; width: 12px; height: 12px; background-color: ' +
					app._config.statusIndicator.background_color +
					"; opacity: 1; border-radius: 15px;border: 2px solid white;color: " +
					app._config.statusIndicator.border_color +
					"; cursor: pointer; } #statusIndicator .symbol.connected {  background-color: " +
					app._config.statusIndicator.connected.background_color +
					"; border-color: " +
					app._config.statusIndicator.connected.border_color +
					"; opacity: 1} #statusIndicator .symbol.connected.sending {background-color: " +
					app._config.statusIndicator.sending.background_color +
					"; border-color: " +
					app._config.statusIndicator.sending.border_color +
					";} ._settingsDeviceDetails_sending {background-color: #00acfe;}  .logocodestatustext.haserrors { text-decoration: underline;  color: red;} .app40.appbuilder .toolbox #nav-tabs_game{display: none; }"
			);

			// Input, range, color
			app.addStyles(
				"#app" +
					app.id +
					" input[type=range], #app" +
					app.id +
					" input[type=color]{width: 100% !important;} #app" +
					app.id +
					" input[type=color] { -webkit-appearance: none; border: none; } #app" +
					app.id +
					" input[type=color]::-webkit-color-swatch-wrapper { padding: 0; } #app" +
					app.id +
					" input[type=color]::-webkit-color-swatch { border: none; } #app" +
					app.id +
					' input[type=color]{padding: 0px;}  .phone .phone-navigator .app .app-navigator .screen.list .items .item.textbox.field-background-transparent input[type="text"], .phone .phone-navigator .app .app-navigator .screen.list .items .item.textbox.field-background-transparent input[type="password"], .phone .phone-navigator .app .app-navigator .screen.list .items .item.textarea.field-background-transparent textarea, .phone .phone-navigator .app .app-navigator .screen.list .items .item.select.field-background-transparent .selected, .phone .phone-navigator .app .app-navigator .screen.list .items .item.picker.field-background-transparent .picked { background: transparent} .item-code-container{max-height: 200px;} .codeflask{overflow: scroll !important; max-height: 200px; width: 99% !important; border: 1px solid silver; border-radius: 3px;} .codeflask .token.number {color: #0aa600 !important;} .codeflask .token.property {color: #002bff !important;} .codeflask .token.number {color: #0aa600 !important;} pre.codeflask__pre{background-color: transparent} .codeflask__flatten{font-size: 12px !important;}'
			);

			// position
			app.addStyles(
				".position-absolute{ position: absolute; } .position-relative{ position: relative; } .float-left{ float: left; } .float-right{ float: right; } .clear-right{ clear: right; } .clear-left{ clear: left; } .clear-both{clear:both} .width-1-3{ width: 30%; } .width-2-3{ width: 62%; } .width-1-2{ width: 46%; }  .width-1-4{ width: 21%; } .width-2-4{ width: 46%; } .width-3-4{ width: 71%; } .width-4-4{ width: auto; }  .width-1-5{ width: 17%; } .width-2-5{ width: 35%; } .width-3-5{ width: 58%; } .width-4-5{ width: 75%; } .width-5-5{ width: auto; } .width-1-6{ width: 15%; } .width-2-6{ width: 30%; } .width-3-6{ width: 46%; } .width-4-6{ width: 62%; } .width-5-6{ width: 77%; } .width-6-6{ width: auto; } .width-1-8{ width: 9%; } .width-2-8{ width: 21%; } .width-3-8{ width: 33%; } .width-4-8{ width: 46%; } .width-5-8{ width: 54%; } .width-6-8{ width: 64%; } .width-7-8{ width: 83%; }  #app" +
					app.id +
					" .image-float-right img{float: right;} .item.single-row>div {float: left; width: 50%;}  .item.single-row input,.item.single-row textarea {width: 100%}   .field-width-1-2  .textarea-container, .field-width-1-2  .textbox-container{ width: 50%; }   .field-width-1-4  .textarea-container, .field-width-1-4 .textbox-container{ width: 25%; }   .field-width-2-4  .textarea-container, .field-width-2-4 .textbox-container{ width: 50%; }   .field-width-3-4  .textarea-container, .field-width-3-4 .textbox-container{ width: 75%; }   .field-width-4-4  .textarea-container, .field-width-4-4 .textbox-container{ width: auto; }"
			);

			// tables
			app.addStyles(
				".screen .datatable table{width: 100%;}.screen .datatable th{color:#000000;  background:#a6a6a6;  border-bottom:1px solid #22262e;  border-right: 1px solid #22262e;  font-weight: normal;  padding:10px;  text-align:left;  vertical-align:middle;}.screen .datatable th:last-child{border-right:none;} .screen .datatable tr{border-top: 1px solid #C1C3D1;  border-bottom-: 1px solid #C1C3D1;  color:#494949;  font-size:16px;}.screen .datatable tr:hover td{background:#a6a6a6;  color:#FFFFFF;  border-top: 1px solid #22262e;  border-bottom: 1px solid #22262e;}.screen .datatable tr:first-child{border-top:none;}.screen .datatable tr:last-child{border-bottom:none;}.screen .datatable tr:nth-child(odd) td{background:#EBEBEB;}.screen .datatable tr:nth-child(odd):hover td{background:#a6a6a6;}.screen .datatable td{background:#FFFFFF;  padding:12px;  text-align:left;  vertical-align:middle;  border-right: 1px solid #C1C3D1;}.screen .datatable td:last-child{border-right: 0px;}"
			);

			// Text, align, borders
			app.addStyles(
				' .text-align-center input{text-align: center;} .image-align-center img{display: block; margin: auto;} .border-bottom-none{border-bottom: none;} .padding-unset{padding: unset;} .padding-none{padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;}   .field-align-center .textarea-container,  .field-align-center .textbox-container,  .field-align-center .selected-container,  .field-align-center .picker-container  {margin: 0 auto;} .field-align-center .textarea-container textarea,  .field-align-center .textbox-container input,  .field-align-center .selected-container,  .field-align-center .picker-container  {text-align: center;} .phone .phone-navigator .app .app-navigator .screen.list .items .item.textbox.border-none input[type="text"], .phone .phone-navigator .app .app-navigator .screen.list .items .item.textbox.border-none input[type="password"], .phone .phone-navigator .app .app-navigator .screen.list .items .item.textarea.border-none textarea, .phone .phone-navigator .app .app-navigator .screen.list .items .item.select.border-none .selected, .phone .phone-navigator .app .app-navigator .screen.list .items .item.picker.border-none .picked {    border: none;   box-shadow: none;}'
			);

			// display, show hide, Font-size
			// hidden-live and template: if there is a phone-container class, then this is AppBuilder, so show the item
			app.addStyles(
				".no-arrow.link .link-arrow{display: none;} .hidden-live, .event, .template{display: none;} .phone-container .hidden-live, .phone-container .event, .phone-container .template{display: block;} .item.x-large, .item.x-large input, .item.x-large textarea {font-size: x-large;} .title-hidden .title{ display: none; } "
			);

			// Phaser

			app.addStyles(
				"#phaser-canvas{height: inherit; width: inherit; text-align: center; background-color: transparent; } #phaser-canvas canvas{border: 1px solid var(--gm-panel-border)}  #phaser-example{height: inherit; width: inherit}   .phone .phone-navigator .app .app-navigator .screen.list .items .phaser.item.thumb{ background-color: #000000;    background-position: top left;     background-repeat: no-repeat;     padding-top: 20px;     border-bottom: 6px solid #191919; } .phone .phone-navigator .app.phaser-show-hidden.phaser-setup .phaser.phaser-setup.item.thumb.phaser-hidden, .phone .phone-navigator .app.phaser-show-hidden.phaser-object .phaser.phaser-object.item.thumb.phaser-hidden, .phone .phone-navigator .app.phaser-show-hidden.phaser-event .phaser.phaser-event.item.thumb.phaser-hidden, .phone .phone-navigator .app.phaser-show-hidden.phaser-graphic .phaser.phaser-graphic.item.thumb.phaser-hidden, .phone .phone-navigator .app.phaser-show-hidden.phaser-function .phaser.phaser-function.item.thumb.phaser-hidden { background-color: #1e1e1e;}  .phaser.phaser-text.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-textpng.png');}  .phaser.phaser-function.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-functionpng.png');}  .phaser.phaser-event.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-eventpng.png');}  .phaser.phaser-audio.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-audiopng.png');} .phaser.phaser-collide.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-collidepng.png');}  .phaser.phaser-collider.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-colliderpng.png');} .phaser.phaser-config.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-configpng.png');}  .phaser.phaser-joystick.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-joystickpng.png');}   .phaser.phaser-create.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-createpng.png');} .phaser.phaser-for-loop.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-for-looppng.png');}  .phaser.phaser-game.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-gamepng.png');}   .phaser.phaser-group.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-grouppng.png');}   .phaser.phaser-image.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-imagepng.png');}  .phaser.phaser-item.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-itempng.png');}  .phaser.phaser-keyboard.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-keyboardpng.png');}  .phaser.phaser-overlap.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-overlappng.png');}  .phaser.phaser-pointer.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-pointerpng.png');}  .phaser.phaser-sprite.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-spritepng.png');}  .phaser.phaser-spriteSheet.item.thumb{ background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-spritesheetpng.png');}  .phaser.phaser-staticbody.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-staticbodypng.png');}   .phaser.phaser-staticGroup.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-staticgrouppng.png');}  .phaser.phaser-tileSprite.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-tilespritepng.png');}  .phaser.phaser-update.item.thumb{background-image: url('https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/phaser/phaser-updatepng.png');}          "
			);

			app.addStyles(
				" .container [data-icon]:before{content: none;}         .phone .phone-navigator .app .app-navigator .screen.list .items .phaser.item.thumb .image {     width: auto;     max-width: 90px;     max-height: 90px;     height: auto; }   .phone .phone-navigator .app .app-navigator .screen.list .items .phaser.item.thumb .image-container, .phaser-spriteSheet.item.thumb .image-container  {     width: 90px;     height: 90px;     float: left; padding-right: 10px; }  .gamemaker .phone .phone-navigator .app .app-navigator .screen.list .items .phaser.item.thumb .title{   color: #00e300; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;   font-size: 15px;     font-weight: normal;     margin-left: 101px;     margin-bottom: 5px;  border-bottom: 1px solid var(--gm-panel-border);}   .gamemaker .phone .phone-navigator .app .app-navigator .screen.list .items .phaser.item.thumb .text,  .gamemaker .phone .phone-navigator .app .app-navigator .screen.list .items .phaser.item.thumb .synopsis  {   color: #00e300; font-size: 10px;     overflow: hidden;    padding-left: 0px;       line-height: 14px;  height: 68px;   }  .item .synopsis .comment {    margin-left: 0px;  border-bottom: 1px solid var(--gm-panel-border);}  .gamemaker .phaser-setup .phaser-setup.phaser-hidden.phaser.item, .gamemaker .phaser-object .phaser-object.phaser-hidden.phaser.item, .gamemaker .phaser-event .phaser-event.phaser-hidden.phaser.item, .gamemaker .phaser-graphic .phaser-graphic.phaser-hidden.phaser.item, .gamemaker .phaser-function .phaser-function.phaser-hidden.phaser.item {    display: none; }    .phaser-setup.phaser-show-hidden .phaser-setup.phaser-hidden.phaser.item, .phaser-object.phaser-show-hidden .phaser-object.phaser-hidden.phaser.item, .phaser-event.phaser-show-hidden .phaser-event.phaser-hidden.phaser.item, .phaser-graphic.phaser-show-hidden .phaser-graphic.phaser-hidden.phaser.item, .phaser-function.phaser-show-hidden .phaser-function.phaser-hidden.phaser.item {    display: block; }  .gm-left-panel hr{border-top: 1px solid var(--gm-panel-border); border-bottom: 0px; margin: 10px 0;}    #edit_item .file-chooser-upload.btn {display: none;}  "
			);

			// Import Event Hidden Template Loader
			app.addStyles(
				"#app" +
					app.id +
					" .import.item, #app" +
					app.id +
					" .event.item, #app" +
					app.id +
					" .hidden-live.item{font-size: 10pt;      font-family: courier;         color: white;      background-color: #cbcbcb;  border: 2px dashed white;      padding: 3px;      padding-left: 25px;	}  #app" +
					app.id +
					" .template.item{border: 2px dashed black;}  #app" +
					app.id +
					" .import.item {background-image: url(http://d3s8dljl1bm5rz.cloudfront.net/1579269);      background-repeat: no-repeat;      background-position: left;      background-size: 20px;}   .phone .loader .inner .text { margin: 3px auto 3px auto;   xxwidth: 240px;}"
			);

			// ------------------------------
			// AppBuilder UI
			// ------------------------------

			if (app.isAppBuilder) {
				/*
				var metaTag=document.createElement('meta');
				metaTag.name = "viewport";
				metaTag.content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0";
				document.getElementsByTagName('head')[0].appendChild(metaTag);
				*/

				// Controls on Forms, Tools, Blockly2
				app.addStyles(
					"body{font-family: 'Roboto', sans-serif} .span-toolbox input, .span-toolbox button, .span-toolbox select, .span-toolbox textarea {font-family: 'Roboto', sans-serif;} .tab-pane .help-block{line-height: normal; font-style: italic;}   .box2 .content .icon {    width: 60px;    padding: 2px;}   .tab-pane.active {    overflow: hidden;}   a.icon h3, a.icon div.tool:before {cursor: pointer;}     .blockly2_titlebar{background-color: #191919; }   body>#blockly2>.blockly2_titlebar{     background-image: url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/branding/appshed-white-h55png.png);  background-repeat: no-repeat; background-size: contain;}   .blocklyTreeLabel { color: black; } .phone .phone-navigator .app .app-navigator .screen.appsscreen .items .item.icon .item-icon-inner .title {margin-left: 0px; margin-right: 0px; font-weight: normal; text-shadow: none; font-size: 10px; }  #logMessages .panel { padding-left: 10px; padding-right: 10px;}  .form-horizontal input+.help-block, .form-horizontal select+.help-block, .form-horizontal textarea+.help-block, .form-horizontal .uneditable-input+.help-block, .form-horizontal .input-prepend+.help-block, .form-horizontal .input-append+.help-block, .tab-pane .help-block { font-size: 8pt;}"
				);

				// Module Popup
				app.addStyles(
					".categories-list-popup a { background-repeat: no-repeat; background-image: url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/modules/folder2png.png); padding: 10px; padding-left: 60px; background-color: silver; width: 85%; display: inline-block; margin-bottom: 5px; }  ul.categories-list-popup{ margin-left: 0px; }  #add_module .help-block:nth-child(2) { display: none;  } "
				);

				// Hide Module Hide Template New and Search fields
				// TODO... Show/hide templates based on status, FREE, EDU, PREMIUM
				//app.addStyles('#tab_modules .margin-t-20{display: none} #modules-browser h1 a{display: none}   .edu-user #tab_modules .margin-t-20{display: initial}   .edu-user #modules-browser h1 a{display: initial}');
				//jQuery('#tab_modules .margin-t-20, #modules-browser h1 a').addClass('for-edu');

				// Image Chooser
				app.addStyles(
					"li.group-browser-group i.collapsed{     background-size: 22px;     height: 22px;     width: 22px;     background-repeat: no-repeat;     background-image: url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/appbuilder/arrow-inactive-lgpng.png); }"
				);
				app.addStyles(
					"li.group-browser-group i.expanded{     background-size: 22px;     height: 22px;     width: 22px;     background-repeat: no-repeat;     background-image: url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/appbuilder/arrow-active-lgpng.png); }"
				);
				app.addStyles(
					"li.group-browser-group i.icon-circle{     font-size: 10px;      height: 22px;     width: 22px;   display: inline-block; }"
				);

				// ID
				//app.addStyles(".control-group:last-of-type{ border: 1px solid silver;     background-color: #f2f2f2; }");
				app.addStyles("$.control-group .variable-chooser{ border: none;}");

				// Actions Extensions Drop-down
				app.addStyles(
					".action-selector .action.selected {background-image: url(https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/TriangleArrow-Down.svg/532px-TriangleArrow-Down.svg.png);    background-size: 20px 20px;    background-repeat: no-repeat;    background-position-x: 372px;    background-position-y: 20px;} .action-selector .action.selected, .action-selector .action:hover, .action-selector2-tab .action.selected, .action-selector2-tab .action:hover {    background-color: var(--as-bg-dark);  "
				);

				// EDU and Admin user
				app.addStyles(
					' .for-edu{ display: none;}    .for-not-edu{display: initial} .edu-user .for-edu{display: initial}  .edu-user .for-not-edu{display: none}  .admin-user a.home-icon { width: 40px; } .not-admin-user .item.oae, .not-edu-user .item.oee { border: 1px dashed #cc52b8; }  .not-edu-user .open.oee ul:before,.not-admin-user .open.oae ul:before { content: "Read only"; color: black; padding-left: 100px; } '
				);

				// Academy
				app.addStyles(
					'#academy .item h3{font-size: 18px}  #academy .button {color: #2394FF; border-color: #2394FF; background-color: #ffffff}  #academy .button.arrow-up {color: #ffffff; border-color: #ffffff; background-color: #2394FF}  .academy-categories.category .breadcrumb li.active, .academy-categories.unit .breadcrumb li.active{    display: block;font-size: 25px;margin-top: 6px;color: #0088cc;margin-bottom: 1px;}  .academy-categories.category .academy-scroller .wrapper .page .item .description{ font-size: 13px}   .academy-categories.category .academy-scroller .wrapper .page .item{margin: 0px 6px 8px; border: 1px solid grey;    height: 81px;    width: 326px;    padding: 9px;    background-image: linear-gradient(#fcfcfc,#d5d5d5);}   .academy-categories.category .academy-scroller .wrapper .page .item.no-free,  .academy-categories.category .academy-scroller .wrapper .page .item.no-free:hover{background-image: url(" https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/appbuilder/course-banner-premium2png.png "); background-size: contain} .academy-categories.category .academy-scroller .wrapper .page .item:hover {    background-image: linear-gradient(#ffffff,#fcfcfc); }  .academy-categories.category .breadcrumb li.active:after {    content: " (Category)"; } .academy-categories.unit .breadcrumb li.active:after {    content: " (Course)"; }  .academy-categories.category .breadcrumb li.li-btn .btn, .academy-categories.unit .breadcrumb li.li-btn .btn  {    margin-top: -66px; }'
				);

				// Game Maker IDE

				// ------------------------------
				// MOBILE AppBuilder
				// ------------------------------


                // buttons to open/close toolbox
                jQuery(".app").append('<div id="toggle-mobile-menu" class="mobileeditor-overlay"><i class="icon-edit"></i></div>');
                jQuery("#toggle-mobile-menu").click(function () {
                    if (jQuery(".span-toolbox").hasClass("mobileeditor-show")) {
                        jQuery(".span-toolbox").removeClass("mobileeditor-show");
						jQuery(".span-toolbox").css("display","none");
                    } else {
                        jQuery(".span-toolbox").addClass("mobileeditor-show");
						jQuery(".span-toolbox").css("display","block");
                    }
                });
                // buttons to close mobileeditor
                jQuery(".app").append('<div id="close-mobileeditor" class="mobileeditor-overlay">Open Desktop Editor</div>');
                jQuery("#close-mobileeditor").click(function () {
					app.isMobileEditor = false;
                    jQuery("body").removeClass("mobileeditor");
					// show the toolbox
					jQuery(".span-toolbox").css("display","block");
                    
                });
                // buttons to show mobileeditor
                jQuery(".app").append('<div id="show-mobileeditor" class="mobileeditor-overlay">Mobile Editor</div>');
                jQuery("#show-mobileeditor").click(function () {
					app.isMobileEditor = true;
                    jQuery("body").addClass("mobileeditor");
					// hide the toolbox
					jQuery(".span-toolbox").css("display","none");
                    
                });


				if (
					app.isAppBuilder &&
					(screen.width < 963 || jQuery(document).width() < 860)
				) {
					// not done here 
				} else {
					// ------------------------------
					// NOT MOBILE AppBuilder
					// ------------------------------

					app.addStyles(
						".new-tab-placeholder, .new-item-placeholder{display: none}"
					);
				}
			}

			// ------------------------------
			// NOT AppBuilder UI
			// ------------------------------

			if (!app.isAppBuilder) {
				// Imports
				app.addStyles(".import.item{display: none}");
			}
			return this;
		};




		app.addClass = function (className) {
			// Adds `className` to the app `element`
			// Returns `this`

			jQuery(".app-navigator").addClass(className);

			return this;
		};

		app._addCodeMirrorScripts = function () {
			// Add the scripts to support the udpated CodeMirror

			// now load CSS
			jQuery.each(
				[
					"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/lib/codemirror.css",
					"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/addon/lint/lint.css",
					"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/theme/cobalt.css",
				],
				function (i, val) {
					app.loadScript(val, null, "css");
				}
			);

			// Load JS sequentially
			app.loadScript(
				"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/lib/codemirror.js",
				function () {
					app.loadScript(
						"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/mode/javascript/javascript.js",
						function () {
							app.loadScript(
								"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/mode/css/css.js",
								function () {
									app.loadScript(
										"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/mode/htmlmixed/htmlmixed.js",
										function () {
											app.loadScript(
												"https://unpkg.com/jshint@2.13.2/dist/jshint.js",
												function () {
													app.loadScript(
														"https://unpkg.com/jsonlint@1.6.3/web/jsonlint.js",
														function () {
															app.loadScript(
																"https://unpkg.com/csslint@1.0.5/dist/csslint.js",
																function () {
																	app.loadScript(
																		"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/addon/lint/lint.js",
																		function () {
																			app.loadScript(
																				"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/addon/lint/javascript-lint.js",
																				function () {
																					app.loadScript(
																						"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/addon/lint/json-lint.js",
																						function () {
																							app.loadScript(
																								"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/addon/lint/css-lint.js",
																								function () {
																									app.loadScript(
																										"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/codemirror/5-65/addon/lint/html-lint.js",
																										function () {
																											app.loadScript(
																												"",
																												function () {}
																											);
																										}
																									);
																								}
																							);
																						}
																					);
																				}
																			);
																		}
																	);
																}
															);
														}
													);
												}
											);
										}
									);
								}
							);
						}
					);
				}
			);
		};

		app.addCSS = function (url, prepend) {
			// Loads `url` as a CSS file to the page

			if (prepend) {
				return jQuery("head").prepend(
					'<link rel="stylesheet" href="' + url + '" type="text/css" />'
				);
			} else {
				return jQuery("head").append(
					'<link rel="stylesheet" href="' + url + '" type="text/css" />'
				);
			}
		};

		/*
		app._addCustomClass
		Adds `name` to the Custom Class for the item currently being edited 
		*/
		app._addCustomClass = function (name) {
			// Make sure the input field is available (i.e. the Item is being edited)
			if (jQuery("#style_costumclases").length) {
				var myRE = new RegExp(name);
				var customClasses = String(jQuery("#style_costumclases").val());
				if (customClasses.search(myRE) >= 0) {
					return true;
				} else {
					customClasses += " " + name;
				}
				jQuery("#style_costumclases").val(customClasses);
				// search again to make sure
				if (String(jQuery("#style_costumclases").val()).search(myRE) >= 0) {
					return true;
				}
			}
			return false; // something went wrong
		};

		app.addDevice = function (props) {
			// adds an IoT Device (such as ESP8266, RaspberryPi or Arduino) to this app.
			// `props` is a JSON object containing the properties of the device

			try {
				var device;

				device = new Device(props);

				app._devices[props.id] = device;

				// If this is the first device added, make it the default
				if (Object.keys(app._devices).length == 1) {
					app._defaultDevice = props.id;
				}
				return device;
			} catch (er) {
				app.handleError(er, "app.addDevice()");
			}
		};

		app.addHoverImages = function (imageArray) {
			// Adds hover images that appear when the user hovers over the `Item`
			// Works with touch and mouse events
			// `imageArray` is an array of objects in the format
			//    `[
			//	   `{`
			//		`id: id,`
			//		`class: className,`
			//		`url: imageURL,`
			//		`doActions: true|false`
			//	   `}`,
			//		...
			// Returns `this`

			for (var i = 0; i < imageArray.length; i++) {
				var hasUrl = false;

				// make sure there is a url
				if (imageArray[i].hasOwnProperty("url") && imageArray[i].url > "") {
					hasUrl = true;
				}

				// Preload the image
				if (hasUrl) {
					jQuery("<img />")[0].src = imageArray[i].url;
				}

				// Get the Item
				var idOrClassName = imageArray[i].id
					? imageArray[i].id
					: imageArray[i].class;
				var thisItem = this.getItem(idOrClassName);

				if (thisItem && thisItem.element) {
					// Make sure originalImage is saved
					if (!thisItem.originalImage)
						thisItem.originalImage = thisItem.getImage();

					if (hasUrl) {
						thisItem.hoverImage = imageArray[i].url;
					}
					thisItem.onHoverDoActions = imageArray[i].doActions;
				}
			}
			return this;
		};

		app.addInterval = function (identifier, name) {
			// Adds an interval handler `identifier` to the `_intervals`,
			//returns `identifier`
			// Optional `name` can be used as a reference to the `identifier` (used by `app.clearInterval()`)

			name = name || identifier;

			try {
				this._intervals[name] = identifier;
				return identifier;
			} catch (er) {
				app.handleError(er, "app.addInterval");
			}
		};

		addIotEvent = function (variable, value, range, method, callback) {
			console.warn("addIotEvent", variable, value, range, method, callback);

			// method: comparison operator, one of == != >= <= > <

			return this.phone.navigator.events.addEvent({
				type: "iot",
				variable: variable,
				value: value,
				range: range,
				method: method,
				callback: callback,
			});
		};

		app.addJQueryScripts = function () {
			// Adds the script tags required for jQuery to the `<head>`
			// This method is called on an `Interval` until all the scripts required have been loaded
			// Once all the script are loaded, the `Interval` is stopped

			if (app._JQUERYHARDCODED) {
				// jQuery code is pasted in Settings, do not need to load
				app._scriptLoaded_jquery = true;
				app._scriptLoaded_ajaxq = true;
				app._scriptsLoaded_arest = true;
				//$.noConflict(); .. This is done in index.html
			}

			// check if all scripts have been loaded
			if (app._scriptLoaded_jquery && app._scriptLoaded_ajaxq) {
				app._scriptsLoaded_arest = true;

				return true;
			}

			if (app._scriptLoaded_jquery) {
				if (!app._scriptLoading_ajaxq) {
					app._scriptLoading_ajaxq = true;
					app.loadScript(app._ajaxqURL);
				}
			} else if (!app._scriptLoading_jquery) {
				app._scriptLoading_jquery = true;
				app.loadScript(app._jqueryURL);
			}

			// test for jQuery and ajaxq
			try {
				if (!app._scriptLoaded_jquery && app._scriptLoading_jquery && jQuery) {
					jQuery.noConflict();
					app._scriptLoaded_jquery = true;
				}
				if (
					!app._scriptLoaded_ajaxq &&
					app._scriptLoading_ajaxq &&
					jQuery.ajaxq
				)
					app._scriptLoaded_ajaxq = true;
			} catch (er) {}

			setTimeout(function () {
				app.addJQueryScripts();
			}, 300);
		};

		app._addNewCoursesLink = function () {
			jQuery("#academy>.header>.button.btn-courses").remove();
			jQuery("#academy>.header>.button:first")
				.hide()
				.clone()
				.addClass("btn-courses")
				.appendTo("#academy>.header")
				.click(function () {
					app._showProduct("courses");
				})
				.show()
				.find('span:contains("AppShed Academy")')
				.text("Courses");

			// We need to show old Academy Link (in future this will be optional for users that want to access it.)
			if (true || localStorage["showOldAcademyLink"]) {
				app._showCoursesAddOldAcademyLink();
			}

			return this;
		};

		app.addScreenClickHandlers = function (id, el) {
			// adds the event handlers to the `Screen` to capture `click` events

			if (el) app._screen_el = el;

			if (app._screen_el) {
				app._screen_el
					.getElements(".item")
					.removeEvent("click", app.onItemClicked);
				app._screen_el
					.getElements(".item")
					.addEvent("click", app.onItemClicked);
			}

			return this;
		};

		app.addScreenEvent = function (id, func) {
			// The given `func` will be called whenever the screen `id` is shown.
			// `id` can be the `Screen.id` or the `Screen ClassName`
			// This function returns an `identifier`.
			// Within `func`, `this` will refer to the `Element` of the `Screen` that is shown.
			// There is one parameter `app`.
			// Example:
			/*
			```
			app.addScreenEvent(17078, function() {
				app.getScreen(this).setBackgroundColor("Blue")
			});
			```
			*/

			var f = function (eid, screen) {
				// If a Class Name passed in, test for that and get the id
				if (isNaN(id) && screen.classList.contains(id))
					id = app.getIdFromDOMId(screen.id);

				if (id == eid) {
					appbuilder.app.debug("api", "screenEvent", id);
					try {
						func.call(screen, this);
					} catch (e) {
						appbuilder.app.debug(
							"api",
							"Error with custom js on screen event",
							e
						);
					}
				}
			}.bind(this);

			return this.phone.addEvent("screen", f);
		};

		app.addScript = function (code, callback, el) {
			// Loads the JavaScript content `script` into the page
			// If `script` holds  a url, passes this to `app.loadScript()`
			// Optional `el` specifies the element to add it to (e.g. iframe target for Blockly)

			var el = el || "body";

			if (code.match(/^http/)) {
				return app.loadScript(script, callback, el);
			}

			var script = document.createElement("script");

			script.type = "text/javascript";
			script.innerHTML = code;
			return jQuery(el).prepend(script);
		};

		app.addStyles = function (styleDescriptor) {
			// add `styleDescriptor` CSS styles to the document head
			// Returns the result of DOM method `appendChild()`

			var head = document.getElementsByTagName("head")[0];
			var tag = document.createElement("style");

			tag.innerHTML = styleDescriptor;
			return head.appendChild(tag);
		};

		app.addTabEvent = function (id, func) {
			// The given `func` will be called whenever the Tab `id` is shown.
			// `id` can be the `Tab.id` or the `Tab ClassName`
			// The given `func` will be called whenever the Tab `id` is shown.
			// This function returns an `identifier`.
			// Within `func`, `this` will refer to the `Element` of the `Tab` that is shown.
			// There is one parameter `app`.

			var f = function (eid, tab) {
				// If a Class Name passed in, test for that and get the id
				if (isNaN(id) && tab.classList.contains(id))
					id = app.getIdFromDOMId(tab.id);

				if (id == eid) {
					appbuilder.app.debug("api", "tabEvent", id);
					try {
						//func.call(tab,this)
						// Call func after timeout to give time for DOM to load new Screen
						setTimeout(function () {
							func.call(tab, app);
						}, 10);
					} catch (e) {
						appbuilder.app.debug("api", "Error with custom js on tab event", e);
					}
				}
			}.bind(this);

			return this.phone.addEvent("tab", f), f;
		};

		app.addVariableEvent_xxx = function (id, func) {
			// The given `func` will be called whenever the `Variable` `id` is changed.
			// This function returns an `identifier`.
			// Within `func`, `this` will refer to the `Element` of the `Tab` that is shown.
			// There are two parameters: `val` and `app`.
			/*
			```
			app.addVariableEvent('textbox', function(val) {
			var t = document.getElement('#screen17078 .title span');
			if(t) {
				t.set('text', val);
			}
			});
			```
			*/
		};

		//Override method for alert
		appbuilder.app.alert = function (message, context) {
			// don't show system alerts
			if (app.disableSystemAlerts) {
				if (
					message == "Downloading updates to app" ||
					message == "App is now available offline" ||
					message == "This app is currently unavailable" ||
					message == "This screen is currently unavailable"
				)
					return;
			}

			if (appbuilder.app.isPhoneGap) {
				navigator.notification.alert(message);
			} else if (appbuilder.app.isMobile) {
				alert(message);
			} else {
				appbuilder.app
					.makeConfirm(message, null, null, null, false)
					.inject(
						document.id(
							context ||
								document.getElement(".phone-inner") ||
								document.getElement(".phone") ||
								document.body
						)
					);
			}
		};

		app.alertPinValue = function (idOrProps, pin, format) {
			// Shows a screen alert message with the value of the pin for the device `idOrProps`.
			// Optional `format` can be `a` (for analog) or `d` (for digital) value (Default: `d`)
			// Returns `this`

			var props = this.idOrPropsToObject(idOrProps);
			this.getDevice(props).alertPinValue(pin, format);

			return this;
		};

		app.analogRead = function (pin, callback, idOrProps) {
			// v1.3.6 changing the order of the arguments, was: idOrProps,pin,callback
			// Read the analog state of `pin` for the device `idOrProps`
			// Optional `callback(data)` function is called passing the `data` of the Response
			// Returns `this`

			var props = this.idOrPropsToObject(idOrProps);
			this.getDevice(props).analogRead(pin, callback);

			return this;
		};

		app.analogWrite = function (pin, value, idOrProps) {
			// v1.3.6 changing the order of the arguments, was: idOrProps,pin,value
			// Write the PWM `value` to `pin` for the device `idOrProps`
			// `value` is in the range 0-255 (Uno) and 0-1023 (ESP8266)
			// Returns `this`

			var props = this.idOrPropsToObject(idOrProps);
			this.getDevice(props).analogWrite(pin, value);

			return this;
		};

		/*
			appendASALinks
			Append the ASA links 
			Params
				`el` the  element to append to
		*/
		app.appendASALinks = function (el) {
			var options = options || {}; 
	   
		   // do this async, as the innerHTML will be replaced first
		   setTimeout(function () {
			   try {
				   // ASA  items
				   jQuery.each(app.asa.asas, function (i, asa) {
	   
					   // Only show links to the manual start ASAs
					   if(asa.options.can_manual_start) {
	   
						   jQuery('<div><input type="button" value="' + asa.title + '" /></div>')
							   .appendTo(jQuery(el))
							   .click(() => {
								   // all options show demo tour
								   app.asa.start(asa.key, { force: true });
							   });
					   }
	   
				   });
			   } catch (er) {
				   console.error("appendASALinks", er);
			   }
		   }, 100);
	   
		   return ""; // return "" so that {{ }} is not populated with undefined
	   };
	   
	   


        /*
			appendFormChangeEmail
			Add the changeEmail form 
			Params
				`el` the element to append to
		*/
		app.appendFormChangeEmail = function (el) {
			// do this async, as the innerHTML will be replaced first
			setTimeout(function () {
				try {
					jQuery(`<form id="as-help-form-changeemail">
						<div class="fields">
							<span><input name="new_email" class="changeemail" value="" placeholder="Change your email address"></span><input type="submit" class="changeemail" value="Change email">
						</div>
						<div class="logout hidden">
							Please re-login with your new email. <a href="/appbuilder/login/logout">Log out now</a>
						</div>
						<div class="hint hidden">
							<br />
							<i style="zoom: 2;opacity: 1;color: white;" class="icon-spinner icon-spin "></i>
							<div class="alert "></div>	
						</div>
					</form>`)
					.appendTo(jQuery(el))
					.submit(function (event) {

						event.preventDefault();
						
						// show loader, hide the alert hint
						jQuery('#as-help-form-changeemail .hint i').removeClass("hidden")
							.parent().removeClass('hidden');
						jQuery('#as-help-form-changeemail .hint .alert').removeClass("alert-error").addClass("hidden").text("");
					

						jQuery.ajax({
							url: "https://workflow.appshed.com/webhook/702999ed-3a11-40d9-b1e9-4757cf665cd9",
							type: "POST",
							xhrFields: { withCredentials: true },
							data: {
								"email":app.user.email,
								"new_email": jQuery('#as-help-form-changeemail input[name="new_email"]').val(),
								"user_id":app.user.id,
								"mtc_id":app.getCookieVal('mtc_id')+''
							}

						}).always(function (aa, bb, cc) {
							
							var res = (bb == "success") ? cc : aa; // the response data differs based on success or error

							// hide loader, show alert
							jQuery('#as-help-form-changeemail .hint i').addClass("hidden")
								.parent().removeClass('hidden');
							jQuery('#as-help-form-changeemail .hint .alert').removeClass("hidden");
					
							// populate alert
							if(res.hasOwnProperty("responseJSON")){
								if(res.responseJSON.hasOwnProperty("dwc") && res.responseJSON.dwc.length){
									app._mtCreateDWC(res.responseJSON.dwc,{"prependTo": "#as-help-form-changeemail .hint .alert" });
								}else if(res.responseJSON.hasOwnProperty("msg") && res.responseJSON.msg.length){
									jQuery('#as-help-form-changeemail .hint .alert').text(res.responseJSON.msg)
								}else if(res.responseJSON.hasOwnProperty("err") && res.responseJSON.err.length){
									jQuery('#as-help-form-changeemail .hint .alert').text(res.responseJSON.err)
								}else{
								}
							} 
								
						}).done(function (aa, bb, cc) {

							// hide the fields, show logout
							jQuery('#as-help-form-changeemail .fields').addClass('hidden');
							jQuery('#as-help-form-changeemail .hint').parent().append(' <a href="/appbuilder/login/logout">Log out now</a>')

							// hide the ASA close buttons (to try force logout)
							jQuery('.asa-message-next, .asa-message-minimize, .asa-message-close').addClass('hidden')

						}).fail(function (aa, bb, cc) {
							jQuery('#as-help-form-changeemail .hint .alert').addClass("alert-error");
						})
					});
				} catch (er) {
					console.error("appendFormSearchword", er);
				}
			}, 100);

			return ""; // return "" so that {{ }} is not populated with undefined
		};


        





		/*
			appendFormSearchword
			Add the searchword form to the help menu
			Params
				`el` the element to append to
		*/

		app.appendFormSearchword = function (el) {
			// do this async, as the innerHTML will be replaced first
			setTimeout(function () {
				try {
					jQuery(`<form id="as-help-form-searchword">
                    <input type="submit" class="searchword" value="Search">
                    <span><input name="searchword" class="searchword"  placeholder="Search the Help Center"></span>
                    </form>`)
						.appendTo(jQuery(el))
						.submit(function (event) {
                            var ji = jQuery("#as-edu-popup-iframe-" + jQuery(".as-edu-popup-header .nav li.active").data("tab")	);
                            ji
                                .attr( "src",
                                    "/search?searchword=" + encodeURIComponent(
                                            jQuery('#as-help-form-searchword input[name="searchword"]').val()
                                        ) + "&Search= "
                                )
                                .removeClass('hidden'); 

                            //.show()
                            //.parent().show();
							// hide temporary form
							//jQuery('.as-edu-popup-content').text('')
							//maximise resourcepanel
							app._resourcepanelMaximize();

							event.preventDefault();
						});
				} catch (er) {
					console.error("appendFormSearchword", er);
				}
			}, 100);

			return ""; // return "" so that {{ }} is not populated with undefined
		};

		app.appendToVariable = function (variable, value, atFront) {
			// appends `value` to `variable`
			// Optionally if `atFront` is `true` adds the `value` to the front of the `variable`

			try {
				if (atFront)
					return this.setVariable(variable, value + this.getVariable(variable));
				else
					return this.setVariable(variable, this.getVariable(variable) + value);
			} catch (er) {
				app.handleError(er, "app.getItem(" + id + ")");
			}
		};

		app.applyScrollRules = function (el) {
			// Applies scroll rules to the current screen (based on classList)
			// This must only happen once for each screen load
			if (app._currentScreen != app._lastScrollRulesScreen) {
				app._lastScrollRulesScreen = app._currentScreen;

				if (
					el.classList.contains("scroll-disabled") ||
					(app.isMobile && el.classList.contains("mobile-scroll-disabled"))
				) {
					el.getElementsByClassName("items")[0].retrieve("scroll").disable();
				}
			}

			// show the scrollbar in Game Maker
			try {
				if (app.currentProduct == "gamemaker") {
					el
						.getElementsByClassName("items")[0]
						.retrieve("scroll").iScroll.options.hideScrollbar = false;
					app.refreshScroll();
				} else {
					el
						.getElementsByClassName("items")[0]
						.retrieve("scroll").iScroll.options.hideScrollbar = true;
				}
			} catch (er) {}
		};

		app.applyFieldFocusRules = function (id, el) {
			return;

			// THIS IS GLITCHY< SO DISabLE

			/*
			
			// When the field has focus, update the variable regualarly
			// This is needed because changes to a variable are not saved if you 
			//.  tap a button immediately after changing a field
		
			// Cancel all existing fieldIntervals (might be running from previous screen)
			// The previous screen might be on a div transitioned behind current screen
			jQuery.each(app._fieldIntervals,function(key,value){
				clearInterval(app._fieldIntervals[key]);
		
			});
		
			// look for input and textarea
			var selectorStr = ".item.textarea textarea, .item.textbox input"
			jQuery(el).find(selectorStr).each(function(){
				var jThis = jQuery(this);
				var fieldName = jThis.attr("name");
		
				// add a focus event
				jThis.focus(function(){
					var jField = jQuery(this);
					app._fieldIntervals[fieldName] = setInterval(function(){
						app.setVariable(fieldName,jField.val());
					},300);			
				});
		
				// add a blur event		
				jThis.blur(function(){
				var jThis = jQuery(this);
				clearInterval(app._fieldIntervals[fieldName]);
				
				});	  
		
			});
			
			// Clear the interval on blur
		
			*/
		};

		app.applyStyles = function (idOrSlug) {
			// Applies the styles from another app with `idOrSlug` to this app
			// The other app must be published.
			// Returns `this`

			if (!idOrSlug) return this;

			// make sure the appdata object exists
			if (!app._appData[idOrSlug]) app._appData[idOrSlug] = {};

			// check if appData loaded
			if (app._appData[idOrSlug].data) {
				// if already added, return
				if (app._appData[idOrSlug].stylesAdded) return this;

				// get the styles from splashhtml
				var css = app._appData[idOrSlug].data["html"].replace(
					/<style scoped>([\s\S]*)<\/style>[\s\S]*/,
					"$1"
				);
				// remove #app1234 from the css
				css = css.replace(/#app\d+/g, "#app" + app.id); //
				app.addStyles(css);

				// mark this as added
				app._appData[idOrSlug].stylesAdded = true;

				app.log("Style added: " + idOrSlug, [idOrSlug]);

				app.hideLoader();

				return this;
			}

			// If the appData hasn't been loaded, load now
			app.showLoader(10000);

			app.loadAppData(idOrSlug, function (idOrSlug) {
				// call this same function once loaded to put the styles on the page
				app.applyStyles(idOrSlug);
			});

			return this;
		};

		app.autoConnectDevices = function () {
			// Automatically connects to available devices.
			// The first available device becomes the defaultDevice

			// if the time has come to autoconnect...
			if (Date.now() >= app._autoConnectTimestamp + app._autoConnectInterval) {
				app._autoConnectTimestamp = Date.now();

				if (!app._autoConnectGotLocal) {
					app.getDevice("local"); // try get the local device
					app._autoConnectGotLocal = true;
				}

				var checkedDevices = [];

				// first add all known IPs as devices (to try auto connect)
				try {
					var ips = JSON.parse(localStorage["deviceWiFiIPs"]);
					jQuery.each(ips, function (i, val) {
						var url = "http://" + val + "/info";
						jQuery
							.ajax({
								url: url,
								crossDomain: true,
								timeout: 700,
								local_ip: val,
							})
							.done(function (a, b, c) {
								if (a && a.hasOwnProperty("connected") && a.connected) {
									//var identifier = String(a.id + '_' + this.local_ip).replace(/\./g, "_").replace(/[^\d\w_]/g, "");
									var identifier = a.name; // + '_wifi';

									var d = app.getDevice({
										id: identifier,
										local_ip: this.local_ip,
										isValidLocalIP: true,
									});
								}
							});
					});
				} catch (er) {}

				jQuery.each(app._devices, function (key, d) {
					d.getInfo(
						function (a, textStatus, b) {
							//onSucces

							// jQuery really messed up the arguments to .always...
							var data, jqXHR, errorThrown;
							if (a.statusCode) {
								// this happens when fail
								jqXHR = a;
								errorThrown = b;
							} else {
								// success
								data = a;
								jqXHR = b;

								/*
							// if multiple devices connect, the last one will become the default device.
							if (data.connected) {
								app._defaultDevice = key;
							} else if (app._defaultDevice == key) {
								app._defaultDevice = "";
							}
							*/

								// If connected, and no current defaultDevice, or if default not connected, set as default
								if (
									(data.connected && app._defaultDevice == "") ||
									!app.getDevice().connected
								) {
									// default device is not connected
									app._defaultDevice = key;
								}
							}
						},
						null,
						function (a, textStatus, b) {
							// onFail
							// jqXHR, textStatus, errorThrown

							// If this is the default device, clear it
							if (app._defaultDevice == key) {
								app._defaultDevice = "";
							}
						}
					);
				});
			}

			// run again if required
			if (app._autoConnectDevices) {
				setTimeout(app.autoConnectDevices, app._autoConnectInterval);
			}
		};

		app.blink = function (number, duration, noBgChange, id) {
			// Blinks the built-in LED
			// Optional `id` to use a specific `Device`
			// If no `id` passed in the default `Device` is used (`IOIO` is the initial default device)

			this.getDevice(id ? id : this._defaultDevice).blink(
				number,
				duration,
				noBgChange
			);

			return this;
		};

		app.blinkAllDevices = function (number, duration, noBgChange) {
			// Blink all connected devices
			// The parameters `number`,`duration`,`noBgChange` are passed through to `Device.blink()`
			// Return `this`

			for (var k in this._devices) {
				this._devices[k].blink(number, duration, noBgChange);
			}

			return this;
		};

		app._blocklyChangeHandler = function () {
			var output = jQuery("[name=blocky_output]")[0];

			var code = Blockly.JavaScript.workspaceToCode(Blockly.mainWorkspace);
			var editor = output.retrieve("editor");
			if (editor) {
				editor.setValue(code);
			}
			output.set("value", code);
		};

		app.callFunction = function (
			deviceId,
			called_function,
			parameters,
			onSuccess,
			onFail
		) {
			/*
			 Calls the specified `called_function` on the device`deviceId` sending `parameters` and calling `callback` on the return.
			 `params` should not be longer than 255 characters
			 [Optional] `deviceId` defaults to `app._defaultDevice`
			 Returns `this`
			*/

			var device = this.getDevice(deviceId ? deviceId : this._defaultDevice);
			device.callFunction(called_function, parameters, onSuccess, onFail);

			return this;
		};

		app.camelize = function (str) {
			// Return a single word formatted in Camel Case
			return str
				.replace(/[^a-z ]/gi, "")
				.replace(/(?:^\w|[A-Z]|\b\w|\s+)/g, function (match, index) {
					if (+match === 0) return ""; // or if (/\s+/.test(match)) for white spaces
					return index == 0 ? match.toLowerCase() : match.toUpperCase();
				});
		};

		app.cancelLoop = function (num) {
			// Cancel a loop function `num`

			if (
				app._loopFunctions.length > num &&
				typeof app._loopFunctions[num] === "object"
			) {
				app._loopFunctions[num].cancelled = true;
			}
		};

		app.clearDevice = function (deviceId) {
			// Clears the data from the device

			var device = this.getDevice(deviceId ? deviceId : this._defaultDevice);
			device.clear();

			return this;
		};

		app.clearDevices = function () {
			// Removes (forgets) all `Devices` that have been connected
			// Returns `this`

			this._devices = {};
			this._defaultDevice = null;
			return this;
		};

		app.clearInterval = function (identifierOrName) {
			// Clears the interval identified by `identifierOrName`
			// Optional `identifierOrName` can be the `identifier` of the interval, or a `name` supplied by `app.setInterval()`
			// If no  `identifierOrName` then all Intervals are cleared
			// Returns `this`

			try {
				// if no identifierOrName, clear all Intervals
				if (identifierOrName) {
					// try clear the interval using both forms
					window.clearInterval(identifierOrName);
					window.clearInterval(this._intervals[identifierOrName]);

					// Delete the property from _intervals
					delete this._intervals[identifierOrName];
				} else {
					var keys = Object.keys(this._intervals);
					for (var i = 0; i < keys.length; i++) {
						window.clearInterval(this._intervals[keys[i]]);

						// Delete the property from _intervals
						delete this._intervals[keys[i]];
					}
				}
			} catch (er) {
				app.handleError(er, "app.clearInterval()");
			}

			return this;
		};

		app.closeAcademyBrowse = function (callback) {
			jQuery(".popup-underlay.academy-browse").remove();
			jQuery(".popup-window.academy-browse").remove();
		};

		app.console = {
			// If _consoleOriginal exists, then we are using the _app_console
			// Object to handle console methods with extra functionality

			/***
			 * argToString - Converts one argument to one string
			 * @param: val
			 * @return: String
			 *
			 ***/
			argToString: function (val) {
				try {
					if (!val) {
						return "";
					}

					if (typeof val == "object") {
						// sometimes no keys, but there is a value
						if (Object.keys(val).length == 0 && String(val).length > 0) {
							return val;
						}
						return "\n" + JSON.stringify(val, null, "\t") + "\n";
					} else {
						return val + " ";
					}
				} catch (ex) {}

				return "";
			},

			/***
			 * argsToString - Converts an array of arguments to one string
			 * @param: arguments[] any number of arguments can be passed. Everything is converted to string.
			 * @return: String of all arguments concatentated
			 *
			 ***/
			argsToString: function (a, b, c, d, e, f, g, h) {
				var rVal = "";
				// typeof does not work with arguments array
				rVal += this.argToString(a);
				rVal += this.argToString(b);
				rVal += this.argToString(c);
				rVal += this.argToString(d);
				rVal += this.argToString(e);
				rVal += this.argToString(f);
				rVal += this.argToString(g);
				rVal += this.argToString(h);

				return rVal;
			},

			error: function () {
				if (app._debug) {
					if (window.hasOwnProperty("_consoleOriginal")) {
						app.console.writeToAppConsole.apply(this, arguments);
						return window._consoleOriginal.error.apply(window, arguments);
					} else {
						return console.error.apply(window, arguments);
					}
				}
			},

			log: function () {
				if (app._debug) {
					if (window.hasOwnProperty("_consoleOriginal")) {
						app.console.writeToAppConsole.apply(this, arguments);
						return window._consoleOriginal.log.apply(window, arguments);
					} else {
						return console.log.apply(window, arguments);
					}
				}
			},

			warn: function () {
				if (app._debug) {
					if (window.hasOwnProperty("_consoleOriginal")) {
						app.console.writeToAppConsole.apply(this, arguments);
						return window._consoleOriginal.warn.apply(window, arguments);
					} else {
						return console.warn.apply(window, arguments);
					}
				}
			},

			// Write the data to the app console
			writeToAppConsole: function () {
				if (jQuery("#_app_console").length) {
					// add the arguments to the end of the console
					jQuery("#_app_console").val(
						jQuery("#_app_console").val() +
							"\n" +
							this.argsToString.apply(this, arguments)
					);
					jQuery("#_app_console").scrollTop(
						jQuery("#_app_console")[0].scrollHeight
					);
				}
			},
		};

		app.contextMenuChanges = function (id, el) {
			// implement any context menu changes

			// oee - Only EDU Editable
			// This allows items (e.g. from Template) to be shared with Starter user but not allow editing, copying, only delete)
			if (!app.isEDUUser) {
				jQuery(el)
					.find(".items-inner .item.oee")
					.click(function () {
						app._contextMenuKeepDeleteOnly("oee");
					});
			}

			// oae - Only Admin Editable
			// This allows items (e.g. from Template) to be shared with EDU or Starter user but not allow editing, copying, only delete)
			if (!app.isAdminUser) {
				jQuery(el)
					.find(".items-inner .item.oae")
					.click(function () {
						app._contextMenuKeepDeleteOnly("oae");
					});
			}
		};

		app._contextMenuKeepDeleteOnly = function (aClass) {
			// Remove all options from the Context Menu except Delete
			// Used for oee and oae

			try {
				// Start an interval to look for the context menu to appear (takes a while)
				app._handlerContextOpen = setInterval(function () {
					// Look for li to appear
					if (jQuery("body>.open>.dropdown-menu").length) {
						clearInterval(app._handlerContextOpen);
						// another short delay, as other li might be added
						setTimeout(function () {
							jQuery(
								"body>.open>.dropdown-menu li:not(:contains(Delete))"
							).remove();
							jQuery("body>.open").addClass(aClass);
						}, 10);
						// and for good measure...
						setTimeout(function () {
							jQuery(
								"body>.open>.dropdown-menu li:not(:contains(Delete))"
							).remove();
							jQuery("body>.open").addClass(aClass);
						}, 200);
					}
				}, 10);

				// safety - force stop after a while
				setTimeout(function () {
					clearInterval(app._handlerContextOpen);
				}, 3000);
			} catch (er) {}
		};

        app._createBlockly2Loader = function () {
            app._createLoader("#action-target");
        }
        
		app.decodeHTML = (function () {
			// this prevents any overhead from creating the object each time
			var element = document.createElement("div");

			function decodeHTMLEntities(str) {
				if (str && typeof str === "string") {
					// strip script/html tags
					str = str.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim, "");
					str = str.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim, "");
					element.innerHTML = str;
					str = element.textContent;
					element.textContent = "";
				}

				return str;
			}

			return decodeHTMLEntities;
		})();

		app.deviceOrientationAbsoluteHandler = function (eventData) {
			// save the event data in a global app property
			app.deviceOrientationAbsoluteEvent = eventData;
		};

		app.deviceOrientationHandler = function (eventData) {
			// save the event data in a global app property
			app.deviceOrientationEvent = eventData;
		};

		app.deviceMotionHandler = function (eventData) {
			if (navigator && navigator.accelerometer) {
				// this is Cordova
				app.deviceMotionEvent = eventData;
			} else {
				app.deviceMotionEvent = eventData;
			}
		};

		app.devicesToString = function () {
			// Returns a string represenation of all the connected `devices`
			// Default layout is: id - local_ip

			var rVal = "";
			for (var k in this._devices)
				rVal +=
					this._devices[k].id +
					" - " +
					this._devices[k].variables.local_ip +
					"\n";

			return rVal;
		};

		app.digitalRead = function (pin, callback, idOrProps) {
			// v1.3.6 changing the order of the arguments, was: idOrProps,pin,callback
			// Read the digital state of `pin` for the device `idOrProps`
			// Optional `callback(data)` function is called passing the `data` of the Response
			// Returns `this`

			var props = this.idOrPropsToObject(idOrProps);
			this.getDevice(props).digitalRead(pin, callback);

			return this;
		};

		app.digitalWrite = function (pin, value, idOrProps) {
			// v1.3.6 changing the order of the arguments, was: idOrProps,pin,value
			// Write the digital `value` to `pin` for the device `idOrProps`
			// Returns `this`

			var props = this.idOrPropsToObject(idOrProps);
			this.getDevice(props).digitalWrite(pin, value);

			return this;
		};

		app._disableAppConsole = function () {
			// handle console logging through the app

			try {
				if (window.hasOwnProperty("_consoleOriginal")) {
					window.console = window._consoleOriginal;
					//	window._consoleOriginal = null;
				}
			} catch (er) {}
		};

		app.disableLogging = function () {
			if (!window.console) window.console = {};
			var methods = ["log", "debug", "warn", "info"];
			for (var i = 0; i < methods.length; i++) {
				console[methods[i]] = function () {};
			}
		};

		app._disableSaveInPanel = function (onClickFn) {
			// Disable the save button in the Edit Panel
			// If `onClickFn` method passed, add it to the save button
			try {
				// Remove the Save button
				jQuery(".span-toolbox .popup-loaded form button.btn-success").remove();

				// Add a different save button
				if (
					jQuery(".span-toolbox .popup-loaded form .edit-btns .tr-exp.tr-save")
						.length == 0
				) {
					jQuery(
						'<button type="button" class="btn btn-warning tr-exp tr-save"><i class="icon-save"></i> Upgrade</button>'
					)
						.prependTo(jQuery(".span-toolbox .popup-loaded form .edit-btns"))
						.click(onClickFn);
				}
			} catch (er) {}
		};

		app.disableScroll = function () {
			app.getScreen().disableScroll();
			return this;
		};

		app.doAppBuilderNoApp = function () {
			// Show a message if in AppBuilder and no app is open

			// Only show if URL shows no current app, or no app.id
			if (window.location.hash == "#1/1" && !(parseInt(app.id) > 1)) {
				// Only do stuff if not already done
				if (jQuery(".span-toolbox>.appbuilder-no-app").length == 0) {
					jQuery(".span-toolbox").append(
						'<div class="appbuilder-no-app"></div>'
					);

					// Add the DWC
					app._mtCreateDWC("appbuilder-no-app", {
						appendTo: ".span-toolbox>.appbuilder-no-app",
					});

					// make sure the DWC is shown
					jQuery(".span-toolbox>.appbuilder-no-app").show();
				} else {
					// make sure the DWC is shown
					jQuery(".span-toolbox>.appbuilder-no-app").show();
				}

				// Immediately hide when clicking Open App
                jQuery(".navbar-fixed-top a , .resourcepanel,  .appsscreen .apps, .appsscreen .app-icon").on("click",
					function () {
						// Hide the div, but don't set undone, as the message might appear on loop
						jQuery(".span-toolbox>.appbuilder-no-app").hide();
						
					}
				);
			} else {
				jQuery(".span-toolbox>.appbuilder-no-app").hide();
			}
		};

		/**
		 * Runs whenever the DOM subtree is modified, and is used to trigger DOM updates to customise the UI
		 * @method doDOMSubtreeModified
		 * @ignore
		 *
		 */
		//
		
		// DOM event DOM change DOM update DOM modified
		app.doDOMSubtreeModified = function (mutations) {
			var origType = app._popupContainerType;
			var origWindowType = app._popupWindowType;
			var origItemType = app._popupContainerItemType;

			// determine the item type

			if (jQuery("#popup-container input[name=item_type]").length) {
				// the item type is stored in a form input
				var type = jQuery("#popup-container input[name=item_type]").val();
				// only set it if it has changed
				if (app._popupContainerItemType != type) {
					app._popupContainerItemType = type;
				}
			} else {
				app._popupContainerItemType = "";
			}

			// determine the container type

			if (
				jQuery(
					'#popup-container .sliding .sliding-inner h1:contains("Rearranging Items")'
				).length
			) {
				app._popupContainerType = "move_items";
			} else if (
				app._popupContainerType != "edit_item" &&
				jQuery("#popup-container .tab-pane.active#edit_item").length
			) {
				app._popupContainerType = "edit_item";
			} else if (
				app._popupContainerType != "edit_item_action" &&
				jQuery("#popup-container .tab-pane#edit_item").length &&
				jQuery("#popup-container .tab-pane.active#edit_action").length
			) {
				app._popupContainerType = "edit_item_action";
			} else if (
				app._popupContainerType != "edit_item_action_selector" &&
				jQuery("#popup-container .tab-pane#edit_item").length &&
				jQuery("#popup-container .tab-pane.active#edit_action_selector").length
			) {
				app._popupContainerType = "edit_item_action_selector";
			} else if (
				app._popupContainerType != "edit_item_type" &&
				jQuery("#popup-container .tab-pane#edit_item").length &&
				jQuery("#popup-container .tab-pane.active#edit_type").length
			) {
				app._popupContainerType = "edit_item_type";
			} else if (
				app._popupContainerType != "edit_item_style" &&
				jQuery("#popup-container .tab-pane#edit_item").length &&
				jQuery("#popup-container .tab-pane.active#edit_style").length
			) {
				app._popupContainerType = "edit_item_style";
			} else if (
				app._popupContainerType != "edit_item_action" &&
				jQuery("#popup-container .tab-pane#edit_item").length &&
				jQuery("#popup-container .tab-pane.active#edit_advanced").length
			) {
				app._popupContainerType = "edit_item_advanced";
			} else if (
				app._popupContainerType != "edit_item_help" &&
				jQuery("#popup-container .tab-pane#edit_item").length &&
				jQuery("#popup-container .tab-pane.active#edit_help").length
			) {
				app._popupContainerType = "edit_item_help";
			} else if (
				app._popupContainerType != "edit_screen" &&
				jQuery("#popup-container #edit_screen").length
			) {
				app._popupContainerType = "edit_screen";
			} else if (
				app._popupContainerType != "edit_tab" &&
				jQuery("#popup-container #edit_item").length &&
				jQuery('#popup-container #edit_item input[name="tab_image"]').length
			) {
				app._popupContainerType = "edit_tab";
			} else if (
				app._popupContainerType != "edit_app" &&
				jQuery("#popup-container #edit_app").length
			) {
				app._popupContainerType = "edit_app";
			} else if (
				jQuery(
					"#popup-container .sliding.toolbox:not(.hidden-left) #nav-tabs_game.active"
				).length &&
				jQuery("#popup-container  .sliding.toolbox").css("display") != "none"
			) {
				app._popupContainerType = "game_tools";
			} else if (
				jQuery(
					".appbuilder #popup-container .sliding.toolbox:not(.hidden-left) #tab_items.active"
				).length &&
				jQuery("#popup-container  .sliding.toolbox").css("display") != "none" &&
				jQuery(".app .screen.list").length
			) {
				app._popupContainerType = "appbuilder_tools_list";
			} else if (
				jQuery(
					".appbuilder #popup-container .sliding.toolbox:not(.hidden-left) #tab_items.active"
				).length &&
				jQuery("#popup-container  .sliding.toolbox").css("display") != "none" &&
				jQuery(".app .screen.map").length
			) {
				app._popupContainerType = "appbuilder_tools_map";
			} else if (
				jQuery(
					".appbuilder #popup-container .sliding.toolbox:not(.hidden-left) #tab_items.active"
				).length &&
				jQuery("#popup-container  .sliding.toolbox").css("display") != "none" &&
				jQuery(".app .screen.photo").length
			) {
				app._popupContainerType = "appbuilder_tools_photo";
			} else if (
				jQuery(
					".appbuilder #popup-container .sliding.toolbox:not(.hidden-left) #tab_items.active"
				).length &&
				jQuery("#popup-container  .sliding.toolbox").css("display") != "none" &&
				jQuery(".app .screen.icon").length
			) {
				app._popupContainerType = "appbuilder_tools_icon";
			} else if (
				jQuery("#popup-container .sliding .sliding-inner .qrimage>img").length
			) {
				app._popupContainerType = "share_qrcode";
			} else if (
				jQuery(
					'#popup-container .sliding .sliding-inner form[action="/appbuilder/apps/save"]'
				).length
			) {
				app._popupContainerType = "app_settings";
			} else if (
				window.location.hash == "#1/1" &&
				!(parseInt(app.id) > 1) &&
				jQuery(".span-toolbox>#popup-container>.toolbox.hidden-right-noapp")
					.length
			) {
				app._popupContainerType = "apps-screen";
			} else if (
				app._popupContainerType != "" &&
				jQuery("#popup-container>div").length == 1
			) {
				// no specific type, but it has changed from what it was, so set to empty
				app._popupContainerType = "";
			} else {
			}

			// .popup-window changes
			// NOTE: These set a different variable, app._popupWindowType (not containerType)
			if (
				jQuery(
					'.popup-window .popup-loaded .popup-content>h1:contains("Publish")'
				).length
			) {
				app._popupWindowType = "publish";
			} else if (jQuery(".popup-window .popup-loaded .popup-content").length) {
				// catch all for any other popup
				app._popupWindowType = "other";
			} else if (app._popupWindowType != "") {
				// can't identify the popupWindow, so clear it
				app._popupWindowType = "";
			}

			//  console.warn('is same? ',app._popupContainerType ,'orig:',origType);

			// If the container type has changed
			if (app._popupContainerType != origType) {
				if (app._popupContainerType == "edit_item") {
					// if there is a once function,  call it
					if (app._onceEditItem) {
						var callback = app._onceEditItem;
						app._onceEditItem = null;
						callback.call();
					}

					// Do some general stuff for all panels
					app._onLoadEditPanel();

					// Show error messages
					app._onLoadEditPanelShowMessages();


					if (app._popupContainerItemType == "location") {
						app._onLoadEditLocation();
					}

					// If Blockly iframe, prepare new Blockly
					if (app._onLoadEditPanelHasBlockly()) {
						app._onLoadEditItemActionPrepareBlockly();
					}

					// For edit_item with JavaScript action, re-initiate the CodeMirror editor
					// do it here to avoid UI showing old editor when going to Aciton tab
					if (jQuery("#action_js").length) {
						app._initializeCodeEditor(document.getElementById("action_js"), {
							mode: document
								.getElementById("action_js")
								.get("data-editor-type"),
							readOnly: document.getElementById("action_js").get("readonly"),
						});
					}

					// Edit Item Panel onLoad
					if (app.currentProduct == "gamemaker") {
						app.game._onLoadEditPanel(); // this is the code for app.game specifically
					}
				} else if (app._popupContainerType == "edit_item_action") {
					app._onLoadEditItemAction();
				} else if (app._popupContainerType == "edit_item_help") {
					// Add any extra config options
					app._onLoadEditPanelConfigOptions();
				} else if (app._popupContainerType == "edit_screen") {
					// Edit Screen Panel onLoad

					// Do some general stuff for all panels
					app._onLoadEditPanel();

					try {
						// Hide the Is Secure selector
						jQuery('.control-group:contains("screen_secured")').hide();
					} catch (er) {}
				} else if (app._popupContainerType == "edit_app") {
					// Edit App Panel onLoad

					// Do some general stuff for all panels
					app._onLoadEditPanel();
				} else if (app._popupContainerType == "edit_tab") {
					// Edit Tab Panel onLoad

					// Do some general stuff for all panels
					app._onLoadEditPanel();
				} else if (app._popupContainerType == "appbuilder_tools_list") {
					// AppBuilder tools

					app._onAppBuilderTools("list");
				} else if (app._popupContainerType == "appbuilder_tools_map") {
					// AppBuilder tools

					app._onAppBuilderTools("map");
				} else if (app._popupContainerType == "appbuilder_tools_photo") {
					// AppBuilder tools

					app._onAppBuilderTools("photo");
				} else if (app._popupContainerType == "appbuilder_tools_icon") {
					// AppBuilder tools

					app._onAppBuilderTools("icon");
				} else if (app._popupContainerType == "game_tools") {
					// game tools

					if (app._onGameTools) {
						try {
							app._onGameTools.call(app.game.this);
						} catch (er) {}
					}

					if (app._onceGameTools) {
						app.hideDeepLoader();
						try {
							app._onceGameTools.call(app.game.this);
							app._onceGameTools = null;
						} catch (er) {}
					}
				} else if (app._popupContainerType == "move_items") {
					// in Game Maker, stop the game after moving
					if (app.isAppBuilder && app.currentProduct == "gamemaker") {
						jQuery("#popup-container .sliding .sliding-inner .btn-success").on(
							"click",
							function () {
								app.game.stop();
							}
						);
					}
				} else if (app._popupContainerType == "share_qrcode") {
					// make sure it's an https url
					/*
					Google Chart API deprecated, replaced with QuickChart.io
					OLD URL: https://chart.apis.google.com/chart?chl=https%3A%2F%2Fapps.appshed.com%2F1690405&chs=200x200&choe=UTF-8&cht=qr&chld=L%7C2
					New URL: https://quickchart.io/qr?text=https%3A%2F%2Fapps.appshed.com%2F1690405&chs=200x200&choe=UTF-8&cht=qr&chld=L%7C2
					
					Can  install on-premise version from https://github.com/typpo/quickchart
					*/

					var img = jQuery(jQuery("#popup-container .sliding .sliding-inner .qrimage>img")[0]);

					var oldSrc = img.attr("src");

					// use https in QR code
					var newSrc = oldSrc.replace(/chl=http/, "chl=https");
					// use quickchart not google api
					newSrc = newSrc.replace(/chart\.apis\.google\.com\/chart/, "quickchart.io/qr");
					// replace chl with text param
					newSrc = newSrc.replace(/chl=/, "text=");

                    var iotSrc = newSrc.replace(/=https/, "=http");


					img.attr("src", newSrc);

					img.parent().append('<br><br><h4>For IoT/robotics use this link</h4><img src="' + iotSrc + '"><br>(HTTP/insecure link - requierd for IoT)'	);

				} else if (app._popupContainerType == "app_settings") {
					// save the form html in a vairable - for various lookups
					app._app_settings_form_jQuery = jQuery(
						jQuery(
							'#popup-container .sliding .sliding-inner form[action="/appbuilder/apps/save"]'
						).html()
					);

					// populate some app settings
					if (app._app_settings_form_jQuery.find("#app_galleryhide").length) {
						app.settings.app_galleryhide =
							app._app_settings_form_jQuery.find("#app_galleryhide")[0].checked;
					} else {
						// did not find the settings.
					}

					// Special case: if the App Settings was opened automatically to extract the data, then...
					//  call a special callback function.... if it exists
					if (
						app._app_settings_auto_open_callback &&
						typeof app._app_settings_auto_open_callback == "function"
					) {
						try {
							app._app_settings_auto_open_callback.call();
						} catch (error) {
							console.error("_app_settings_auto_open_callback.call()", error);
						}
						app._app_settings_auto_open_callback = null;
					}
				} else if (app._popupContainerType == "apps-screen") {
					app.doAppBuilderNoApp();
					// Something hides the div, so make sure to show it
					setTimeout(() => {
						jQuery(".span-toolbox>.appbuilder-no-app").show();
					}, 2000);
				} else if (app._popupContainerType == "") {
					// Nothing being edited... some tools
				}

				// trigger the event
				document.dispatchEvent(app.events["ase-popup-loaded"]);
			}

			// If the window type has changed
			if (app._popupWindowType != origWindowType) {
				// for ANY popup

				if (app._popupWindowType.length) {
					// Image Chooser needs different rule
					if (jQuery(".popup-window .popup-content.upload-picker").length) {
						jQuery(".popup-window .popup-content.upload-picker").css(
							"height",
							"95%"
						);
					} else {
						// fix the popup height to auto fit contents
						jQuery(".popup-window, .popup-window .popup-content").css(
							"height",
							"auto"
						);
					}
				}

				if (app._popupWindowType == "publish") {
				} else if (app._popupWindowType == "other") {
				}
			}
		};


		// When the Edit Item panel Saved or Deleted
		app.doDOMSubtreeItemsModified = function () {
			var origType = app._itemsListType;

			// determine the container type
			if (jQuery(".app-navigator-inner .screen.list.loading").length) {
				app._itemsListType = "list_loading";
			} else if (jQuery(".app-navigator-inner .screen.list").length) {
				app._itemsListType = "list_screen";
			} else if (jQuery(".app-navigator-inner .screen.appsscreen").length) {
				app._itemsListType = "apps_screen";
			} else if (
				app._itemsListType != "" &&
				jQuery(".app-navigator-inner>div").length >= 1
			) {
				// no specific type, but it has changed from what it was, so set to empty
				app._itemsListType = "";
			}

			// If the container type has changed
			if (app._itemsListType != origType) {
				if (app._itemsListType == "apps_screen") {
					// Set a flag so we know later that a new app was selected
					window._wasOnAppsScreen = true;

					setTimeout(function () {
						// If there is a New App icon
						jQuery(".app-icon.newapp .image").css(
							"background-image",
							"url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/appbuilder/add-newpng.png	)"
						);
						jQuery(".appsscreen .home-bar-buttons .title").hide();
					}, 20);
				}

				if (app.currentProduct == "gamemaker") {
					if (app._itemsListType == "list_screen") {
						// If new app loaded, make sure the filters are applied
						if (window._wasOnAppsScreen) {
							window._wasOnAppsScreen = false;

							app.game._setFilters();
						}
					}
				}

				if (app.currentProduct == "appbuilder") {
					if (app._itemsListType == "list_screen") {
						// highlight JavaScript Errors
						// app._showJavaScriptWarnings(); // no longer doing this since new CodeMirror editor shows inline errors. Maybe reconsider
					}
				}
			}
		};


		app.doDOMSubtreeModifiediFrame = function (iframeEl,id,mutations) {
			var origType = app._iframeContainerType[id];
            var jEl = jQuery(iframeEl);

            var r = new RegExp('/', 'g');

			
			var path =  String(iframeEl.contentWindow.location.pathname).replace(r, '_').replace(/^_/,''); // e.g. appbuilder_academy


			// default type is the path
			app._iframeContainerType[id] = path;

			// determine the sub container type
			if(path == "appbuilder_academy"){

				// sub sections on this page
				if(jEl.contents().find('')){

				}
				
			} else if(path == "appbuilder_academy_userslist"){
				

				// sub sections on this page
				if(jEl.contents().find('form[action="/appbuilder/academy/importusers"]').length){
					app._iframeContainerType[id] = path + '_importusers';
				}else if(jEl.contents().find('form[action="/appbuilder/academy/edituser"]').length){
					app._iframeContainerType[id] = path + '_edituser';
				}
			
			}




			// HANDLERS: If the container type has changed

			if (app._iframeContainerType[id] != origType) {

				if (app._iframeContainerType[id]  == "appbuilder_academy_userslist_importusers") {

					// Change endpoint from workflow.appshed.com/webhook TO appshed.com/webhook
					// CloudFront has a Lamda@Edge function to add the worklflow Host header

					// Do various things to combine two forms to make it look like one page with 2 steps
					var jEl = jQuery('#as-edu-popup-iframe-edu');
					jEl.contents().find('form[action="/appbuilder/academy/importusers"]').addClass('original');
					jEl.contents().find('form.original').clone().removeClass('original').addClass('clone').prependTo(jEl.contents().find('form.original').parent());
					jEl.contents().find('form.clone')
						.attr('target','check-csv')
						.attr('enctype',"multipart/form-data")
						.attr('action','https://appshed.com/webhook/18d22a0f-c878-4e78-a01f-22bd03c78227')
					jEl.contents().find('form.clone .uploader-upload').after('<input name="file" type="file" /><input class="btn btn-large btn-warning" type="submit" name="submitBtn" value="Check CSV" />');
						jEl.contents().find('form.clone .uploader-upload').remove();

					jEl.contents().find('form.clone .popup-content>.control-group>b').remove();
					jEl.contents().find('form.clone .popup-content>.control-group>.control>.help-block').remove();
					jEl.contents().find('form.clone .uploader-message').html('<h4>Step 1: Check CSV for errors</h4>');
					jEl.contents().find('form.clone .popup-content').css('height','unset');
					jEl.contents().find('form.clone .popup-content a[data-popup="close"]').parent().remove();

					jEl.contents().find('form.original .popup-content>.control-group>b').before("<p>NOTE: Please check the CSV for errors before uploading. <br>If you're uploading a lot of users at a time it may take a while to process all of them.");
					jEl.contents().find('form.original .popup-content>.control-group>b').remove();
					jEl.contents().find('form.original').css('background-color','white');
					jEl.contents().find('form.original .navbar').remove();
					jEl.contents().find('form.original .uploader-message').html('<h4>Step 2: Upload CSV</h4>');
					jEl.contents().find('form.original .uploader-upload').addClass('btn-primary');
					jEl.contents().find('form.original .popup-content>.control-group>.control>.help-block').prepend('<hr />');

					jEl.contents().find('form.clone').on('submit',function(){
						jEl.contents().find('.check-csv-msg').addClass('loading').removeClass('hidden');
					})

					jQuery('<iframe>', {
						src: '',
						id:  'check-csv',
						name:  'check-csv',
						frameborder: 0,
						scrolling: 'no'
						}).appendTo(jEl.contents().find('body'));

						
						jEl.contents().find('iframe#check-csv').on("load",function(e){
							app._onLoadiFrameCallback.bind(this)(e,{"observer": false}); 
						})
					// add a msg block after the check-csv form
					jEl.contents().find('form.clone .uploader').after('<div class="check-csv-msg loading hidden" style="margin: 10px 0px;background-color: #e7e7e7;min-height: 40px;"><div class="check-csv-msg-loadingtext" style="padding: 10px;">Checking CSV</div></div>');

					

					
					
					
						
						jEl.contents().find('iframe#check-csv').on("load",function(e){
							app._onLoadiFrameCallback.bind(this)(e,{"observer": false}); 
						})
					
				} else if (app._iframeContainerType[id]  == "") {
					// Nothing being edited... some tools
				}

				// trigger the event
				document.dispatchEvent(app.events["ase-iframe-loaded"]);
			}


			// For these cases, do the checks each time

			if(id == "check-csv"){
				app.edu._callbackCheckCSV(iframeEl,id);

				document.dispatchEvent(app.events["ase-iframe-loaded"]);

			}
		};




		app.doImports = function () {
			// Import required libraries
			// The libraries are listed in the App Description:
			//   Add a line(s) starting with the keyword `import` followed by a list of libraries to import
			//   Additional libraries can be on the same line (space or comma delimited) or on a new line with the `import` keyword
			//   e.g. `import libdemo`
			// Returns `this`

			// Requires jQuery and ajaxq
			// Load the libraries using ajaxq to allow for dependencies on previous libraries

			// if jquery not ready, wait and call again
			if (!app._scriptLoaded_jquery || !app._scriptLoaded_ajaxq) {
				setTimeout(function () {
					app.doImports();
				}, 500);
				return this;
			}

			var libraries = app.getLibraries();

			for (var i = 0; i < libraries.length; i++) {
				app.import(libraries[i]);
			}

			app._importsDone = true;

			return this;
		};

		app._doJSLint = function (code, callback) {
			// Use the JSLint module to get error messages
			// Optional `callback` function

			jQuery("#JSLINT_SOURCE").val(code);
			jQuery("[name='JSLint']").click();

			if (!callback) {
				callback = function () {
					var msg = jQuery("#JSLINT_WARNINGS_LIST")[0];
					jQuery(msg).find("cite").prepend("Line: ");
					console.warn("JSLint warning: ", msg);
				};
			}

			setTimeout(function () {
				callback.apply();
			}, 1000);
		};

		app.doReady = function () {
			// Calls all functions that have been set for app onReady
			// returns `this`

			for (var i = 0; i < app._readyFunctions.length; i++) {
				try {
					app._readyFunctions[i].apply(app._readyFunctionsParams[i]);
				} catch (er) {}
			}
		};


        /*
			doResendWelcomeEmail
			
			Global variables
				`el` the element that was clicked
		*/
		app.doResendWelcomeEmail = function (options) {

            try {
                
                var jEl = jQuery(el);

                // Show loader
                if(jEl.find('.icon-spinner').length == 0){
					jEl.prepend('<i class="icon-spinner icon-spin " style="zoom: 2;"></i>');
				}
                jEl.find('>*').hide();
				jEl.find('.icon-spinner').show();

                // add a hint alert box
                if(jEl.parent().find('.welcomemeail.hint').length == 0){
                    jEl.after(`
                        <div class="welcomemeail hint hidden">
                            <div class="alert"></div>	
                        </div>
                    `)
                }
                var jAlert = jEl.parent().find('.welcomemeail.hint .alert');

                // hide the alert hint
                jAlert.text("")
                .removeClass("alert-error")
                .parent().addClass('hidden');

                // disabled the button while ajax runs
                jEl.find('input').attr("disabled","disabled");

                jQuery.ajax({
                    url: "https://workflow.appshed.com/webhook/506274e2-bba4-428b-a56f-48f115628c47",
                    type: "POST",
                    xhrFields: { withCredentials: true },
                    data: {
                        "email":app.user.email,
                        "user_id":app.user.id,
                        "mtc_id":app.getCookieVal('mtc_id')+''
                    }

                }).always(function (aa, bb, cc) {
                    var res = (bb == "success") ? cc : aa; // the response data differs based on success or error

                    jEl.find('input').removeAttr("disabled");
						
					// Hide loader
					//jEl.removeClass('loading').hide();
					jEl.find('.icon-spinner').hide();

                    // If the response includes dwc, show this as the alert
                    if(res.hasOwnProperty("responseJSON") && res.responseJSON.hasOwnProperty("dwc")){
                        jAlert.text("").parent().removeClass('hidden');
                        app._mtCreateDWC(res.responseJSON.dwc,{"prependTo": jAlert });

                        if(res.responseJSON.hasOwnProperty("err")){
                            jAlert.addClass("alert-error");
                            console.error('doResendWelcomeEmail',res.responseJSON.err)
                        }
                    }else{
                        jAlert.text(res.responseJSON.err)
                        .addClass("alert-error")
                        .parent().removeClass('hidden')
                    }
                })
            } catch (er) {
                console.error("doResendWelcomeEmail", er);
            }

			return ""; // return "" so that {{ }} is not populated with undefined
		};


		app.doScreenImports = function (id, el) {
			// Import libraries referenced on the current screen

			jQuery(".import").each(function () {
				try {
					// presume a text item with the library name as the only content in the .html
					// also look for an Icon with content in .title
					var el = jQuery(this);
					var content = el.find(".html").first().text();
					if (el.hasClass("icon")) {
						content = el.find(".title").first().text();
					}
					if (content) {
						app.import(content, function () {
							setTimeout(function () {
								el.css("display", "none");
							}, 2000);
						});
					}
				} catch (er) {
					//
				}
			});
		};

		app.doScreenOnLoad = function (id, el) {
			// Run any onLoad handlers for for the current screen
			// Return `this`

			// temporarily set a variable "done" so that the method is not called twice.
			if (app._screenOnLoadDone) {
				return this;
			} else {
				app._screenOnLoadDone = true;
				setTimeout(function () {
					// Set "done" back to false ready for the next screen load
					app._screenOnLoadDone = false;

					jQuery(el)
						.find(".event.onLoad.item")
						.each(function () {
							var el = this;

							if (!app.isAppBuilder) {
								setTimeout(function () {
									app.getItem(el.id, el).callActions();
								}, 1);
							}
						});
				}, 1000);
			}

			return this;
		};

		app._doScreenOnLoadEditIcons = function (id, el) {
			// add some classes to show edit icons. A short delay is needed for the elements to load
			setTimeout(() => {
				// for the App List screen, skip this
				if (app._lastScreenId != 1) {
					var el = el || document;

					// Gallery Screen items need a cover div containing the pencil
					jQuery(el)
						.find(
							".phone-container .screen.photo .items .item.photo .image-container"
						)
						.css("position", "relative")
						.prepend('<div class="hover-show-edit"></div>');

					jQuery(el)
						.find(
							".phone-container .screen .header .title, .phone-container .tab-bar .tab-inner, .phone-container .screen .items .item"
						)
						.addClass("hover-show-edit");
				}
			}, 500);
		};

		app.doThemes = function () {
			// Apply required themes
			// The themes are listed in the App Description:
			//   Add a line(s) starting with the keyword `theme` followed by the theme name
			//   Additional themes can be on the same line (space or comma delimited) or on a new line with the `theme` keyword
			//   e.g. `theme urban`
			// Returns `this`

			var themes = app.getThemes();

			for (var i = 0; i < themes.length; i++) {
				app.applyStyles(themes[i]);
			}

			return this;
		};

		app._enableAppConsole = function () {
			// handle console logging through the app

			if (!window.hasOwnProperty("_consoleOriginal")) {
				window._consoleOriginal = console;
			}
			window.console = app.console;
		};

		app.enableScroll = function () {
			app.getScreen().enableScroll();
			return this;
		};



		app.findClass = function (element, className) {
			// Returns the first `DOM Element` matching  `className`
			return element.querySelector("." + className);
		};

		app.findLocalDevices = function (address) {
			// Finds devices on the same LAN
			// The devices are "linked" to the app - stored in `app._devices`
			// Optional `address` is the local IP address of the app.
			// If `address` is ommitted the app will try to determine it's own Local IP (must be online to do this)
			// The first device found will be made the default device

			// iPhone Personal Hotspot Tethering IP range... 172.20.10.1-172.20.10.3
			// Android Hotspot IP 192.168.42.x

			try {
				if (!address || address == "") {
					// try get the local address, then re-call this method
					this.getLocalIP(function (ip_addr) {
						app.findLocalDevices(ip_addr);
					});
				} else {
					// Scan the local subnet of `address` looking for devices

					var ipParts = String(address).split(".");
					var ipPartial =
						ipParts[0] + "." + ipParts[1] + "." + ipParts[2] + ".";

					// go through all IP addresses changing the last number only
					for (var i = 0; i < 255; i++) {
						var ipAddress = ipPartial + i;
						var thisURL = "http://" + ipAddress;
						var response;
						jQuery
							.ajax({
								url: thisURL + "/info",
								ipAddress: ipAddress,
								crossDomain: true,
								timeout: app._scanIPTimeout,
							})
							.done(function (data) {
								// inspect the `data` sent to determine if it is a valid device
								// Expect to find `name` and `id` in the `data` object
								if (data && data.id && data.name) {
									// get the device, passing the properties
									// The local_ip is valid, so indicate this in props
									var props = {
										id: data.id,
										name: data.name,
										hardware: data.hardware,
										connected: data.connected,
										local_ip: this.ipAddress,
										isValidLocalIP: true,
									};
									var device = app.getDevice(props);
									device.info = data;

									// If IOIO stil the default, or no default, make this device default
									if (
										!app._defaultDevice ||
										app._defaultDevice == "" ||
										app._defaultDevice == "IOIO"
									)
										app._defaultDevice = data.id;

									// Some devices (Arduino) sometimes do not return variables - due to requests in rapid succession.
									// Do getInfo() to retry
									if (!data.variables || !data.variables.local_ip)
										device.getInfo();
								}
							});
					}
				}
			} catch (er) {
				app.handleError(er, "app.findLocalDevices()");
			}

			return this;
		};

		app.findParentItem = function (element) {
			// Returns the `Item` containing the DOM `element`
			// This traverses up each `parentElement`
			// If it finds an `Item` it returns the `Item` object

			try {
				if (element && element.classList) {
					if (element.classList.contains("item"))
						return app.getItem(element.id);

					// if we reach the 'screen' element, return
					if (element.classList.contains("screen")) return null;

					// call this method on the parent
					return app.findParentItem(element.parentElement);
				}
			} catch (er) {
				app.handleError(er, "app.findParentItem()");
			}

			return null;
		};

		app._insertDemoApp = function (parentSelector, url, options) {
			// Insert a demo app (iframe) into parentSelector
			// Each parentSelector can have only one demo app, the class will be demo-app-iframe
			// Updates the demo app if it already exists
			// options:

			try {
				jQuery(parentSelector).each(function () {
					var jParent = jQuery(this);

					// Add demo-app-iframe inside parent
					if (jParent.find(".demo-app-container").length == 0) {
						jParent.prepend(
							'<div class="demo-app-container phone background full iphoneX ios7style"></div>'
						);
					}
					if (
						jParent.find(".demo-app-container .demo-app-iframe").length == 0
					) {
						jParent
							.find(".demo-app-container")
							.prepend(
								'<iframe class="demo-app-iframe phone-inner" frameborder="0" xwidth="320" xheight="691" src=""></iframe><div class="demo-app-link"><a href="' +
									url +
									'" target="_blank">Open app in new tab</a></div>'
							);

						// append the loader
						jParent
							.find(".demo-app-container")
							.append(
								' <div class="demo-app-loader" style="     position: absolute;     left: 0px;     right: 0;     top: 0;     bottom: 0;     background-color: white; "><div style="width: 50%;height: 100%;margin: 156px auto;text-align: center;"><i class="icon-spinner icon-spin " style="     zoom: 6;     color: var(--gm-color-low); "></i><div class="deep-loader-text" style="margin-top: 30px; color: var(--gm-color-low);"></div></div></div>'
							);
					}

					// show the loader for a second (hard to know when an iframe has actually loaded)
					jParent
						.find(".demo-app-container .demo-app-loader")
						.css("display", "inline-block");
					setTimeout(function () {
						jParent
							.find(".demo-app-container .demo-app-loader")
							.css("display", "none");
					}, 1000);

					// set the url
					jParent.find(".demo-app-iframe").attr("src", url);
				});
			} catch (er) {}
		};

		app._fixCourseDemoAppLink = function () {
			if (jQuery('#yoo-zoo .item .pos-bottom h3:contains("Demo app")').length) {
				var url = jQuery(
					'#yoo-zoo .item .pos-bottom .element:contains("Demo app")'
				)
					.text()
					.replace(/Demo app/, "")
					.trim();
				if (url > "") {
					app._insertDemoApp("#yoo-zoo .ingredients .media-right", url);
				}
			}
		};

		// change the links in course catalog to custom action
		app._fixCourseCatalogLinks = function (selector, sourceSelector) {
			window.scroll(0, 0);

			// make the links inside selector load inside the selector
			jQuery(selector + " a").click(function (event) {
				var link = jQuery(this);
				var href = String(link.attr("href"));

				// If full URL then do default
				if (href.match(/^http/)) {
					return;
				}

				event.preventDefault(); //prevent default action

				// check it has href
				if (href.length > 0) {
					app._showCoursesLoad(href, selector, sourceSelector);

					/*
					app._showContainerLoader();

					// load the content into the 
					jQuery(selector).load(href + sourceSelector, null, function () {

						app._fixCourseCatalogLinks(selector, sourceSelector);
						app._fixCourseDemoAppLink();
						app._hideContainerLoader();
					});
					*/
				}
			});

			// If there is a Course ID, create the link to start course

			if (
				jQuery('#yoo-zoo .item .pos-bottom h3:contains("Course ID")').length
			) {
				var id = jQuery(
					'#yoo-zoo .item .pos-bottom .element:contains("Course ID")'
				)
					.text()
					.trim()
					.replace(/\D/g, "");
				if (id > "" && parseInt(id) > 0) {
					// make sure it hasn't already been done
					if (jQuery(".yoo-zoo .pos-ingredients .start-course").length == 0) {
						// Add the button

						var jDiv = jQuery('<div class="start-course"></div>');
						jQuery(".yoo-zoo .pos-ingredients").prepend(jDiv);
						jQuery(
							'<button type="submit" class="btn btn-success">Start this course</button>'
						)
							.click(function () {
								// open the Academy
								app.openAcademyPanel();
								app.showAcademyLoader();

								// repeatedly check
								var homeClicked = false;
								app.setInterval(
									function () {
										// If we are on Home, do callback
										if (jQuery("#academy .academy-intro").length) {
											app.clearInterval("handler_tryopenAcademyHome");

											// Click on the All Courses link - which has cid=21
											jQuery("#academy a").each(function () {
												if (/cid=21/.test(this.href)) {
													this.click();

													// keep looking for the course ID
													app.setInterval(
														function () {
															// If we find the link
															jQuery("#academy a").each(function () {
																var myRE = new RegExp("cid=" + id + "$");
																if (myRE.test(this.href)) {
																	// Stop the interval and click the course link to launch
																	app.clearInterval("academy_find_course_link");
																	setTimeout(app.hideAcademyLoader, 600);

																	this.click();
																}
															});
														},
														100,
														4000,
														"academy_find_course_link"
													);
												}
											});
										} else if (
											jQuery("#academy .breadcrumb a:contains('Home')")
												.length &&
											!homeClicked
										) {
											homeClicked = true;
											jQuery("#academy .breadcrumb a:contains('Home')")
												.get(0)
												.click();
										}
									},
									300,
									5000,
									"handler_tryopenAcademyHome"
								);

								var product = "appbuilder"; // default show App Builder
								if (
									jQuery('#yoo-zoo .item .pos-bottom h3:contains("Product")')
										.length
								) {
									product = jQuery(
										'#yoo-zoo .item .pos-bottom .element:contains("Product")'
									)
										.text()
										.trim()
										.replace(/Product/g, "");
								}
								app._showProduct(product);

								// Fix the app layout to show the app list not the app seardh
								if (jQuery(".items-inner .apps.search").length) {
									jQuery(".items-inner").css(
										"transform",
										"translate(-320px, 0px)"
									);
								}
							})
							.prependTo(jDiv);
					}

					app.addStyles(
						".yoo-zoo .pos-ingredients .start-course { text-align: center; background-color: #eeeeee; padding: 20px; } .yoo-zoo .pos-ingredients .start-course button { background-color: #458cfa; background-image: linear-gradient(to bottom, #438cfe,#3383ff); }"
					);
				}
			}
		};

		app._fixFirstMapScreen = function () {
			// first load of map fix needs to be delayed

			// deprecated
			return;

			/*
			if(!app._firstMapScreenDone){
				app._firstMapScreenDone = true;
				setTimeout(()=>{
					//app._fixMapScreen()					
				},1000);						
			}
			*/
		};

		app._fixMapScreen = function () {
			//deprecated
			return;
		};

		/*
        Returns an array of app descriptor objects:
        {
            title: "",
            id: 123,
            icon: "url-for-icon-image"
        }

        Only works on App List screen
        Options

		Tags: Get Apps getApps Get all apps getAllApps
		
        */
		app.getAppDescriptors = function (options) {
			var options = options || {};
			var rVal = [];

			if (window.location.hash != "#1/1") {
				app.showToastMessage(
					"Cannot get App descriptors if not on App List screen."
				);
			} else {
				jQuery(".apps .apps-inner .item.icon .app-icon").each(function () {
					var jThis = jQuery(this);
					rVal.push({
						title: jThis.parent().find(".title").text(),
						id: jThis.data("href"),
						icon: jThis
							.find(".image")
							.css("background-image")
							.replace(/.*(http:\/\/appshed-id-images)/, "$1")
							.replace(/\'\)/, ""),
					});
				});
			}
			return rVal;
		};

		/*
			_getAppSettings
			Asynchronously loads the app settings. 
			Optional callback called once the settings are loaded
		*/
		app._getAppSettings = function (callback) {
			// This is implemented by automatically opening the App Settings and reading the Form data. In future do using API

			// Only do this if the App Settings links is currently visible in the Toolbox
			//   (otherwise it can mess up editing screens - in future try avoid this limitation)
			if (jQuery(".span-toolbox .toolbox.hidden-left").length) {
				return false;
			}

			// hide the toolbox to avoid visible changes
			jQuery(".span-toolbox").css("display", "none");
			jQuery(".span-toolbox .toolbox").css("display", "none");

			// this function will be called when the App Settings panel is loaded.
			app._app_settings_auto_open_callback = function () {
				jQuery(
					'form[action="/appbuilder/apps/save"]>.edit-btns>button[data-popup="close"]'
				).click();
				setTimeout(function () {
					jQuery(".span-toolbox").css("display", "block");
					jQuery(".span-toolbox .toolbox").css("display", "block");
				}, 500); // show the toolbox again

				if (callback) {
					callback.call();
				}
			};

			// now trigger opening the App Settings by clicking the icon
			jQuery(".toolbox .app-controls .icon-cogs").click();

			return true;
		};

		/*
		_getCloudVariableItemIDs
		Return an array of item IDs for Cloud Varaibles
		TODO: Currently this only looks on the current screen. Need to interrogate ALL variables in the app
		*/
		app._getCloudVariableItemIDs = function () {
			var arr = [];
			jQuery(".app .screen .items .item.option-cloud-variable").each(
				function () {
					arr.push(this.id.replace(/\D/g, ""));
				}
			);
			return arr;
		};

		app.getCookieVal = function (name) {
			// returns the value of a certain key (name) in the cookie

			var value = "; " + document.cookie;
			var parts = value.split("; " + name + "=");
			if (parts.length == 2) {
				return parts.pop().split(";").shift();
			}
			return null;
		};

		app.getData = function (idOrClassName) {
			// returns the Data object for `idOrClassName'
			// the `ClassName` doesn't need to exist in the app... it can be a made-up 'table name', e.g. 'users'
			// If any screen has this ClassName, it will be linked to this 'table'
			// Multiple screens can use the same ClassName (even adding different fields to the same 'table')

			// If `idOrClassName` is
			//   Case 1: null, and the current screen has ClassNames,
			//      check each ClassName for app data
			//      if app data found, then return the first one found.
			//      else return the screen data and save the classnames in app localstorage
			//   Case 2: an Id (number),
			//      If it matches a screenId
			//   	return the screen data
			//   Case 3: an 'identifier', then look for app data (not Screen data) matching the identifier
			//      if app data found, return it
			//      xxxxxx else go through classnames in app locastorage..
			//      xxxxxx   if a match found, move the screendata to classname data and return
			//      xxxxxx else create an empty app data and return it
			//   Case 4: nothing found. Create a new data Object for this identifier

			var currentScn = this.getScreen();

			// Case 1
			if (!idOrClassName) {
				// go through all the classes on the current screen
				for (var c = 0; c < currentScn.element.classList.length; c++) {
					//ignore built-in classes
					if (
						!["screen", "list", "icon"].contains(
							currentScn.element.classList[c]
						)
					) {
						// get the datasets from local storage
						var datasetNames = Object.keys(this.getLocalProperty("datasets"));

						for (var d = 0; d < datasetNames.length; d++) {
							// If this screen has a classname matching some local app data, use it
							// (the first matched classname will be used)
							if (datasetNames[d] == currentScn.element.classList[c]) {
								// Save the object in app.datasets for quick lookup
								if (!this._datasets[datasetNames[d]]) {
									this._datasets[datasetNames[d]] = new AppShedData(
										datasetNames[d],
										{
											isAppData: true,
										}
									);
								}
								return this._datasets[datasetNames[d]];
							}
						}
					}
				}
			}

			// Case 2
			if (!isNaN(idOrClassName)) {
				try {
					// might cause an error
					var scnLocalStorage = this.getScreen(idOrClassName).getLocalStorage();
					if (scnLocalStorage.hasOwnProperty("data")) {
						return this.getScreen(idOrClassName).getData();
					}
				} catch (er) {}
			}

			var datasets = this.getLocalProperty("datasets");

			// Case 3
			if (datasets.hasOwnProperty(idOrClassName)) {
				//return datasets[idOrClassName];
				// Save the object in app.datasets for quick lookup
				if (!this._datasets[idOrClassName]) {
					this._datasets[idOrClassName] = new AppShedData(idOrClassName, {
						isAppData: true,
					});
				}
				return this._datasets[idOrClassName];
			}

			// Case 4
			var newD = new AppShedData(idOrClassName, {
				isAppData: true,
			});
			datasets[idOrClassName] = [];
			this.setLocalProperty("datasets", datasets);

			// Save the object in app.datasets for quick lookup
			if (!this._datasets[idOrClassName]) {
				this._datasets[idOrClassName] = new AppShedData(idOrClassName, {
					isAppData: true,
				});
			}
			return this._datasets[idOrClassName];
		};

		app.getDefaultLayoutId = function () {
			//from Attached data-board attribute (linked board)
			var data_board = jQuery(".app").data("board");
			if (data_board && !isNaN(data_board)) {
				return parseInt(data_board);
			}

			return null;
		};

		app.getDevice = function (idOrProps, key) {
			// Returns the device for `idOrProps`
			// `idOrProps` can be a `deviceId` (a ten character string)
			// or an object in the form
			// * {id: xxx, [local_ip: xxx, layoutId: xxx]}
			// If no `idOrProps` passed in, the default device is returned
			// Optionl `key` is the aREST Pro key
			var idOrProps = idOrProps || this._defaultDevice;
			var props = app.idOrPropsToObject(idOrProps);

			// special case local - if device is running softAP (local Access Point)
			// If no id, and no _defaultDevice, default to `local`
			if (!props.id || props.id == "") {
				props.id = "local";
				this._defaultDevice = "local";
			}

			if (key && key > "") props.key = key;

			var device = app._devices[String(props.id).trim()];

			if (device) {
				// don't update properties if only id passed in (1 key)
				if (Object.keys(props).length > 1) {
					device.updateProperties(props);
				}
			} else {
				device = app.addDevice(props);
			}

			// if no default, make this the default
			if (!app._defaultDevice) {
				app._defaultDevice = props.id;
			}

			// Save as the current app.device
			if (app._defaultDevice == props.id) {
				app.device = device;
			}

			return device;
		};

		app.getIdFromDOMId = function (domId) {
			return parseInt(String(domId).replace(/[a-z]/g, ""));
		};

		app.getIPs = function (callback) {
			// Looks for the Local IP address(es) for the app
			// Calls `callback(ip_addr)` for each IP Address
			// Adds all the IP Addresses to `app._appIPAddresses[]`

			app._appIPAddresses = [];

			var ip_dups = {};

			//compatibility for firefox and chrome
			var RTCPeerConnection =
				window.RTCPeerConnection ||
				window.mozRTCPeerConnection ||
				window.webkitRTCPeerConnection;
			var useWebKit = !!window.webkitRTCPeerConnection;

			//bypass naive webrtc blocking using an iframe
			if (!RTCPeerConnection) {
				//NOTE: you need to have an iframe in the page right above the script tag
				//
				//<iframe id="iframe" sandbox="allow-same-origin" style="display: none"></iframe>
				//<screenipt>...getIPs called in here...

				var win = iframe.contentWindow;
				RTCPeerConnection =
					win.RTCPeerConnection ||
					win.mozRTCPeerConnection ||
					win.webkitRTCPeerConnection;
				useWebKit = !!win.webkitRTCPeerConnection;
			}

			//minimal requirements for data connection
			var mediaConstraints = {
				optional: [
					{
						RtpDataChannels: true,
					},
				],
			};

			var servers = {
				iceServers: [
					{
						urls: "stun:stun.services.mozilla.com",
					},
				],
			};

			//construct a new RTCPeerConnection
			var pc = new RTCPeerConnection(servers, mediaConstraints);

			function handleCandidate(candidate) {
				//match just the IP address
				var ip_regex =
					/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;
				var ip_addr = ip_regex.exec(candidate)[1];

				//remove duplicates
				if (ip_dups[ip_addr] === undefined) {
					app._appIPAddresses.push(ip_addr);
					if (callback != null) callback(ip_addr);
				}

				ip_dups[ip_addr] = true;
			}

			//listen for candidate events
			pc.onicecandidate = function (ice) {
				//skip non-candidate events
				if (ice.candidate) handleCandidate(ice.candidate.candidate);
			};

			//create a bogus data channel
			pc.createDataChannel("");

			//create an offer sdp
			pc.createOffer(
				function (result) {
					//trigger the stun server request
					pc.setLocalDescription(
						result,
						function () {},
						function () {}
					);
				},
				function () {}
			);

			//wait for a while to let everything done
			setTimeout(function () {
				try {
					//read candidate info from local description
					var lines = pc.localDescription.sdp.split("\n");

					lines.forEach(function (line) {
						if (line.indexOf("a=candidate:") === 0) handleCandidate(line);
					});
				} catch (er) {}

				callback();
			}, 1000);
		};

		app.getItem = function (idOrClassName, element) {
			// Returns an `Item` object for `idOrClassName`
			// If no `idOrClassName` supplied it returns the `Current Item` (last item clicked)
			// `idOrClassName` can be the `ItemId` or the `ClassName` set in `Custom Classes`, or the DOM id of the item
			// If multiple items have the same `ClassName`, the first item is returned
			// Optional `element` is assinged to the `Item.element` property

			if (!idOrClassName && this._currentItemId)
				idOrClassName = this._currentItemId;

			// If 'element' supplied but no id, get id from the element
			if (
				!idOrClassName &&
				element &&
				typeof elemet === "object" &&
				element.id &&
				element.id.match(/item/)
			) {
				idOrClassName = element.id.replace(/item/, "");
			}

			var testId = this.getIdFromDOMId(idOrClassName);

			try {
				if (this._items[testId]) {
					// MUST reload the `element` otherwise it references old stuff
					this._items[testId].init(element);
					return this._items[testId];
				}

				var item = new this.Item(testId);

				if (element) item.element = element;

				// if no element, try getting the item by ClassName
				if (item.element == null) item = this.getItemByClassName(idOrClassName);

				// If still no element, there is no item
				if (!item || item.element == null) {
					return null;
				} else {
					this._items[item.id] = item;
					return item;
				}
			} catch (er) {
				this.handleError(er, "app.getItem(" + idOrClassName + ")");
			}
		};

		app.getItemHTML = function (id, type, data) {
			// returns the default HTML for an item

			switch (type) {
				case "icon":
					return (
						'<td class=" item icon" id="item' +
						id +
						'"><div class="item-icon-inner"><img class="image" src="' +
						(data && data.image
							? data.image
							: "https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/images/defaultjpg.jpg") +
						'" width="50" height="50"><div class="title">An Icon</div></div></td>'
					);
					break;

				case "plain":
					return (
						'<div class=" item plain link" id="item' +
						id +
						'" data-linktype="screen" data-href="16011448" x-blackberry-focusable="true"><div class="link-arrow"></div><img class="icon" src="' +
						(data && data.image
							? data.image
							: "https://d1yeqpqwjn2qg3.cloudfront.net/UQugOX_P3gdOptCVr3u-_oq-6Zs=/80x80/http://appshed-id-images.s3-website-eu-west-1.amazonaws.com/8") +
						'" width="40" height="40"><div class="text">A link</div></div>'
					);
					break;

				case "radio":
					var checked = "";
					if (
						data &&
						data.name &&
						data.value &&
						app.getVariable(data.name) == data.value
					) {
						checked = 'checked="checked"';
					}
					return (
						'<div class=" item radio" id="item' +
						id +
						'"><span class="radio-container no-title"><input class="radio" type="radio" name="' +
						(data && data.name ? data.name : "radio") +
						'" value="' +
						(data && data.value ? data.value : "radio") +
						'" id="label-' +
						id +
						'" data-variable="' +
						(data && data.name ? data.name : "radio") +
						'" data-save-value="yes" ' +
						checked +
						'></span><label class="title" for="label-' +
						id +
						'">' +
						(data && data.title ? data.title : "A radio button") +
						"</label></div>"
					);
					break;

				default:
					return (
						'<div class=" item thumb" id="' +
						(id ? id : "item1") +
						'"><div class="image-container"><img class="image" src="' +
						(data && data.image
							? data.image
							: "https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/images/defaultjpg.jpg") +
						'" width="50" height="50"></div><div class="title">' +
						(data && data.title ? data.title : "A text &amp; image item") +
						'</div><div class="text">' +
						(data && data.text ? data.text : "A subtitle for this item") +
						"</div></div>"
					);
			}
		};

		app.getItemByClassName = function (name) {
			// Returns an `Item` matching `name`

			var elements = document.getElementsByClassName(name);

			if (elements && elements.length && elements[0].id.match(/item/))
				return this.getItemByDomId(elements[0].id);
		};

		app.getItemByDomId = function (domId, element) {
			// Returns an `Item` object for `domId` which is the `id` of the `Element` in the `DOM Tree`
			// Optional `element` is the `DOM Element`

			return app.getItem(
				parseInt(String(domId).replace(/[a-z]/g, "")),
				element
			);
		};

		app.getItemsElement = function () {
			return document.getElementsByClassName("items")[0];
		};

		/**
		 * Evaluates the code and returns error messages (if any)
		 * @method
		 * @param {string} code The code to evaluate
		 * @param {*} options optional settings
		 * @returns
		 */
		app._getJSLintMessages = function (code, options) {
			var msg = "";

			try {
				// Set up some options for the jslint - these should be optimised for our use case
				let option = Object.create(null);
				[
					"devel",
					"browser",
					"fudge",
					"convert",
					"eval",
					"for",
					"getset",
					"long",
					"single",
					"this",
					"white",
				].forEach(function (title) {
					option[title] = true;
				});

				var result = app.jslint(code, option, [
					"object",
					"item",
					"data",
					"app",
					"jQuery",
				]);

				// Go through all the warnings
				jQuery(result.warnings).each(function (i, val) {
					// ignore some errors
					// ignore ; erros
					if (
						String(val.message).test(/Expected ';' and instead saw/) ||
						String(val.message).test(/Undeclared 'appbuilder'/) ||
						String(val.message).test(/Expected '===' and instead saw '=='/)
					) {
					} else {
						msg +=
							'<div class="lint-warning"><cite><address>Line ' +
							(parseInt(val.line) + 1) +
							"</address>" +
							val.message +
							"</cite><samp>" +
							result.lines[val.line] +
							"</samp>  \n<br></div>";
					}
				});
			} catch (err) {
				console.error("app._getJSLintMessages", err);
			}

			return msg;
		};

		app.getJSON = function (appIdOrSlug) {
			// returns a JSON object
		};

		app.getLibraries = function () {
			// Returns an array of libraries that are required for this app

			var libs = [];

			var desc = "\n" + app.description;
			var matches = desc.match(/[\n]import.*/gi);

			if (matches && matches.length) {
				for (var i = 0; i < matches.length; i++) {
					libs = libs.concat(
						matches[i]
							.replace(/\nimport */i, "")
							.replace(/ /g, ",")
							.replace(/,+/g, ",")
							.split(",")
					); //
				}
			}

			return libs;
		};

		app.getLocalData = function (idOrClassName) {
			// returns the data array from local storage matchich idOrClassName
			var datasets = this.getLocalProperty("datasets");
			if (datasets.hasOwnProperty(idOrClassName)) {
				return datasets[idOrClassName];
			} else {
				// Create the object with empty data array
				datasets[idOrClassName] = [];
				// save it back to localstorage
				this.setLocalProperty("datasets", datasets);
				return datasets[idOrClassName];
			}
		};

		app.getLocalIP = function (callback) {
			// Searches for the Local IP Address for the app
			// IP addresses starting with 10. and 192. are treated as local
			// `callback(ip_addr)` is called if a local IP is found.
			// The app needs internet connectivity to do this.

			this.getIPs(function (ip_addr) {
				if (String(ip_addr).match(/^10\./) || String(ip_addr).match(/^192\./)) {
					if (callback != null) callback(ip_addr);
				}
			});
		};

		app.getLocalProperty = function (property) {
			// Returns the value for `property` from `localStorage` for the app

			return this.getLocalStorage()[property];
		};

		app.getLocalStorage = function () {
			// Returns the object stored in localStorage for this screen
			// The Key for app localstorage is app123 (where 123 is the ID of the app)
			// The following properties are stored
			// 		AppId (integer)
			// 		datasets (object) {ClassName: [{},{}...]  }
			// 		  e.g. datasets.users = [{username: 'abc'},{username:'xyz'}]

			if (typeof localStorage["app" + this.id] == "undefined") {
				localStorage["app" + this.id] = JSON.stringify({
					AppId: this.id,
					datasets: {},
				});
			}

			return JSON.parse(localStorage["app" + this.id]);
		};

		app.getPin = function (pinNameOrNumber) {
			// Redundant function
			// Returns `app.getPinValue()`

			return app.getPinValue(pinNameOrNumber);
		};

		app.getPinValue = function (pinNameOrNumber, id) {
			// Returns the value for pin `pinNameOrNumber`
			// Optional `id` to use a specific `Device`
			// If no `id` passed in the default `Device` is used (`IOIO` is the initial default device)

			var device = this.getDevice(id ? id : this._defaultDevice);

			// For IOIO use built in iot.setPin
			if (device.id == "IOIO") {
				try {
					return window.appbuilder.events.iot.getPinValue(pinName);
				} catch (er) {
					this.handleError(er, "app.getPin() IOIO error");
				}
			} else {
				// all other devices... use Device methods
				return device.getPinValue(pinNameOrNumber);
			}
		};

		app.getRandomColor = function (numOfSteps, step) {
			// Returns a random color in the format `rgb(x,y,z)`.
			// Optional `numOfSteps` determines how many steps to separate the color spectrum into.
			// Optional `step` specifies the specific step to return. Default is a random step.

			var numOfSteps = numOfSteps || 100;
			var step = step || parseInt(Math.random() * numOfSteps);

			// This function generates vibrant, "evenly spaced" colours (i.e. no clustering). This is ideal for creating easily distinguishable vibrant markers in Google Maps and other apps.
			// Adam Cole, 2011-Sept-14
			// HSV to RBG adapted from: http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript
			var r, g, b;
			var h = step / numOfSteps;
			var i = ~~(h * 6);
			var f = h * 6 - i;
			var q = 1 - f;
			switch (i % 6) {
				case 0:
					r = 1;
					g = f;
					b = 0;
					break;
				case 1:
					r = q;
					g = 1;
					b = 0;
					break;
				case 2:
					r = 0;
					g = 1;
					b = f;
					break;
				case 3:
					r = 0;
					g = q;
					b = 1;
					break;
				case 4:
					r = f;
					g = 0;
					b = 1;
					break;
				case 5:
					r = 1;
					g = 0;
					b = q;
					break;
			}
			var c =
				"#" +
				("00" + (~~(r * 255)).toString(16)).slice(-2) +
				("00" + (~~(g * 255)).toString(16)).slice(-2) +
				("00" + (~~(b * 255)).toString(16)).slice(-2);
			return c;
		};

		app.getRemoteIP = function (callback) {
			// Searches for the Remote IP Address for the app
			// IP addresses starting with 10. and 192. are treated as local
			// `callback(ip_addr)` is called if a remote IP is found.

			this.getIPs(function (ip_addr) {
				if (
					ip_addr != null &&
					ip_addr != undefined &&
					!String(ip_addr).match(/^10\./) &&
					!String(ip_addr).match(/^192\./)
				) {
					if (callback != null) callback(ip_addr);
				}
			});
		};

		app.getScreen = function (id) {
			// returns the `Screen` object for `id`

			try {
				var element;

				if (!id) {
					id = String(document.querySelector(".screen").id).replace(
						/screen/,
						""
					);
				}

				// look in the cache for the screen
				if (this._screens[id]) {
					// MUST reload the `element` otherwise it references old stuff
					this._screens[id].element = document.getElementById(
						this._screens[id].domId
					);
					return this._screens[id];
				}

				// Special Case: id is the DOM Element of the screen
				// then the DomID will be in the format "screen123"
				// This happens if app.addScreenEvent() passes `this` to app.getScreen()
				if (typeof id === "object" && id.id && id.id.match(/screen/)) {
					element = id;
					id = element.id.replace(/screen/, "");
				}

				// look in the cache for the screen
				if (this._screens[id]) {
					// MUST reload the `element` otherwise it references old stuff
					if (element) this._screens[id].element = element;
					else
						this._screens[id].element = document.getElementById(
							this._screens[id].domId
						);
				} else {
					var aScreen = new app.Screen(id);
					if (element) aScreen.element = element;
					this._screens[id] = aScreen;
				}

				return this._screens[id];
			} catch (er) {
				app.handleError(er, "app.getScreen(" + id + ")");
			}
		};

		app.getThemes = function () {
			// Return an array of themes for this app

			var themes = [];

			var desc = "\n" + app.description;
			var matches = desc.match(/[\n]theme.*/gi);
			//var matches = app.description.match(/^theme.*/i);
			if (matches && matches.length) {
				for (var i = 0; i < matches.length; i++) {
					themes = themes.concat(
						matches[i]
							.replace(/^themes* */i, "")
							.replace(/:/g, "")
							.replace(/ /g, ",")
							.replace(/,+/g, ",")
							.split(",")
					); //
				}
			}

			return themes;
		};

		app.getUser = function () {
			if (!app.user) {
				app.user = new AppShedUser();
				app.user._init();
			}
			return app.user;
		};

		/*
		Get an app variable
		name is the mandatory properties

		Extra feature: get app.prop using special format:
		name = "app_" prepended to property name
		e.g. app_version will get app.version
		*/
		app.getVariable = function (name) {
			//appbuilder.app.debug("api","getVariable",name);
			var formField = appbuilder.app.api.phone.navigator.loadVar(name);
			if (formField) {
				return formField.value;
			} else if (String(name).search(/^app_/) != -1) {
				// might be an app variable
				// remove _app_ from the front
				var prop = String(name).replace(/^app_/, "");
				if (app.hasOwnProperty(prop)) {
					return app[prop];
				}
			}
			return null;
		};

		app.getVariable_xxx = function (name) {
			// Returns the value of a form variable with the given `name`.
			// [NOTE: the method name is getVariable without _xxx and it already exists in the built-in JavaScript library.
			//   It is included here for documentation purposes only.]
		};

		// Add a linear gradient to make sure white images are visible
		app._gradientBG = function () {
			try {
				var str = jQuery(".file-chooser-image.custom-input").attr("style");
				if (!str.match(/linear-gradient/)) {
					str = str.replace(
						/(url\(.*?\))/,
						"$1, repeating-linear-gradient( 45deg,  #ffffff,  #ffffff 10px,  #d1d1d1 10px,  #d1d1d1 20px)"
					);
					jQuery(".file-chooser-image.custom-input").attr("style", str);
				}
			} catch (er) {
				console.warn("ERROR gradientBG", er);
				alert(
					"The object did not load correctly. Please Cancel then re-open the object."
				);
			}
		};

		/*
			Use GTM to create Mautic DWC
			GTM vairables created using JavaScript calls trigger DWC insert
		*/

		app.gtmVars = {}; // store the GTM vars here

		/*
			gtmGetVariable
			vName - name of the variable
			options: { 
			"dwc": true, // is this a DWC trigger
			"slot": "", // name of the DWC slot

			"focusItem": true, // is this a Focus Item

			// choose one of these: appendTo || prependTo || before || after
			"before": "", // optional selector where to place before
			"after": "", // optional selector where to place after
			"appendTo": "" // optional selector where to append, default "body"
			"prependTo": "" // optional selector. Default reverts to prependTo "body"

			// RegExp tests
			"testPathname": "reg-expression", // will only process if the location.pathname matches
			"testNotPathname": "reg-expression", // pathname must NOT match
			"delay": 0, // optional, how long to wait before creating the DWC, default 0
			"cta": { // Call to action settings
				"selector": "", // the selector for the cta
				"type": "autologin", // action types: autologin, ...
			}
			}

			DWC
			If a DWC is created it can be refreshed by include a div with this attribute:
			<div data-mt-refresh="dd0"...>  NB the refresh must contain a 0, e.g. 10, 1000 etc


			Return values
			0 - pending, not processed (probably DOM not ready)
			1 - processed
			2 - skipped, already processed
			-1 - error
			-2 - skipped, pathname not matched
			-3 - skipped, NotPathname DID match

		*/
		app.gtmGetVariable = function (vName, options) {
			try {
				// don't do anything until gtm.dom event
				if (
					!dataLayer ||
					!/"event":"gtm\.dom"/.test(JSON.stringify(dataLayer))
				) {
					return 0;
				}

				var options = options || {};

				// ignore if regexp tests fail
				if (options.hasOwnProperty("testPathname")) {
					var re = new RegExp(options.testPathname);
					if (!re.test(window.location.pathname)) {
						return -2;
					}
				}

				if (options.hasOwnProperty("testNotPathname")) {
					var re = new RegExp(options.testNotPathname);
					if (re.test(window.location.pathname)) {
						return -3;
					}
				}

				// ignore if we have done this var
				if (app.gtmVars.hasOwnProperty(vName)) {
					return 2;
				}

				if (options.dwc && options.slot) {
					// is there a delay

					setTimeout(
						function (vName, options) {
							app._mtCreateDWC(vName, options);
						}.bind(this, vName, options),
						options.delay || 0
					);
				} else if (options.focusItem && options.id) {
					app.createFocusItem(vName, options);
				}

				app.gtmVars[vName] = options;

				return 1; // processed
			} catch (error) {
				console.error("gtmGetVariable", error);
				return 2;
			}
		};

		/*
			Creates Call To Action on the target
		*/
		app.mtCreateCTA = function (slot, options) {
			try {
			} catch (error) {
				console.error("createCTA", error);
			}
		};

		/*
			Create Mautic DWC in a slot
			If it already exists, not recreated
			Parameters
                `slot` - the name of the slot
                `options` - object of options (optional)
                    {
                        prependTo    : object-or-selector
                        appendTo     : object-or-selector
                        before       : object-or-selector
                        after        : object-or-selector
                        cta - passed to the function app.mtCreateCTA
                    }
		*/
		app.createDWC = function (slot, options) {
			return;

			// DEPRECATED replaced by _mtCreateDWC

			/*

			try {
				

				// look for the slot - will have class "mt-dwc" and "slot-container"
				if(!jQuery('.mt-dwc.'+slot+'-container').length){
					// missing, so add the div
					var jEl = jQuery('<div class="mt-dwc '+slot+'-container"><div data-slot="dwc" data-param-slot-name="'+slot+'"></div></div>');
					if(options.hasOwnProperty("prependTo")){
						jEl.prependTo(options.prependTo);
					}else if(options.hasOwnProperty("appendTo")){
						jEl.appendTo(options.appendTo);
					}else if(options.hasOwnProperty("before")){
						jQuery(options.before).before(jEl);
					}else if(options.hasOwnProperty("after")){
						jQuery(options.after).after(jEl);
					}else{
						jEl.appendTo('body');
					}
				}

				

				var j = jQuery('.mt-dwc.'+slot+'-container');
				

				// Add CTA		
				if(options.cta && typeof options.cta === "object"){
					app.mtCreateCTA(slot,options)
				}

				// if it has a mt-refresh (should have at least one 0 in the delay), set a timer


				

				app._mtLoadDWC(slot);

			} catch (error) {
				console.error('createDWC',error)		

			}
            */
		};

		/*
			Create Mautic Focus Item in a slot
			If it already exists, not recreated
		*/
		app.createFocusItem = function (vName, options) {
			if (options && options.focusItem && options.id && !isNaN(options.id)) {
				jQuery.getScript(
					"https://content.appshed.com/focus/" + options.id + ".js"
				);
			}
		};


        app._createLoader = function (target) {
            // add the loader div if not present
            var target = target || "#action-target";

            if (jQuery(target + " .appLoader").length == 0) {
                jQuery(target).append(
                    '<div class="appLoader loading"></div>'
                );
            }
        };

        
		app.handleError = function (er, msg) {
			// Handles errors. Logs `er` and `msg`

			var msg = msg || "";
			console.log("ERROR: ", er, msg);
		};

		app.handleTextareaEditing = function (id, el) {
			jQuery(el)
				.find(".item.textarea.code")
				.each(function () {
					var jItem = jQuery(this);
					var thisItem = app.getItem(jItem.attr("id"));

					jItem.find("textarea").hide();
					var codeId = this.id + "-code";
					var codeLanguage = "js";

					jQuery(jItem.attr("class").split(" ")).each(function () {
						if (String(this).match(/language-/)) {
							codeLanguage = String(this).replace(/language-/, "");
						}
					});

					if (jItem.hasClass("language_logo")) {
						codeLanguage = "logo";
					}
					var varName = thisItem.getVariableName();
					//var codeEl = jQuery('<div id="'+codeId+'" class="item-code-container">'+app.getVariable(varName)+'</div>');
					var codeEl = jQuery(
						'<div id="' + codeId + '" class="item-code-container"></div>'
					);
					jItem.after(codeEl);
					var flask = new CodeFlask("#" + codeId, { language: codeLanguage });
					flask.updateCode(app.getVariable(varName));
					codeEl.find("pre").css("width", "100%");

					flask.onUpdate((code) => {
						jQuery(".codeflask pre").each(function () {
							// fix some css
							var jThis = jQuery(this);
							jThis.parent().parent().css("height", jThis.css("height"));
							jThis.parent().css("height", jThis.css("height"));
							jThis
								.parent()
								.find("textarea")
								.css("height", jThis.css("height"));
							// update the app variable, if different
							var varName = thisItem.getVariableName();
							if (app.getVariable(varName) != code) {
								app.setVariable(varName, code);
							}
							app.refreshScroll();
						});
					});

					// store the flask on the item, so it can be accessed elsewhere
					jItem.data("flask", flask);
				});

			/*

			app.addStyles(' #app'+app.id+' .item.expand input[type=text]  ,  #app'+app.id+' .item.expand textarea   {      height: 50px;     width: 100%;     box-sizing: border-box;     _border: 2px solid #ccc;     _border-radius: 4px;     _font-size: 16px;     _background-color: white;     transition: height 0.8s ease-in-out;     overflow-y: scroll;   } #app'+app.id+' .item.expand textarea:focus   ,  #app'+app.id+' .item.expand input[type=text]:focus  {      width: 100%;     height: 400px;   }');


			jQuery(el).find('.item.textarea.expand textarea').blur(function () {

				app.iScroll().scrollToTop();
				setTimeout(function(){
					app.iScroll().scrollToTop();
				},1000);
			})
			*/
		};

		app.hideAcademyLoader = function (timeout) {
			// Hides the loading element
			// Optional - Delay hiding until `timeout`
			// Returns `this`

			if (!timeout) {
				jQuery(".academyLoader").addClass("invisible");
			} else {
				setTimeout(app.hideAcademyLoader, timeout);
			}

			return this;
		};

        app._hideBlockly2Loader = function () {
            app._hideLoader("#action-target");
        }
        
		app._hideContainerLoader = function (timeout) {
			// hide the container loader

			if (timeout && !isNaN(timeout)) {
				setTimeout(() => {
					jQuery(".container-loader").hide();
				}, timeout);
			} else {
				jQuery(".container-loader").hide();
			}
		};

		app.hideDeepLoader = function (timeout) {
			if (timeout && !isNaN(timeout)) {
				setTimeout(() => {
					jQuery(".deep-loader").hide();
					//jQuery('.screen').css('visibility','visible');
				}, timeout);
			} else {
				//						jQuery('.screen').css('visibility','visible');
				jQuery(".deep-loader").hide();
			}
		};

		app.hideLoader = function (timeout) {
			// Hides the loading element
			// Optional - Delay hiding until `timeout`
			// Returns `this`

			if (!timeout) timeout = 1;

			setTimeout(function () {
				//document.getElementsByClassName('loader')[0].style.display = 'none'
				jQuery(".loader").each(function (index) {
					if (jQuery(this).attr("id") != "logMessages") {
						jQuery(this).css("display", "none");
					}
				});
			}, timeout);

			return this;
		};


        app._hideLoader = function (target) {
            // Hide the loader for Blockly2
            var target = target || "#action-target";

            app._createLoader(target);

            jQuery(target + " .appLoader").addClass("hidden");
        };


		app.hideTabBar = function () {
			// Hides the tab bar
			// Returns `this`
			try {
				var an = jQuery(".app-navigator");
				this._app_navigatorTop = an.css("top");
				this._app_navigatorBottom = an.css("bottom");

				an.css("top", 0);
				an.css("bottom", 0);
				//an.css('height',jQuery(".app").css('height'));
				an.css("height", "unset");

				jQuery(".tab-bar").hide();
			} catch (er) {}

			return this;
		};

		app._highlightProductLink = function () {
			// Highlights the current product link in the navbar

			// Make sure a product-selector is active
			//if(jQuery('.navbar .nav>li.product-selector.active').length == 0){

			// un-highlight all
			jQuery(".navbar .nav>li.product-selector").removeClass("active");

			switch (app.currentProduct) {
				case "appbuilder":
					jQuery("#product-link-ab").addClass("active");
					break;
				case "gamemaker":
					jQuery("#product-link-gm").addClass("active");
					break;
				case "courses":
					jQuery("#product-link-courses").addClass("active");
					break;
			}
			//}

			return this;
		};

		app.idOrPropsToObject = function (idOrProps) {
			// Returns an `object` using `idOrProps`

			var props = {
				id: "",
			};

			if (idOrProps && typeof idOrProps === "object") props = idOrProps;
			else if (idOrProps && idOrProps > "") props.id = String(idOrProps).trim();

			return props;
		};

		app.import = function (idOrSlug, callback) {
			// Imports the required JavaScript `library`
			// The library is imported from the Custom JavaScript from another app `idOrSlug`
			// Optional `callback` called once imported
			// Valid values for `library` include:
			//  * appcar, libphaser
			// Returns `this`

			if (!idOrSlug) return this;

			// make sure the appdata object exists
			if (!app._appData[idOrSlug]) app._appData[idOrSlug] = {};

			// check if appData loaded
			if (app._appData[idOrSlug].data) {
				// if already added, return
				if (app._appData[idOrSlug].jsAdded) {
					if (callback != null) callback(idOrSlug);
					return this;
				}

				//  Special Case: `callback` for libphaser must be saved as a window variable - called by libphaser
				if (idOrSlug == "libphaser") {
					window._liphaser_callback = callback;
					callback = null;
				}

				// get the script from .javascript
				app.addScript(app._appData[idOrSlug].data["javascript"], callback);

				// mark this as added
				app._appData[idOrSlug].jsAdded = true;

				app.log("Imported: " + idOrSlug, [idOrSlug]);

				//					if(callback != null) callback(idOrSlug);

				return this;
			}

			// if no appData, load it and import again on callback
			// set a flag so that the data is only loaded once

			if (!app._appData[idOrSlug].loadingData) {
				app._appData[idOrSlug].loadingData = true;

				app.loadAppData(idOrSlug, function (idOrSlug) {
					app._appData[idOrSlug].dataLoaded = true;
					app.import(idOrSlug, callback);
				});
			}

			return this;
		};




		/*
			app.inAppBlocklyShow
			Shows a Blockly editor in the app (not in AppBuilder)
			This is used for apps that support creating of code within the published app
			The output can be LOGO, JavaScript (coming soon)

			Example call:

				app.inAppBlocklyShow({
					"variable": "textarea1", 
					"callback": function(code){
						console.warn("The Logo code is",code);
					}
				});
			

				Params:
			`settings`: 
				{
					variable: 
						(required) the app variable to populate with the generated code from Blockly
					parent: 
						the DOM element where the Blockly will be placed
						Default: The current Item in the app (this will be the Item that was clicked to show Blockly)
					callback: 
						A function to call when Blockly is closed. This happens after the variable is set.
						Params: 
							code: The generated code (e.g. "FD 100 RT 90");
				

				}
			
		*/
		//app._inAppBlocklySettings = {};

		app.inAppBlocklyShow = function(settings){

			
			app.showDeepLoader(10000,"Loading Blockly...");
			

			// the first time loading blockly2 , load Blockly2 scripts
			if (!app._inAppBlocklyLoadScriptsStarted) {
				return app._inAppBlocklyLoadScripts(function () {
					// in the callback, setup Blockly2
					app.inAppBlocklyShow(settings);
				});
			}


			var settings = settings || {};


			// Default options
			if(!settings.hasOwnProperty("parent")){
				settings.parent = app.getItem().element;
			}

			// Save the settings
			//app._inAppBlocklySettings = settings;

			try {
				if (jQuery(settings.parent).length) {

			

					// add blockly2 div
					if(jQuery('#inAppBlockly_container').length > 0){
						// the blockly stuff has been done

						// Show the Blockly container
						jQuery("#inAppBlockly_container").show();

					}else{
						// add the div after screen
						jQuery(".app .screen").before(
							'<div id="inAppBlockly_container"><div class="inAppBlockly_titlebar"></div></div>'
						);    
						app.addStyles(`
							#inAppBlockly_container {
								position: absolute;
								left: 0px;
								top: 0px;
								right: 0px;
								bottom: 0px;
								background_color: blue;
								z-index: 999;
							}
							.inAppBlockly_titlebar {
								_height: 42px;
								width: 80px;
								position: absolute;
								z-index: 1;
								top: 0px;
								right: 0px;
							}
							.inAppBlockly_titlebar button.btn.shrink {
								float: right;
								padding: 0px 5px;
								margin: 5px 20px 0px 0px;
							}
						`)

						// Close button
						jQuery(".inAppBlockly_titlebar").append(
							'<button class="btn shrink do-shrink" type="button"><i class="icon-resize-small"></i> Close</button>'
						);
						jQuery(".inAppBlockly_titlebar .do-shrink   ").click(function () {
							//window.scrollTo(0, 0);

							// close blockly
							jQuery("#inAppBlockly_container").hide();
							//Blockly.svgResize(app._blockly2Workspace);


							Blockly.JavaScript.addReservedWords('code');
							var bcode = String(Blockly.JavaScript.workspaceToCode(Blockly.getMainWorkspace()));  
							
							// make some changes to convert from JavaScript to Logo
							bcode = bcode.replace(/;/g," ");
							bcode = bcode.replace(/  /g," ");
							bcode = bcode.replace(/==/g,"=");
							bcode = bcode.replace(/\n\n/g,"\n");
							

							// persist in localStorage
							var sBlocks = Blockly.serialization.workspaces.save(app._inAppBlockly);
							app.setLocalData(app.getItem().element.id+"_blockly",sBlocks);


							// put code into variable
							if(settings.hasOwnProperty("variable")){
								app.setVariable(settings["variable"],bcode);
							} 


							// callback
							if(settings.hasOwnProperty("callback")){
								settings.callback.call(this,bcode)
							} 
						});


						var options = {
							_toolbox: app._blockly2Toolbox,

							kind: "flyoutToolbox",
							collapse: true,
							comments: false,
							disable: false,
							maxBlocks: Infinity,
							trashcan: true,
							horizontalLayout: false,
							toolboxPosition: "start",
							css: true,
							media: "https://blockly-demo.appspot.com/static/media/",
							rtl: false,
							scrollbars: true,
							sounds: true,
							oneBasedIndex: true,
							grid: {
								spacing: 20,
								length: 1,
								colour: "#888",
								snap: true,
							},
							zoom: {
								controls: true,
								wheel: true,
								startScale: 1,
								maxScale: 3,
								minScale: 0.3,
								scaleSpeed: 1.2,
							},
						};

							
						const toolbox = 
						{
							"kind": "categoryToolbox",
							"contents": [
							{
								"kind": "category",
								"name": "Program",
								"contents": [
								{
									"kind": "block",
									"name": "IF",
									"type": "controls_if"
								},
								{
									"kind": "BLOCK",
									"type": "logic_compare"
								},
								{
									"kind": "BLOCK",
									"name": "REPEAT",
									"type": "controls_repeat_ext",
									"inputs": {
										"TIMES": {
											"shadow": {
											"type": "math_number",
											"fields": {"NUM": 10}
											}
										}
									}
								},
								{
									"kind": "BLOCK",
									"name": "LOOP",
									"type": "loop",
									"inputs": {},
									"_inputs": {
										"TIMES": {
											"shadow": {
											"type": "math_number",
											"fields": {"NUM": 10}
											}
										}
									}
								},
								{
									"kind": "BLOCK",
									"name": "WAIT",
									"type": "wait",
									"_inputs": {
                                        "aValue": {
                                            "shadow": {
                                                "type": "math_number",
                                                "fields": {"NUM": 1000}
                                            }
                                        }
									}
								},
								/*
									LOOP
									DELAY
									DISPLAY
									LABEL
									GOTO
									CLEAR
									VAR
								*/
								]
							},
							{
								"kind": "category",
								"name": "Devices",
								"contents": [
									{
									"kind": "block",
									"type": "drive_control"
									},
									{
									"kind": "block",
									"type": "motor_control"
									},
									{
									"kind": "block",
									"type": "servo_control"
									},
								]
							},
							{
								"kind": "category",
								"name": "Pins",
								"contents": [
									{
									"kind": "block",
									"type": "get_digital_pin"
									},
									{
									"kind": "block",
									"type": "get_analog_pin"
									},
									{
									"kind": "block",
									"type": "set_digital_pin"
									},
									{
									"kind": "block",
									"type": "set_analog_pin"
									},
								]
							},
							{
								"kind": "category",
								"name": "Data",
								"contents": [
									{
									"kind": "block",
									"type": "math_number"
									},
									{
									"kind": "block",
									"type": "text"
									},
									// Variables
								]
							},
							]
						}


						app._inAppBlockly = Blockly.inject("inAppBlockly_container", {toolbox: toolbox});
						
						// pre-poluate with existing blocks if available
						var sBlocks = app.getLocalData(app.getItem().element.id+"_blockly");
						if(sBlocks.hasOwnProperty("blocks")){
							Blockly.serialization.workspaces.load(sBlocks, app._inAppBlockly);
						}

					}

				}
			} catch (er) {
				console.error("ERROR app.inAppBlocklyShow  ", settings,er);
			}

			app.hideDeepLoader();

		};






		app._inAppBlocklyLoadScripts = function (callback) {
			// Start loading the Blockly2 scripts
			app._inAppBlocklyLoadScriptsStarted = true;
		
			// if Blockly 10 exists
			try {
				if(Blockly &&  parseInt(Blockly.VERSION) >= 10){
					if (callback) {
						callback.call();
					}
					return;
				}
			} catch (error) {
			}
		
			// hide old blockly
			//jQuery("#action-target>div").children().hide();
			// Add a loading placeholder
			//app._showBlockly2Loader();
		
			var onLoadCallback = function () {
				// onLoadCallback
		
				// all scripts loaded
				app._inAppBlocklyLoadScriptsDone = true;
				//app._hideBlockly2Loader();
		
				Blockly.Blocks['loop'] = {
					init: function() {
						this.jsonInit(
							{
								"type": "loop",
								"message0": "LOOP %1", //%{BKY_CONTROLS_REPEAT_TITLE}
								"args0": [{
									"type": "input_value",
									"name": "TIMES",
									"_check": "Number"
								}],
								"message1": "%{BKY_CONTROLS_REPEAT_INPUT_DO} %1",
								"args1": [{
									"type": "input_statement",
									"name": "DO"
								}],
								"previousStatement": null,
								"nextStatement": null,
								"style": "loop_blocks",
								"tooltip": "Runs repeatedly in a loop",
								"helpUrl": ""
							}
						)
						
					}
				};
				
				
				Blockly.Blocks['wait'] = {
					init: function() {
						this.appendDummyInput()
							.appendField("WAIT")
							.appendField(new Blockly.FieldNumber(0, 0, 9999, 1), "aValue");
						this.setColour(320);
						this.setOutput(false);
						this.setNextStatement(true);
						this.setPreviousStatement(true);
						this.setTooltip('Wait before processing the next command (in milliseconds)');
					}
				};

		
				Blockly.Blocks['get_digital_pin'] = {
					init: function() {
						this.appendDummyInput()
							.appendField("Get Digital pin")
							.appendField(new Blockly.FieldDropdown([["D0","0"], ["D1","1"], ["D2","2"], ["D3","3"], ["D4","4"], ["D5","5"], ["D6","6"], ["D7","7"], ["D8","8"]]), "pinNumber");
						this.setColour(320);
						this.setOutput(true,"Number");
						this.setTooltip('Get digital pin');
					}
				};
		
		
				Blockly.Blocks['get_analog_pin'] = {
					init: function() {
						this.appendDummyInput()
							.appendField("Get Analog pin")
							.appendField(new Blockly.FieldDropdown([["A0","0"]]), "pinNumber");
						this.setColour(320);
						this.setOutput(true,"Number");
						this.setTooltip('Get analog pin');
					}
				};
		
				Blockly.Blocks['set_digital_pin'] = {
					init: function() {
						this.appendDummyInput()
							.appendField("Set Digital pin")
							.appendField(new Blockly.FieldDropdown([["D0","0"], ["D1","1"], ["D2","2"], ["D3","3"], ["D4","4"], ["D5","5"], ["D6","6"], ["D7","7"], ["D8","8"]]), "pinNumber")
							.appendField(new Blockly.FieldDropdown([["0","0"], ["1","1"]]), "pinValue");
						this.setColour(320);
						this.setOutput(false);
						this.setNextStatement(true);
						this.setPreviousStatement(true);
						this.setTooltip('Set digital pin');
					}
				};
				
		
		
				Blockly.Blocks['set_analog_pin'] = {
					init: function() {
						this.appendDummyInput()
							.appendField("Set Analog pin")
							.appendField(new Blockly.FieldDropdown([["A0","0"]]), "pinNumber")
							.appendField(new Blockly.FieldNumber(0, 0, 1024, 1), "pinValue");
						this.setColour(320);
						this.setOutput(false);
						this.setNextStatement(true);
						this.setPreviousStatement(true);
						this.setTooltip('Set digital pin');
					}
				};
				
		
				Blockly.Blocks['drive_control'] = {
					init: function() {
						this.appendDummyInput()
							.appendField("Drive")
							.appendField(new Blockly.FieldDropdown([["FD","FD"], ["BK","BK"], ["LT","LT"], ["RT","RT"], ["ARCFL","ARCFL"], ["ARCFR","ARCFR"], ["ARCBL","ARCBL"], ["ARCBR","ARCBR"], ["ST","ST"] ]), "driveMode")
							.appendField(new Blockly.FieldNumber(0, 0, 1024, 1), "aValue");
						this.setColour(320);
						this.setOutput(false);
						this.setNextStatement(true);
						this.setPreviousStatement(true);
						this.setTooltip('Control driving');
					}
				};
				
		
				Blockly.Blocks['motor_control'] = {
					init: function() {
						this.appendDummyInput()
							.appendField("Motor")
							.appendField(new Blockly.FieldDropdown([["MAFD","MAFD"], ["MABK","MABK"], ["MBFD","MBFD"], ["MBBK","3MBBK"] ]), "motorMode")
							.appendField(new Blockly.FieldNumber(0, 0, 1024, 1), "aValue");
						this.setColour(320);
						this.setOutput(false);
						this.setNextStatement(true);
						this.setPreviousStatement(true);
						this.setTooltip('Control motor');
					}
				};
				
		
				Blockly.Blocks['servo_control'] = {
					init: function() {
						this.appendDummyInput()
							.appendField("Servo")
							.appendField(new Blockly.FieldDropdown([["SERVO0","SERVO0"], ["SERVO1","SERVO1"], ["SERVO2","SERVO2"], ["SERVO3","SERVO3"], ["SERVO4","SERVO4"], ["SERVO5","SERVO5"], ["SERVO6","SERVO6"], ["SERVO7","SERVO7"], ["SERVO8","SERVO8"],  ]), "servoNumber")
							.appendField(new Blockly.FieldNumber(0, -360, 360, 1), "aValue");
						this.setColour(320);
						this.setOutput(false);
						this.setNextStatement(true);
						this.setPreviousStatement(true);
						this.setTooltip('Control servo');
					}
				};
				
		
				
				Blockly.JavaScript.forBlock['wait'] = function(block, generator) {
					var aValue = block.getFieldValue('aValue');
					var code = ' WAIT ' + aValue ;
					return code;
				};
				Blockly.JavaScript.forBlock['get_digital_pin'] = function(block, generator) {
					var pinNumber = block.getFieldValue('pinNumber');
					var code = ' D' + pinNumber;
					return [code, Blockly.JavaScript.ORDER_ATOMIC];
				};
				
				Blockly.JavaScript.forBlock['set_digital_pin'] = function(block, generator) {
					var pinNumber = block.getFieldValue('pinNumber');
					var pinValue = block.getFieldValue('pinValue');
					var code = ' D' + pinNumber + ' ' + pinValue ;
					return code;
				};
				Blockly.JavaScript.forBlock['get_analog_pin'] = function(block, generator) {
					var pinNumber = block.getFieldValue('pinNumber');
					var code = ' A' + pinNumber ;
					return [code, Blockly.JavaScript.ORDER_ATOMIC];
				};
				Blockly.JavaScript.forBlock['set_analog_pin'] = function(block, generator) {
					var pinNumber = block.getFieldValue('pinNumber');
					var pinValue = block.getFieldValue('pinValue');
					var code = ' A' + pinNumber + ' ' + pinValue ;
					return code;
				};
				Blockly.JavaScript.forBlock['drive_control'] = function(block, generator) {
					var driveMode = block.getFieldValue('driveMode');
					var aValue = block.getFieldValue('aValue');
					var code = ' ' + driveMode + ' ' + aValue ;
					return code;
				};
				Blockly.JavaScript.forBlock['motor_control'] = function(block, generator) {
					var motorMode = block.getFieldValue('motorMode');
					var aValue = block.getFieldValue('aValue');
					var code = ' ' + motorMode + ' ' + aValue ;
					return code;
				};
				Blockly.JavaScript.forBlock['servo_control'] = function(block, generator) {
					var servoNumber = block.getFieldValue('servoNumber');
					var aValue = block.getFieldValue('aValue');
					var code = ' ' + servoNumber + ' ' + aValue ;
					return code;
				};
		
		
		
				Blockly.JavaScript.forBlock['controls_repeat_ext'] = function(a, generator) {
					var b = a.getField("TIMES") ? String(Number(a.getFieldValue("TIMES"))) : Blockly.JavaScript.valueToCode(a, "TIMES", Blockly.JavaScript.ORDER_ASSIGNMENT) || "0";
					var c = Blockly.JavaScript.statementToCode(a, "DO");
					c = Blockly.JavaScript.addLoopTrap(c, a);
					a = "";
					var e = b;
					b.match(/^\w+$/) || (0,
					module$exports$Blockly$utils$string.isNumber)(b) || (e = Blockly.JavaScript.nameDB_.getDistinctName("repeat_end",module$exports$Blockly$Names.NameType.VARIABLE),
					a += "var " + e + " = " + b + ";\n");
					var code = a + ("\n REPEAT " + e + " [\n  " + c + "\n] ")
			
					return code;
				};
		

		
				Blockly.JavaScript.forBlock['loop'] = function(a, generator) {
					//var b = a.getField("TIMES") ? String(Number(a.getFieldValue("TIMES"))) : Blockly.JavaScript.valueToCode(a, "TIMES", Blockly.JavaScript.ORDER_ASSIGNMENT) || "0";
					var c = Blockly.JavaScript.statementToCode(a, "DO");
					c = Blockly.JavaScript.addLoopTrap(c, a);
					a = "";
					//var e = b;
					//b.match(/^\w+$/) || (0,
					//module$exports$Blockly$utils$string.isNumber)(b) || (e = Blockly.JavaScript.nameDB_.getDistinctName("repeat_end",module$exports$Blockly$Names.NameType.VARIABLE),
					//a += "var " + e + " = " + b + ";\n");
					var code = a + ("\n LOOP  [\n  " + c + "\n] ")
			
					return code;
				};
		
				// change this to suit Blockly
				Blockly.JavaScript.forBlock['controls_if'] =  function(a, b) {
					var c = 0;
					let d = "";
					b.STATEMENT_PREFIX && (d += b.injectId(b.STATEMENT_PREFIX, a));
					do {
		//                const e = b.valueToCode(a, "IF" + c, Order$$module$build$src$generators$javascript$javascript_generator.NONE) || "false";
						let e = b.valueToCode(a, "IF" + c, true) || "false";
							e = e.replace(/[\(\)]/g,"");
						let f = b.statementToCode(a, "DO" + c);
						b.STATEMENT_SUFFIX && (f = b.prefixLines(b.injectId(b.STATEMENT_SUFFIX, a), b.INDENT) + f);
						d += (0 < c ? " ELSE " : "") + "IF " + e + " [\n" + f + "\n]";
						c++
					} while (a.getInput("IF" + c));
					if (a.getInput("ELSE") || b.STATEMENT_SUFFIX)
						c = b.statementToCode(a, "ELSE"),
						b.STATEMENT_SUFFIX && (c = b.prefixLines(b.injectId(b.STATEMENT_SUFFIX, a), b.INDENT) + c),
						d += " ELSE [\n" + c + "\n]";
					return d + "\n"
				}
		
		
		
				if (callback) {
					callback.call();
				}
			}
		
		
			// load the blockly scripts
			// load the new blockly2 scripts, and the old blocks and javascript files that have all the old definitions
			app.loadScript(
				"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/inapp/blockly.min.js",
				onLoadCallback,null,null,null,function(){
					// onErrorCallback
					// if the s3 file not available, try to get a local file (if this is an APK the file should be in a subfolder ./inapp/)
					app.loadScript(
						"./inapp/blockly.min.js",
						onLoadCallback,null,null,null,function(){
							// onErrorCallback
							// If local file failed, we need to inform the user.
							appbuilder.app.alert('Unable to load Blockly (Error 72198)');
						}
					)
				}
			);
		};
		
		
		
		
		

        app._inAppBlocklyLoadScripts2 = function (callback) {
            // Start loading the Blockly2 scripts
            app._inAppBlocklyLoadScriptsStarted = true;

            // hide old blockly
            //jQuery("#action-target>div").children().hide();
            // Add a loading placeholder
            //app._showBlockly2Loader();

            // load the blockly scripts
            // load the new blockly2 scripts, and the old blocks and javascript files that have all the old definitions
            app.loadScript(
                "https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/inapp/en.js",
                function () {
                    app.loadScript(
                        "https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/inapp/blockly_compressed.js",
                    function () {
                        app.loadScript(
                            "https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/inapp/javascript_compressed.js",
                            function () {
                                app.loadScript(
                                    "https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/inapp/blocks_compressed.js",
                                    function () {
                                        app.loadScript(
                                            "https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/inapp/toolbox.js",
                                                function () {
                                                    // all scripts loaded
                                                    app._inAppBlocklyLoadScriptsDone = true;
                                                    //app._hideBlockly2Loader();

                                                    if (callback) {
                                                        callback.call();
                                                    }
                                                }
                                            );
                                        }
                                    );
                                }
                            );
                        }
                    );
                }
            );
        };



        
		/**
		 * Initialises app.js on startup.
		 * A number of setup procedures are called.
		 * This is a Private method and should not be called by the user.
		 *
		 * @method _init
		 */

		app._init = function () {
			try {
				window.appbuilder.events.iot.init();
			} catch (er) {
				//console.warn('ioio.init()',er);
			}

			// If app.config has been set, merge to the default config
			app._config = app.utils.merge(app._config, app.config);

			app.element = document.getElementsByClassName("app")[0];
			app.id = String(app.element.id).replace(/app/, "");
			app.description = app.element.dataset.description;

			// Save the app Id in localstorage
			localStorage["currentApp"] = app.id;

			//if (document.getElementById('academy')) {
			/* 
            Determine if this is the AppBuilder environment.
            Be careful as this property is used extensive to change behaviour and UI
            Need to make sure that the rules do not falsely identify AppBuilder, e.g. Preview screen is very similar, but is not AppBuilder (so can't use || appbuilder.hasOwnProperty('userid')  )
            */

			// isAppBuilder
			if (document.getElementById("academy")) {
				app.isAppBuilder = true;
			}

			// isPreview
			if (document.querySelectorAll(".preview-content-wrapper").length) {
				app.isPreview = true;
			}

			// isWebApp
			if (
				/apps\.appshed\.com/.test(window.location.hostname) ||
				(!app.isAppBuilder && !app.isPreview)
			) {
				app.isWebApp = true;
			}

			// Create the  events
			app._addEventListenersASE();

			if (app._REQUIREJQUERYSCRIPTS) {
				app.setInterval(app.addJQueryScripts(), 1000, 10000);
			}

			app._addCodeMirrorScripts();

			app.element.removeEvent("touchstart", app.onTouchstart);
			app.element.removeEvent("mousedown", app.onTouchstart);
			app.element.addEvent("touchstart", app.onTouchstart);
			app.element.addEvent("mousedown", app.onTouchstart);

			app.element.removeEvent("touchmove", app.onTouchmove);
			app.element.removeEvent("mousemove", app.onTouchmove);
			app.element.addEvent("touchmove", app.onTouchmove);
			app.element.addEvent("mousemove", app.onTouchmove);

			app.element.removeEvent("touchend", app.onTouchend);
			app.element.removeEvent("mouseup", app.onTouchend);
			app.element.addEvent("touchend", app.onTouchend);
			app.element.addEvent("mouseup", app.onTouchend);

			// Set up motion and orientation event handlers
			app._initDeviceMotion();
			app._initDeviceOrientation();

			// ########################################
			// Listen for changes on the Edit Panel

			if (app.isAppBuilder) {
				var options = {
					childList: true,
					attributes: true,
					characterData: false,
					subtree: true,
				};

				var observer = new MutationObserver(mCallback); // used to use DOMSubtreeModified

				function mCallback(mutations) {
					// only process if the function isnot pending
					if (!app._DOMSubtreeModifiedPending) {
						app._DOMSubtreeModifiedPending = true;

						setTimeout(() => {
							app._DOMSubtreeModifiedPending = false;
							app.doDOMSubtreeModified(mutations);
						}, app._DOMSubtreeModifiedInterval);
					}
				}
				//				observer.observe(jQuery('#popup-container,.popup-window')[0], options);
				observer.observe(jQuery("body")[0], options);

				// ########################################

				// Event when Publish button clicked

				setTimeout(function () {
					jQuery('.toolbox ul.app-controls>li>a:contains("Publish")')
						.off("click")
						.on("click", function () {
							// Extra checks for EDU users
							if (app.isEDUUser) {
								setTimeout(function () {
									jQuery("body>.popup-window .publish_warning").remove();
									jQuery("body>.popup-window .content.controls").before(
										'<div class="publish_warning_container"><div class="publish_warning alert alert-info">Checking app visiblity...</div><p>(Go to App Settings -> Advanced to change this setting.)</p></div>'
									);

									// Get the app settings
									if (
										!app._getAppSettings(function () {
											// Show a warning if the app will be visible in the App Gallery
											if (app.settings.app_galleryhide) {
												jQuery("body>.popup-window .publish_warning")
													.addClass("alert-success")
													.removeClass("alert-info")
													.text(
														"Your app will NOT be visible in the public App Gallery."
													);
											} else {
												jQuery("body>.popup-window .publish_warning")
													.addClass("alert-warning")
													.removeClass("alert-info")
													.text(
														"PLEASE NOTE: Your app will be visible in the public App Gallery."
													);
											}
										})
									) {
										// if _getAppSettings returns false, an error ocurred

										// remove the publish_warning
										jQuery(
											"body>.popup-window .publish_warning_container"
										).remove();
									}
								}, 300);
							}
						});
				}, 1000);
			}

			// If https turn orientationTracking on by default
			if (String(window.location.href).search(/^https/) != -1) {
				app._enableOrientationTracking = true;
			}
			if (app._enableOrientationTracking) {
				app._startOrientationTracking();
			}

			// Start the loop timeout interval
			setTimeout(function () {
				try {
					app.loop();
				} catch (er) {}
			}, app._loopTimeout);

			/* 
			==================
			  LOOP functions
			==================
			*/

			// Loop to update statusIndicator
			app.loop(function () {
				// If the default device is a connected
				if (app.device && app.device.connected) {
					jQuery("#statusIndicator .symbol").addClass("connected");
				} else {
					jQuery("#statusIndicator .symbol").removeClass("connected");
				}
			});

			// ==================

			// Connect Devices... if auto, or there is a Board Layout assigned to the app
			if (!isNaN(parseInt(app.getDefaultLayoutId()))) {
				app._autoConnectDevices = true;
			}
			if (app.isAppBuilder) {
				app._autoConnectDevices = false;
			}
			if (app._autoConnectDevices) {
				setTimeout(app.autoConnectDevices, app._autoConnectInterval);
			}

			// Save init timestamp
			app._loginHourUTC = app.utils.getHourTimestampUTC();

			// Import andy required libraries
			app.doImports();

			app._init2();
		};

		

		app._init2 = function () {
			// some init tasks can only be done once jQuery loaded

			if (
				app._scriptLoaded_jquery &&
				app._scriptLoaded_ajaxq &&
				app._importsDone
			) {

				
			// jQuery plugin "deepest" - credit https://gist.github.com/geraldfullam/3a151078b55599277da4#file-jquery-deepest-js
			(function ($) {     $.fn.deepest = function (selector) {         var deepestLevel  = 0,             $deepestChild,             $deepestChildSet;               this.each(function () {             $parent = $(this);             $parent                 .find((selector || '*'))                 .each(function () {                     if (!this.firstChild || this.firstChild.nodeType !== 1) {                         var levelsToParent = $(this).parentsUntil($parent).length;                         if (levelsToParent > deepestLevel) {                             deepestLevel = levelsToParent;                             $deepestChild = $(this);                         } else if (levelsToParent === deepestLevel) {                             $deepestChild = !$deepestChild ? $(this) : $deepestChild.add(this);                         }                     }                 });             $deepestChildSet = !$deepestChildSet ? $deepestChild : $deepestChildSet.add($deepestChild);         });                      return this.pushStack($deepestChildSet || [], 'deepest', selector || '');     }; }(jQuery));     


				// appjs-test notification

				if (window._appjs_test) {
					if (jQuery(".appjs_test").length == 0) {
						jQuery(
							'<div class="appjs_test" style="position: fixed;bottom: 0px;right: 0px;background: red;padding: 5px 30px 5px 30px;width: 100px;text-align: center;color: white;font-size: 13px;line-height: 14px; z-index: 1000;">appjs_test<div class="appjs_test_version" style="font-size: 10px;">v' +
								app.version +
								"</div></div>"
						)
							.appendTo("body")
							.append(
								jQuery(
									'<div class="appjs_test_close" style="position: absolute;top: 0px;right: 0px;font-size: 8px;border: 1px solid #fff;border-radius: 8px;width: 12px;height: 12px;line-height: 13px;margin: 3px;float: right; cursor: pointer;">X</div>'
								).click(function () {
									//jQuery('.appjs_test').hide();
									window.location.href =
										window.location.origin +
										window.location.pathname +
										"?testappjs=0" +
										window.location.hash;
								})
							);
					} else {
						jQuery(".appjs_test").show();
					}
					console.log(
						"%c________________________ appjs_test " +
							app.version +
							" ________________________",
						"background: red; color: #FFF;line-height: 30px;"
					);
				}

				// New version - hide the popup, check using interval
				app.setInterval(
					function () {
						jQuery('.popup-window:contains("Registration")').each(function () {
							var jThis = jQuery(this);
							if (parseInt(jThis.css("height")) == 460) {
								jQuery("body>.popup-underlay").remove();
								jThis.remove();
							}
						});
					},
					100,
					5000
				);

				// jQuery functions

				jQuery.fn.isFixed = function () {
					try {
						var ele = jQuery(this);

						if (!ele.length) {
							return null;
						}

						var eleCheck = ele.offsetParent(),
							returnVal;
						if (eleCheck.prop("tagName") === "HTML") {
							return false;
						}

						returnVal =
							eleCheck.css("position") !== "fixed" ? eleCheck.isFixed() : true;
						return returnVal;
					} catch (error) {
						console.error("jQuery.fn.isFixed", error);
					}
				};

				/*
					Basic check to see if the element is in the viewport
				*/
				jQuery.fn.isInViewport = function () {
					try {
						if (jQuery(this).length == 0) {
							return;
						}

						var elementTop = jQuery(this).offset().top;
						var elementBottom = elementTop + jQuery(this).outerHeight();

						var viewportTop = jQuery(window).scrollTop();
						var viewportBottom = viewportTop + jQuery(window).height();

						var elementLeft = jQuery(this).offset().left;
						var elementRight = elementTop + jQuery(this).outerHeight();

						var viewportLeft = jQuery(window).scrollLeft();
						var viewportRight = viewportLeft + jQuery(window).width();

						return (
							elementBottom > viewportTop &&
							elementTop < viewportBottom &&
							elementRight > viewportLeft &&
							elementLeft < viewportRight
						);
					} catch (error) {
						console.error("jQuery.fn.isInViewport", error);
					}
				};

				// app.message.init(); DEPRECATED

				// if "ads" added to app, replace the class with adsv1 - deprecated
				jQuery(".app>.app-navigator.ads").removeClass("ads").addClass("adsv1"); // remove now

				// for Preview page
				if (app.isPreview) {
					jQuery("body").addClass("preview");

					// replace "//" in the description with two line breaks
					jQuery(".description").each(function (i, el) {
						jQuery(el).html(
							String(jQuery(el).text()).replace(/\/\//g, "<br><br>")
						);
					});
				}

				app.addCoreStyles();

				app._doScreenOnLoadEditIcons();

				/* 
				No longer restricting ios14 to these apps
				
				if(app.id >1572135 || app.id == 5041){
					jQuery('.app').addClass('ios14');
				}
				*/

				app.updateState();

				// Check if Trial requested
				if (window.location.params.get("trial") == "1") {
					sessionStorage.setItem("trialRequested", "1");
				}

				// Add new courses link
				app._addNewCoursesLink();

				// Remap the iot.js methods
				try {
					window.appbuilder.events.iot.setPin = function (pinName, value) {
						app.getDevice().setPin(pinName, value);
					};
					window.appbuilder.events.iot.togglePinValue = function (pinName) {
						app.getDevice().togglePin(pinName);
					};
				} catch (er) {}

				if (true) {
					// app.isAppBuilder
					// Pulsing light and Log Messages
					try {
						// set the default style properties for the web app
						var top = "5px";
						var leftright = "right: 6px; ";
						var descriptor = ".phone";
						var descriptor2 = ".phone";
						// change properties for AppBuilder
						if (app.isAppBuilder) {
							top = "30px";
							leftright = "left: 40px; ";
							descriptor = ".phone.background";
							descriptor2 = ".app";
						}

						if (jQuery("#statusIndicator").length == 0) {
							jQuery(descriptor).prepend(
								'<div id="statusIndicator" class="light-pulse" style="' +
									leftright +
									";  top: " +
									top +
									';"><div style="width: 50%; margin: 0 auto; "><div class="symbol" style=""></div></div></div>'
							);

							jQuery("#statusIndicator .symbol").html("&#9881");
						}

						if (jQuery("#logMessages").length == 0) {
							jQuery(descriptor2).prepend(
								'<div id="logMessages" class="loader" style="display: none;"><div class="inner"><div class="header"><div class="title">Settings</div></div><div class="scrolling"></div></div></div>'
							);
						}

						// Status Indicator click

						jQuery("#statusIndicator").click(app.showStatusMessage);

						// use https for web link
						jQuery('.toolbox a:contains("Share")').click(function () {
							var newLink = String(
								jQuery(".app-webview-url").attr("href")
							).replace(/http:/, "https:");
							jQuery(".app-webview-url").attr("href", newLink);
						});

						// Make some changes to Modules aka Templates
						// change tab label
						jQuery(".content-items.modules").html(
							'<i class="icon-copy"></i> Templates'
						);

						// change button label
						jQuery("#tab_modules a:contains('New Module')").text(
							"New Template"
						);

						// Add a search box to Modules search
						jQuery("#search-form-modules input[name='srch']").attr(
							"placeholder",
							"Search Templates"
						);
						if (jQuery("#search-form-modules-button").length == 0) {
							jQuery("#search-form-modules input").after(
								'<button id="search-form-modules-button" style="margin-left: 4px; margin-bottom: 10px; height: 30px" type="submit">Search</button>'
							);
						}
					} catch (er) {
						app.handleError(er, "Can't show status LED app._init2");
					}
				}

				// disable console.log console.warn console.debug console.info if not AppBuilder, too many logs (especially with device variable updates) might cause sluggish behaviour
				if (!app.isAppBuilder && !app._debug) {
					app.disableLogging();
				}

				// Add an event handler to run every time the "app" changes...
				// ie App listing shown, or a different app loaded
				// Run after delay to take it out of sync

				// prepare some Game Maker things
				app.game._onLoadApp();

				// Kick off the logoLoop interval
				setInterval(function () {
					if (app._logoLoopActive) {
						app.logoLoopOld(app._logoLoopSettings);
					}
				}, 500); // check frequently as the user can override the normal _logoLoopDelay value

				// add the event handlers to the `Tab` to initialise the screen
				app.phone.addEvent("tab", function (id, el) {
					app._initTab(id, el);
				});

				// add the event handlers to the `Screen` to initialise the screen
				app.phone.addEvent("screen", function (id, el) {
					app._initScreen(id, el);
				});

				// Get the ASAs initialized
				app.asa._init();


				/* 
				#######################################################################
				// Now the app is ready
				####################################################################### 
				*/
				app.ready = true;

				// call all ready functions
				app.doReady();

				// if there is an app.init() function in this app, call it
				if (typeof app.init == "function") {
					app.init();
				}


				// For the first screen this needs to be called manually
				try {
					app._initScreenFirst();
				} catch (er) {
					console.error("app._init2 " + er);
				}

				// in gamemaker, apps homescreen needs resizing
				jQuery(".gamemaker .items-inner .apps").css("width", "328");

				app.doThemes();

				install30(function () {
					// install30_callback
					// These things must only happen once install30 compeltes

					app._showProduct();

					/* ******************************** _tr ******************************** */
					app._trUIChanges();

					app.mtGetConfig(); // get Mautic config settings

					app._showWebAppContent();

					// Dispatch the event.
					document.dispatchEvent(app.events["ase-init-done"]);

					// init the user, session, trial, school etc.
					app.getUser();
				});
			} else {
				setTimeout(app._init2, 500);
			}
		};


		app.initAccordion = function () {
			// Initialises any accordions on the screen
			// To create an Accordion add the className `accordion` to the `Item`
			// Returns `this`

			// Thumb/ Image Links
			new Fx.Accordion(this, ".accordion.item", ".accordion.item .text", {
				alwaysHide: true,
				display: -1,
				onActive: function (t, el) {
					el.getParent(".accordion.item").getElement("img").addClass("rotate");
				},
				onBackground: function (t, el) {
					el.getParent(".accordion.item")
						.getElement("img")
						.removeClass("rotate");
				},
				onComplete: function () {
					try {
						app.refreshScroll();
					} catch (er) {}
				},
			});

			return this;
		};

		app._initDeviceMotion = function () {
			// tasks to set up devicemotion event handling

			// NB HTTPS is required for devicemotion, especially chrome

			// TODO this is outdated, needs to be adjusted on Cordova for new APIs
			// https://blog.phonegap.com/migrating-from-the-cordova-device-orientation-plugin-8442b869e6cc

			if (navigator && navigator.accelerometer) {
				// Cordova
				navigator.accelerometer.watchAcceleration(
					app.deviceMotionHandler,
					null,
					{
						frequency: 100,
					}
				);
			} else if ("ondeviceorientation" in window) {
				window.addEventListener("devicemotion", app.deviceMotionHandler, false);
			}
		};

		app._initDeviceOrientation = function () {
			// tasks to set up deviceorientation event handling

			// Useful reference https://www.audero.it/demo/device-orientation-api-demo.html
			// TODO implement PhoneGap code - this is deprecated

			// Cordova check
			if (app.isPhoneGap) {
				if (navigator && navigator.accelerometer) {
					navigator.accelerometer.watchAcceleration(
						app.deviceOrientationHandler,
						null,
						{
							frequency: 100,
						}
					);
				}

				// Web browser check
			} else if ("ondeviceorientation" in window) {
				window.addEventListener(
					"deviceorientation",
					app.deviceOrientationHandler
				);
			}
		};

		app._initDeviceOrientationAbsolute = function () {
			// tasks to set up deviceorientation event handling

			// Useful reference https://www.audero.it/demo/device-orientation-api-demo.html
			// TODO implement PhoneGap code - this is deprecated

			// Cordova check
			if (app.isPhoneGap) {
				if (navigator && navigator.accelerometer) {
					navigator.accelerometer.watchAcceleration(
						app.deviceOrientationAbsoluteHandler,
						null,
						{
							frequency: 100,
						}
					);
				}

				// Web browser check
			} else if ("deviceorientationabsolute" in window) {
				window.addEventListener(
					"deviceorientationabsolute",
					app.deviceOrientationAbsoluteHandler
				);
			}
		};

		/*
		_initEmitCloudVariables
		Set up Cloud Variables to emit their changes
		*/
		app._initEmitCloudVariables = function (options) {
			// get all cloud variables - look for the presence of data-variable attribute
			jQuery(".item.option-cloud-variable [data-variable]").each(function () {
				var jItem = jQuery(this).parent().parent();
				var item = app.getItem(jItem.attr("id"));
				var name = item.getVariableName();

				// turn off any input events
				item.jQuery.off("input");

				// NB NB NB NB NB NB NB NB NB NB NB NB
				// This code exists in ANOTHER LOCATION - change both places
				item.jQuery.on("input", function () {
					app.socket.emit("cloud-variable-changed", {
						appId: app.id,
						name: name,
						value: event.target.value,
						fromUser: app.getUser().getId(),
						fromApp: app.id,
					});
				});
			});
		};

		app._call_initScreen = function (id, el) {
			// repeatedly try call _initScreen for a duration
			// this is used on the first screen load
			/*
			app.setInterval(()=>{
				try{
					app._initScreen(app.getScreen().id,app.getScreen().element);
					app.clearInterval("_call_initScreen");
				}catch(er){}
			},100,2000,"_call_initScreen")
			*/
		};


		app._initScreen = function (id, el, force) {
			// initilisation of each screen on load
			// `force` forces the function to run, bypassing conditions that would limit it

			// If this is the same as lastScreen, and less than x millis, then don't init again
			if (
				(typeof force == "undefined" || force === false) &&
				id == app._lastScreenId &&
				Date.now() < app._lastScreenInitTime + 1000
			) {
				return;
			}
			try {
				//
				app._currentScreen = String(id).replace(/\D/g, "");
				app.id = app.getCurrentAppId(); // sometimes the id is 1 when starting up
				localStorage["currentScreen"] = app._currentScreen;

				// save this screen in the app property
				app.screen = app.getScreen(el);

				// fix Map screens
				//app._fixMapScreen(id,el);

				// do imports
				app.doScreenImports(id, el);

				// run any Screen.onLoad event handlers
				app.doScreenOnLoad(id, el);

				// Add the edit icons
				app._doScreenOnLoadEditIcons(id, el);

				// log screen classNames, id
				//app._saveScreenData(id,el)

				// to capture `click` events
				app.addScreenClickHandlers(id, el);

				// Save field changes to variables
				// This is needed because setVariable is not called when tapping a button
				app.applyFieldFocusRules(id, el);

				// make text areas easier to edit
				app.handleTextareaEditing(id, el);

				// to reformat Capture elements using HTML5
				app.reformatCaptureItems(id, el);

				// to reformat range elements using HTML5
				app.reformatInputTypes(id, el);

				// reformat data items
				app.reformatDataItems(id, el);

				// Initialise __cloud variables
				app._initScreenCloudVariables(id, el);

				// Initialise accordions on the screen
				app.initAccordion.call(el);

				// reposition Items
				app.repositionItems(id, el);

				// implement any context menu changes
				app.contextMenuChanges(id, el);

				// disable scroll
				app.applyScrollRules(el);

				// look for IoT device pin fields matching the naming convention
				app.markPinVariablesAsInputs();

				// Create audio items for Sound Actions
				// Some mobile browsers block JavaScript initiated sounds, so pre-load audio items
				app.preloadAddioItems(el);


				// scroll to top on apps-screen
				jQuery('.app-icon.newapp').click(()=>{
					window.scrollTo(0,0)
				})

				// if this is the first screen to display for this app...
				if (!app._firstScreenDone) {
					app._firstScreenDone = true;

					// show the default product
					// this messes up loading courses from a location hash, so let's try skip it
					// app.game._showProduct();
				}

				// auto-start game, maybe?
				app.game.autoStart(id, el);

				// ASE event
				document.dispatchEvent(app.events["ase-screen-init-done"]);
			} catch (er) {
				console.error("ERROR in app._initScreen()", er);
			}

			app._lastScreenId = id;
			app._lastScreenInitTime = Date.now();
		};


		/*
		_initScreenCloudVariables
		Initialise variables that require cloud synchronisation using socket.io 
		*/
		app._initScreenCloudVariables = function (id, el) {
			if (jQuery(".app .screen .items .item.option-cloud-variable").length) {
				// Make sure socket.io is loaded
				// add id and el to the options
				app._loadSocket(
					{
						id: id,
						el: el,
					},
					function (options) {
						app.socket = io("https://socket.appshed.com");
						app.socket.once("connect", () => {
							app.warn(
								505,
								"The socket is connected. Cloud Variables will now sync."
							);

							// start listening
							app._startSocketListener();

							// join the default room
							app.socket.emit("join_room", "app" + app.id);

							// emit when cloud-variables change
							app._initEmitCloudVariables(options);
						});

						app.socket.once("connect_error", () => {
							app.warn(
								5,
								"The app could not connect to the socket server. Cloud Variables will not work.",
								"_initScreenCloudVariables connect_error",
								app._getCloudVariableItemIDs()
							);
						});
					}
				);
			}
		};

		/*
		_initScreenFirst
		Calls the _initScreen for the first screen when the page loads... 
		Required since the event handler does not trigger for the first screen (maybe can be fixed in future)
		*/
		app._initScreenFirst = function () {
			try {
				var el = jQuery(".app .screen")[0];
				if (el !== null && typeof el !== "undefined") {
					app._initScreen(el.id, el, true);
				}
			} catch (error) {
				console.error("app._initScreenFirst", error);
			}
		};

		app._initTab = function (id, el) {
			id = null;
			el = null;
		};

		// Initialize (or re-initialize) the code editor on the element el using options
		app._initializeCodeEditor = function (el, options) {
			options = options || {}; // create an empty object of null passed in

			// try retrieve the editor and put back in textarea
			// will fail if not present
			try {
				var edtr = el.retrieve("editor");
				if (edtr) {
					edtr.toTextArea();
				}
			} catch (error) {
				console.warn("_initializeCodeEditor", error);
			}

			var editor = CodeMirror.fromTextArea(el, {
				mode: options.hasOwnProperty("mode") ? options.mode : "javascript",
				lineNumbers: options.hasOwnProperty("lineNumbers")
					? options.lineNumbers
					: !0,
				theme: options.hasOwnProperty("theme") ? options.theme : "cobalt",
				matchBrackets: !0,
				indentUnit: 4,
				indentWithTabs: !0,
				enterMode: "keep",
				tabMode: "shift",
				gutters: options.hasOwnProperty("gutters")
					? options.gutters
					: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"],
				lint: options.hasOwnProperty("lint") ? options.lint : true,
				readOnly: options.hasOwnProperty("readOnly") ? options.readOnly : false,
			});

			// put the editor ontp the element
			el.store("editor", editor);
		};

		app._insertBlockly2 = function () {
			// Add Blockly2 editor (new version)

			// the first time loading blockly2 , load Blockly2 scripts
			if (!app._loadBlockly2ScriptsStart) {
				return app._loadBlockly2Scripts(function () {
					// in the callback, setup Blockly2
					app._insertBlockly2();
				});
			}

			try {
				if (jQuery("#action-target").length) {
					// hide old blockly
					jQuery("#action-target>div:first").children().hide();

					// add blockly2 div
					jQuery("#action-target>div:first").append(
						'<div id="blockly2" style="height: 700px; width: 410px;"><div class="blockly2_titlebar" style="height: 42px;    width: 100%;    background-color: #262626;"></div></div>'
					);

					// Expand button
					jQuery(".blockly2_titlebar").append(
						'<button class="btn expand do-expand" type="button"><i class="icon-resize-full"></i> Expand</button>'
					);
					jQuery(".blockly2_titlebar .do-expand").click(function () {
						window.scrollTo(0, 0);

						// expand blockly2
						jQuery("#blockly2")
							.prependTo("body")
							.css("z-index", 1200)
							.css("position", "absolute")
							.css("top", "0px")
							.css("left", "0px")
							.css("bottom", "0px")
							.css("right", "0px")
							.css("width", "unset")
							.css("height", "unset");
						Blockly.svgResize(app._blockly2Workspace);

						// hide the Expand button
						jQuery(".blockly2_titlebar button.do-expand").addClass("hidden");
						// show the Shrink button
						jQuery(".blockly2_titlebar button.do-shrink").removeClass("hidden");
					});

					// Shrink button
					jQuery(".blockly2_titlebar").append(
						'<button class="btn expand do-shrink hidden" type="button"><i class="icon-resize-small"></i> Shrink</button>'
					);
					jQuery(".blockly2_titlebar .do-shrink").click(function () {
						window.scrollTo(0, 0);

						// shrink blockly2
						jQuery("#blockly2")
							.prependTo("#action-target")
							.css("z-index", 1200)
							.css("position", "inherit")
							.css(
								"width",
								document.getElementById("action-target").offsetWidth + "px"
							)
							.css("height", "700px");
						Blockly.svgResize(app._blockly2Workspace);

						// hide the Expand button
						jQuery(".blockly2_titlebar button.do-expand").removeClass("hidden");
						// show the Shrink button
						jQuery(".blockly2_titlebar button.do-shrink").addClass("hidden");
					});

					var options = {
						toolbox: app._blockly2Toolbox,
						collapse: true,
						comments: false,
						disable: false,
						maxBlocks: Infinity,
						trashcan: true,
						horizontalLayout: false,
						toolboxPosition: "start",
						css: true,
						media: "https://blockly-demo.appspot.com/static/media/",
						rtl: false,
						scrollbars: true,
						sounds: true,
						oneBasedIndex: true,
						grid: {
							spacing: 20,
							length: 1,
							colour: "#888",
							snap: true,
						},
						zoom: {
							controls: true,
							wheel: true,
							startScale: 1,
							maxScale: 3,
							minScale: 0.3,
							scaleSpeed: 1.2,
						},
					};

					app._blockly2Workspace = Blockly.inject("blockly2", options);
					Blockly.addChangeListener(app._blocklyChangeHandler);

					app._blocklyWinInterval = app.setInterval(
						() => {
							// Populate the workspace with the old Blockly dom
							// only do this once, by saving status in the Blockly iFrame
							var blocklyWin = jQuery("#action-target iframe")[0].contentWindow;
							if (!blocklyWin.originalLoad) {
								Blockly.Xml.domToWorkspace(
									blocklyWin.Blockly.Xml.workspaceToDom(
										blocklyWin.Blockly.mainWorkspace
									),
									Blockly.mainWorkspace
								);
								blocklyWin.originalLoad = true;
							}

							// sometimes blockly does not appear, so need to try resize a couple times
							Blockly.svgResize(app._blockly2Workspace);
						},
						100,
						4000
					);
				}
			} catch (er) {
				console.warn("ERROR app._insertBlockly2 ", er);
			}
		};

		app._installEDU40 = function () {
			////////////////////////////////////////////////////////////////////
			//              EDU 4.0
			////////////////////////////////////////////////////////////////////
			// appshed.com email login will see app40
			//if(app.getCookieVal('appshedlogin').search(/appshed\.com/) > 0){

			app._isAPP40 = true;
			jQuery("body").addClass("app40");

			// Login and add New EDU BETA link
			if (window._appjs_test === true) {
				//app._loginToEDU();
			}
		};

		/*
			return the iScroll object for the app
		*/
		app.iScroll = function () {
			if (!app._iScroll) {
				try {
					app._iScroll = jQuery(".items")[0].retrieve("scroll");
				} catch (er) {}
			}

			return app._iScroll;
		};

		app.isLandscape = function () {
			// Return true if the device screen is landscape orientation not portrait

			if (app.isPhoneGap && jQuery("body").width() > jQuery("body").height()) {
				return true;
			} else if (
				!app.isPhoneGap &&
				jQuery(".app").width() > jQuery(".app").height()
			) {
				return true;
			}

			return false;
		};

		app._isSuperUser = function () {
			// returns true if the current user is in the group `Super Users`

			if (
				jQuery('.navbar-fixed-top .dropdown:contains("Admin Tools")').length
			) {
				return true;
			}

			return false;
		};

		app._isTRExp = function () {
			// Returns true if this is a free user and the tr has exp

			//return window._app_trExp;
			return window.appshed["trExp"];
		};

		app.loadAppData = function (idOrSlug, callback) {
			// Loads the app data for another app `idOrSlug`
			// Optional `callback` function called, passed one parameter: `idOrSlug`
			// Returns `this`

			// SPECIAL CASE
			// Change 'appcar' to 'libappcar'  - temporary workaround to get appcar library from another app
			// this allows the app 'appcar' to be the user facing app
			if (idOrSlug == "appcar") idOrSlug = "libappcar";

			var protocol = "http";
			if (window && window.location && window.location.protocol) {
				protocol = window.location.protocol;
			}

			jQuery
				.ajax({
					url:
						protocol +
						"//cors.appshed.com/?u=http://apps.appshed.com/" +
						idOrSlug,
				})
				.always(function (data) {
					if (data.status == 200 || data.statusText == "OK") {
						var appId = data.responseText.replace(
							/[\s\S]*"app":(\d+),"request"[\s\S]*/,
							"$1"
						); //

						// now get the app json
						jQuery
							.ajax({
								url:
									protocol +
									"//cors.appshed.com/?u=http://apps.appshed.com/" +
									idOrSlug +
									"/" +
									appId +
									".app.js",
							})
							.always(function (data) {
								if (data.status == 200 || data.statusText == "OK") {
									try {
										var rObj = JSON.parse(
											data.responseText.replace(
												/appbuilder\.app\.FileLoader\.fetched\(([\s\S]*)\);$/,
												"$1"
											)
										); //
										if (!app._appData[idOrSlug]) app._appData[idOrSlug] = {};

										app._appData[idOrSlug].data =
											rObj["app"][Object.keys(rObj["app"])[0]];

										if (callback != null) callback(idOrSlug);
									} catch (er) {
										app.handleError(er, "app.loadAppData(" + idOrSlug + ")");
									}
								}
							});
					}
				});
		};

		app._loadBlockly2Scripts = function (callback) {
			// Start loading the Blockly2 scripts
			app._loadBlockly2ScriptsStart = true;

			// hide old blockly
			jQuery("#action-target>div").children().hide();
			// Add a loading placeholder
			app._showBlockly2Loader();

			// load the blockly scripts
			// load the new blockly2 scripts, and the old blocks and javascript files that have all the old definitions
			app.loadScript(
				"https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/blockly-compressedjs.js",
				function () {
					app.loadScript(
						"https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/javascript-compressedjs.js",
						function () {
							app.loadScript(
								"https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/blocks-compressedjs.js",
								function () {
									app.loadScript(
										"https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/blocksjs.js",
										function () {
											app.loadScript(
												"https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/blockly/enjs.js",
												function () {
													// all scripts loaded
													app._loadBlockly2ScriptsDone = true;
													app._hideBlockly2Loader();

													if (callback) {
														callback.call();
													}
												}
											);
										}
									);
								}
							);
						}
					);
				}
			);
		};

		app._loadJSLint = function () {
			app.loadScript(
				window.location.origin + "/templates/yoo_katana/js/jslint_wrapper.js",
				null,
				"module"
			);
		};

		/*
		loadScript
		Adds a `<link>` tag with `src = url` to the `<head>` 

		Optional `callback` called when the script has loaded (ready)
		Optional `el` specifies the element to add it to (e.g. iframe target for Blockly)
		Optional `forceReload` will reload the script even if it exists on the DOM
		Optional `onErrorCallback` called if the script fails to load
		*/
		app.loadScript = function (
			url,
			callback,
			filetype,
			el,
			forceReload,
			onErrorCallback
		) {
			try {
				var el = el || document.getElementsByTagName("head")[0];
				var tag = "script";
				var fileref;

				// check if this link already present
				var currentlinks = el.getElementsByTagName(tag);
				for (var j = 0; j < currentlinks.length; j++) {
					if (currentlinks[j].href == url || currentlinks[j].src == url) {
						if (forceReload) {
							currentlinks[j].remove();
						} else {
							if (callback) {
								callback(url);
								return true;
							}
						}
					}
				}

				if (filetype == "css") {
					//if filename is an external CSS file
					fileref = document.createElement("link");
					fileref.setAttribute("rel", "stylesheet");
					fileref.setAttribute("type", "text/css");
					fileref.setAttribute("href", url);
				} else if (filetype == "module") {
					fileref = document.createElement("script");
					fileref.setAttribute("type", "module");
					fileref.setAttribute("src", url);
				} else {
					//if filename is a external JavaScript file
					fileref = document.createElement("script");
					fileref.setAttribute("type", "text/javascript");
					fileref.setAttribute("src", url);
				}

				// add the error callback
				if (onErrorCallback && typeof onErrorCallback === "function") {
					fileref.onerror = onErrorCallback;
				}

				// add the success callback
				if (callback) {
					if (fileref.readyState) {
						//IE
						fileref.onreadystatechange = function () {
							if (
								fileref.readyState === "loaded" ||
								fileref.readyState === "complete"
							) {
								fileref.onreadystatechange = null;
								callback(url);
							}
						};
					} else {
						//Others
						fileref.onload = function () {
							callback(url);
						};
					}
				}

				// add the script to the DOM
				if (typeof fileref != "undefined") {
					el.appendChild(fileref);
				}
			} catch (er) {
				console.warn("ERROR app.loadScript", er, url, callback, filetype, el);
			}

			return true;
		};

		/*
		_loadSocket
		Loads the socket.io script 
		Optional `callback` called when done, passed `options`
		*/
		app._loadSocket = function (options, callback) {
			var options = options || {};

			app.loadScript(
				"https://socket.appshed.com/socket.io/socket.io.js",
				function () {
					if (callback) {
						callback.call(this, options);
					}
				},
				null,
				null,
				null,
				function () {
					// on error
					var itemIDs = app._getCloudVariableItemIDs();
					app.warn(
						5,
						"The app could not load the socket.io script. Cloud Variables will not work.",
						"_loadSocket could not load socket.io",
						itemIDs
					);
				}
			);
		};

		app.log = function (aMsg, itemIds) {
			// Save `aMsg` to the `app._log`
			// The user can access the log by clicking on the status light in the simulator
			// Optional `itemIds` are the affected items
			var itemIds = itemIds || [];

			var now = Date.now();
			app._log.push({
				timestamp: now,
				msg: aMsg,
				itemIds: itemIds,
			});
		};

		// Cyberbob
		/*
        jQuery('<div class="cyberbob-the-net-container3" style="position: fixed; bottom: 10px; left: 70px;"><div class="cyberbob-inner" style="position: relative;"><img src="https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/cyberbob-the-net.png" class="cyberbob-image" style="width: 20px;filter: grayscale(100%);"></div></div>').appendTo('body').click(()=>{
            if(confirm('This will clear your progress in localStorage, ok?')){
                app.asa.reset('demo-feature-tour');
                localStorage['asas'] = '';
            }
        })
        */

		/*
			Creates the user on the edu.appshed.com Moodle site and logs them in
		*/
		app._loginToEDU = function () {
			jQuery
				.ajax({
					url:
						"https://api.appshed.com/user/session?sessionId=" +
						app.getCookieVal("fd80d3664c1b48eccd2de275919ca98c"),
					xhrFields: { withCredentials: true },
				})
				.done(function (a, b, c) {
					console.warn("EDU Auth: DONE api.appshed.com/user/session this,a,b,c",this,a,b,c);
					var responseJSON = c.responseJSON;

					// now use the user id to create the user in EDU site (Moodle)
					jQuery
						.ajax({
							url: "https://devapi.appshed.com/edu/user/create/" + a.id,
							xhrFields: { withCredentials: true },
						})
						.done(function (aa, bb, cc) {
							console.warn("EDU Auth: DONE devapi.appshed.com/edu/user/create/ this,aa,bb,cc",this,aa,bb,cc);

							// callback once EDU Popup created

							// try get username from earlier session
							try {
								if (
									typeof responseJSON === "object" &&
									responseJSON.hasOwnProperty("username")
								) {
									jQuery("#as-edu-popup-iframe-1").on("load", function () {
										// fill in the login details and submit the login form
										var doc = jQuery(this).contents();
										doc.find("#username").val(responseJSON.username);
										doc.find("#password").val("Password_123");
										doc.find("form#login").submit();
										jQuery("#as-edu-popup-iframe-1").on("load", function () {
											// once done, the EDU panel is ready to be shown.
											console.warn("EDU Ready");
										});
									});
								}
							} catch (error) {
								console.error("_resourcepanelInit callback parse error", error);
							}

							/*
					// if successful, log in
					jQuery.ajax('https://appshed.com/edu/login/index.php' ,{
						method: 'POST',
						data: {username: c.username, password: 'Password_123'},
						crossDomain: true,
					}).done(function(aaa,bbb,ccc){
						console.warn('EDU Login: DONE edu.appshed.com/login/index.php this,aaa,bbb,ccc',this,aaa,bbb,ccc);
						app._resourcepanelInit();

					}).fail(function(aaa,bbb,ccc){
						console.warn('EDU Login: FAIL api.appshed.com/user/session this,aaa,bbb,ccc',this,aaa,bbb,ccc);		
					});
*/
						})
						.fail(function (aa, bb, cc) {
							console.warn(
								"EDU Auth: FAIL devapi.appshed.com/edu/user/create/ this,aa,bb,cc",
								this,
								aa,
								bb,
								cc
							);
						});
				})
				.fail(function (a, b, c) {
					console.warn(
						"EDU Auth: FAIL api.appshed.com/user/session this,a,b,c",
						this,
						a,
						b,
						c
					);
				});
		};

		/*
		Sends `params` to `deviceId` to draw logo commands
		Optional `deviceId` specifies the device, else `_deafultDevice` is used
		Params can be in the default Logo format:
			<cmd> <value> <cmd> <value> etc... (line breaks are ignored)
		or in script form:
			<cmd>,<value>;<cmd>,<value>;etc.
		Optional `callback` is called on completion
		Optional fns contains an array of functions
		Optional noGetInfo, indicates that logoHandleIfs must not getInfo for the device, i.e. use current values

		CMDs: 
			FD LT RT BK ST ARCFL ARCBL ARCFR ARCBR 
			D0 D1 D2 D3 D4 D5 D6 D7 D8 D9 A0 A1 A2 A3 A4 A5 A6 A7 A8 A9
			MAFD MABK MBFD MBBK 
			WAIT, DELAY
			SERVO[0-9] [0-180] e.g SERVO7 90 (Servo on Pin 7 to 90 deg)
			IF x = y AND a < b [ ... ]
			REAPEAT n [ ... ]
			LOOP [ ... ] 
			FN1 1 2 3 4 5 6 7 8 9 [ ... ]

		FN1 (functions)
			Up to 9 FNs... 
				e.g. FN1 FN2... FN9
			Can pass up to 9 variables (numbers) to the function
				e.g. FN1 4 2 8 [ ... ]
			Variables can be used in the function using VAR1
				e.g. FN1 4 [ REPEAT :VAR1 [ ... ] ]
		Returns `this`
		*/
		app.logo = function (params, settings, onSuccess, onFail) {
			var d = app.getDevice();

			// use logo2 unless build < 63
			if (!app.isAppBuilder && d && d.variables && d.variables.build < 63) {
				// we will do the code below
			} else {
				if (d.variables.build < 67) {
					return app.logo2(params, settings, onSuccess, onFail);
				} else {
					// logo3 from firmware 67
					return app.logo3(params, settings, onSuccess, onFail);
				}
			}

			var deviceId, fns, noGetInfo;

			try {
				deviceId = settings.deviceId;
				fns = settings.fns;
				noGetInfo = settings.noGetInfo;
			} catch (er) {}

			params = app.logoStringFixes(params);

			// Handle LOOP commands, these are run on an interval
			params = app.logoHandleLoops(params);

			if (!fns) {
				// default functions is to use form variables FN1... FN9
				fns = [
					{
						name: "FN1",
						code: app.getVariable("FN1"),
					},
					{
						name: "FN2",
						code: app.getVariable("FN2"),
					},
					{
						name: "FN3",
						code: app.getVariable("FN3"),
					},
					{
						name: "FN4",
						code: app.getVariable("FN4"),
					},
					{
						name: "FN5",
						code: app.getVariable("FN5"),
					},
					{
						name: "FN6",
						code: app.getVariable("FN6"),
					},
					{
						name: "FN7",
						code: app.getVariable("FN7"),
					},
					{
						name: "FN8",
						code: app.getVariable("FN8"),
					},
					{
						name: "FN9",
						code: app.getVariable("FN9"),
					},
				];
			}

			// handle functions with nested functions
			fns = app.logoInjectFunctionsIntoFnCode(fns);

			// Now inject functions into str
			params = app.logoInjectFunctions(params, fns);

			// Now expand all repeats
			params = app.logoInjectRepeats(params);

			// Now do IFs
			// If there are if in the code, handle that,
			// Otherwise get ready to send it off
			// NB this pattern must match the pattern used in
			//. logoHandleIfs to avoid indefinite loop
			if (params.match(/if/i)) {
				// this function will call app.logo for each if, so must return/exit
				return app.logoHandleIfs(params, noGetInfo, onSuccess, onFail);
			}

			// Basic Cleanup
			params = String(params);
			params = params.replace(/\n/g, ";");
			params = params.replace(/;;/g, ";");
			params = params.replace(/^;/g, "");
			params = params.replace(/  /g, " ");

			// get into the format <cmd>,<value>;<cmd>,<value>;
			params = params.replace(/(\w) (\d)/g, "$1,$2");
			params = params.replace(/(\d) /g, "$1;");
			// Each word is treated as a new command (might not be true with advanced commands or conditions)
			params = params.replace(/(\w) (\w)/g, "$1;$2");
			params = params.replace(/ /g, "");

			// Set up servos
			params = this.logoHandleServos(params, deviceId);

			// call the logo in chunks
			this.logoCallChunks(deviceId, params, onSuccess, onFail);

			return params;
		};

		/*
		Sends `params` to `deviceId` to draw logo commands
		settings:
			Optional `deviceId` specifies the device, else `_deafultDevice` is used
			Optional fns contains an array of functions
			Optional noGetInfo, indicates that logoHandleIfs must not getInfo for the device, i.e. use current values
			Optional queueNum
			Optional dontClearErrors
			Optional paramFormat, indicates which format to send the params. logo3 requires a new format for example
		Params can be in the default Logo format:
			<cmd> <value> <cmd> <value> etc... (line breaks are ignored)
		or in script form:
			<cmd>,<value>;<cmd>,<value>;etc.
		Optional `onSuccess` or onFail is called on completion

		CMDs: 
			FD LT RT BK ST ARCFL ARCBL ARCFR ARCBR 
			D0 D1 D2 D3 D4 D5 D6 D7 D8 D9 A0 A1 A2 A3 A4 A5 A6 A7 A8 A9
			MAFD MABK MBFD MBBK 
			WAIT, DELAY
			SERVO[0-9] [0-180] e.g SERVO7 90 (Servo on Pin 7 to 90 deg)
			IF x = y AND a < b [ ... ]
			REAPEAT n [ ... ]
			LOOP [ ... ] 
			FN1 1 2 3 4 5 6 7 8 9 [ ... ]

		FN1 (functions)
			Up to 9 FNs... 
				e.g. FN1 FN2... FN9
			Can pass up to 9 variables (numbers) to the function
				e.g. FN1 4 2 8 [ ... ]
			Variables can be used in the function using VAR1
				e.g. FN1 4 [ REPEAT :VAR1 [ ... ] ]
		Returns `this`
		*/
		app.logo2 = function (params, settings, onSuccess, onFail) {
			var settings = settings || {};

			// default paramFormat is 2
			if (!settings.hasOwnProperty("paramFormat")) {
				settings.paramFormat = 2; // use 2 to denote logo2 format
			}

			// Clear logoErrors - might get new errors back
			var d = app.getDevice(deviceId);

			// Clear logoErrors - might get new errors back
			if (
				!settings.hasOwnProperty("dontClearErrors") ||
				!settings.dontClearErrors
			) {
				d.logoErrors = [];
				d.logoErrorsCaptured = "";
				d.logoErrorsGotAt = 0;
				jQuery(".logocodestatus .logocodestatustext").removeClass("haserrors");
			}

			d.updateLogoErrorsStatus({
				msg: "Sending code...",
			});

			var deviceId, fns, noGetInfo;
			var queueNum = 0;

			if (settings && settings.hasOwnProperty("deviceId")) {
				deviceId = settings.deviceId;
			}
			if (settings && settings.hasOwnProperty("noGetInfo")) {
				noGetInfo = settings.noGetInfo;
			}
			if (settings && settings.hasOwnProperty("queueNum")) {
				queueNum = settings.queueNum;
			}

			// Call CLEAR if required
			params = app.logoHandleClear(params);

			// Call DISPLAY if required
			params = app.logoHandleDisplay(params);

			// Neaten up
			params = app.logoStringFixes(params);

			// Handle LOOP commands, these are run on an interval
			params = app.logoHandleLoops2(params);

			// Arithmetic
			params = app.logoHandleArithmetic(params);

			// CMD,VALUE pairs
			params = app.logoHandleCommands(params);

			// LABEL
			params = app.logoHandleLables(params);

			// Variables - MAKE
			params = app.logoHandleMake(params);

			// REPEAT
			params = app.logoHandleRepeat(params);

			// Basic Cleanup
			params = String(params);
			params = params.replace(/\n/g, ";"); // remnove line breaks
			params = params.replace(/\s+/g, " "); // remove double spaces

			// Handle parameters
			params = app.logoHandleParameters(params);

			params = params.replace(/ /g, "");
			params = params + ";";
			params = params.replace(/,;/g, ";");
			params = params.replace(/;;+/g, ";");

			// Functions - TO
			params = app.logoHandleFunctions(params);

			// IF Conditions
			params = app.logoHandleConditions(params);

			// Set up servos
			params = this.logoHandleServos(params, deviceId);

			// Final clean up
			params = params.replace(/^;+/g, ""); // remove leading ;

			// for build >= 70 change commands
			//if(window._appjs_test || (d && d.variables && d.variables.build >= 70)){
			if (d && d.variables && d.variables.build >= 70) {
				params = app._logoHandleBuild70(params);
			}

			// update logocodestatus on success or fail
			var new_onSuccess = function () {
				// call any function passed in
				try {
					onSuccess.apply(this);
				} catch (er) {}

				this.updateLogoErrorsStatus({
					msg: "Code received by device. Checking for errors...",
					status: "checkingForErrors",
				});
			};
			var new_onFail = function () {
				try {
					onFail.apply(this);
				} catch (er) {}

				this.updateLogoErrorsStatus({
					msg: "Code could not be sent to the device.",
				});
			};

			// call the logo in chunks
			if (settings.paramFormat == 2) {
				app.logoCallChunks2(
					deviceId,
					params,
					queueNum,
					new_onSuccess,
					new_onFail
				);
			} else if (settings.paramFormat == 3) {
				params = app._logo3Conversion(params);
				app.logoCallChunks3(
					deviceId,
					params,
					queueNum,
					new_onSuccess,
					new_onFail
				);
			}

			return params;
		};

		/*
		logo3 used for firmware from v67
		Converts logo format to a lower level code that is optimised to run on the microcontroller

		Parameters:
			params, settings, onSuccess, onFail - These are all passed to logo2
			options: this includes any new/additional options

		Returns logo2() return value
		*/
		app.logo3 = function (params, settings, onSuccess, onFail) {
			var settings = settings || {};

			// add the paramFormat to options
			if (!settings.hasOwnProperty("paramFormat")) {
				settings.paramFormat = 3; // use 3 to denote logo3 format
			}

			return app.logo2(params, settings, onSuccess, onFail);
		};

		/*
		Converts params to the format required for logo3

		Parameters:
			params: the logo string in logo2 format

		Returns: params (converted)
		*/
		app._logo3Conversion = function (params) {
			return params;
		};

		app.logoCallChunks = function (deviceId, params, onSuccess, onFail) {
			/*
				Call the logo function in chunks < 255 characters
			*/

			params = app.logoStringFixes(params);

			// If < 255, just call it
			if (params.length < 255) {
				return this.callFunction(deviceId, "logo", params, onSuccess, onFail);
			}

			// Get the first 255 chars
			var first = params.substring(0, 254);
			var rest = params.substring(254);

			// Find the last ; in first
			var re = new RegExp("(.*);(.*)");
			var match;

			if ((match = re.exec(first))) {
				// first is up to the last ;
				first = match[1];
				// Add the remaining part to rest
				rest = match[2] + rest;
			}

			// send off first ... don't pass the callback until the last chunk (<255)
			this.callFunction(deviceId, "logo", first, onSuccess, onFail);

			// pass last back to this function to get next chunk
			return this.logoCallChunks(deviceId, rest, onSuccess, onFail);
		};

		app.logoCallChunks2 = function (
			deviceId,
			params,
			queueNum,
			onSuccess,
			onFail
		) {
			/*
				Call the logo function in chunks < 255 characters
				queueNum: default 0, for one-off commands. 1 for loop
			*/

			var queueNum = queueNum || 0;
			params = app.logoStringFixes(params);

			// If < 255, just call it
			if (params.length < 255) {
				return this.callFunction(
					deviceId,
					"logo2",
					queueNum + "|" + params,
					onSuccess,
					onFail
				);
			}

			// Get the first 255 chars
			var first = params.substring(0, 254);
			var rest = params.substring(254);

			// Find the last ; in first
			var re = new RegExp("(.*);(.*)");
			var match;

			if ((match = re.exec(first))) {
				// first is up to the last ;
				first = match[1];
				// Add the remaining part to rest
				rest = match[2] + rest;
			}

			// send off first ... don't pass the callback until the last chunk (<255)
			this.callFunction(
				deviceId,
				"logo2",
				queueNum + "|" + first,
				onSuccess,
				onFail
			);

			// pass rest back to this function to get next chunk
			return this.logoCallChunks2(deviceId, rest, queueNum, onSuccess, onFail);
		};

		app.logoCallChunks3 = function (
			deviceId,
			params,
			queueNum,
			onSuccess,
			onFail
		) {
			/*
				Call the logo function in chunks < 255 characters
				queueNum: default 0, for one-off commands. 1 for loop
			*/

			var queueNum = queueNum || 0;
			params = app.logoStringFixes(params);

			// If < 255, just call it
			if (params.length < 255) {
				//				return this.callFunction(deviceId, "logo3", queueNum + "|" + params, onSuccess, onFail);
				return this.callFunction(deviceId, "logo3", params, onSuccess, onFail);
			}

			// Get the first 255 chars
			var first = params.substring(0, 254);
			var rest = params.substring(254);

			// Find the last ; in first
			var re = new RegExp("(.*);(.*)");
			var match;

			if ((match = re.exec(first))) {
				// first is up to the last ;
				first = match[1];
				// Add the remaining part to rest
				rest = match[2] + rest;
			}

			// send off first ... don't pass the callback until the last chunk (<255)
			//			this.callFunction(deviceId, "logo3", queueNum + "|" +first, onSuccess, onFail);
			this.callFunction(deviceId, "logo3", first, onSuccess, onFail);

			// pass rest back to this function to get next chunk
			return this.logoCallChunks3(deviceId, rest, queueNum, onSuccess, onFail);
		};

		app.logoHandleArithmetic = function (str) {
			/* Format arithmetic properly
				operators A + B + - * /
				Ignore spaces A+B
				Can be Variables, pins or numbers
					:VAR1+A0+512
			*/

			// Remove spaces either side of operators
			str = str.replace(/ *([\+\-\*\/]) */g, "$1");

			// URL escape some special characters
			str = str.replace(/\//g, "%2F");

			return str;
		};

		/*
		logoHandleClear
		Clear all the code running on the device if CLEAR in Logo Code.
		Remove CLEAR - do not send to device.
		*/
		app.logoHandleClear = function (params) {
			// If CLEAR, then call function
			if (params.search(/\bclear\b/i) >= 0) {
				app.getDevice().callFunction("clear");
				// clear expressions
				if (app.device) {
					app.device._logoExpressions = [];
				}

				// clear DISPLAYS
				jQuery(".item.logodisplay input,.item.logodisplay textarea").val("");
			}

			// remove all CLEAR
			params = params.replace(/\bclear\b/gi, "");

			return params;
		};

		/*
		logoHandleDisplay
		Display the required value in the input field
		*/
		app.logoHandleDisplay = function (params) {
			var str = "";

			// If DISPLAY, then setVariable input field
			var matches = params.match(/\bdisplay +.+/gim);

			if (app.getDevice() && app.device.connected) {
				jQuery.each(matches, function (i, exp) {
					// remove DISPLAY
					exp = exp.replace(/display +/i, "");

					app.device.logoDisplay(exp);
				});

				app.device.logoDisplayUpdate();
			}

			// remove all DISPLAY
			params = params.replace(/\bdisplay +.+/gim, "");
			return params;
		};

		app.logoHandleConditions = function (params) {
			params = params.replace(/(\w);([=<>!]+)([:\w])/g, "$1$2$3"); // remove ; before comparator
			params = params.replace(/(\w)([=<>!]+)([:\w])/g, "$1,$2,$3"); // commas before/after comparator ,=,

			//			params = params.replace(/(\bAND\b|\bOR\b)/g, "$1;"); // ; after AND/OR
			params = params.replace(/,AND,/g, ";AND;"); // ; after AND/OR
			params = params.replace(/,OR,/g, ";OR;"); // ; after AND/OR

			return params;
		};

		app.logoHandleFunctions = function (params) {
			params = params.replace(/\[;+/g, "["); // no ; after [
			params = params.replace(/\];+\[/g, "]["); // function parameters and statements - no colon between
			params = params.replace(/\bTO;/g, "TO,"); // comma after TO
			params = params.replace(/\];+END/g, "]END"); // no ; before END
			params = params.replace(/\b(TO,\w+)\[/g, "$1,["); // comma after function name
			params = params.replace(/\b(TO,\w+,\[:\w+),:/g, "$1;:"); // comma between parameters
			params = params.replace(/\b(TO,\w+,\[[^\]]*:\w+),:/g, "$1;:"); // comma between parameters
			/*
			for(var i=100;i>=0;i--){ // limit the check to n times
				params = params.replace(/\b(TO,\w+,\[^\]*:\w+),:/g, "$1;:"); // comma between parameters				
				if(params.search(/\bTO,\w+,\[[^\]]*?:\w+:/) == -1) { // check if any still need fixing
				//	i = -1
				}
			}
*/

			return params;
		};

		app.logoHandleIfs = function (str, noGetInfo, onSuccess, onFail) {
			/* handle if statements
				
				noGetInfo (optional) means evaluate the condition immediately, no getInfo callback
				To allow for nested Ifs...
				There should be no other brackets in the str by this time, 
				all repeats must be expanded
				Find the condition, then the first [, then the last ]
				Everything in between, send to app.logo
				if the condition is true
			
				If there are any WAITS preceeding the If, pause for that time before checking the condition
			
					e.g
					... WAIT 100 ... IF D0 = 1 [ ...  IF A3 > 345 [ ...  ] ... ]
			
				*/

			str = app.logoStringFixes(str);

			// remove linebreaks
			str = str.replace(/\r?\n|\r/g, " ");

			/* Looking for  $1 IF $2 $3
				$1 happens separately, so kick that off now, 
					but it might have waits
					so count the milliseconds of all waits in $1 before running condition
				$2 is the condition
				$3 is the body of the If, 
					as well as the 'remainder'... anything after the closing bracket of the if
					the remainder should also be kicked off
			*/

			var re = /(.*?)if\s*([^\[]*)\s*(\[.*)/gi,
				output = [],
				match,
				parts,
				last;

			if ((match = re.exec(str))) {
				// get the sum of all waits in $1
				var delay = app.logoSumWaits(match[1]);

				// now kick off $1
				app.logo(match[1]);

				// from $3 get the body and the remainder

				var startIndex = match[3].indexOf("[");
				var endIndex = app.indexofMatchingBracket(match[3]);

				// Get the condition
				var condition = match[2];

				// for all digital pins used in conditions, set them to inputs
				var cRE = /([AD]\d)/gi;
				var cMatches;
				while ((cMatches = cRE.exec(condition))) {
					// Only digital pins need to be configured
					if (cMatches[0].match(/D/i)) {
						var pinNum = cMatches[0].replace(/[AD]/i, "");
						app.getDevice().setPinMode(pinNum, "i");
						console.warn("INPUT", pinNum);
					}
				}

				// get the body (between the brackets), so add or subtract 1 to leave out []
				var body = match[3].substr(startIndex + 1, endIndex - 1);

				var remainder = "";
				// remainder is everything after endIndex
				if (str.length > endIndex) {
					// Execute the remainder now
					remainder = match[3].substr(endIndex + 1);
				}

				// after delay do the if
				setTimeout(function () {
					// To make sure we are testing the right values, need to call getInfo
					// and check values in the callback

					// remainder is everything after endIndex
					// run remainder at the same time as the body
					if (remainder > "") {
						app.logo(remainder, null, onSuccess, onFail);
					}

					/*
					Check the condition.
					The condition should have properties like D0, D1
					Need to replace these with app.getDevice().D0
					Need to put () around the whole thing
					AND and OR need to be replaced with ) && (
					
					*/
					condition = "(" + condition + ")";
					// make all == into =, then make all = into ==
					condition = condition.replace(/==/g, "=");
					condition = condition.replace(/=/g, "==");
					condition = condition.replace(/and/gi, ") && (");
					condition = condition.replace(/or/gi, ") || (");
					condition = condition.replace(/([AD]\d)/g, "app.getDevice().$1");

					//			var statement = "if "+condition+"{app.logo('"+body+"')}";
					// Set a temp variable to hold the outcome of condition
					app._logoHandleIfsBool = false;
					var statement = "if " + condition + "{app._logoHandleIfsBool = true}";
					// evaluate the condition
					eval(statement);

					if (app._logoHandleIfsBool) {
						// Might not need to getInfo
						if (noGetInfo) {
							app.logo(body, null, onSuccess, onFail);
						} else {
							app.getDevice().getInfo(function () {
								// onSuccess getInfo
								app.logo(body, null, onSuccess, onFail);
							});
						}
					}
				}, delay);
			} else {
				// If we get here, the if patterns did not match

				// There might be malformed if, so remove all if
				// and do logo

				str = str.replace(/if/g, "");
				str = str.replace(/\r?\n|\r/g, " ");
				return app.logo(str, null, onSuccess, onFail);
			}
		};

		app.logoHandleLables = function (str) {
			/* Format labels properly
				<name>:
			*/

			// add commas
			str = str.replace(/(\w+):/g, "LABEL,$1");

			return str;
		};

		app.logoHandleLoops = function (str) {
			// Removes LOOPs from the str and adds these to the logo loop
			// Returns the str without LOOP

			/* Looking for  $1 IF $2 
				$1 not part of the loop
				$2 is the body of the LOOP, 
					as well as the 'remainder'... anything after the closing bracket of the loop
			*/

			var rVal = str; // by default return the whole str

			str = app.logoStringFixes(str);

			// remove linebreaks
			str = str.replace(/\r?\n|\r/g, " ");

			var re = /(.*?)LOOP\s*(\[.*)/gi,
				output = [],
				match,
				parts,
				last;

			if ((match = re.exec(str))) {
				//  $1 is not part of the loop so it is sent back
				rVal = match[1];

				// from $2 get the body and the loop

				var startIndex = match[2].indexOf("[");
				var endIndex = app.indexofMatchingBracket(match[2]);

				// get the body (between the brackets), so add or subtract 1 to leave out []
				var body = match[2].substr(startIndex + 1, endIndex - 1);

				var remainder = "";
				// remainder is everything after endIndex
				if (str.length > endIndex) {
					// Execute the remainder now
					remainder = match[2].substr(endIndex + 1);
				}

				// add the body to the logoLoop code
				if (
					app._logoLoopSettings.hasOwnProperty("code") &&
					app._logoLoopSettings.code
				) {
					body = app._logoLoopSettings.code + " " + body;
				}

				// update the code in settings
				app._logoLoopSettings.code = body;

				// Handle case if the remainder has it's own LOOP
				remainder = app.logoHandleLoops(remainder);

				// Make sure the loop is started
				app.logoLoopStart();

				// Add remainder to return val
				rVal += " " + remainder;
			}

			// pass the remainder of params back
			return rVal;
		};

		app.logoHandleLoops2 = function (str) {
			// Removes LOOPs from the str and send to the logo loop
			// Returns the str without LOOP

			/* Looking for  $1 LOOP $2 
				$1 not part of the loop
				$2 is the body of the LOOP, 
					as well as the 'remainder'... anything after the closing bracket of the loop
			*/

			var rVal = str; // by default return the whole str

			str = app.logoStringFixes(str);

			// remove linebreaks
			str = str.replace(/\r?\n|\r/g, " ");

			var re = /(.*?)LOOP\s*(\[.*)/gi,
				output = [],
				match,
				parts,
				last;

			if ((match = re.exec(str))) {
				//  $1 is not part of the loop so it is sent back
				rVal = match[1];

				// from $2 get the body and the loop

				var startIndex = match[2].indexOf("[");
				var endIndex = app.indexofMatchingBracket(match[2]);

				// get the body (between the brackets), so add or subtract 1 to leave out []
				var body = match[2].substr(startIndex + 1, endIndex - 1);

				var remainder = "";
				// remainder is everything after endIndex
				if (str.length > endIndex) {
					// Execute the remainder now
					remainder = match[2].substr(endIndex + 1);
				}

				// Send the body to Loop
				app.logoLoop(body, {
					dontClearErrors: true,
				});

				// Handle case if the remainder has it's own LOOP
				remainder = app.logoHandleLoops2(remainder);

				// Add remainder to return val
				rVal += " " + remainder;
			}

			// pass the remainder of params back
			return rVal;
		};

		app.logoHandleMake = function (str) {
			/* Format MAKE properly
				MAKE :VAR <value> or <value_operator_value>
			*/

			// look for MAKE and a "<name>
			if (str.test(/MAKE +"[\w_]+/)) {
				// is there an operator?
				if (
					str.test(/MAKE +"[\w_]+ :*[a-zA-Z0-9]+ *[\+\-\*\/%] *:*[a-zA-Z0-9]+/)
				) {
					console.warn("******************** MAKE with multiple param");
					str = str.replace(
						/MAKE +"([\w_]+) (:*[a-zA-Z0-9]+) *([\+\-\*\/%]) *(:*[a-zA-Z0-9]+)/,
						"MAKE,$1,$2,$3,$4;"
					);
				} else if (str.test(/MAKE +"[\w_]+ :*[a-zA-Z0-9]+/)) {
					console.warn("******************** MAKE with single param");
					str = str.replace(/MAKE +"([\w_]+) (:*[a-zA-Z0-9]+)/, "MAKE,$1,$2;");
				}
			}

			return str;
		};

		app.logoHandleCommands = function (str) {
			// get into the format <cmd>,<value>;<cmd>,<value>;

			// CMD format is ;CMD \d;
			str = str.replace(
				/\b(A|D|SERVO|FD|BK|LT|RT|ARCFL|ARCFR|ARCBL|ARCBR|MAFD|MABK|MBFD|MBBK|STOP|WAIT|DELAY)(\d*) +(\d+)\b/g,
				";$1$2,$3;"
			);
			// Or variables
			str = str.replace(
				/\b(A|D|SERVO|FD|BK|LT|RT|ARCFL|ARCFR|ARCBL|ARCBR|MAFD|MABK|MBFD|MBBK|STOP|WAIT|DELAY)(\d*) +(:\w+)\b/g,
				";$1$2,$3;"
			);

			// IF format is ;IF when preceeded by spaces
			str = str.replace(/ +(IF|LOOP|MAKE|REPEAT|TO)/g, ";$1");

			return str;
		};

		app.logoHandleParameters = function (params) {
			for (var i = 100; i >= 0; i--) {
				// limit the check to n times
				// by this time, commands should already be replaced
				// any remaining spaces should be parameters
				params = params.replace(/(\w) ([:\w])/g, "$1,$2"); // separate parameters with a comma

				if (params.search(/\w [:\w]/) == -1) {
					// check if any still need fixing
					i = -1;
				}
			}

			return params;
		};

		app.logoHandleRepeat = function (str) {
			/* Format REPEAT properly
				REPEAT 5/:VAR1 []
			*/

			// Remove spaces either side of operators
			str = str.replace(/REPEAT *([:\w\d]+) *\[/g, "REPEAT,$1,[");
			str = str.replace(/\]/g, ";];");

			return str;
		};

		app.logoHandleServos = function (params, deviceId) {
			/*
			Set up any servose used in params
			*/

			var servoNum = 1;

			// Go through pin 0-9, looking for servo commands SERVO4 etc
			jQuery.each([0, 1, 2, 3, 4, 5, 6, 7, 8, 9], function (i, val) {
				var myRE = new RegExp("(servo" + i + ")", "ig");
				if (params.match(myRE)) {
					// If servo on this pin Attach the servo on this pin
					app.getDevice(deviceId).attachServos([servoNum, i]);
					servoNum++;

					// Use A4 instead of SERVO4
					params = params.replace(myRE, "A" + i);
				}
			});

			return params;
		};

		app.logoInjectFunctionsIntoFnCode = function (fns) {
			// If any of the functions have nested FNs, inject those Functions
			// Expecting an array of objects:
			/*
				[
					{
						"name": "name_of_function",
						"code": "FD RT etc "
					},
					...
				]
			*/

			jQuery.each(fns, function (i, val) {
				if (!fns[i].code) {
					fns[i].code = "";
				}

				fns[i].code = app.logoStringFixes(fns[i].code);

				fns[i].code = app.logoInjectFunctions(fns[i].code, fns);
			});

			return fns;
		};

		app.logoInjectFunctions = function (str, fns) {
			// Inject the functions into the str

			if (!str) {
				return "";
			}

			str = app.logoStringFixes(str);

			jQuery.each(fns, function (i, val) {
				str = app.logoInjectFunction(val.name, val.code, str);
			});

			str = str.replace(/\r?\n|\r/g, " ");
			return str;
		};

		app.logoInjectFunction = function (name, code, str) {
			// Replace all occurrences of name with code in the str
			// Also replace all :VARs

			str = app.logoStringFixes(str);

			//	Find the function with 9 optional vars which must be numbers
			var re = new RegExp(
				name +
					"([ ]+[0-9]+)?([ ]+[0-9]+)?([ ]+[0-9]+)?([ ]+[0-9]+)?([ ]+[0-9]+)?([ ]+[0-9]+)?([ ]+[0-9]+)?([ ]+[0-9]+)?([ ]+[0-9]+)?",
				""
			);
			var match, match2;

			// look for occurences of the function
			while ((match = re.exec(str))) {
				// The fn code
				if (code > "") {
					var thisCode = code;
					// Up to 9 vars, in the match array
					for (var v = 1; v <= 9; v++) {
						// If a parameter passed in for VAR1, replace :VAR1 with the value
						// or just replace with ''
						var varVal = "";
						if (match[v] && !Number.isNaN(match[v])) {
							varVal = match[v];
							// remove spaces from the value
							varVal = varVal.replace(/ /g, "");
						}

						var codeRE = new RegExp(":VAR" + v, "i");
						while ((match2 = codeRE.exec(thisCode))) {
							thisCode = thisCode.replace(codeRE, varVal);
						}
					}
				}
				// Now replace this match in the str
				var thisRE = new RegExp(match[0]);
				str = str.replace(thisRE, thisCode);
			}
			str = str.replace(/\r?\n|\r/g, " ");
			return str;
		};

		app.logoLoopStart = function (settings, onStartFn) {
			/*
			Start the logo loop
			Check every xx to see if it should run

			onStartFn  A function to run every time the loop starts
			*/

			if (onStartFn) {
				app._logoLoopOnStartFn = onStartFn;
			}

			app._logoLoopActive = true;
		};

		app.logoLoopStop = function () {
			/*
			Stop the logo loop
			*/

			app._logoLoopActive = false;
		};

		app.logoLoop = function (params, settings, onSuccess, onFail) {
			// send logo commands to the logo loop function

			var settings = settings || {};

			// add to queueNum 1;
			settings.queueNum = 1;

			return app.logo2(params, settings, onSuccess, onFail);
		};

		app.logoLoopOld = function (settings) {
			/*
			Run the logo loop code
			`settings` (optional) Object to define various settings:
			Default is app._logoLoopSettings
				{
					delay: x // Default: 1000, The number of milliseconds to wait after each callback. This allows the device not to become overloaded
					variable: 'x' // Default: 'logoCode', The name of the app variable that holds the code
					code: 'x' // Code to run. This is in addition to the variable code
				} 
			*/

			// Reset if a long delay has passed
			if (Date.now() > app._logoLoopLastRun + app._logoLoopDelay + 10000) {
				app._logoLoopLastRun = 0;
				app._logoLoopRunning = false;
			}

			// Exit if busy running
			if (app._logoLoopRunning) {
				return;
			}

			// Exit if minimum delay not passed
			if (Date.now() < app._logoLoopLastRun + app._logoLoopDelay) {
				return;
			}

			app._logoLoopLastRun = Date.now();
			app._logoLoopRunning = true;

			var varName = "loopCode";
			var allCode = "";

			try {
				if (settings.hasOwnProperty("delay") && !isNaN(settings.delay)) {
					app._logoLoopDelay = settings.delay;
				}
				if (
					settings.hasOwnProperty("variable") &&
					app.getVariable(settings.variable) > ""
				) {
					varName = settings.variable;
				}
				if (settings.hasOwnProperty("code") && settings.code > "") {
					allCode += " " + settings.code;
				}
			} catch (er) {}

			// Start with the form field code
			if (app.getVariable(varName) > "") {
				allCode = app.getVariable(varName) + allCode;
			}

			// call the onStartFn
			try {
				if (typeof app._logoLoopOnStartFn === "function") {
					app._logoLoopOnStartFn.call();
				}
			} catch (er) {
				console.warn("ERROR _logoLoopOnStartFn", er);
			}

			app.logo(
				allCode,
				null,
				function () {
					// onSuccess callback
					app._logoLoopRunning = false;
				},
				function () {
					// onFail callback
					app._logoLoopRunning = false;
				}
			);
		};

		app.logoSumWaits = function (str) {
			// Return the sum of all WAIT in str

			var rVal = 0;

			var re = /wait\s*(\d*)\s*/gi,
				match;

			while ((match = re.exec(str))) {
				if (!isNaN(parseInt(match[1]))) {
					rVal += parseInt(match[1]);
				}
			}
			return rVal;
		};

		// REPEAT
		app.logoInjectRepeats = function (str) {
			str = app.logoStringFixes(str);

			str = str.replace(/\r?\n|\r/g, " ");
			var re = /repeat\s*(\d*)\s*\[([^\[\]]*)\]/gi,
				output = [],
				match,
				parts,
				last;

			while ((match = re.exec(str))) {
				var repeatStr = "";
				var times = parseInt(match[1]);
				if (!(times > 0)) {
					times = 1;
				}
				if (match.length) {
					for (var i = 0; i < parseInt(match[1]); i++) {
						repeatStr += match[2] + " ";
					}
				}
				var match0 = match[0].replace(/\[/g, "\\[").replace(/\]/g, "\\]");
				var thisRE = new RegExp(match0, "i");
				str = str.replace(thisRE, repeatStr);
			}
			str = str.replace(/\r?\n|\r/g, " ");
			return str;
		};

		app.logoStringFixes = function (params) {
			var params = params || "";

			// Everything in UpperCase
			params = params.toUpperCase();

			// treat all brackets as square brackets
			params = params.replace(/[\(\{]/g, "[").replace(/[\)\}]/g, "]");

			// Make sure brackets have a space before and after (i.e. for the user, space are optional around brakcets)
			params = params.replace(/\]/g, " ] ").replace(/\[/g, " [ ");

			params = params.replace(/\n/g, ";"); // remnove line breaks
			params = params.replace(/\s+/g, " "); // remove double spaces

			return params;
		};

		app.indexofMatchingBracket = function (
			expression,
			index,
			bracket,
			closing
		) {
			// Function to return index of closing
			// bracket for given index of opening bracket (defaults to 0)

			var i;
			var bracket = bracket || "[";
			var closing = closing || "]";
			var index = index || expression.indexOf(bracket);

			// If index given is invalid and is
			// not an opening bracket.
			if (expression.charAt(index) != "[") {
				return -1;
			}

			// Stack to store opening brackets.
			var st = [];

			// Traverse through string starting from
			// given index.
			for (i = index; i < expression.length; i++) {
				// If current character is an
				// opening bracket push it in stack.
				if (expression.charAt(i) == "[") {
					st.push(expression.charAt(i));
				}
				// If current character is a closing
				// bracket, pop from stack. If stack
				// is empty, then this closing
				// bracket is required bracket.
				else if (expression.charAt(i) == "]") {
					st.pop();
					if (st.length == 0) {
						return i;
					}
				}
			}

			// If no matching closing bracket
			// is found.
		};

		app.loop = function () {
			// the `loop` function repeats continuously carrying out any user defined tasks
			// Optional: Add new functions to the loops by passing arguments to `loop`
			// arg[0] - function reference or an ad-hoc function, or a string of javascript
			// arg[1] - (optional) the interval for this function, e.g. 1000 will run it every second. Default 0 (will run as quickly as possible, limited by the app global loop setting)
			// arg [2...n] - arguments to the function arg[0]
			// e.g. `app.loop('app.setBackgroundColor',2000,'random')`
			// Returns the index number for this function, can be cancelled with app.cancelLoop(num)

			// If there are arguments, add the new function to the loop
			try {
				if (arguments.length) {
					var obj = {};
					obj.func = arguments[0];
					obj.lastCalled = 0;
					obj.interval = 0;

					// if an interval passed in, use it, or default to always
					if (arguments.length > 1) obj.interval = arguments[1];

					// if additional arguments, these will be the arguments to pass to the func
					obj.arguments = [];
					if (arguments.length > 2) {
						for (var i = 2; i < arguments.length; i++) {
							obj.arguments[i - 2] = arguments[i];
						}
					}

					// add this obj to the loop functions
					app._loopFunctions[app._loopFunctions.length] = obj;

					// if called with arguments then the setup now done for new func. so exit
					return app._loopFunctions.length - 1;
				}

				var now = Date.now();

				// call all the loop functions
				for (var i = 0; i < app._loopFunctions.length; i++) {
					if (
						!app._loopFunctions[i].cancelled &&
						(!app._loopFunctions[i].interval ||
							app._loopFunctions[i].lastCalled +
								app._loopFunctions[i].interval <
								now)
					) {
						app._loopFunctions[i].lastCalled = now;
						try {
							app._loopFunctions[i].func.apply(app._loopFunctions[i].arguments);
						} catch (er) {
							// if error, then possibly the value is a javascript string, not a function
							try {
								// Create a temporary function to eval the string
								var fn = function () {
									eval(app._loopFunctions[i].func);
								};
								// call/apply, but don't need arguments in this case
								fn.apply();
							} catch (er) {}
						}
					}
				}
			} catch (er) {
				console.log("ERROR in app.loop", er);
			}

			setTimeout(app.loop, app._loopTimeout);
		};

		app.markPinVariablesAsInputs = function () {
			// Find fields matching the IoT Device pin naming convention and mark them as input fields

			// go through all form items
			jQuery(app._formItemsCSSSelector).each(function (index) {
				var variable = jQuery(this).attr("name");

				/* 		if (variable && variable > "") {
					// look for field names like pinD3 or pinA0
					if (variable.match(/^pin[AD]\d+$/)) {
						var format = 'd';
						if (variable.match(/pinA/)) {
							format = 'a';
						}

						var pinNumber = variable.replace(/^pin[AD]/, '');

						// Add to the object that holds these
						app._pinVariables[variable] = {
							'format': format,
							'pinNumber': pinNumber,
							'property': property
						}
					}
				} */

				if (variable && variable > "") {
					var format = "";

					// look for field names like pinD3 or pinA0
					if (variable.match(/^pinD\d+$/i)) {
						var format = "d";
					}
					if (variable.match(/^pinA\d+$/i)) {
						format = "a";
					}
					if (variable.match(/^pinDHT\d+/i)) {
						format = "dht";
					}

					if (format > "") {
						//var pinNumber = variable.replace(/^pin[ADHT]+/, '');
						var pinNumber = variable.replace(/^pin[ADHT]+(\d)+.*/i, "$1");
						// DHT has properties like .TEMP or .HUM
						var prop = "";
						if (variable.test(/\./)) {
							prop = variable.replace(/^.*?\.(.+)/i, "$1").toLowerCase();
						}
						// standardise properties (allowing for different names by users)
						switch (prop) {
							case "temp":
								prop = "temperature";
								break;
							case "hum":
							case "humidity":
								prop = "relative_humidity";
								break;
							default:
								break;
						}
						// Add to the object that holds these
						app._pinVariables[variable] = {
							format: format,
							pinNumber: pinNumber,
							property: prop,
						};
					}
				}
			});
		};








		/*
			Create Mautic DWC and Focus Items Mautic Config

		*/

		app.mtConfigVars = {}; // store the GTM vars here

		app.mtGetConfig = function () {
			try {
				jQuery
					.ajax({
						url: "//appshed.com/json/111-mtconfig",
					})
					.done(function (a, b, c) {
						var j = jQuery(jQuery.parseHTML(a)).find(
							"article.uk-article>div>p"
						);
						if (j.length) {
							try {
								var conf = JSON.parse(j.text());

								if (typeof conf === "object") {
									var keys = Object.keys(conf);
									for (var k = 0; k < keys.length; k++) {
										app.mtGetVariable(keys[k], conf[keys[k]]);
									}
								}
							} catch (error) {
								console.error("JSON parse", error, this);
							}
						}
					});
			} catch (error) {
				console.error("mtGetConfig", error);
			}
		};

		/*
			mtGetVariable
			vName - name of the variable
			options: { 
			"dwc": true, // is this a DWC trigger
			"slot": "", // name of the DWC slot

			"focusItem": true, // is this a Focus Item

			// choose one of these: appendTo || prependTo || before || after
			"before": "", // optional selector where to place before
			"after": "", // optional selector where to place after
			"appendTo": "" // optional selector where to append, default "body"
			"prependTo": "" // optional selector. Default reverts to prependTo "body"

			// RegExp tests
			"testPathname": "reg-expression", // will only process if the location.pathname matches
			"testNotPathname": "reg-expression", // pathname must NOT match
			
			"delay": 0, // optional, how long to wait before creating the DWC, default 0
			"cta": { // Call to action settings
				"selector": "", // the selector for the cta
				"type": "autologin", // action types: autologin, ...
			}
			}

			DWC
			If a DWC is created it can be refreshed by include a div with this attribute:
			<div data-mt-refresh="dd0"...>  NB the refresh must contain a 0, e.g. 10, 1000 etc


			Return values
			0 - pending, not processed (probably DOM not ready)
			1 - processed
			2 - skipped, already processed
			-1 - error
			-2 - skipped, pathname not matched
			-3 - skipped, NotPathname DID match

		*/

		app.mtGetVariable = function (vName, options) {
			return;
			/*

			// DEPRECATED, replaced by gtmGetVariable
			try {
				

				
				var options = options || {};

				
				// ignore if regexp tests fail
				if(options.hasOwnProperty('testPathname')){
					var re = new RegExp(options.testPathname);
					if(!re.test(window.location.pathname)){
						return -2;
					}
				}
				
				if(options.hasOwnProperty('testNotPathname')){
					var re = new RegExp(options.testNotPathname);
					if(re.test(window.location.pathname)){ 
						return -3;
					}
				}


				// ignore if we have done this var
				if(app.mtConfigVars.hasOwnProperty(vName)){
					return 2;
				}

				
				
				if(options.dwc && options.slot){
					// is there a delay
					
					setTimeout((function(vName,options){
						app._mtCreateDWC(vName,options);
					}).bind(this,vName,options),(options.delay || 0))

				} else if(options.focusItem && options.id){
					app.mtCreateFocusItem(vName,options);
				}

					[vName] = options;

				return 1; // processed

			} catch (error) {
				console.error('gtmGetVariable',error)	
				return 2;	
			}
			*/
		};

		/*
			Create Mautic DWC for a slot
			If it already exists, not recreated
			Params
				`options`
					{
						prependTo (jQuery selector or jQuery object)
						appendTo
						before
						after
						cta: call-to-action
						loader: show a loader
					}
		*/
		app._mtCreateDWC = function (slot, options) {
			try {
				// look for the slot - will have class "mt-dwc" and "slot-container"
				if (!jQuery(".mt-dwc." + slot + "-container").length) {
					// missing, so add the div
					var jEl = jQuery(
						'<div class="mt-dwc ' +
							slot +
							'-container"><div data-slot="dwc" data-param-slot-name="' +
							slot +
							'"></div></div>'
					);
					if (options.hasOwnProperty("prependTo")) {
						jEl.prependTo(options.prependTo);
					} else if (options.hasOwnProperty("appendTo")) {
						jEl.appendTo(options.appendTo);
					} else if (options.hasOwnProperty("before")) {
						jQuery(options.before).before(jEl);
					} else if (options.hasOwnProperty("after")) {
						jQuery(options.after).after(jEl);
					} else {
						jEl.appendTo("body");
					}

					// Add loader
					if (options.hasOwnProperty("loader") && options.loader) {
						jEl.prepend(
							'<div class="dwc-loader" style="height: 200px"><div style="position: absolute;left: 0px;right: 0;top: 20px;bottom: 50px;"><div style="width: 50%;height: 100%;margin: 90px auto;text-align: center;"><i class="icon-spinner icon-spin " style="     zoom: 2;     color: var(--gm-color-low); "></i><div class="deep-loader-text" style="margin-top: 30px; color: var(--gm-color-low);"></div></div></div></div>'
						);
					}

					// Add CTA
					if (options.cta && typeof options.cta === "object") {
						app.mtCreateCTA(slot, options);
					}
				}

				app._mtLoadDWC(slot);
			} catch (error) {
				console.error("mtCreateDWC", error);
			}
		};



		/*
			Create Mautic Focuse Item
			If it already exists, not recreated
		*/
		app.mtCreateFocusItem = function (options) {
			if (options && options.focusItem && options.id && !isNaN(options.id)) {
				jQuery.getScript(
					"https://content.appshed.com/focus/" + options.id + ".js"
				);
			}
		};

		/*
			app._mtDoMauticReplacements(slot);
			Replaces some special patterns in the DWC content
			Parameters
				`slot` - the slot to work on

			Patterns
				[[[ code ]]] stuff [[[ ]]]
					Creates a div around `stuff` with a click event that runs the `code`
		*/
        
		app._mtDoMauticReplacements = function (slot) {
			try {
				var jSlot = jQuery(
					'div[data-slot="dwc"][data-param-slot-name="' + slot + '"]'
				).first();

				if (jSlot.length) {
					// =====================================
					// Text substitutions {{ <code> }}
					// =====================================

					var re2 = new RegExp("{{.*?}}", "g");
					var counter = 0; // just as a safety net for rogue while statements

					while (jSlot.find(':contains("{{")').length && counter < 20) {
						counter++;

						jSlot
							.deepest(':contains("{{")')
							.filter(function () {
								//return re2.test(jQuery(this).html());
								return re2.test(this.innerText);
							})
							.each(function () {
								var j = jQuery(this);
								var el = this;
								var inner = this.innerHTML;

								// find all occurrences of the pattern
								var results = inner.match(re2);
								jQuery(results).each(function (i, val) {
									var code = val.replace(/[{}]/g, "");
									code = app.decodeHTML(code);
									var result = "";

									try {
										var fn = Function("return (" + code + ")");
										// set 'this' to the DOM element the code is contained in
										result = fn.call(el);
									} catch (error) {
										console.warn("ERROR _mtDoMauticReplacements substitution",slot,code,error);
										result =
											'<span class="mt-dwc-sub-err" style="display: none;">' +
											code +
											"</span>";
									}

									var st = inner.indexOf(val);
									var en = st + val.length;
									inner = inner.substring(0, st) + result + inner.substring(en);
								});

								// put the new inner text back
								this.innerHTML = inner;
							});
					}

					if (counter == 20) {
						console.warn("_mtDoMauticReplacements counter limit reached");
					}

					// =====================================
					// Click replacement  [[[ <code> ]]]
					// =====================================

					var re = new RegExp("\\[\\[\\[.*?\\]\\]\\]", "g");

					var counter = 0; // just as a safety net for rogue while statements

					while (jSlot.find(':contains("[[[")').length && counter < 20) {
						counter++;

						jSlot
							.deepest(':contains("[[[")')
							.filter(function () {
								return re.test(this.innerText);
							})
							.each(function () {
								var j = jQuery(this);
								var inner = this.innerHTML;

								// find all occurrences of the pattern
								var results = inner.match(re);
								jQuery(results).each(function (i, val) {
									var code = val.replace(/[\[\]]/g, "");
									code = app.decodeHTML(code);

									var st = inner.indexOf(val);
									var en = st + val.length;
									inner = inner.substring(0, st) + inner.substring(en);
									j.click(function () {
										try {
                                                // so code is probably a snippet not a function reference
                                                Function("el",`
                                                window.el = el;
                                                `+code)(this);
                                        } catch (error) {
                                            console.warn(
                                                "ERROR _mtDoMauticReplacements click",
                                                slot,
                                                error
                                            );                                                    
                                        }
									});
								});

								// put the new inner text back
								this.innerHTML = inner;
							});
					}

					if (counter == 20) {
						console.warn("_mtDoMauticReplacements counter limit reached");
					}
				}

				return true;
			} catch (er) {
				console.warn("ERROR app._mtDoMauticReplacements", slot, er);
			}
		};




		app._mtDoMauticReplacementsAll = function () {
			jQuery('div[data-slot="dwc"]').each(function () {
				app._mtDoMauticReplacements(jQuery(this).data("param-slot-name"));
			});
		};

		/*
			app._mtLoadDWC
			Loads the DWC Mautic content for a dynamic web content slot
			Parameters
				`slot` - mandatory, the slot that must be loaded
		*/
		
        app._mtLoadDWC = function(slot) {
            if (!slot || slot.length == 0) {
                return;
            }

            // find the slot
            var jSlot = jQuery('div[data-slot="dwc"][data-param-slot-name="' + slot + '"]').first();
            if (jSlot.length) {
                // disable all slots
                jQuery('div[data-slot="dwc"]').attr("data-slot", "dwc-disabled");
                jSlot.attr("data-slot", "dwc");

                // when the slot loads, do some replacements
                app._onMutation(jSlot[0], null, function() {
                    app._mtDoMauticReplacements(slot);

                    // brief delay before processing... because sometimes the dwc content doesn't get replaced, maybe a delay helps.
                    setTimeout(function() {
                        app._mtDoMauticReplacements(slot);

                        var j = jQuery(".mt-dwc." + slot + "-container");

                        // Refresh
                        j.find("[data-mt-refresh*='0']").each(function() {
                            var s = jQuery(this).data("mt-refresh");
                            if (s && !isNaN(s)) {
                                setTimeout(()=>{
                                    // trigger the DWC replace
                                    app._mtLoadDWC(slot);
                                }
                                , s);
                            }
                        });

                        // Hide the loader (if present)
                        jSlot.parent().find(".dwc-loader").hide();
                    }, 100);
                });

                var whenMauticReady = function(){
                    if(typeof MauticJS == 'object'){
                        app.clearInterval('whenMauticReadyInterval');

                        // load the mautic DWC content (only this slot is enabled)
                        MauticJS.replaceDynamicContent();

                        // do some replacements in the content
                        //app._mtDoMauticReplacements(slot);

                        // enable all other slots
                        jQuery('div[data-slot="dwc-disabled"]').attr("data-slot", "dwc");
                    }
                }

                // If Mautic not ready
                if(typeof MauticJS == 'undefined'){
                    app.setInterval(whenMauticReady,100,5000,'whenMauticReadyInterval');
                }else{
                    whenMauticReady();
                }

                return true;
            }
        };

		app._mtSendOnError = function () {};

		app._mtSendOnLoad = function () {};

		/*
			Creates Call To Action on the target
		*/
		app.mtCreateCTA = function (slot, options) {
			try {
			} catch (error) {
				console.error("createCTA", error);
			}
		};









		
		app.neoPixel = function (params, deviceId, callback) {
			// Sends `params` to `deviceId` to do NeoPixel routines
			// `params` is an object in the format:
			//	{
			//		routine: [101...199],	// the routine number
			//		s: [1...4],    			// Optional, the Strip number, default 1
			//		wait: int,				// Optional, the number of milliseconds to wait between changes, default 20
			//		duration: int,			// Optional, duration of the routine, default to 0 - ongoing
			//		color: "hex"/{rgb}		// Optional, color either hex string or rgb object
			//	}
			// Optional `deviceId` specifies the device, else `_deafultDevice` is used
			// Optional `callback` is called on completion
			// Returns `this`

			try {
				// construct the value string
				var val = "";
				var arr = [];

				// Defaults
				params.s = params.s || 1;
				params.wait = params.wait || 20;
				params.duration = params.duration || 0;

				if (params.routine == 102) {
					val = this.toRGBInt(params.color);
					arr = [params.routine, params.s, val, params.duration];
				}

				// expecting array of arrays e.g. [ [1,4,1,1000] , [1,4,0,0] ]
				// cmds,id,key,callback
				this.sendCommands([arr]);
			} catch (er) {
				app.handleError(er, "app.neoPixel()");
			}

			return this;
		};

		// called when the appbuilder tools panel loads
		app._onAppBuilderTools = function (type) {
			// check for javascript errors
			// app._showJavaScriptWarnings();  // deprecated after new CodeMirror editor

			// Add dblclick on the app name to open settings
			jQuery(".span-toolbox .app-name,.span-toolbox .app-description")
				.off()
				.on("click", function () {
					// only do this if on the tools_list screen
					if (app._popupContainerType == "appbuilder_tools_list") {
						jQuery(".span-toolbox .app-controls .icon-cogs").click();
					}
				});
			// and make text unselectable,
			jQuery(".span-toolbox .app-name,.span-toolbox .app-description").addClass(
				"disable-select hover-show-edit"
			);

			if (type == "map") {
				// disable Map Point except on Map screen
				jQuery('.toolbox a.item.icon[data-screentype="map list"]').show();
			} else if (type == "list") {

				// Make sure the initial no-app DWC is hidden (sometimes doesn't get removed if an app opened too quickly)
				jQuery('.mt-dwc.appbuilder-no-app-container').hide()

				// Add GTM MT DWC appbuilder-toolbox-top
				if (jQuery(".appbuilder-toolbox-top-container").length == 0) {
					jQuery(".toolbox .app-controls").after(
						'<div class="mt-dwc appbuilder-toolbox-top-container"><div data-slot="dwc" data-param-slot-name="appbuilder-toolbox-top"></div></div>'
					);

					// Every time the DWC loads do some chnages to it
					jQuery(".mt-dwc.appbuilder-toolbox-top-container").on(
						"DOMSubtreeModified",
						function () {
							// Remove the span inline style that MT automatically adds once it loads
							jQuery(event.target).find("span").attr("style", "");
							// if there is a refresh attribute, set a timeout
							jQuery(event.target)
								.find("[data-mt-refresh*='0']")
								.each(function () {
									setTimeout(() => {
										// trigger the DWC replace
										MauticJS.replaceDynamicContent();
									}, jQuery(this).data("mt-refresh"));
								});
							// if it has a mt-refresh (should have at least one 0 in the delay), set a timer
						}
					);

					// trigger the DWC replace
					if (typeof MauticJS === "undefined") {
						setTimeout(() => {
							// repeat the check
							if (typeof MauticJS === "undefined") {
								setTimeout(() => {
									MauticJS.replaceDynamicContent();
								}, 10000); // 10 seconds
							} else {
								MauticJS.replaceDynamicContent();
							}
						}, 2000);
					} else {
						MauticJS.replaceDynamicContent();
					}
				}
			} else {
				jQuery('.toolbox a.item.icon[data-screentype="map list"]').hide();
			}
			return this;
		};

		app.onItemClicked = function (e) {
			// Saves the `_currentItemId` when `Element` `e` is clicked.
			// Returns `this`

			if (e.target.classList.contains("item"))
				app._currentItemId = app.getIdFromDOMId(e.target.id);
			if (
				e.target.parentElement &&
				e.target.parentElement.classList.contains("item")
			)
				app._currentItemId = app.getIdFromDOMId(e.target.parentElement.id);
			if (
				e.target.parentElement &&
				e.target.parentElement.parentElement &&
				e.target.parentElement.parentElement.classList.contains("item")
			)
				app._currentItemId = app.getIdFromDOMId(
					e.target.parentElement.parentElement.id
				);

			app.ui.handlerContextMenuItemEdit();

			return app;
		};

		app._onLoadEditLocation = function () {
			// called when the edit location panel opens

			try {
				// hide the old Find button - tied to google search
				jQuery(".popup-embed .map form.input-append button").hide();

				// Add new find
				var jBtnFind = jQuery(
					'<div class="btn find_location"><i class="icon-find"></i> Find</div>'
				);
				jQuery(".popup-embed .map form.input-append").append(jBtnFind);
				jQuery(".popup-embed .map form.input-append").append(
					'<p style="font-size: 11px;"><em>Enter an address or paste a lat,long value.<br />e.g. 51.5014641593889, -0.14190073075232426</em></p>'
				);

				jQuery(".popup-embed .map form.input-append").before(
					'<div class="alert"><p>Attention: Free users (non-EDU):</p><p>The address search will open <a href="https://www.google.com/maps" target="_blank" style="color: blue; text-decoration: underline;">Google Maps</a>. Right click on the location to get the latitude and longitude.</p></div>'
				);

				// **************************************************************
				// Add new map - temporary
				// **************************************************************
				var oLat = 51.5256859;
				var oLon = -0.084638;
				var jLat = jQuery('.popup-embed .map input[name="item_location[0]"]');
				var jLon = jQuery('.popup-embed .map input[name="item_location[1]"]');

				var formLat = jLat.val();
				var formLon = jLon.val();
				if (formLat > "" && formLon > "") {
					oLat = formLat;
					oLon = formLon;
				}

				// hide current map
				jQuery(".popup-embed .map .mapper").hide();

				var jMap = jQuery(
					'<div class="edit_location_map" style="height: 250px; margin-top: 20px;">New Map</div>'
				);
				jQuery(".popup-embed .map form.input-append").after(jMap);

				app.edit_location_map = L.map(jMap.get(0), {
					center: [oLat, oLon],
					zoom: 13,
				});

				var myIcon = L.icon({
					iconUrl:
						"/components/com_appbuilder/libraries/leaflet/marker-icon.png",
					shadowUrl:
						"/components/com_appbuilder/libraries/leaflet/marker-shadow.png",
					iconSize: [25, 41],
					iconAnchor: [12, 41],
					popupAnchor: [1, -34],
					tooltipAnchor: [16, -28],
					shadowSize: [41, 41],
				});

				app.edit_location_map.setView([oLat, oLon], 13);
				L.tileLayer(
					"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
					{}
				).addTo(app.edit_location_map),
					app.edit_location_map.zoomControl.setPosition("topleft");

				var marker = L.marker([oLat, oLon], {
					draggable: "true",
					icon: myIcon,
				}).addTo(app.edit_location_map);

				marker.on("dragend", function (event) {
					var marker = event.target;
					var position = marker.getLatLng();
					marker.setLatLng(new L.LatLng(position.lat, position.lng), {
						draggable: "true",
					});
					app.edit_location_map.panTo(new L.LatLng(position.lat, position.lng));
					jQuery('.popup-embed .map input[name="item_location[0]"]').val(
						position.lat
					);
					jQuery('.popup-embed .map input[name="item_location[1]"]').val(
						position.lng
					);
					//				  app.edit_location_map.setView([position.lat,position.lng]);
				});

				// When lat/lon fields updated, move the marker
				jQuery(
					'.popup-embed .map input[name="item_location[0]"],.popup-embed .map input[name="item_location[1]"]'
				).change(function () {
					var lat = jQuery(
						'.popup-embed .map input[name="item_location[0]"]'
					).val();
					var lon = jQuery(
						'.popup-embed .map input[name="item_location[1]"]'
					).val();

					var ll = new L.LatLng(lat, lon);
					marker.setLatLng(ll, { draggable: "true" });
					app.edit_location_map.panTo(ll);
				});
				// **************************************************************

				jBtnFind.click(function () {
					var addr = jQuery(".popup-embed .map .map-address").val();

					if (addr && addr > "") {
						// If a lat,lon has been pasted into search, (e.g. from Google),  update the map
						if (addr.match(/\s*-*\d+\s*,\s*-*\d+\s*/)) {
							var arr = addr.split(",");
							jQuery('.popup-embed .map input[name="item_location[0]"]').val(
								arr[0]
							);
							jQuery('.popup-embed .map input[name="item_location[1]"]').val(
								arr[1]
							);

							// move the marker
							var ll = new L.LatLng(arr[0], arr[1]);
							marker.setLatLng(ll, { draggable: "true" });
							app.edit_location_map.panTo(ll);

							return;
						}

						// Free users go to Google maps
						if (!app.isEDUUser) {
							window.open("https://maps.google.com/maps?q=" + addr);
							return;
						} else {
							// Final option, use LocationIQ
							jQuery
								.ajax({
									url:
										"https://eu1.locationiq.com/v1/search.php?key=pk.8541be163829a750c7c4f2de18d424b4&q=" +
										addr +
										"&format=json",
								})
								.done(function (data) {
									if (data.length) {
										jQuery(
											'.popup-embed .map input[name="item_location[0]"]'
										).val(data[0].lat);
										jQuery(
											'.popup-embed .map input[name="item_location[1]"]'
										).val(data[0].lon);

										marker.setLatLng(new L.LatLng(data[0].lat, data[0].lon));
										app.edit_location_map.panTo(
											new L.LatLng(data[0].lat, data[0].lon)
										);
									} else {
										// no results, try Google Maps
										window.open("https://maps.google.com/maps?q=" + addr);
									}
								})
								.fail(function () {
									// no results, try Google Maps
									window.open("https://maps.google.com/maps?q=" + addr);
								});
						}
					}
				});
			} catch (er) {
				console.warn("app._onLoadEditLocation", er);
			}
		};

		app._onLoadEditItemActionPrepareBlockly = function () {
			// remove all iFrames
			jQuery("#action-target iframe").each(function () {
				// destroy the old iframe so it doesn't load some junk
				// This messes up the text padding inside Blockly for some reason
				this.remove();
			});

            // Expand and Shrink (same button) needs extra stuff
            jQuery('.mobileeditor .span-toolbox button.expand').click((e)=>{
                // if text is Shrink, then we are in expanded view
                if(e.target.innerText.indexOf('Shrink')>= 0){
                    jQuery('body').addClass('blocklyexpanded');
                }else{
                    jQuery('body').removeClass('blocklyexpanded');
                }
            })

			// the original iframe src includes a blocklyId stored on the parent div
			var origSrc =
				"/index.php?option=com_appbuilder&controller=blockly&blockly=5&blocklyType=action&blocklyId=";
			origSrc += jQuery('#action-target div[data-blockly-type="action"]').attr(
				"data-blockly-id"
			);

			// The XML containing the app variables is in the old src
			jQuery.get(origSrc).done(function (a, b, c) {
				// get the XML element from the response data
				var oldXML = jQuery(a)[3];
				// some styles
				app.addStyles(" #edit_action iframe { height: 710px; }");
				// create new iframe

				// first remove NEW Blockly if already present
				if (jQuery("#blockly_editor").length) {
					jQuery("#blockly_editor").remove();
				}
				jiWin = jQuery("<iframe>", {
					src: "/includes/blockly/blockly_editor.html",
					id: "blockly_editor",
					frameborder: 0,
					scrolling: "no",
				});

				// add the iframe to the DOM
				// then wait for the new iframe to load
				// jiWin.appendTo(jQuery('#edit_action iframe#blockly_editor_old').parent()).on('load',function(){
				jiWin
					.insertAfter(
						jQuery('#action-target div[data-blockly-type="action"]>button')
					)
					.on("load", function () {
						// onload

						// rebuild the toolbox using variables
						// get variables from old iframe and add to the new xml
						var xmlDoc = jQuery("#edit_action iframe#blockly_editor")
							.contents()
							.find("xml")[0];
						//jQuery('#edit_action iframe#blockly_editor_old').contents().find('xml category[name="App Variables"]>block').each(function(i,val){
						jQuery(oldXML)
							.find('category[name="App Variables"]>block')
							.each(function (i, val) {
								jQuery(xmlDoc)
									.find('category[name="App Variables"]')[0]
									.appendChild(this);
							});

						// rebuild teh toolbox using the updated XML
						jQuery("#edit_action iframe#blockly_editor")[0].contentWindow.Blockly.getMainWorkspace().updateToolbox(xmlDoc);

						// set up the text Editor and event hadnlers
						jQuery("[data-blockly]").each(function (container) {
							var that = this;
							var iWin = jQuery("#blockly_editor")[0].contentWindow;
							var blocklyId = iWin.id;
							var Blockly = iWin.Blockly;

                            // This is a hack workaround... mainWorkspace is deprecated in Blockly 10, but old functions.js still uses it.
                            Blockly.mainWorkspace = Blockly.getMainWorkspace()

							output = jQuery("[name=blocky_output]")[0];

							// Add the CodeMirror editor to the textarea
							app._initializeCodeEditor(output, {
								mode: output.get("data-editor-type"),
								readOnly: output.get("readonly"),
								gutters: [],
								lineNumbers: false,
								lint: false,
							});

							function showCode() {
								Blockly.JavaScript.addReservedWords("code");
								var code = Blockly.JavaScript.workspaceToCode(
									Blockly.getMainWorkspace()
								);
								var editor = output.retrieve("editor");
								if (editor) {
									editor.getDoc().setValue(code);
								} else {
									output.set("value", code);
								}
							}

							var xml_text = jQuery("[data-blockly]").attr("data-blockly");
							if (xml_text) {
								try {
									//var xml = Blockly.Xml.textToDom(xml_text);
									var xml = Blockly.utils.xml.textToDom(xml_text);
                                    
									Blockly.Xml.domToWorkspace(xml, Blockly.getMainWorkspace());
								} catch (e) {
									console.error(
										"Function execution appshedBlocklyReady" + blocklyId,
										e
									);
								}
							}

							Blockly.getMainWorkspace().addChangeListener(showCode),
								setTimeout(showCode, 500),
								setTimeout(showCode, 1500),
								that.store("blockly", Blockly);
						});
					});
			});
		};

		app._onLoadEditItemAction = function () {
			// Remove various elements that were added manually
			// If using Change Action, then we could get a messed up UI if we don't clean up here
			jQuery("button.action_js_invert-color").remove();
			jQuery("button.action_js_shrink").remove();
			jQuery("button.action_js_expand").remove();

			// When Change Action used, need to scroll up
			document.body.scrollTop = document.documentElement.scrollTop = 0;

			// If Blockly present
			if (app._onLoadEditPanelHasBlockly()) {
				app._onLoadEditItemActionPrepareBlockly();
			}

			// If Javascript present
			if (jQuery(".form-horizontal .control-label[for=action_js]").length) {
				var parent = jQuery(".form-horizontal .control-label[for=action_js]")
					.parent()
					.parent();

				// make some style changes to the JavaScript editor
				parent.find(".controls.textarea").css("margin-left", 0);

				var buttonDiv = jQuery('<div class="editor-btns"></div>');
				parent.before(buttonDiv);

				// Add color invert link
				if (jQuery(".action_js_invert-color").length == 0) {
					var colorSwitcher = jQuery(
						'<button class="btn expand no-float action_js_invert-color" type="button"><i class="icon-appshed-publish-requests"></i> Invert Colors</button>'
					).click(function () {
						// toggle invert
						if (
							jQuery(".controls.textarea .CodeMirror").css("filter").match(/1/)
						) {
							jQuery(".controls.textarea .CodeMirror").css(
								"filter",
								"invert(0)"
							);
						} else {
							jQuery(".controls.textarea .CodeMirror").css(
								"filter",
								"invert(1)"
							);
						}
					});

					buttonDiv.append(colorSwitcher);
				}

				// Add Shrink button
				if (jQuery(".action_js_expand").length == 0) {
					var el = jQuery(
						' <button class="btn expand no-float action_js_shrink" type="button"><i class="icon-resize-small"></i> Shrink</button>'
					)
						.css("display", "none")
						.click(function () {
							jQuery(".action_js_shrink").hide();
							jQuery(".action_js_expand").show();
						});

					buttonDiv.append(el);
				}

				// Add Expand button
				if (jQuery(".action_js_expand").length == 0) {
					var el = jQuery(
						' <button class="btn expand no-float action_js_expand" type="button"><i class="icon-resize-full"></i> Expand</button>'
					).click(function () {
						jQuery("body>.container>.row").addClass("toolbox-only");
						jQuery(".CodeMirror").css("height", 600);
						jQuery(".action_js_shrink").show();
						jQuery(".action_js_expand").hide();
						jQuery("#cloned-el").hide();
					});
					buttonDiv.append(el);
				}

				// Action for shrink -
				// The edit buttons must also Shrink
				jQuery(
					".action_js_shrink, .span-toolbox .edit-btns button, .span-toolbox #edit_action_trigger"
				).click(function () {
					jQuery("body>.container>.row").removeClass("toolbox-only");
					jQuery(".CodeMirror").css("height", 300);
				});

				/*

				DEPRECATED
				With the new CodeMirror inline error messages, don't need to use _getJSLintMessages


				// Add warning icon if JavaScript error	
				var item = app.getItem(app._currentItemId);
				var code = item.getActionJavaScript();						
				var msg = app._getJSLintMessages(code);

				if(msg>''){
					// make it yellow...  jQuery('.span-toolbox .popup-loaded .nav-tabs a[data-target="edit_action"]').css('background-color','yellow');

						
					// add css class to the item matching the warning
					//item.jQuery.addClass('warnings').addClass('warning0'); // warning0 is for javascript

					// make sure the tab has a warnings container (do this only once for each item)
					var jTabAction = jQuery('.span-toolbox .popup-loaded .nav-tabs a[data-target="edit_action"]');

					if (jTabAction.find('.warnings-container').length == 0) {
						jTabAction.prepend('<div class="warnings-container" style="float: right;"><img class="warnings-image" src="https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/warningsgif.gif	" width="20" height="18"><div class="warnings-msgs"></div></div>');
					}
				}
				
				*/

				// re-initiate the CodeMirror editor (to enable settings like lint)
				app._initializeCodeEditor(document.getElementById("action_js"), {
					mode: document.getElementById("action_js").get("data-editor-type"),
					readOnly: document.getElementById("action_js").get("readonly"),
				});

				/*
				// Add the JavaScript Debugging container if not present
				if(jQuery('.popup-loaded .tab-pane:contains(Custom Javascript) .warnings-messages-container.javascript').length==0){
					jQuery('.popup-loaded .tab-pane:contains(Custom Javascript) .editor-btns').after(jQuery('<div class="warnings-messages-container javascript"><div class="title">JavaScript Debugging</div><div class="warnings-msgs default">Debugging messages will appear here if the code has any errors.</div><div class="warnings-msgs log"></div></div>'))

					app.addStyles('.warnings-messages-container {     background-color: #d1d1d1;     margin: 20px 0px;     border-radius: 10px;     border: 1px solid #c0c0c0; } .warnings-messages-container .title {     background-color: #404040;     border-radius: 10px 10px 0px 0px;     color: white;     padding-left: 15px;     font-size: 10px; } .warnings-messages-container .warnings-msgs {     font-size: 13px;     font-family: monospace;     font-style: italic;     padding: 15px;  max-height: 200px; 	overflow-y: scroll;} .warnings-messages-container address{margin-bottom: 0px; margin-top: 0px} .lint-warning{margin-bottom: 5px;} ');
					
				}

				if(msg.length){
					jQuery('.popup-loaded .warnings-messages-container.javascript .warnings-msgs.default').hide()
					jQuery('.popup-loaded .warnings-messages-container.javascript .warnings-msgs.log').show()
					jQuery('.popup-loaded .warnings-messages-container.javascript .warnings-msgs.log').html(msg);
				}else{
					jQuery('.popup-loaded .warnings-messages-container.javascript .warnings-msgs.default').show()
					jQuery('.popup-loaded .warnings-messages-container.javascript .warnings-msgs.log').hide()
				}
				*/
			}
		};

		
		app._onLoadEditPanel = function () {
			// called every time the edit panel is loaded (for AppBuilder and Game Maler)

			// add class record-id to the ID div
			if (
				jQuery(
					'.span-toolbox .popup-loaded #edit_item .control-group p.help-block:contains("ID:"), .span-toolbox .popup-loaded #edit_screen .control-group  p.help-block:contains("ID:")'
				).length
			) {
				jQuery(
					'.span-toolbox .popup-loaded #edit_item .control-group p.help-block:contains("ID:"), .span-toolbox .popup-loaded #edit_screen .control-group  p.help-block:contains("ID:")'
				)
					.parent()
					.parent()
					.addClass("record-id");
			}

			// Change the Help tab to Options
			if (
				jQuery(
					'.span-toolbox .popup-loaded .nav-tabs a[data-target="edit_help"]:contains("Help")'
				).length
			) {
				jQuery(
					'.span-toolbox .popup-loaded .nav-tabs a[data-target="edit_help"]:contains("Help")'
				).html(
					jQuery(
						'.span-toolbox .popup-loaded .nav-tabs a[data-target="edit_help"]:contains("Help")'
					)
						.html()
						.replace(/Help/, "Options")
				);
			}



            // in MobileEditor 
            if(jQuery('body').hasClass('mobileeditor')){
                // hide app-description-box 
                jQuery('.mobileeditor .span-toolbox .app-description-box').addClass('hidden');

                // Show the toolbox 
                jQuery(".span-toolbox").addClass("mobileeditor-show");
				jQuery(".span-toolbox").css("display","block");

                // when clicking edit buttons
                jQuery(".mobileeditor #popup-container .edit-btns button").click((e)=>{
                    // show app description again 
                    jQuery('.mobileeditor .span-toolbox .app-description-box').removeClass('hidden');
                    // hide toolbox
                    jQuery(".span-toolbox").removeClass("mobileeditor-show");
					jQuery(".span-toolbox").css("display","none");
                });
                

            }
		};

		/*
		_onLoadEditPanelConfigOptions
		Add various config options based on the Item Type
		*/
		app._onLoadEditPanelConfigOptions = function () {
			var item = this.getItem();

			if (app._popupContainerType == "edit_item_help") {
				if (item.isFormItemType()) {
					// Add cloud-variable checkbox if not present
					app._onLoadEditPanelConfigOptionsAdd({
						className: "option-cloud-variable",
						label: "Is Cloud Variable",
						helpText:
							"Select this option if this is a cloud variable. Cloud variables are stored online in the cloud, and are updated in real-time with other users of this app.",
					});

					// Add hidden checkbox if not present
					app._onLoadEditPanelConfigOptionsAdd({
						className: "hidden-live",
						label: "Hidden",
						helpText:
							"Hide this item.<br>The item will still be visible in AppBuilder (editor) but hidden in the published app.",
					});
				}
			}
		};

		app._onLoadEditPanelConfigOptionsAdd = function (options) {
			if (
				jQuery(
					".span-toolbox .popup-loaded #edit_help.tab-pane .control-group.option-" +
						options.className
				).length == 0
			) {
				// Find the help panel
				if (jQuery(".span-toolbox .popup-loaded #edit_help.tab-pane").length) {
					// add the Cloud checkbox
					var el = jQuery(
						'<div class="control-group option-' +
							options.className +
							'"><label for="option_' +
							options.className +
							'" class="control-label ">' +
							options.label +
							'</label><div class="controls checkbox"><input type="checkbox" name="option-' +
							options.className +
							'" id="option-' +
							options.className +
							'" value="" ' +
							(jQuery("#style_costumclases")
								.val()
								.search(new RegExp(options.className)) >= 0
								? "checked"
								: "") +
							' ><div class="help-block">' +
							options.helpText +
							"</div></div></div>"
					);
					jQuery(".span-toolbox .popup-loaded #edit_help.tab-pane ").prepend(
						el
					);
					jQuery("#option-" + options.className).click(function () {
						if (this.checked) {
							app._addCustomClass(options.className);
						} else {
							app._removeCustomClass(options.className);
						}
					});
				}
			}
		};

		app._onLoadEditPanelHasBlockly = function () {
			// returns true if the edit panel has a Blockly editor

			// current check just looks for an iframe.. .might need to be improved in future
			return jQuery("#action-target iframe").length > 0;
		};

		/*
		_onLoadEditPanelShowMessages
		Show any messages at the top of the Edit panel
		*/
		app._onLoadEditPanelShowMessages = function () {
			if (
				jQuery(
					".popup-loaded .tab-content .tab-pane#edit_item .warnings-container"
				).length == 0
			) {
				var str = "";
				// Look for messages for this item
				app._log.forEach(function (e) {
					if (e.itemIds && e.itemIds.length) {
						e.itemIds.forEach(function (id) {
							// If one of the itemIds is the current item
							if (id == app._currentItemId) {
								// append the message
								str += "<span>" + e.msg + "</span><br />";
							}
						});
					}
				});

				if (str.length) {
					var el = jQuery(
						'<div class="warnings-container"><img class="warnings-image" src="https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/warningsgif.gif	" width="20" height="18"><div class="warnings-msgs" style="display: inline;margin-left: 10px;">There are errors with this item.<br><br>' +
							str +
							"</div></div>"
					);

					el.prependTo(".popup-loaded .tab-content .tab-pane#edit_item");
				}
			}
		};





		/*
			app._onceMutation
			Calls _onMutation once only then disconnects
		*/
		app._onceMutation = function (el, options, callback) {
			var options = options || {};
			options.once = true;
			return app._onMutation(el, options, callback);
		};



		        /*
            Called when an iframe element onload event occurs
            E.g. Resourcepanel iframes call this function when loaded
                "this" is the element that triggered the event
                e: the event object
				options:
					observer: (default: true) Boolean, whether to create a mutation observer for the contents.	
        */
		app._onLoadiFrameCallback = function(e,options){
			// "this" should be the element that triggered the event

			var jEl = jQuery(this);

			// create a unique id for this element
			var id = (jEl.attr("id").length) ? jEl.attr("id") : String(this).replace(/[^a-zA-z]*/,'').substring(0,100);
			


			
			// after a page load, set pending to false
			app._DOMSubtreeModifiediFramesPending[id] = false;


			// this might throw an error
			try {

				// force the first call to detect initial page
				app.doDOMSubtreeModifiediFrame(jEl[0],id)


				if(options && options.hasOwnProperty("observer") && options.observer === false){

					// dno't create observer
				}else{

					//  create mutation observer (after every page load)
					var observer = new MutationObserver(mCallback); // used to use DOMSubtreeModified

					var options = {
						childList: true,
						attributes: true,
						characterData: false,
						subtree: true,
					};

					function mCallback(mutations,observer) {

						// only process if the function is not pending
						if (!app._DOMSubtreeModifiediFramesPending[id]) {
							app._DOMSubtreeModifiediFramesPending[id] = true;

							setTimeout(() => {
								app._DOMSubtreeModifiediFramesPending[id] = false;
								app.doDOMSubtreeModifiediFrame(jEl[0],id,mutations);
							}, app._DOMSubtreeModifiedInterval);
						}
					}

					observer.observe(jEl[0].contentDocument.body, options);

			
				}

			} catch (error) {
				console.error('_onLoadiFrameCallback',error)
			}
		} 



		/*
			app._onMutation
			Observes changes to a DOM element and runs a callback when the change happens
			similar to DOMSubtreeModified
			can call on or once methods
		*/
		app._onMutation = function (el, options, callback) {
			var options = options || {};
			var observer = new MutationObserver(mCallback);
			function mCallback(mutations) {
				if (callback) {
					callback.call();
				}
				if (options.hasOwnProperty("once") && options.once) {
					observer.disconnect();
				}
			}
			observer.observe(el, {
				childList: true,
				attributes: true,
				characterData: false,
				subtree: true,
			});
		};

		app.onReady = function (fn, params) {
			// Will call function `fn` when the app is ready
			// (optional) `params` is an array of parameters that will be passed to `fn` when calling/apply
			// This method can be called multiple times to add multiple functions to the `ready` event
			// Returns `this`

			if (fn) {
				app._readyFunctions.push(fn);
				var p = params || [];
				app._readyFunctionsParams.push(p);
			}

			// if the app is ready, call it now
			if (app.ready) {
				fn.apply(this, params);
			}

			return this;
		};

		app.openAcademyBrowse = function (callback) {
			jQuery("body").append(
				'<div class="popup-underlay academy-browse" style="z-index: 101; opacity: 0.5;"></div>       <div class="popup-window upload-picker academy-browse" style="z-index: 102; opacity: 1; visibility: visible; left: 352px;"><div class="popup-loaded"><form>      <div class="navbar" style="margin-bottom: 0px;">          <div class="navbar-inner">              <div class="container">                  <span class="brand">Courses</span>                  <a href="#" data-popup="hidecourses" title="Close" class="btn pull-right"><i class="icon-remove"></i> Close</a>                                </div>          </div>      </div>      <div class="popup-content  upload-picker">          <div class="row-fluid">              <iframe id="courses_frame" src="https://appshed.com/courses" style="position: absolute; z-index: 103; width: 100%; height: 90%; border-width: 0px">       </iframe>          </div>      </div>  </form></div></div>'
			);

			jQuery('.popup-window .btn[data-popup="hidecourses"]').click(function () {
				jQuery(".popup-underlay.academy-browse").remove();
				jQuery(".popup-window.academy-browse").remove();
			});
		};

		app.openAcademyCategories = function (callback) {
			app.openAcademyPanel();
			app.showAcademyLoader();

			// must have .academy-categories but NOT .category or .unit
			if (
				jQuery("#academy .academy-categories").length &&
				!jQuery("#academy .academy-categories.category").length &&
				!jQuery("#academy .academy-categories.unit").length
			) {
				app.hideAcademyLoader();

				if (callback) {
					callback.call();
				}
				return;
			} else {
				app.openAcademyHome(() => {
					app.openAcademyPath(
						["#academy a:contains('Course Categories')"],
						null,
						callback
					);
				});
			}
		};

		app.openAcademyCategory = function (categoryName, callback) {
			// Just for safety, close the Loader after a while
			setTimeout(function () {
				app.hideAcademyLoader();
			}, 6000);

			app.openAcademyPanel();
			app.showAcademyLoader();

			// must have .academy-categories and .category and categoryName active
			if (
				jQuery(
					'#academy .academy-categories.category .breadcrumb li.active:contains("' +
						categoryName +
						'")'
				).length
			) {
				app.hideAcademyLoader();

				if (callback) {
					callback.call();
				}
				return;
			} else {
				app.openAcademyHome(() => {
					app.openAcademyCategories(() => {
						return app.openAcademyPath(
							["#academy a.item:contains('" + categoryName + "')"],
							null,
							callback
						);
					});
				});
			}
		};

		app.openAcademyCourse = function (categoryName, courseName, callback) {
			// this Opens a course in AppShed Academy.

			// Just for safety, close the Loader after a while
			setTimeout(function () {
				app.hideAcademyLoader();
			}, 5000);

			// close the course browser app.closeacademybrowse();

			app.openAcademyPanel();
			app.showAcademyLoader();

			// must have .academy-categories and .category
			if (
				jQuery(
					'#academy .academy-categories.unit .breadcrumb li:contains("' +
						categoryName +
						'")'
				).length &&
				jQuery(
					'#academy .academy-categories.unit .breadcrumb li.active:contains("' +
						courseName +
						'")'
				).length
			) {
				setTimeout(app.hideAcademyLoader, 500);

				if (callback) {
					callback.call();
				}
				return;
			} else {
				app.openAcademyHome(() => {
					app.openAcademyCategories(() => {
						app.openAcademyCategory(categoryName, () => {
							return app.openAcademyPath(
								["#academy a.item:contains('" + courseName + "')"],
								null,
								callback
							);
						});
					});
				});
			}
		};

		app.openAcademyHome = function (callback) {
			// Just for safety, close the Loader after a while
			setTimeout(function () {
				app.hideAcademyLoader();
			}, 7000);

			app.openAcademyPanel();
			app.showAcademyLoader();

			// repeatedly check
			app.setInterval(
				function () {
					// If we are on Home, do callback
					if (jQuery("#academy .academy-intro").length) {
						app.clearInterval("handler_openAcademyHome");
						//app.hideAcademyLoader();
						if (callback) {
							callback.call();
						}
						return;
					} else if (jQuery("#academy .breadcrumb a:contains('Home')").length) {
						jQuery("#academy .breadcrumb a:contains('Home')").get(0).click();
					}
				},
				300,
				5000,
				"handler_openAcademyHome"
			);
		};

		app.openAcademyLink = function (category, course, callback) {
			app.openAcademyPanel();
			app.showAcademyLoader();

			setTimeout(function () {
				// Open AppShed Academy to a category, course, or just hom
				if (category) {
					if (course) {
						app.openAcademyCourse(category, course, callback);
					} else {
						app.openAcademyCategory(category, callback);
					}
				} else {
					// Open the home
					app.openAcademyHome(callback);
				}
			}, 1000);
		};

		app.openAcademyPanel = function (callback) {
			// first check if Academy is closed, and open it
			if (jQuery("#academy .button.arrow-up").length) {
				jQuery("#academy .button.arrow-up").click();
				app.hideAcademyLoader();

				if (callback) {
					setTimeout(() => {
						callback.call();
					}, 1000);
				}
			} else {
				//It's open already
				app.hideAcademyLoader();

				if (callback) {
					callback.call();
				}
			}
		};

		app.openAcademyPath = function (path, repeat, callback) {
			// if this method is called recursively, repeat will be true

			// Just for safety, close the Loader after a while
			setTimeout(function () {
				app.hideAcademyLoader();
			}, 5000);

			app.showAcademyLoader();

			var delayTimeout = 100;
			var giveUpTime = 2000;
			var runTime = Date.now();

			// set a global time variable
			if (!repeat) {
				window._as_navigateAcademyStart = runTime;
			}

			app.openAcademyPanel();
			app.showAcademyLoader();

			// if over time, just stop trying,
			if (runTime > window._as_navigateAcademyStart + giveUpTime) {
				// try next path
				return;
			}

			// If found path, click it
			if (jQuery(path[0]).length) {
				app.hideAcademyLoader();

				jQuery(path[0]).get(0).click();

				if (callback) {
					callback.call();
				}
				return;
			} else {
				// not found the path, try again after delay
				setTimeout(function () {
					app.openAcademyPath(path, true, callback);
				}, delayTimeout);
			}
		};

		/*
		openApp
		In AppBuilder, this will open the app specified by idOrName
		if `idOrName` is an integer, it will be treated as an ID, otherwise as a name
		*/
		app.openApp = function (idOrName, options, callback) {
			var options = options || {};

			// go to the App List screen (requires options.force)
			if (window.location.hash != "#1/1" && options.force) {
				window.location.hash = "#1/1";

				// after a delay, try again
				return setTimeout(
					function (idOrName, options, callback) {
						app.openApp(idOrName, options, callback);
					}.bind(this, idOrName, options, callback),
					20
				);
			}

			var j;
			if (!isNaN(idOrName)) {
				if (
					jQuery(
						".apps .apps-inner .item.icon .app-icon[data-href=" +
							idOrName +
							"] .image"
					).length
				) {
					j = jQuery(
						jQuery(
							".apps .apps-inner .item.icon .app-icon[data-href=" +
								idOrName +
								"] .image"
						)[0]
					);
				}
			} else {
				if (
					jQuery(
						'.apps .apps-inner .item.icon .title:contains("' + idOrName + '")'
					).length
				) {
					j = jQuery(
						jQuery(
							'.apps .apps-inner .item.icon .title:contains("' + idOrName + '")'
						)
							.parent()
							.find(".app-icon .image")
					);
				}
			}
			if (j && j.length) {
				// simulate a click to open dropdownmenu
				j.click();

				setTimeout(() => {
					// find the Open App link
					if (
						jQuery('body>.open .dropdown-menu li a:contains("Open App")').length
					) {
						jQuery(
							'body>.open .dropdown-menu li a:contains("Open App")'
						)[0].click();
					} else {
						// if not found, click on the special div to close the dropdownmenu
						// this div is added when the dropdown-menu appears, as a cover.. identified by it's z-index
						jQuery("body>div")
							.filter(function () {
								return this.style.zIndex == 900;
							})
							.click();
					}
				}, 500);
			}
		};

		app._openPopup = function (options) {
			// used to open edit, delete popups
			// they can be embeded (edit) or window (delete)
			// options = {id: 123, task: edit|delete|unit }

			var cover, popup;

			if (options.task == "edit") {
				options.controller = "items";
				options.container = ".toolbox .popup-loaded";

				// Show a cover
				cover = jQuery('<div class="phone-cover "></div>');
				cover.appendTo(".app");
				jQuery(".box2.sliding.toolbox").addClass("hidden-left");

				// Add the popup container
				popup = jQuery(
					'<div class="popup-embed sliding "><div class="popup-loaded sliding-inner"></div</div>'
				).appendTo("#popup-container");
			} else if (options.task == "delete") {
				options.controller = "items";
				options.container = ".toolbox .popup-loaded";

				// Show a cover
				cover = jQuery(
					'<div class="popup-underlay" style="z-index: 101; opacity: 0.5;"></div>'
				);
				cover.appendTo("body");

				// Add the popup container
				popup = jQuery(
					'<div class="popup-window" style=" z-index: 102; opacity: 1; visibility: visible; width: 350px; height: 120px; position:fixed; top: 50%; left: 50%; margin-top: -60px; /*set to a negative number 1/2 of your height*/ margin-left: -175px; /*set to a negative number 1/2 of your width*/ border: 1px solid #ccc; background-color: #f3f3f3; "><div class="popup-loaded"></div></div>'
				).appendTo("body");
			} else if (options.task == "unit" || options.controller == "academy") {
				options.controller = "academy";
				options.container = "#academy .popup-loaded";

				// Show a cover
				app.showAcademyLoader(5000);

				// Add the popup container
				// The academy element and popup-loaded should already be present
				if (jQuery(options.container).length == 0) {
					return;
				}
			}

			// save the cover (in 2 if 1 already used)
			if (app._popup1) {
				app._popup2 = popup;
				app._cover2 = cover;
			} else {
				app._popup1 = popup;
				app._cover1 = cover;
			}

			// Now call the AJAX
			// pass the same id for item_id and cid
			var url = "";
			if (options.hasOwnProperty("url")) {
				url = options.url;
			} else {
				url = "/index.php";
			}

			// add the basics
			if (url.match(/\?/)) {
				url += "&";
			} else {
				url += "?";
			}
			url +=
				"option=com_appbuilder&telPreview=true&emailPreview=true&version=2&time=" +
				Date.now();

			// check each of the options and add if present
			jQuery.each(
				["option", "task", "controller", "item_id", "cid"],
				function (i, val) {
					if (options.hasOwnProperty(val) && options[val] > "") {
						url += "&" + val + "=" + options[val];
					}
				}
			);
			// ?option=com_appbuilder&task=' + options.task + '&controller=' + options.controller + '&app_id=' + app.id + '&item_id=' + options.id + '&cid=' + options.id

			jQuery
				.ajax(url)
				.done((data, textStatus, jqXHR) => {
					if (options.controller == "academy") {
						app.hideAcademyLoader();
					}

					var data = JSON.parse(data);

					// Populate the panel
					jQuery(options.container).html(data.content);

					// Change submit form to use AJAX
					jQuery(options.container + " form").submit(function (event) {
						event.preventDefault(); //prevent default action
						var post_url = jQuery(this).attr("action"); //get form action url
						var request_method = jQuery(this).attr("method"); //get form GET/POST method
						var form_data = jQuery(this).serialize(); //Encode form elements for submission

						jQuery
							.ajax({
								url: post_url,
								type: request_method,
								data: form_data,
							})
							.done(function (response) {
								// There should be a few response actions to do
								app._responseActions.do(response);
							});
					});

					// Put actions on the buttons
					jQuery(options.container + ' .btn[data-popup="close"]').click(
						(event) => {
							event.preventDefault(); //prevent default action
							app._responseActions.close();
						}
					);
					jQuery(
						options.container +
							' .btn[data-popup="no-embed"]:contains("Delete")'
					).click((event) => {
						event.preventDefault(); //prevent default action
						app._openPopup({
							id: options.id,
							task: "delete",
						});
					});

					/*
				    TODO: The problem with using this function to open Academy links
				    Is that there are too many actions that need to be handleded. 
				    So we need to just stay with the default methods to browse academy
				*/

					// Put actions on the a tags
					// "in" must open in the same popup
					jQuery(options.container + ' a[data-popup="in"]').click(function (
						event
					) {
						event.preventDefault(); //prevent default action
						var jThis = jQuery(this)[0];
						app._openPopup({
							url: jThis.href,
							controller: options.controller,
						});
					});

					// Put actions on the .control divs
					// "in" must open in the same popup
					jQuery(options.container + " div.control").click(function (event) {
						event.preventDefault(); //prevent default action
						var jThis = jQuery(this);
						if (jThis.data("parent") > "")
							app._openPopup({
								url: jThis.data("parent"),
								controller: options.controller,
							});
					});
				})
				.fail((jqXHR, textStatus, errorThrown) => {
					console.warn("_openPopup AJAX fail", jqXHR, textStatus, errorThrown);
				});
		};

		/*
		_responseActions
		Objec to handle all the actions in a response
		*/
		app._responseActions = {
			// method to handle all the actions in a response
			do: function (response) {
				try {
					var json = JSON.parse(response);
					// look for actions in the json
					if (
						typeof json === "object" &&
						json.hasOwnProperty("action") &&
						json.action.length > 0
					) {
						jQuery.each(json.action, (i, val) => {
							// try get the details for this action in the json
							if (json.hasOwnProperty(val)) {
								try {
									// if the action has an argument, it will be as a propoerty in the json onbject
									// e.g. json = {phone_item_refresh: {arg_object} }
									// the arg_object will be available as `this`
									app._responseActions[val].call(app.game.this, json);
								} catch (er) {
									console.warn("app._jsonActions[val].call()", val, er);
								}
							}
						});
					}
				} catch (er) {
					console.warn("app._responseActions do()", er);
				}
			},

			close: function (json) {
				var cover, popup;
				if (app._popup2) {
					cover = app._cover2;
					popup = app._popup2;
				} else {
					cover = app._cover1;
					popup = app._popup1;
				}

				// show the toolbox if phone-cover
				if (cover) {
					if (cover.hasClass("phone-cover")) {
						jQuery(".box2.sliding.toolbox.hidden-left").removeClass(
							"hidden-left"
						);
					}

					cover.remove();
					popup.remove();
				}

				// now remove the cover history
				if (app._popup2) {
					app._popup2 = null;
					app._cover2 = null;
				} else {
					app._popup1 = null;
					app._cover1 = null;
				}
			},

			close_all: function (json) {
				this.close();
				this.close();
			},

			phone_item_refresh: function (json) {
				//
				appbuilder.app &&
					appbuilder.app.current &&
					(appbuilder.eventsManager.closeEvents(),
					appbuilder.app.current.loaded(json.phone_item_refresh, !0));
				return;
			},
		};

		// Scan for iot devices
		// Force all (optional) forces scanning of all IPs in range even if no resonse on .1 (expecting router on .1)
		app._scanForDevices = function (forceAll) {
			// When called from Settings, do UI changes
			jQuery("button._scanForDevices").hide();
			jQuery("progress._scanForDevicesProgress").show();
			jQuery("._scanForDevicesProgress_text").show();

			// Get the normal LAN WiFi ranges
			var ranges = app._commonLANIPs;

			// add ips from localstorage
			try {
				// might throw error if invalid localStorage data
				var ips = JSON.parse(localStorage["deviceWiFiIPs"]);
				// Add the normal LAN WiFi ranges
				ranges = ranges.concat(ips);
			} catch (er) {}

			var prefixes = [];
			app._countDeviceScanTotal = 0; // keep a count of all requests
			app._countDeviceScanInProgress = 0; // keep a count of requests in progress
			app._countDeviceScanDone = 0; // keep a count of requests in progress

			jQuery.each(ranges, function (i, val) {
				jQuery("._scanForDevicesProgress_text").text("Scanning " + val);

				var prefix = String(val).replace(/^(\d+\.\d+\.\d+\.).*/, "$1");
				// don't repeat prefixes
				if (jQuery.inArray(prefix, prefixes) == -1) {
					prefixes.push(prefix);
					if (forceAll) {
						app._scanIPsInRange(val);
					} else {
						// if the router at .1 exists, scan this range

						var url = "http://" + prefix + "1";

						try {
							jQuery
								.ajax({
									url: url,
									crossDomain: true,
									timeout: 4000,
									ip: val,
								})
								.done(function (a, b, c) {
									// Found router
									app._scanIPsInRange(this.ip);
								})
								.fail(function (a, b, c) {
									// if not timeout, then probably router/something exists at this url
									if (b != "timeout" && b != "error") {
										app._scanIPsInRange(this.ip);
									}
								});
						} catch (er) {}
					}
				}
			});
		};

		// Scan all IP addresses in the range that the given IP belongs to
		app._scanIPsInRange = function (ipString) {
			var prefix = String(ipString).replace(/^(\d+\.\d+\.\d+\.).*/, "$1");

			// look for a device on each IP address under prefix. The browser should handle queing of 6 concurrent requests per domain/prefix
			for (var i = 1; i < 256; i++) {
				var url = "http://" + prefix + i + "/info";
				jQuery("._scanForDevicesProgress_text").text("Scanning " + prefix + i);
				app._countDeviceScanTotal++;
				app._countDeviceScanInProgress++;

				// create n queues per prefix
				var n = parseInt(Math.random() * 6);
				jQuery
					.ajaxq(prefix + n, {
						url: url,
						crossDomain: true,
						timeout: 2000,
						local_ip: prefix + i,
						prefix: prefix,
						suffix: i,
					})
					.always(function () {
						jQuery("._scanForDevicesProgress_text").text(
							"Scanning " + this.local_ip
						);
						app._countDeviceScanInProgress--;
						app._countDeviceScanDone++;
						var percent = parseInt(
							(app._countDeviceScanDone / app._countDeviceScanTotal) * 100
						);
						jQuery("progress._scanForDevicesProgress").attr("value", percent);
					})
					.done(function (a, b, c) {
						try {
							var identifier = a.name; // + '_wifi';

							var d = app.getDevice({
								id: identifier,
								local_ip: this.local_ip,
								isValidLocalIP: true,
							});

							if (jQuery("#_settings_device_" + d.id).length == 0) {
								var devices_wifi = jQuery("._settingsDevices_wifi");

								var thisLink = jQuery(
									'<div class="link" id="_settings_device_' +
										d.id +
										'">' +
										(d.name && d.name > "" ? d.name : d.id) +
										"</div>"
								)
									.click(function () {
										app._logMessagesSelectedDevice = d;

										app.showStatusMessagePanel("DeviceDetails");
									})
									.appendTo(devices_wifi);
							}
						} catch (er) {
							console.error("app._scanIPsInRange", er.messaage);
						}
					})
					.fail(function () {
						//console.log('fail',this);
					});
			}
		};

		app.setLogoLoopSettings = function (settings) {
			// Set the logo loops settings to `settings`

			// If there are settings, only set those value passed in.
			// Therefore retain existing settings that are not explicitly set
			if (settings) {
				if (settings.hasOwnProperty("delay")) {
					app._logoLoopSettings.delay = settings.delay;
				}
				if (settings.hasOwnProperty("variable")) {
					app._logoLoopSettings.variable = settings.variable;
				}
				if (settings.hasOwnProperty("code")) {
					app._logoLoopSettings.code = settings.code;
				}
			}
		};

		// Show the JavaScript warnings on items
		app._showJavaScriptWarnings = function () {
			// If app.jslint not loaded yet, try again in n seconds
			if (!app.hasOwnProperty("jslint") || typeof app.jslint != "function") {
				setTimeout(function () {
					app._showJavaScriptWarnings();
				}, 1000);
				return;
			}

			var selector = ".app .screen .item";

			jQuery(selector)
				.not(".new-item-placeholder")
				.each(function () {
					try {
						var item = app.getItem(this.id);
						var j = item.jQuery;
						var code = item.getActionJavaScript();

						//					var j = jQuery(this);

						/*
					
					// try get this JSON
					var thisJSON = {};
					try {
						var item_JSON = JSON.parse(j.find('>.text').text());
						if (typeof item_JSON === "object") {
							thisJSON = item_JSON;
						}
					} catch (er) {}


					// Delay
					var delay = 0;
					if (thisJSON.hasOwnProperty('delay') && !isNaN(thisJSON.delay) && parseInt(thisJSON.delay) > 0) {
						delay = parseInt(thisJSON.delay);
					}
					*/

						/*
					var code = '';
					if (j.data('linktype') == 'jscode') {
						code = appbuilder.app.api.phone.navigator.screenObj.javascripts[this.id];
					} else if (j.data('linktype') > '') {
						// Get the code using callActions()

						// TODO This is not very efficient... Better to get the JavaScript equivalent for the action
						// if the linktype is tab or screen (i.e. navigating away from the game) then stop the game.
						if (["tab", "screen"].contains(j.data('linktype'))) {
							code += "app.game.stop(); ";
						}
						code += "app.getItem('" + this.id + "').callActions();\n";
					}
					*/

						// skip if no code to run
						if (code == "") {
							return;
						}

						// JavaScript error If Code has an error, JSLint
						// Show message us linter, and skip if code has an error

						var hasError = true; // set to true... skip the Function test below

						/*
					try {
						// this line throws an error if there is a problem with the code
						// but sometimes this does not pick up all errors
						(function () {
							new Function(code);
						})()
					} catch (er) { 
						hasError = true;
					}
					*/

						if (hasError) {
							var msg = app._getJSLintMessages(code);
							/*
						// Set up some options for the jslint - these should be optimised for our use case
						let option = Object.create(null);
						["devel","browser","fudge","convert","eval","for","getset","long","single","this","white"].forEach(function (title) {
							option[title] = true;
						});

						var result = app.jslint(
							code,option,
							["object","item","data","app","jQuery"]
						);
						
						// Go through all the warnings
						var msg = '';
						jQuery(result.warnings).each(function(i,val){
							// ignore some errors
							// ignore ; erros
							if(String(val.message).test(/Expected ';' and instead saw/) 
								||  String(val.message).test(/Undeclared 'appbuilder'/)
								||  String(val.message).test(/Expected '===' and instead saw '=='/)
								
							){
							
							}else{
								msg += "<cite><address>Line "+ (parseInt(val.line)+1) +"</address>"+val.message+"</cite><samp>"+ result.lines[val.line]+ "</samp>  \n<br>";
							}
						})
						*/
							if (msg > "") {
								// add the warning to the item
								app.warn(0, msg, null, [item.id + ""]);
							}
						}
					} catch (er) {
						console.log("error _showJavaScriptWarnings", er);
					}
				});
		};

		app._trUIChanges = function () {
			// Make some UI changes for tr accounts

			// only for non-EDU
			if (!app.isEDUUser) {
				// make sure not done already
				if (!app._trUIDone) {
					// for both expired and not
					/*
					if (jQuery('.toolbox-ads').length == 0) {
						jQuery('.toolbox .app-controls').after('<div class="toolbox-ads" style="     height: 90px;     margin-bottom: 10px;     border: 1px solid silver;     "><a href="/upgrade" target="_blank"><img src="/images/messages/ads/free-trial-ad.png" border="0"></a> </div>');
					}
                    */

					// Hide some top-menu items
					//jQuery.each(["Device", "Dev Tools", "Dashboard", "Academy"], function (i, val) {
					jQuery.each(["Dev Tools", "Dashboard", "Academy"], function (i, val) {
						jQuery(
							'.navbar-fixed-top ul.nav li.dropdown>a:contains("' + val + '")'
						)
							.parent()
							.hide();
					});

					var href = "/about/account-structure-changes";
					var days = 31 - new Date().getDate();
					var linkText = "Trial expired";

					// if _tr has exp
					if (app._isTRExp()) {
						// Disable some buttons
						jQuery.each(["Publish", "Share"], function (i, val) {
							jQuery('.toolbox ul.app-controls>li>a:contains("' + val + '")')
								.css("color", "#c0c0c0")
								.unbind()
								.attr("href", "")
								.attr("data-popup", "")
								.attr("data-toggle", "")
								.click(function () {
									return false;
								})
								.parent()
								.find(".dropdown-menu")
								.remove();
						});
					} else {
						// not exp, show days remaining

						//linkText = 'Trial expires in '+days+' days';
						linkText = "Trial expires soon";
					}

					// override text
					linkText = "";

					// Add the Expires in button to top Nav
					/*
					if (jQuery('.navbar-fixed-top .tr-exp.tr-upgrade').length == 0) {

						var div = jQuery('<div class="tr-exp tr-upgrade" style="margin-left: 185px; margin-right: 20px; display: inline-block;">    <span style="    line-height: 52px;    vertical-align: middle;   "><a href="' + href + '" target="_blank">' + linkText + '</a>     </span>    </div>');
						var button = jQuery('<button type="button" class="btn btn-warning" style="    vertical-align: middle;    margin-top: 0px;"><i class="icon-user"></i> Upgrade</button>').click(function () {
							window.open('/upgrade', '_blank');
						});

						jQuery('.navbar-fixed-top ul.nav').first().after(div.append(button));
					}
                    */

					// mark UI changes
					app._trUIDone = true;
				}
			}
		};

		app.ui = {
			bounce: function (selector, repeat) {
				// bounce an element
				// (optional) repeat that many times, default 1

				var repeat = repeat || 1;
				jQuery(selector).animate(
					{
						top: -81,
					},
					null,
					null,
					function () {
						jQuery(selector).animate(
							{
								top: -41,
							},
							200,
							null,
							function () {
								if (repeat > 1) {
									repeat--;
									app.ui.bounce(selector, repeat);
								}
							}
						);
					}
				);
			},

			closeToolbox: function () {
				jQuery(".span-toolbox").css("display", "none");
			},

			handlerContextMenuItemEdit: function (timeout) {
				// add the event handler to the Item Context Menu for Edit

				if (app.isMobileEditor) {
					timeout = timeout || 0;

					// If the element does not exist, try again after a timeout
					// (but not if this method being called with a timeout already - avoid infinite loop)

					if (jQuery(".open>.dropdown-menu").length == 0 && timeout <= 3000) {
						return setTimeout(function () {
							app.ui.handlerContextMenuItemEdit(timeout + 500);
						}, 500);
					}

					jQuery(".open>.dropdown-menu")
						.children()
						.each(function () {
							if (jQuery(this).find(".icon-edit").length) {
								jQuery(this).click(function () {
									app.ui.openToolbox();

									app.ui.handlerItemSave();
								});
							}
						});
				}
			},

			handlerItemSave: function (timeout) {
				if (app.isMobileEditor) {
					timeout = timeout || 0;

					if (
						jQuery("#popup-container .btn-success").length == 0 &&
						timeout <= 3000
					) {
						return setTimeout(function () {
							app.ui.handlerItemSave(timeout + 500);
						}, 500);
					}

					jQuery("#popup-container .btn-success").click(function () {
						app.ui.closeToolbox();
					});
				}
			},

			openToolbox: function () {
				jQuery(".span-toolbox").css("display", "block");
			},

			toggleToolbox: function () {
				if (jQuery(".span-toolbox").css("display") == "block") {
					jQuery(".span-toolbox").css("display", "none");
				} else {
					jQuery(".span-toolbox").css("display", "block");
				}
			},
		};

		app.onTouchend = function (e) {
			// Event handler for the `touchend` and `mouseup` events

			app.isTouching = false;
		};

		app.onTouchmove = function (e) {
			// Event handler when touch or mouse moves

			// Avoid calling this method if it is currently executing
			if (app._isActiveTouchmove) return;

			app._isActiveTouchmove = true;

			var ident = Math.random();

			// Event handler for the `touchmove` and `mousemove` events
			var touchobj = e.event.changedTouches
				? e.event.changedTouches[0]
				: e.event; // reference first touch point for this event
			app.touchX = touchobj.clientX;
			app.touchY = touchobj.clientY;

			// Get the touchAngle
			app.touchAngle =
				(Math.atan2(
					app.touchY - app.touchStartY,
					app.touchX - app.touchStartX
				) *
					180) /
				Math.PI;
			// make angle 0-360, not negatives.
			if (app.touchAngle < 0) app.touchAngle = 360 + app.touchAngle;

			// see if hovering over item
			// Get the Element below the current point
			var thisHoverElement = document.elementFromPoint(
				touchobj.clientX,
				touchobj.clientY
			);
			var thisHoverItem = app.findParentItem(thisHoverElement);

			// Is it a new Element
			if (
				!app._currentHoverItem ||
				(thisHoverItem && thisHoverItem.id != app._currentHoverItem.id)
			) {
				var oldHoverItem = app._currentHoverItem;

				// Save this as the current Element and Item
				app._currentHoverElement = thisHoverElement;
				app._currentHoverItem = thisHoverItem;

				// reset the hover image on oldHoverItem if it has a hover image
				if (
					oldHoverItem &&
					oldHoverItem.hoverImage &&
					oldHoverItem.originalImage
				)
					oldHoverItem.setImage(oldHoverItem.originalImage);

				// set the new hover image if required
				if (app._currentHoverItem && app._currentHoverItem.hoverImage) {
					app._currentHoverItem.setImage(app._currentHoverItem.hoverImage);
				}

				// call actions for this `Item`
				if (
					app._currentHoverItem &&
					app._currentHoverItem.callActions &&
					app._currentHoverItem.onHoverDoActions
				)
					app._currentHoverItem.callActions();
			}

			//        e.preventDefault()
			app._isActiveTouchmove = false;
		};

		app.onTouchstart = function (e) {
			// Event handler for the `touchstart` and `mousedown` events

			// need to make sure scroll rules have been applied, because on some mobiles the screen event doesn't fire
			app.applyScrollRules(document.querySelector(".screen"));

			app._isTouching = true;
			var touchobj = e.event.changedTouches
				? e.event.changedTouches[0]
				: e.event; // reference first touch point for this event
			app.touchStartX = touchobj.clientX;
			app.touchStartY = touchobj.clientY;
			app.touchX = touchobj.clientX;
			app.touchY = touchobj.clientY;
		};

		app.preload = function (images) {
			// Preloads the `images` passed in an array
			// Format of `images':
			//  `[ 'url1','urls',...]`
			// returns `this`

			for (var i = 0; i < images.length; i++) {
				// Preload the image
				jQuery("<img />")[0].src = images[i];
			}

			return this;
		};

		app.preloadAddioItems = function (el) {
			// create audio elements for each Sound action

			jQuery(el)
				.find('.item[data-linktype="sound"]')
				.each(function () {
					var jThis = jQuery(this);
					var aId = this.id + "_audio";

					// Check it doesn't exist already
					if (jQuery("#" + aId).length == 0) {
						jQuery("<audio></audio>")
							.attr({
								src: jThis.data("href"),
								id: aId,
							})
							.appendTo("body");
					}
					// Now start playing, and pause the audio.
					// This will allow us to control the audio from async JavaScript
					jQuery("#" + aId).each(function () {
						this.play();
						this.pause();
						this.currentTime = 0;
					});
				});
		};




		
		/*
			app._resourcepanelInit
			Prepares the EDU popup div and actions. 
			Includes iframe to edu.appshed.com Moodle site
			Params
				`options` - 
					{
						"reload": (default false) - true to force the whole resource panel to be rebuilt. This is useful if the state has changed (e.g. trial activated)
					}

            Tabs:
                    Tabs can have data attributes:
                        href: (optional) the src for the iframe
                        responsive: (default: yes): 
                            If yes: the iframe shown when maxed and hidden when docked. The other content (DWC) hidden when maxed
                            If no: Both DWC and iframe shown in maxed AND docked
                        link-target: (the target for <a href>)
                            iframe-max: (default) into the iframe, and maximise
                            iframe: into the iframe (no resize)
                            _blank: in a new tab
                            default: opens in the current window
		*/

		app._resourcepanelInit = function (options, callback) {
			// Do this only for AppBuilder
			if (!(app.isAppBuilder && !app.isPreview)) {
				return;
			}

			var options = options || {};

			// is reload required
			if (options && options.reload === true) {
				jQuery(".resourcepanel").children().remove();
			}

			// only continue if the popup panel is not present
			if (!jQuery(".as-edu-popup").length) {
				// default docked
				jQuery(".resourcepanel").addClass("docked");

				// add bg
				jQuery('<div class="as-edu-popup-bg"> </div>')
					.prependTo(".resourcepanel")
					.click(function () {
						app._resourcepanelMinimize();
					});

				jQuery(`<div class="as-edu-popup" style="display: block;">  
					<div class="as-edu-popup-header"> </div> 
					</div> `).prependTo(".resourcepanel");

				// add header controls
				jQuery(` <div class="as-edu-header-controls">     
					<div class="as-edu-header-control as-edu-close">
					<img width="13" height="13" src="https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/images/close-bk-x.png">
					</div>
					<div class="as-edu-header-control as-edu-maximize">
					<img width="13" height="13" src="https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/images/expand.png">
					</div>       
					<div class="as-edu-header-control as-edu-minimize">
						<img width="13" height="13" src="https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/images/collapse.png">
					</div>  </div>`).prependTo(".as-edu-popup-header");

				if (!app.isEDUStudent) {
					jQuery(".as-edu-close").hide();
				}

				// tabs
				jQuery(`<div class="navbar">
					<ul class="nav pull-left">
					</ul>
					</div>`).prependTo(".as-edu-popup-header");
				// Home
				jQuery(`<li data-tab="home" data-href=""  data-responsive="no" class="active">
						<img width="16" src="https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/images/home-bk.png"></li>`).appendTo(
					".as-edu-popup-header>.navbar>ul"
				);
				// Courses
				jQuery(`<li data-tab="courses" data-href="" data-responsive="no" >Courses</li>`).appendTo(
					".as-edu-popup-header>.navbar>ul"
				);
				// Help
				jQuery(`<li data-tab="help" data-href="/help" data-responsive="yes">Help</li>`).appendTo(
					".as-edu-popup-header>.navbar>ul"
				);
				// EDU or Upgrade
				if (app.isEDUTeacher && app.isEDUActive) {
					// EDU for Active Teacher
					jQuery(`<li data-tab="edu" data-href="/appbuilder/academy" data-responsive="yes">EDU</li>`).appendTo(
						".as-edu-popup-header>.navbar>ul"
					);
				}
				if (
					app.isStarter ||
					app.isTrEDU ||
					app.isEDUUnpaid ||
					(app.isEDUUser && !app.isEDUActive)
				) {
					// don't show Upgrade to students
					if (!app.isEDUStudent) {
						// Upgrade
						jQuery(`<li data-tab="upgrade" data-href="">Upgrade</li>`).appendTo(
							".as-edu-popup-header>.navbar>ul"
						);
					}
				}

				// tab click
				jQuery(".as-edu-popup-header .nav>li").click(function () {
					app._resourcepanelSetTab(this.dataset.tab);
				});

				// Minimize makes it really small
				jQuery(".as-edu-minimize").click(function () {
					app._resourcepanelMinimize();
				});

				// Maximize
				jQuery(".as-edu-maximize").click(function () {
					app._resourcepanelMaximize();
				});

				jQuery(".as-edu-close").click(function () {
					jQuery(".as-edu-popup").hide();
				});

				// load Home tab
				app._resourcepanelSetTab("home");

				// Make the DIV element draggable:
				initDragAndResizeElement("as-edu-popup");

				function initDragAndResizeElement(className) {
					initDragElement();
					initResizeElement();

					var css = `
						
						`;
					(head = document.head || document.getElementsByTagName("head")[0]),
						(style = document.createElement("style"));
					head.appendChild(style);
					style.type = "text/css";
					style.appendChild(document.createTextNode(css));

					function initDragElement() {
						var pos1 = 0,
							pos2 = 0,
							pos3 = 0,
							pos4 = 0;
						var popups = document.getElementsByClassName("as-edu-popup");
						var elmnt = null;
						//var currentZIndex = 1099; //TODO reset z index when a threshold is passed

						for (var i = 0; i < popups.length; i++) {
							var popup = popups[i];
							var header = getHeader(popup);

							popup.onmousedown = function () {
								//this.style.zIndex = "" + currentZIndex;
							};

							if (header) {
								header.parentPopup = popup;
								header.onmousedown = dragMouseDown;
							}
						}

						function dragMouseDown(e) {
							jQuery(".as-edu-popup-iframe").hide();

							elmnt = this.parentPopup;
							//elmnt.style.zIndex = "" + ++currentZIndex;

							e = e || window.event;
							// get the mouse cursor position at startup:
							pos3 = e.clientX;
							pos4 = e.clientY;
							document.onmouseup = closeDragElement;
							// call a function whenever the cursor moves:
							document.onmousemove = elementDrag;
						}

						function elementDrag(e) {
							if (!elmnt) {
								return;
							}

							// save data to show it moved
							jQuery(".as-edu-popup").data("dragged", true);

							e = e || window.event;
							// calculate the new cursor position:
							pos1 = pos3 - e.clientX;
							pos2 = pos4 - e.clientY;
							pos3 = e.clientX;
							pos4 = e.clientY;
							// set the element's new position:
							var newTop = elmnt.offsetTop - pos2;
							var newLeft = elmnt.offsetLeft - pos1;

							// ensure moved to reachable position, not off visible area
							var rect = elmnt.getBoundingClientRect(); // absolute position on screen
							if (rect.top < 70) {
								newTop += 10;
							}
							if (rect.left < 10) {
								newLeft += 10;
							}

							elmnt.style.top = newTop + "px";
							elmnt.style.left = newLeft + "px";
						}

						function closeDragElement() {
							jQuery(".as-edu-popup-iframe").show();
							/* stop moving when mouse button is released:*/
							document.onmouseup = null;
							document.onmousemove = null;

							// did it actually move?
							if (jQuery(".as-edu-popup").data("dragged")) {
								// update body class to reflect docked
								jQuery("body").addClass("resourcepanel-undocked");
								jQuery(".resourcepanel").removeClass("docked");

								// reset the data
								jQuery(".as-edu-popup").data("dragged", null);
							}

							// If it hardly moved much, re-dock it
							if (
								Math.abs(
									jQuery(".resourcepanel-container").offset().top -
										jQuery(".resourcepanel .as-edu-popup").offset().top
								) +
									Math.abs(
										jQuery(".resourcepanel-container").offset().left -
											jQuery(".resourcepanel .as-edu-popup").offset().left
									) <
								50
							) {
								app._resourcepanelMinimize();
							}
						}

						function getHeader(element) {
							var headerItems = element.getElementsByClassName(
								"as-edu-popup-header"
							);

							if (headerItems.length === 1) {
								return headerItems[0];
							}

							return null;
						}
					}

					function initResizeElement() {
						var popups = document.getElementsByClassName("as-edu-popup");
						var element = null;
						var startX, startY, startWidth, startHeight;

						for (var i = 0; i < popups.length; i++) {
							var p = popups[i];

							var right = document.createElement("div");
							right.className = "resizer-right";
							p.appendChild(right);
							right.addEventListener("mousedown", initDrag, false);
							right.parentPopup = p;

							var bottom = document.createElement("div");
							bottom.className = "resizer-bottom";
							p.appendChild(bottom);
							bottom.addEventListener("mousedown", initDrag, false);
							bottom.parentPopup = p;

							var both = document.createElement("div");
							both.className = "resizer-both";
							p.appendChild(both);
							both.addEventListener("mousedown", initDrag, false);
							both.parentPopup = p;
						}

						function initDrag(e) {
							jQuery(".as-edu-popup-iframe").hide();
							element = this.parentPopup;

							startX = e.clientX;
							startY = e.clientY;
							startWidth = parseInt(
								document.defaultView.getComputedStyle(element).width,
								10
							);
							startHeight = parseInt(
								document.defaultView.getComputedStyle(element).height,
								10
							);
							document.documentElement.addEventListener(
								"mousemove",
								doDrag,
								false
							);
							document.documentElement.addEventListener(
								"mouseup",
								stopDrag,
								false
							);
						}

						function doDrag(e) {
							element.style.width = startWidth + e.clientX - startX + "px";
							element.style.height = startHeight + e.clientY - startY + "px";
						}

						function stopDrag() {
							jQuery(".as-edu-popup-iframe").show();
							document.documentElement.removeEventListener(
								"mousemove",
								doDrag,
								false
							);
							document.documentElement.removeEventListener(
								"mouseup",
								stopDrag,
								false
							);
						}
					}
				}

				// if a trial is requested, do it
				if (!app.isTrEDU && sessionStorage.getItem("trialRequested") == "1") {
					// reset session variable
					sessionStorage.setItem("trialRequested", null);

					app.user.trialRequest();
				}

				if (callback) {
					try {
						callback.call();
					} catch (error) {
						console.error("_resourcepanelInit callback", error);
					}
				}
			}
		};

		
		/*
            app._resourcepanelLoadContent
            Loads the content for the specified resourcepanel tab
            Parameters
                `el` - the tab element that was clicked
        */


		app._resourcepanelLoadContent = function (tab) {
			// based on the tab container passed in
			//            var jTab = jQuery(el);
			var jTab = jQuery(
				'.as-edu-popup-header .navbar li[data-tab="' + tab + '"]'
			).first();
			if (jTab.length == 0) {
				console.warn("_resourcepanelLoadContent tab not found");
				return;
			}

			var jContainer = jQuery(
				'.as-edu-popup-tab-container[data-tab="' + jTab.data("tab") + '"]'
			).first();
			var jContent = jContainer.find(".as-edu-popup-content").first();

			// first clear previous content
			jContent.text("");

			// SHARED CONTENT for all tabs
			// Add the DWC top based on user types
			app._mtCreateDWC(
				"resources-" + jTab.data("tab") + "-top-" + app.user.getType(),
				{ appendTo: jContent }
			);

			// for all show this DWC
			app._mtCreateDWC("resources-" + jTab.data("tab") + "-top", {
				appendTo: jContent,
			});


			// SPECIAL CONTENT for specific tabs

			// home SPECIAL CONTENT 
			if (jTab.data("tab") == "home") {

				// If there is a processing edu order, show DWC
				if(app.user.state.hasOwnProperty('hasEDUOrderProcessing') && app.user.state['hasEDUOrderProcessing'] == true){
					app._mtCreateDWC(
						"resources-" + jTab.data("tab") + "-top-" + app.user.getType() + "-edu-processing",
						{ prependTo: jContent }
					);
				}
			}

			// courses SPECIAL CONTENT 
			if (jTab.data("tab") == "courses") {
				// only show courses if verified
				if(app.user.isVerified() ){
					jQuery(`
						<div class="course-catalog">
						</div>
						`).appendTo(jContent);
					app._showCourses();
				}else{

					// show this DWC
					app._mtCreateDWC("resources-" + jTab.data("tab") + "-unverified", {
						appendTo: jContent,
					});

					// Initially we will give access to courses to unverified
					if(true){
						
						jQuery(`
							<div class="course-catalog">
							</div>
							`).appendTo(jContent);
						app._showCourses();
					}
				}
			}

			// help SPECIAL CONTENT 
			if (jTab.data("tab") == "help") {
				// Search box
			}

			
			// edu SPECIAL CONTENT 
			if (jTab.data("tab") == "edu") {
				// Show the Dashboard when panel maximized 
				// show/hide the iframe is controlled by css
				jQuery("#as-edu-popup-iframe-" + jTab.data("tab"))
                    .data("href","https://appshed.com/appbuilder/academy")
                    .removeClass("hidden");

			}

			// upgrade SPECIAL CONTENT 
			if (jTab.data("tab") == "upgrade") {
			}
		};



		app._resourcepanelMinimize = function (el) {
			var j = jQuery(".as-edu-popup");

			var width = "273px";
			//var height = '87px';
			var height = "unset";
			var top = "0px";
			var left = "0px";
			var bottom = "0px";

			// toggle between small and big
			if (j.width() <= 200 && j.height() <= 100) {
				width = "400px";
				//height = 'unset';
				top = "0px";
			}
			j.css("position", "absolute")
				.css("zz-index", 110)
				.css("bottom", bottom)
				.css("left", left)
				.css("width", width)
				.css("height", height)
				.css("top", top);

			// update body class to reflect docked
			jQuery("body")
				.removeClass("resourcepanel-undocked")
				.removeClass("resourcepanel-maxed");
			jQuery(".resourcepanel").addClass("docked");
		};

		app._resourcepanelMaximize = function (el) {
			var j = jQuery(".as-edu-popup");

			j.css("position", "fixed")
				.css("zz-index", 1106)
				.css("width", "unset")
				.css("height", "unset")
				.css("inset", "83px 35px 22px 35px");

			// update body class to reflect docked
			jQuery(".resourcepanel").removeClass("docked");
			jQuery("body")
				.addClass("resourcepanel-maxed")
				.addClass("resourcepanel-undocked");
		};

		/*
            app._resourcepanelSetTab 
            Set the tab in the resource panel
            Parameters:
            `tab` - the tab  to show, e.g. 'courses'
			`options` - (optional) object of various options
				{
					"reload": true // the tabe container is cleared to forece a reload
				}

        */

		app._resourcepanelSetTab = function (tab, options) {
			var options = options || {};

			var jTab = jQuery(
				'.as-edu-popup-header .navbar li[data-tab="' + tab + '"]'
			).first();

			if (jTab.length == 0) {
				return;
			}

			// remove current active tab
			jQuery(".as-edu-popup-header .nav>li.active").removeClass("active");

			// make this active
			jTab.addClass("active");

			// Hide all containers
			jQuery(".as-edu-popup-tab-container").hide();

			// reload required?
			if (options && options.reload === true) {
				jQuery(
					'.as-edu-popup-tab-container[data-tab="' + jTab.data("tab") + '"]'
				).remove();
			}

			// does a div exist for this tab, if not, add it
			if (
				jQuery(
					'.as-edu-popup-tab-container[data-tab="' + jTab.data("tab") + '"]'
				).length == 0
			) {
				// Create the div and iframe
				var responsiveClass = (jTab.data("responsive") == 'no' ? "" : "responsive")
				jQuery(
					`
					<div class="as-edu-popup-tab-container" data-tab="` +
						jTab.data("tab") +
						`">
							<div class="as-edu-popup-content ${responsiveClass}"></div>
							<div class="as-edu-popup-iframe-container ${responsiveClass}"> 
								<iframe src="" id="as-edu-popup-iframe-` + jTab.data("tab") + `" class="as-edu-popup-iframe"></iframe>
							</div> 
						</div> 
					</div> `
				).appendTo(".as-edu-popup");

				// iframe on load
				jQuery('#as-edu-popup-iframe-' + jTab.data("tab")).on("load",function(e){
					app._onLoadiFrameCallback.bind(this)(e); 
				})


				// load the content
				app._resourcepanelLoadContent(tab);
			}

			// Show this container
			var jContainer = jQuery(
				'.as-edu-popup-tab-container[data-tab="' + jTab.data("tab") + '"]'
			).first();
			jContainer.show();

			// load iframe?
			var ji = jQuery("#as-edu-popup-iframe-" + jTab.data("tab"));
			// look for a data-href property
			if (jTab.data("href").length) {                
				//if (ji.attr("src") != jTab.data("href")) {
				if (ji.attr("src") == "") {
					ji.addClass('hidden');
					ji.attr("src", jTab.data("href"));
				}
				
				ji.removeClass('hidden');
				//ji.parent().show();
			} else {
				ji.addClass('hidden');
			}


			
		};


        

		app.prependToVariable = function (variable, value) {
			// prepends `value` to `variable` and return the result

			return this.appendToVariable(variable, value, true);
		};

		app.reformatCaptureItems = function (id, el) {
			// Reformat `Items` of type `Capture` to show the `file input` element
			// This is a temporary fix because the AppShed UI did not update to support HTML5 capture items

			var els = el.getElementsByClassName("capture");
			for (var i = 0; i < els.length; i++) {
				try {
					if (els[i].getElementsByClassName("file").length) {
						break;
					}

					var input = document.createElement("input");
					input.type = "file";
					input.id = els[i].dataset.name;
					input.name = els[i].dataset.name;
					input.className = "file";
					input.accept = els[i].dataset.capturetype + "/*";
					input.dataset.variable = els[i].dataset.name;
					input.dataset.name = els[i].dataset.name;
					input.dataset.capturetype = els[i].dataset.capturetype;

					var offEl = els[i].getElementsByClassName("off")[0];
					var parent = offEl.parentNode;
					parent.appendChild(input);
					offEl.style.display = "none";
				} catch (er) {}
			}
		};

		app.reformatDataItems = function (id, el) {
			// Reformat `Items` that have special functionality for `Data`
			// returns `this`

			var vars = app.data.getVariables();

			// DATA SELECT
			// Add variable selection

			app.addStyles(
				".data_select_controls input{zoom: 2;} .data_select_variable label{float: left; width: inherit; padding-right: 10px} .data_select_controls select{width: inherit;} "
			);

			jQuery(".data_select_controls").remove();

			jQuery(".data_select.item").each(function (index) {
				var el = this;

				var id = "data_select" + el.id.replace(/item/, "");
				var insert = '<div id="' + id + '" class="data_select_controls">';

				insert += '<div class="data_select_variable">';

				vars.forEach(function (currentValue, index, array) {
					insert +=
						'<label><input name="data_select_variable_' +
						currentValue +
						'" type="checkbox">' +
						currentValue +
						"</label>";
				});
				insert += "</div>"; // data_select_variable

				insert += "</div>"; // data_select_controls

				jQuery(this).before(insert);
			});

			// DATA FILTER
			// add additional controls to buttons with class `data_filter`
			// Remove the existing controls if present
			jQuery(".data_filter.item .data_filter_controls").remove();

			app.addStyles(
				".data_filter.item{clear: both;} #app" +
					app.id +
					" .data_filter.item.button button.button{width:inherit;} .data_filter_variable,.data_filter_comparison,.data_filter_value{float: left; width: inherit; padding-right: 10px} .data_filter_value{width: 50px;} .data_filter_controls input, .data_filter_controls select{width: inherit;} .data_filter_controls input{line-height: 24px;}"
			);
			var insert = '<div class="data_filter_controls">';

			insert += '<div class="data_filter_variable">';
			insert += '<select name="data_filter_variable">';
			insert += '<option value=""> - no filter - </option>';
			vars.forEach(function (currentValue, index, array) {
				insert += "<option>" + currentValue + "</option>";
			});
			insert += "</select></div>";

			insert +=
				'<div class="data_filter_comparison"><select name="data_filter_comparison">';
			["==", "!=", "<>", ">", "<", ">=", "<="].forEach(function (
				currentValue,
				index,
				array
			) {
				insert += "<option>" + currentValue + "</option>";
			});
			insert += "</select></div>";

			insert +=
				'<div class="data_filter_value"><input name="data_filter_value" /></div>';

			insert += "</div>"; // data_filter_controls

			jQuery(".data_filter.item button").before(insert);

			return this;
		};

		app.reformatInputTypes = function (id, el) {
			// Reformat `Items` that have className `range` or 'slider' to show the `range input` element
			// This is a temporaru fix because the AppShed UI did not update to support HTML5 range items
			// returns `this`

			var inputTypes = [
				"color",
				"date",
				"datetime-local",
				"email",
				"month",
				"number",
				"range",
				"search",
				"tel",
				"time",
				"url",
				"week",
			];

			// Set the `type` for `textbox` Items
			for (var t = 0; t < inputTypes.length; t++) {
				var els = el.getElementsByClassName(inputTypes[t]);
				for (var i = 0; i < els.length; i++) {
					try {
						// check that the `type` has not already been set
						if (
							els[i].getElementsByClassName("textbox")[0].type == inputTypes[t]
						) {
							break;
						}

						els[i].getElementsByClassName("textbox")[0].type = inputTypes[t];
					} catch (er) {}
				}
			}

			// Disable
			jQuery(".disabled.item input").each(function () {
				jQuery(this).attr("disabled", "true");
			});

			return this;
		};

		app.refreshScroll = function () {
			// Refresh the iScroll
			// This is needed if items are added to the screen, as the size of the scroll area changes
			// Returns `this`

			try {
				jQuery(".items")[0].retrieve("scroll").refresh();
			} catch (er) {}

			return this;
		};

		app.removeClass = function (className) {
			// Removes `className` from the app `element`
			// Returns `this`

			jQuery(".app-navigator").removeClass(className);

			return this;
		};

		/*
		_removeCustomClass
		Remove a class from the Custom Class field
		*/
		app._removeCustomClass = function (name) {
			if (jQuery("#style_costumclases").length) {
				var myRE = new RegExp(name, "g");
				jQuery("#style_costumclases").val(
					jQuery("#style_costumclases")
						.val()
						.replace(myRE, "")
						.replace(/ /g, "")
				);
			}

			return true;
		};

		app.removeScreenEvent_xxx = function (identifier) {
			// Stops a `Screen` event from being called when a screen loads
			// `identifier` is the return value of `app.addScreenEvent()`
		};

		app.removeTabEvent_xxx = function (identifier) {
			// Stops a `Tab` event from being called when a screen loads
			// `identifier` is the return value of `app.addTabEvent()`
		};

		app.removeVariableEvent_xxx = function (identifier) {
			// Stops a `Variable` event from being called when a variable value changes
			// `identifier` is the return value of `app.addVariableEvent()`
		};

		app.replaceItemHTML = function (html, data) {
			// Replace the values of the `Item html` using the properties supplied in `data`
			// Supported Properties
			// 		image: the URL of the image
			// 		title
			// 		text
			// 		name (and data-variable)
			// 		value
			// 		checked

			if (!data) {
				return html;
			}

			if (data.id) {
				html = html.replace(/id="item\d+"/, 'id="item' + data.id + '"');
			}

			if (data.image) {
				html = html.replace(
					/<img class="icon" src=".*?"/,
					'<img class="icon" src="' + data.image + '"'
				);
				html = html.replace(
					/<img class="image" src=".*?"/,
					'<img class="image" src="' + data.image + '"'
				);
			}

			if (data.title) {
				// Special case: plain items, treat the text class as the title
				if (html.match(/item plain/)) {
					html = html.replace(
						/<div class="text">.*?<\/div>/,
						'<div class="text">' + data.title + "</div>"
					);
				} else {
					html = html.replace(
						/<div class="title">.*?<\/div>/,
						'<div class="title">' + data.title + "</div>"
					);
				}
			}

			if (data.text) {
				html = html.replace(
					/<div class="text">.*?<\/div>/,
					'<div class="text">' + data.text + "</div>"
				);
			}

			if (data.name) {
				html = html.replace(/name=".*?"/, 'name="' + data.name + '"');
				html = html.replace(
					/data-variable=".*?"/,
					'data-variable="' + data.name + '"'
				);
			}

			if (data.value) {
				html = html.replace(/value=".*?"/, 'value="' + data.value + '"');
				html = html.replace(/<\/textarea>/, data.value + "</textarea>");
			}

			if (data.checked) {
				html = html.replace(/value="/, 'checked value="');
			} else {
				html = html.replace(/checked/, "");
			}

			return html;
		};

		app.repositionItems = function (id, el) {
			// Reposition items based on `className`
			// Supported `classNames`:
			//    `position-bottom`
			// Returns `this`

			var newEl = jQuery(el).find(".position-bottom").detach();

			newEl
				.css("position", "absolute")
				.css("bottom", "0px")
				.css("width", "100%");

			if (parseInt(jQuery(".tab-bar").css("bottom")) == 0) {
				newEl.css("bottom", jQuery(".tab-bar").css("height"));
			}

			jQuery(el).find(".scrolling").append(newEl);

			return this;
		};

		/*
			app._request
			Generic function to do a request
			The Response can be stored in app._responses {} (this requires an identifier)
			Params:
				`identifier` - (Optional) some pre-defined requestes, e.g. school, trial, session
				`options` - (Optional)
					{
						url: (if provided, this overides the defaul for the identifier)
						withCredentials: (default true), 
						saveResponse: (default false)
					}

		*/
		app._request = function (identifier, options, success, fail) {
			var options = options || {};

			try {
				// get the url based on identifier
				var address = "";
				switch (identifier) {
					case "school":
						address =
							"https://workflow.appshed.com/webhook/1d9dadbf-b522-4a5b-9672-d04d76f93c76";
						break;

					case "trialLogs":
						address =
							"https://workflow.appshed.com/webhook/b769324f-fa9b-4e39-a779-49717e4987b6";
						break;

					case "trialRequest":
						address =
							"https://workflow.appshed.com/webhook/9d3991a2-2821-4ea9-a937-937cf5641027";
						address +=
							"?email=" +
							app.user.username +
							"&mtc_id=" +
							app.getCookieVal("mtc_id");
					// address += '&user_id=' + app.user.id;

					default:
						break;
				}

				if (options.hasOwnProperty("url")) {
					address = options.url;
				}

				// saveResponses?
				if (identifier) {
					// only save responses if we have an identifier
					options.saveResponse = options.hasOwnProperty("saveResponse")
						? options.saveResponse
						: false;
					// check _response has a key for this identifier
					if (
						options.saveResponse &&
						!app._responses.hasOwnProperty(identifier)
					) {
						app._responses[identifier] = []; // add an array to hold multiple responses
					}
				}

				// user_id   by default add the user.id to the request, make sure not already there
				var symbol = /\?/.test(address) ? "&" : "?";
				address = /user_id=/.test(address)
					? address
					: address + symbol + "user_id=" + app.user.id;

				var jqXHR = jQuery
					.ajax({
						url: address,
						xhrFields: {
							withCredentials: options.hasOwnProperty("withCredentials")
								? options.withCredentials
								: true,
						},
					})
					.done(function (a, b, c) {
						// save the data
						if (options.saveResponse) {
							app._responses[identifier].push({
								result: "done",
								a: a,
								b: b,
								c: c,
							});
						}

						// just do the callback
						if (success != null) {
							success(a, b, c);
						}
					})
					.fail(function (a, b, c) {
						console.warn(
							"ERROR this._requestTrialLogs ajax fail",
							identifier,
							options,
							this,
							a,
							b,
							c
						);

						// save the data
						if (options.saveResponse) {
							app._responses[identifier].push({
								result: "fail",
								a: a,
								b: b,
								c: c,
							});
						}

						// just do the callback
						if (fail != null) {
							fail(a, b, c);
						}
					});

				return jqXHR;
			} catch (error) {
				console.warn("ERROR this._requestTrialLogs", error);
			}

			// app.isTrEDU = true;
		};


		app.resetDevice = function (deviceId) {
			var device = this.getDevice(deviceId ? deviceId : this._defaultDevice);
			device.reset();

			return this;
		};

		app.restartDevice = function (deviceId) {
			var device = this.getDevice(deviceId ? deviceId : this._defaultDevice);
			device.restart();

			return this;
		};

		app._saveScreenData = function (id, el) {
			// Save data about the screen to localStorage
			// Return `this`

			return this;
		};

		app.scrollTo = function (x, y, time, easing, el) {
			if (!x) {
				x = 0;
			}
			if (!y) {
				y = 0;
			}
			if (!el) {
				el = jQuery(".items")[0];
			}
			if (!time) {
				time = 300;
			}

			// don't do this on appsscreen
			if (
				jQuery(".screen").length &&
				jQuery(".screen")[0].hasClass("appsscreen")
			) {
				return;
			}

			try {
				el.retrieve("scroll").iScroll.scrollTo(x, y, time, easing);
			} catch (er) {}
		};

		app.sendCommands = function (cmds, id, key, callback) {
			// Sends commands `cmds` to a `Device`
			// `cmds` expect an array of `command` arrays, where each `command` array contains 4 items: `[format,pin,value,duration]`
			// Example: Turn digital Pin 4 on for 1 second
			//		[ [1,4,1,1000] , [1,4,0,0] ]
			// Optional `id` specifies the Device ID, otherwise `_defaultDevice` is used
			// Optional `key` specidies the Pro key
			// Optional `callback` is called once the commands have been sent.
			// `callback` may be called multiple times if the number of commands being sent exceeds `Device.ioMaxCommandsPerBatch`

			this.getDevice(id, key).sendCommands(cmds, callback);

			return this;
		};

		app.setAction = function (idOrClassName, handler) {
			// Sets the action `handler` for `idOrClassName`
			// Removes all other Actions for this `idOrClassName`

			this._actions[idOrClassName] = null;
			this.addAction(idOrClassName, handler);

			return this;
		};

		app.setBackground = function (color) {
			// Shortcut for app.setBackgroundColor
			// If no `color` uses random color
			// Returns app.getBackgroundColor()

			if (!color) color = app.getRandomColor();

			return app.setBackgroundColor(color);
		};

		app.setBackgroundColor = function (color) {
			// Set the `BackgroundColor` of the current screen to `color`
			// Returns `this`
			app.getScreen().setBackgroundColor(color);

			return this;
		};

		app.setBackgroundImage = function (src, method) {
			// Set the `BackgroundIamge` of the current screen to `src`
			// Optional `method` determines the layout
			// Returns `this`

			app.getScreen().setBackgroundImage(src, method);

			return this;
		};

		app.setDefaultDevice = function (idOrProps) {
			// Sets the default device for the app.
			// `idOrProps` can pass in either the `deviceId` or a properties `Object`
			// Returns `this`

			var props = this.idOrPropsToObject(idOrProps);
			this._defaultDevice = props.id;
			this.getDevice(props);

			return this;
		};

		app.setInterval = function (func, delay, timeout, name, after) {
			// repeatedly calls a function `func` with a fixed `delay`
			// optionally stops after `timeout`
			// Optionally gives this interval a `name` which can be used by `clearInterval`
			// Optional `after` is a function to call after the timeout

			try {
				// make sure another interval is not using "name" - cancel it
				app.clearInterval(name);

				var identifier = app.addInterval(window.setInterval(func, delay), name);
				if (timeout)
					setTimeout(function () {
						app.clearInterval(identifier);
						if (after) {
							after.call();
						}
					}, timeout);
			} catch (er) {
				app.handleError(er, "app.setInterval()");
			}

			return this;
		};

		app.setLED = function (val, id) {
			// Sets the built-in LED to `val`
			// `val` can be 1/0 or ON/OFF or true/false
			// Optional `id` to use a specific `Device`
			// If no `id` passed in the default `Device` is used
			// Returns `this`

			try {
				this.getDevice(id ? id : this._defaultDevice).setLED(val);
			} catch (er) {
				this.handleError(er, "app.setLED()");
			}

			return this;
		};

		app.setLocalData = function (idOrClassName, data) {
			// returns the data array from local storage matchich idOrClassName
			var datasets = this.getLocalProperty("datasets");
			datasets[idOrClassName] = data;
			// save it back to localstorage
			this.setLocalProperty("datasets", datasets);
		};

		app.setLocalProperty = function (property, value) {
			// Saves the `value` for `property` in `localStorage` for the app
			// Returns `bool true` if successful

			var obj = this.getLocalStorage();
			obj[property] = value;

			return this.setLocalStorage(obj);
		};

		app.setLocalStorage = function (obj) {
			// Saves the `obj` to in localStorage for the app
			// `obj` must have a valid format
			//    Required: AppId (int)
			//    Required: datasets (Object)
			// Returns `bool true` if the process was successful

			try {
				if (obj && typeof obj === "object") {
					if (!isNaN(parseInt(obj.AppId))) {
						if (typeof obj.datasets === "object") {
							// obj passes all the tests
							// Save to local Storage

							localStorage["app" + this.id] = JSON.stringify(obj);

							return true;
						}
					}
				}
			} catch (er) {}
			return false;
		};

		app.setMotorDriver = function (type, id, key, callback) {
			// Sends commands `cmds` to a `Device`
			// `cmds` expect an array of `command` arrays, where each `command` array contains 4 items: `[format,pin,value,duration]`
			// Example: Turn digital Pin 4 on for 1 second
			//		[ [1,4,1,1000] , [1,4,0,0] ]
			// Optional `id` specifies the Device ID, otherwise `_defaultDevice` is used
			// Optional `key` specidies the Pro key

			this.getDevice(id, key).setMotorDriver(type, callback);

			return this;
		};

		/*
		If orientation tracking is turned on, the app redirects to https
		*/
		app.setOrientationTracking = function (state) {
			app._enableOrientationTracking = state;

			// Redirect to the secure version of the app (web app)
			if (
				state &&
				!app.isAppBuilder &&
				String(window.location.href).search(/^https/) == -1 &&
				confirm(
					"Do you want to reload the app using a secure link (https)? IoT devices will not work."
				)
			) {
				window.location.href = String(window.location.href).replace(
					/^http:/,
					"https:"
				);
			}
		};

		app.setPin = function (pinNameOrNumber, val, id, key) {
			// Sets the pin number `pinNameOrNumber` to `val`
			// Optional `id` to use a specific `Device`
			// If no `id` passed in the default `Device` is used (`IOIO` is the initial default device)

			var device = this.getDevice(id ? id : this._defaultDevice, key);

			// For IOIO use built in iot.setPin
			if (device.id == "IOIO") {
				try {
					window.appbuilder.events.iot.setPin(pinNameOrNumber, val);
				} catch (er) {
					this.handleError(er, "app.setPin() IOIO error");
				}
			} else {
				// all other devices... use Device methods
				device.setPin(pinNameOrNumber, val);
			}

			return this;
		};

		app.setRGB = function (color, pins, id, key) {
			// Sets the RGB LED to `color` (see Device.setRGB)
			// Optional `id` to use a specific `Device`
			// If no `id` passed in the default `Device` is used
			// Returns `this`

			this.getDevice(id ? id : this._defaultDevice, key).setRGB(color, pins);

			return this;
		};

		app.setTabBarBackgroundColor = function (color) {
			// Sets the `backgroundColor` of the `TabBar`  to `color`
			// Return `this`

			jQuery(".tab-bar").css("background", color);

			return this;
		};

		app.setTabBarColor = function (color) {
			// Sets the text color on the `TabBar`  to `color`
			// Return `this`

			jQuery(".tab-bar .label").css("color", color).css("text-shadow", "none");

			return this;
		};

		app.setTitleBackgroundColor = function (color) {
			// Sets the `backgroundColor` of the `Screen Title`  to `color`
			// Return `this`

			this.getScreen().setTitleBackgroundColor(color);

			return this;
		};

		app.setTitleColor = function (color) {
			// Sets the `color` of the `Screen Title`  to `color`
			// Return `this`

			this.getScreen().setTitleColor(color);

			return this;
		};

		/*
		Save an app variable
		name, val are the mandatory properties

		Extra feature: set app.prop using special format:
		name = "app_" prepended to property name
		e.g. app_version will set app.version
		*/
		app.setVariable = function (name, value, method, type) {
			//appbuilder.app.debug("api","setVariable",name,value)
			appbuilder.app.api.phone.navigator.saveVar(name, value, method, type);
			var item = document.getElement("[data-variable=" + name + "]");
			if (item) {
				item && item.set("value", value);

				// if codeflask is being used, need to update the code
				// the flask object is attached to the jQuery item element
				try {
					jQuery(item).parent().parent().data("flask").updateCode(value);
				} catch (er) {
					//console.error('app.setVariable',er);
				}
			} else if (String(name).search(/^app_/) != -1) {
				// might be an app variable
				// remove _app_ from the front
				var prop = String(name).replace(/^app_/);
				if (app.hasOwnProperty(prop)) {
					return app[prop];
				}
			}
		};

		app.setVariable_xxx = function (name, value) {
			// Set the value of the variable `name` to `value`.
			// [NOTE: the method name is setVariable without _xxx and it already exists in the built-in JavaScript library.
			//   It is included here for documentation purposes only.]
		};

		app.showAcademyLoader = function (timeout) {
			// Shows the loading element

			jQuery(".academyLoader").removeClass("invisible");

			if (timeout) {
				app.hideAcademyLoader(timeout);
			}

			return this;
		};

        app._showBlockly2Loader = function () {
            app._showBlockly2Loader("#action-target");
        }

		app._showBuilder = function () {
			// Show the Builder (which will hide courses)
			jQuery("body>.container>.row").addClass("hidden");
			jQuery("body>.container>.row.builder").removeClass("hidden");
		};

		/*
			Show the Course catalog 
			options (optional)
                options.path - the course path to load
            callback (optional) callback function (n)
        */
		app._showCourses = function (options, callback) {
			var options = options || {};
			var path = "/courses";
			var base = "https://appshed.com";

			// do we need to load a different path, based on original_hash having more than just /courses
			if (app._coursesFirstLoad) {
				app._coursesFirstLoad = false; // only happens once

				if (
					localStorage["original_hash"].match(/courses/) &&
					localStorage["original_hash"] != "#/courses"
				) {
					path = localStorage["original_hash"].replace(/#/, "");
				}
			}

			// if a path is passed in the options, this will take precendence.
			if (options.hasOwnProperty("path") && options.path.length) {
				path = options.path;
			}

			// Make sure the builder is identified
			jQuery("body>.container>.row>.span-phone").parent().addClass("builder");

			/*
                // Make sure the Course Catalog row exists
                if (jQuery('body>.container>.row.course-catalog').length == 0) {
                    jQuery('body>.container').append('<div class="row course-catalog"></div>');
                } else {
                    // If  the Catalog has content, don't load new content
                    if (jQuery('.course-catalog').children().length) {
                        //return;
                    }
                }
                */

			// Show the Courses tab in resourcepanel
			app._resourcepanelSetTab("courses");

			// Load the catalog home
			var selector = ".resourcepanel .course-catalog";
			//var sourceSelector = " main.tm-content";

			// remove sections of content we don't want (since we got the whole body)
			// only keep tm-block tm-block-default block-top-c
			// and tm-block tm-block-default

			var sourceSelector = " .tm-block.tm-block-default";

			//app._showContainerLoader();

			app._showCoursesLoad(base + path, selector, sourceSelector, callback);
		};

		// Handle the ajax load for course, to inject into page
		app._showCoursesLoad = function (href, selector, sourceSelector, callback) {
			var hash = href.replace(/.*appshed\.com/, "");
		
			// Get catalog content
			jQuery(selector).load(href + sourceSelector, null, function () {
		
				// scroll to top
				jQuery('.as-edu-popup-tab-container').animate({ scrollTop: 0 }, "fast");
		
				// callback
				try {
		
					// if External Content (Moodle edu.appshed.com)
					if(window._appjs_test){
						var extUrl = jQuery('.resourcepanel .course-catalog .pos-bottom h3:contains("External Content")').parent().text().replace(/.*External Content/s,"");
						if(extUrl.length){
							jQuery('.resourcepanel .course-catalog>.tm-block.tm-block-default:not(.block-top-c)').hide()
		
							// create iFrame 
							var iFr = jQuery('.resourcepanel .course-catalog').parent().parent().find('.as-edu-popup-iframe-container>iframe');
							iFr.data("done-styles","0")
							iFr.attr('src',extUrl).css('display','block');
							iFr.on('load',function(){
								// CSS fixes (same as below)
								iFr.contents().find('.navbar.fixed-top').remove();
								iFr.contents().find('header#page-header').remove();
								iFr.contents().find('section#region-main .activity-header').remove();
								iFr.contents().find('#page.drawers').css('margin-top','0px');
								iFr.contents().find('#topofscroll').css('padding-top','0px');
							});
		
							// try add some CSS to head of iframe
							app.setInterval(() => {
								if(iFr.contents().find('head style.resourcepanel').length == 0){ 
									iFr.contents().find('head').append('<style class="resourcepanel"> .navbar.fixed-top, header#page-header, section#region-main .activity-header {display: none;} #page.drawers, #topofscroll {margin-top: 0px; padding-top: 0px;} </style>')
		
								}
							}, 100, 3000);
							
		
		
						}
					}
		
					
					// Change all the links to load inside div
					app._fixCourseCatalogLinks(selector, sourceSelector);
					app._fixCourseDemoAppLink();
					app._hideContainerLoader();
		
					if (callback) {
						callback.call(href, selector, sourceSelector);
					}
		
					//document.dispatchEvent(app.events['ase-course-page']);
					// dispatch a custom event with some extra details
					var eventType = "ase-course-course";
					if (jQuery("#yoo-zoo>.frontpage-categories").length) {
						eventType = "ase-course-frontpage";
					} else if (jQuery("#yoo-zoo>.items").length) {
						eventType = "ase-course-category";
					}
		
					this.dispatchEvent(
						new CustomEvent(eventType, {
							detail: {
								el: this,
								href: href,
								selector: selector,
								sourceSelector: sourceSelector,
							},
							bubbles: true,
							cancelable: true,
						})
					);
				} catch (er) {
					console.error("_showCoursesLoad", er);
				}
			});
		};
		

		

		app._showCoursesAddOldAcademyLink = function () {
			// Show a link for the old academy
			if (jQuery("#academy .oldAcademyLink").length == 0) {
				// Add a label to the button that will open the Old Academy
				jQuery(
					'#academy>.header>.button.btn-courses span:contains("Courses")'
				).after(
					jQuery('<span class="oldAcademyLink">[Old Academy]</span>').click(
						function (e) {
							e.stopPropagation(); // Don't open the new Courses when this link is clicked
							jQuery("#academy>.header>.button:first").click();
						}
					)
				);
			}
		};

		app._showContainerLoader = function (timeout, msg) {
			// Show the Container Loader
			// This is a loader sitting above the container above Courses and Builder

			// Add the screen loader (sits behind the screen objects)
			if (jQuery("body>.container>.container-loader").length == 0) {
				// Add loading spinner behind screen
				jQuery("body>.container").append(
					' <div class="container-loader" style="     position: absolute;     left: 0px;     right: 0;     top: 0;     bottom: 0;     background-color: white; "><div style="width: 50%;height: 100%;margin: 156px auto;text-align: center;"><i class="icon-spinner icon-spin " style="     zoom: 6;     color: var(--gm-color-low); "></i><div class="deep-loader-text" style="margin-top: 30px; color: var(--gm-color-low);"></div></div></div>'
				);
			}

			jQuery(".container-loader").show();

			//jQuery('.screen').css('visibility','hidden');

			if (msg) {
				jQuery(".deep-loader-text").text(msg);
			}

			if (timeout) {
				app._hideContainerLoader(timeout);
			}

			return this;
		};

		app.showDeepLoader = function (timeout, msg) {
			// Show the Deep Loader
			// This is a loader sitting under the screen, so the Screen element will be hiddne
			// The normal loader sits above/on top of the screen

			// Add the screen loader (sits behind the screen objects)
			if (jQuery(".deep-loader").length == 0) {
				// Add loading spinner behind screen
				jQuery(".app-navigator").append(
					' <div class="deep-loader" style="     position: absolute;     left: 0px;     right: 0;     top: 0;     bottom: 0;     background-color: black; "><div style="width: 50%;height: 100%;margin: 156px auto;text-align: center;"><i class="icon-spinner icon-spin " style="     zoom: 6;     color: var(--gm-color-low); "></i><div class="deep-loader-text" style="margin-top: 30px; color: var(--gm-color-low);"></div></div></div>'
				);
			}

			jQuery(".deep-loader").show();

			//jQuery('.screen').css('visibility','hidden');

			if (msg) {
				jQuery(".deep-loader-text").text(msg);
			}

			if (timeout) {
				app.hideDeepLoader(timeout);
			}

			return this;
		};

		app.showLoader = function (timeout, msg) {
			// Shows the loading element
			// Optional - Hide the loader after `timeout`
			// Optional `msg` is the message to show in the loader. Default is "Loading..."
			// Returns `this`

			//document.getElementsByClassName('loader')[0].style.display = 'block';
			jQuery(".loader").each(function (index) {
				var el = jQuery(this);
				if (el.attr("id") != "logMessages") {
					el.css("display", "block");
					if (msg) {
						el.find(".text").text(msg);
					} else {
						el.find(".text").text("Loading...");
					}
				}
			});

			if (timeout) {
				app.hideLoader(timeout);
			}

			return this;
		};


        app._showLoader = function (target) {
            // Show a loader while Blockly 2 scripts load

            var target = target || "#action-target";

            app._createLoader(target);

            jQuery(target + " .appLoader").removeClass("hidden");
        };
		/*
            Show one of the main products
            Set up the UI for this product
            options (optional) - different options available for each product
                Courses:
                    see _showCourses


            callback: (optional) called when the product has loaded
        */
		app._showProduct = function (prod, options, callback) {
			// SPECIAL CASE : COURSES
			if (prod == "courses") {
				return app._showCourses(options, function () {
					app._resourcepanelMaximize();
				});
			}
			////////////////////////////////////////////

			var prod =
				prod ||
				localStorage["product"] ||
				sessionStorage["product"] ||
				"appbuilder";
			localStorage["product"] = prod;
			sessionStorage["product"] = prod;
			app.currentProduct = prod;

			// stop here if not edit environment... probably Preview or Web app
			if (!app.isAppBuilder) {
				return;
			}

			// Dispatch the event.
			document.dispatchEvent(app.events["ase-show-product-" + prod]);

			// switching between courses and apps/games requires hash changes - this is to allow page refresh to work
			/*
			if (prod == "appbuilder" || prod == "gamemaker") {
				// if changing from courses to apps/games, put the hash back
				if(window.location.hash.match(/^#\/courses/)){
					var pageHash = '#'+localStorage['currentApp']+'/'+localStorage['currentScreen'];
					window.location.assign(pageHash);
					// There's a glitch. If going to 1/1 then the app list does not reappear, so refresh required
					if(pageHash == '#1/1'){
						window.location.reload();
					}
				}
			}
			*/

			app._highlightProductLink();

			app.showDeepLoader(1000);

			// Do an animation to make it look good
			// but in case there is a problem, force visibilty after timeout
			setTimeout(() => {
				// jQuery('body>.container').css('opacity','1');
			}, 3000);

			jQuery("body>.container").animate(
				{
					opacity: 0,
				},
				null,
				null,
				function () {
					jQuery("body").removeClass("appbuilder");
					jQuery("body").removeClass("gamemaker");
					jQuery("body").removeClass("courses");
					jQuery("body").removeClass("iot");
					jQuery("body").addClass(prod);

					// do some UI changes midway through animation
					if (prod == "appbuilder") {
						app.game.stop();
						app.showTabBar();
						app.game._showItemTools();
					} else if (prod == "gamemaker") {
						app.hideTabBar();
						app.game._launchGameShowGameTools();

						//
					} else if (prod == "courses") {
						app._showCourses(options, callback);
					}

					jQuery("body>.container").animate(
						{
							opacity: 1,
						},
						null,
						null,
						function () {
							app.refreshScroll();
						}
					);
				}
			);
		};

		app.showRemoteScreen_xxx = function (url) {
			// The app will navigate to a remote screen that is loaded from `url`.
			// `url` can contain parameters in the form `{name}` that will be replaced with the value of a form `variable` with the given `name`.
			// For example url = `https://mydomain.com/myscript.php?FirstName=[myName]`
			//   This requires a form `variable` in your app with the Name `myName`
			// [NOTE: the method name is showRemoteScreen without _xxx and it already exists in the built-in JavaScript library.
			//   It is included here for documentation purposes only.]
		};

		app.showScreen_xxx = function (id) {
			// The app will navigate the screen with `id`
			// [NOTE: the method name is showScreen without _xxx and it already exists in the built-in JavaScript library.
			//   It is included here for documentation purposes only.]
		};

		/*
		showStatusMessage
		Optional `options` - Object containing options.
			options = {
				panel: "<panel_name>" - The name of the panel to open
			}
		*/
		app.showStatusMessage = function (options) {
			var options = options || {};

			var inner = jQuery("#logMessages>.inner>.scrolling");

			// Close button
			if (!jQuery("#logMessages .inner ._settingsClose").length) {
				jQuery('<div class="_settingsClose"><div>X</div></div>').appendTo(
					"#logMessages .inner"
				);
				jQuery("#logMessages .inner ._settingsClose").click(function () {
					jQuery("#logMessages").hide();
				});
			}

			// Back button
			if (!jQuery("#logMessages .inner ._settingsBack").length) {
				jQuery('<div class="_settingsBack"><div>&lt;</div></div>').appendTo(
					"#logMessages .inner"
				);
				jQuery("#logMessages .inner ._settingsBack").click(function () {
					app.showStatusMessagePanel("Settings");
				});
			}

			///////////////////
			//  Menu
			///////////////////
			if (jQuery("#logMessages ._settingsSettings").length) {
				// rebuild each time
				jQuery("#logMessages ._settingsSettings").remove();
			}
			var menu = jQuery('<div class="_settingsSettings panel"></div>');

			if (app.device && app.device.connected) {
				jQuery('<div class="link">Connected Device</div>')
					.click(function () {
						app._logMessagesSelectedDevice = app.device;
						app.showStatusMessagePanel("DeviceDetails");
					})
					.appendTo(menu);
			}
			jQuery('<div class="link">Find IoT Devices</div>')
				.click(function () {
					app.showStatusMessagePanel("Devices");
				})
				.appendTo(menu);
			jQuery('<div class="link">Orientation</div>')
				.click(function () {
					app.showStatusMessagePanel("Orientation");
				})
				.appendTo(menu);
			jQuery('<div class="link">Messages</div>')
				.click(function () {
					app.showStatusMessagePanel("Messages");
				})
				.appendTo(menu);
			jQuery('<div class="link">Console</div>')
				.click(function () {
					app.showStatusMessagePanel("Console");
				})
				.appendTo(menu);
			jQuery('<div class="link">About</div>')
				.click(function () {
					app.showStatusMessagePanel("About");
				})
				.appendTo(menu);

			inner.append(menu);

			///////////////////
			// IoT Devices
			///////////////////
			if (jQuery("#logMessages ._settingsDevices").length) {
				// rebuild each time
				jQuery("#logMessages ._settingsDevices").remove();
			}
			var devices = jQuery('<div class="_settingsDevices panel"></div>');
			inner.append(devices);

			var html = "";

			if (app.isSecure) {
				// Cannot connect to devices when secure
				html =
					'<div class="comment">The app cannot connect to IoT devices in secure mode (https). You need to switch to insecure mode (http) if you want to connect IoT devices.</div><p>&nbsp;</p>';
				if (app.isAppBuilder) {
					html +=
						'<div class="comment">IoT Mode is not supported when using AppBuilder. Publish the app and run as a web app to connect to devices.</div>';
				} else {
					html +=
						'<div class="inputContainer"><button class="switchToInsecure">Switch to IoT mode</button></div>';
				}
				html +=
					'<div class="warning">Orientation tracking will be disabled if you switch to IoT mode. Oreintation tracking cannot be done in insecure (http) URLs. It is not possible to use orientation tracking and IoT devices at the same time.</div></div><p>&nbsp;</p>';
				devices.append(html);
			} else {
				// Direct Connection
				html += '<div class="_settingsDevices_ap  box">';
				html += "<p>Direct Connection</p>";
				html +=
					'<div class="inputContainer"><button class="_localDeviceBtn green">Connect to a local device</button></div>';
				html += '<div class="inputContainer"></div>';
				html += "</div>";

				// WiFi Devices
				html += '<div class="_settingsDevices_wifi  box">';
				html += "<p>WiFi Devices</p>";
				html +=
					'<div class="inputContainer"><button class="_scanForDevices blue">Scan for WiFi devices</button><progress class="_scanForDevicesProgress" value="0" max="100" style="width: 100%; display: none;"></progress><div class="_scanForDevicesProgress_text"  style="display: none;"></div></div>';
				html += "</div>";

				//Cloud Devices
				html += '<div class="_settingsDevices_cloud  box">';
				html += "<p>Cloud Devices</p>";
				html +=
					'<div class="inputContainer"><button class="_scanForCloudDevices orange">Scan for Cloud devices</button><progress class="_scanForCloudDevicesProgress" value="0" max="100" style="width: 100%; display: none;"></progress><div class="_scanForCloudDevicesProgress_text"  style="display: none;"></div></div>';
				html += "</div>";

				devices.append(html);

				// actions for button
				jQuery("button._scanForDevices").click(function () {
					app._scanForDevices(true);
				});
				jQuery("button._scanForCloudDevices").click(function () {
					alert("No cloud devices found.");
				});
			}

			///////////////////
			// IoT Device Details
			///////////////////
			if (jQuery("#logMessages ._settingsDeviceDetails").length) {
				// rebuild each time
				jQuery("#logMessages ._settingsDeviceDetails").remove();
			}
			var devicedetails = jQuery(
				'<div class="_settingsDeviceDetails panel"></div>'
			);

			var html = '<div class="details">';
			html +=
				'<div class="_settingsDeviceDetails_connected tag"><span class="_settingsDeviceDetails_connected"></span></div>';
			html +=
				'<div class="_settingsDeviceDetails_sending tag">Sending<span class="_settingsDeviceDetails_sending"></span></div>';
			html +=
				'<div class="_settingsDeviceDetails_name" style=" margin-bottom: 10px;  font-size: large;" ></div>';

			html +=
				'<div class="_settingsDeviceDetails_chartContainer"><canvas id="_settingsDeviceDetails_chart" width="280" height="50"></canvas></div>';
			html +=
				'<div><progress class="_logMessagesSelectedDeviceProgress" value="0" max="100" style="width: 100%;"></progress></div>';
			html += '<div class="_settingsDeviceDetails_text" ></div>';
			html += "<p>&nbsp;</p>";
			html += "</div>";

			jQuery(html).appendTo(devicedetails);

			jQuery('<div class="link">Code errors</div>')
				.click(function () {
					app.showStatusMessagePanel("CodeErrors");
				})
				.appendTo(devicedetails);

			jQuery(
				'<div class="link _settingsClearAllCode">Clear all code</div>'
			).appendTo(devicedetails);

			jQuery(
				'<div class="link _settingsRebootDevice">Reboot the device</div>'
			).appendTo(devicedetails);

			jQuery('<div class="link">Configure WiFi Settings</div>')
				.click(function () {
					app.showStatusMessagePanel("ConfigureDeviceWiFi");
				})
				.appendTo(devicedetails);

			jQuery('<div class="link">Update Firmware</div>')
				.click(function () {
					app.showStatusMessagePanel("UpdateFirmware");
				})
				.appendTo(devicedetails);

			jQuery('<div class="_settingsDeviceDetails_info"></div>').appendTo(
				devicedetails
			);

			inner.append(devicedetails);

			///////////////////
			// Device Code Errors
			///////////////////
			if (jQuery("#logMessages ._settingsCodeErrors").length) {
				//jQuery('#logMessages ._settingsConfigureDeviceWiFi').remove();
			} else {
				var panel = jQuery('<div class="_settingsCodeErrors panel"></div>');

				var html = '<div class="details">';
				html += '<div class="comment"></div>';
				html += '<div class="_settingsCodeErrorDetail"></div>';
				html += "</div>";

				jQuery(html).appendTo(panel);

				inner.append(panel);
			}

			///////////////////
			// Device Configure WiFi Settings
			///////////////////
			if (jQuery("#logMessages ._settingsConfigureDeviceWiFi").length) {
				//jQuery('#logMessages ._settingsConfigureDeviceWiFi').remove();
			} else {
				var configurewifi = jQuery(
					'<div class="_settingsConfigureDeviceWiFi panel"></div>'
				);

				var html = '<div class="details">';
				html +=
					'<div class="comment"><p>You can change the WiFi settings used by the device. Enter the details below.</p></div>';
				html +=
					'<div>WiFi name (ssid): <br /><input class="_settingsConfigureDeviceWiFi_ssid"></input></div>';
				html +=
					'<div>WiFi password: <br /><input type="password" class="_settingsConfigureDeviceWiFi_password"></input></div><br />';
				html += '<div class="_settingsConfigureDeviceWiFi_button"></div>';
				html +=
					'<div class="warning">Once you save these details the device will always try to connect to the WiFi using these settings. If the device cannot join the WiFi network, you will need to connect to the device AP (WiFi access point) and reconfigure these settings.</div>';
				html += "</div>";

				jQuery(html).appendTo(configurewifi);

				inner.append(configurewifi);
			}

			///////////////////
			// Device Update Firmware
			///////////////////
			if (jQuery("#logMessages ._settingsUpdateFirmware").length) {
			} else {
				var udpatefirmware = jQuery(
					'<div class="_settingsUpdateFirmware panel"></div>'
				);

				var html = '<div class="details">';
				html +=
					'<div class="inputContainer _checkForUpdate"><button class="_checkForUpdateBtn">Check for udpates</button><progress class="_checkForUpdatesProgress" value="0" max="100" style="width: 100%; display: none;"></progress><div class="_checkForUpdatesProgress_text"  style="display: none;"></div></div>';
				html +=
					'<div class="inputContainer _doUpdate"><button class="_doUpdateBtn">Update the firmware</button><progress class="_doUpdateProgress" value="0" max="100" style="width: 100%;"></progress><div class="_doUpdateProgress_text"></div></div>';
				html +=
					'<div class="warning">Updating the firmware will change the software on the device. This provides new and updated features. Check the AppShed website for details on the new firmware.</div>';

				html += "</div>";

				jQuery(html).appendTo(udpatefirmware);

				inner.append(udpatefirmware);
			}

			///////////////////
			// Orientation
			///////////////////
			if (jQuery("#logMessages ._settingsOrientation").length) {
				//jQuery('#logMessages ._settingsOrientation').remove();
			} else {
				var orientation = jQuery(
					'<div class="_settingsOrientation panel"></div>'
				);
				inner.append(orientation);

				// Add orientation contents
				var str = "";
				// input: enableOrietnation
				str +=
					'<div class="inputContainer"><label for="_app_enableOrientationTracking" style="    line-height: 20px;    text-align: revert;    display: inline;">Enable orientation tracking</label><span style="float: right;"><input id="_app_enableOrientationTracking" type="checkbox" name="_app_enableOrientationTracking" data-variable="switch" data-save-value="yes" class="switch" value="1"></span> </div> ';
				// gyroData table
				str +=
					'<div class="gyroData">     <div class=""></div>     <div class=""></div>  <div class=""></div> <div class=""></div>  <div class=""></div> <div class=""></div> <p>&nbsp;</p> </div> ';
				// comments
				str +=
					'<div class="comment">Orientation tracking allows the app to make use of the gyro/accelerometer data.<br>This requires the app to be re-loaded in a secure URL (https).<div class="warning">IoT connectivity will be disabled if you enable orientation tracking. Device connections cannot be done in secure (https) URLs. It is not possible to use orientation tracking and IoT devices at the same time.</div></div><p>&nbsp;</p>';
				orientation.append(str);

				// Tick the box if currently tracking orientation
				if (app._enableOrientationTracking) {
					jQuery("#_app_enableOrientationTracking").each(function () {
						this.checked = true;
					});
				}
				// handle change on checkbox
				jQuery("#_app_enableOrientationTracking").change(function () {
					app.setOrientationTracking(this.checked);
				});
			}

			///////////////////
			// Messages
			///////////////////
			if (jQuery("#logMessages ._settingsMessages").length) {
				jQuery("#logMessages ._settingsMessages").remove();
			}
			var messages = jQuery('<div class="_settingsMessages panel"></div>');
			inner.append(messages);

			var str = "";
			// comment
			str +=
				'<div class="comment">Messages generated by the app appear here (e.g. errors, status, configuration).</div><p>&nbsp;</p>';

			// go through all app.log() messages
			app._log.forEach(function (e) {
				//logs += e.msg + " (" + (e.timestamp - app._log[0].timestamp) + ")<br>";logs += e.msg + " (" + (e.timestamp - app._log[0].timestamp) + ")<br>";
				str +=
					"<div>" +
					e.msg +
					" (" +
					(e.timestamp - app._log[0].timestamp) +
					")</div>";
			});

			messages.append(str);

			///////////////////
			// Console
			///////////////////
			if (jQuery("#logMessages ._settingsConsole").length) {
				//jQuery('#logMessages ._settingsConsole').remove();
			} else {
				var console = jQuery('<div class="_settingsConsole panel"></div>');
				inner.append(console);

				//
				// Add contents
				var str = "";
				// input: enableConsoleLog
				str +=
					'<div class="inputContainer"><label for="_app_enableConsoleLog" style="    line-height: 20px;    text-align: revert;    display: inline;">Enable console log</label><span style="float: right;"><input id="_app_enableConsoleLog" type="checkbox" name="_app_enableConsoleLog" data-variable="switch" data-save-value="yes" class="switch" value="1"></span> </div> ';
				// comments
				str +=
					'<div class="comment">Enable the console log to view console messages (info, warn, error and debug).<p>&nbsp;</p></div>';
				// Console output
				str += '<div class="_settingsConsoleContainer" style="display: none;">'; // start container
				str +=
					'<div class="_settingsConsoleOutput"><textarea id="_app_console" name="_app_console" style="margin: 0px 0px 10px;width: 95%;margin-bottom: 0px;border-radius: 0px;height: 210px;font-size: 11px;line-height: 11px;"></textarea></div> ';
				// Console input
				str +=
					'<div class="_settingsConsoleInput" style="    background-color: white;    color: black;    padding-left: 5px;"> > <form id="_app_consoleForm" style="margin-bottom: 0px;display: inline-block;width: 93%;"><input id="_app_consoleInput" name="_app_consoleInput" style="    border: none;    width: 85%"/><button style="color: black;float: right;width: 10% ;padding: 0px;" type="submit">&gt;</button></form></div> ';
				str += "</div> "; // End container
				console.append(str);

				// Handle enable checkbox change
				jQuery("#_app_enableConsoleLog").change(function () {
					if (this.checked) {
						jQuery("._settingsConsole>.comment").hide();
						jQuery("._settingsConsoleContainer").show();
						jQuery("#_app_console").attr("disabled", false);
						jQuery("#_app_consoleInput").attr("disabled", false);
						app._enableAppConsole();
					} else {
						jQuery("#_app_console").attr("disabled", true);
						jQuery("#_app_consoleInput").attr("disabled", true);
						app._disableAppConsole();
					}
				});

				// handle input submit
				jQuery(document).on("submit", "#_app_consoleForm", function () {
					//jQuery('#_app_consoleForm').submit(function(e) {
					try {
						eval(
							"console = window.console; " + jQuery("#_app_consoleInput").val()
						);
						//e.preventDefault();
					} catch (er) {
						console.error(er.message);
					}

					return false;
				});
			}

			///////////////////
			// About
			///////////////////
			if (jQuery("#logMessages ._settingsAbout").length) {
				//jQuery('#logMessages ._settingsAbout').remove();
			} else {
				var about = jQuery('<div class="_settingsAbout panel"></div>');
				inner.append(about);

				about.append("<div>" + "app.js version " + app.version + "</div>");
				about.append("<div>" + "Phaser version " + Phaser.VERSION + "</div>");
			}

			jQuery("#logMessages").show();

			// Open a panel
			// Default panel is Settings
			var panel = "Settings";
			if (options.hasOwnProperty("panel")) {
				panel = options.panel;

				// Special handling
				if (panel == "CodeErrors") {
					// Default device will be opened
					app._logMessagesSelectedDevice = app.getDevice();
				}
			}
			app.showStatusMessagePanel(panel);
		};

		/*
		Show the required panel in the statusMessage popup
		*/
		app.showStatusMessagePanel = function (panel) {
			jQuery("#logMessages .header .title").text(panel);
			jQuery("#logMessages ._settingsBack").hide();
			jQuery("#logMessages .panel").hide();
			jQuery("#logMessages ._settings" + panel).show();

			if (panel != "Settings") {
				jQuery("#logMessages ._settingsBack").show();
			}

			// Certain Panels have extra functionality

			// Orientation panel
			// Update the gyro data for 1 minute
			if (panel == "Orientation") {
				app.setInterval(
					function () {
						if (app._enableOrientationTracking) {
							jQuery("#logMessages .gyroData").show();

							var props = ["x", "alpha", "y", "beta", "z", "gamma"];
							jQuery.each(props, function (i, prop) {
								var val = prop + ": ";
								if (app.gyro.hasOwnProperty(prop)) {
									// 3 decimal places is sufficient
									val += parseInt(parseFloat(app.gyro[prop]) * 1000) / 1000;
								}
								jQuery(
									"#logMessages .gyroData>div:nth-child(" + (i + 1) + ")"
								).text(val);
							});
						} else {
							jQuery("#logMessages .gyroData").hide();
						}
					},
					100,
					60000
				);
			}

			// Devices panel
			if (panel == "Devices") {
				app.getDevice();

				// local device button
				jQuery("._localDeviceBtn").click(function () {
					app._logMessagesSelectedDevice = app.getDevice("local");
					app.showStatusMessagePanel("DeviceDetails");
				});

				// WiFi links
				if (Object.keys(app._devices).length) {
					Object.keys(app._devices).forEach(function (e) {
						var d = app._devices[e];

						// check if this link already exists
						if (jQuery("#_settings_device_" + d.id).length == 0) {
							var thisLink = jQuery(
								'<div class="link" id="_settings_device_' +
									d.id +
									'">' +
									(d.name && d.name > "" ? d.name : d.id) +
									"</div>"
							).click(function () {
								app._logMessagesSelectedDevice = d;
								app.showStatusMessagePanel("DeviceDetails");
							});
							// append to the appropriate div
							if (d.id == "local") {
								// This is handled by a button
								//jQuery('._settingsDevices_ap').append(thisLink);
							} else {
								jQuery("._settingsDevices_wifi").append(thisLink);
							}
						}
					});
				}
			}

			// if secure url
			jQuery("#logMessages button.switchToInsecure").click(function () {
				if (app.isSecure) {
					if (
						confirm(
							"Do you want to reload the app using an insecure link (http)? Orientation tracking will not work."
						)
					) {
						window.location.href = String(window.location.href).replace(
							/^https:/,
							"http:"
						);
					}
				}
			});

			// DeviceDetails
			if (panel == "DeviceDetails") {
				var d = app._logMessagesSelectedDevice;

				// Set this to the default device
				app.setDefaultDevice(d.id);

				// make sure the interval is not currently running
				app.clearInterval("logMessagesSelectedDevice");

				// reset all the dynamic fields
				jQuery("#logMessages ._settingsDeviceDetails_name").html("");
				jQuery("#logMessages span._settingsDeviceDetails_connected").html("");
				jQuery("#logMessages div._settingsDeviceDetails_connected").css(
					"background-color",
					"none"
				);
				jQuery("#logMessages span._settingsDeviceDetails_address").html("");
				jQuery("#logMessages ._settingsDeviceDetails_info").html("");
				jQuery("#logMessages ._logMessagesSelectedDeviceProgress").attr(
					"value",
					0
				);

				if (d) {
					var startTime = Date.now();
					var duration = 60000;

					jQuery("._settingsClearAllCode").click(function () {
						if (
							confirm(
								"Are you sure? This will clear all the Logo code currently running on the device?"
							)
						) {
							d.callFunction("clear");
						}
					});

					jQuery("._settingsRebootDevice").click(function () {
						if (confirm("Are you sure you want to reboot?")) {
							d.callFunction("restart");
						}
					});

					var chartData = [
						0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,
						0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,
					];
					var ctx = document
						.getElementById("_settingsDeviceDetails_chart")
						.getContext("2d");
					var config = {
						type: "line",
						data: {
							labels: chartData,
							datasets: [
								{
									label: "",
									steppedLine: true,
									color: "rgb(0,255,255)",
									backgroundColor: "grey",
									borderColor: "white",
									data: chartData,
								},
							],
						},
						options: {
							legend: {
								display: false,
							},
							scales: {
								xAxes: [
									{
										gridLines: {
											display: true,
										},
										ticks: {
											display: false,
										},
									},
								],
								yAxes: [
									{
										gridLines: {
											display: false,
										},
										ticks: {
											max: 1.2,
											min: 0,
											display: false,
										},
									},
								],
							},
							tooltips: {
								enabled: false,
							},
							animation: {
								duration: 0,
							},
						},
					};
					var myChart = new Chart(ctx, config);

					// Update the details for over interval
					// make sure not currently running
					app.clearInterval("logMessagesSelectedDevice");

					app.setInterval(
						function () {
							// Get the latest info (should be ready for the next update)
							d.getInfo();

							// If the DeviceDetails panel is not visible, clear this internval
							if (
								jQuery("#logMessages ._settingsDeviceDetails.panel:visible")
									.length == 0
							) {
								app.clearInterval("logMessagesSelectedDevice");
								jQuery("_settingsDeviceDetails_text").text("");
								jQuery("._logMessagesSelectedDeviceProgress").attr("value", 0);
								return;
							}

							//var now = Date.now();
							//var diff = now - startTime;
							//var percent = parseInt(diff / duration * 100);
							// Save the progress in a d property
							if (!d.hasOwnProperty("_logMessagesProgress")) {
								d._logMessagesProgress = 0;
							}
							d._logMessagesProgress++;

							// Once progress reaches 100, start again at 0
							if (d._logMessagesProgress > 100) {
								d._logMessagesProgress = 0;
							}
							var percent = d._logMessagesProgress;

							// update the chart
							var data = config.data.datasets[0].data;
							data.push(d.connected ? 1 : 0.1);
							data.shift();
							config.data.datasets[0].data = data;
							myChart.update();

							jQuery("#logMessages ._settingsDeviceDetails_name").text(d.name);
							jQuery("#logMessages span._settingsDeviceDetails_connected").text(
								d.connected ? "Connected" : "Not connected"
							);
							jQuery("#logMessages div._settingsDeviceDetails_connected").css(
								"background-color",
								d.connected ? "green" : "red"
							);
							var info = "";
							info += '<div class="_settingsDeviceDetails_variables"><table>';
							info +=
								'<tr><td>Address</td><td><a href="' +
								d.address +
								'/info" target="_blank">' +
								d.address +
								"</a></td></tr>";
							jQuery.each(d.info.variables, function (key, value) {
								info += "<tr><td>" + key + "</td><td>" + value + "</td></tr>";
							});
							info += "</table></div>";
							jQuery("#logMessages ._settingsDeviceDetails_info").html(info);
							jQuery("._logMessagesSelectedDeviceProgress").attr(
								"value",
								percent
							);
							jQuery("_settingsDeviceDetails_text").text("Updating status...");
						},
						1000,
						null,
						"logMessagesSelectedDevice",
						function () {
							/* No longer used
						jQuery('_settingsDeviceDetails_text').text('');
						jQuery('._logMessagesSelectedDeviceProgress').attr('value', 0);
						*/
						}
					);
				}
			}

			// DeviceDetails
			if (panel == "CodeErrors") {
				var d = app._logMessagesSelectedDevice;

				// clear any existing detail
				var detail = jQuery("._settingsCodeErrorDetail");
				detail.html("");

				// add all the errors
				var str = "";
				jQuery.each(d.logoErrors, function (e, errArr) {
					var thisStr = "";
					// each errArr has an array with a code and optional value
					thisStr += "<tr>";
					var msg = errArr[0];
					if (app.logoErrorMessages.hasOwnProperty(errArr[0])) {
						msg = app.logoErrorMessages[errArr[0]].short_description;
					}
					thisStr += "<td>" + msg + "</td>";
					thisStr += "<td>" + errArr[1] + "</td>";
					thisStr += "</tr>";
					// add all errors with most recent at top
					str = thisStr + str;
				});
				detail.append(
					'<table border="1"><tr><th>Error</th><th>Code/value</th></tr>' +
						str +
						"</table>"
				);

				var comment = "<p>There are no errors</p>";
				if (d.logoErrors.length) {
					comment = "<p>The code contains the following errors:</p>";
				}
				jQuery("._settingsCodeErrors .comment").html(comment);
			}

			// ConfigureDeviceWiFi
			if (panel == "ConfigureDeviceWiFi") {
				var d = app._logMessagesSelectedDevice;

				// reset all the dynamic fields
				jQuery(
					"#logMessages button._settingsConfigureDeviceWiFi_button"
				).remove();

				if (d) {
					// add the Submit button
					jQuery(
						'<button class="_settingsConfigureDeviceWiFi_button">Update WiFi Settings</button>'
					)
						.click(function () {
							// Wifi update requires build >= 58
							if (d.variables.build && parseInt(d.variables.build) >= 58) {
								if (
									confirm(
										"Are you sure you want to update the WiFi settings on the device " +
											d.name +
											"?"
									)
								) {
									var params =
										jQuery("input._settingsConfigureDeviceWiFi_ssid").val() +
										"," +
										jQuery("input._settingsConfigureDeviceWiFi_password").val();
									d.callFunction(
										"setWiFi",
										params,
										function () {
											alert(
												"WiFi settings on " +
													d.name +
													" have been updated. Restart the device to connect to the network."
											);
										},
										function () {
											alert("Could not update WiFi settings on " + d.name);
										}
									);
								}
							} else {
								// Earlier builds do not support wifi updating
								alert(
									"Your device firmware does not support WiFi configuration. Find more information at appshed.com"
								);
							}
						})
						.appendTo("#logMessages div._settingsConfigureDeviceWiFi_button");

					// make sure the interval is not currently running
					app.clearInterval("logMessagesSelectedDevice");
				}
			}

			// UpdateFirmware
			if (panel == "UpdateFirmware") {
				var d = app._logMessagesSelectedDevice;

				// reset checkForUpdate
				jQuery("progress._checkForUpdatesProgress").hide();
				jQuery("progress._checkForUpdatesProgress").attr("value", 0);
				jQuery("._settingsUpdateFirmware ._checkForUpdatesProgress_text").text(
					""
				);

				// reset doUpdate
				jQuery("._settingsUpdateFirmware .inputContainer._doUpdate").hide();
				jQuery("progress._doUpdateProgress").attr("value", 0);

				if (d) {
					// configure the button "Check for updates"
					jQuery("._settingsUpdateFirmware button._checkForUpdateBtn").click(
						function () {
							// call device function to check for udpates.
							// The device must be connected to the internet.
							// update the progress indicator
							jQuery("progress._checkForUpdatesProgress").show();
							jQuery("._checkForUpdatesProgress_text")
								.show()
								.text("Checking for updates...");

							jQuery("progress._checkForUpdatesProgress").attr("value", 1);
							app.setInterval(
								function () {
									var val = parseInt(
										jQuery("progress._checkForUpdatesProgress").attr("value")
									);
									if (val >= 100) {
										val = 0;
									} else {
										val += 2;
									}
									if (val > 0) {
										jQuery("progress._checkForUpdatesProgress").attr(
											"value",
											val
										);
									}
								},
								100,
								10500,
								"_checkForUpdatesProgress"
							);

							// Call the function on the device
							// Save the new build in a device property
							d._updateToBuild = "";
							d.callFunction(
								"updateAvailable",
								{ timeout: 10000 },
								function (data, textStatus, jqXHR) {
									if (
										data &&
										data.hasOwnProperty("return_value") &&
										data.return_value != "0"
									) {
										// progress indicator to 100
										app.clearInterval("_checkForUpdatesProgress");
										jQuery("progress._checkForUpdatesProgress").attr(
											"value",
											100
										);

										// Show the do|Update button
										jQuery(
											"._settingsUpdateFirmware .inputContainer._doUpdate"
										).show();
										jQuery("._checkForUpdatesProgress_text")
											.show()
											.text("Update found. Version " + data.return_value);
										d._updateToBuild = data.return_value;
									} else {
										jQuery("._checkForUpdatesProgress_text")
											.show()
											.text("No update available.");
									}
								},
								function () {
									// sometimes this function is called even when a new build has been found. So don't show in that case
									app.clearInterval("_checkForUpdatesProgress");
									jQuery("progress._checkForUpdatesProgress").attr(
										"value",
										100
									);
									jQuery("._checkForUpdatesProgress_text").text("");

									if (d._updateToBuild == "") {
										jQuery("._checkForUpdatesProgress_text")
											.show()
											.text("Error while checking for updates.");
									}
								}
							);
						}
					);

					// Configure the button "Do update"
					jQuery("._settingsUpdateFirmware button._doUpdateBtn").click(
						function () {
							if (
								confirm(
									"Are you sure you want to update the firmware on this device?"
								)
							) {
								if (
									prompt(
										"Please type 'yes' to confirm you want to update the firmware"
									).toLowerCase() == "yes"
								) {
									jQuery("progress._checkForUpdatesProgress").show();
									jQuery("._checkForUpdatesProgress_text")
										.show()
										.html(
											"<p>Updating the firmaware.<br />DO NOT RESET THE DEVICE...</p>"
										);

									jQuery("progress._doUpdateProgress").attr("value", 1);
									app.setInterval(
										function () {
											var val = parseInt(
												jQuery("progress._doUpdateProgress").attr("value")
											);
											if (val >= 100) {
												val = 0;
											} else {
												val += 1;
											}
											if (val > 0) {
												jQuery("progress._doUpdateProgress").attr("value", val);
											}
											// if the device has updated, then d.info should get the new build
											// after a short while, start checking for build
											if (val > 10) {
												if (
													d.connected &&
													d.variables.hasOwnProperty("build") &&
													d.variables.build == d._updateToBuild
												) {
													app.clearInterval("_doUpdateProgress");
													jQuery("._doUpdateProgress_text")
														.show()
														.html(
															"Updated firmware to " +
																d.variables.build +
																'.<p style="    font-size: 1.5em;">Update successful</p>'
														);
													jQuery("progress._doUpdateProgress").attr(
														"value",
														100
													);
												}
											}

											// When finished, and not updated...
											if (val == 0) {
												jQuery("._checkForUpdatesProgress_text")
													.show()
													.text(
														"The status of the update is unknown. On slow connections it can take a few minutes to update the device. Wait for a few minutes and then reset the device."
													);
											}
										},
										600,
										91000,
										"_doUpdateProgress"
									);

									// Call the function on the device
									d.callFunction(
										"updateFirmware",
										"",
										function (data, textStatus, jqXHR) {
											jQuery("._doUpdateProgress_text")
												.show()
												.text("Firmware update in progress...");

											// unlikely to get a success (1) return value if updating. but might get 0 if it definitely fails
											if (
												data &&
												data.hasOwnProperty("return_value") &&
												data.return_value == "0"
											) {
												jQuery("progress._doUpdateProgress").attr("value", 100);
												jQuery("._doUpdateProgress_text")
													.show()
													.text("Updating firmware failed.");
											}
										},
										function () {
											// If call function fails, it is probably busy updating
											jQuery("._doUpdateProgress_text")
												.show()
												.text("Firmware update in progress...");
										}
									);
								}
							}
						}
					);
				}
			}
		};

		app.showTab_xxx = function (id) {
			// The app will navigate the tab with `id`
			// [NOTE: the method name is showTab without _xxx and it already exists in the built-in JavaScript library.
			//   It is included here for documentation purposes only.]
		};

		app.showTabBar = function (id) {
			// Show the tab bar (if it is hidden)
			// Returns `this`

			// skip if appsscreen
			if (jQuery(".screen.appsscreen").length) {
				return this;
			}
			try {
				var tb = jQuery(".tab-bar");
				tb.show();
				/*
						var an = jQuery(".app-navigator");
						an.css("top",this._app_navigatorTop);
						an.css("bottom",this._app_navigatorBottom);
						an.css('height',jQuery(".app").css('height'));
				*/
				var an = jQuery(".app-navigator");
				an.css("top", "");
				an.css("bottom", "");
				an.css("height", "");
			} catch (er) {}

			return this;
		};

		/*
            Show a "toast" message. 
            This is a simple notification that appears briefly at the top of the screen then dissappears.
            options
                top, left, right, bottom
                selector - the element to attach to
                delay - how long to show (5000)
                no_out: (default: false) If true it will remain on screen
		*/
		app.showToastMessage = function (msg, options, callback) {
			var options = options || {};
			var thisId = "as-toast-" + Date.now(); // get a uniqueish id using timestamp

			var cssText =
				"position: fixed; ;padding: 10px;background-color: var(--gm-blue);color: white;line-height: 16pt;z-index: 2000;border: 1px solid white;border-radius: 10px;text-align: center;font-size: 10pt;";

			// position either left or right
			if (options.hasOwnProperty("left")) {
				cssText += "left: " + options.left + "px;";
			} else {
				cssText += "right: " + (options.right || 50) + "px;";
			}
			// position either top or bottom
			if (options.hasOwnProperty("bottom")) {
				cssText += "bottom: " + options.bottom + "px;";
			} else {
				cssText += "top: " + (options.top || -100) + "px;";
			}

			// width must include px or %
			cssText += "width: " + (options.width || "90%") + ";";

			var aDiv = document.createElement("div");
			aDiv.style.cssText = cssText;
			aDiv.className = "as-toast-container";
			aDiv.innerHTML = msg;
			aDiv.id = thisId;
			aDiv.onclick = function (event) {
				// remove the cursor if it's clicked
				jQuery(this).remove();
				event.stopPropagation();
			};

			//document.body.appendChild(aDiv)
			jQuery(options.selector || "body").append(aDiv);

			// animate in,
			var chgCSS = {};
			if (options.hasOwnProperty("animate_in_bottom")) {
				chgCSS.bottom = options.animate_in_bottom;
			} else {
				chgCSS.top = options.animate_in_top || 10;
			}

			jQuery("#" + thisId).animate(chgCSS, 500);

			// animate out
			chgCSS = {};

			if (options.hasOwnProperty("animate_out_bottom")) {
				chgCSS.bottom = options.animate_out_bottom;
			} else {
				chgCSS.top = options.animate_out_top || -100;
			}

			setTimeout(function () {
				if (options.hasOwnProperty("no_out") && options.no_out) {
					// no out animation
				} else {
					jQuery("#" + thisId).animate(chgCSS, 500, null, function () {
						jQuery(this).remove();
					});
				}
			}, options.delay || 5000);
		};

		/*
			_showWebAppContent
			Adds the landing pages, DWC and ads to web apps

		*/
		app._showWebAppContent = function () {
			// stop here if not Web app
			if (!app.isWebApp) {
				return;
			}
		};

		/*
		Starts the gyro orientation tracking
		*/
		app._startOrientationTracking = function (freq) {
			gyro.frequency = freq || 200;

			// Stop tracking in case already running
			app._stopOrientationTracking();

			if (
				gyro.hasFeature("deviceorientation") ||
				gyro.hasFeature("devicemotion")
			) {
				gyro.startTracking(function (o) {
					// save variables in the app
					app.gyro = o;
				});
			}
		};

		/*
		_startSocketListener
		Start the socket listener for various topics
		*/
		app._startSocketListener = function () {
			try {
				if (app.socket && app.socket.connected) {
					app.socket.on("cloud-variable-changed", (...args) => {
						// get all cloud variables - look for the presence of data-variable attribute
						jQuery(
							'.item.option-cloud-variable [data-variable="' +
								args[0].name +
								'"]'
						).each(function () {
							var jItem = jQuery(this).parent().parent();
							var item = app.getItem(jItem.attr("id"));
							var name = item.getVariableName();

							// turn off any input events
							item.jQuery.off("input");

							// Set the variable with the broadcast value
							app.setVariable(args[0].name, args[0].value);

							// Start the emitter again
							// NB NB NB NB NB NB NB NB NB NB NB NB
							// This code exists in ANOTHER LOCATION - change both places
							item.jQuery.on("input", function () {
								app.socket.emit("cloud-variable-changed", {
									appId: app.id,
									name: name,
									value: event.target.value,
									fromUser: app.getUser().getId(),
									fromApp: app.id,
								});
							});
						});
					});
				}
			} catch (error) {
				console.error("app._startSocketListener", error);
			}
		};

		app._stopOrientationTracking = function () {
			gyro.stopTracking();
		};

		app.stopLoops = function () {
			// Stop all the loops

			app._loopFunctions = [];

			return this;
		};

		app.togglePin = function (pinNameOrNumber, id) {
			// Toggles the pin `pinNameOrNumber`
			// Optional `id` to use a specific `Device`
			// If no `id` passed in the default `Device` is used (`IOIO` is the initial default device)

			var device = this.getDevice(id ? id : this._defaultDevice);

			// For IOIO use built in iot.togglePinValue
			if (device.id == "IOIO") {
				try {
					window.appbuilder.events.iot.togglePinValue(pinNameOrNumber);
				} catch (er) {
					this.handleError(er, "app.togglePin() IOIO error");
				}
			} else {
				device.togglePin(pinNameOrNumber);
			}
		};

		app.togglePinValue = function (pinNameOrNumber, id) {
			// Override method for `togglePin`
			return this.togglePin(pinNameOrNumber, val, id);
		};

		app.toRGB = function (color) {
			// Returns an object with `r,g,b` properties for the supplied `color'
			// `color` must be a 6 character Hexadecimal
			// If `color` is already an rgb object, return it

			if (
				typeof color === "object" &&
				color.hasOwnProperty("r") &&
				color.hasOwnProperty("g") &&
				color.hasOwnProperty("b")
			)
				return color;

			var obj = {};

			color.match(/[A-Za-z0-9]{2}/g).map(function (v, index) {
				switch (index) {
					case 0:
						obj.r = parseInt(v, 16);
						break;
					case 1:
						obj.g = parseInt(v, 16);
						break;
					case 2:
						obj.b = parseInt(v, 16);
						break;
				}
			});

			return obj;
		};

		app.toRGBInt = function (color) {
			// Returns the RGB integer value for `color`
			// `color` can be hex color or RGB object

			color = this.toRGB(color);

			return 256 * 256 * color.r + 256 * color.g + color.b;
		};

		/*
			app.updateState
			Updates the app state properties, e.g. app.isEDUUser and many others
		*/
		app.updateState = function (options) {
			// Check if EDU User
			// Look for a menu dropdown for App Gallery ... this determines if it is an EDU user
			if (jQuery(".navbar-fixed-top .dropdown .icon-appshed-apps").length) {
				app.isEDUUser = true;
				jQuery("body").addClass("edu-user");

				// Check if teacher or student
				if (
					jQuery(".navbar-fixed-top .dropdown .icon-appshed-student").length
				) {
					app.isEDUTeacher = true;
					jQuery("body").addClass("edu-teacher");
				} else {
					app.isEDUStudent = true;
					app.isEDUActive = true; // Let's presume the student is active, but might not be, needs API call to check
					jQuery("body").addClass("edu-student");
				}
			} else {
				app.isStarter = true;
				jQuery("body").addClass("not-edu-user");
			}

			//Check if EDU unpaid (for teachers and admin)
			// look for a link to /pending in the navbar
			if (
				jQuery(
					'.navbar li.dropdown ul.dropdown-menu a:contains("Dashboard")'
				).attr("href") == "/appbuilder/academy/pending"
			) {
				app.isEDUPending = true;
				app.isEDUUnpaid = true; //maybe the payment has not been processed, but need to treat as unpaid
				app.isEDUActive = false;
				jQuery("body").addClass("expired-edu-user");
			} else if (
				jQuery(
					'.navbar li.dropdown ul.dropdown-menu a:contains("Dashboard")'
				).attr("href") == "/appbuilder/academy"
			) {
				app.isEDUUnpaid = false;
				app.isEDUActive = true;
			}

			// Check EDU referrer pages
			if (app.isEDUUser) {
				// if they came from the "pay" page, (not for students)
				if (/appbuilder\/academy\/pay/.test(document.referrer)) {
					if (app.isEDUActive === false) {
						app.isEDUIncomplete = true; // they  skipped putting in payment details
					} else {
						app.isEDUIncomplete = false; // they must have paid then (probably, need to check!)
					}
				}

				// if they came from the "pending" page, (not for students)
				if (/appbuilder\/academy\/pending/.test(document.referrer)) {
					app.isEDUIncomplete = false; // they must have compledted the payment details
				}
			}

			// Check if Active EDU (for Teacher only)
			if (
				app.isEDUTeacher &&
				app.isEDUUnpaid !== true &&
				app.isEDUIncomplete !== true
			) {
				app.isEDUActive = true; // seems they have an active EDU
				app.isEDUUnpaid = false;
				app.isEDUIncomplete = false;
			}

			// Check if Admin User
			// Look for a menu dropdown for Admin Tools... preceeded by wrench

			if (jQuery('.dropdown .dropdown-toggle:contains("Admin Tools")').length) {
				app.isAdminUser = true;
				jQuery("body").addClass("admin-user");
			} else {
				jQuery("body").addClass("not-admin-user");
			}
		};

		/**
		 * Displays a warning message in AppBuilder.
		 *
		 * @method warn
		 * @param {string} msg The text to show the user
		 * @param {number} type (default 0) Warnings fall into different types (see app.warnings)
		 * @param {string} er Optional: Error message to show in the console
		 * @param {array} itemIds A list of item IDs to highlight for this warning
		 */

		app.warn = function (type, msg, er, itemIds) {
			var type = type || 0;

			// For each type, show a general comment for this type of warning
			// only show this warning message the first time
			if (app.warnings[type].count == 0) {
				app.log(app.warnings[type].initial);
			}

			app.warnings[type].count++;

			// add to the app log
			app.log(app.warnings[type].name + ": " + msg, itemIds);

			// optional show in console
			if (er && er.length) {
				console.error("app.warn", type, msg, itemIds, er);
			}

			// Go through the affected Items
			if (itemIds && Array.isArray(itemIds)) {
				jQuery.each(itemIds, function (i, val) {
					// add css class to the item matching the warning
					var jItem = jQuery("#item" + val);
					jItem.addClass("warnings").addClass("warning" + type);

					// make sure it has a warnings container (do this only once for each item)
					if (jItem.find(".warnings-container").length == 0) {
						jQuery(
							'<div class="warnings-container"><a href="javascript: return null;" title="There is an error with this item. Edit the item to see error messages."><img class="warnings-image" src="https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/warningsgif.gif	" width="20" height="18"></a><div class="warnings-msgs"></div></div>'
						)
							.click(function (event) {
								alert(
									"There is an error with this item. Edit the item to see error messages."
								);
								event.stopPropagation();
							})
							.prependTo(jItem);
					}
				});
			}
		};

		// Item Object Item Class Item
		app.Item = function (id) {
			this.id = id;
			this.element = null; // HTML DOM element for this Item
			this.jQuery = null; // a jQuery object for the DOM lement
			this.domId = "";
			this.hoverImage = null; // Image to display when hovering over this item (our touchover)
			this.game = {}; // Hold various game parameters relating to this Item
			this.onHoverDoActions = false;
			this.originalImage = null;
			this.type = null;

			try {
				this.domId = "item" + this.id;
				this.element = document.getElementById(this.domId);
				this.jQuery = jQuery(this.element);

				if (this.jQuery.hasClass("plain")) this.type = "plain";
				if (this.jQuery.hasClass("thumb")) this.type = "thumb";
				if (this.jQuery.hasClass("image")) this.type = "image";
				if (this.jQuery.hasClass("icon")) this.type = "icon";
				if (this.jQuery.hasClass("html")) {
					// might be Styled Text or Text item
					if (this.jQuery.hasClass("text")) this.type = "text";
					else this.type = "html";
				}
				if (this.jQuery.hasClass("textbox")) this.type = "textbox";
				if (this.jQuery.hasClass("textarea")) this.type = "textarea";
				if (this.jQuery.hasClass("select")) this.type = "select";
				if (this.jQuery.hasClass("button")) this.type = "button";
				if (this.jQuery.hasClass("switch")) this.type = "switch";
				if (this.jQuery.hasClass("checkbox")) this.type = "checkbox";
				if (this.jQuery.hasClass("radio")) this.type = "radio";
				if (this.jQuery.hasClass("picker")) this.type = "picker";
				if (this.jQuery.hasClass("capture")) this.type = "capture";
			} catch (er) {
				app.handleError(er, "Item.init()");
			}

			this.init = function (element) {
				this.element = document.getElementById(this.domId);
				this.jQuery = jQuery(this.element);
			};

			this.addAction = function (handler) {
				// Add an `Action` for this `Item`
				// `handler` is a function name or adhoc function
				// `Items` can contain multiple actions. The AppBuilder defines only the default action
				// returns `this`

				app.addAction(this.id, handler);

				return this;
			};

			this.addBefore = function () {};

			this.callActions = function () {
				// calls all actions for this `Item`
				// The default Action is set in AppBuilder
				// Additional Actions can be set using `app.addAction()`
				// Actions can be identified using the `itemId`, `DOM id`, and all `Classnames`
				// Returns `this`

				// if the screen is being scrolled, don't call actions
				try {
					if (
						document.getElementsByClassName("items")[0].retrieve("scroll")
							.iScroll.moved
					) {
						return false;
					}
				} catch (er) {
					return false;
				}

				// remove any existing .glow elements on the screen
				jQuery(".item .glow").remove();

				// set the currentId so this item can retrieve itself using app.getItem()
				app._currentItemId = this.id;

				// Sound actions can't be called async from JavaScript, so play the <audio> element created by preloadAduioItems
				if (app.getItem().jQuery.data("linktype") == "sound") {
					// play the <audio>
					jQuery("#" + this.domId + "_audio")[0].play();
				} else {
					// call the default action
					appbuilder.app.api.phone.navigator.click(null, this.element);
				}

				if (app._actions[this.id]) this.callEachAction(app._actions[this.id]);

				if (app._actions[this.domId])
					this.callEachAction(app._actions[this.domId]);

				// for each class, call actions
				if (this.element && this.element.classList) {
					for (var i = 0; i < this.element.classList.length; i++) {
						if (app._actions[this.element.classList.item(i)])
							this.callEachAction(app._actions[this.element.classList.item(i)]);
					}
				}
				return this;
			};

			this.callEachAction = function (arr) {
				// Loops through `arr` and calls the action for each element
				if (arr && arr.length) {
					for (var i = 0; i < arr.length; i++) arr[i].call();
				}
			};

			this.click = function () {
				// Simulate the user clicking on the item
				this.callActions();
				return this;
			};

			this.containsClass = function (className) {
				// Returns true if this `Item` contains the custom class `className`

				return this.element.classList.contains(className);
			};

			this.getActionJavaScript = function () {
				// Returns the JavaScript code that will run when the action is called

				var code = "";
				try {
					if (this.jQuery.data("linktype") == "jscode") {
						code =
							appbuilder.app.api.phone.navigator.screenObj.javascripts[
								this.domId
							];
					} else if (this.jQuery.data("linktype") > "") {
						// Get the code using callActions()

						// TODO This is not very efficient... Better to get the JavaScript equivalent for the action
						// if the linktype is tab or screen (i.e. navigating away from the game) then stop the game.
						if (["tab", "screen"].contains(this.jQuery.data("linktype"))) {
							code += "app.game.stop(); ";
						}
						code += "app.getItem('" + this.domId + "').callActions();\n";
					}
				} catch (err) {
					console.error("Item.getActionJavaScript", err);
				}

				return code;
			};

			this.getBackgroundColor = function () {
				// Returns the `backgroundColor` of this `Item`

				return this.element.style.backgroundColor;
			};

			this.getDefaultValue = function () {
				// Return the `Default Value` for this item

				// Check the actual HTML code to see get the original value set in AppBuilder... the value="" will hold the Default Value
				if (String(this.element.outerHTML).match(/.* value="\d+".*/)) {
					thisVal = String(this.element.outerHTML);
					thisVal = thisVal.replace(/.* value="(\d+)".*/, "$1");
					if (thisVal > "") {
						return thisVal;
					}
				}
				return "";
			};

			this.getIconAbove = function () {
				// returns the icon in the row above this icon
				return app.getScreen().getIconAbove(this.id);
			};

			this.getIconBelow = function () {
				// returns the icon in the row above this icon
				return app.getScreen().getIconBelow(this.id);
			};

			this.getIconLeft = function () {
				// returns the icon on the left of this icon
				return app.getScreen().getIconLeft(this.id);
			};

			this.getIconRight = function () {
				// returns the icon on the right of this icon
				return app.getScreen().getIconRight(this.id);
			};

			this.getImage = function () {
				// returns the URL of the image for this item
				return app.findClass(this.element, "image").src;
			};

			this.getInputElement = function () {
				// return the DOM element for the input field, if present
				if (this.type == "textbox") {
					return this.jQuery.find("input.textbox")[0];
				}
				if (this.type == "select") {
					return this.jQuery.find("span.selected")[0];
				}
				if (this.type == "textarea") {
					return this.jQuery.find("textarea.textarea")[0];
				}
			};

			this.getLargeImage = function () {
				// If the Image is compressed, the URL of the larger source image is returned
				var img = this.getImage();
				if (img.match(/fit-in/)) {
					// get the id number from end of string
					img = img.replace(/.*?(\d+)$/, "$1");
					// create the  https url for the source image
					img = "https://d3s8dljl1bm5rz.cloudfront.net/" + img;
				}
				return img;
			};

			this.getPosition = function () {
				// Returns an object with the x,y coordinates of the item
				// This is only relevant when the item has been placed using `this.place()`;
				var obj = {};
				obj.x = parseFloat(String(this.element.style.left).replace("/D/g", ""));
				obj.y = parseFloat(String(this.element.style.top).replace("/D/g", ""));

				return obj;
			};

			this.getSubTitle = function (str) {
				//Returns the `Subtitle` of the item

				try {
					return app.findClass(this.element, "text").innerText;
				} catch (er) {
					app.handleError(er, "Item.getSubTitle()");
				}
				return null;
			};

			this.getText = function (str) {
				//Returns the `Text` of the item

				try {
					return app.findClass(this.element, "text").innerText;
				} catch (er) {
					// the text might be in a 'html' class
					try {
						return app.findClass(this.element, "html").innerText;
					} catch (er2) {
						app.handleError(er + ", " + er2, "Item.getText()");
					}
				}
				return null;
			};

			this.getTitle = function (str) {
				//Returns the `Title` of the item

				try {
					return app.findClass(this.element, "title").innerText;
				} catch (er) {
					app.handleError(er, "Item.getText()");
				}
				return null;
			};

			this.getVariable = function () {
				// Returns `app.getVariable()` if this Item is a `Form Item`

				if (this.isFormItem()) {
					return app.getVariable(this.getVariableName());
				}

				return null;
			};

			this.getVariableName = function () {
				// Returns the `variable name` if this is a `Form Item`

				var rVal = null;

				if (this.isFormItem()) {
					jQuery(this.element)
						.find(app._formItemCSSSelector)
						.each(function (index) {
							// If there is no dataset.variable, it is not an Item so skip
							if (
								this.dataset.variable &&
								this.dataset.variable != "undefined"
							) {
								rVal = this.dataset.variable;
							}
						});
				}

				return rVal;
			};

			this.hide = function () {
				// Hide this `Item`
				// Returns `this`

				jQuery(this.element).hide();

				return this;
			};

			this.isFormItem = function () {
				// Returns `true` if this is a `Form Item`

				for (var i = 0; i < app._formItemTypes.length; i++) {
					if (
						this.element &&
						this.element.classList &&
						this.element.classList.contains(app._formItemTypes[i])
					) {
						return true;
					}
				}

				return false;
			};

			this.isAbove = function (otherId) {
				// returns true this item is above the other Item
				try {
					return app.getItem(otherId).getIconAbove().id == this.id;
				} catch (er) {
					return false;
				}
			};

			this.isBelow = function (otherId) {
				// returns true this item is below the other Item
				try {
					return app.getItem(otherId).getIconBelow().id == this.id;
				} catch (er) {
					return false;
				}
			};

			this.isFormItemType = function () {
				// return true if this is a type of Form Item
				var cl = app.getItem().element.className;
				if (
					cl.search(/textbox/) >= 0 ||
					cl.search(/textarea/) >= 0 ||
					cl.search(/select/) >= 0 ||
					cl.search(/button/) >= 0 ||
					cl.search(/switch/) >= 0 ||
					cl.search(/checkbox/) >= 0 ||
					cl.search(/radio/) >= 0 ||
					cl.search(/picker/) >= 0 ||
					cl.search(/capture/) >= 0
				) {
					return true;
				}
				return false;
			};

			this.isLeft = function (otherId) {
				// returns true this item is left of the other Item
				try {
					return app.getItem(otherId).getIconLeft().id == this.id;
				} catch (er) {
					return false;
				}
			};

			this.isRight = function (otherId) {
				// returns true this item is right of the other Item
				try {
					return app.getItem(otherId).getIconRight().id == this.id;
				} catch (er) {
					return false;
				}
			};

			this.place = function (x, y) {
				// place the item at a certain absolute x,y position

				try {
					if (this.element) {
						this.element.style.position = "absolute";
						this.element.style.left = parseInt(x) + "px";
						this.element.style.top = parseInt(y) + "px";
					}
				} catch (er) {
					app.handleError(addscrer, "Item.place()");
				}

				return this;
			};

			this.setAction = function (handler) {
				// Sets the `Action` for this `Item`
				// `handler` is a function name or adhoc function
				// returns `this`

				app.setAction(this.id, handler);

				return this;
			};

			this.setBackgroundColor = function (color) {
				//set the background color of this Item to `color`
				// Special case: `color` is `'random'` will get a random color.
				try {
					if (!color || color == "random") color = app.getRandomColor();
					this.element.style.backgroundColor = color;
				} catch (er) {
					app.handleError(er, "Item.setBackgroundColor()");
				}
				return this;
			};

			this.setBackgroundImage = function (src, method) {
				// Sets the `backgroundImage` of this `Item` to `src`.
				// Optional `method` determines the layout
				// One of: `fit` | `fill` | `stretch` | `center` | `tile`
				// `method` defaults to `fit`

				if (!method) method = "fill";

				var items = this.element;

				items.style.backgroundImage = "url('" + src + "')";
				items.style.backgroundRepeat = "no-repeat";
				items.style.backgroundPosition = "center center";

				if (method == "fill") items.style.backgroundSize = "cover";
				else if (method == "stretch") items.style.backgroundSize = "100% 100%";
				else if (method == "center")
					items.style.backgroundSize =
						items.style.height + "px " + items.style.width + "px";
				else if (method == "tile") {
					items.style.backgroundSize =
						items.style.height + "px " + items.style.width + "px";
					items.style.backgroundRepeat = "repeat";
				} else items.style.backgroundSize = "contain";

				return this;
			};

			this.setHTML = function (str) {
				//set the value of Html to `str`
				try {
					app.findClass(this.element, "html").innerHTML = str;
				} catch (er) {
					app.handleError(er, "Item.setHTML()");
				}
				return this;
			};

			this.setImage = function (src) {
				//set the image URL to `src`
				if (this.type == "plain") {
					this.jQuery.find(".icon").first().attr("src", src);
				} else {
					this.jQuery.find(".image").first().attr("src", src);
				}
				//					app.findClass(this.element,"image").src = src;
				return this;
			};

			this.setImageID = function (id) {
				//set the image ID to `id`
				// Presumes that the current image src points to the
				// This keeps the same URL host and path - useful when using on web app offline which uses local images

				this.setImage(
					String(this.getImage()).replace(/(.*?)(\d+)$/, "$1" + id)
				);

				return this;
			};

			this.setInputBackgroundColor = function (color) {
				//set the background color of the input field to `color`
				// Special case: `color` is `'random'` will get a random color.
				try {
					if (!color || color == "random") color = app.getRandomColor();
					this.getInputElement().style.backgroundColor = color;
				} catch (er) {
					app.handleError(er, "Item.setBackgroundColor()");
				}
				return this;
			};

			this.setInputTextColor = function (color) {
				//set the color of Text to `color`
				this.getInputElement().style.color = color;

				return this;
			};

			this.setLabel = function (str) {
				//set the value of Label to `str`
				try {
					app.findClass(this.element, "button").innerHTML = str;
				} catch (er) {
					app.handleError(er, "Item.setLabel()");
				}
				return this;
			};

			this.setLabelColor = function (color) {
				//set the color of Label to `color`
				try {
					app.findClass(this.element, "button").style.color = color;
				} catch (er) {
					app.handleError(er, "Item.setLabelColor()");
				}

				return this;
			};

			this.setSubTitle = function (str) {
				//set the value of Sub Title to `str`
				app.findClass(this.element, "text").innerHTML = str;
				return this;
			};

			this.setSubTitleColor = function (color) {
				//set the color of SubTitle to `color`
				try {
					app.findClass(this.element, "text").style.color = color;
				} catch (er) {
					app.handleError(er, "Item.setSubTitleColor()");
				}

				return this;
			};

			this.setText = function (str) {
				//set the value of Text to `str`

				try {
					app.findClass(this.element, "text").innerHTML = str;
				} catch (er) {
					// the text might be in a 'html' class
					try {
						app.findClass(this.element, "html").innerHTML = str;
					} catch (er2) {
						app.handleError(er + ", " + er2, "Item.setText()");
					}
				}

				return this;
			};

			this.setTextColor = function (color) {
				//set the color of Text to `color`
				try {
					app.findClass(this.element, "text").style.color = color;
				} catch (er) {
					// the text might be in a 'html' class
					try {
						app.findClass(this.element, "html").style.color = color;
					} catch (er2) {
						// the text might be in a 'title' class
						try {
							app.findClass(this.element, "title").style.color = color;
						} catch (er2) {
							app.handleError(er + ", " + er2, "Item.setTextColor()");
						}
					}
				}

				return this;
			};

			this.setTitle = function (str) {
				//set the value of Title to `str`
				try {
					app.findClass(this.element, "title").innerHTML = str;
				} catch (er) {
					app.handleError(er, "Item.setTitle()");
				}
				return this;
			};

			this.setTitleColor = function (color) {
				//set the color of Title to `color`
				try {
					app.findClass(this.element, "title").style.color = color;
				} catch (er) {
					app.handleError(er, "Item.setTitleColor()");
				}

				return this;
			};

			this.show = function () {
				// Show this `Item`
				// Returns `this`

				jQuery(this.element).show();

				return this;
			};

			this.swap = function (otherId) {
				// swaps this icon with the other
				try {
					var parentNode = this.element.parentNode;
					var thisClone = this.element.cloneNode(true);
					var otherItem = app.getItem(otherId);
					var otherParent = otherItem.element.parentNode;
					var otherClone = otherItem.element.cloneNode(true);
					parentNode.replaceChild(otherClone, this.element);
					otherParent.replaceChild(thisClone, otherItem.element);

					app.addScreenClickHandlers();

					return this;
				} catch (er) {
					app.handleError(er, "Item.swap()");
				}
			};

			this.toString = function () {
				//returns a string representation of the object
				return "AppShed Object: Item (" + this.id + ")";
			};
		};

		// Screen Object
		app.Screen = function (id) {
			this.id = id;
			this.element = null;
			this.jQuery = null; // a jQuery object for the DOM lement
			this.domId = "";

			this.data; // Data object for this screen
			this.items = {};
			this.icons = {};

			this.originalBackgroundImage;

			try {
				this.domId = "screen" + this.id;
				this.element = document.getElementById(this.domId);
				this.jQuery = jQuery(this.element);
			} catch (er) {
				app.handleError(er, "Screen.init()");
			}

			this.addIconRow = function (rowHTML, index, data) {
				// Adds a row of `Icons` by inserting `rowHTML` into the table
				// `index` specifies the row where to insert. Defaults to -1 (bottom of the table)
				// If `rowHTML` is ommitted then the HTML is generated using `data`
				// `data` contains the values to be used for the Icons.

				if (this.getType() == "icon") {
					if (!index) index = -1;
					if (!rowHTML) rowHTML = this.getIconRowHTML(null, null, data);

					this.getTable().insertRow(index).outerHTML = rowHTML;

					this.clearItemsCache();
				}

				return this;
			};

			this.addIconRows = function (numRows, data) {
				// adds numRows rows of icons
				// Uses `data` to populate the rows

				if (this.getType() == "icon") {
					for (var i = 0; i < numRows; i++) {
						// get the data for this row if it exists
						var thisData = data && data[i] ? data[i] : {};
						// add the default if it exists
						if (data && data["default"]) thisData["default"] = data["default"];

						this.addIconRow(null, null, thisData);
					}
				}

				return this;
			};

			this.addItem = function (data) {
				// Adds an `Item` to the `Screen`
				// `data` (optional) An object containing the values to be used for the Item.
				//    All properties are optional
				//    {
				//    	id: <A unique integer to be used as the ItemId>,
				//    	type: <The `Item type 'text','image','link','thumb' etc`>,
				//    	image: <The image URL>,
				//    	title: <Item title>,
				//    	text: <Item text>,
				//    	html: <The html to be used for this item>,
				//    	value: <The value for a form field>,
				//    	action: <The JavaScript action>,
				//    	afterId: <Insert the `Item` after an item with this `id` (deafult added to bottom)>,
				//    	beforeId: <Insert the `Item` before this>,
				//    	template: <The idOrClassName of the item to use as a template for the new item.>
				//    	   Must be on the current screen.
				//    	   If a template is supplied, the following properties are set by the template:
				//    	      type
				//    	      beforeId (by default the item is added before the template)
				//    }

				var data = data || {};
				var template;
				var id = this.getNextId();
				if (data.id) {
					id = data.id;
				} else {
					data.id = id;
				}

				if (data && data.template) {
					template = app.getItem(data.template);
				}

				if (this.getType() == "list") {
					var type = "thumb";
					if (data && data.type) {
						type = data.type;
					}
					if (template) {
						type = template.type;
					}

					var html = "";
					if (template) {
						// get html from template and replace properties with data
						html = app.replaceItemHTML(template.element.outerHTML, data);
					} else if (data && data.html) {
						html = app.replaceItemHTML(data.html, data);
					} else {
						html = app.getItemHTML(id, type, data);
					}

					var beforeId = null;
					if (template) {
						beforeId = template.id;
					}
					if (data && data.beforeId) {
						beforeId = data.beforeId;
					}
					var added = false;
					if (beforeId) {
						var sibling = app.getItem(beforeId);
						if (sibling && sibling.element) {
							jQuery(sibling.element).before(html);
							added = true;
						}
					} else if (data && data.afterId) {
						var sibling = app.getItem(data.afterId);
						if (sibling && sibling.element) {
							jQuery(sibling.element).after(html);
							added = true;
						}
					}
					if (!added) {
						jQuery(".items-inner").append(html);
					}

					var newItem = app.getItem(id);
					// remove the 'template' class
					if (template) {
						jQuery(newItem.element).removeClass("template");
					}

					if (data && data.action) {
						newItem.setAction(data.action);
						jQuery(newItem.element).click(function () {
							app.getItem(app.getIdFromDOMId(this.id)).callActions();
						});
					}

					// add the on-change event handler to form items to make sure app variables work properly
					if (newItem && newItem.isFormItem()) {
						jQuery(newItem.element)
							.find(":input")
							.change(function () {
								var jEl = jQuery(this);
								app.setVariable(jEl.attr("name"), jEl.val());
							});
					}

					this.clearItemsCache();
				} else if (this.getType() == "icon") {
					if (!index) index = -1;
					if (!rowHTML) rowHTML = this.getIconRowHTML(null, null, data);

					this.getTable().insertRow(index).outerHTML = rowHTML;

					this.clearItemsCache();
				}

				setTimeout(function () {
					app.refreshScroll();
				}, 100);

				return this;
			};

			this.clearItemsCache = function () {
				// Clears the `items` hash (local cache)
				this.items = {};
			};

			this.containsClass = function (className) {
				// Returns true if this `Screen` contains the custom class `className`

				return this.element.classList.contains(className);
			};

			this.countColumns = function () {
				// Returns the number of columns (for Icon screen types)
				if (this.getType() == "icon") {
					return this.getTable().rows[0].cells.length;
				}
			};

			this.disableScroll = function () {
				// Disables the defult scrolling of the screen.
				// All the content is at fixed position, and content below the fold remains hidden.
				// Returns `this`

				this.element
					.getElementsByClassName("items")[0]
					.retrieve("scroll")
					.disable();

				// To do this using event handler on the screen
				// app.phone.addEvent('screen',function(id,screen){
				//  	screen.getElement('.items').retrieve('scroll').disable();
				// });

				return this;
			};

			this.enableScroll = function () {
				// Enables the defult scrolling of the screen.
				// Returns `this`

				this.element
					.getElementsByClassName("items")[0]
					.retrieve("scroll")
					.enable();
				return this;
			};

			this.getBackgroundColor = function () {
				// Returns the `backgroundColor` of this `Screen`

				var items = app.findClass(this.element, "items");

				return items.style.backgroundColor;
			};

			this.getData = function () {
				// Returns the Data object for this screen

				if (!this.data) this.data = new AppShedData(this.id);

				return this.data;
			};

			this.getIconAbove = function (iconId) {
				// returns the icon in the row above this icon

				var icons = this.getIcons();

				for (var r in icons) {
					var cells = icons[r];

					for (var c in cells) {
						if (icons[r][c].id == iconId) {
							r = parseInt(r);
							if (r > 0) return icons[r - 1][c];
						}
					}
				}
			};

			this.getIconBelow = function (iconId) {
				// returns the icon in the row below this icon

				var icons = this.getIcons();
				var rowKeys = Object.keys(icons);

				for (var r in icons) {
					var cells = icons[r];

					for (var c in cells) {
						if (icons[r][c].id == iconId) {
							r = parseInt(r);
							if (r < rowKeys.length - 1) return icons[r + 1][c];
						}
					}
				}
			};

			this.getIconLeft = function (iconId) {
				// returns the icon on the left of this icon

				var icons = this.getIcons();

				for (var r in icons) {
					var cells = icons[r];

					for (var c in cells) {
						if (icons[r][c].id == iconId) {
							c = parseInt(c);
							if (c > 0) return icons[r][c - 1];
						}
					}
				}
			};

			this.getIconRight = function (iconId) {
				// returns the icon on the left of this icon

				var icons = this.getIcons();

				for (var r in icons) {
					var cells = icons[r];
					var cellKeys = Object.keys(cells);

					for (var c in cells) {
						if (icons[r][c].id == iconId) {
							c = parseInt(c);
							if (c < cellKeys.length - 1) return icons[r][c + 1];
						}
					}
				}
			};

			this.getIconRowHTML = function (idStart, cols, data) {
				// returns the HTML for a row of (cols) Icons

				if (!cols) cols = this.countColumns();

				if (!idStart) idStart = this.getNextId();

				var rVal = "<tr>";

				for (var i = 0; i < cols; i++) {
					var thisData =
						data && data[i]
							? data[i]
							: data && data["default"]
							? data["default"]
							: null;
					rVal += app.getItemHTML(idStart + i, "icon", thisData);
				}
				rVal += "</tr>";

				return rVal;
			};

			this.getIcons = function () {
				// Returns an object of items
				// The object has rows and columns corresponding to the icons on the screen
				// Returns `null` if not an `Icons` screen

				if (this.getType() != "icon") return null;

				this.icons = {};

				try {
					var rows = this.getTable().getElementsByTagName("tr");

					for (var r = 0; r < rows.length; r++) {
						var cObj = {};
						var cells = rows[r].getElementsByTagName("td");

						for (var c = 0; c < cells.length; c++) {
							cObj[c] = app.getItemByDomId(cells[c].id);
						}

						this.icons[r] = cObj;
					}
				} catch (er) {
					app.handleError(er, "Screen.getIcons()");
				}

				return this.icons;
			};

			this.getItems = function (clearCache) {
				// return all the items on this screen as objects

				if (clearCache) this.clearItemsCache();

				// by default, use the cached items collection
				if (Object.keys(this.items).length) return this.items;

				// loop through all elements of a certain class name
				var elements = this.element.getElementsByClassName("item");

				for (var i = 0; i < elements.length; i++) {
					// ignore new-item-placeholder
					if (!elements[i].classList.contains("new-item-placeholder")) {
						var item = app.getItemByDomId(elements[i].id, elements[i]);
						this.items[item.id] = item;
					}
				}

				return this.items;
			};

			this.getLocalProperty = function (property) {
				// Returns the value for `property` from `localStorage` for this screen

				return this.getLocalStorage()[property];
			};

			this.getLocalStorage = function () {
				// Returns the object stored in localStorage for this screen

				if (typeof localStorage[this.id] == "undefined")
					localStorage[this.id] = JSON.stringify({
						ScreenId: this.id,
						data: [],
					});

				return JSON.parse(localStorage[this.id]);
			};

			this.getNextId = function (testId) {
				// Returns the next valid (unused) `id`. Used when creating `Items` dynamically.
				// The first ID for a screen is the Screen.id + 1
				try {
					if (!testId) testId = +this.id + 1;

					var items = this.getItems();
					var keys = Object.keys(items);

					if (!keys.length) return testId;
					else {
						// check if we can use testId
						// otherwise increment and test again

						var items = this.getItems();
						for (var i in items) {
							if (items[i].id == testId) return this.getNextId(testId + 1);
						}
						// if we get here, testId is not an existing id on this screen
						return testId;
					}
				} catch (er) {
					app.handleError(er, "Screen.getNextId()");
				}
			};

			this.getTable = function () {
				// Returns the HTML `table` element (for `Icon` screen types)
				if (this.getType() == "icon")
					return this.element.getElementsByTagName("table")[0];
			};

			this.getTitle = function (str) {
				// Returns the `Title` of the screen

				var header = app.findClass(this.element, "header");
				return app.findClass(header, "title").innerText;
			};

			this.getType = function () {
				// Returns the type of `Screen` (`list`,`icon`,`gallery`,`map`)

				var classes = this.element.classList;

				if (classes.contains("list")) return "list";
				if (classes.contains("icon")) return "icon";
				if (classes.contains("gallery")) return "gallery";
				if (classes.contains("map")) return "map";

				return "";
			};

			this.setBackgroundColor = function (color) {
				// Sets the `backgroundColor` of this `Screen` to `color`

				if (!color || color == "random") color = app.getRandomColor();

				var items = app.findClass(this.element, "items");

				items.style.backgroundImage = "none";
				items.style.backgroundColor = color;

				return this;
			};

			this.setBackgroundImage = function (src, method) {
				// Sets the `backgroundImage` of this `Screen` to `src`.
				// Special case: if `src` is omitted, sets the background to the original background image
				// Optional `method` determines the layout
				// One of: `fit` | `fill` | `stretch` | `center` | `tile`
				// `method` defaults to `fit`

				if (!method) method = "fill";

				if (!src && this.originalBackgroundImage > "")
					src = this.originalBackgroundImage;

				var items = app.findClass(this.element, "items");

				// first time, save original
				if (!this.originalBackgroundImage)
					this.originalBackgroundImage = String(items.style.backgroundImage)
						.replace(/.*\s?url\([\'\"]?/, "")
						.replace(/[\'\"]?\).*/, "");

				items.style.backgroundImage = "url('" + src + "')";
				items.style.backgroundRepeat = "no-repeat";
				items.style.backgroundPosition = "center center";

				if (method == "fill") items.style.backgroundSize = "cover";
				else if (method == "stretch") items.style.backgroundSize = "100% 100%";
				else if (method == "center")
					items.style.backgroundSize =
						items.style.height + "px " + items.style.width + "px";
				else if (method == "tile") {
					items.style.backgroundSize =
						items.style.height + "px " + items.style.width + "px";
					items.style.backgroundRepeat = "repeat";
				} else items.style.backgroundSize = "contain";

				return this;
			};

			this.setLocalProperty = function (property, value) {
				// Saves the `value` for `property` in `localStorage` for this screen
				// Returns `bool true` if successful

				var obj = this.getLocalStorage();
				obj[property] = value;

				return this.setLocalStorage(obj);
			};

			this.setLocalStorage = function (obj) {
				// Saves the `obj` to in localStorage for this screen
				// `obj` must have a valid format
				//    Required: ScreenId (int)
				//    Required: data (Array)
				// Returns `bool true` if the process was successful

				try {
					if (obj && typeof obj === "object") {
						if (!isNaN(parseInt(obj.ScreenId))) {
							if (Array.isArray(obj.data)) {
								// obj passes all the tests
								// Save to local Storage

								localStorage[this.id] = JSON.stringify(obj);

								return true;
							}
						}
					}
				} catch (er) {}
				return false;
			};

			this.setTitle = function (str) {
				// Sets the `Title` of the screen to `str`.
				// Returns the `Screen` object

				jQuery(this.element).find(".header .title span").text(str);

				return this;
			};

			this.setTitleBackgroundColor = function (color) {
				// Sets the `backgroundColor` of this `Screen Title`  to `color`

				var header = app.findClass(this.element, "header");

				header.style.backgroundImage = "none";
				header.style.backgroundColor = color;

				return this;
			};

			this.setTitleColor = function (color) {
				// Sets the `backgroundColor` of this `Screen Title`  to `color`

				jQuery(".header .title").css("color", color);

				return this;
			};

			this.toString = function () {
				// Returns a string represenation of the `Screen`
				return "AppShed Object: Screen (" + this.id + ")";
			};
		};

		/*
            AppShed Automation
            
            ASA Object AppShed Automation Object ASA Class
            Handles automation features such as 
                Feature Tour: automated walkthrough of various features
                Virtual Assistant: shows a user how to complete a certain task
                Guided Learning: learn faster with guided prompts and mini challenges with hints
                Product Marketing 'demideo': demo 'video' to showcase key features in a constant loop
                Lead nurturing: provide guided app building without registration
                EDU Dashboard: track student progress through Guided Learning and other ASA experiences
        */



	
		app.asa = {
			// PROPERTIES
		
			// SET LOWER asas: null, // empty, will be filled from localStorage or _defaultAsas
			_clickDuration: 2000,
			currentASA: null, // holds the refernce to the ASA being processed. Used for ASE events
			currentStep: null, // holds the current step
		
			templates: {
				// holds various templates for the ASA
				// this is the main master template. ASAs are checked against this to make sure they are valid
				main: {
					key: "",
					title: "", // title of the ASA - to show users. This also appears in links
					description: "", // Full description (HTML)
					state: 100,
					options: {
						can_pause: false, // if true, the ASA can be paused. Steps have minimize button
						max_restarts: -1, // The maximum times the ASA can be restarted. -1 is indefinite. 0 means no restarts, it will only run once
						can_manual_start: false, // If true, then the ASA can be started by calling the start() method. These will also be listed in app.appendASALinks() . If false, it should only launch when the launch conditions occurr.
					},
					data: {
						// store dynamic data for each instance
						cursor: {
							// the last cursor position
							x: -1,
							y: -1,
						},
					},
					steps: [
						{
							key: "template",
							state: 100,
							delay: {
								before_action: 0, // wait before running the action
								before_cursor: 0, // wait before starting the cursor animation
								after_action: 0, // wait before setting done after the action
								before_message: 0, // mandatory, >= 0
								before_auto: 0, // if no action, and not manual, wait before auto done
								before_highlight: 0, // wait before doing the highlight element
							},
							next: {
								text: "", // text to show for the Next button. Default "Next >"
								manual: true,
								allow_auto: false, // if true, then a manual next can be replaced with automatic if the user choose to auto-all
								code: "", // Code to run when the next button is clicked. This will run after the step is marked as Done
							},
							secondary: {
								// The secondary call-to-action in the footer of the MessageBox
								show: false, // by default the Secondary link does  appear
								text: "[ Exit ]",
								code: "", // The default code (not shown) will reset the ASA
							},
							footer: {
								// content to show in the footer area
								show: false, // by default not shown
								text: "", // text or HTML content
							},
							action: {
								type: "code", // type of action: code, set_field ...
								code: "", // JavaScript code for type=code
								auto_populate: true, // for action.type "set_field"
							},
							message: {
								modal: false, // true if the message box must be modal
								width: 300,
								aspect_ratio: "", // Various aspect ratios are supported
								keep_visible: false, // if true the message remains visible once the step is done
		
								anchor_target: "", // selector for the element where this will be anchored
								anchor_position: {
									// the position on the message box where to anchor
									x: "left", // left or right (like CSS)
									y: "top", // top or bottom
								},
								target_position: {
									// the position on the target box where to anchor
									x: "right", // left or right (like CSS)
									y: "top", // top or bottom
								},
								anchor_offset: {
									// (optional) offset the anchor position by these amounts
									x: 0,
									y: 0,
								},
								source: {
									// 1st look for source: remote source URL for HTML content
									all: "",
									starter: "",
									pro: "",
									student: "",
									teacher: "",
									admin: "",
									instructor: "",
								},
								dwc: {
									// then look for DWC - slot name to get the content
									all: "",
									starter: "",
									pro: "",
									student: "",
									teacher: "",
									admin: "",
									instructor: "",
								},
								text: {
									// then use text or HTML content
									all: "",
									starter: "",
									pro: "",
									student: "",
									teacher: "",
									admin: "",
									instructor: "",
								},
							},
							arrow: {
								show: false, // should the arrow appear
								keep_visible: false, // if true the element remains visible once the step is done
								placement: "top", // on which part of the box should the arrow be placed: options are top,right, bottom, left
								side: "left", // to which edge must it be achnored, top, right, bottom, left
								offset: "30px", // how far from the edge should it be placed. Can be px or %, include the symbol, e.g "30px" or "50%"
							},
							highlight: {
								show: false, // should an element be highlighted, default false
								keep_visible: false, // if true the element remains visible once the step is done
								selector: "", // a jQuery selctor for the element to highlight. If multiple elements are matched, the first match will be used.
								background: "", // the background CSS rule for the highlight
								border: "2px solid white", // the border CSS rule for the highlight
							},
							trigger: {
								event_name: "",
								condition: "", // (optional) code that must evaluate to true for this step to run. This gives more granular control, so when the event occurs, other conditions can be checked.
								prompt: "", // this message is displayed when the user tries to "start" or unpause the ASA but the trigger or trigger condition are not valid.
							},
							skip: {
								condition: "", // code that must evaluate to true to skip this step
							},
							cursor: {
								// (optional) settings to control the ASA virtual cursor (not the actual mouse cursor)
								show: false, // true will show the ASA cursor at this step
								duration: 1000, // milliseconds for the animation. if 0 there will be no animation
								start: {
									// (optional) the start position. if omitted, it will start from the last position if exists, or center of the screen
									click: false, // if true show the click animation
									x: -1,
									y: -1,
									selector: "", // a DOM selector for the element where the cursor will start. The center of the element will be used.
								},
								end: {
									// the end position. if omitted, it will end at the target_position of the anchor_target (if exists)
									click: false, // if true show the click animation
									x: -1,
									y: -1,
									selector: "", // a DOM selector for the element where the cursor will end. The center of the element will be used.
								},
							},
							data: {
								message_wrapper_id: "",
							},
						},
					],
				},
			},
		
			_defaultAsas: null, // DEPRECATED... set asas to the default array below
			asas: [
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
				//                           DEFAULT ASAs
		
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
				{
					key: "tour-courses",
					title: "Tour: AppShed Courses",
					description:
						"A quick tour of the AppShed Courses. See where you can access courses, what's available, and how to start learning.",
					state: 100,
					options: {
						can_pause: true,
						can_manual_start: true,
					},
					steps: [
						{
							key: "start",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 800,
								aspect_ratio: "16-9",
								text: {
									all: "TEMP",
								},
								source: {
									old_corsall: "https://cors.appshed.com/?u=https://content.appshed.com/asa-tour-courses-start", // [data-slot-container='1']"
									all: "https://content.appshed.com/asa-tour-courses-start",
								},
							},
							trigger: {
								event_name: "asa-start-tour-courses",
							},
						},
		
						{
							key: "course-buttons-1",
							state: 100,
							next: {
								manual: false,
							},
							highlight: {
								show: true,
								selector: "li#product-link-courses",
								keep_visible: true,
								background: "white",
							},
							message: {
								width: 300,
								keep_visible: true,
								text: {
									all: "Courses can be accessed from here",
								},
								anchor_target: "li#product-link-courses",
								anchor_position: {
									x: "left",
									y: "top",
								},
								target_position: {
									x: "left",
									y: "bottom",
								},
								anchor_offset: {
									x: -30,
									y: 20,
								},
							},
							arrow: {
								show: true,
								placement: "top",
								side: "left",
								offset: "50px",
							},
						},
		
						{
							key: "course-buttons-3",
							state: 100,
							highlight: {
								show: true,
								selector:
									".resourcepanel .as-edu-popup-header li[data-tab='courses']",
								border: "none",
							},
							message: {
								width: 300,
								modal: true,
								text: {
									all: "Or here. <br>Click Next to see the Course Catalog",
								},
								anchor_target:
									".resourcepanel .as-edu-popup-header li[data-tab='courses']",
								anchor_position: {
									x: "right",
									y: "top",
								},
								target_position: {
									x: "left",
									y: "bottom",
								},
								anchor_offset: {
									x: 100,
									y: 10,
								},
							},
							arrow: {
								show: true,
								placement: "top",
								side: "right",
								offset: "50px",
							},
						},
						{
							key: "click-product-courses",
							state: 100,
							next: {
								manual: false,
							},
							action: {
								code: "app._showProduct('courses')",
							},
							delay: {
								before_action: 2500, // wait before running the action
								before_cursor: 0, // wait before starting the cursor animation
								after_action: 0, // wait before setting done after the action
								before_message: 0, // mandatory, >= 0
								before_auto: 3000, // if no action, and not manual, wait before auto done
								before_highlight: 0, // wait before doing the highlight element
							},
							cursor: {
								show: true,
								duration: 1000,
								start: {
									click: false,
									x: 800,
									y: 300,
								},
								end: {
									click: true,
									selector: "#product-link-courses",
								},
							},
						},
		
						{
							key: "course-categories",
							state: 100,
							delay: {
								before_message: 1000, // mandatory, >= 0
								before_highlight: 1000, // wait before doing the highlight element
							},
							message: {
								modal: true, // true if the message box must be modal
								width: 300,
								text: {
									all: "Here are the course categories.<br>Click Next to see some of the 'Coding' courses.",
								},
								anchor_target: ".as-edu-popup .course-catalog", // .yoo-zoo .frontpage-categories
								anchor_position: {
									x: "left",
									y: "bottom",
								},
								target_position: {
									x: "left",
									y: "top",
								},
								anchor_offset: {
									x: 200,
									y: -10,
								},
							},
							arrow: {
								show: true,
								placement: "bottom",
								side: "left",
								offset: "50%",
							},
							highlight: {
								show: true,
								selector: ".as-edu-popup .course-catalog",
								background: "white",
							},
							trigger: {
								event_name: "ase-course-frontpage",
								condition:
									" jQuery('.yoo-zoo .frontpage-categories').length > 0",
							},
						},
		
						{
							key: "click-category-coding",
							state: 100,
							next: {
								manual: false,
							},
							action: {
								code: "jQuery(\".category .description a[title='Coding']\").click() ",
							},
							delay: {
								before_action: 2500, // wait before running the action
								before_cursor: 0, // wait before starting the cursor animation
								after_action: 0, // wait before setting done after the action
								before_message: 0, // mandatory, >= 0
								before_auto: 3000, // if no action, and not manual, wait before auto done
								before_highlight: 0, // wait before doing the highlight element
							},
							cursor: {
								show: true,
								duration: 1000,
								start: {
									click: false,
									x: -1,
									y: -1,
									selector: "",
								},
								end: {
									click: true,
									x: -1,
									y: -1,
									selector: ".category .description a[title='Coding']",
								},
							},
						},
		
						{
							key: "show-coding-course",
							state: 100,
							highlight: {
								show: false,
								selector:
									'.teaser-item:contains("Blockly Lesson 1: Simple Calculator")',
								background: "white",
							},
							message: {
								width: 300,
								modal: false,
								text: {
									all: "Let's give this Blockly lesson a try",
								},
								anchor_target:
									'.teaser-item:contains("Blockly Lesson 1: Simple Calculator")',
								anchor_position: {
									x: "left",
									y: "bottom",
								},
								target_position: {
									x: "left",
									y: "top",
								},
								anchor_offset: {
									x: 0,
									y: -20,
								},
							},
							arrow: {
								show: true,
								placement: "bottom",
								side: "left",
								offset: "50%",
							},
							trigger: {
								event_name: "ase-course-category",
								condition:
									" jQuery('.teaser-item:contains(\"Blockly Lesson 1: Simple Calculator\")').length > 0",
							},
						},
		
						{
							key: "scroll-to-blockly",
							state: 100,
							next: {
								manual: false,
							},
							delay: {
								before_action: 500,
							},
							action: {
								code: "app.asa.scrollTo('.teaser-item:contains(\"Blockly Lesson 1: Simple Calculator\")')",
							},
						},
						{
							key: "click-coding-course",
							state: 100,
							next: {
								manual: false,
							},
							action: {
								code: "jQuery('.teaser-item a:contains(\"Blockly Lesson 1: Simple Calculator\")').click() ",
							},
						},
		
						{
							key: "course-buttons-3",
							state: 100,
							next: {
								text: "Done",
							},
							message: {
								width: 300,
								modal: true,
								text: {
									all: "You can try out the app on the right,<br>Or start the course yourself.",
								},
							},
							trigger: {
								event_name: "ase-course-course",
							},
						},
					],
				},
		
				{
					key: "tour-edu",
					title: "Tour: EDU Features",
					description:
						"A quick tour of the EDU Features of AppShed. Helps teachers get a feel for how AppShed can be used effectively as a teaching tool.",
					state: 100,
					options: {
						can_pause: true,
						can_manual_start: true,
					},
					steps: [
						{
							key: "start",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 600,
								aspect_ratio: "16-9",
								text: {
									all: "<img src='/images/ASA/edu-tour/EDUASAGIF1.gif' width='600' height='316' />",
								},
							},
							trigger: {
								event_name: "asa-start-tour-edu",
							},
							action: {
								code: "window.scroll(0,0)",
							},
							next: {
								text: "Show me",
							},
						},
		
						{
							key: "show-me-dashboard",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 300,
								text: {
									all: "All of the EDU features can be found here. These include...",
								},
								anchor_target:
									'.navbar-fixed-top ul.nav>li:contains("Dashboard")',
								anchor_position: {
									x: "left",
									y: "top",
								},
								target_position: {
									x: "left",
									y: "bottom",
								},
								anchor_offset: {
									x: 0,
									y: 15,
								},
							},
							arrow: {
								show: true,
								placement: "top",
								side: "left",
								offset: "30px",
							},
							highlight: {
								show: true,
								selector: '.navbar-fixed-top ul.nav>li:contains("Dashboard")',
								background: "white",
							},
						},
		
						{
							key: "slide2",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 600,
								aspect_ratio: "16-9",
								text: {
									all: "<img src='/images/ASA/edu-tour/EDUASAGIF2.gif' width='600' height='316' />",
								},
							},
						},
						{
							key: "slide3",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 600,
								aspect_ratio: "16-9",
								text: {
									all: "<img src='/images/ASA/edu-tour/EDUASAGIF3.gif' width='600' height='316' />",
								},
							},
						},
						{
							key: "slide4",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 600,
								aspect_ratio: "16-9",
								text: {
									all: "<img src='/images/ASA/edu-tour/EDUASAGIF4.gif' width='600' height='316' />",
								},
							},
						},
						{
							key: "slide5",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 600,
								aspect_ratio: "16-9",
								text: {
									all: "<img src='/images/ASA/edu-tour/EDUASA5.png' width='600' height='316' />",
								},
							},
						},
		
						{
							key: "asa-edutour-end-form",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 600,
								aspect_ratio: "16-9",
								dwc: {
									all: "asa-edutour-end-form",
								},
							},
							next: {
								text: "Close",
							},
						},
					],
				},
		
				{
					key: "hint-resourcepanel-expand",
					title: "Hint: Resource Panel Expand",
					description: "",
					state: 100,
					options: {
						max_restarts: 0,
					},
					steps: [
						{
							key: "start",
							state: 100,
							message: {
								modal: false, // true if the message box must be modal
								width: 200,
								XXXaspect_ratio: "16-9",
								text: {
									all: "Courses are best viewed full-screen. Click the 'expand' icon to expand the Resource Panel.",
								},
								anchor_target:
									".resourcepanel .as-edu-header-controls .as-edu-maximize",
								anchor_position: {
									x: "right",
									y: "top",
								},
								target_position: {
									x: "right",
									y: "bottom",
								},
								anchor_offset: {
									x: 20,
									y: 10,
								},
							},
							arrow: {
								show: true,
								placement: "top",
								side: "right",
								offset: "20px",
							},
							trigger: {
								event_name: "ase-course-course",
								xxx_event_name: "asa-start-hint-resourcepanel-expand",
							},
							action: {
								code: "window.scroll(0,0)",
							},
							next: {
								text: "OK",
							},
						},
					],
				},
		
				
				{
					key: "verify-email",
					title: "Verify Email",
					description:
						"Guide you through the process to verify your email address",
					state: 100,
					options: {
						can_pause: true,
					},
					steps: [
						{
							key: "start123",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 800,
								aspect_ratio: "16-9",
								dwc: {
									all: "asa-verify-email", 
								},
							},
							trigger: {
								event_name: "verify-email",
							},
							next: {
								text: "Close",
							},
						},
					]
		
				},
		
		
		
				
				{
					key: "invalid-email",
					title: "Invalid Email",
					description:
						"You need to provide a valid email address",
					state: 100,
					options: {
						can_pause: true,
					},
					steps: [
						{
							key: "start123",
							state: 100,
							message: {
								modal: true, // true if the message box must be modal
								width: 600,
								aspect_ratio: "16-9",
								text: {
									all: "TEMP",
								},
								dwc: {
									all: "asa-invalid-email", 
								},
							},
							trigger: {
								event_name: "invalid-email",
							},
							next: {
								text: "Close",
							},
						},
					]
		
				},
		
		
		
		
		
		
		
		
				{
					key: "prompt-first-app",
					title: "Create your first app",
					description:
						"Prompt to click on the button to create your first app",
					state: 100,
					options: {
						can_pause: false,
						max_restarts: 0,
					},
					steps: [
						{
							key: "start",
							state: 100,
							trigger: {
								event_name: "ase-popup-loaded-apps-screen",
								condition: "app._popupContainerType == 'apps-screen' && jQuery('.phone .apps-inner>.item').length == 0"
							},
							delay: {
								before_auto: 3000, // wait before running the action
							},
							next: {
								text: "", // text to show for the Next button. Default "Next >"
								manual: false,
								allow_auto: true, // if true, then a manual next can be replaced with automatic if the user choose to auto-all
							},
						},
						{
							key: "popup",
							state: 100,
							message: {
								modal: false, // true if the message box must be modal
								width: 300,
								text: {
									all: "Click here to create your first app",
								},
								anchor_target: ".home-bar .app-icon.newapp",
								anchor_position: {
									// the position on the message box where to anchor
									x: "left", // left or right (like CSS)
									y: "bottom", // top or bottom
								},
								target_position: {
									// the position on the target box where to anchor
									x: "left", // left or right (like CSS)
									y: "top", // top or bottom
								},
								anchor_offset: {
									// (optional) offset the anchor position by these amounts
									x: -20,
									y: -70,
								},
							},
							next: {
								text: "Close", 
							},
							arrow: {
								show: true, // should the arrow appear
								keep_visible: false, // if true the element remains visible once the step is done
								placement: "bottom", // on which part of the box should the arrow be placed: options are top,right, bottom, left
								side: "left", // to which edge must it be achnored, top, right, bottom, left
								offset: "30px", // how far from the edge should it be placed. Can be px or %, include the symbol, e.g "30px" or "50%"
							},
							highlight: {
								show: true, // should an element be highlighted, default false
								keep_visible: false, // if true the element remains visible once the step is done
								selector: ".home-bar .app-icon.newapp>.image", // a jQuery selctor for the element to highlight. If multiple elements are matched, the first match will be used.
								background: "", // the background CSS rule for the highlight
								border: "2px solid white", // the border CSS rule for the highlight
							},
						},
		
					],
				},
		
		
				{
					key: "prompt-first-toolbox",
					title: "Introducing the Toolbox",
					description:
						"Prompt to introduce the toolbox.",
					state: 100,
					options: {
						can_pause: false,
						max_restarts: 0,
					},
					steps: [
						{
							key: "start",
							state: 100,
							trigger: {
								event_name: "ase-popup-loaded-appbuilder_tools_list",
							},
							delay: {
								before_auto: 1000, // wait before running the action
							},
							next: {
								text: "", // text to show for the Next button. Default "Next >"
								manual: false,
								allow_auto: true, // if true, then a manual next can be replaced with automatic if the user choose to auto-all
							},
						},
						{
							key: "popup",
							state: 100,
							message: {
								modal: false, // true if the message box must be modal
								width: 300,
								text: {
									all: "This is the Toolbox. Add things to your app: tabs, screens, various items, form elements etc.",
								},
								anchor_target: "#popup-container>.toolbox",
								anchor_position: {
									// the position on the message box where to anchor
									x: "left", // left or right (like CSS)
									y: "top", // top or bottom
								},
								target_position: {
									// the position on the target box where to anchor
									x: "left", // left or right (like CSS)
									y: "top", // top or bottom
								},
								anchor_offset: {
									// (optional) offset the anchor position by these amounts
									x: 80,
									y: 80,
								},
							},
							next: {
								text: "Close", 
							},
							highlight: {
								show: true, // should an element be highlighted, default false
								keep_visible: false, // if true the element remains visible once the step is done
								selector: "#popup-container>.toolbox", // a jQuery selctor for the element to highlight. If multiple elements are matched, the first match will be used.
								background: "var(--as-bg-light)", // the background CSS rule for the highlight
								border: "2px solid white", // the border CSS rule for the highlight
							},
						},
		
					],
				},
		
		
		
		
		
				{
					key: "prompt-first-edit",
					title: "Adding and editing items",
					description:
						"Introduces the edit panel.",
					state: 100,
					options: {
						can_pause: false,
						max_restarts: 0,
					},
					steps: [
						{
							key: "start",
							state: 100,
							trigger: {
								event_name: "ase-popup-loaded-edit_item",
							},
							delay: {
								before_auto: 1000, // wait before running the action
							},
							next: {
								text: "", // text to show for the Next button. Default "Next >"
								manual: false,
								allow_auto: true, // if true, then a manual next can be replaced with automatic if the user choose to auto-all
							},
						},
						{
							key: "popup",
							state: 100,
							message: {
								modal: false, // true if the message box must be modal
								width: 200,
								text: {
									all: "This is the Edit Panel. You can add text and images and edit properties.",
								},
								anchor_target: "#edit_item",
								anchor_position: {
									// the position on the message box where to anchor
									x: "right", // left or right (like CSS)
									y: "top", // top or bottom
								},
								target_position: {
									// the position on the target box where to anchor
									x: "left", // left or right (like CSS)
									y: "top", // top or bottom
								},
								anchor_offset: {
									// (optional) offset the anchor position by these amounts
									x: -20,
									y: 50,
								},
							},
							next: {
								text: "Next", 
							},
							highlight: {
								show: true, // should an element be highlighted, default false
								keep_visible: false, // if true the element remains visible once the step is done
								selector: ".popup-loaded", // a jQuery selctor for the element to highlight. If multiple elements are matched, the first match will be used.
								background: "white", // the background CSS rule for the highlight
								border: "2px solid grey", // the border CSS rule for the highlight
							},
							arrow: {
								show: true, // should the arrow appear
								keep_visible: false, // if true the element remains visible once the step is done
								placement: "right", // on which part of the box should the arrow be placed: options are top,right, bottom, left
								side: "top", // to which edge must it be achnored, top, right, bottom, left
								offset: "20px", // how far from the edge should it be placed. Can be px or %, include the symbol, e.g "30px" or "50%"
							},
						},
						{
							key: "other-tabs",
							state: 100,
							message: {
								modal: false, // true if the message box must be modal
								width: 300,
								text: {
									all: "Check out these other tabs for advanced settings.",
								},
								anchor_target: ".popup-loaded .nav-tabs",
								anchor_position: {
									// the position on the message box where to anchor
									x: "left", // left or right (like CSS)
									y: "top", // top or bottom
								},
								target_position: {
									// the position on the target box where to anchor
									x: "left", // left or right (like CSS)
									y: "bottom", // top or bottom
								},
								anchor_offset: {
									// (optional) offset the anchor position by these amounts
									x: 150,
									y: 5,
								},
							},
							next: {
								text: "Close", 
							},
							arrow: {
								show: true, // should the arrow appear
								keep_visible: false, // if true the element remains visible once the step is done
								placement: "top", // on which part of the box should the arrow be placed: options are top,right, bottom, left
								side: "left", // to which edge must it be achnored, top, right, bottom, left
								offset: "30px", // how far from the edge should it be placed. Can be px or %, include the symbol, e.g "30px" or "50%"
							},
							highlight: {
								show: true, // should an element be highlighted, default false
								keep_visible: false, // if true the element remains visible once the step is done
								selector: ".popup-loaded .nav-tabs", // a jQuery selctor for the element to highlight. If multiple elements are matched, the first match will be used.
								background: "white", // the background CSS rule for the highlight
								border: "2px solid grey", // the border CSS rule for the highlight
							},
						},
		
					],
				},
		
		
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
			],
		
			// METHODS
		
			/*
				Add some dataset attributes to the element 
				Used for GTM tracking
				Can receive an element or a HTML string (for innerHTML)
			*/
			addStepDataset: function (elOrString, asa, i_asa, step, i_step) {
				if (typeof elOrString === "string") {
					var str =
						'data-step-key="' + step.key + '" data-asa-key="' + asa.key + '"';
					elOrString = elOrString.replace(/>$/, str + ">");
					return elOrString;
				} else {
					elOrString.dataset.stepKey = step.key;
					elOrString.dataset.asaKey = asa.key;
					return elOrString;
				}
			},
		
			/*
				Returns a positive or negative integer based on the aspect ratio
				`ratio` must be a string in the format w-h
				e.g. 16-9
		
				returns null if could not carry out compare
			*/
			_aspectCompare: function (ratio) {
				var w = parseInt(ratio.replace(/(\d+)-\d+/, "$1"));
				var h = parseInt(ratio.replace(/\d+-(\d+)/, "$1"));
				if (!isNaN(w) && !isNaN(h)) {
					return w - h;
				}
			},
		
			/*
			Creates a highlight element for the supplied step (using step.highlight.selector)
			Returns the jQuery object for the element created.
			Does not create a highlight if the element is not visible on the screen (outside the viewport, visibiltiy or display not showing)
			*/
			createHighlight: function (asa, step, options) {
				var jOrig = jQuery(step.highlight.selector);
		
				if (
					jOrig.css("visibility") == "hidden" ||
					jOrig.css("display") == "none"
				) {
					return;
				}
		
				if (jOrig.length) {
					var jEl = jQuery(app.utils.cloneWithInlineStyles(jOrig[0]));
					var thisId = "asa-highlight-" + Date.now(); // get a uniqueish id using timestamp
		
					var origX = window.scrollX;
					var origY = window.scrollY;
					window.scrollTo(0, 0); // need this so we position
					var rect = jOrig[0].getBoundingClientRect();
					var top = rect.top + 0;
					var left = rect.left + 0;
					window.scrollTo(origX, origY);
		
					// add a container
					var fixed = jOrig.isFixed() ? "fixed" : "absolute";
					var left = rect.left - 18;
					var top = rect.top - 12;
					var border =
						(step && step.highlight.border) || "2px solid var(--gm-blue)";
					var padding = "10px";
					var background = (step && step.highlight.background) || "";
		
					// Some elements have known adjustments
		
					if (fixed == "fixed") {
						left += 6;
					} else {
						left -= 4;
					}
		
					var jCont = jQuery(
						'<div id="' + thisId + '" class="asa-highlight-container"></div>'
					)
						.css("position", fixed)
						.css("border", border)
						.css("top", top)
						.css("left", left)
						.css("padding", padding)
						.css("background", background)
						.css("z-index", 2041)
						.appendTo("body");
		
					jEl.css("position", "relative").css("z-index", 1501);
					jCont.append(jEl[0]);
		
					// scroll into viewport
					if (!jQuery("#" + thisId).isInViewport()) {
						app.asa.scrollTo("#" + thisId);
					}
		
					return jCont;
				} else {
					console.warn("createHighlight could not match any elements");
				}
			},
		
			/* 
				Inserts a message box into the DOM
				Used by ASA 
				`msg` can be text or HTML
		
				All optional unless specified
				options:{
					step: (special case) - this is a step object from an ASA, and contains many properties
					modal: true makes it a modal with an opaque background (can click the background to make it dissappear, we don't want users stuck not able to use AppBuilder)
					size: xs, s, m, l, xl
				}
		
		
			*/
			_createMessageBox: function (msg, asa, step, options) {
				var options = options || {};
				var thisId = "asa-message-" + Date.now(); // get a uniqueish id using timestamp
				var loc;
				/* loc needs 
						loc.left OR loc.right
						loc.top OR loc.bottom
						loc.x AND loc.y
						e.g.
						{"left": "20px", "top": "30px"}
					*/
		
				var wrapperDiv = document.createElement("div");
		
				// if ASA step
				if (typeof step == "object") {
					//step = options.step;
		
					// Save some data
					step.data.message_wrapper_id = thisId;
		
					//options.modal = step.message.modal;
					//options.size = step.message.size;
		
					// Show modal if required
					if (step.message.modal) {
						this._createModalBackground(options);
					}
		
					// position the message
		
					if (
						step.message.anchor_target &&
						jQuery(step.message.anchor_target).length
					) {
						try {
							var j = jQuery(step.message.anchor_target);
							var element = j[0];
		
							var rect = element.getBoundingClientRect();
		
							// configure the location
							// only set either left||right and top||bottom
							loc = {};
							if (step.message.anchor_position.x == "left") {
								if (step.message.target_position.x == "left") {
									loc.left = rect.left; // default left.
								} else if (step.message.target_position.x == "right") {
									loc.left = rect.left + rect.width;
								}
							} else if (step.message.anchor_position.x == "right") {
								if (step.message.target_position.x == "left") {
									loc.left = rect.left - step.message.width; // shift to the left
								} else if (step.message.target_position.x == "right") {
									loc.left = rect.left - step.message.width + rect.width;
								}
							}
		
							var h = 100; // presume the height of the message is 100 for now. will adjust once rendered.
							if (step.message.anchor_position.y == "top") {
								if (step.message.target_position.y == "top") {
									loc.top = rect.top; // default left.
								} else if (step.message.target_position.y == "bottom") {
									loc.top = rect.top + rect.height;
								}
							} else if (step.message.anchor_position.y == "bottom") {
								if (step.message.target_position.y == "top") {
									loc.top = rect.top - h;
									//loc.top = rect.top-step.message.height;
								} else if (step.message.target_position.y == "bottom") {
									loc.top = rect.top - h + rect.height;
									//loc.top = rect.top-step.message.height+rect.height
								}
							}
		
							// offsets
							if (
								step.message.anchor_offset &&
								!isNaN(step.message.anchor_offset.x)
							) {
								loc.left += step.message.anchor_offset.x;
								loc.top += step.message.anchor_offset.y;
							}
						} catch (er) {
							console.error("_createMessageBox getBoundingClientRect", er);
						}
					}
				}
		
				// default loc if not set
				if (
					!loc ||
					!(loc.hasOwnProperty("top") || loc.hasOwnProperty("bottom"))
				) {
					wrapperDiv.dataset.valign = "center"; // can only get height once rendered
		
					loc = {
						x: "left",
						y: "top",
						// "top": ((!step && 80) || this._aspectCompare(step.message.aspect_ratio)<0?20:80), // portrait aspect goes higher
						top: 20,
						left:
							screen.width / 2 - 0.5 * ((!step && 600) || step.message.width), // center of screen
					};
				}
		
				// close other messages?
				// disable this, as messages should be closing themselves properly
				/*
				if(!(options.hasOwnProperty('allow_other_messages') && options.allow_other_messages)){
					jQuery('.asa-message-wrapper').remove();
				}
				*/
		
				wrapperDiv.style.cssText = "color: #fff; ";
				var pos = "absolute";
				try {
					if (!step) {
						//step.message.modal
						pos = "fixed";
					}
					if (
						step &&
						step.message.anchor_target &&
						jQuery(step.message.anchor_target).isFixed()
					) {
						pos = "fixed";
					}
				} catch (error) {
					console.error("_createMessageBox wrapperDiv pos", error);
				}
				wrapperDiv.style.cssText += "position:" + pos + "; z-index: 2042;";
		
				// e.g. loc.x = "left", loc["left"] = 200
				/*
				wrapperDiv.style.cssText += loc.x+': '+loc[loc.x]+'px; ';
				wrapperDiv.style.cssText += loc.y+': '+loc[loc.y]+'px; ';
				*/
				wrapperDiv.style.cssText += "left: " + loc.left + "px; ";
				wrapperDiv.style.cssText += "top: " + loc.top + "px; ";
		
				wrapperDiv.className = "asa-message-wrapper";
				wrapperDiv.id = thisId;
		
				// Minimise button
				var minimizeDiv = document.createElement("div");
				if (asa && asa.options && asa.options.can_pause) {
					minimizeDiv.style.cssText =
						"position: absolute; top: -2px; right: 24px; cursor: pointer; ";
					minimizeDiv.className = "asa-message-minimize";
					// The class and dataset attributes are used by GTM
					minimizeDiv.innerHTML = this.addStepDataset(
						'<img class="asa-message-minimize" width="10" height="10" src="https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/images/msg-box-minimize.png">',
						asa,
						options.i_asa,
						step,
						options.i_step
					);
		
					this.addStepDataset(
						minimizeDiv,
						asa,
						options.i_asa,
						step,
						options.i_step
					);
		
					minimizeDiv.onclick = function () {
						app.asa.minimize(asa, step);
					};
				}
		
				// Close button
				var closeDiv = document.createElement("div");
				closeDiv.style.cssText =
					"position: absolute; top: -2px; right: 7px; cursor: pointer; ";
				closeDiv.className = "asa-message-close";
				// The class and dataset attributes are used by GTM
				closeDiv.innerHTML = this.addStepDataset(
					'<img class="asa-message-close" width="10" height="10" src="https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/images/msg-box-close.png">',
					asa,
					options.i_asa,
					step,
					options.i_step
				);
		
				this.addStepDataset(closeDiv, asa, options.i_asa, step, options.i_step);
		
				closeDiv.onclick = function () {
					// When closing step, reset it so it can restart
					app.asa._removeVisualElements();
					app.asa.reset(asa.key); // default action for secondary link
				};
		
				// Message
				var elMessageC = document.createElement("div");
				elMessageC.style.cssText = "position: relative;  z-index: 2042;  "; //background-color: var(--gm-blue); ; border-radius: 14px;
		
				// Width: If width exists that supersedes
				//elMessageC.style.cssText += 'width:'+((options.size)?size[options.size].width:size['m'].width)+'px; '
				elMessageC.style.cssText +=
					"width:" + ((!step && "100%") || step.message.width) + "px; ";
		
				elMessageC.className =
					"asa-message-container ar-" +
					((!step && " ") || step.message.aspect_ratio);
		
				// Message Box
				var elMessageBox = document.createElement("div");
				elMessageBox.style.cssText =
					"background-color: var(--gm-blue);height: 100%;position: relative; border-radius: 7px; border: 1px solid white; display: flex;flex-direction: column; z-index: 2050;";
				elMessageBox.className = "asa-message-box";
		
				var elMessageInner = document.createElement("div");
				elMessageInner.style.cssText = "overflow: scroll; flex-grow: 1;";
				elMessageInner.className = "asa-message-inner";
		
				var elMessage = document.createElement("div");
				elMessage.style.cssText = "padding: 20px 10px 5px; height: 100%; ";
				elMessage.className = "asa-message-content";
		
				var elFooterCont = document.createElement("div");
		
				if (step) {
					// Step messages text
					var types = [
						"all",
						"starter",
						"student",
						"pro",
						"teacher",
						"instructor",
						"admin",
					];
					for (const t of types) {
						// If there is a remote source for the content
						if (step.message.source[t].length) {
							var el = document.createElement("div");
							el.style.cssText = "height: 100%; ";
							el.className = "asa-message-source asa-message-source-" + t;
							el.dataset.source = step.message.source[t];
							// el.innerHTML ='<div style="height: 200px"><div style="position: absolute;left: 0px;right: 0;top: 20px;bottom: 50px;"><div style="width: 50%;height: 100%;margin: 90px auto;text-align: center;"><i class="icon-spinner icon-spin " style="     zoom: 2;     color: var(--gm-color-low); "></i><div class="deep-loader-text" style="margin-top: 30px; color: var(--gm-color-low);"></div></div></div></div>';
							elMessage.appendChild(el);
							// we will use jQuery later to get the content
		
							// or if there is DWC content
						} else if (step.message.dwc[t].length) {
							var el = document.createElement("div");
							el.style.cssText = "height: 100%; ";
							el.className = "asa-message-dwc asa-message-dwc-" + t;
							el.dataset.dwc = step.message.dwc[t];
							// el.innerHTML = '<div class="asa-message-loading" style="height: 200px"><div style="position: absolute;left: 0px;right: 0;top: 20px;bottom: 50px;"><div style="width: 50%;height: 100%;margin: 90px auto;text-align: center;"><i class="icon-spinner icon-spin " style="     zoom: 2;     color: var(--gm-color-low); "></i><div class="deep-loader-text" style="margin-top: 30px; color: var(--gm-color-low);"></div></div></div></div>'
							elMessage.appendChild(el);
							// we will use jQuery later to get the content
		
							// or if there is text content
						} else if (step.message.text[t].length) {
							var el = document.createElement("div");
							if (t == "all") {
								el.style.cssText = "font-size: 12pt;line-height: 18pt;";
							} else {
								el.style.cssText =
									"font-size: 8pt;line-height: 10pt;background: #2973e2;padding: 10px 20px;margin-top: 10px; height: 100%; ";
							}
							el.className = "asa-message-content-" + t;
							el.innerHTML = step.message.text[t];
		
							elMessage.appendChild(el);
						}
					}
		
					// Footer area
					elFooterCont.className = "asa-message-footer-container";
					if (step.next.manual || step.secondary.show || step.footer.show) {
						elFooterCont.style.cssText =
							"height: 50px; border-top: 1px solid #9d9d9d; ";
					}
		
					// Next button
					if (step.next.manual) {
						var elNext = document.createElement("div");
						elNext.style.cssText =
							"display: inline-block;float: right; cursor: pointer;margin: 10px 10px;padding: 5px;background-color: white;min-width: 85px;border-radius: 5px;color: black;text-align: center;line-height: 16pt;font-size: 11pt; ";
						elNext.className = "asa-message-next";
						elNext.innerText = step.next.text || "Next";
		
						// Put some data on the Next button for GTM tracking
						this.addStepDataset(
							elNext,
							asa,
							options.i_asa,
							step,
							options.i_step
						);
		
						elNext.addEventListener("click", (event) => {
							msgNextClicked(event, asa, step);
						});
		
						function msgNextClicked(event, asa, step) {
							app.asa._stepDone(asa, options.i_asa, step, options.i_step);
						}
		
						elFooterCont.appendChild(elNext);
					}
		
					// Secondary button
					if (step.secondary.show) {
						var elSecondary = document.createElement("div");
						elSecondary.style.cssText =
							"display: inline-block;float: left;margin: 10px;font-size: smaller;line-height: 20px; padding: 5px; cursor: pointer; ";
						elSecondary.className = "asa-message-secondary";
						elSecondary.innerText = step.secondary.text;
		
						this.addStepDataset(
							elSecondary,
							asa,
							options.i_asa,
							step,
							options.i_step
						);
		
						elSecondary.addEventListener("click", (event) => {
							msgSecondaryClicked(event, asa, step);
						});
		
						function msgSecondaryClicked(event, asa, step) {
							if (
								step.secondary.hasOwnProperty("code") &&
								step.secondary.code.length
							) {
								try {
									Function(step.secondary.code)(asa, i_asa, step, i_step);
								} catch (er) {
									console.error("msgSecondaryClicked", er);
								}
							} else {
								// Default action for secondary link
								app.asa._removeVisualElements();
								app.asa.reset(asa.key); // default action for secondary link
							}
						}
		
						elFooterCont.appendChild(elSecondary);
					}
		
					// Footer content
					if (step.footer.show) {
						var elFooter = document.createElement("div");
						elFooter.style.cssText =
							" display: inline-block; float: left; margin-left: 10px; font-size: smaller; line-height: 50px; ";
						elFooter.className = "asa-message-footer";
						elFooter.innerText = step.footer.text;
		
						elFooterCont.appendChild(elFooter);
					}
		
					// Arrow
					// use the placement, anchor, offset
					if (step.arrow.show) {
						var arrowDiv = document.createElement("div");
						arrowDiv.style.cssText =
							"position: absolute;" +
							step.arrow.side +
							": " +
							step.arrow.offset +
							";" +
							step.arrow.placement +
							": -7px;z-index: 2045; line-height: 0px;";
						arrowDiv.className = "asa-message-arrow";
						arrowDiv.innerHTML =
							'<svg version="1.1" baseProfile="full" width="20" height="20" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(45deg);"> <rect width="20" height="20" fill="var(--gm-blue)"></rect> </svg>';
						elMessageBox.appendChild(arrowDiv);
					}
				} else {
					// simple msg
					elMessage.innerHTML = msg;
				}
		
				// Create the stack of divs
				elMessageInner.appendChild(elMessage);
				elMessageBox.appendChild(minimizeDiv);
				elMessageBox.appendChild(closeDiv);
				elMessageBox.appendChild(elMessageInner);
				elMessageBox.appendChild(elFooterCont);
				elMessageC.appendChild(elMessageBox);
				wrapperDiv.appendChild(elMessageC);
				document.body.appendChild(wrapperDiv);
		
				// for anchored boxes, adjust top based on actual message height
				if (step && step.message.anchor_position.y == "bottom") {
					// we presumed height was 100. subtract more if height > 100
					var j = jQuery("#asa-message-" + thisId);
		
					var h = parseInt(j.css("height"));
					// new top = current - (h-100)
					var newTop = parseInt(j.css("top")) - (h - 100);
					j.css("top", newTop);
				}
		
				// for valign boxes, position middle
				var fnValign = function () {
					var j = jQuery(this);
					var rect = j[0].getBoundingClientRect();
					var h = 20;
					if (rect.height < 300) {
						h = window.innerHeight / 2 - rect.height / 2;
					}
					j.css("top", h);
				};
				jQuery('.asa-message-wrapper[data-valign="center"]').each(fnValign);
				// seems to need a timeout as it doesn't always valign properly.
				app.setInterval(
					function () {
						jQuery('.asa-message-wrapper[data-valign="center"]').each(fnValign);
					},
					10,
					100
				);
		
				// Load source content
				jQuery(".asa-message-source").each(function () {
					var j = jQuery(this);
					if (j.data("source").length) {
						/* Old way, use load() method to inject content. But now, use iframe
						j.load(j.data("source"), null, function () {
							// for valign boxes, position middle
							// seems to need a timeout as it doesn't always valign properly.
							app.setInterval(
								function () {
									jQuery('.asa-message-wrapper[data-valign="center"]').each(
										fnValign
									);
								},10,1000);
						});
						*/
						j.append('<iframe src="'+j.data("source")+'"></iframe>')
					}
				});
		
				// Load DWC content
				jQuery(".asa-message-dwc").each(function () {
					var j = jQuery(this);
					if (j.data("dwc").length) {
						app._mtCreateDWC(j.data("dwc"), { appendTo: j, loader: true });
		
						// for valign boxes, position middle
						// seems to need a timeout as it doesn't always valign properly.
						app.setInterval(
							function () {
								jQuery('.asa-message-wrapper[data-valign="center"]').each(
									fnValign
								);
							},
							10,
							1000
						);
					}
				});
		
				return wrapperDiv;
			},
		
			/*
				Creates the modal background 
				Returns the jQuery element for the background 
			*/
			_createModalBackground: function (options) {
				// Add mask, and stop scrolling
		
				if (jQuery(".asa-modal-container").length) {
					// Do nothing of the modal background already exists
					return jQuery(".asa-modal-container");
				} else {
					return jQuery(
						'<div class="asa-modal-container" style="position:fixed;width:100%;height:100%;left: 0px; top: 0px;background:#000; opacity: 0.4; z-index: 2040;"></div>'
					)
						.click(function () {
							app.asa._removeModal();
						})
						.appendTo("body");
				}
			},
		
			/*
				_doCursorAnimation
				Use the step properties to move the cursor from start to finish
			*/
			_doCursorAnimation: function (asa, i_asa, step, i_step) {
				var c = step.cursor;
		
				if (c.show) {
					// look for a selector
					if (c.start.selector) {
						// try get the start loc from the selector
						try {
							var j = jQuery(c.start.selector);
							var rectS = j[0].getBoundingClientRect();
							if (rectS) {
								c.start.x = rectS.left + 0.5 * rectS.width;
								c.start.y = rectS.top + 0.5 * rectS.height;
							}
						} catch (error) {
							console.error("_doCursorAnimation c.start.selector", error);
						}
					}
		
					if (isNaN(c.start.x)) {
						// start from previous position or center
						if (asa.data.cursor.x != -1) {
							c.start.x = asa.data.cursor.x;
							c.start.y = asa.data.cursor.y;
						} else {
							// use center
							c.start.x = window.innerWidth / 2;
							c.start.y = window.innerHeight / 2;
						}
					}
		
					// look for a selector
					if (c.end.selector) {
						// try get the start loc from the selector
						try {
							var j = jQuery(c.end.selector);
							var rectS = j[0].getBoundingClientRect();
							if (rectS) {
								c.end.x = rectS.left + 0.5 * rectS.width;
								c.end.y = rectS.top + 0.5 * rectS.height;
							}
						} catch (error) {
							console.error("_doCursorAnimation c.end.selector", error);
						}
					}
		
					if (isNaN(c.end.x)) {
						// end at the center of anchor_target
						if (step.message.anchor_target) {
							var j = jQuery(step.message.anchor_target);
							var element = j[0];
							var rect = element.getBoundingClientRect();
		
							if (rect) {
								c.end.x = rect.left + 0.5 * (rect.right - rect.left);
								c.end.y = rect.top + 0.5 * (rect.bottom - rect.top);
							}
						}
						if (isNaN(c.end.x)) {
							// no end pos, so just move it around a bit
							c.end.x =
								c.start.x +
								window.innerWidth / 2 -
								parseInt(Math.random() * 0.5 * window.innerWidth);
							c.end.y =
								c.start.y +
								window.innerHeight / 2 -
								parseInt(Math.random() * 0.5 * window.innerHeight);
						}
					}
		
					// Save the end position in asa.cursor for later moves
					asa.data.cursor.x = c.end.x;
					asa.data.cursor.y = c.end.y;
		
					// create the cursor inside the wrapper
		
					var wrapperDiv = document.createElement("div");
					wrapperDiv.style.cssText = "";
					wrapperDiv.className = "asa-cursor-wrapper";
					wrapperDiv.style.cssText +=
						"position:absolute;left: 0px; top: 0px;z-index: 2200; ";
		
					var cursorDiv = document.createElement("div");
					cursorDiv.style.cssText =
						"position: relative; top: " +
						c.start.y +
						"px; left: " +
						c.start.x +
						"px;";
					cursorDiv.className = "asa-cursor-container";
					cursorDiv.onclick = function () {
						// remove the cursor if it's clicked
						jQuery(".asa-cursor-wrapper").remove();
					};
		
					var cursorImg = document.createElement("img");
					cursorImg.style.cssText = "width: 100px; display: block;";
					cursorImg.className = "asa-cursor-image";
					cursorImg.src =
						"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/click-arrow-static.gif";
		
					var clickImg = document.createElement("img");
					clickImg.style.cssText = "width: 100px; display: none;";
					clickImg.className = "asa-cursor-click-image";
					clickImg.src =
						"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/images/click-arrow.gif";
		
					cursorDiv.appendChild(clickImg);
					cursorDiv.appendChild(cursorImg);
					wrapperDiv.appendChild(cursorDiv);
					document.body.appendChild(wrapperDiv);
		
					var nextTimout = 0; // keep a running count for each consecutive timeout
		
					// click on start?
					if (c.start.click) {
						// Show click gif
						jQuery(".asa-cursor-image").hide();
						jQuery(".asa-cursor-click-image").show();
						nextTimout += app.asa._clickDuration;
		
						setTimeout(
							function (asa, i_asa, step, i_step) {
								// Hide click gif
								jQuery(".asa-cursor-click-image").hide();
								jQuery(".asa-cursor-image").show();
							}.bind(this, asa, i_asa, step, i_step),
							nextTimout
						);
					}
		
					setTimeout(
						function (asa, i_asa, step, i_step) {
							// Show animation
		
							var doAnimate = function () {
								jQuery(cursorDiv).animate(
									{ left: step.cursor.end.x, top: step.cursor.end.y },
									step.cursor.duration || 1000,
									null,
									function () {
										// callback after animation
		
										// click on end?
										if (c.end.click) {
											// Show click gif
											jQuery(".asa-cursor-image").hide();
											jQuery(".asa-cursor-click-image").show();
		
											// Hide click gif
											setTimeout(
												function (asa, i_asa, step, i_step) {
													jQuery(".asa-cursor-click-image").hide();
													jQuery(".asa-cursor-image").show();
												}.bind(this, asa, i_asa, step, i_step),
												app.asa._clickDuration
											);
										}
									}
								);
							};
		
							// get start in viewport
							if (
								!app.utils.xyIsInViewport(
									step.cursor.start.x,
									step.cursor.start.y
								)
							) {
								app.asa.scrollTo(
									[step.cursor.start.x, step.cursor.start.y],
									null,
									function () {
										doAnimate();
									}
								);
							} else {
								// no scrolling, just start animation
								doAnimate();
							}
		
							/*
		########################################################################################
		This messes up the click point at the end, because the x,y changes when scrolling
		########################################################################################
						*/
							// get end in viewport, after suitable delay
		
							if (
								!app.utils.xyIsInViewport(step.cursor.end.x, step.cursor.end.y)
							) {
								// wait for 1 second before end
								var delay =
									(step.cursor.duration > 0 && step.cursor.duration) || 0;
								setTimeout(function () {
									app.asa.scrollTo([step.cursor.end.x, step.cursor.end.y]);
								}, delay);
							}
						}.bind(this, asa, i_asa, step, i_step),
						nextTimout
					);
				}
			},
		
			/*
				returns the ASA object (JSON) matching key
			*/
			get: function (key) {
				for (const asa of this.asas) {
					if (asa.key == key) {
						return asa;
					}
				}
			},
		
			/*
				Handles activity that needs to be carried out for all ASAs
				All ASAs and all "next steps" are checked to see if action is required.
				Starts steps, pauses, resumes etc
				This method can be triggered by events, called in a loop, called manually
		
				eName: the name of the event that triggered this method call
				options
					trigger_start: key - simulate the trigger to start the first step of the ASA identified by key. (This might not start the ASA if invalid state). Try asa.start(key) with 'force'
			*/
			_handleAutomationEvents: function (eName, options) {
				var options = options || {};
				var eventName = eName;
				var minDelay = 1; // minimum delay for setTimeout. To allow all loops to finish
		
				// Modify the event name in some cases
		
				// Append container type for popups
				if (eName == "ase-popup-loaded") {
					eventName += "-" + app._popupContainerType;
				}
		
		
				// TODO Get all the automations from localStorage -
		
				// look for a pending automation step that triggers on this event
				for (var i_asa = 0; i_asa < this.asas.length; i_asa++) {
					//var asa = this.asas[i_asa];
		
		
					var asa = app.asa._spawnFromTemplate({
						data: app.asa.asas[i_asa],
						template: app.asa.templates["main"],
						ignore: ["steps"],
					}).data; // spawn asa without steps
		
		
					// Presume the new state will be "done" - this will be changed as required.
					var asaState = 900;
		
					for (var i_step = 0; i_step < asa.steps.length; i_step++) {
						// make sure the step has all the required fields
						var sft = app.asa._spawnFromTemplate({
							data: asa.steps[i_step],
							template: app.asa.templates["main"].steps[0],
						});
		
						if (sft.messages.error.length) {
							// Spawned step has errors - don't continue
							console.warn(
								"_handleAutomationEvents: ASA step has invalid data",
								i_asa,
								i_step,
								sft.messages.error,
								asa.steps[i_step]
							);
		
							if (/@appshed\.com/.test(app.user.username)) {
								app.showToastMessage(
									"ASA step has invalid data (see console for details)"
								);
							}
						} else {
							// spawned step is valid
							var step = sft.data;
		
							// don't process new steps if an existing one is 'in progress'
							if (step.state >= 200 && step.state < 700) {
								break; // break out the step loop for this asa.
							}
		
							// If the step is pending, see if we must do it
							if (step.state >= 100 && step.state < 200) {
								// Check conditions if we do this step
								if (
									// has the trigger event just occurred...
									step.trigger.event_name == eventName ||
									// or there is no specified trigger event (just do the step)
									step.trigger.event_name.length == 0 ||
									//  or is there a trigger_start for this key, to start
									(i_step == 0 &&
										options.hasOwnProperty("trigger_start") &&
										options.trigger_start == asa.key)
								) {
									// run the validation code if any
									app.__outputTriggerCondition = false; // use this to hold the output of the condition evaluation
									if (
										step.trigger.hasOwnProperty("condition") &&
										step.trigger.condition.length ) { 
		
											
											
											Function("app.__outputTriggerCondition = "+step.trigger.condition)();
											
										}
		
									if (
										!step.trigger.hasOwnProperty("condition") ||
										!step.trigger.condition.length ||
										app.__outputTriggerCondition
									) {
										// Do we skip it
										if (Function(step.skip.condition)()) {
											// mark this step as skipped
											app.asa._stepSkipped(asa, i_asa, step, i_step);
										} else {
											// ############################
											// Ok, so we can do this step
											// ############################
		
											// trigger the ASE event
											app.asa.currentASA = asa;
											app.asa.currentStep = step;
											document.dispatchEvent(app.events["ase-asa-step"]);
		
											step.state = 200; // mark as running
											asa.state = asaState = 200;
		
											// show message (always show for manual next)
											if (
												step.next.manual ||
												step.message.text.all.length ||
												step.message.text.admin.length ||
												step.message.text.instructor.length ||
												step.message.text.pro.length ||
												step.message.text.starter.length ||
												step.message.text.student.length ||
												step.message.text.teacher.length
											) {
												setTimeout(
													function (asa, i_asa, step, i_step) {
														var msg = JSON.stringify(step.message.text).replace(
															/,/g,
															", "
														);
														app.asa._createMessageBox(msg, asa, step, {
															step: step,
															asa: asa,
															i_step: i_step,
															i_asa: i_asa,
														});
													}.bind(this, asa, i_asa, step, i_step),
													step.delay.before_message || minDelay
												);
											}
		
											// do the cursor
											if (step.cursor && step.cursor.show) {
												setTimeout(
													function (asa, i_asa, step, i_step) {
														app.asa._doCursorAnimation(
															asa,
															i_asa,
															step,
															i_step
														);
													}.bind(this, asa, i_asa, step, i_step),
													step.delay.before_cursor || minDelay
												);
											}
		
											// do the highlight
											if (step.highlight && step.highlight.show) {
												setTimeout(
													function (asa, i_asa, step, i_step) {
														app.asa.highlight(asa, i_asa, step, i_step);
													}.bind(this, asa, i_asa, step, i_step),
													step.delay.before_highlight || minDelay
												);
											}
		
											// do action
											if (
												step.action.type == "code" &&
												step.action.code.length
											) {
												setTimeout(
													function (asa, i_asa, step, i_step) {
														try {
															Function(step.action.code)();
														} catch (er) {
															console.error("_handleAutomationEvents", er);
														}
		
														// set state done if not manual
														if (!step.next.manual) {
															setTimeout(
																function (asa, i_asa, step, i_step) {
																	app.asa._stepDone(asa, i_asa, step, i_step);
																}.bind(this, asa, i_asa, step, i_step),
																step.delay.after_action || minDelay
															);
														}
													}.bind(this, asa, i_asa, step, i_step),
													step.delay.before_action || minDelay
												);
											} else {
												// no action, and not manual,  set state done after wait
												if (!step.next.manual) {
													setTimeout(
														function (asa, i_asa, step, i_step) {
															app.asa._stepDone(asa, i_asa, step, i_step);
														}.bind(this, asa, i_asa, step, i_step),
														step.delay.before_auto || minDelay
													);
												}
											}
										}
									}
								}
								break;
							}
						}
					} // end loop all steps
		
					// if the
				} // end loop all asas
			}, // END _handleAutomationEvents
		
			/*
				highlight
				Highlights an element
			*/
			highlight: function (asa, i_asa, step, i_step) {
				if (step && step.highlight && step.highlight.selector) {
					// create the highlight
					var jHighlight = this.createHighlight(asa, step);
		
					if (jHighlight) {
						// show the modal backgrdoun
						var jModal = this._createModalBackground();
		
						// function to remove both modal and highlight elements
						var onClick = function () {
							jModal.remove();
							jHighlight.remove();
						};
		
						// clicking on either removes them
						jModal.click(onClick);
						jHighlight.click(onClick);
					}
				}
			},
		
			/*
				Carry out initialisation tasks
			*/
			_init: function () {
				// try get asas from localStorage
				if (
					localStorage.hasOwnProperty("asas") &&
					localStorage["asas"].length
				) {
					try {
						var a = JSON.parse(localStorage["asas"]);
		
						// do a few checks to see if it's valid
						if (
							Array.isArray(a) &&
							a.length &&
							typeof a[0] === "object" &&
							a[0].hasOwnProperty("key")
						) {
							this.asas = a;
						}
					} catch (error) {
						console.error("app.asa._init", error);
					}
				}
		
				// If nothing in asas, use default
				/*
				default set in properties above
				if(this.asas == null){
					this.asas = this._defaultAsas;
				}
				*/
		
				// set up an interval to look for Mautic notifications
				setInterval(function () {
					if (
						jQuery(
							"body>iframe.mf-bar-iframe:not([data-asa-handle-notification])"
						).length
					) {
						// we are only looking for bar notifications
						// the data attribute shows if we have handled it already
						var j = jQuery(
							"body>iframe.mf-bar-iframe:not([data-asa-handle-notification])"
						);
		
						// add the data attribute with timestamp to show we handled this notification
						j.attr("data-asa-handle-notification", Date.now());
		
						j.prev().hide(); // hide the expand/collapse div
						j.hide(); // hide the iframe
		
						// Look for an asa action, starting [[asa
						if (j.contents().find('.mf-headline:contains("[[asa")').length) {
							var action = j
								.contents()
								.find('.mf-headline:contains("[[asa")')
								.text();
							action = action.replace(/.*\[\[(.*?)\]\].*/, "$1");
		
							// does this notification start an asa
							if (/asa-start:/.test(action)) {
								var key = action.replace(/asa-start:/, "");
								app.asa.start(key, { force: true });
							}
		
							if (window._appjs_test === true) {
								// don't hide the notificaion on test
							} else {
								j.hide();
								// There might be a collapser
								jQuery(".mf-bar-collapser").hide();
							}
						}
					}
				}, 500);
			},
		
			/*
				When the minimize button on the step is clicked
			*/
			minimize: function (asa, step) {
				this.pause(asa, step);
		
				this._removeVisualElements(asa, step, { minimize: true });
			},
		
			/*
				pauses the ASA
			*/
			pause: function (asa, step) {
				// mark the step and ASA as paused
				step.state = 300;
				asa.state = 300;
			},
		
			/*
				Save the asas to localStorage
			*/
			_persistAsas: function () {
				try {
					localStorage["asas"] = JSON.stringify(app.asa.asas);
				} catch (error) {
					console.error("app.asa._persistAsas", error);
				}
			},
		
			_removeCursor: function (asa, step) {
				// remove the cursor if it's clicked
				jQuery(".asa-cursor-wrapper").remove();
			},
		
			_removeHighlight: function (asa, step, options) {
				// remove the highlight element
				// The step might have a setting to keep visible
				if (step && step.highlight && step.highlight.keep_visible) {
					// don't remove highlight
				} else {
					jQuery(".asa-highlight-container").remove();
				}
		
				this._removeModal();
			},
		
			/*
				Remove the ASA visual elements
				However there are certain conditions that determine which elements should remain visible
			*/
			_removeMessageBox: function (asa, step, options) {
				var options = options || {};
				var selector = ".asa-message-wrapper";
		
				// Now do the closing
		
				// if minimize
				if (options.minimize) {
					var rect = jQuery(".help-icon-floating")[0].getBoundingClientRect();
					jQuery(selector).animate(
						{
							left: rect.left + 20,
							top: rect.top + 20,
							width: 30,
							height: 30,
							opacity: 0.3,
						},
						600,
						null,
						function () {
							// remove after animation
							jQuery(selector).remove();
							app.asa._removeModal();
		
							// Show a message so the user knows
							setTimeout(function () {
								app.showToastMessage(
									"When you minimise a tour / tutorial / guide, <br>it will be minimised into <br>the Help area. <br><br>Just click the Help button (?) <br>to reopen it. ",
									{
										selector: ".help-icon-floating",
										bottom: -100,
										width: "200px",
										right: 20,
										animate_in_bottom: 90,
										animate_out_bottom: -200,
										delay: 10000,
									}
								);
							}, 600);
						}
					);
				} else {
					// not minimizing
		
					// The step might have a setting to keep visible
					if (step && step.message && step.message.keep_visible) {
						this._removeModal();
					} else {
						jQuery(selector).remove();
						this._removeModal();
					}
				}
			},
		
			_removeModal: function (asa, step) {
				jQuery(".asa-modal-container").remove();
			},
		
			_removeVisualElements: function (asa, step, options) {
				// remove the visual elements that might be currently visible
		
				this._removeCursor(asa, step, options);
				this._removeHighlight(asa, step, options);
				this._removeMessageBox(asa, step, options);
				this._removeModal(asa, step);
			},
		
			/*
				Resets the automation identified by `key`
				options
					force: (default true) forces the ASA to restart even if currently in progress
			*/
			reset: function (key, options) {
				var options = options || { force: true };
		
				// find the ASA
				var asa = this.get(key);
		
				if (asa) {
					// set all steps to pending
					for (const step of asa.steps) {
						step.state = 100;
					}
		
					asa.sate = 100;
		
					this._persistAsas();
				}
			},
		
			/*
				scrollToSelector
				Uses native element.scrollTo but adds some ASA adaptions
				selector:  the selector for the element
				options
					Can include all element.scrollTo options, and also:
					offset_top: (optional) default -100
		
			*/
			scrollTo: function (selectorOrArray, options, callback) {
				var options = options || {};
				var selector, arr;
		
				if (!selectorOrArray) {
					return;
				}
		
				if (Array.isArray(selectorOrArray)) {
					arr = selectorOrArray;
				} else {
					selector = selectorOrArray;
				}
		
				// defaults
				if (!options.hasOwnProperty("offset_top")) {
					options.offset_top = -200;
				}
				if (!options.hasOwnProperty("behavior")) {
					options.behavior = "smooth";
				}
		
				if (selector) {
					options.top = jQuery(selector).offset().top + options.offset_top;
				} else if (arr) {
					options.top = arr[1] + options.offset_top;
					options.left = arr[0];
				}
		
				window.scrollTo(options);
		
				if (callback) {
					// presume a 1 second scroll time... this is a guess
					setTimeout(function () {
						callback.call();
					}, 1000);
				}
			},
		
			/*
				Sets all the step states to `state`
			*/
			_setAllStepStates: function (asa, state) {
				for (const step of asa.steps) {
					step.state = state;
				}
			},
		
			/*
				_spawnFromTemplate
				Adds to the data object, all the template properties (recursively)that are missing
				Returns messages with errors if any data properties not suitable for the template (type mismatch)
				Options: 
					template: the template to use to create the new
					data (optional) if missing, the new object will be exactly the template object
					messages [{
						type
						msg
					}]
		
				
				An options object is returned. If no errors, it will contain options.data (the original object but now containing the extra properties)
				options.messages [] is returned with info and error messages
			*/
			_spawnFromTemplate: function (options) {
				var rVal = {};
		
				try {
					// check options is valid
					if (
						typeof options != "object" ||
						!options.hasOwnProperty("template")
					) {
						console.warn("_spawnFromTemplate invalid options", options);
						return;
					}
		
					var template = JSON.parse(JSON.stringify(options.template));
		
					// add messages
					if (!options.hasOwnProperty("messages")) {
						options.messages = { log: [], warn: [], error: [] };
					}
		
					// add property
					if (!options.hasOwnProperty("property")) {
						options.property = "top";
					}
		
					// If NOT existing data
					if (!options.hasOwnProperty("data")) {
						// easy, just make spawned = template
						options.data = template;
						options.messages.log.push({
							msg: "No data. Creating new object from template",
							template: template,
						});
					} else {
						// data object exists
		
						// fail if not same type
						if (typeof options.data !== typeof template) {
							options.messages.error.push({
								msg:
									"Type mismatch. Looking for `" +
									typeof template +
									"` but found `" +
									typeof options.data +
									"`",
								property: options.property,
								data: options.data,
								template: template,
							});
							//return rVal;
						} else {
							// they are same type
		
							// template is an object, iterate
							if (typeof template === "object") {
								// add the whole template object
								// var spawned = template;
		
								// now check all properties from template object
								//for(const p in template){
								for (const p of Object.keys(template)) {
									//console.warn('iterate property',p,typeof options.data[p],typeof template[p],options.data[p])
		
									// if p in data,
									if (options.data.hasOwnProperty(p)) {
										// might need to ignore this p
										if (
											!options.hasOwnProperty("ignore") ||
											!Array.isArray(options.ignore) ||
											!options.ignore.includes(p)
										) {
											// call recursively to spawn this property properly
											// any missing sub-properties will get added
											var temp = app.asa._spawnFromTemplate({
												data: options.data[p],
												template: template[p],
												property: options.property + "." + p,
												messages: options.messages,
											});
										}
		
										// check for errors
										/*
										rVal.messages.log = rVal.messages.log.concat(temp.messages.log)
										rVal.messages.warn = rVal.messages.warn.concat(temp.messages.warn)
										rVal.messages.error = rVal.messages.error.concat(temp.messages.error)
										*/
		
										/*
										if(temp.messages.error.length){
												// don't add spawned
											//return rVal
										}else{
											// no error - so it's ok to use spawned object
											if(temp.hasOwnProperty('spawned')){
												spawned[p] = temp.spawned;
											}
										}
										*/
									} else {
										// data doesn't have this property, so add from template
		
										// must we ignore this property
										if (
											!options.hasOwnProperty("ignore") ||
											!Array.isArray(options.ignore) ||
											!options.ignore.includes(p)
										) {
											options.data[p] = template[p];
										}
									}
								}
		
								// if we get here, no erros, so use spawned
								// rVal.spawned = spawned;
							} else {
								// not an object, and same type, so we just stick with the data we've got
								options.messages.log.push({
									msg: "Used data in place of template",
									property: options.property,
									data: options.data,
									template: template,
								});
		
								//return rVal;
							}
						}
					}
		
					return options;
				} catch (error) {
					console.error("_spawnFromTemplate", error);
				}
			},
		
			/*
				Starts the automation identified by `key`
				options
					force: true forces the ASA to restart even if currently in progress
			*/
			start: function (key, options) {
				var options = options || { force: false };
		
				// find the ASA
				var asa = this.get(key);
				if (asa) {
					// force restart required if 200<= state < 900
					if (asa.state >= 200 && asa.state < 900 && options.force) {
						// set all steps to pending
						for (const step of asa.steps) {
							if (step.state >= 200 && step.state < 900 && options.force) {
								step.state = 100;
							}
						}
		
						asa.sate = 100;
					}
		
					if (options.hasOwnProperty("skip_to") && options.skip_to.length) {
						// find a step with the key matching skip_to value
		
						// see if the step exists first
						var keyExists = false;
						for (const step of asa.steps) {
							if (step.key == options.skip_to) {
								keyExists = true;
								break;
							}
						}
						// now mark skipped up to that point
		
						for (const step of asa.steps) {
							if (step.key != options.skip_to) {
								step.state = 700;
							} else {
								// break once we get to skip_to
								break;
							}
						}
					}
		
					// trigger the ASE event
					app.asa.currentASA = asa;
					document.dispatchEvent(app.events["ase-asa-start"]);
		
					// simulate the trigger event by passing it in
					this._handleAutomationEvents(asa.steps[0].trigger.event_name);
				}
			},
		
			/*
				Carry out some tasks when a step is done
			*/
			_stepDone: function (asa, i_asa, step, i_step) {
				app.asa._removeVisualElements(asa, step);
		
				step.state = 900;
		
				// Set ASA to 100 - ready for next trigger
				asa.state = 100;
		
				// if all steps done, set all states to Pending
				if (i_step == asa.steps.length - 1) { // this is the last step
		
					// add completed_count if not present
					if(!asa.data.hasOwnProperty("completed_count")){
						asa.data.completed_count = 0;
					}
					asa.data.completed_count = asa.data.completed_count+1;
		
					// is this restart allowed
					if(!asa.options.hasOwnProperty("max_restarts") || asa.options.max_restarts == -1 || asa.options.max_restarts >= asa.data.completed_count){
						app.asa._setAllStepStates(asa, 100);
					}
				}
		
				app.asa._persistAsas();
		
				// handle events - in case the next event has an empty trigger, it must start immediately
				app.asa._handleAutomationEvents();
			},
		
			/*
				Carry out some tasks when a step is skipped
			*/
			_stepSkipped: function (asa, i_asa, step, i_step) {
				step.state = 400;
		
				// Set ASA to 100 - ready for next trigger
				asa.state = 100;
		
				// if all steps done, set all states to Pending
				if (i_step == asa.steps.length - 1) {
					this._setAllStepStates(asa, 100);
				}
		
				// handle events - in case the next event has an empty trigger, it must start immediately
				app.asa._handleAutomationEvents();
			},
		
			/*
				Unpauses the automation identified by `key`
			*/
			unpause: function (key, options) {
				var options = options || {};
		
				// find the ASA
				var asa = this.get(key);
		
				if (asa) {
					// unpause  required if 300<= state < 400
					if (asa.state >= 300 && asa.state < 400) {
						// set all steps to pending
						for (const step of asa.steps) {
							if (step.state >= 300 && step.state < 400) {
								step.state = 100;
							}
						}
		
						asa.sate = 100;
					}
		
					// simulate the trigger event by passing it in
					this._handleAutomationEvents(asa.steps[0].trigger.event_name);
				}
			},
		}; // END app.asa
				
				   




		/*
			EDU Object
			tags: Academy Class Academy Object, EDU Class, 
			Provides methods to handle EDU functionality
		*/
		app.edu = {


			/*
				_callbackCheckCSV
				Called after the check-csv webhook is called and the iframe is loaded
				Params
					frameEl: The iframe DOM element
			*/
			_callbackCheckCSV: function (frameEl,id) {
				var jFrame = jQuery(frameEl);

				
				// try format the message
				var msg = jFrame.contents().find('body').text();
				try {
					var jMsg = JSON.parse(msg);
					msg = `
						<h5>${jMsg["msg"]}</h5>
						<ul>
							<li>
							`+JSON.parse(jMsg["errors"].replace(/'/g,'"')).join('</li><li>')+`
							</li>
						</ul>
					`;
				} catch (error) {
		console.error('_callbackCheckCSV',error)
					msg = jFrame.contents().find('body').text();
				}
				// put the msg into the msg container 
				jQuery('#as-edu-popup-iframe-edu').contents().find('.check-csv-msg')
					.removeClass('loading').removeClass('hidden')
					.html(`<div style="padding: 20px;" class="check-csv-msg-error">
						${msg}
					</div>
				`)

			}
		}  // END app.edu
        



		/*
			Provide a collection if utils utility methods for various tasks
		*/

		app.utils = {
			/*
				Clones el and returns a new el, with all the stylesheet rules for el include as inline styles
				This is useful when appending out of the original context where the CSS rules won't apply
				e.g. Highlight item added to body

				Use pure JS not jQuery, jQuery removes innerText from elements with children
			*/
			cloneWithInlineStyles: function (el) {
				var jEl = jQuery(el);
				var rules = app.utils.getAllStyleRules(el);

				// if the element contains both children and innerText,
				//    and if the innerText is not HTML
				//    put the innerText into a span (so it is proper HTML)

				el = app.utils.fixTextNodes(el);

				var clone = el.cloneNode();

				// Create the new element
				var jClone = jQuery(clone).attr("style", rules);

				// now clone all children
				if (jEl.children().length) {
					jEl.children().each(function (key, child) {
						// get the cloned el with styles
						jClone.append(app.utils.cloneWithInlineStyles(child));
					});
				} else {
					jClone.text(jEl.text());
				}
				return jClone[0];
			},

			compare: function (actual, needed, method, range) {
				if (method == "equal") {
					// =
					if (
						actual == needed ||
						(needed - range <= actual && actual <= needed + range)
					) {
						return true;
					}
				} else if (method == "notequal") {
					//!=
					if (
						(range && (actual < needed - range || needed + range < actual)) ||
						(!range && needed != actual)
					) {
						return true;
					}
				} else if (method == "lessthan") {
					//<
					if (actual < needed) {
						return true;
					}
				} else if (method == "greaterthan") {
					//>
					if (actual > needed) {
						return true;
					}
				} else if (method == "lessthanorequalto") {
					//<=
					if (actual <= needed) {
						return true;
					}
				} else if (method == "greaterthanorequalto") {
					if (actual >= needed) {
						return true;
					}
				}
				return false;
			},

			/*
			Fixes improper HTML, where an element with child nodes should not have any direct innerText
			Convert innerText to spans
			*/
			fixTextNodes: function (el) {
				var itd = app.utils.innerTextDirect(el);

				if (itd.length && el.children.length) {
					jQuery(el).append("<span>" + itd + "</span>");

					app.utils.removeDirectTextNodes(el);
				}
				return el;
			},

			/*
			Returns a string containing all the CSS rules applying to the element
			CSS is extracted from inline and external stylesheets
			Due to CORS restrictions, stylesheets sourced from another domain cannot be parsed
		*/
			getAllStyleRules: function (el) {
				var css = window.getComputedStyle(el);
				var str = "";
				for (var i = 0; i < css.length; i++) {
					str += css[i] + ": " + css.getPropertyValue("" + css[i]) + "; ";
				}
				return str;

				// using stylesheets...
				/*
				var sheets = document.styleSheets, ret = [];
				el.matches = el.matches || el.webkitMatchesSelector || el.mozMatchesSelector 
					|| el.msMatchesSelector || el.oMatchesSelector;
				for (var i in sheets) {
					try{
					var rules = sheets[i].rules || sheets[i].cssRules;
					for (var r in rules) {
						if (el.matches(rules[r].selectorText)) {
							ret.push(rules[r].cssText.replace(/.*{(.*)}/g,"$1"));
						}
					}
					}catch(er){
		//                   console.warn('Caught in',i,sheets[i],er)
					}
				}
				return ret.join();
				*/
			},

			getHourTimestampUTC: function (aDate) {
				// return the timestamp for `aDate` or Now for the current hour
				// Format: yyyymmddhh
				// GTM tag usage
				var date = aDate ? aDate : new Date();
				var year = date.getUTCFullYear();
				var month = String(date.getUTCMonth() + 1).padStart(2, "0");
				var day = String(date.getUTCDate()).padStart(2, "0");
				var hour = String(date.getUTCHours()).padStart(2, "0");
				var hourTimestamp = year + month + day + hour;
				return hourTimestamp;
			},

			getObjProp: function (obj, propName, type) {
				// return a 'safe' value as a property from an object
				// `format` (optional) defines the Type to return. Default `string`
				// `format` can be: 0 (string - safe value is ""), 1 (number - safe value is 0)

				var type = type || 0;

				// String
				if (type == 0) {
					if (typeof obj === "object" && obj.hasOwnProperty(propName)) {
						return "" + obj[propName];
					}
					return "";
				}

				// Number
				if (type == 1) {
					if (
						typeof obj === "object" &&
						obj.hasOwnProperty(propName) &&
						!isNaN(obj[propName])
					) {
						return +obj[propName];
					}
					return 0;
				}

				return "";
			},

			/*
			Return all the text nodes directly within the element.
			This helps when innerText is returning text from children, but you only want text from el
			*/
			getTextNodes: function (node, includeWhitespaceNodes) {
				var textNodes = [],
					nonWhitespaceMatcher = /\S/;

				function getTextNodesIn(node) {
					if (node.nodeType == 3) {
						if (
							includeWhitespaceNodes ||
							nonWhitespaceMatcher.test(node.nodeValue)
						) {
							textNodes.push(node);
						}
					} else {
						for (var i = 0, len = node.childNodes.length; i < len; ++i) {
							if (node.childNodes[i].nodeType == 3) {
								if (
									includeWhitespaceNodes ||
									nonWhitespaceMatcher.test(node.childNodes[i].nodeValue)
								) {
									textNodes.push(node.childNodes[i]);
								}
							}
						}
					}
				}

				getTextNodesIn(node);
				return textNodes;
			},

			/*
			Returns the inner text directly within el (not in child nodes)
			*/
			innerTextDirect: function (el) {
				var str = "";
				var nodes = app.utils.getTextNodes(el);
				for (var i = 0; i < nodes.length; ++i) {
					str += nodes[i].textContent;
				}

				return str;
			},

			/*
				returns true of the x,y position is in the viewport
			*/
			xyIsInViewport: function (x, y) {
				/*
				console.warn('xyIsInViewport x y',x,y)

				console.warn('xyIsInViewport window.scrollY - window.innerHeight',window.scrollY - window.innerHeight)
				console.warn('xyIsInViewport window.scrollY',window.scrollY);


				console.warn('xyIsInViewport window.scrollX - window.innerWidth',window.scrollX - window.innerWidth)
				console.warn('xyIsInViewport window.scrollX ',window.scrollX)


				var rVal = (
					y >= 0 &&
					x >= 0 &&
					
					y >= window.scrollY - window.innerHeight &&
					y <= window.scrollY &&
			
				
					x >= window.scrollX - window.innerWidth &&
					x <= window.scrollX 
				);
				*/

				var rVal =
					y >= 0 &&
					x >= 0 &&
					y <= window.scrollY + window.innerHeight &&
					y >= window.scrollY &&
					x <= window.scrollX + window.innerWidth &&
					x >= window.scrollX;

				return rVal;
			},

			/*
			Merge two objects
			Start with the base object. Any properties from the add object replace the properties in base
			*/
			merge: function (base, add) {
				if (
					typeof base === "object" &&
					base !== null &&
					typeof add === "object" &&
					add !== null
				) {
					jQuery.each(add, function (key, val) {
						if (base.hasOwnProperty(key)) {
							// If the value is an object, use merge
							if (
								typeof base[key] === "object" &&
								base[key] !== null &&
								typeof add[key] === "object" &&
								add[key] !== null
							) {
								base[key] = app.utils.merge(base[key], add[key]);
							} else {
								// If the value is not an object, replace base value with add value
								base[key] = add[key];
							}
						}
					});
				}

				return base;
			},

			/*
			Removes text nodes directly within the element
			(They should exist as spans probably)
			*/
			removeDirectTextNodes: function (node) {
				for (var i = 0; i < node.childNodes.length; i++) {
					if (node.childNodes[i].nodeType == 3) {
						node.childNodes[i].remove();
					}
				}
				return node;
			},

			setJSField: function (code, callback) {
				// wait for the box to be ready
				// the interval will continue for a period of time, to keep checking the editor has the correct value
				// neccesary because some glitch causes the value to be lost in random instances after some timeout

				// make sure we are working with an empty string at least
				var code = code || "";

				app.setInterval(
					function () {
						try {
							if (document.id("action_js")) {
								var ed = document.id("action_js").retrieve("editor");

								//console.warn('setJSField ed',ed)

								if (typeof ed === "object") {
									// Check it is set
									var check = ed.getValue() == code;
									//console.warn('setJSField code check ',check)
									if (check) {
										// if code already set, break
										// cancel interval after a timeout
										setTimeout(function () {
											app.clearInterval("app-game-addItem-action");
											if (callback) {
												callback.call();
											}
										}, 1000);
										return;
									}

									//console.warn('setJSField set code ')

									// set the value
									ed.setValue(code);
								}
							}
						} catch (er) {
							console.warn("ERROR setJSField interval waiting for editor", er);
						}
					},
					200,
					10000,
					"app-game-addItem-action"
				);
			},

			stringToArray: function (str) {
				// Returns an array, from `str`
				// Error handling ensures that an object is always returned, even if empty

				try {
					var arr = JSON.parse(str);

					if (Array.isArray(arr)) {
						return arr;
					}
				} catch (er) {}

				try {
					// try adding braces
					var arr = JSON.parse("[" + str + "]");
					if (Array.isArray(arr)) {
						return arr;
					}
				} catch (er) {}

				return [];
			},

			stringToObject: function (str) {
				// Returns an object, from `str`
				// Error handling ensures that an object is always returned, even if empty

				var obj = {};

				try {
					var objS;
					eval("objS = " + str);

					if (typeof objS === "object") {
						obj = objS;
					}
				} catch (er) {}

				return obj;
			},

			urldecode: function (url) {
				return decodeURIComponent(url.replace(/\+/g, " "));
			},
		};

		app.stats = {
			max: function (array) {
				return Math.max.apply(null, array);
			},

			min: function (array) {
				return Math.min.apply(null, array);
			},

			range: function (array) {
				return app.stats.max(array) - app.stats.min(array);
			},

			midrange: function (array) {
				return app.stats.range(array) / 2;
			},

			sum: function (array) {
				var num = 0;
				for (var i = 0, l = array.length; i < l; i++) num += array[i];
				return num;
			},

			mean: function (array) {
				return app.stats.sum(array) / array.length;
			},

			median: function (array) {
				array.sort(function (a, b) {
					return a - b;
				});
				var mid = array.length / 2;
				return mid % 1 ? array[mid - 0.5] : (array[mid - 1] + array[mid]) / 2;
			},

			modes: function (array) {
				if (!array.length) return [];
				var modeMap = {},
					maxCount = 0,
					modes = [];

				array.forEach(function (val) {
					if (!modeMap[val]) modeMap[val] = 1;
					else modeMap[val]++;

					if (modeMap[val] > maxCount) {
						modes = [val];
						maxCount = modeMap[val];
					} else if (modeMap[val] === maxCount) {
						modes.push(val);
						maxCount = modeMap[val];
					}
				});
				return modes;
			},

			variance: function (array) {
				var mean = app.stats.mean(array);
				return app.stats.mean(
					array.map(function (num) {
						return Math.pow(num - mean, 2);
					})
				);
			},

			standardDeviation: function (array) {
				return Math.sqrt(app.stats.variance(array));
			},

			meanAbsoluteDeviation: function (array) {
				var mean = app.stats.mean(array);
				return app.stats.mean(
					array.map(function (num) {
						return Math.abs(num - mean);
					})
				);
			},

			zScores: function (array) {
				var mean = app.stats.mean(array);
				var standardDeviation = app.stats.standardDeviation(array);
				return array.map(function (num) {
					return (num - mean) / standardDeviation;
				});
			},
		};

		// Function aliases:
		app.stats.average = app.stats.mean;
		app.stats.avg = app.stats.mean;

		app.assets = {
			// A collection of Base64 encoded assets for use within apps (image and audio)
			// Used mainly for offline functionality where dynamic loading of assets is required

			// Some sound effects obtained from https://www.zapsplat.com

			atlas: {},

			audio: {
				// zapsplat_household_rubber_glove_pull_finger_release_002_22249
				flick:
					"data:audio/mp3;base64,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",

				// zapsplat_cartoon_jump_jaw_harp_edited_006_17212-mp3-Base64
				jump: "data:audio/mp3;base64,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",

				shoot:
					"data:audio/mp3;base64,SUQzAwAAAAAAH1RFTkMAAAAVIAAAU291bmQgR3JpbmRlciAzLjUuNQD/+5RoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYaW5nAAAADwAAABUAABb4AAQEBAQICAgICBYWFhYWJiYmJiY3Nzc3SUlJSUlbW1tbW3JycnJyiIiIiJ6enp6erKysrKy7u7u7u8bGxsbU1NTU1N/f39/f5ubm5ubs7Ozs8vLy8vL39/f39/v7+/v7/////wAAAE5MQU1FMy45OHIDugAAAAAAAAAA9CAkBXGNAAHgAAAW+MljrKoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+xRoAA/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAAQAUAcAgAcAcAcDgcDAAAADzm8bi7wkEvxydD+j4fOfww//0zEpL1Fwaamftm6My+HZeGWS8ODRkQaKVGP/+xRoHg/wAABpAAAACAAADSAAAAEAAAGkFAAAIAAANIKAAARool25BoREGFAuZkL6jl2n6tKxB8rvxj+zEOS5uFW0yWKZXs2nplmKUebBOpgoRFxgEDikQgJBFtXBmLH/+3RoPAABFwxLfhxAAAAADSDAAAAnahdMGc4AAAAANIMAAABjP9L/bM7MMO+70AOXHYMgSjxt29cs0zWYCZ07klSRCoBhidjLdnAMjkEwMKocdS3hz/8xOHQwmoXNAk2FPXMThRSpSTXV2uMwR8//mVixn3/qSuG2GLnTNLrqTIAABgw7EghiHH7MEBQCAMwGFgsAy0PLG////WH64pnDNS3f7YpX2gVHEFAuUJGL9TPTAVe5E4zBkqSZhwUFBIMMiXdaKQJ2xYz/W7f/////////////4cAy3AJA4KFJEAnNgGa3Ko66H/////////////5h0XGIQ8YdCgVBQFAKcg0D3AgRIRiKFaqquqEAJoAmCSStFdxW0fu1OpziuP7/+4RoCoD0S1/d/zEAAgAADSDgAAEUqYNx54TeCAAANIAAAAQIAOJwrUC11lwsT/NkA3BuH4SA1BUEoLQ8BqbBTXrrxc001P/zcO7u8CghiwsKh0NNKFmmP////ni3m3d4RqeFtYGvUNJK1rMQ+iOQlehBBmKU7GFjFVlYkhxUYOKOsVFVyiZtuocag7Pnrkf/tU3UHBsUmvUSiKAsoNxsskudH8CsCHaK2ibhaxDxYTpWbfc1t41j+lU+EfDrC0BJROhak8tF9RsK+v9Z//+Pq+HkqfQ861GvoWfiZSSnSpzKqRXK6dtZSZn2CYwAAjJlKJnmHkBxFRIkxyR1ajN90zyZNPYJ0QLpBMw9NSRqktIzJZaKKlECj7pkOT1Ax6jYtDaLw7o4kuCjDCmpa8TSYWB+qqrgiDQINZ6KUFWJcEEFMBBhAVl1A6cKc6JAB7L/+5RoCQD0011a8kw2EgAADSAAAAEY8YFl7D0yyAAANIAAAAQNgABzD0a1supdApjLhq8XMHTBkUaKyAlVL/+5fAYEgSCYXxuLxsB4eRFU2hMVz5v//u7u9MlNOE0TrIo5PKpPoGQmeTTYgWsgYeYeokWNKIkezRilHnsYq6QPLKLKfEphFRRxzQhFwqdOwsop6k4tkjbROJWiRnJf/TgsWlVvr7KeV3jlMtj9FOhgDEJlCyyAo7kMXbWMehIBeVGIotR1E6lX5XavtIRMGmAqYCzEF8eljZf5Jve23j05y3k7R5KA2Qko5ATyrQ1wL8ZSGbtnSBAgFDwEFIdFgaBEgBJ0iYoMiNAQEgrC4JnwoZDYUGw+QC4VKCo+mhPm0Z0620SOQLrMtISIrhLzRtGmdOl7I7JLeeRqKTYEwfcKjYhIkmSEQkJmMirKiVoZo/SByAUEhGFzYrkZOrMUgRPPLuYOryRInO8simrMKDvQPHzh8+RoIAMDEEpUDfGu2wD/+5RoBgD0uVNaceM2AgAADSAAAAEVDX1hLDDRyAAANIAAAATPEzAYUJ3Fp/s7AhgBAQAxqPp9fVfTV2BDE4QQ+iaGsPSsvoatmaNE4EAC0UiJhLfNC7KiDwGkABAGBEwkUkmXqZ5fKQLWnCakkVUsgYYU5/QtFJFKStIwbPo5t3KeX1/rs2GkziiaR6CZh6qNKRirnMJHSaa7yoO41NfCRiLELyOp9xit5Yj1Lx9ycASgAALVsa03D4XqhTAuX6uwYXMRhL9M5iWdyvm+xUlgCCwAcCgZCCDVSdUepdevjOGVqZ5acuxUXmBhESzo1QSyVlB8TjIrF5havPS2YH54jKtC8XU8LqAeq0JKXUKGI+JgpHD2KWSfFUZ8xJPUDUVoHoJSd0rCUfRTEsc573w7venV96BWl7kXXiUHgnp2pIdssgbtaQSk4rlsD4uA3N5WaTPUpHJmusAYQEigBU5XfeAuIn1T3rV6NsjZVJ5U3CEBQRnEhq/xb3oX4+ieoS//+5RoFAD1G1FZYw9MQgAADSAAAAEbIZFhrDBbiAAANIAAAASUUavtSr+DChxW9cGQ4s6nELI0W1Dnr5cnlzRtHqBNZVNg4iSSUkjXSQrLs9E9ydmMmjRk5BEjbIAqJhK+UUoyRKqxl5a1cUpb4fFZujb0/eu20qptcsyulJzTlkpSS9fdStONnljM4zZdPSXGEfh2g0oKjLNkV6b2aLKAIuABsAEJxv8qQqGX7D1XbSAUMSQoW3AECNQgUc0DS5WHf5poVAWieZ9ZiacuH3Yq4SqYdtiagBdxXKB6NBdJQ0uSg6up/5DEKGmpaQ2PDh07fMD88QTqNl05dOFjbClDJ5aJA5gWHkgkwRk4giLFVs+Eo2OXC0e67Rb55Gbvkhhsno15cXFVUmEIxH4PTIKTAph6XSLh8Tj6xkqZXFyE/qcHCwtr0Mnn76xhewdoUBmJBmJBXPyyWiqtRl1bSVrreKHHKpr/q0/ejYuti2exQ2U73n6y/mM1dQcA0AACaU//+6RoA4L2eGBX0wxN4gAADSAAAAEZmXVWzL00yAAANIAAAASssgHBg6/DbK2XQCpWBVm0i5aRqTXGXNJZzFK0ojETuS6Pv/p40H0yFD0+V5AArAHRoCCelI6Sp6ni88eqe2VmSQmEgSCYnNBLEgSyKISsQQaiUTjJ9bRHDr3t5ApqZxqDlW+eNh8RSWOxqEx2OthKPnmL6iPUGywwMy2ZmYlr1gkQlghnRi8iPjFCMC0lFKwWEURssibJ0ZGnqSN6kCOkCNRK1gFGl2QkITYVBgFhpBaEy0aBuRRA5eLapwZ90TiSWlEUu1/8DSCAFqSkQcCUcodVkxfQ4XzOOA0zZWtqCstnMpuLyiRNYhlMdAgLKBiINEMMIDEr0NZlCpmGVxWXbgzQla8L+StRk7C/MYOQR8fZEiFF6YUNiqZRSG9q8wu2QBgkMEZsQFyIRB8kFS4VFJkUrH9HECMRisNmBGCaIEBGKh0OiYUiJsMqAkKlRoaIkSaEyKBA0QHidYy2gJz5gmOoCJUh4lEpkwSGGTq9o4Y2xOk11HuIk0JZEkKmrVQillDuxi5FYmCP1ylVgq7g29wrR2lAAgBXSb6nE7XbskOZs59uDgKPKymDT1DffSUq2PIhwORgVs4RMxT/+6RoE4T3GGBUmzhi8gAADSAAAAEcUYFOzL05CAAANIAAAAQcGAqkutQO/TwOnSQ1DNOuRExAIlYjOoEg6gJW6oEg8oNA7k2EfsL38WHkIhj6B8ChLEgGRBD1ElUMC8ShEEQGgiADgfE4AgPiMLQ+CkJTADxLHEGIejiKQsE5QSRLF5IUiOVy4nOC2akI/IKaImj6RRsNjEzMTMuMxxKlLya56dC4exSesFMumJqhk5NGhwQtxp86+nBwwtBuOw4OB+VzKVxZE8pxpztjWKnyYwPT91DddCMUelvLluXz20AAArMgDZbMLbiQpua6zvyNxa9e++pe8Alm2eBozUZM4FtG+fmeo6aRR2u5DWUJaXYgEL0g40GjJdODBzAm2f2FCVyGGgaBOHpCzcNg3ywm8W4yiVJ46y2PWNqHwLATMmwtBDB5CSmYLccaRMkeJLx9meuCQHCXM7DdN0uxhtBKl0eJeTpS5jl6J8chssyGFvNNQKo6VMjlKCLg+CoVEoGUYiNGyYrMjm9dXS5fhgD2hYHzBENnjbkpIVGUKqizQWJhV+aPtNuRaxO2a3vdJtG3aTLC7JtpGEnK8cOVl1VLaTvFCAAAL3W6V3gRsM9ANWGU5dypQxGBliAUuWcAw5v/+6RoDob3BGBTs1hkdAAADSAAAAEYXYFOzLB+yAAANIAAAAScbk0arZzMFKkgRLczhCiC45mGXFLurVgKUQqHIcdhrECtPa5BzWotSxmna01hdip23XgyVf63F7LleRdKmqwrIXpd5uTNHjcVmy9WXQC3jPnGi3wG3Oy0x232a65ThP+/r7PMvHkSR1J3EE05cX4XzhrimhrD0SyYJxLMCuiOnyhxiJN8l6hVPY15VOk0KePrw30uod6wKmqM2pWBFl6rhBHAcyuIEQMATKx2Sg5PhxaJQhCCsxk3KSAycFrIg2wc6nmBANwgWwIwTlXCIY5L7ElUzAp4XOMkBZ0piETvR+RF7AMASkgUgqgmIKgs/78yqGIxDDOHhcluUHxl2YbfZrDOIeVI0VcytrcFTPO/8UbMuh/GBt2ayw54XPd1mreu6z1924R13XKbrKHGjYciCIo7GSVEiPk9VyVeuOF50cvJUrjTKVbTbZRq9c13Nh27cN/o3T74znXg3lTJFRprsmSVC1y62q/oF3pm2a0po0k3G4ljKhkWem7jZVLbST+M03V+/KtKwZAEAAtzduewhPUtF8jIDPMJHViVhQ0PHoJ6PoykOZpbpsQEJFNCyubIBQMioKnAsTGjzif/+3RoGoD0mGBXUek0wAAADSAAAAEQ+YFbR6TPQAAANIAAAARYlJlTyRU62cVaQltRBRI4kkbv+IYnSKQSJYKciCuRIpG4d510oQMmdY2kvWFJmoVOwkXvRYtE7fVb6yiOVg0EvRyikOmSSY1UXw5GVabodZo3MtE+W5SKTQSxvfLRAbBQABO3/5yC2d6gE8EhOKWHGgPCeD5WCga8WyhCsKlWFEBciELBEVbNqIURGQoSxwushSaVIpUbHxtt6InWixIlKLa7U8LdsnlMdRsUeEhJLRMEvOMksuZ5JbKa125xVH7ZkyRbmLu5Qw4OycrL5ZiTRMMyTO0flwlTPsZKL281BS5RVnbTKoAAApy71gBaEFqGXaz6VmYlSM8NSeL/+4RoCwT0X2BUOekzwAAADSAAAAEQnYFMZ6TPwAAANIAAAAT6+ihGGRCmjBMPDQNPJg20ShbmhO2OHxKcCwCGsVCCJ8AoGiSJbTJPT9WSmkopMolLilkoLCYBqbbmYbHhCCZRmEjHY91UbPOrcSkSCmMV4Yl5NRx4vKSN5hxrlnzOZj7R2tsv8KRxKifRks3ddFFKuRimS3nSAlJb/zsMnEhQo1WNa6OUQol08GzpXFUCoFhEEgSmIy54iFRQZOPQk0kNbfYJiI/bMpP3YUzZ/o+ikIj6xNuxaZTc6i5NMXJ7kC+o5rVraaNPnJdJofVazVV5jZJrnuqfG7/j8rbnNDp7BjGTuKKlE/cSRTfGXDJd1S35cokceZmWmltOqiAAADTcm/qaSMYyZI5IQ0GEiA884Zk0qiWJgPAeFy4mjkSlRbNjExCSCSA08eE0cxL/+2RoGID0SFtRUewyUgAADSAAAAENjTFG47DBqAAANIAAAATy6SkU2SRRBoNGnHVuSqNm4+kZpYlWFpiTjhMivWLeTErEl2WctPEdZ8z+em7ojlgIpJUB6xj2PmkTGrKRq5JaX0uyoSiHl9y1b3Mqauo2bnNRc7ROTQeTAEUkm7hAbUvnp2TAlJv1XPaZk05hJhJEDIBRJInBMoeAQlTPdaamaQSqcbxjpk8PWGJwleUdBWdbIwkRrZRQyqY9pONO6R5szrW6T4n5uXw/ITZPruD3RamnpReqd15p42+YuZjbYtiFaU5rdQSC9uC8Mjv/+3RoA4Dzok7OGYwxcgAADSAAAAEOkTk3Rhhz6AAANIAAAAQyAoGgyXPE5cPYdAyPh1iUQGRaHMtjwPYirTp9nsYhg5YKrdQIECGhBMgsFIoTq7iamuteprOw8yEzWr6VGerKuZXm6jKBMA0ZryBouWRhNVrA0KWtnybmYKe8mHw3ZyTC8VeyxLKx6pKUTq3JQEBJABLUggVRG4UFpchpUQhHSVa4yYr1I/iKeklS1CiZJQCXkWTUDkgkUkWfYxAmKLYdISSKInmEwx1UFCnLUz175l8aSkmRQJEhWpPc1UumfiDJ6dToXVLxWsMFbYIChQ3ARoFWswUquGyGeykbp5hWMYY1AgBAJRBd39CSwfBgJET0Z7A8shd4eBpBqTn/+2RoDQDzaEJM6SwxwgAADSAAAAEKvMMzpJh8KAAANIAAAAT4mMPOWRhRgIaAhIBRSWZJKVGAVgU0bBIkDDUUi9SqDcWEigoiCkQCSSNhtAoOTLKOFyRLNIslYSRI6a/JLrTSKLOj0tZTXfKx/GMvJI4lhUb/WyI0Q00E7bABKRDJERAqSoTloBQXDIllODkUktogLtoTLE3srLF0xQjUJl1WbZa1hldhs0qJVZobjVKRIGSTKkJMIokjnKjhQGATR2ktbDh8awwNs8ouBDQiBAclhAFAm2RGkaThA2EDgdNQM+kwYSAQXxCWrJETtlP/+zRoEYDyOCpK6OkwugAADSAAAAEHmIMnQSTB6AAANIAAAAQbP6UJhJoBBQlEpPdwyT+5jG9YTVb8SnlNJUQYyixmpFu0eroKDZ3rmgAILaFLlUmRSzSiGKaM4cDTSB5pZYQEnHFnk3GHhyPMcMwelLJYSLzAEVskRoKXFJvxFSCwlgViAISaMVuqIAFxe0//+zRoBYHx3x9IaCFgCgAADSAAAAEGzH8fopknKAAANIAAAASZE7mmVhIILrbb61a8Yy1Esu42FLq1a5Fr3ob1lurWpnH2/6Fx1WifW48jnvqJKDeoAgm25rtn2EQvycBF9NWxR1F6HRU2ZVgt4r9RdcUunbBAxEgLpFzJZEJjSBZeTpK0sPehWHmjagAEXLL/+yRoAgnxIhlIaAEwWgAADSAAAAEDAGEdoAhq6AAANIAAAARdoAABLyZybmbQHgFGf//nI47/mYmidWrXF6icC33TTxQC7aDUcBb+zcwbAMAgIjMYdRkRoDEgpOoAAAADbAAAAf/mQ6bQPFoCWAAE29tqAaCstGT/+xRoDYHwhQDH6AEQCAAADSAAAAEDTE8FoATI6AAANIAAAASEgEjWI0kkpZHKZLISaaKKAAAzBGaNtgAAHDP+cCAhUqhQogBUBCQUFk06U5YABASUdfEVbusFfg1VGub/+xRoFgPw6A8++AIZuAAADSAAAAEBhALqgARAIAAANIAAAAQAA//+VFRUVDIFFRURhgeKior+LExBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xRoHw/wrwCNGAEQCAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpUQUcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/w==",

				levelComplete:
					"data:audio/mp3;base64,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",
			},

			image: {},

			json: {
				joystick: {
					frames: [
						{
							filename: "base",
							frame: {
								x: 2,
								y: 2,
								w: 280,
								h: 280,
							},
							rotated: false,
							trimmed: false,
							spriteSourceSize: {
								x: 0,
								y: 0,
								w: 280,
								h: 280,
							},
							sourceSize: {
								w: 280,
								h: 280,
							},
						},
						{
							filename: "button1-down",
							frame: {
								x: 2,
								y: 284,
								w: 132,
								h: 132,
							},
							rotated: false,
							trimmed: false,
							spriteSourceSize: {
								x: 0,
								y: 0,
								w: 132,
								h: 132,
							},
							sourceSize: {
								w: 132,
								h: 132,
							},
						},
						{
							filename: "button1-up",
							frame: {
								x: 136,
								y: 284,
								w: 132,
								h: 132,
							},
							rotated: false,
							trimmed: false,
							spriteSourceSize: {
								x: 0,
								y: 0,
								w: 132,
								h: 132,
							},
							sourceSize: {
								w: 132,
								h: 132,
							},
						},
						{
							filename: "button2-down",
							frame: {
								x: 270,
								y: 284,
								w: 132,
								h: 132,
							},
							rotated: false,
							trimmed: false,
							spriteSourceSize: {
								x: 0,
								y: 0,
								w: 132,
								h: 132,
							},
							sourceSize: {
								w: 132,
								h: 132,
							},
						},
						{
							filename: "button2-up",
							frame: {
								x: 284,
								y: 138,
								w: 132,
								h: 132,
							},
							rotated: false,
							trimmed: false,
							spriteSourceSize: {
								x: 0,
								y: 0,
								w: 132,
								h: 132,
							},
							sourceSize: {
								w: 132,
								h: 132,
							},
						},
						{
							filename: "button3-down",
							frame: {
								x: 418,
								y: 138,
								w: 132,
								h: 132,
							},
							rotated: false,
							trimmed: false,
							spriteSourceSize: {
								x: 0,
								y: 0,
								w: 132,
								h: 132,
							},
							sourceSize: {
								w: 132,
								h: 132,
							},
						},
						{
							filename: "button3-up",
							frame: {
								x: 404,
								y: 272,
								w: 132,
								h: 132,
							},
							rotated: false,
							trimmed: false,
							spriteSourceSize: {
								x: 0,
								y: 0,
								w: 132,
								h: 132,
							},
							sourceSize: {
								w: 132,
								h: 132,
							},
						},
						{
							filename: "stick",
							frame: {
								x: 404,
								y: 2,
								w: 134,
								h: 134,
							},
							rotated: false,
							trimmed: false,
							spriteSourceSize: {
								x: 0,
								y: 0,
								w: 134,
								h: 134,
							},
							sourceSize: {
								w: 134,
								h: 134,
							},
						},
					],
					meta: {
						app: "http://www.codeandweb.com/texturepacker",
						version: "1.0",
						image: "arcade-joystick.png",
						format: "RGBA8888",
						size: {
							w: 552,
							h: 418,
						},
						scale: "1",
						smartupdate:
							"$TexturePacker:SmartUpdate:10346054b252ab14bb310a8d6bd547c8:95c6dd72d4153222351a2981c3dd9889:a263a0553fca6de61a66e4e620c067cc$",
					},
				},
			},
		};

		// Phaser Game object
		// Game Maker Game Class Game Definition
		// The default variable for Phaser games is
		//
		//      window.game
		//
		// The appshed object for game properties and methods is
		//
		// 		app.game
		//
		// So the code below can be a bit confusing.
		//
		// 		app.game != game   !!!!
		//
		//
		// JSON object
		// Various Phaser game objects can have a JSON string in the Text field of the item
		// This holds various properties and methods that can be used to configure the game
		// These Properties and Methods correlate to Phaser's properties and methods
		//

		window.game = {}; // this will hold the Phaser game object
		window.player = {}; // in most games this is used for the main character

		app.addStyles(
			".box2 .content .icon h3{overflow: inherit; white-space: inherit}"
		);

		app.game = {
			_collectionNames: [
				"preload",
				"create",
				"update",
				"render",
				"arc",
				"audio",
				"circle",
				"collider",
				"config",
				"ellipse",
				"group",
				"image",
				"joystick",
				"keyboard",
				"line",
				"multiline",
				"overlap",
				"otherFunction",
				"pointer",
				"polygon",
				"rectangle",
				"settings",
				"sprite",
				"staticGroup",
				"text",
				"tileset",
				"tileSprite",
			],
			_default_width: 800,
			_default_height: 600,
			_delayActionTypes: [
				"overlap",
				"collider",
				"joystick",
				"keyboard",
				"otherFunction",
				"pointer",
				"update",
			],
			_gyroPreviousH: 0, // remember the last gyro movement, horizontal and vertical
			_gyroPreviousV: 0,
			_installed: false,
			_jsonCommentProperties: [
				"synopsis",
				"editTop",
				"mainProperties",
				"dataProperties",
				"bodyProperties",
				"actionTop",
			], // all the comment properties
			_jsonPropertyGroups: ["body", "data", "comments"], // the groups of properties in the JSON, apart from Main Properties
			_menuAdded: false,
			_funcs: [], // an array to hold functions that run during the game, e.g. update()
			_funcsObjectList: "", // holds a string listing all the objects for quick ref in funcs
			_funcsObjectListDone: false, // indicates the _funcsObjectList has been prepared
			_guis: {}, // place to hold the gui objects
			_ide: "objects", // what state the IDE is in
			_pause: false, // hidden property to pause wihin the update
			_onPause: null, // function to run when _pause detected
			_requireRestart: false, // If true, the game will be stopped and restarted when viewing game. This flag set when editing objects
			_toolTypes: [],
			_validConfigKeys: [
				"width",
				"height",
				"zoom",
				"resolution",
				"type",
				"parent",
				"canvas",
				"canvasStyle",
				"context",
				"scene",
				"seed",
				"title",
				"url",
				"version",
				"autoFocus",
				"input",
				"disableContextMenu",
				"banner",
				"dom",
				"fps",
				"render",
				"backgroundColor",
				"callbacks",
				"loader",
				"images",
				"physics",
				"plugins",
			], // Valid keys that can be used in the Game Config
			_visibleTypes: [
				"arc",
				"circle",
				"ellipse",
				"image",
				"line",
				"multiline",
				"polygon",
				"rectangle",
				"sprite",
				"spriteSheet",
				"text",
				"tileSprite",
			],

			enableGyro: true,
			graphics: null, // holds the graphics object used to create geometry
			height: this._default_height,
			isStickDown: true,
			keys: {}, // hold all the Phaser Key objects
			parent: null,
			renderer: null,
			state: null,
			stateName: "Game",
			this: null, // holds the `this` from the scene
			width: this._default_width,

			// ===============================================================================
			// Containers for the Game Objects and Preperties
			// ===============================================================================

			preload: {},
			create: {},
			update: {},
			render: {},

			score: 0,
			scoreText: "",

			// Objects to hold game assets
			arc: {},
			audio: {},
			cameraAdjust: {
				tileSprite: {},
				sprite: {},
			}, // objects that need to be adjusted relative to the camera
			circle: {},
			collider: {}, // holds details of all collider items
			collision: {}, // holds the state of collissions in the format collision['object1_object2'] = true
			config: {},
			ellipse: {},
			group: {},
			image: {},
			joystick: {},
			keyboard: {},
			keyCode: {}, // object holding arrays of Javascript for each key, allows for multiple scripts to be assiciated to every key
			line: {},
			multiline: {},
			object: {}, // holds various user created objects of no specific type
			overlap: {},
			otherFunction: {}, // holds function items
			pointer: {},
			polygon: {},
			rectangle: {},
			settings: {}, // Holds particular settings for a game. Was config{}, need to rename to settings{} because Phaser 3 uses game.config{}
			sprite: {},
			staticGroup: {},
			text: {},
			tileset: {},
			tileSprite: {},

			// ===============================================================================

			_bodyPropertiesDescriptor: {
				acceleration: {
					vector: true,
				},
				allowDrag: {},
				allowGravity: {},
				allowRotation: {},
				angularAcceleration: {},
				angularVelocity: {},
				bounce: {
					vector: true,
				},
				checkCollision: {},
				collideWorldBounds: {},
				debugBodyColor: {},
				deltaMax: {
					vector: true,
				},
				debugShowBody: {},
				debugShowVelocity: {},
				drag: {
					vector: true,
				},
				enable: {},
				friction: {
					vector: true,
				},
				gravity: {
					vector: true,
				},
				immovable: {},
				isCircle: {},
				mass: {},
				maxVelocity: {
					vector: true,
				},
				moves: {},
				pushable: true,
				useDamping: {},
				velocity: {
					vector: true,
				},
			},

			// an array of sections and tools for the Game panel
			//  synopsisProperties: List each of the properties that should be shown in the synopsis to make it easy to identify the object. The array is foreach row in the html, with multiple keys shown on each row. the Value is the fully qualified  descriptor of the property (of the obj Object), as a string, e.g. "data.bounds.width" will be obj.data.bounds.width
			_tools: [
				{
					name: "Game Setup",
					icon: "tab",
					tools: [
						{
							name: "Game Config",
							type: "config",
							icon: "icon-play-circle",
							itemTitle: "gameConfig",
							itemImageId: 8027100,
							fixedImage: true,
							itemText:
								'{ "width": 320, "height": 450, "hidden": false, "scale": {"mode": "Phaser.Scale.FIT", "autoCenter": "Phaser.Scale.CENTER_BOTH"}, "gravity": { 	"x": 0, 	"y": 0 }, "debug": false, "origin": 0.5, "bounds": { 	"width": 320, 	"height": 450 }, "data": { "test": true	 } }',
							itemCustomClass: "phaser phaser-setup phaser-config",
							synopsisProperties: [
								{
									width: "JSON.width",
									height: "JSON.height",
								},
								{
									"gravity.x": "JSON.gravity.x",
									"gravity.y": "JSON.gravity.y",
								},
							],
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"LyoKVGhpcyBpcyB0aGUgbWFpbiBzY3JpcHQgb2YgdGhlIGdhbWUuClRoZSBmaXJzdCBsaW5lIGxhdW5jaGVzIHRoZSBnYW1lLCBhbmQgY29ubmVjdHMgYWxsIHRoZSBHYW1lIE1ha2VyIG9iamVjdHMgdG8gdGhlIFBoYXNlciBlbmdpbmUuClRoZSBmaXJzdCBsaW5lIG11c3Qgbm90IGJlIGNoYW5nZWQgb3IgcmVtb3ZlZDogZXZhbChhcHAuZ2FtZS5ydW4oKSk7CgpBbnkgdmFsaWQgUGhhc2VyMyBKYXZhU2NyaXB0IGNhbiBiZSBhZGRlZCB0byB0aGlzIHNjcmlwdC4gVGhpcyBpbmNsdWRlcyB2YXJpYWJsZXMgYW5kIG1ldGhvZHMsIGFuZCBldmVuIGNsYXNzZXMuCihTZWUgd3d3LnBoYXNlci5pbyBmb3IgZnVsbCBkb2N1bWVudGF0aW9uIG9mIFBoYXNlcjMpCgpUaGUgbWFpbiBtZXRob2RzIG9mIGFueSBQaGFzZXIgZ2FtZSBhcmU6CiAgcHJlbG9hZCgpCiAgY3JlYXRlKCkKICB1cGRhdGUoKQogIHJlbmRlcigpCiAgClRoZXNlIG1ldGhvZHMgY2FuIGJlIHBvcHVsYXRlZCBpbiB0aGlzIHNjcmlwdC4gQnV0IHRoZXkgYXJlIG9wdGlvbmFsIC0gdGhpcyBzY3JpcHQgZG9lcyBub3QgbmVlZCB0byBpbmNsdWRlIGFueSBjb2RlLgoKVGhlIEdhbWUgT2JqZWN0cyBhbHNvIGNvbnRhaW4gY29kZSBmb3IgdGhlIGdhbWUuClRoZSBHYW1lIE1ha2VyIGVuZ2luZSBjb21iaW5lcyB0aGUgY29kZSBmcm9tIHRoaXMgc2NyaXB0LCB3aXRoIGFsbCB0aGUgR2FtZSBPYmplY3RzLCB0byBjcmVhdGUgdGhlIGZpbmFsIGdhbWUgY29kZS4KKi8KCgovLyBMYXVuY2ggdGhlIGdhbWUKZXZhbChhcHAuZ2FtZS5ydW4oKSk7CgoKLy8gRGVmYXVsdCBQaGFzZXIgbWV0aG9kcy4gCgpmdW5jdGlvbiBwcmVsb2FkICgpCnsKCn0KCgpmdW5jdGlvbiBjcmVhdGUgKCkKewoJCn0KCgpmdW5jdGlvbiB1cGRhdGUgKCkKewoKfQoKCmZ1bmN0aW9uIHJlbmRlcigpCnsKCn0KCgo=",
							},
						},

						{
							name: "Group",
							icon: "icon-th-list",
							itemTitle: "group1",
							itemImageId: 7963111,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-setup phaser-group",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Static Group",
							inactive: false,
							hidden: true,
							icon: "icon-th-list",
							itemTitle: "staticGroup1",
							itemImageId: 7963111,
							fixedImage: true,
							itemText:
								'{"data": {"rows": 4,"cols": 5,"offsetX": 100,"offsetY": 100,"spacingX": 32,"spacingY": 32}}',
							itemCustomClass: "phaser phaser-setup phaser-staticGroup",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gIENyZWF0ZSBhIGdyaWQgb2YgIGJyaWNrcyAKCgpmb3IodmFyIGkgPSAwOyBpPCBkYXRhLmdldCgncm93cycpOyBpKyspewkKCWZvcih2YXIgaiA9IDA7IGogPCBkYXRhLmdldCgnY29scycpOyBqKyspewoJCS8vIENyZWF0ZSBhIHNwcml0ZSB3aXRoaW4gdGhlIHN0YXRpY0dyb3VwCgkJLy8gdXNpbmcgdGhlIGF0dHJpYnV0ZXMgb2YgaW1hZ2UxCgkJdmFyIHNwcml0ZSA9IG9iamVjdC5jcmVhdGUoCgkJCWRhdGEuZ2V0KCdvZmZzZXRYJykrKGoqZGF0YS5nZXQoJ3NwYWNpbmdYJykpLAoJCQlkYXRhLmdldCgnb2Zmc2V0WScpKyhpKmRhdGEuZ2V0KCdzcGFjaW5nWScpKSwKCQkJJ2ltYWdlMScpOwoJfQp9",
							},
						},

						{
							name: "Camera",
							inactive: true,
							icon: "icon-facetime-video",
							itemTitle: "camera1",
							itemImageId: 0,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-setup phaser-camera",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
					],
				},
				{
					name: "Sprites",
					icon: "standard",
					tools: [
						{
							name: "Image",
							icon: "icon-picture",
							itemTitle: "image1",
							itemImageId: 7957318,
							itemText:
								'{"x": 41,"y": 136,"width": 32,"height": 32,"group": ""}',
							itemCustomClass: "phaser phaser-object phaser-image",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Sprite",
							type: "sprite",
							icon: "icon-star",
							itemTitle: "sprite1",
							itemImageId: 7957354,
							itemText:
								'{"x": 175,"y": 390,"width": 22,"height": 22,"group": "","body": {"collideWorldBounds": false,"bounce": {"x": 0,"y": 0}}}',
							itemImage:
								"http://appshed-id-images.s3-website-eu-west-1.amazonaws.com/6657056",
							itemCustomClass: "phaser phaser-object phaser-sprite",
							synopsisProperties: [
								{
									x: "JSON.x",
									y: "JSON.y",
								},
								{
									width: "width",
									height: "height",
								},
								{
									group: "group",
								},
							],
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIGFjdGlvbiBvbiBhIFNwcml0ZQovLyBUaGlzIEFjdGlvbiBpcyBjYWxsZWQgb25jZSBpbiB0aGUgZ2FtZSAiY3JlYXRlKCkiIG1ldGhvZC4KLy8gVGhlIGZvbGxvd2luZyB2YXJpYWJsZXMgYXJlIGF2YWlsYWJsZSBpbiB0aGlzIGNvbnRleHQ6Ci8vIAlvYmplY3QgLSB0aGUgU3ByaXRlIGdhbWUgb2JqZWN0LCBpLmUuIGFwcC5nYW1lLnNwcml0ZVsidGhpc05hbWUiXQovLyAJZGF0YSAtIHRoZSBkYXRhIG9iamVjdAovLyAgdGhpcyAtIHRoZSBQaGFzZXIgZ2FtZSBvYmplY3QKCgoKLy8gU2V0IGEgdmFyaWFibGUgdG8gc2hvdyBpZiB0aGUgYmFsbCBpcyBvbiB0aGUgcGxheWVyCgpvYmplY3Quc2V0RGF0YSgnb25wbGF5ZXInLCB0cnVlKTs=",
							},
						},
						{
							name: "Sprite Sheet",
							icon: "icon-user",
							itemTitle: "player",
							itemImageId: 8641124,
							itemText:
								'{"x": 175,"y": 422,"width": 104,"height": 24,"group": "","body": {"immovable": true}}',
							itemCustomClass: "phaser phaser-object phaser-spriteSheet",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Tile Sprite",
							icon: "icon-cloud",
							itemTitle: "tileSprite1",
							itemImageId: 7973547,
							itemText:
								'{"x": 175,"y": 225,"width": 350,"height": 450,"group": "group1"}',
							itemCustomClass: "phaser phaser-object phaser-tileSprite",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},

						{
							name: "Audio",
							icon: "icon-volume-up",
							itemTitle: "audio1",
							itemImageId: 7973689,
							fixedImage: true,
							itemText: "{}",
							itemCustomClass: "phaser phaser-object phaser-audio",
							helpText:
								'<div class="warning">You must select the Sound File (Action tab) every time you edit an audio object.</div>',
							action: {
								value: "sound",
								content: 148431,
							},
						},
						{
							name: "Text",
							icon: "icon-font",
							itemTitle: "score",
							itemImageId: 7974003,
							fixedImage: true,
							itemText: '{"x": 130,"y": 10,"text": "Score: 0","group": ""}',
							itemCustomClass: "phaser phaser-object phaser-text",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
					],
				},

				{
					name: "Graphics",
					icon: "advanced",
					tools: [
						{
							name: "Rectangle",
							inactive: false,
							icon: "icon-stop",
							itemTitle: "rectangle1",
							itemImageId: 8026970,
							fixedImage: true,
							itemText:
								'{"x": 175,"y": 225,"width": 30,"height": 20,"fill_color": "0x7A7A7A","stroke_color": "0xFFFFFF","stroke_width": 1,"group": ""}',
							itemCustomClass: "phaser phaser-graphic phaser-rectangle",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Circle",
							inactive: false,
							icon: "icon-adjust",
							itemTitle: "circle1",
							itemImageId: 8026970,
							fixedImage: true,
							itemText:
								'{"x": 180,"y": 125,"radius": 30,"fill_color": "0x7A7A7A","stroke_color": "0xFFFFFF","stroke_width": 1,"group": ""}',
							itemCustomClass: "phaser phaser-graphic phaser-circle",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Line",
							inactive: false,
							icon: "icon-minus",
							itemTitle: "line1",
							itemImageId: 8026970,
							fixedImage: true,
							itemText:
								'{"x1": 120,"y1": 40,"x2": 180,"y2": 100,"stroke_color": "0xFFFFFF","stroke_width": 1,"group": ""}',
							itemCustomClass: "phaser phaser-graphic phaser-line",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "MultiLine",
							inactive: false,
							icon: "icon-code-fork",
							itemTitle: "multiline1",
							itemImageId: 8026970,
							fixedImage: true,
							itemText: '{"points": "25,100,50,200,75,100,100,200"}',
							itemCustomClass: "phaser phaser-graphic phaser-multiline",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Ellipse",
							inactive: false,
							icon: "icon-eye-open",
							itemTitle: "ellipse1",
							itemImageId: 8026970,
							fixedImage: true,
							itemText:
								'{"x": 200,"y": 50,"width": 100,"height": 30,"fill_color": "0x7A7A7A","stroke_color": "0xFFFFFF","stroke_width": 1,"group": ""}',
							itemCustomClass: "phaser phaser-graphic phaser-ellipse",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Arc",
							inactive: false,
							icon: "icon-chevron-up",
							itemTitle: "arc1",
							itemImageId: 8026970,
							fixedImage: true,
							itemText:
								'{"x": 50,"y": 200,"radius": 30, "startAngle": 0, "endAngle": 90, "anticlockwise": false,"fill_color": "0x7A7A7A","stroke_color": "0xFFFFFF","stroke_width": 1,"group": ""}',
							itemCustomClass: "phaser phaser-graphic phaser-arc",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Polygon",
							inactive: false,
							icon: "icon-bookmark",
							itemTitle: "polygon1",
							itemImageId: 8026970,
							fixedImage: true,
							itemText:
								'{"points": "150,150,200,150,200,200,175,175,150,200","fill_color": "0x7A7A7A","stroke_color": "0xFFFFFF","stroke_width": 1,"group": ""}',
							itemCustomClass: "phaser phaser-graphic phaser-polygon",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
					],
				},
				{
					name: "Events",
					icon: "form",
					tools: [
						{
							name: "Collider",
							icon: "icon-resize-small",
							itemTitle: "collider1",
							itemText: '{"a": "sprite1","b": ["staticGroup1","image1"]}',
							itemImageId: 7963106,
							fixedImage: true,
							itemCustomClass: "phaser phaser-event phaser-collider",
							helpText:
								"The special properties (a & b) define the Objects or Groups involved in the collision.",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIHVzZSBvZiBhIENvbGxpZGVyIEFjdGlvbgovLyBUaGlzIEFjdGlvbiBpcyBjYWxsZWQgZXZlcnkgdGltZSB0aGUgY29saXNzaW9uIGJldHdlZW4gImEiIGFuZCAiYiIgb2NjdXJzLgovLyBUaGUgZm9sbG93aW5nIHZhcmlhYmxlcyBhcmUgYXZhaWxhYmxlIGluIHRoaXMgY29udGV4dDoKCi8vIG9iamVjdCAtIFRoaXMgb2JqZWN0Ci8vIHRoaXMgLSB0aGUgR2FtZSBPYmplY3QKLy8gCW9iamVjdEEgLSBUaGUgZmlyc3Qgb2JqZWN0IGludm9sdmVkIGluIHRoZSBjb2xsaXNpb24KLy8gCW9iamVjdEIgLSBUaGUgc2Vjb25kIG9iamVjdCBpbnZvbHZlZCBpbiB0aGUgY29sbGlzaW9uCgoKCi8vIEluY3JlbWVudCB0aGUgc2NvcmUgYnkgMQovLyBJZiB0aGVyZSBpcyBhIFRleHQgT2JqZWN0IGNhbGxlZCBzY29yZSwgaXQgd2lsbCBhdXRvbWF0aWNhbGx5IGdldCB1cGRhdGVkIHdpdGggdGhlIGFwcC5nYW1lLnNjb3JlCmFwcC5nYW1lLnNjb3JlICs9IDE7CgoKLy8gUGxheSBhIHNvdW5kIAp0cnl7CglhdWRpbzEucGxheSgpOwp9Y2F0Y2goZXIpe30KCgoKLy8gRGlzYWJsZSB0aGUgb2JqZWN0IHRoYXQgd2FzIGhpdApvYmplY3RCLmRpc2FibGVCb2R5KHRydWUsIHRydWUpOwoKLy8gcmVidWlsZCB0aGUgZ3JpZCBpZiBhbGwgb2JqZWN0cyBoaXQJCnRyeXsKICBpZihzdGF0aWNHcm91cDEgJiYgc3RhdGljR3JvdXAxLmNvdW50QWN0aXZlKCkgPT09IDApewoJc3RhdGljR3JvdXAxLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24gKHNwcml0ZSkgewoJCS8vIEVuYWJsZSB0aGUgYm9keSBvZiBlYWNoIGJsb2NrLCBhbmQgbWFrZSBpdCB2aXNpYmxlICh0cnVlKSAKCQlzcHJpdGUuZW5hYmxlQm9keShmYWxzZSwgMCwgMCwgdHJ1ZSwgdHJ1ZSk7CQkKCX0pOwogIH0KfWNhdGNoKGVyKXt9",
							},
						},
						{
							name: "Overlap",
							icon: "icon-copy",
							itemTitle: "overlap1",
							itemImageId: 7963112,
							fixedImage: true,
							itemText: '{"a": "player","b": "sprite1"}',
							itemCustomClass: "phaser phaser-event phaser-overlap",
							helpText:
								"The special properties (a & b) define the Objects or Groups involved in the overlap.",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIHVzZSBvZiBhbiBPdmVybGFwIEFjdGlvbgovLyBUaGlzIEFjdGlvbiBpcyBjYWxsZWQgZXZlcnkgdGltZSB0aGUgb2JqZWN0cyAiYSIgYW5kICJiIiBvdmVybGFwLgovLyBUaGUgZm9sbG93aW5nIHZhcmlhYmxlcyBhcmUgYXZhaWxhYmxlIGluIHRoaXMgY29udGV4dDoKCi8vIG9iamVjdCAtIHRoaXMgb2JqZWN0Ci8vIHRoaXMgLSB0aGUgR2FtZSBPYmplY3QKLy8gCW9iamVjdEEKLy8gCW9iamVjdEIKCgovLyBwbGF5IGEgc291bmQKaWYgKHR5cGVvZiBhdWRpbzEgIT09ICd1bmRlZmluZWQnKXsKCWF1ZGlvMS5wbGF5KCk7Cn0KCgovLyByZXZlcnNlIHRoZSB2ZWxvY2l0eSBvZiB0aGUgYmFsbC9zcHJpdGUKaWYgKHR5cGVvZiBzcHJpdGUxICE9PSAndW5kZWZpbmVkJyl7CglpZighc3ByaXRlMS5nZXREYXRhKCdvbnBsYXllcicpKXsKCQlzcHJpdGUxLmJvZHkudmVsb2NpdHkueSAqPSAtMTsgCgl9CQp9CgoKLy8gQ2FsbCB0aGUgT3RoZXIgRnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBib3VuY2UgYW5nbGUKaWYgKHR5cGVvZiBmdW5jdGlvbjEgIT09ICd1bmRlZmluZWQnKXsKCWZ1bmN0aW9uMS5jYWxsKHRoaXMpCn0=",
							},
						},
						{
							name: "Keyboard",
							icon: "icon-th",
							itemTitle: "w",
							itemImageId: 7965627,
							fixedImage: true,
							itemText: '{"key": "w","data": {"delta": -1}}',
							itemCustomClass: "phaser phaser-event phaser-keyboard",
							helpText:
								"Valid values for key are: A, ALT, B, BACKSPACE, BACKTICK, BACK_SLASH, C, CAPS_LOCK, CLOSED_BRACKET, COMMA, CTRL, D, DELETE, DOWN, E, EIGHT, END, ENTER, ESC, F, F1, F2, F3, F4, F5, F6, F7, F8, F9, F10, F11, F12, FIVE, FORWARD_SLASH, FOUR, G, H, HOME, I, INSERT, J, K, L, LEFT, M, MINUS, N, NINE, NUMPAD_EIGHT, NUMPAD_FIVE, NUMPAD_FOUR, NUMPAD_NINE, NUMPAD_ONE, NUMPAD_SEVEN, NUMPAD_SIX, NUMPAD_THREE, NUMPAD_TWO, NUMPAD_ZERO, O, ONE, OPEN_BRACKET, P, PAGE_DOWN, PAGE_UP, PAUSE, PERIOD, PLUS, PRINT_SCREEN, Q, QUOTES, R, RIGHT, S, SEMICOLON, SEVEN, SHIFT, SIX, SPACE, T, TAB, THREE, TWO, U, UP, V, W, X, Y, Z, ZERO",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIHVzZSBvZiBhIEtleWJvYXJkIEFjdGlvbgovLyBUaGlzIEFjdGlvbiBpcyBjYWxsZWQgZXZlcnkgdGltZSB0aGUga2V5IGlzIHByZXNzZWQuCi8vIFRoZSBrZXkgbXVzdCBiZSBzZXQgaW4gdGhlIHByb3BlcnRpZXM6CgpwbGF5ZXIueSArPSBkYXRhLmdldCgnZGVsdGEnKQ==",
							},
						},
						{
							name: "Pointer",
							inactive: false,
							icon: "icon-arrow-up",
							itemTitle: "pointer1",
							itemImageId: 8640887,
							fixedImage: true,
							itemText:
								'{"on_pointerdown": true,"on_pointerdownoutside": false,"on_pointermove": false,"on_pointerout": false,"on_pointerover": false,"on_pointerup": false,"on_pointerupoutside": false,"object_name": "","data": {}}',
							itemCustomClass: "phaser phaser-event phaser-pointer",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gSWYgdGhlIHBvaW50ZXIgaXMgZG93biwgc2VuZCB0aGUgYmFsbCBvZmYgYnkgc2V0dGluZyB4IGFuZCB5IHZlbG9jaXR5LgppZiAoc3ByaXRlMS5nZXREYXRhKCdvbnBsYXllcicpKQp7CglzcHJpdGUxLnNldFZlbG9jaXR5KC03NSwgLTMwMCk7CgkKCS8vIFNhdmUgdGhlIGRhdGEgdG8gc2hvdyB0aGF0IHRoZSBzcHJpdGUgaXMgbm8gbG9uZ2VyIG9uIHRoZSBwbGF5ZXIuCglzcHJpdGUxLnNldERhdGEoJ29ucGxheWVyJywgZmFsc2UpOwp9Cg==",
							},
						},
						{
							name: "Joystick",
							inactive: false,
							icon: "icon-hand-up",
							itemTitle: "joystick1",
							itemImageId: 8620863,
							fixedImage: true,
							itemText:
								'{"on_up": true,"on_down": true,"on_left": true,"on_right": true,"on_up_left": true,"on_up_right": true,"on_down_left": true,"on_down_right": true,"base_color": "0x888888","base_alpha": 0.2,"thumb_color": "0x101010","thumb_alpha": 0.2,"force_min": 10,"radius": 40,"data": {}}',
							itemCustomClass: "phaser phaser-event phaser-joystick",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIHVzZSBvZiBhIEpveXN0aWNrIEFjdGlvbgovLyBUaGlzIEFjdGlvbiBpcyBjYWxsZWQgZXZlcnkgdGltZSB0aGUgam95c3RpY2sgaXMgdXBkYXRlZC4KLy8gVGhlIERhdGEgUHJvcGVydGllcyBkZWZpbmUgd2hlbiB0aGlzIGFjdGlvbiBpcyBjYWxsZWQsIChlLmcuIG9uX3VwKQoKCgovLyBTZXQgdGhlIHBsYXllci54IHRvIGJlIG9mZnNldCBmcm9tIHRoZSBtaWRwb2ludAovLyBhdCBkb3VibGUgdGhlIGZvcmNlIGFwcGxpZWQgYnkgdGhlIGpveXN0aWNrCnBsYXllci54ID0gdGhpcy5jYW1lcmFzLm1haW4ubWlkUG9pbnQueCArICgyKnRoaXMuam95c3RpY2suZm9yY2VYKTsKCi8vICBLZWVwIHRoZSBwbGF5ZXIueCB3aXRoaW4gY2VydGFpbiBib3VuZHMKcGxheWVyLnggPSBQaGFzZXIuTWF0aC5DbGFtcChwbGF5ZXIueCwgNTIsIDI5OCk7CgoKCgovLyBwbGFjZSB0aGUgYmFsbCBvbiB0aGUgcGxheWVyIGlmIHJlcXVpcmVkIAppZiAoc3ByaXRlMSAmJiBzcHJpdGUxLm9ucGxheWVyKQp7CglzcHJpdGUxLnggPSBwbGF5ZXIueDsKfQ==",
							},
						},
						{
							name: "Gyro",
							inactive: true,
							icon: "icon-fullscreen",
							itemTitle: "gyro1",
							itemImageId: 0,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-event phaser-gyro",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Level Done",
							inactive: true,
							icon: "icon-flag",
							itemTitle: "onLevelDone",
							itemImageId: 0,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-event phaser-level-done",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Play",
							inactive: true,
							icon: "icon-play",
							itemTitle: "onGamePlay",
							itemImageId: 0,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-event phaser-game-play",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Pause",
							inactive: true,
							icon: "icon-pause",
							itemTitle: "onGamePause",
							itemImageId: 0,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-event phaser-pause",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "End",
							inactive: true,
							icon: "icon-stop",
							itemTitle: "onGameEnd",
							itemImageId: 0,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-event phaser-game-end",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Other Event",
							inactive: true,
							icon: "icon-time",
							itemTitle: "event1",
							itemImageId: 0,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-event phaser-other-event",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
					],
				},

				{
					name: "Functions",
					icon: "tab",
					tools: [
						{
							name: "Preload",
							icon: "icon-download",
							itemTitle: "preload1",
							itemImageId: 7963107,
							fixedImage: true,
							itemText:
								'{"data": {"colorBg": "0x000000","colorProgressBox": "0x222222","colorProgressBar": "0x00e300","colorText": "0x00e300"}}',
							itemCustomClass: "phaser phaser-function phaser-preload",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIHVzZSBvZiBhIFByZWxvYWQgQWN0aW9uCi8vIFRoaXMgQWN0aW9uIGlzIGNhbGxlZCB3aGVuIHRoZSBnYW1lIGlzIGxvYWRpbmcgYXNzZXRzLCBpLmUuIHRoZSBwcmVsb2FkKCkgZnVuY3Rpb24uCgovLyBUaGlzIHNhbXBsZSBjb2RlIGNyZWF0ZXMgYSBwcm9ncmVzcyBiYXIgd2hpbGUgaW1hZ2VzIGFuZCBvdGhlciBhc3NldHMgYXJlIGxvYWRlZAoKdmFyIHdpZHRoID0gYXBwLmdhbWUudGhpcy5jYW1lcmFzLm1haW4ud2lkdGgKdmFyIGhlaWdodCA9IGFwcC5nYW1lLnRoaXMuY2FtZXJhcy5tYWluLmhlaWdodDsKCnZhciBib3hXaWR0aCA9IDAuOSp3aWR0aDsKdmFyIGJveEhlaWdodCA9IC4wNSpoZWlnaHQ7CnZhciBib3hNYXJnaW4gPSA1Owp2YXIgc3BhY2luZyA9IDIwOwoKdmFyIGNvbG9yQmcgPSBvYmplY3QuZGF0YS5nZXQoJ2NvbG9yQmcnKSB8fCAweDAwMDAwMDsKdmFyIGNvbG9yUHJvZ3Jlc3NCb3ggPSBvYmplY3QuZGF0YS5nZXQoJ2NvbG9yUHJvZ3Jlc3NCb3gnKSB8fCAweDIyMjIyMjsKdmFyIGNvbG9yUHJvZ3Jlc3NCYXIgPSBvYmplY3QuZGF0YS5nZXQoJ2NvbG9yUHJvZ3Jlc3NCYXInKSB8fCAweDAwZTMwMDsKdmFyIGNvbG9yVGV4dCA9IChvYmplY3QuZGF0YS5nZXQoJ2NvbG9yVGV4dCcpIHx8IDB4MDBlMzAwKS5yZXBsYWNlKC9eMHgvLCIjIik7CgoKdmFyIHhNaWQgPSB3aWR0aC8yOwp2YXIgeU1pZCA9IGhlaWdodC8yCgp2YXIgYmcgPSB0aGlzLmFkZC5ncmFwaGljcygpOwp2YXIgcHJvZ3Jlc3NCb3ggPSB0aGlzLmFkZC5ncmFwaGljcygpOwp2YXIgcHJvZ3Jlc3NCYXIgPSB0aGlzLmFkZC5ncmFwaGljcygpOwoKYmcuZmlsbFN0eWxlKGNvbG9yQmcsIDEpOwpiZy5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCnByb2dyZXNzQm94LmZpbGxTdHlsZShjb2xvclByb2dyZXNzQm94LCAxKTsKcHJvZ3Jlc3NCb3guZmlsbFJlY3QoeE1pZC0oYm94V2lkdGgvMiksIHlNaWQtKGJveEhlaWdodC8yKSwgYm94V2lkdGgsIGJveEhlaWdodCk7Cgp2YXIgbG9hZGluZ1RleHQgPSB0aGlzLm1ha2UudGV4dCh7Cgl4OiB3aWR0aCAvIDIsCgl5OiBoZWlnaHQgLyAyIC0gc3BhY2luZywKCXRleHQ6ICdMb2FkaW5nLi4uJywKCXN0eWxlOiB7CgkJZm9udDogJzE2cHggQXJpYWwnLAoJCWZpbGw6IGNvbG9yVGV4dAoJfQp9KTsKbG9hZGluZ1RleHQuc2V0T3JpZ2luKDAuNSwgMC41KTsKCnZhciBwZXJjZW50VGV4dCA9IHRoaXMubWFrZS50ZXh0KHsKCXg6IHdpZHRoIC8gMiwKCXk6IGhlaWdodCAvIDIgK3NwYWNpbmcsCgl0ZXh0OiAnMCUnLAoJc3R5bGU6IHsKCQlmb250OiAnMTJweCBBcmlhbCcsCgkJZmlsbDogY29sb3JUZXh0Cgl9Cn0pOwpwZXJjZW50VGV4dC5zZXRPcmlnaW4oMC41LCAwLjUpOwoKdmFyIGFzc2V0VGV4dCA9IHRoaXMubWFrZS50ZXh0KHsKCXg6IHdpZHRoIC8gMiwKCXk6IGhlaWdodCAvIDIgKyAoc3BhY2luZyoyKSwKCXRleHQ6ICcnLAoJc3R5bGU6IHsKCQlmb250OiAnMTBweCBBcmlhbCcsCgkJZmlsbDogY29sb3JUZXh0Cgl9Cn0pOwphc3NldFRleHQuc2V0T3JpZ2luKDAuNSwgMC41KTsKCnRoaXMubG9hZC5vbigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAodmFsdWUpIHsKCXBlcmNlbnRUZXh0LnNldFRleHQocGFyc2VJbnQodmFsdWUgKiAxMDApICsgJyUnKTsKCXByb2dyZXNzQmFyLmNsZWFyKCk7Cglwcm9ncmVzc0Jhci5maWxsU3R5bGUoY29sb3JQcm9ncmVzc0JhciwgMSk7Cglwcm9ncmVzc0Jhci5maWxsUmVjdCh4TWlkLShib3hXaWR0aC8yKSwgeU1pZC0oYm94SGVpZ2h0LzIpLCBib3hXaWR0aCAqIHZhbHVlLCBib3hIZWlnaHQpOwp9KTsKCnRoaXMubG9hZC5vbignZmlsZXByb2dyZXNzJywgZnVuY3Rpb24gKGZpbGUpIHsKCWFzc2V0VGV4dC5zZXRUZXh0KCdMb2FkaW5nIGFzc2V0OiAnICsgZmlsZS5rZXkpOwp9KTsKCnRoaXMubG9hZC5vbignY29tcGxldGUnLCBmdW5jdGlvbiAoKSB7CgkvL2JnLmRlc3Ryb3koKTsKCXByb2dyZXNzQmFyLmRlc3Ryb3koKTsKCXByb2dyZXNzQm94LmRlc3Ryb3koKTsKCWxvYWRpbmdUZXh0LmRlc3Ryb3koKTsKCXBlcmNlbnRUZXh0LmRlc3Ryb3koKTsKCWFzc2V0VGV4dC5kZXN0cm95KCk7Cn0pOwoK",
							},
						},
						{
							name: "Create",
							icon: "icon-repeat",
							itemTitle: "create1",
							itemImageId: 7963108,
							fixedImage: true,
							itemText:
								'{"data": {"left": true,"right": true,"up": true,"down": true}}',
							itemCustomClass: "phaser phaser-function phaser-create",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIHVzZSBvZiB0aGUgQ3JlYXRlIGZ1bmN0aW9uCi8vIFRoaXMgQWN0aW9uIGlzIGNhbGxlZCBhcyBwYXJ0IG9mIHRoZSBHYW1lLmNyZWF0ZSgpIGZ1bmN0aW9uLgovLyBNdWx0aXBsZSBpbnN0YW5jZXMgb2YgdGhpcyB0eXBlIGNhbiBiZSBhZGRlZAoKLy8gT2JqZWN0cyBhdmFpbGFibGUgYXJlOiAKLy8gIG9iamVjdCAtIHRoaXMgb2JqZWN0IAovLyAgZGF0YSAtIHRoZSBkYXRhIGZvciB0aGlzIG9iamVjdCAgCi8vICB0aGlzIC0gdGhlIEdhbWUgT2JqZWN0CgoKLy8gIEVuYWJsZSB3b3JsZCBib3VuZHMgYmFzZWQgb24gdGhlIGRhdGEgcHJvcGVydGllcwp0aGlzLnBoeXNpY3Mud29ybGQuc2V0Qm91bmRzQ29sbGlzaW9uKAoJZGF0YS5nZXQoJ2xlZnQnKSwKCWRhdGEuZ2V0KCdyaWdodCcpLAoJZGF0YS5nZXQoJ3VwJyksCglkYXRhLmdldCgnZG93bicpCik7CgoKCi8vVGhpcyB2YXJpYWJsZSBpcyBhICJnbG9iYWwiIHRoYXQgaG9sZHMgdGhlIGxhc3QgeCBwb3NpdGlvbiBvZiB0aGUgcGxheWVyLgp3aW5kb3cubGFzdFBsYXllclggPSAxNTU7CgoKCgovLyAgQ3JlYXRlIHNvbWUgYW5pbWF0aW9ucyBmb3Igb3VyIHBsYXllcgp0cnl7CiAgICB0aGlzLmFuaW1zLmNyZWF0ZSh7CiAgICAgICAga2V5OiAnbGVmdCcsCiAgICAgICAgZnJhbWVzOiB0aGlzLmFuaW1zLmdlbmVyYXRlRnJhbWVOdW1iZXJzKCdwbGF5ZXInLCB7IHN0YXJ0OiAwLCBlbmQ6IDMgfSksCiAgICAgICAgZnJhbWVSYXRlOiA1LAogICAgICAgIHJlcGVhdDogLTEKICAgIH0pOwoKICAgIHRoaXMuYW5pbXMuY3JlYXRlKHsKICAgICAgICBrZXk6ICdzdG9wJywKICAgICAgICBmcmFtZXM6IFsgeyBrZXk6ICdwbGF5ZXInLCBmcmFtZTogNCB9IF0sCiAgICAgICAgZnJhbWVSYXRlOiA1CiAgICB9KTsKCiAgICB0aGlzLmFuaW1zLmNyZWF0ZSh7CiAgICAgICAga2V5OiAncmlnaHQnLAogICAgICAgIGZyYW1lczogdGhpcy5hbmltcy5nZW5lcmF0ZUZyYW1lTnVtYmVycygncGxheWVyJywgeyBzdGFydDogNSwgZW5kOiA4IH0pLAogICAgICAgIGZyYW1lUmF0ZTogNSwKICAgICAgICByZXBlYXQ6IC0xCiAgICB9KTsKCgp9Y2F0Y2goZXIpe30KCgo=",
							},
						},
						{
							name: "Update",
							icon: "icon-refresh",
							itemTitle: "update1",
							itemImageId: 7963114,
							fixedImage: true,
							itemText: '{"data": {"yAbovePlayer": 30,"yRespawn": 650}}',
							itemCustomClass: "phaser phaser-function phaser-update",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIHVzZSBvZiB0aGUgVXBkYXRlIGZ1bmN0aW9uCi8vIFRoaXMgQWN0aW9uIGlzIGNhbGxlZCBhcyBwYXJ0IG9mIHRoZSBHYW1lLnVwZGF0ZSgpIGZ1bmN0aW9uLgovLyBNdWx0aXBsZSBpbnN0YW5jZXMgb2YgdGhpcyB0eXBlIGNhbiBiZSBhZGRlZAoKLy8gVGhlIGZvbGxvd2luZyB2YXJpYWJsZXMgYXJlIGF2YWlsYWJsZSBpbiB0aGlzIGNvbnRleHQ6Ci8vICAgdGltZSAtIHBhc3NlZCBmcm9tIFBoYXNlci51cGRhdGUoKQovLyAgIGRlbHRhIC0gcGFzc2VkIGZyb20gUGhhc2VyLnVwZGF0ZSgpCi8vICAgb2JqZWN0IC0gdGhpcyBvYmplY3QKLy8gICBkYXRhIC0gdGhlIGRhdGEgcHJvcGVydGllcyBmb3IgdGhpcyBvYmplY3QKLy8gICB0aGlzIC0gdGhlIEdhbWUgT2JqZWN0CgoKCgppZiAoc3ByaXRlMS55ID4gZGF0YS5nZXQoJ3lSZXNwYXduJykpCnsKCXNwcml0ZTEuc2V0VmVsb2NpdHkoMCk7CglzcHJpdGUxLnNldFBvc2l0aW9uKHBsYXllci54LCBwbGF5ZXIueSAtIGRhdGEuZ2V0KCd5QWJvdmVQbGF5ZXInKSk7CglzcHJpdGUxLnNldERhdGEoJ29ucGxheWVyJywgdHJ1ZSk7Cn0KCgovLyBBcHBseSB0aGUgcmVxdWlyZWQgYW5pbWF0aW9uCi8vIGJhc2VkIG9uIHRoZSBsYXN0IHBvc2l0aW9uIG9mIHRoZSBwbGF5ZXIuCi8vIGUuZy4gSWYgdGhlIHBsYXllciBoYXMgbW92ZWQgbGVmdCwgc2hvdyB0aGUgImxlZnQiIGFuaW1hdGlvbi4KdHJ5ewoJaWYocGxheWVyLnggPCB3aW5kb3cubGFzdFBsYXllclgpewoJCXBsYXllci5wbGF5KCdsZWZ0Jyk7Cgl9ZWxzZSBpZihwbGF5ZXIueCA+IHdpbmRvdy5sYXN0UGxheWVyWCl7CgkJcGxheWVyLnBsYXkoJ3JpZ2h0Jyk7Cgl9ZWxzZXsKCQlwbGF5ZXIucGxheSgnc3RvcCcpOwoJfQoKCS8vIE5vdyBzYXZlIHRoZSBjdXJyZW50IHBsYXllciBwb3NpdGlvbiBmb3IgdGhlIG5leHQgdXBkYXRlIGxvb3AuCgl3aW5kb3cubGFzdFBsYXllclggPSBwbGF5ZXIueDsKfWNhdGNoKGVyKXt9Cgo=",
							},
						},
						{
							name: "Render",
							inactive: true,
							icon: "icon-print",
							itemTitle: "render1",
							itemImageId: 7963113,
							fixedImage: true,
							itemText: "{\n}",
							itemCustomClass: "phaser phaser-function phaser-render",
							action: {
								value: "code",
								codetype: "js",
								base64Content: "",
							},
						},
						{
							name: "Function",
							icon: "icon-wrench",
							itemTitle: "function1",
							itemImageId: 7963110,
							fixedImage: true,
							itemText: '{"data": {"bounceFactor": 10}}',
							itemCustomClass: "phaser phaser-function phaser-otherFunction ",
							action: {
								value: "code",
								codetype: "js",
								base64Content:
									"Ly8gVGhpcyBpcyBhIHNhbXBsZSBKYXZhU2NyaXB0IHNuaXBwZXQgdG8gZGVtb25zdHJhdGUgdGhlIHVzZSBvZiBhIEZ1bmN0aW9uIEFjdGlvbgovLyBUaGlzIEFjdGlvbiBjYW4gYmUgY2FsbGVkIGJ5IG90aGVyIGdhbWUgb2JqZWN0cywgc3VjaCBhcyBhIENvbGxpZGVyIGNhbGxiYWNrLgoKLy8gUGFyYW1ldGVycyBjYW4gYmUgcGFzc2VkIHRvIHRoZSBmdW5jdGlvbiBhbmQgd2lsbCBiZSBhdmlhbGFibGUgYXMgZm9sbG93czoKLy8gYXBwLmdldEl0ZW0oKS5hY3Rpb25QYXJhbXMKCi8vIFRvIHBhc3MgcGFyYW1ldGVycyB0byB0aGlzIGZ1bmN0aW9uLCB1c2U6Ci8vIGZ1bmN0aW9uMS5jYWxsKHRoaXMscGFyYW1zKTsKCgovL2NvbnNvbGUud2FybignaW5zaWRlIGZ1bmN0aW9uMScsdGhpcyxwYXJhbXMpCgoKdmFyIGRpZmYgPSAwOwoKaWYgKHNwcml0ZTEueCA8IHBsYXllci54KQp7CgkvLyAgQmFsbCBpcyBvbiB0aGUgbGVmdC1oYW5kIHNpZGUgb2YgdGhlIHBsYXllcgoJZGlmZiA9IHBsYXllci54IC0gc3ByaXRlMS54OwoJc3ByaXRlMS5zZXRWZWxvY2l0eVgoLTEgKiBkYXRhLmdldCgnYm91bmNlRmFjdG9yJykgKiBkaWZmKTsKfQplbHNlIGlmIChzcHJpdGUxLnggPiBwbGF5ZXIueCkKewoJLy8gIEJhbGwgaXMgb24gdGhlIHJpZ2h0LWhhbmQgc2lkZSBvZiB0aGUgcGxheWVyCglkaWZmID0gc3ByaXRlMS54IC1wbGF5ZXIueDsKCXNwcml0ZTEuc2V0VmVsb2NpdHlYKGRhdGEuZ2V0KCdib3VuY2VGYWN0b3InKSAqIGRpZmYpOwp9CgllbHNlCnsKCS8vICBCYWxsIGlzIHBlcmZlY3RseSBpbiB0aGUgbWlkZGxlCgkvLyAgQWRkIGEgbGl0dGxlIHJhbmRvbSBYIHRvIHN0b3AgaXQgYm91bmNpbmcgc3RyYWlnaHQgdXAhCglzcHJpdGUxLnNldFZlbG9jaXR5WCgyICsgTWF0aC5yYW5kb20oKSAqIDgpOwp9Cgo=",
							},
						},
					],
				},
			],

			// Help Text for all tools
			_toolsHelpText: {
				title:
					"The Object Name can only include letters, numbers and underscore.",
				text: "The JSON describes all the properties of this object.<br>Do not edit this field directly unless you know what you are doing, because you could break your game!",
			},

			_addEditHandler: function (sprite, item) {
				// When the object is clicked open the editor

				try {
					if (app.isAppBuilder) {
						if (sprite.hasOwnProperty("setInteractive")) {
							sprite.setInteractive();
						}
						if (sprite.hasOwnProperty("on")) {
							sprite.on("pointerdown", function (pointer) {
								// make sure option to edit is ticked
								if (jQuery("#gm-setting-editOnClick")[0].checked) {
									// make sure Editor is not open already for another item
									// if toolbox is not hidden, then can open editor
									if (
										jQuery("#popup-container .toolbox.hidden-left").length == 0
									) {
										jQuery(item.element).click();
										// try a few times to click the Edit option
										app.setInterval(
											function () {
												app.game.pause();
												jQuery(".dropdown-menu .icon-edit").click();
											},
											100,
											1000
										);
									}
								}
							});
						}
					}
				} catch (er) {
					console.warn("_addEditHandler", sprite, item, er);
				}
			},

			_addPanelItem: function (obj) {
				// Add an Item using the properties from tool object `obj`
				// Uses the properties from _tool

				// Click to add Image Link
				jQuery(
					".toolbox .tab-content div:nth-child(1)>div:nth-child(4)>a:nth-child(4)"
				)[0].click();

				// Once the Edit Panel is open, call this function
				app._onceEditItem = function () {
					try {
						// Hide the edit-btns untl slow tasks done (like adding Action to JavaScript Editor)
						jQuery("#popup-container .edit-btns").addClass("invisible");
						var autoShowBtns = true;

						// open Edit tab
						jQuery(".form-horizontal .nav-tabs li:nth-child(1)>a")[0].click();

						// Add various features to the Edit Panel
						//app.game._prepareEditPanel(obj)

						// Set the Title
						jQuery("#edit_item #item_title").val(obj.itemTitle);
						jQuery("#item_title").val(
							app.game._fixTitle(jQuery("#item_title").val(), true)
						);

						// Set the Text
						jQuery("#edit_item #item_text").val(obj.itemText);

						// Try format the JSON
						try {
							jQuery("#item_text").val(
								JSON.stringify(JSON.parse(obj.itemText), null, "\t")
							);
						} catch (er) {
							console.warn("_addPanelItem contains invalid JSON", obj, er);
						}

						// click on Clear for image
						jQuery(".file-chooser-clear.btn").click();

						// change the Image displayed in the Editor
						setTimeout(function () {
							jQuery(".file-chooser-image.custom-input").attr(
								"style",
								"background-image: url(https://appshed-id-images.s3-eu-west-1.amazonaws.com/" +
									obj.itemImageId +
									");     background-repeat: no-repeat;     background-size: contain;    background-position: center center;"
							);

							// Item Image
							jQuery("input[name=item_image]").val(obj.itemImageId);
						}, 200);

						// Set CustomClasses
						jQuery("#style_costumclases").val(obj.itemCustomClass);

						// Set the Action
						if (obj.action && typeof obj.action === "object") {
							// Click the Change Action button
							jQuery("#edit_action_trigger").click();

							// find the action box we need
							jQuery(
								'#edit_action_selector div.action[data-value="' +
									obj.action.value +
									'"]'
							).each(function () {
								var jThis = jQuery(this);
								if (
									obj.action &&
									obj.action.base64Content &&
									obj.action.base64Content.length
								) {
									obj.action.atob = atob(obj.action.base64Content);
								}
								var dataValue = jThis.data("value");

								// some values have multiple options
								if (dataValue == "code") {
									if (jThis.data("codetype") == "js") {
										// Don't auto show Save Btns .. need a callback to handle this
										autoShowBtns = false;
										this.click();
										// Set the JS Editor value and show btns when done
										app.utils.setJSField(obj.action.atob, function () {
											jQuery("#popup-container .edit-btns").removeClass(
												"invisible"
											);
										});
									}
								} else if (dataValue == "sound" && obj.action.content) {
									this.click();
									jQuery("input[name=action_sound]").val(obj.action.content);
								} else if (dataValue == "screen") {
									if (
										jQuery(this).data("screentype") == obj.action.screentype
									) {
										this.click();
									}
								} else {
									this.click();
								}
							});
						}

						if (autoShowBtns) {
							jQuery("#popup-container .edit-btns").removeClass("invisible");
						}
					} catch (er) {
						// panel was not ready
						console.warn("ERROR _addPanelItem", er);
					}
				};
			},

			_applyFilter: function () {
				// Apply object filters
				// `this` is the object that changed
				// 	filters work by adding the  allowed class to the .app element
				// 	CSS rules will show items if their collection is in the .app element

				// Create an object to hold the current filter state
				var currentFilters = {};

				// hide the Empty message
				app.game.setEmptyMessage();

				// Get a count of all hidden items
				var countHidden = 0;
				var checkedCollections = 0;

				var showAll = jQuery("#gm-filter-all").prop("checked");
				currentFilters["gm-filter-all"] = showAll;

				// Count ticked collections
				jQuery(".gm-filter-collection").each(function () {
					if (jQuery(this).prop("checked")) {
						checkedCollections++;
					}
				});

				// If any collection not checked, untick All
				if (!showAll) {
					jQuery(".gm-filter-collection").each(function () {
						if (!jQuery(this).prop("checked")) {
							jQuery("#gm-filter-all").prop("checked", false);
						}
					});
				}

				// TOGGLE
				// if not showAll and only 2 collections are now ticked, then 'toggle' between the two collections,
				if (
					!showAll &&
					jQuery(this).prop("checked") &&
					checkedCollections == 2
				) {
					// turn off the previous one and only leave the recently ticked filter on
					jQuery(".gm-filter-collection").prop("checked", false);
					jQuery(this).prop("checked", true);
				}

				// Go through all colelction filters
				jQuery(".gm-filter-collection").each(function () {
					// save the state in currentFilters
					currentFilters[jQuery(this).data("class")] =
						jQuery(this).prop("checked");

					// If showAll, make sure it is ticked
					if (showAll) {
						jQuery(this).prop("checked", true);
					}

					// Add or remove the class to the app (to apply CSS filetering on objects)
					if (jQuery(this).prop("checked")) {
						jQuery(".app").addClass(jQuery(this).data("class"));
						// count hidden items of this class
						countHidden += jQuery(
							".item.phaser-hidden." + jQuery(this).data("class")
						).length;
					} else {
						jQuery(".app").removeClass(jQuery(this).data("class"));
					}
				});

				// Show or hide hidden items using a class on the app
				if (jQuery("#gm-filter-hidden").prop("checked")) {
					currentFilters["gm-filter-hidden"] = true;
					jQuery(".app").addClass("phaser-show-hidden");
					countHidden = 0;
				} else {
					currentFilters["gm-filter-hidden"] = false;
					jQuery(".app").removeClass("phaser-show-hidden");
				}

				// Show 'active' class based on checked status
				jQuery(".gm-filter-collection, .gm-filter").each(function () {
					if (jQuery(this).prop("checked")) {
						jQuery(this).parent().addClass("active");
					} else {
						jQuery(this).parent().removeClass("active");
					}
				});

				// Save currentFilters to local storage
				localStorage["currentFilters"] = JSON.stringify(currentFilters);

				// in case no visible objects, show message
				setTimeout(function () {
					app.game.setEmptyMessage(countHidden);
					app.refreshScroll();
				}, 400);

				// Check for valid object names
				app.game._fixInvalidNames();

				app.scrollTo();
			},

			autoStart: function (id, el) {
				// el is the screen element

				if (!app.isAppBuilder) {
					// use the first config item
					var hasGame = false;
					jQuery(el)
						.find(".phaser-config.item:first")
						.each(function () {
							hasGame = true;
						});

					if (hasGame) {
						setTimeout(() => {
							app.game._launchGame();
						}, 1000);
					} else {
						app.game.hide();
					}
				}
			},

			callGroupSetAll: function (group, obj) {
				// call group.setAll for each of the properties in obj
				// The value can be a single object {} , or an array of objects [ {},{},...],
				// with key/value pairs for properties to be set {key:value}

				if (Array.isArray(obj)) {
					for (var j = 0; j < obj.length; j++) {
						try {
							jQuery.each(obj[j], function (key, value) {
								group.setAll(key, value);
							});
						} catch (er) {
							console.log("callGroupSetAll", obj, group, er);
						}
					}
				} else if (typeof obj === "object") {
					// it's an object, so we only expect one entry
					jQuery.each(obj, function (key, value) {
						group.setAll(key, value);
					});
				}
			},

			checkValidJSON: function (obj, item) {
				var valid = true;

				// Help the user by giving suggestions on error
				try {
					var text = item.getText();

					if (text.length && (!obj || Object.keys(obj).length == 0)) {
						// a common error is to forget the '' if the JSON has complex properties, such as body.immovable needs 'body.immovable'
						if (text.match(/\./g).length) {
							valid = false;
							app.warn(
								1,
								'The JSON for "' + item.getTitle() + '"  is invalid.'
							);
						}
					}
				} catch (er) {
					app.log("Error - check the JSON");
				}

				return valid;
			},

			collideObject: function (name) {
				// Returns the Phaser Object with the key= `name` from the current collision
				// If none found, returns null
				// Uses this.currentObject() which should be a Collider object

				try {
					var curr = app.game.currentObject();

					if (curr && curr.hasOwnProperty("objects")) {
						// check each of the collider objects to see if they match the key
						if (curr.objects.objA.key == name) {
							return curr.objects.objA;
						} else if (curr.objects.objB.key == name) {
							return curr.objects.objB;
						}
					}
				} catch (er) {
					console.log("colliderObject", er);
				}
			},

			_countHidden: function () {
				return jQuery(".items-inner .phaser.item").filter(function () {
					return jQuery(this).css("display") == "none";
				}).length;
			},

			_countVisible: function () {
				return jQuery(".items-inner .phaser.item").filter(function () {
					return jQuery(this).css("display") != "none";
				}).length;
			},

			_create_addMenu: function () {
				// Adds the menu into the game
				// The context of `this` is `game`

				if (app.game._menuAdded) {
					return;
				} else {
					// Add the Close button (x in the top left corner)

					/*
								var sprite = this.add.sprite(15, 15, '_closeButton');
								var shape = new Phaser.Geom.Rectangle(0, 0, 30, 30);
								sprite.setScrollFactor(0)
								app.game.sprite['_closeButton'] = sprite;
					
								sprite.setInteractive(shape, Phaser.Geom.Rectangle.Contains);
								this.children.bringToTop(sprite);
					
								//  Input Event listeners
								sprite.on('pointerdown', function (pointer) {
									if(app.isAppBuilder){
										app.game._doShowObjects();
									}
									app.game.stop(this);		
								},this);
					
					*/
					app.game._menuAdded = true;
				}
			},

			/*
		_createbodyProperties: function (body,params)
		{
	
			var gui = new dat.GUI({ width: 350 });
	
	
			gui.add(body, 'allowDrag');
			gui.add(body, 'allowGravity');
			gui.add(body, 'allowRotation');
			gui.add(body, 'angularAcceleration', -360, 360, 5);
			gui.add(body, 'angularVelocity', -360, 360, 5);
			gui.add(body, 'collideWorldBounds');
			gui.add(body, 'debugShowBody');
			gui.add(body, 'debugShowVelocity');
			gui.add(body, 'enable');
			gui.add(body, 'immovable');
			gui.add(body, 'isCircle');
			gui.add(body, 'mass', 0.1, 10, 0.1);
			gui.add(body, 'moves');
			gui.add(body, 'useDamping');
			gui.addColor(body, 'debugBodyColor');
	
			app.game._createVectorGui(gui, 'acceleration', body.acceleration, -600, 600, 10);
			app.game._createVectorGui(gui, 'bounce', body.bounce, 0, 1, 0.1);
			app.game._createVectorGui(gui, 'deltaMax', body.deltaMax, 0, 60, 1);
			app.game._createVectorGui(gui, 'drag', body.drag, 0, 60, 0.1);
			app.game._createVectorGui(gui, 'friction', body.friction, 0, 1, 0.05);
			app.game._createVectorGui(gui, 'gravity', body.gravity, -600, 600, 10);
			app.game._createVectorGui(gui, 'maxVelocity', body.maxVelocity, 0, 10000, 100);
			app.game._createVectorGui(gui, 'velocity', body.velocity, -600, 600, 10);
	
			var check = gui.addFolder('checkCollision');
			check.add(body.checkCollision, 'left');
			check.add(body.checkCollision, 'up');
			check.add(body.checkCollision, 'right');
			check.add(body.checkCollision, 'down');
	
			return gui;
		},
	
	
		*/

			_createGui: function (obj, params, collection) {
				// Create a GUI based on the object passed in
				// params:
				//   type
				//   name
				//
				// Naming convention to auto-format the GUI
				//   "color" in the name - color controller
				// collection: default is blank for "main" || "data" (data variables) || "body"

				var params = params || {};
				var collection = params.collection || "main";
				var d; // Holds the descriptors

				var fieldJSON = JSON.parse(jQuery("#edit_item #item_text").val());

				// For the Body colection, not all keys will be included, only those that have a descriptor
				if (collection == "body") {
					d = app.game._bodyPropertiesDescriptor;
				}

				var gui = new dat.GUI({
					width: 350,
				});

				try {
					var keys = Object.keys(obj).sort();

					jQuery.each(keys, function (i, key) {
						// get the value for this key
						var val = obj[key];

						// update the data value as the user changes it
						// helpful in game view to see effect

						// if we have a descriptor template, check this key is required
						// if we don't have a descriptor for this, don't include it.
						if (d && !d.hasOwnProperty(key)) {
							//return; // doing all properties
						}

						// If the property starts with _ it should be hidden, don't show it
						if (key.match(/^_/)) {
							return;
						}

						var controller, controller2;

						// =============================================================1
						//
						// The function to run onChange
						//
						// =============================================================1
						var onChangeFn = function (controller, newVal, settings) {
							// When a property changes, need to do different things based on the settings
							// settings: {} an object to define various settings relating to the change
							//    settings: {
							//      subKey: "keyname" - if we are changing a subKey of the Key value
							//    }
							// vectorY is true if its a vector and the y value changed
							//

							var settings = settings || {};

							var fieldJSON = JSON.parse(jQuery("#edit_item #item_text").val());

							// Round numbers sensibly
							if (!isNaN(newVal) && newVal !== true && newVal !== false) {
								// this makes sure booleans aren't made numbers
								newVal = Math.round(newVal * 100) / 100;
							}

							// Phaser mostly works with hex as 0X, but dat.gui uses #
							// Make sure to do this after the number rounding, as 0xFFFFFF is a number!
							if (String(key).match(/color/i)) {
								newVal = String(newVal).replace(/#/, "0x");
							}

							// Fix for  booleans - got converted to 1/0
							if (
								jQuery(controller.domElement)
									.parent()
									.parent()
									.hasClass("boolean")
							) {
								if (newVal == 0) {
									newVal = false;
								} else {
									newVal = true;
								}
							}

							// Set the value on the game object
							if (collection == "data") {
								// DATA GUI

								if (!fieldJSON.hasOwnProperty("data")) {
									fieldJSON.data = {};
								}

								if (settings.subKey) {
									var curr = app.game[params.type][params.name].data.get(key);
									curr[settings.subKey] = newVal;
									app.game[params.type][params.name].data.set(key, curr);

									if (!fieldJSON.data.hasOwnProperty(key)) {
										fieldJSON.data[key] = {};
									}
									fieldJSON.data[key][settings.subKey] = newVal;
								} else {
									app.game[params.type][params.name].data.set(key, newVal);
									fieldJSON.data[key] = newVal;
								}
							} else if (collection == "comments") {
								// Comments GUI

								if (!fieldJSON.hasOwnProperty("comments")) {
									fieldJSON.comments = {};
								}

								// Put in in the JSON with URI encoding
								fieldJSON.comments[key] = encodeURI(newVal);
							} else if (collection == "body") {
								// BODY GUI

								if (!fieldJSON.hasOwnProperty("body")) {
									fieldJSON.body = {};
								}
								// Sometimes we are setting a subKey, e.g. x and y for a vector
								if (settings.subKey) {
									app.game[params.type][params.name].body[key][
										settings.subKey
									] = newVal;
									if (!fieldJSON.body.hasOwnProperty(key)) {
										fieldJSON.body[key] = {};
									}
									fieldJSON.body[key][settings.subKey] = newVal;
								} else {
									app.game[params.type][params.name].body[key] = newVal;
									fieldJSON.body[key] = newVal;
								}
							} else {
								// MAIN GUI

								// Hidden toggle
								if (key == "hidden") {
									// Change the Custom Class CSS to show if newVal true, else hide
									// By default remove hidden
									var customClasses = String(
										jQuery("#style_costumclases").val()
									).replace(/phaser-hidden/, "");
									if (newVal) {
										customClasses += " phaser-hidden";
									}
									jQuery("#style_costumclases").val(customClasses);
									fieldJSON[key] = newVal;

									// Static Group toggle
								} else if (key == "staticGroup") {
									// Change the Custom Class CSS to show if newVal true, else hide
									// By default remove both group types
									var customClasses = String(
										jQuery("#style_costumclases").val()
									)
										.replace(/phaser-group/, "")
										.replace(/phaser-staticGroup/, "");
									if (newVal) {
										customClasses += " phaser-staticGroup";
										// Move the object to this collection
										// Don't need to set app.game[type][name] - this will be set when the item is saved
									} else {
										customClasses += " phaser-group";
									}
									jQuery("#style_costumclases").val(customClasses);
									fieldJSON[key] = newVal;

									// Gravity
								} else if (key == "gravity") {
									if (settings.hasOwnProperty("x")) {
										this.physics.world.gravity.x = newVal;
									}
									if (settings.hasOwnProperty("y")) {
										this.physics.world.gravity.y = newVal;
									}

									fieldJSON[key][settings.subKey] = newVal;

									// Vectors
								} else if (settings.subKey) {
									try {
										if (
											params &&
											params.type &&
											app.game[params.type] &&
											app.game[params.type].hasOwnProperty(params.name) &&
											app.game[params.type][params.name].hasOwnProperty(key) &&
											app.game[params.type][params.name].key.hasOwnProperty(
												settings.subKey
											)
										) {
											app.game[params.type][params.name][key][settings.subKey] =
												newVal;
										}
									} catch (er) {}

									if (!fieldJSON.hasOwnProperty(key)) {
										fieldJSON[key] = {};
									}
									fieldJSON[key][settings.subKey] = newVal;

									// If the existing Game Object has this property, set it (see real time changes)
								} else if (
									params &&
									params.type &&
									app.game[params.type] &&
									app.game[params.type].hasOwnProperty(params.name) &&
									app.game[params.type][params.name].hasOwnProperty(key)
								) {
									app.game[params.type][params.name][key] = newVal;
									fieldJSON[key] = newVal;

									// cannot find anything to do with this property
								} else {
									// just set it on obj
									obj[key] = newVal;
									fieldJSON[key] = newVal;
								}
							}

							// Update the JSON in the text field
							jQuery("#edit_item #item_text").val(
								JSON.stringify(fieldJSON, null, "\t")
							);
						};
						// =============================================================1
						// ================= END onChangeFn   ==========================1
						// =============================================================1

						// Create the controller (or two, if vector)
						// Settings holds specific settings about the change
						var settings = {};
						try {
							// Handle some special cases for different types of values
							// such as Vectors, colors, objects, hidden, staticGroup, or plain

							// Vectors
							if (d && d.hasOwnProperty(key) && d[key].vector) {
								var folder = gui.addFolder(key);

								controller = folder.add(val, "x");
								controller.onChange(function (newVal) {
									onChangeFn(controller, newVal, {
										subKey: "x",
									});
								});

								controller2 = folder.add(val, "y");
								controller2.onChange(function (newVal) {
									onChangeFn(controller, newVal, {
										subKey: "y",
									});
								});

								// Colors
							} else if (String(key).match(/color/i)) {
								// GUI supports # colors
								// Special case: sometimes val is 255 (white)
								if (val == 255) {
									val = 0x00ff00;
								}
								if (typeof val == "number") {
									val = "0x" + Number(16711935).toString(16);
								}
								// if int, change to hex
								obj[key] = String(val).replace(/0x/, "#");
								controller = gui.addColor(obj, key);
								controller.onChange(function (newVal) {
									onChangeFn(controller, newVal);
								});

								// on_  Event states such as on_mouseover... make sure not 1/0
								/*
						}else if(String(key).match(/^on_/) && (val == 0 || val == 1)){
	
							if(val == 0 ){
								val = false;
							}else{
								val = true;
							}
	
							controller = gui.add(obj, key);
							controller.onChange(function(newVal){onChangeFn(controller,newVal)});
						*/
							} else if (false) {
								if (val == 0) {
									val = false;
								} else {
									val = true;
								}

								controller = gui.add(obj, key);
								controller.onChange(function (newVal) {
									onChangeFn(controller, newVal);
								});

								// object_name
							} else if (key == "object_name") {
								// For most cases we just want objects with body
								// But if the object type is Pointer, then we want all visible objects, because you can click on any visible object
								var options = [];
								if (params.type == "pointer") {
									options = app.game._getVisibleObjectNames();
								} else {
									options = app.game._getBodyObjectNames();
								}
								// Add an empty string at the beginning
								options = options.concat([""]);

								// Add the current val (group) if it isn't in the array, to make sure we don't loose custom vals
								if (val > "" && !jQuery.inArray(val, options)) {
									options.push(val);
								}

								options.sort();
								controller = gui.add(obj, key, options);
								controller.onChange(function (newVal) {
									onChangeFn(controller, newVal);
								});

								// Groups
							} else if (key == "group") {
								var options = app.game._getGroupNames().concat([""]);

								// Add the current val (group) if it isn't in the array, to make sure we don't loose custom groups
								if (val > "" && !jQuery.inArray(val, options)) {
									options.push(val);
								}

								options.sort();

								controller = gui.add(obj, key, options);
								controller.onChange(function (newVal) {
									onChangeFn(controller, newVal);
								});

								// Objects
							} else if (val && typeof val == "object") {
								var folder = gui.addFolder(key);
								var subKeys = Object.keys(val);

								jQuery.each(subKeys, function (i, thisSubKey) {
									// for each of the subKeys, add a controller and onChange handler
									var controller;

									if (key == "a" || key == "b") {
										controller = folder.add(
											val,
											thisSubKey,
											app.game._getColliderOptions(val[thisSubKey])
										);

										// Special options for scale sub keys
									} else if (key == "scale" && thisSubKey == "mode") {
										controller = folder.add(val, thisSubKey, [
											"Phaser.Scale.NONE",
											"Phaser.Scale.FIT",
											"Phaser.Scale.ENVELOP",
											"Phaser.Scale.WIDTH_CONTROLS_HEIGHT",
											"Phaser.Scale.HEIGHT_CONTROLS_WIDTH",
											"Phaser.Scale.RESIZE",
										]);
									} else if (key == "scale" && thisSubKey == "autoCenter") {
										controller = folder.add(val, thisSubKey, [
											"Phaser.Scale.NO_CENTER",
											"Phaser.Scale.CENTER_BOTH",
											"Phaser.Scale.CENTER_HORIZONTALLY",
											"Phaser.Scale.CENTER_VERTICALLY",
										]);
									} else if (typeof val[thisSubKey] === "object") {
										// do nothing.. it is a deep object
									} else {
										controller = folder.add(val, thisSubKey);
									}

									if (controller) {
										controller.onChange(function (newVal) {
											onChangeFn(controller, newVal, {
												subKey: thisSubKey,
											});
										});
									}
								});

								// a or b -> Select an object
							} else if (key == "a" || key == "b") {
								controller = gui.add(
									obj,
									key,
									app.game._getColliderOptions(val)
								);
								controller.onChange(function (newVal) {
									onChangeFn(controller, newVal);
								});

								// comments
							} else if (collection == "comments") {
								obj[key] = decodeURI(obj[key]);
								controller = gui.add(obj, key);
								controller.onChange(function (newVal) {
									onChangeFn(controller, newVal);
								});

								// Normal properties
							} else if (val !== null) {
								// Plain old simple value for this key
								controller = gui.add(obj, key);
								controller.onChange(function (newVal) {
									onChangeFn(controller, newVal);
								});
							}
						} catch (er) {
							console.warn("Error adding GUI", key, val, typeof val, er);
						}
					});
				} catch (er) {
					console.warn(er);
				}

				return gui;
			},

			_createVectorGui: function (gui, name, vector, min, max, step) {
				var folder = gui.addFolder(name);

				folder.add(vector, "x", min, max, step);
				folder.add(vector, "y", min, max, step);

				return folder;
			},

			_createEnd: function () {
				// called at the end of scence.create()
				// The context of `this` is the `this` from the create() function

				try {
					// Call any functions that are required during create.
					// Actions on any of these Types are treated as create functions, and used for setting up the game
					// e.g. The action for a phaser-group will be run during the create to set up the game
					// The functions should have been added by _prepareGameFuncs

					//        	app.game._funcs.groupCaller.call(this)
					//        	app.game._funcs.staticGroupCaller.call(this)
					app.game._funcs.imageCaller.call(this);
					app.game._funcs.spriteCaller.call(this);
					app.game._funcs.spriteSheetCaller.call(this);
					app.game._funcs.tileSpriteCaller.call(this);
					app.game._funcs.textCaller.call(this);

					app.game._funcs.arcCaller.call(this);
					app.game._funcs.circleCaller.call(this);
					app.game._funcs.ellipseCaller.call(this);
					app.game._funcs.lineCaller.call(this);
					app.game._funcs.multilineCaller.call(this);
					app.game._funcs.polygonCaller.call(this);
					app.game._funcs.rectangleCaller.call(this);

					// and lastly the phaser-create functions
					app.game._funcs.createCaller.call(this);
				} catch (er) {
					app.handleError(er, "_createEnd() Caller functions");
				}

				// by default follow
				try {
					if (typeof player == "object" && Object.keys(player).length) {
						this.cameras.main.startFollow(player, true, 0.1, 0.1);
					}
				} catch (er) {
					console.log("_createEnd", er);
				}

				// Add the menu
				app.game._create_addMenu.call(this);

				// Pointer Setup
				app.game._createPointers.call(this);

				// Joystick setup
				app.game._createJoysticks.call(this);

				// Keyboard event handlers

				jQuery.each(app.game.keyCode, function (key, objArr) {
					// handle isDown event

					// for each key, go through the array of code scripts
					jQuery.each(objArr, function (i, ofunc) {
						// ofunc is a descriptor {functionName, event}
						// check if this func is up/down and the script event matches
						if (["keyup", "keydown"].contains(ofunc.event)) {
							// call each function
							try {
								// the "on" method needs a description of the event,
								// eg keyup_A (as the first parameter)
								// second param is the function call
								app.game.this.input.keyboard.on(
									ofunc.event + "_" + ofunc.key,
									() => {
										app.game._funcs[ofunc.functionName].call(app.game.this);
									},
									this
								);
							} catch (er) {
								console.log(
									"keyCode error calling action",
									app.game.keyCode,
									key,
									i,
									ofunc,
									er
								);
							}
						}
					});

					// check if the key has just been released
					if (Phaser.Input.Keyboard.JustUp(key)) {
						console.warn("Key JustUp", key);
					}
				});
			},

			_createJoysticks: function () {
				// Create the joystick object with required settings

				// only set up the joystick if there are Joystick items
				if (jQuery(".phaser-joystick.item").length) {
					// default joystick settings.
					var jSettings = {
						base_color: "0x888888",
						base_alpha: 0.5,
						thumb_color: "0xcccccc",
						thumb_alpha: 0.5,
						force_min: 10,
						radius: 40,
					};

					var keys = Object.keys(app.game.joystick);

					// loop through all Joystick objects
					jQuery.each(app.game.joystick, function (key, j) {
						//  If there are multiple joystick objects, the last one will  override the settings
						//var j = app.game.joystick[keys[0]];
						if (j.base_color) {
							jSettings.base_color = j.base_color;
						}
						if (j.base_alpha) {
							jSettings.base_alpha = j.base_alpha;
						}
						if (j.thumb_color) {
							jSettings.thumb_color = j.thumb_color;
						}
						if (j.thumb_alpha) {
							jSettings.thumb_alpha = j.thumb_alpha;
						}
						if (j.force_min) {
							jSettings.force_min = j.force_min;
						}
						if (j.radius) {
							jSettings.radius = j.radius;
						}
					});

					this.joystick = this.plugins
						.get("rexvirtualjoystickplugin")
						.add(this, {
							x: 100,
							y: 300,
							radius: jSettings.radius,
							base: this.add
								.graphics()
								.fillStyle(jSettings.base_color, jSettings.base_alpha)
								.fillCircle(0, 0, jSettings.radius),
							thumb: this.add
								.graphics()
								.fillStyle(jSettings.thumb_color, jSettings.thumb_alpha)
								.fillCircle(0, 0, jSettings.radius / 2),
							dir: 3, // 'up&down'|0|'left&right'|1|'4dir'|2|'8dir'|3
							forceMin: jSettings.force_min,
							enable: true,
						})
						.on("update", app.game._onJoystickUpdate, this);

					// The "on update" function must be called on every update, and onChange, because change doesn't fire if position remains constant

					app.game.this.joystick.setVisible(false);

					this.input.on("pointerdown", app.game._onJoystickPointerdown);

					this.input.on("pointerup", app.game._onJoystickPointerUp);
				}
			},

			_createPointers: function () {
				// Create the pointer objects with required settings

				// loop through all Pointer objects
				var keys = Object.keys(app.game.pointer);
				//jQuery.each(app.game.pointer,function(key,p){
				for (var i = 0; i < keys.length; i++) {
					var p = app.game.pointer[keys[i]];

					// default applied to game
					// var target = this.input;
					var gameObject;
					var group;

					// is this applied to an object or the game as a whole
					if (p.hasOwnProperty("object_name") && p.object_name > "") {
						var oName = p.object_name;
						if (app.game.sprite.hasOwnProperty(oName)) {
							gameObject = app.game.sprite[oName];
						} else if (app.game.image.hasOwnProperty(oName)) {
							gameObject = app.game.image[oName];
						} else if (app.game.tileSprite.hasOwnProperty(oName)) {
							gameObject = app.game.tileSprite[oName];
						} else if (app.game.group.hasOwnProperty(oName)) {
							group = app.game.group[oName];
						} else if (app.game.staticGroup.hasOwnProperty(oName)) {
							group = app.game.staticGroup[oName];
						}
					}

					// now create the event handlers.
					// This action might be applied to multiple events
					var pointerEvents = [
						"pointerdown",
						"pointerdownoutside",
						"pointermove",
						"pointerout",
						"pointerover",
						"pointerup",
						"pointerupoutside",
					];

					jQuery.each(pointerEvents, function (j, val) {
						// if this option is true for this pointer object
						// e.g. pointer.on_POINTER_MOVE

						var obj = p;

						if (obj["on_" + val]) {
							var handleEvent = function (target) {
								target.on(val, function (pointer) {
									app.game._funcs["pointer" + obj.JSON.item.domId].call(
										this,
										pointer
									);
								});
							};

							// is this event on a gameObject or group or the game as a whole
							if (group) {
								// add the event to each object in the group
								jQuery.each(group.getChildren(), function (c, child) {
									child.setInteractive();
									handleEvent(child, true);
								});
							} else if (gameObject) {
								gameObject.setInteractive();
								handleEvent(gameObject, true);
							} else {
								handleEvent(app.game.this.input);
							}
						}
					});
				}
			},

			_createStart: function () {
				// called at the start of scence.create()
				// The context of `this` is the `this` from the create() function

				// initilize the graphics object
				app.game.graphics = this.add.graphics();

				var w = app.game.getConfig().width || 350;
				var h = app.game.getConfig().height || 450;
				var wBounds = w;
				var hBounds = h;
				var xBounds = 0;
				var yBounds = 0;

				var conf = app.game.getConfig();

				try {
					// if the config has data.world.bounds.width
					if (!isNaN(conf.JSON.bounds.width)) {
						wBounds = parseInt(conf.JSON.bounds.width);
					}
				} catch (er) {}

				try {
					if (!isNaN(conf.JSON.bounds.height)) {
						hBounds = parseInt(conf.JSON.bounds.height);
					}
				} catch (er) {}

				// by default make the world bounds the same as the canvas/camera
				this.physics.world.setBounds(xBounds, yBounds, wBounds, hBounds);

				// by default make the main camera the same size as bounds
				this.cameras.main.setBounds(xBounds, yBounds, wBounds, hBounds);
				// default deadzone is 20% w,h
				this.cameras.main.setDeadzone(w * 0.2, h * 0.2);
			},

			createPhaserAudios: function (that) {
				// save the image obj in a collection

				jQuery(jQuery(".phaser-audio.item").get().reverse()).each(function () {
					// Skip if there is no URL for this audio (it will also cause an error when destroy is called)
					if (!jQuery(this).data("href")) {
						return;
					}

					// try, in case errors creating one of the sprites
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var obj = app.utils.stringToObject(item.getText());

						obj.name = item.getTitle();
						obj.item = item;

						app.game.audio[obj.name] = that.sound.add(obj.name);

						app.game.audio[obj.name].JSON = obj;
						app.game.audio[obj.name].JSONString = item.getText();

						app.game.setObjectProperties(app.game.audio[obj.name], obj);

						// Change the play() method
						// handle allowSimultaneous
						app.game.audio[obj.name]._originalPlay =
							app.game.audio[obj.name].play;
						app.game.audio[obj.name].play = function (markerName, config) {
							// don't play if isPlaying
							if (
								app.game.audio[obj.name].allowSimultaneous ||
								!app.game.audio[obj.name].isPlaying
							) {
								app.game.audio[obj.name]._originalPlay.call(
									app.game.audio[obj.name],
									markerName,
									config
								);
							}
						};
					} catch (er) {
						console.log("createPhaserAudioa", er)``;
					}
				});
			},

			createPhaserConfigs: function (that) {
				// save the image obj in a collection

				jQuery(".phaser-config.item").each(function () {
					// try, in case errors creating one of the sprites
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var obj = app.utils.stringToObject(item.getText());
						var name = item.getTitle();

						obj.name = name;
						obj.item = item;

						var thisObject = {};
						thisObject.JSON = obj;
						thisObject.JSONString = item.getText();

						app.game.config[name] = thisObject;
						app.game.setObjectProperties(app.game.config[name], obj);

						// Initiliase the item in the list to display as required
						app.game._initializeListItem(thisObject);
					} catch (er) {
						console.log(er);
					}
				});
			},

			createPhaserPreload: function (that) {
				// save the obj in a collection

				jQuery(".phaser-preload.item").each(function () {
					// try, in case errors creating one of the sprites
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var name = item.getTitle();
						var data = app.utils.stringToObject(item.getText());

						var obj = {};
						obj.data = data;
						obj.objectType = "preload";
						obj.item = item;

						app.game.preload[name] = obj;
						app.game.setObjectData(app.game.preload[name], data);
					} catch (er) {
						console.log(er);
					}
				});
			},

			createPhaserCreate: function (that) {
				// save the obj in a collection

				jQuery(".phaser-create.item").each(function () {
					// try, in case errors creating one of the sprites
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var name = item.getTitle();
						var data = app.utils.stringToObject(item.getText());

						var obj = {};
						obj.data = data;
						obj.objectType = "create";
						obj.item = item;

						app.game.create[name] = obj;
						app.game.setObjectData(app.game.create[name], data);
					} catch (er) {
						console.log(er);
					}
				});
			},

			createPhaserUpdate: function (that) {
				// save the obj in a collection

				jQuery(".phaser-update.item").each(function () {
					// try, in case errors creating one of the sprites
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var name = item.getTitle();
						var data = app.utils.stringToObject(item.getText());

						var obj = {};
						obj.data = data;
						obj.objectType = "update";
						obj.item = item;

						app.game.update[name] = obj;
						app.game.setObjectData(app.game.update[name], data);
					} catch (er) {
						console.log(er);
					}
				});
			},

			createPhaserRender: function (that) {
				// save the obj in a collection

				jQuery(".phaser-render.item").each(function () {
					// try, in case errors creating one of the sprites
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var name = item.getTitle();
						var data = app.utils.stringToObject(item.getText());

						var obj = {};
						obj.data = data;
						obj.objectType = "render";
						obj.item = item;

						app.game.render[name] = obj;
						app.game.setObjectData(app.game.render[name], data);
					} catch (er) {
						console.log(er);
					}
				});
			},

			createPhaserColliders: function (that, methodType) {
				// Create the colliders
				// The Collider Items will have these properties:
				// a: the name of one Game Object (or array of names)
				// b: same
				// The Action of the Item is the callback

				var methodType = methodType || "collider";

				jQuery(
					jQuery(".phaser-" + methodType + ".item")
						.get()
						.reverse()
				).each(function () {
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var obj = app.utils.stringToObject(item.getText());

						obj.name = item.getTitle();
						obj.item = item;

						var gameObjects = {
							a: [],
							b: [],
						}; // we will put all the game objects here

						jQuery.each(["a", "b"], function (i, aorb) {
							// a&b can be either single objects or an array of objects of differing types

							// The Item Text field (JSON) must have properties/keys "a" and "b" that specify the collision objects/arrays
							var names = obj[aorb];

							if (Array.isArray(names)) {
								// It's an array of objects, so loop through
								jQuery.each(names, function (j, thisName) {
									// we need to know the Type so we can get the object
									var type = app.game.getType(thisName);
									// add this Game Object to the array
									if (type) {
										gameObjects[aorb].push(app.game[type][thisName]);
									}
								});
							} else {
								// its a single object
								var type = app.game.getType(names);
								if (type) {
									gameObjects[aorb] = app.game[type][names];
								}
							}
						});

						var thisObject;

						// now call the Phaser methods to add the Collider or Overlap
						if (methodType == "collider") {
							thisObject = that.physics.add.collider(
								gameObjects.a,
								gameObjects.b,
								function (object1, object2) {
									try {
										if (app.game._funcs["collider" + item.element.id]) {
											app.game._funcs["collider" + item.element.id].call(
												app.game.this,
												object1,
												object2
											);
										}
									} catch (er) {
										console.warn(
											"Collider callback error",
											object1,
											object2,
											er
										);
									}
								},
								null,
								that
							);
						} else if (methodType == "overlap") {
							thisObject = that.physics.add.overlap(
								gameObjects.a,
								gameObjects.b,
								function (object1, object2) {
									try {
										if (app.game._funcs["overlap" + item.element.id]) {
											app.game._funcs["overlap" + item.element.id].call(
												app.game.this,
												object1,
												object2
											);
										}
									} catch (er) {
										console.warn(
											"Overlap callback error",
											object1,
											object2,
											er
										);
									}
								},
								null,
								that
							);
						}

						thisObject.JSON = obj;
						thisObject.JSONString = item.getText();

						app.game[methodType][obj.name] = thisObject;
						app.game.setObjectProperties(app.game[methodType][obj.name], obj);
					} catch (er) {
						console.log("createPhaserCollider er", methodType, item, obj, er);
					}
				});
			},

			createPhaserGameObjects: function (that) {
				// create Game Objects
				// This includes Image, Sprite, Spritesheet, TileSprite, Group, StaticGroup

				// by using the order of the items in the screen, we create the phaser objects in the correct layers on top of each other
				// Need a nested jQuery to reverse the list  https://www.sitepoint.com/jquery-each-reverse-it/
				jQuery(
					jQuery(
						".items-inner>.phaser-text.item, .items-inner>.phaser-tileSprite.item, .items-inner>.phaser-group.item, .items-inner>.phaser-staticGroup.item, .items-inner>.phaser-arc.item, .items-inner>.phaser-circle.item, .items-inner>.phaser-ellipse.item, .items-inner>.phaser-image.item, .items-inner>.phaser-line.item, .items-inner>.phaser-multiline.item, .items-inner>.phaser-polygon.item, .items-inner>.phaser-rectangle.item, .items-inner>.phaser-sprite.item, .items-inner>.phaser-spriteSheet.item"
					)
						.get()
						.reverse()
				).each(function () {
					// handle different objects separately
					if (jQuery(this).hasClass("phaser-tileSprite")) {
						return app.game.createPhaserTileSprite(that, this);
					} else if (
						jQuery(this).hasClass("phaser-group") ||
						jQuery(this).hasClass("phaser-staticGroup")
					) {
						return app.game.createPhaserGroup(that, this);
					} else if (jQuery(this).hasClass("phaser-text")) {
						return app.game.createPhaserText(that, this);
					} else {
						return app.game.createPhaserSprite(that, this);
					}
				});
			},

			createPhaserJoysticks: function (that) {
				// Create the joysticks
				// The actions are called based on movement conditions being met (e.g. up_left)

				jQuery(jQuery(".phaser-joystick.item").get().reverse()).each(
					function () {
						// try, in case errors creating one of the sprites
						try {
							// no Phaser object for this, so we create one
							var thisObject = {};

							var item = app.getItem(app.getIdFromDOMId(this.id));
							var obj = app.utils.stringToObject(item.getText());

							obj.name = item.getTitle();
							obj.item = item;

							thisObject.JSON = obj;
							thisObject.JSONString = item.getText();

							app.game.joystick[obj.name] = thisObject;
							app.game.setObjectProperties(app.game.joystick[obj.name], obj);
						} catch (er) {
							console.log(er);
						}
					}
				);
			},

			createPhaserKeys: function (that) {
				//
				jQuery(jQuery(".phaser-keyboard.item").get().reverse()).each(
					function () {
						// try, in case errors creating one of the sprites
						try {
							var item = app.getItem(app.getIdFromDOMId(this.id));
							var obj = app.utils.stringToObject(item.getText());
							var name = item.getTitle();

							var upperKey = String(obj.key).toUpperCase();

							// In this case the name is generated as:
							//   key_event
							//   e.g. A_isDown
							/*
						var name = upperKey;
						if(obj.hasOwnProperty("event")){
							name += "_"+obj.event;
						}else{
							// default event for Keyboard 
							obj.event = "isDown";
						}
						*/

							// Keyboard objects must have a "key" property

							//obj.objectType = "key";
							obj.item = item;

							app.game.keyboard[name] = {};
							app.game.keyboard[name].JSON = obj;
							app.game.setObjectProperties(app.game.keyboard[name], obj);

							if (Phaser.Input.Keyboard.KeyCodes.hasOwnProperty(upperKey)) {
								app.game.keys[obj.key] = that.input.keyboard.addKey(
									Phaser.Input.Keyboard.KeyCodes[upperKey]
								);

								// if the keyCode array has not been created, do that first
								if (!app.game.keyCode[obj.key]) {
									app.game.keyCode[obj.key] = [];
								}
								// Add this obj to the keyCode for the key
								// default event set to isDown
								var eventName = obj.event || "isDown";

								// Add a description of the function to the array
								// including  name and event
								app.game.keyCode[obj.key].push({
									functionName: "keyboard" + this.id,
									event: eventName,
									key: upperKey,
								});
							} else {
								app.warn(4, "Invalid key: " + obj.key);
							}
						} catch (er) {
							console.log("createPhaserKeys error", this, er);
						}
					}
				);
			},

			createPhaserPointers: function (that) {
				// Create the pointers
				// The actions are called based on events (e.g. on_POINTER_MOVE)

				jQuery(jQuery(".phaser-pointer.item").get().reverse()).each(
					function () {
						// try, in case errors creating one of the sprites
						try {
							// no Phaser object for this, so we create one
							var thisObject = {};

							var item = app.getItem(app.getIdFromDOMId(this.id));
							var obj = app.utils.stringToObject(item.getText());

							obj.name = item.getTitle();
							obj.item = item;

							thisObject.JSON = obj;
							thisObject.JSONString = item.getText();

							app.game.pointer[obj.name] = thisObject;
							app.game.setObjectProperties(app.game.pointer[obj.name], obj);
						} catch (er) {
							console.log(er);
						}
					}
				);
			},

			createPhaserSprite: function (that, el) {
				// create a Game Object
				// This includes Image, Sprite, Spritesheet, Graphics (square, circle...)

				try {
					var item = app.getItem(app.getIdFromDOMId(el.id));
					var obj = app.utils.stringToObject(item.getText());
					var jThis = jQuery(el);

					var objectType = "";
					obj.name = item.getTitle();
					obj.item = item;

					/*
					if (jThis.hasClass("phaser-sprite")) {
						objectType = "sprite";
					} else if (jThis.hasClass("phaser-spriteSheet")) {
						objectType = "spriteSheet";
					}
					*/

					jQuery.each(this._visibleTypes, function (i, val) {
						if (jThis.hasClass("phaser-" + val)) {
							objectType = val;
						}
					});

					// fill, stroke colors, width etc with defaults
					var fill_color =
						obj.hasOwnProperty("fill_color") && obj.fill_color > ""
							? obj.fill_color
							: 0x000000;
					var stroke_color =
						obj.hasOwnProperty("stroke_color") && obj.stroke_color > ""
							? obj.stroke_color
							: 0x7a7a7a;
					var stroke_width =
						obj.hasOwnProperty("stroke_width") && obj.stroke_width > ""
							? obj.stroke_width
							: 1;

					var sprite;

					// add to the generic group
					if (objectType == "arc") {
						sprite = that.add
							.arc(
								obj.x,
								obj.y,
								obj.radius,
								obj.startAngle,
								obj.endAngle,
								obj.anticlockwise,
								fill_color
							)
							.setStrokeStyle(stroke_width, stroke_color);
						that.physics.add.existing(sprite);
					} else if (objectType == "circle") {
						sprite = that.add
							.circle(obj.x, obj.y, obj.radius, fill_color)
							.setStrokeStyle(stroke_width, stroke_color);
						that.physics.add.existing(sprite);
					} else if (objectType == "ellipse") {
						sprite = that.add
							.ellipse(obj.x, obj.y, obj.width, obj.height, fill_color)
							.setStrokeStyle(stroke_width, stroke_color);
						that.physics.add.existing(sprite);
					} else if (objectType == "image") {
						sprite = that.physics.add.staticImage(obj.x, obj.y, obj.name);
					} else if (objectType == "line") {
						sprite = that.add
							.line(0, 0, obj.x1, obj.y1, obj.x2, obj.y2)
							.setStrokeStyle(stroke_width, stroke_color);
						that.physics.add.existing(sprite);
					} else if (objectType == "multiline") {
						var points = [];

						points = String(obj.points).split(",");
						for (var p = 0; p < points.length; p++) {
							points[p] = parseInt(points[p]);
						}
						if (points && points.length) {
							sprite = that.add.group({
								key: obj.name,
							});
							this.drawOutline(that, points, sprite, {
								fill_color: fill_color,
								stroke_width: stroke_width,
								stroke_color: stroke_color,
							});
						}
					} else if (objectType == "polygon") {
						//sprite = that.physics.add.polygon(null,null,obj.points, fill_color).setStrokeStyle(stroke_width, stroke_color);

						var points = [];
						try {
							points = String(obj.points).split(",");
							for (var p = 0; p < points.length; p++) {
								points[p] = parseInt(points[p]);
							}
							if (points && points.length) {
								var polygon = new Phaser.Geom.Polygon(points);
								var graphics = app.game.graphics;
								graphics.lineStyle(stroke_width, stroke_color);
								graphics.fillStyle(fill_color);
								sprite = graphics.fillPoints(polygon.points, true);
								graphics.strokePoints(polygon.points, true);
								that.physics.add.existing(sprite);
							}
						} catch (er) {
							console.error(
								"createPhaserSprite Cannot parse polygon points",
								er
							);
						}
					} else if (objectType == "rectangle") {
						sprite = that.add
							.rectangle(obj.x, obj.y, obj.width, obj.height, fill_color)
							.setStrokeStyle(stroke_width, stroke_color);
						var isStatic = obj.hasOwnProperty("static") && obj.static === true;
						that.physics.add.existing(sprite, isStatic);
					} else if (objectType == "sprite" || objectType == "spriteSheet") {
						sprite = that.physics.add.sprite(obj.x, obj.y, obj.name);
					}

					// Special Case: config.data.origin: 0 || {0,0} - Sets the origin on all Game Objects
					try {
						// new origin is on the gameConfig Main props
						if (
							app.game.getConfig().JSON.hasOwnProperty("origin") &&
							!isNaN(app.game.getConfig().JSON.origin)
						) {
							if (sprite.hasOwnProperty("setOrigin")) {
								sprite.setOrigin(app.game.getConfig().JSON.origin);
							}
						}
					} catch (er) {
						console.warn("ERROR origin createPhaserSprite ", er, sprite);
					}

					var w = sprite.width;
					var h = sprite.height;
					if (obj.hasOwnProperty("width") && !isNaN(obj.width)) {
						//sprite.displayWidth = obj.width;
						w = obj.width;
					}
					if (obj.hasOwnProperty("height") && !isNaN(obj.height)) {
						//sprite.displayHeight = obj.height;
						h = obj.height;
					}

					if (typeof sprite.setSize == "function") {
						sprite.setSize(w, h);
					}

					if (typeof sprite.setDisplaySize == "function") {
						sprite.setDisplaySize(w, h);
					}

					// this will fail for objects with no body, ho hum
					if (sprite.hasOwnProperty("refreshBody")) {
						sprite.refreshBody();
					}

					sprite.JSON = obj;
					sprite.JSONString = item.getText();

					app.game.setObjectProperties(sprite, obj);

					var collection = objectType;
					if (objectType == "spriteSheet") {
						collection = "sprite";
					}
					app.game[collection][obj.name] = sprite;

					// special case... add the player as a global variable
					if (obj.name == "player") {
						player = sprite;
					}

					app.game._addEditHandler(sprite, item);

					// Initiliase the item in the list to display as required
					app.game._initializeListItem(sprite);
				} catch (er) {
					console.log("createPhaserSprite", er);
				}
			},

			createPhaserSprites: function (that) {
				// create Game Objects
				// This includes Image, Sprite, Spritesheet

				// Need a nested jQuery to reverse the list  https://www.sitepoint.com/jquery-each-reverse-it/
				jQuery(
					jQuery(
						".items-inner>.phaser-image.item, .items-inner>.phaser-sprite.item, .items-inner>.phaser-tileSprite.item, .items-inner>.phaser-spriteSheet.item"
					)
						.get()
						.reverse()
				).each(function () {
					// tileSprites handled separtely
					// pass `this` as the element
					if (jQuery(this).hasClass("phaser-tileSprite")) {
						return app.game.createPhaserTileSprite(that, this);
					}

					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var obj = app.utils.stringToObject(item.getText());
						var jThis = jQuery(this);

						var objectType = "image";
						obj.name = item.getTitle();
						obj.item = item;

						if (jThis.hasClass("phaser-sprite")) {
							objectType = "sprite";
						} else if (jThis.hasClass("phaser-spriteSheet")) {
							objectType = "spriteSheet";
						}

						var sprite;

						// If it is assigned a group, and the group exists, add it to to the group
						if (
							obj.hasOwnProperty("group") &&
							obj.group > "" &&
							(app.game.group.hasOwnProperty(obj.group) ||
								app.game.staticGroup.hasOwnProperty(obj.group))
						) {
							// check if it's a static group or normal group
							if (app.game.group.hasOwnProperty(obj.group)) {
								sprite = app.game.group[obj.group].create(
									obj.x,
									obj.y,
									obj.name
								);
							} else if (app.game.staticGroup.hasOwnProperty(obj.group)) {
								sprite = app.game.staticGroup[obj.group].create(
									obj.x,
									obj.y,
									obj.name
								);
							}
						} else {
							// if no group specified, add to the generic group
							if (objectType == "image") {
								sprite = app.game.staticGroup["_images"].create(
									obj.x,
									obj.y,
									obj.name
								);
							} else {
								sprite = app.game.group["_sprites"].create(
									obj.x,
									obj.y,
									obj.name
								);
							}
						}

						// Special Case: config.data.origin: 0 || {0,0} - Sets the origin on all Game Objects
						try {
							// new origin is on the gameConfig Main props
							if (
								app.game.getConfig().JSON.hasOwnProperty("origin") &&
								!isNaN(app.game.getConfig().JSON.origin)
							) {
								sprite.setOrigin(app.game.getConfig().JSON.origin);
							}
						} catch (er) {
							console.warn("ERROR origin createPhaserSprites ", er, sprite);
						}

						var w = sprite.width;
						var h = sprite.height;
						if (obj.hasOwnProperty("width") && !isNaN(obj.width)) {
							//sprite.displayWidth = obj.width;
							w = obj.width;
						}
						if (obj.hasOwnProperty("height") && !isNaN(obj.height)) {
							//sprite.displayHeight = obj.height;
							h = obj.height;
						}
						sprite.setSize(w, h);
						sprite.setDisplaySize(w, h);

						try {
							// this will fail for objects with no body, ho hum
							sprite.refreshBody();
						} catch (er) {}

						sprite.JSON = obj;
						sprite.JSONString = item.getText();

						app.game.setObjectProperties(sprite, obj);

						//		                                sprite.name = obj.name

						if (objectType == "image") {
							app.game.image[obj.name] = sprite;
						} else {
							app.game.sprite[obj.name] = sprite;
						}

						// special case... add the player as a global variable
						if (obj.name == "player") {
							player = sprite;
						}

						app.game._addEditHandler(sprite, item);

						// Initiliase the item in the list to display as required
						app.game._initializeListItem(sprite);
					} catch (er) {
						console.log("createPhaserSprites", er);
					}
				});
			},

			createPhaserOtherFunctions: function (that) {
				// Create the otherFunctions
				// these can be called from anywhere in the game using this format:
				//    app.game.functions['function1'](params)
				// passing one parameter (can be an object or anything else)
				// From inside the Javacript Action, the params can be retrieved using:
				//    app.getItem().actionParams

				jQuery(jQuery(".phaser-otherFunction.item").get().reverse()).each(
					function () {
						// try, in case errors creating one of the sprites
						try {
							// no Phaser object for this, so we create one
							var thisObject = {};

							var item = app.getItem(app.getIdFromDOMId(this.id));
							var obj = app.utils.stringToObject(item.getText());

							obj.name = item.getTitle();
							obj.item = item;

							// DEPRECATED: now the function and the object are inserted into the <script> tags, call() not used
							// special requirement... to be able to call this function
							// call the function created in a script
							//obj.call = function(param1,param2,param3,param4,param5,param6,param7,param8,param9,param10){
							//	app.game._funcs['otherFunctionitem'+item.id].apply(app.game.this,arguments)
							//}

							thisObject.JSON = obj;
							thisObject.JSONString = item.getText();

							app.game.otherFunction[obj.name] = thisObject;
							app.game.setObjectProperties(
								app.game.otherFunction[obj.name],
								obj
							);

							//		                                app.game.otherFunction[item.getTitle()] = function(params){
							//											app.game._funcs['otherFunction'+item.element.id].call(that,params);
							//		                                };
						} catch (er) {
							console.log(er);
						}
					}
				);
			},

			createPhaserOverlaps: function (that) {
				// Create an overlap object.
				// This shares the method with collider, as they work the same way
				return app.game.createPhaserColliders(that, "overlap");
			},

			createPhaserText: function (that, el) {
				// The style for the text can be set using the AppShed Style tab
				// and/or added to the obj.Text in the format:
				// style: {
				//   color: "00ff00"
				// }

				try {
					var item = app.getItem(app.getIdFromDOMId(el.id));
					var obj = app.utils.stringToObject(item.getText());
					var jThis = jQuery(el);

					obj.objectType = "text";
					obj.item = item;

					var style = {};

					// Check for styles in the JSON
					if (obj.hasOwnProperty("style") && typeof obj.style === "object") {
						try {
							var keys = Object.keys(obj.style);
							for (var i = 0; i < keys.length; i++) {
								style[keys[i]] = obj.style[keys[i]];
							}
						} catch (er) {
							app.warn(3, item.getTitle() + " (Phaser Text) has errors " + er);
							console.log("createPhaserText", er);
						}
					}

					// get the styles set on Styles tab
					try {
						// <script> tags for styles often combine multiple items together e.g.
						/*
						<style scoped="">#item27905197 {
							font-size: 48px;
						}
						#item27905204 {
							font-family: 'Arial';
							font-size: 48px;
						}
						</style>
						*/

						if (jQuery('style:contains("item' + item.id + '")').length) {
							var re = new RegExp("item" + item.id + " {.*?}", "sm");
							var tag = jQuery('style:contains("item' + item.id + '")')[0]
								.innerText;
							var myStyles = tag.match(re)[0];
							// replace css names with JavaScript names
							myStyles = myStyles
								.replace(/item\d+ /, "")
								.replace(/'/g, "")
								.replace(/font-size/g, "fontSize")
								.replace(/font-family/g, "fontFamily")
								.replace(/font-weight/g, "fontWeight")
								.replace(/font-style/g, "fontStyle")
								.replace(/\n\s*(\w)/g, ' "$1')
								.replace(/(\w)\s*:\s*/g, '$1": "')
								.replace(/;/g, '",')
								.replace(/\n/g, "")
								.replace(/,\s*}/, "}");

							// convert to an object for Phaser
							var css = JSON.parse(myStyles);
							var keys = Object.keys(css);
							for (var i = 0; i < keys.length; i++) {
								style[keys[i]] = css[keys[i]];
							}
						}
					} catch (er) {
						app.warn(
							3,
							item.getTitle() +
								" (Phaser Text) 'Styles' has errors " +
								'style:contains("item' +
								item.id +
								'")',
							er
						);
					}

					app.game.text[item.getTitle()] = that.add.text(
						obj.x,
						obj.y,
						obj.text,
						style
					);

					app.game._addEditHandler(app.game.text[item.getTitle()], item);
				} catch (er) {
					console.log("create text", er);
				}
			},

			//	                    createPhaserTileSprites: function(that,el){
			createPhaserTileSprite: function (that, el) {
				// create a single tileSprite for `el`
				//

				//jQuery( jQuery('.phaser-tileSprite.item').get().reverse()).each(function(){

				try {
					var item = app.getItem(app.getIdFromDOMId(el.id));
					var obj = app.utils.stringToObject(item.getText());

					var objectType = "tileSprite";
					obj.item = item;
					obj.name = item.getTitle();

					// default to tile the world
					var w = game.config.width;
					var h = game.config.height;

					if (obj.hasOwnProperty("cols") && !isNaN(obj.cols) && obj.cols > 0) {
						w = that.textures.get(obj.name).frames.__BASE.width * obj.cols;
					}
					if (obj.hasOwnProperty("rows") && !isNaN(obj.rows) && obj.rows > 0) {
						h = that.textures.get(obj.name).frames.__BASE.height * obj.rows;
					}

					if (obj.hasOwnProperty("width")) {
						w = obj.width;
					}
					if (obj.hasOwnProperty("height")) {
						h = obj.height;
					}

					app.game.tileSprite[obj.name] = that.add.tileSprite(
						obj.x,
						obj.y,
						w,
						h,
						obj.name
					);

					// by default give the tileSprite a body
					that.physics.add.existing(app.game.tileSprite[obj.name], false);

					// do we need to scale the tile/image
					var scaleX = 1;
					if (obj.hasOwnProperty("tileWidth")) {
						// get the actual image width
						var scale =
							obj.tileWidth /
							app.game.this.textures.get(obj.name).frames.__BASE.width;
						if (!isNaN(scale)) {
							scaleX = scale;
						}
					}
					app.game.tileSprite[obj.name].tileScaleX = scaleX;

					var scaleY = 1;
					if (obj.hasOwnProperty("tileHeight")) {
						// get the actual image width
						var scale =
							obj.tileHeight /
							app.game.this.textures.get(obj.name).frames.__BASE.height;
						if (!isNaN(scale)) {
							scaleY = scale;
						}
					}
					app.game.tileSprite[obj.name].tileScaleY = scaleY;

					if (
						obj.hasOwnProperty("cameraAdjustX") ||
						obj.hasOwnProperty("cameraAdjustY")
					) {
						// save this to be adjusted in update()
						app.game.cameraAdjust.tileSprite[obj.name] = {
							x: obj.cameraAdjustX,
							y: obj.cameraAdjustY,
						};
					}

					app.game.setObjectProperties(app.game.tileSprite[obj.name], obj);

					app.game._addEditHandler(app.game.tileSprite[obj.name], item);
				} catch (er) {
					console.log("create tilesSprite", er);
				}

				//});
			},

			createPhaserObjects: function (that) {
				// Creates sprites for each Item matching a `phaser className`

				// create the objects in the right order

				// These probably don't have dependencies and might be referenced in creaet functions
				app.game.createPhaserOtherFunctions(that);
				app.game.createPhaserAudios(that);

				// These have create functions that get called as they are created (TODO)
				app.game.createPhaserGameObjects(that);
				app.game.movePhaserObjectsToGroups(that);

				// These need to be created once the game objects exist
				app.game.createPhaserColliders(that);
				app.game.createPhaserOverlaps(that);
				app.game.createPhaserPointers(that);
				app.game.createPhaserJoysticks(that);
				app.game.createPhaserKeys(that);

				// do setAll for setting group properties and data
				app.game.setAllObjectProperties(that);
			},

			createPhaserGroup: function (that, el) {
				// Create group from a document element
				// Return the group

				// try, in case errors creating one of the sprites
				try {
					var item = app.getItem(app.getIdFromDOMId(el.id));
					var obj = app.utils.stringToObject(item.getText());

					obj.name = item.getTitle();
					obj.item = item;

					app.game.checkValidJSON(obj, item);

					if (jQuery(el).hasClass("phaser-staticGroup")) {
						app.game.staticGroup[obj.name] = that.physics.add.staticGroup({
							key: obj.name,
						});

						// save the JSON obj for later use
						app.game.staticGroup[obj.name].JSON = obj;
						app.game.staticGroup[obj.name].JSONString = item.getText();

						app.game.setObjectProperties(app.game.staticGroup[obj.name], obj);
						app.game.setObjectData(app.game.staticGroup[obj.name], obj);
						// there is a child in the group by default, remove it
						try {
							app.game.staticGroup[obj.name].remove(
								app.game.staticGroup[obj.name].getChildren()[0],
								true,
								true
							);
						} catch (er) {}

						// call the default create function for this object
						try {
							app.game._funcs["staticGroup" + el.id].call(that);
						} catch (er) {}

						return app.game.staticGroup[obj.name];
					} else {
						app.game.group[obj.name] = that.physics.add.group({
							key: obj.name,
						});
						// save the JSON obj for later use
						app.game.group[obj.name].JSON = obj;
						app.game.group[obj.name].JSONString = item.getText();

						app.game.setObjectProperties(app.game.group[obj.name], obj);
						//app.game.setObjectData(app.game.group[obj.name],obj)

						// call the default create function for this object
						try {
							app.game._funcs["group" + el.id].call(that);
						} catch (er) {}

						return app.game.group[obj.name];
					}
				} catch (er) {
					console.warn(er);
				}
			},

			createPhaserGroups: function (that) {
				// Creates groups for each Item matching a `phaser-group`  className

				jQuery(
					jQuery(".phaser-group.item, .phaser-staticGroup.item").get().reverse()
				).each(function () {
					// try, in case errors creating one of the sprites
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						var obj = app.utils.stringToObject(item.getText());

						obj.name = item.getTitle();
						obj.item = item;

						app.game.checkValidJSON(obj, item);

						if (jQuery(this).hasClass("phaser-staticGroup")) {
							app.game.staticGroup[obj.name] = that.physics.add.staticGroup({
								key: obj.name,
							});

							// save the JSON obj for later use
							app.game.staticGroup[obj.name].JSON = obj;
							app.game.staticGroup[obj.name].JSONString = item.getText();

							app.game.setObjectProperties(app.game.staticGroup[obj.name], obj);
							app.game.setObjectData(app.game.staticGroup[obj.name], obj);
							// there is a child in the group by default, remove it
							try {
								app.game.staticGroup[obj.name].remove(
									app.game.staticGroup[obj.name].getChildren()[0],
									true,
									true
								);
							} catch (er) {}
						} else {
							app.game.group[obj.name] = that.physics.add.group({
								key: obj.name,
							});
							// save the JSON obj for later use
							app.game.group[obj.name].JSON = obj;
							app.game.group[obj.name].JSONString = item.getText();

							app.game.setObjectProperties(app.game.group[obj.name], obj);
							//app.game.setObjectData(app.game.group[obj.name],obj)
						}
					} catch (er) {
						console.warn(er);
					}
				});

				// create a general group for sprites that don't specify a group
				app.game.group["_sprites"] = that.physics.add.group();
				//app.game.group['_sprites'].classType = Phaser.Physics.Arcade.Sprite; // default Object type is Arcade Sprite

				app.game.group["_sprites"].JSONString = "";
				app.game.group["_sprites"].JSON = app.utils.stringToObject(
					app.game.group["_sprites"].JSONString
				);

				// create a general staticGroup for images that don't specify a group
				app.game.staticGroup["_images"] = that.physics.add.staticGroup();
				//app.game.staticGroup['_images'].classType = Phaser.Physics.Arcade.Sprite;
				app.game.staticGroup["_images"].JSONString = "";
				app.game.staticGroup["_images"].JSON = app.utils.stringToObject(
					app.game.staticGroup["_images"].JSONString
				);
			},

			currentObject: function () {
				// Returns the Phaser Game object related to the current Item
				// The object will be one of app.game.group/sprite/image etc.
				// Used within Item Action JavaScript
				// If no Game object can be found, it returns an empty object.

				// Go through all the object tyeps and see if an object matching this Item exists
				var rVal;

				jQuery.each(app.game.objectTypes, function (i, val) {
					try {
						// for spriteSheets, look for a sprite
						if (val == "spriteSheet") {
							val = "sprite";
						}
						var obj = app.game[val][app.getItem().getTitle()];
						if (typeof obj === "object" && Object.keys(obj).length > 0) {
							rVal = obj;
							return false;
						}
					} catch (er) {
						console.log("currentObject ERROR", val, app.getItem(), er);
					}
				});

				return rVal;
			},

			_dataClass: function () {
				// Class definition for Data object that is added to some game objects
				// This replicates Phaser 3 object.data, which is created using setDataEnabled()
				// In AppShed we want to support data on all Types

				var d = {
					initialize: function (t, e) {
						(this.parent = t),
							(this.events = e),
							e || (this.events = t.events ? t.events : t),
							(this.list = {}),
							(this.values = {}),
							(this._frozen = !1),
							!t.hasOwnProperty("sys") &&
								this.events &&
								this.events.once("destroy", this.destroy, this);
					},
					get: function (t) {
						var e = this.list;
						if (Array.isArray(t)) {
							for (var i = [], n = 0; n < t.length; n++) i.push(e[t[n]]);
							return i;
						}
						return e[t];
					},
					getAll: function () {
						var t = {};
						for (var e in this.list)
							this.list.hasOwnProperty(e) && (t[e] = this.list[e]);
						return t;
					},
					query: function (t) {
						var e = {};
						for (var i in this.list)
							this.list.hasOwnProperty(i) &&
								i.match(t) &&
								(e[i] = this.list[i]);
						return e;
					},
					set: function (t, e) {
						if (this._frozen) return this;
						if ("string" == typeof t) return this.setValue(t, e);
						for (var i in t) this.setValue(i, t[i]);
						return this;
					},
					setValue: function (t, e) {
						if (this._frozen) return this;
						if (this.has(t)) this.values[t] = e;
						else {
							var i = this,
								n = this.list,
								s = this.events,
								r = this.parent;
							Object.defineProperty(this.values, t, {
								enumerable: !0,
								configurable: !0,
								get: function () {
									return n[t];
								},
								set: function (e) {
									if (!i._frozen) {
										var o = n[t];
										(n[t] = e),
											s.emit("changedata", r, t, e, o),
											s.emit("changedata_" + t, r, e, o);
									}
								},
							}),
								(n[t] = e),
								s.emit("setdata", r, t, e);
						}
						return this;
					},
					each: function (t, e) {
						for (
							var i = [this.parent, null, void 0], n = 1;
							n < arguments.length;
							n++
						)
							i.push(arguments[n]);
						for (var s in this.list)
							(i[1] = s), (i[2] = this.list[s]), t.apply(e, i);
						return this;
					},
					merge: function (t, e) {
						for (var i in (void 0 === e && (e = !0), t))
							t.hasOwnProperty(i) &&
								(e || (!e && !this.has(i))) &&
								this.setValue(i, t[i]);
						return this;
					},
					remove: function (t) {
						if (this._frozen) return this;
						if (!Array.isArray(t)) return this.removeValue(t);
						for (var e = 0; e < t.length; e++) this.removeValue(t[e]);
						return this;
					},
					removeValue: function (t) {
						if (this.has(t)) {
							var e = this.list[t];
							delete this.list[t],
								delete this.values[t],
								this.events.emit("removedata", this.parent, t, e);
						}
						return this;
					},
					pop: function (t) {
						var e = void 0;
						return (
							!this._frozen &&
								this.has(t) &&
								((e = this.list[t]),
								delete this.list[t],
								delete this.values[t],
								this.events.emit("removedata", this, t, e)),
							e
						);
					},
					has: function (t) {
						return this.list.hasOwnProperty(t);
					},
					setFreeze: function (t) {
						return (this._frozen = t), this;
					},
					reset: function () {
						for (var t in this.list) delete this.list[t], delete this.values[t];
						return (this._frozen = !1), this;
					},
					destroy: function () {
						this.reset(),
							this.events.off("changedata"),
							this.events.off("setdata"),
							this.events.off("removedata"),
							(this.parent = null);
					},
					freeze: {
						get: function () {
							return this._frozen;
						},
						set: function (t) {
							this._frozen = !!t;
						},
					},
					count: {
						get: function () {
							var t = 0;
							for (var e in this.list) void 0 !== this.list[e] && t++;
							return t;
						},
					},
				};
				d.initialize({
					once: function () {},
					emit: function () {},
					off: function () {},
				});
				return d;
			},

			drawOutline: function (that, points, group, options) {
				// draws an outline joining all the points
				// points: an array [x1,y1,x1,y2,x3,y3....]
				// optional `group` if all lines must be added to the group

				var t = 0;
				var optionsP = options || {};
				// merge the default options
				var options = app.utils.merge(optionsP, {
					fill_color: 0x000000,
					stroke_width: 1,
					stroke_color: 0x7a7a7a,
				});

				for (var i = 0; i < points.length - 3; i += 2) {
					var x1 = points[i];
					var y1 = points[i + 1];
					var x2 = points[i + 2] + t;
					var y2 = points[i + 3] + t;

					var w = x2 - x1;
					var h = y2 - y1;

					var x = x1 + 0.5 * w;
					var y = y1 + 0.5 * h;

					w = Math.abs(w);
					h = Math.abs(h);

					if (x1 == x2 || y1 == y2) {
						this.graphics.fillStyle(options.fill_color);

						var rect = app.game.this.add
							.rectangle(x, y, w, h, options.fill_color)
							.setStrokeStyle(options.stroke_width, options.stroke_color);

						that.physics.add.existing(rect, true);
						group.add(rect);
					} else {
						this.drawDiagonal(that, x1, y1, x2, y2, group, options);
					}
				}
			},

			drawDiagonal: function (that, x1, y1, x2, y2, group, options) {
				// draws an outline joining all the points
				// points: an array [x1,y1,x1,y2,x3,y3....]

				var steps = 2; // minimum number of steps
				var dLimit = 5;
				var maxSteps = 50;
				var xd = (x2 - x1) / steps;
				var yd = (y2 - y1) / steps;
				var xdabs = Math.abs(xd);
				var ydabs = Math.abs(yd);

				// if delta greater than limit,
				if (xdabs > dLimit && xdabs > ydabs) {
					steps = Math.abs(parseInt((x2 - x1) / dLimit));
				}
				if (ydabs > dLimit && ydabs > xdabs) {
					steps = Math.abs(parseInt((y2 - y1) / dLimit));
				}
				steps = steps > maxSteps ? maxSteps : steps;

				xd = (x2 - x1) / steps;
				yd = (y2 - y1) / steps;

				for (var i = 0; i <= steps; i++) {
					var xa = x1 + i * xd;
					var ya = y1 + i * yd;
					var xb = x1 + (i + 1) * xd;
					var yb = y1 + (i + 1) * yd;
					var w = xb - xa;
					var h = yb - ya;

					this.graphics.fillStyle(options.fill_color);
					var rect = that.add
						.rectangle(xa, ya, w, h, options.fill_color)
						.setStrokeStyle(options.stroke_width, options.stroke_color);

					that.physics.add.existing(rect, true);
					group.add(rect);
				}
			},

			doCameraAdjust: function () {
				// adjust x and y of sprites as camera moves
				// runs in update()
				// Each key should have object {x:, y:}

				// look for sprites and tilesprites
				for (var ts in app.game.cameraAdjust.tileSprite) {
					try {
						if (!isNaN(app.game.cameraAdjust.tileSprite[ts].tilePosition.x)) {
							app.game.tileSprite[ts].tilePosition.x =
								game.camera.x * app.game.cameraAdjust.tileSprite[ts].x;
						}
						if (!isNaN(app.game.cameraAdjust.tileSprite[ts].tilePosition.y)) {
							app.game.tileSprite[ts].tilePosition.y =
								game.camera.y * app.game.cameraAdjust.tileSprite[ts].y;
						}
					} catch (er) {
						console.log(er);
					}
				}
			},

			_doPlayGame: function () {
				app.game._setUIGame();
				app.game._launchGame();

				// Resume and Wake
				app.game.resume();
				app.game.wake();
			},

			_doShowObjects: function () {
				app.game._setUIObjects();
				app.game._showObjects();
			},

			_fixInvalidNames: function () {
				var str = "";

				// Warn if invalid names
				jQuery(".phaser.item").each(function () {
					var title = jQuery(this).find(".title").text();
					if (title.match(/\W/)) {
						str += title + " ";
					}
				});

				if (str > "") {
					this.warn(
						0,
						"Invalid object names: The following objects have invalid names. These can cause errors in your game. " +
							str
					);
				}

				// Don't try to fix the errors (object title is fixed before saving, so should not occur.)

				/*
	
			var el = this._getFirstInvalidName();
			if(el){
				app._onceEditItem = function(){
	console.warn('editing item, fixing',el,el.find('.title').text())
				}
	
				try{
					el.click()
	
					// wait for the context menu to be ready
	
					app.setInterval(function(){
	
						if(jQuery('.dropdown-menu>li>a:contains("Edit")').length){
							jQuery('.dropdown-menu>li>a:contains("Edit")').each(function(){
								// if completed, stop interval
								app.clearInterval("app-game-editItem");
	
								// Click the Navigate button to run the game
								this.click();
	
							});
						}
	
					},100,3000,"app-game-editItem");
	
	
				}catch(er){
	console.warn('_fixInvalidNames error',er)								
				}
	
			}
	
			*/
			},

			// Fix the title
			_fixTitle: function (str, onChange) {
				// Format the name item_title to remove special characters and spaces
				// onChange indicates that the title is being changed in the Edit Item panel

				str = str.replace(/\W/g, "_");

				// Check if there are any existing items with this name
				// Max count: if being changed, then cannot have any in list. If initial, then there can be one in the list, this item itself.
				var maxCount = 1;
				if (onChange) {
					maxCount = 0;
				}
				if (
					jQuery(
						".items-inner .phaser.item .title:contains(" + str + ")"
					).filter(function () {
						return jQuery(this).text() === str;
					}).length > maxCount
				) {
					// append _
					str += "_";
				}
				return str;
			},

			_getBodyObjectNames: function () {
				// return an array of  names for all objects with a body
				var arr = [];
				jQuery.each(app.game._visibleTypes, function (i, type) {
					try {
						jQuery.each(app.game[type], function (name, obj) {
							// names starting with _ are internal
							if (!name.match(/^_/)) {
								arr.push(name);
							}
						});
					} catch (er) {}
				});

				return arr.sort();
			},

			_getColliderOptions: function (val) {
				// return an array of  names for all colliders and overlap options
				var options = app.game
					._getGroupNames()
					.concat(app.game._getBodyObjectNames())
					.concat([""]);

				// Add the current val - sometimes the current val is not one of the options
				if (val > "" && !jQuery.inArray(val, options)) {
					options.push(val);
				}

				return options.sort();
			},

			getConfig: function () {
				// return the config object
				// There should only be one, so return the first, if multiple
				// Or return empty object if none

				var keys = Object.keys(app.game.config);
				if (keys && keys.length) {
					return app.game.config[keys[0]];
				}

				return {};
			},

			_getFirstInvalidName: function () {
				// Return the first item (jQuery) that has an invalid name

				var rVal;
				jQuery(".phaser.item").each(function () {
					str = jQuery(this).find(".title").text();
					if (str.match(/\W/)) {
						rVal = jQuery(this);
						return false;
					}
				});
				return rVal;
			},

			_getGroupNames: function () {
				// return an array of all the group names (static and normal groups)
				var arr = [];
				jQuery.each(app.game.group, function (group, val) {
					// groups starting with _ are internal
					if (!group.match(/^_/)) {
						arr.push(group);
					}
				});
				jQuery.each(app.game.staticGroup, function (group, val) {
					// groups starting with _ are internal
					if (!group.match(/^_/)) {
						arr.push(group);
					}
				});
				return arr.sort();
			},

			_getObjectTypeFromClass: function (strClass) {
				// returns the object type from a list of classes
				// looks for specific classes such as phaser-sprite, phaser-collider etc

				// get a list of valid classes by going through the _tools
				// only do this once per reload, the list is static

				if (!app.game._toolTypes.length) {
					for (var i = 0; i < app.game._tools.length; i++) {
						for (var j = 0; j < app.game._tools[i].tools.length; j++) {
							var tool = app.game._tools[i].tools[j];

							var thisType = tool.itemCustomClass.replace(/.* phaser-/, "");
							app.game._toolTypes.push(thisType);
						}
					}
				}

				// go through all the types, and if a match in strClass, that's the type
				// create an array from strClass
				var arrClass = strClass.split(/ /);
				var rVal;
				jQuery.each(app.game._toolTypes, function (i, val) {
					if (arrClass.contains("phaser-" + val)) {
						rVal = val;
					}
				});
				return rVal;
			},

			_getSynopsisForObject: function (obj) {
				// Returns a synopsis describing this Item as an HTML string
				// This will differ based on the object type and properties
				// `obj` is the game object.

				var synopsis = "";

				// get the Tool for this type
				var tool = app.game._getToolByClass(
					obj.JSON.item.element.classList.value
				);

				// Add the comments.synopsis if there is one
				if (obj.JSON.hasOwnProperty("comments")) {
					if (
						obj.JSON.comments.hasOwnProperty("synopsis") &&
						obj.JSON.comments.synopsis > ""
					) {
						// Use the synopsis as the Text field
						synopsis +=
							'<div class="comment">' +
							decodeURI(obj.JSON.comments.synopsis) +
							"</div>";
					}
				}

				// Add a few key properties based on the type

				// Go through the synopsisProperties in the tool
				if (
					tool &&
					tool.hasOwnProperty("synopsisProperties") &&
					tool.synopsisProperties.length
				) {
					jQuery.each(tool.synopsisProperties, function (i, rowObj) {
						// Row
						synopsis += "<div>";

						// each array element should be an object of key/descriptor pairs for the row
						if (Object.keys(rowObj).length) {
							jQuery.each(rowObj, function (key, descriptor) {
								var val = "";
								try {
									var getVal = new Function("obj", "return obj." + descriptor);
									val = getVal(obj);
								} catch (er) {}
								synopsis += key + ": " + val + " ";
							});
						}

						synopsis += "</div>";
					});
				}

				return synopsis;
			},

			_getToolByClass: function (strClass) {
				// go through the list of tools (grouped in categories)
				// return the tool matching the class of this item
				// `strClass` is the full list custom classes for the item

				for (var i = 0; i < app.game._tools.length; i++) {
					for (var j = 0; j < app.game._tools[i].tools.length; j++) {
						var tool = app.game._tools[i].tools[j];

						if (
							app.game._getObjectTypeFromClass(strClass) ==
							app.game._getObjectTypeFromClass(tool.itemCustomClass)
						) {
							return tool;
						}
					}
				}
			},

			getType: function (name) {
				// return the type of object that has the name `name`
				// check groups, sprites, tileSprites etc

				var rVal;
				// go through all the supported types
				jQuery.each(app.game._collectionNames, function (i, type) {
					// for each type, go through the objects of this type
					jQuery.each(app.game[type], function (key, obj) {
						if (key == name) {
							rVal = type;
						}
					});
				});
				return rVal;
			},

			_getTypeFromElement: function (el) {
				// Returns the Phaser Object type by inspecting the Class list
				return jQuery(el)
					.attr("class")
					.replace(/phaser-setup/, "")
					.replace(/phaser-object/, "")
					.replace(/phaser-event/, "")
					.replace(/phaser-graphic/, "")
					.replace(/phaser-function/, "")
					.replace(/.*?(phaser-\w+).*/, "$1")
					.replace(/phaser-/, "");
			},

			_getVisibleObjectNames: function (val) {
				// return an array of  names for all visible objects and groups
				var options = app.game
					._getGroupNames()
					.concat(app.game._getBodyObjectNames())
					.concat([""]);

				// Add the current val - sometimes the current val is not one of the options
				if (val > "" && !jQuery.inArray(val, options)) {
					options.push(val);
				}

				return options.sort();
			},

			hide: function () {
				jQuery("#phaser-canvas").hide();
				jQuery(".app-navigator-inner").show();
				app.refreshScroll();
			},

			init: function (conf) {
				// initialise the game
				// all parameters are optional and can be used to override the default values

				// Empty all the containers
				app.game._resetObjectContainers();

				// Create the Config objects (should only be one)
				app.game.createPhaserConfigs(this);

				// use the parameter, or get the config from the Item
				var config = conf || app.game.getConfig();

				/*
			// if no properties, check the text field for JSON
			if(Object.keys(config).length == 0){
	
				try{
	
					
					// Warn if more than one
					if(jQuery('.phaser-config.item').length > 1){
						app.warn(2,'You have more than one Game Config objects')
					}
	
	
					// Use this if it has some properties
					if(Object.keys(obj).length){
						config = obj;
					}else{
						// do some checks
						if(!app.game.checkValidJSON(obj,item)){
							app.warn(2,'The JSON for Game Config has errors');
	
							if(text.match(/scene/).length){
								app.warn(2,"Do not include 'scene' in the Text field. If you want to configure the 'scene' then you need to move your config to the Action.");
								// try fix it
								text = text.replace(/,(\W|\n)*?scene\s*:\s*\{(.|\n)*?\}/,"")
								obj = app.utils.stringToObject(text);
	
								// Use this if it has some properties
								if(Object.keys(obj).length){
									app.warn(2,"Ignoring 'scene' in Text field");
									config = obj;
								}
							}
						}
					}
				}catch(er){
					app.warn(2,"Error retrieving settings from Text field");
				}
			}
			*/

				// Now make sure all data is added to the config
				// already done when creating Config objects
				// app.game.setObjectData(config,objData)

				// DEFAULTS
				// Make sure config has the following properties (using these defaults)
				if (!config.hasOwnProperty("data")) {
					app.game.setObjectData(config);
				}
				if (!config.hasOwnProperty("type")) {
					config.type = Phaser.CANVAS;
				}
				if (!config.hasOwnProperty("width")) {
					config.width = 350;
				}
				if (!config.hasOwnProperty("height")) {
					config.height = 450;
				}
				if (!config.hasOwnProperty("parent")) {
					config.parent = "phaser-canvas";
				} else if (config.parent == "phaser-example") {
					config.parent = "phaser-canvas";
				}
				if (!config.hasOwnProperty("physics")) {
					config.physics = {
						default: "arcade",
						arcade: {
							debug: false,
							gravity: {
								x: 0,
								y: 0,
							},
						},
					};
					if (config.debug || config.data.get("debug")) {
						config.physics.arcade.debug = true;
					}
				}
				// gravity might be in Main properties
				//if(config.JSON.gravity){
				if (
					config.hasOwnProperty("JSON") &&
					config.JSON.hasOwnProperty("gravity")
				) {
					if (config.JSON.gravity.hasOwnProperty("x")) {
						config.physics.arcade.gravity.x = config.JSON.gravity.x;
					}
					if (config.JSON.gravity.hasOwnProperty("y")) {
						config.physics.arcade.gravity.y = config.JSON.gravity.y;
					}
				}
				if (!config.hasOwnProperty("scene")) {
					config.scene = {};
				}
				if (!config.hasOwnProperty("scale")) {
					config.scale = {
						mode: Phaser.Scale.FIT,
						autoCenter: Phaser.Scale.CENTER_BOTH,
					};
				}
				// convert scale strings to constants
				try {
					if (
						config.scale.hasOwnProperty("mode") &&
						typeof config.scale.mode === "string"
					) {
						eval("config.scale.mode = " + config.scale.mode);
					}
					if (
						config.scale.hasOwnProperty("autoCenter") &&
						typeof config.scale.autoCenter === "string"
					) {
						eval("config.scale.autoCenter = " + config.scale.autoCenter);
					}
				} catch (er) {
					console.warn("ERROR app.game.init converting config.scale", er);
				}

				// Save config in app
				//app.game.config = config;

				// Remove stuff that is not supported - before returning to run()
				var r = {};
				jQuery.each(config, function (key, val) {
					// only accept these keys
					if (app.game._validConfigKeys.contains(key)) {
						r[key] = val;
					}
				});
				return r;
			},

			_initializeListItem: function (obj) {
				// Do some initialization of the Item on the List Screen

				var jItem = jQuery(obj.JSON.item.element);
				var content = "";
				var content = app.game._getSynopsisForObject(obj);

				// Hide the text div
				jItem.find(">.text").addClass("hidden");

				// Add synopsis (if not existing)
				if (!jItem.find(".synopsis").length) {
					jItem.append('<div class="synopsis"></div>');
				}
				jItem.find(".synopsis").html(content);
			},

			_installGameMaker: function () {
				// Code to Create the Game Maker
				//
				// TODO:
				// 1) How to set the Image-Link image using jQuery
				// 2) How to set the Action-JavaScript code using jQuery (CodeMirror)
				// 3) How to set the Action-Audio
				// 4) How to set the Action-Blockly

				// If the Game tab is present, installation has been done
				if (window._gm_installed) {
					return;
				}

				window._gm_installed = true;

				// Fix the Events tab icon
				jQuery("#events-btn-tab i")
					.removeClass("icon-star")
					.addClass("icon-time");

				//Fix line-height
				//app.addStyles('.box2 .content .icon h3{line-height: 1.5em}')

				// Remove explicit values on app-navigator, so UI works properly for Move items
				jQuery(".app-navigator").css("height", "inherit");
				jQuery(".app-navigator").css("width", "unset");

				jQuery(".app-navigator").css("height", "");
				jQuery(".app-navigator").css("width", "");
				jQuery(".app-navigator").css("top", "");
				jQuery(".app-navigator").css("bottom", "");

				// Add some things

				// LEFT PANEL
				app.game._insertLeftPanel();

				app.game._insertGameTools();

				setTimeout(function () {
					app.refreshScroll();
				}, 1000);
			},

			_insertGameTools: function () {
				if (jQuery("#nav-tabs_game").length == 0) {
					// Add a Games tab
					var gTab = jQuery(".toolbox ul.nav-tabs li:first")
						.clone()
						.attr("id", "nav-tabs_game")
						.removeClass("active");
					gTab
						.find("a")
						.removeClass("items")
						.addClass("games")
						.attr("data-target", "tab_games")
						.html('<i class="icon-gamepad"></i> Games');
					jQuery(".toolbox ul.nav-tabs li:first").after(gTab);

					// Add Games content
					// get the Items content
					var gContent = jQuery('<div class="tab-pane" id="tab_games">');
					jQuery(".toolbox #tab_items").after(gContent);

					// add code for tabs  clicked
					jQuery(".toolbox ul.nav-tabs li").click(function () {
						// inactivate all other tabs
						jQuery(".toolbox ul.nav-tabs li").each(function () {
							jQuery(this).removeClass("active");
						});

						// hide game content (default behaviour)
						jQuery(".toolbox #tab_games").removeClass("active");

						jThis = jQuery(this);
						jThis.addClass("active");

						// if game tab clicked, show Game Maker
						if (jThis.attr("id") == "nav-tabs_game") {
							app.game._showGameTools();

							// if not in GM, load it
							if (!jQuery("body").hasClass("gamemaker")) {
								app.game._showProduct("gamemaker");
							}
						} else if (jThis.find("a[data-target='tab_items']").length) {
							// Items clicked load AB

							// only if we're in GM,
							if (jQuery("body").hasClass("gamemaker")) {
								app.game._showProduct("appbuilder");
							}
						}
					});

					// Now add all the Tools
					jQuery.each(app.game._tools, function (i, section) {
						gContent.append(
							'<h1><span class="square ' +
								section.icon +
								'"></span>' +
								section.name +
								"</h1>"
						);
						var container = jQuery(
							'<div class="content clearfix"></div>'
						).appendTo(gContent);

						jQuery.each(section.tools, function (j, tool) {
							// if inactive , add a class
							var inactiveClass =
								tool.hasOwnProperty("inactive") && tool.inactive
									? "inactive"
									: "";

							if (!tool.hasOwnProperty("hidden") || !tool.hidden == false) {
								jQuery(
									'<a  class="icon ' +
										inactiveClass +
										'"><div class="tool ' +
										tool.icon +
										'"></div><h3>' +
										tool.name +
										"</h3></a>"
								)
									.click(function () {
										// When the tool is clicked...
										if (!tool.inactive) {
											// Add an Item using the properties of the tool
											app.game._addPanelItem(tool);
										}
									})
									.appendTo(container);
							}
						});
					});
				}
			},

			_insertLeftPanel: function () {
				// Insert the content for the

				try {
					if (jQuery("#phone .gm-left-panel").length == 0) {
						var jLeftPanel = jQuery(
							'<div class="gm-left-panel"></div>'
						).prependTo(jQuery("#phone"));

						// Add View Mode Buttons
						jQuery(
							'<div class="view-mode-box">          <button id="gm-view-objects" type="button" class="btn btn-big btn-dark active" >View Objects</button>          <button id="gm-play-game" type="button" class="btn btn-big btn-light" >Play Game</button>  </div>'
						).appendTo(jLeftPanel);

						jQuery("#gm-view-objects").click(function () {
							app.game._doShowObjects();
						});
						jQuery("#gm-play-game").click(function () {
							app.game._doPlayGame();
						});

						// Object Filters
						jQuery(
							'<div class="left-panel-box objects-visible">   <form>     <fieldset>       <legend>Filters</legend>     <label><input type="checkbox" id="gm-filter-setup" class="gm-filter gm-filter-collection" data-class="phaser-setup"> Setup</label>       <label><input type="checkbox" id="gm-filter-objects" class="gm-filter gm-filter-collection" data-class="phaser-object"> Sprites</label>       <label><input type="checkbox" id="gm-filter-graphic" class="gm-filter gm-filter-collection" data-class="phaser-graphic"> Graphics</label>       <label><input type="checkbox" id="gm-filter-event" class="gm-filter gm-filter-collection" data-class="phaser-event"> Events</label>       <label><input type="checkbox" id="gm-filter-function" class="gm-filter gm-filter-collection" data-class="phaser-function"> Functions</label>     <hr>        <label><input type="checkbox" id="gm-filter-all" class="gm-filter"> View All Objects</label>      <label><input type="checkbox" id="gm-filter-hidden" class="gm-filter" data-class="phaser-hidden"> Show Hidden Objects</label>      </fieldset>   </form>   </div>'
						).appendTo(jLeftPanel);

						// Game Controls
						jQuery(
							'<div class="left-panel-box game-visible">   <form>     <fieldset>       <legend>Controls</legend>       <label class="gm-link-play gm-game-controls"><i class=" icon-play"></i> Play</label>       <label class="gm-link-pause gm-game-controls"><i class=" icon-pause"></i> Pause</label>       <!--<label class="gm-link-resume gm-game-controls"><i class=" icon-repeat"></i> Resume</label>-->       <label class="gm-link-sleep gm-game-controls"><i class=" icon-off"></i> Sleep</label>       <!--<label class="gm-link-wake gm-game-controls"><i class=" icon-time"></i> Wake</label>-->       <label class="gm-link-stop gm-game-controls"><i class=" icon-stop"></i> Stop</label>   </fieldset> <br>  <fieldset>       <l gm-game-controlsgend>Settings</legend>            <label><input type="checkbox" id="gm-setting-editOnClick" class="gm-setting"  > Edit-on-Click</label>    </fieldset>   </form>   </div>'
						).appendTo(jLeftPanel);

						// Help
						jQuery(
							'<div class="left-panel-box game-visible objects-visible">   <form>     <fieldset>       <legend>Help &amp; Resources</legend>                                                   <label class="academy-course-link" data-category="Game Maker" data-course="Game Maker Basics">Game Maker Basics</label>            <label><a href="https://appshed.com/create/game-maker" target="_blank">User Guide</a></label>            <label><a href="https://appshed.com/create/game-maker/item/templates" target="_blank">Templates</a> <div class="edubadge" style="">EDU</div></label>            <label><a href="https://appshed.com/create/game-maker" target="_blank">Master Class (training)</a><div class="edubadge" style="">EDU</div></label>            <label class="academy-course-link " data-category="Game Maker">Game Courses<div class="edubadge" style="">EDU</div></label>                           </fieldset>   </form>   </div> '
						).appendTo(jLeftPanel);

						jQuery(".academy-course-link").click(function () {
							app.openAcademyLink(
								jQuery(this).data("category"),
								jQuery(this).data("course")
							);
						});

						// Game Controls
						jQuery(".gm-link-play").click(() => {
							jQuery(".gm-game-controls").removeClass("active");
							jQuery(".gm-link-play").addClass("active");
							app.game._doPlayGame();
						});
						jQuery(".gm-link-pause").click(() => {
							jQuery(".gm-game-controls").removeClass("active");
							jQuery(".gm-link-pause").addClass("active");
							app.game.pause();
						});
						jQuery(".gm-link-resume").click(() => {
							jQuery(".gm-game-controls").removeClass("active");
							jQuery(".gm-link-resume").addClass("active");
							app.game.resume();
						});
						jQuery(".gm-link-wake").click(() => {
							jQuery(".gm-game-controls").removeClass("active");
							jQuery(".gm-link-wake").addClass("active");
							app.game.wake();
						});
						jQuery(".gm-link-sleep").click(() => {
							jQuery(".gm-game-controls").removeClass("active");
							jQuery(".gm-link-sleep").addClass("active");
							app.game.sleep();
						});
						jQuery(".gm-link-stop").click(() => {
							jQuery(".gm-game-controls").removeClass("active");
							jQuery(".gm-link-stop").addClass("active");
							app.game.stop();
						});

						// event handlers for filters
						jQuery(".gm-filter").change(function () {
							app.game._applyFilter.call(this);
						});

						// Click the View All filter after setting up, this is the default.
						//jQuery('#gm-filter-all').click();
						this._setFilters();
					}
				} catch (er) {
					console.warn("app.game._insertLeftPanel", er);
				}
			},

			isVisible: function () {
				return jQuery("#phaser-canvas").css("display") == "block";
			},

			_launchGame: function () {
				// show the screen
				//app.hideDeepLoader();

				// If restart required, first stop
				if (app.game._requireRestart) {
					app.game.stop();
				}

				app.game.show();

				// if the game has not been launched, do that
				if (
					!window.game ||
					!window.game.hasOwnProperty("isBooted") ||
					!window.game.isBooted
				) {
					try {
						// find a Config item
						jQuery(".phaser-config.item:first").each(function () {
							this.click();

							// wait for the context menu to be ready

							app.setInterval(
								function () {
									if (
										jQuery('.dropdown-menu>li>a:contains("Navigate")').length
									) {
										jQuery('.dropdown-menu>li>a:contains("Navigate")').each(
											function () {
												// if completed, stop interval
												app.clearInterval("app-game-showGame");

												// highlight the Play control
												jQuery(".gm-game-controls").removeClass("active");
												jQuery(".gm-link-play").addClass("active");

												// Click the Navigate button to run the game
												this.click();
											}
										);
									}
								},
								100,
								3000,
								"app-game-showGame"
							);
						});
					} catch (er) {
						console.log("_showGame error", er);
					}
				}
			},

			_launchGameShowGameTools: function () {
				// launch the game, but then hide it and show game tools
				// this happens when Game Maker is started, or when the game is reset after adding objects

				// show the screen
				//app.hideDeepLoader();

				//app.game._ide = "objects";
				app.game._setUIObjects();

				// run the game, but pause it and show tools once loaded
				// We need the game objects instantiated to be able to edit properties
				app.game._pause = true;
				app.game._onPause = function () {
					app.game.hide();
					//jQuery(".app-navigator-inner").show();
					app.hideDeepLoader();
				};

				app.game._showGameTools();

				// if theres a Config, launch the game (it will pause and hide to show tools)
				if (jQuery(".phaser-config.item").length) {
					app.game._launchGame();
				} else {
					// if no Config, just show tools
					app.game.hide();
					app.game._showGameTools();
					//jQuery(".app-navigator-inner").show();
					app.hideDeepLoader();
				}
			},

			loadPhaserItems: function (that) {
				// looks for items with the CustomClass belonging to Phaser and loads them
				//  `phaser-image`
				//  `phaser-spriteSheet`
				// Spritesheets must include the width and height as JSON in the Text:
				// `{ width: 123, height: 456 }`

				jQuery(
					".phaser-image.item, .phaser-sprite.item, .phaser-tileSprite.item"
				).each(function () {
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						that.load.image(
							item.getTitle(),
							"https://cors.appshed.com/?u=" + item.getLargeImage()
						);
					} catch (er) {
						console.log("loadPhaserItems sprite er", this, er);
					}
				});

				jQuery(".phaser-spriteSheet.item").each(function () {
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));

						var obj = app.utils.stringToObject(item.getText());

						if (!isNaN(obj.width) && !isNaN(obj.height)) {
							// the method is "spritesheet" in lower Case
							that.load.spritesheet(
								item.getTitle(),
								"https://cors.appshed.com/?u=" + item.getLargeImage(),
								{
									frameWidth: obj.width,
									frameHeight: obj.height,
								}
							);
						}
					} catch (er) {
						console.log("loadPhaserItems spriteSheet er", this, er);
					}
				});

				jQuery(".phaser-audio.item[data-linktype='sound']").each(function () {
					try {
						var item = app.getItem(app.getIdFromDOMId(this.id));
						that.load.audio(
							item.getTitle(),
							"https://cors.appshed.com/?u=" + jQuery(this).data("href")
						);
					} catch (er) {
						console.log("loadPhaserItems audio er", this, er);
					}
				});
			},

			_loadPlugin: function (name, url) {
				// load the plugin `name` from `url`

				try {
					// check the plugin not already loaded
					jQuery.each(app.game.this.plugins.plugins, function (i, p) {
						if (p.key == "rexvirtualjoystickplugin") {
							return;
						}
					});

					// not found, so load it
					this.load.plugin(name, url, true);
				} catch (er) {}
			},

			movePhaserObjectsToGroups: function (that) {
				// Move objects to a group if they have that assigned
				jQuery.each(
					[
						app.game.image,
						app.game.sprite,
						app.game.spriteSheet,
						app.game.tileSprite,
						app.game.arc,
						app.game.circle,
						app.game.ellipse,
						app.game.line,
						app.game.multiline,
						app.game.polygon,
						app.game.rectangle,
					],
					function (i, collection) {
						jQuery.each(collection, function (j, obj) {
							if (obj.hasOwnProperty("group") && obj.group > "") {
								// check if it's a static group or normal group
								if (app.game.group.hasOwnProperty(obj.group)) {
									app.game.group[obj.group].add(obj);
								} else if (app.game.staticGroup.hasOwnProperty(obj.group)) {
									app.game.staticGroup[obj.group].add(obj);
								}
							}
						});
					}
				);
			},

			_onClickEditButtons: function () {
				// remove extra gm-clssses
				jQuery("#popup-container").removeClass("gm-fixedImage");

				// ================================================================
				// CLOSE

				if (jQuery(this).data("popup") == "close") {
					// In case the user changed some data values, reset them back to what they were, using the values in the textarea
					// TODO: This needs to be implemented

					if (app.game._ide == "game") {
						setTimeout(() => {
							app.game.resume();
						}, 500);
					}
				} else {
					// The screen.list will be updated on save and delete
					// Mark the list.screen as loading
					// This will be detected by app.doDOMSubtreeItemsModified()
					jQuery(".app-navigator-inner .screen.list").addClass("loading");
					// Force a call to the state handler to make sure it is registered
					app.doDOMSubtreeItemsModified();

					// ================================================================
					// SAVE

					// On Save require some data updates before saving
					if (jQuery(this).data("popup") == "post") {
						// The item_text already contains the modified JSON...
					}

					// ================================================================
					// DELETE and SAVE

					// Game must be relaunched because there are probably changes that need to be applied

					// hide the highlight element and show loader while we reload
					jQuery("#cloned-el, .phone-element-highlight").css("display", "none");
					app.showDeepLoader();
					app.hideLoader(100); // delay to make sure we get it

					// Once the save is complete, and Game Tools display, then stop (and restart) the game
					// to load fresh details
					app._onceGameTools = () => {
						app.game.stop();
					};
				}
			},

			_onJoystickPointerdown: function (pointer) {
				app.game.this.joystick.setVisible(true);
				app.game.this.joystick.x = pointer.x;
				app.game.this.joystick.y = pointer.y;
				app.game.this.joystick.update();
			},

			_onJoystickPointerUp: function (pointer) {
				app.game.this.joystick.setVisible(false);
			},

			_onJoystickUpdate: function () {
				// Joystick items
				// Check each joystick Item and the function if required

				var cursorKeys = app.game.this.joystick.createCursorKeys();

				jQuery.each(app.game.joystick, function (key, obj) {
					// the obj is the joystick object.

					if (
						(obj["on_up"] &&
							cursorKeys.up.isDown &&
							!cursorKeys.left.isDown &&
							!cursorKeys.right.isDown) ||
						(obj["on_down"] &&
							cursorKeys.down.isDown &&
							!cursorKeys.left.isDown &&
							!cursorKeys.right.isDown) ||
						(obj["on_left"] &&
							cursorKeys.left.isDown &&
							!cursorKeys.up.isDown &&
							!cursorKeys.down.isDown) ||
						(obj["on_right"] &&
							cursorKeys.right.isDown &&
							!cursorKeys.up.isDown &&
							!cursorKeys.down.isDown) ||
						(obj["on_up_left"] &&
							cursorKeys.up.isDown &&
							cursorKeys.left.isDown) ||
						(obj["on_up_right"] &&
							cursorKeys.up.isDown &&
							cursorKeys.right.isDown) ||
						(obj["on_down_left"] &&
							cursorKeys.down.isDown &&
							cursorKeys.left.isDown) ||
						(obj["on_down_right"] &&
							cursorKeys.down.isDown &&
							cursorKeys.right.isDown)
					) {
						app.game._funcs["joystick" + obj.JSON.item.domId].call(
							app.game.this
						);
						return;
					}
				});
			},

			_onLoadApp: function () {
				// Things to do every time the app loads
				try {
					// app.id 1 is the "app listing" screen,
					if (app.id == 1) {
						/*
					if(app.currentProduct == "gamemaker"){
						// Hiden game-specific controls
						jQuery('.gm-left-panel>div').css('display','none');
						jQuery('.gm-left-panel>div.objects-visible.game-visible').css('display','block');
	
						// delay to wait for the updates to arrive
						setTimeout(function(){
							var msg = 'Click the + to create a new app';
	
							// if there are apps already
							if(jQuery('.apps-inner .item').length){
								msg += ',<br>or select one of your existing apps'
							}
							
							msg += '.'
							jQuery('.span-toolbox').prepend('<div class="gm-no-app-open-msg" style="padding-top: 100px; padding-left: 30px; font-size: 20px; line-height: 30px;">'+msg+'</div>');
	
						},1000);
	
						// show a help message
					}
					*/
					} else if (app.id > 1) {
						// the Elements change, so we need to make sure  Phaser canvas is inserted
						// inject a phaser-canvas if not already present
						if (jQuery("#phaser-canvas").length == 0) {
							jQuery(".app-navigator").prepend(
								"<div id='phaser-canvas'></div>"
							);
						}
					}
				} catch (er) {
					console.warn("app.game._onLoadApp", er);
				}
			},

			_onLoadEditPanel: function (callback) {
				app.game.pause();

				// get the obj for this Tool
				var obj = app.game._getToolByClass(jQuery("#style_costumclases").val());

				if (obj) {
					setTimeout(function () {
						app.game._prepareEditPanel(obj, callback);
					}, 500);
				}
			},

			pause: function (callback) {
				// pause the game
				// optional `callback` called once paused

				app.game.state = "pause";

				try {
					// if there is no `this` (game object) then the app has probably been closed. so force stop
					app.game.this.scene.pause("default");
				} catch (er) {
					console.warn("app.game.pause Error", er);
				}

				try {
					jQuery(".event.onGameStop.item").each(function () {
						app.getItem(app.getIdFromDOMId(this.id)).callActions();
					});
				} catch (er) {
					console.warn("app.game.pause Error", er);
				}

				try {
					if (callback) {
						callback.call(app.game.this);
					}
				} catch (er) {
					console.warn("app.game.pause Error", er);
				}
			},

			_preloadStart: function () {
				// called at the start of scence.preload()
				// The context of `this` is the `this` from the create() function

				var protocol = "http";
				if (window && window.location && window.location.protocol) {
					protocol = window.location.protocol;
				}

				// Load the Virtual Joystick Plugin (if there are joystick items)
				if (jQuery(".phaser-joystick.item").length) {
					app.game._loadPlugin.call(
						this,
						"rexvirtualjoystickplugin",
						protocol +
							"//cors.appshed.com/?u=https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/rexrainbow-virtualjoystickjs.js"
					);
				}

				app.game._createHandles.call(this);

				app.game.createPhaserPreload(this);
				app.game.createPhaserCreate(this);
				app.game.createPhaserUpdate(this);
				app.game.createPhaserRender(this);

				try {
					// load the close button
					//this.load.image("_closeButton", 'https://cors.appshed.com/?u=http://d3s8dljl1bm5rz.cloudfront.net/7915413');
				} catch (er) {
					console.log(er);
				}

				// Call any phaser-create Items
				// The functions should have been added by _prepareGameFuncs
				app.game._funcs.preloadCaller.call(this);
			},

			_prepareEditPanel: function (obj, callback) {
				// Make some changes to the edit panel based on `obj`
				// `obj` is the Tool Object from _tools

				// make some UI changes to the Edit Panel
				// Call the `callback` once done

				// If the game is active
				if (app.game.isVisible()) {
					// Hide the Cloned Element (used to highlight the Item in normal App Builder)
					jQuery("#cloned-el").css("display", "none");
				}

				// For fixedImage (not editable by user) add some classes to the Panel
				if (obj.hasOwnProperty("fixedImage") && obj.fixedImage) {
					jQuery("#popup-container").addClass("gm-fixedImage");

					// clone it, to remove action
					// delay as it is still loading
					setTimeout(function () {
						try {
							jQuery(
								".gamemaker #popup-container .file-chooser-image.custom-input"
							).before(
								jQuery(
									".gamemaker #popup-container .file-chooser-image.custom-input"
								).clone()
							);
							jQuery(
								".gamemaker #popup-container .file-chooser-image.custom-input:not(:first)"
							).remove();

							// rename Tab Edit Image Link
							jQuery('#popup-container a:contains("Edit Image Link")').html(
								jQuery('#popup-container a:contains("Edit Image Link")')
									.html()
									.replace("Edit Image Link", "Properties")
							);
						} catch (er) {}
					}, 200);
				}

				// TITLE field

				// rename to "Object Name"
				jQuery("label[for*=item_title]").text("Object Name");

				// Add Help Text
				var itemHelp = app.game._toolsHelpText.title;
				if (obj.helpText) {
					itemHelp += "<br><br>" + obj.helpText;
				}

				jQuery("#item_title")
					.siblings(".help-block")
					.html(itemHelp)
					.css("display", "block");

				// IMAGE field

				// Add a linear gradient to make sure white images are visible
				var gradientBG = function () {
					try {
						var str = jQuery(".file-chooser-image.custom-input").attr("style");
						if (!str.match(/linear-gradient/)) {
							str = str.replace(
								/(url\(.*?\))/,
								"$1, repeating-linear-gradient( 45deg,  #ffffff,  #ffffff 10px,  #d1d1d1 10px,  #d1d1d1 20px)"
							);
							jQuery(".file-chooser-image.custom-input").attr("style", str);
						}
					} catch (er) {
						console.warn("ERROR gradientBG", er);
						alert(
							"The object did not load correctly. Please Cancel then re-open the object."
						);
					}
				};

				app._gradientBG();

				// Track changes to the image
				MutationObserver =
					window.MutationObserver || window.WebKitMutationObserver;

				var trackChange = function (element) {
					var observer = new MutationObserver(function (mutations, observer) {
						if (mutations[0].attributeName == "value") {
							jQuery(element).trigger("change");
						}
					});
					observer.observe(element, {
						attributes: true,
					});
				};

				// Make sure that we track changes on the item image
				trackChange(jQuery("input[name=item_image]")[0]);

				// When the Image changes
				//								jQuery("input[type=hidden]").bind("change", function() {
				jQuery("input[name=item_image]").bind("change", function () {
					// set the gradient background

					gradientBG();

					// For image and sprite objects only
					if (
						(!obj.itemCustomClass.match(/phaser-spriteSheet/) &&
							obj.itemCustomClass.match(/phaser-sprite/)) ||
						obj.itemCustomClass.match(/phaser-image/) ||
						obj.itemCustomClass.match(/phaser-tileSprite/)
					) {
						// Remove  width and height from  JSON
						//  (so that the new image dimensions are used)

						try {
							var j = JSON.parse(jQuery("#item_text").val());
							if (j.hasOwnProperty("width")) {
								delete j.width;
							}
							if (j.hasOwnProperty("height")) {
								delete j.height;
							}
							// put the JSON back
							jQuery("#item_text").val(JSON.stringify(j, null, "\t"));

							// also remove the gui controllers for width and height
							jQuery.each(app.game._guis.main.__controllers, function (i, con) {
								try {
									if (con.property == "width" || con.property == "height") {
										app.game._guis.main.remove(con);
									}
								} catch (er) {}
							});
						} catch (er) {}
					}

					// Hide the GUIs and JSON
					jQuery('.control-group:has("#item_text")').css("display", "none");
					jQuery(".control-group.dat-gui").css("display", "none");

					// Show an alert message
					jQuery("#edit_item").prepend(
						'<div class="alert">You must save this object after changing the image.</div>'
					);
				});

				// TEXT field

				// Rename to JSON
				jQuery("label[for*=item_text").text("JSON");

				// convert the text to JSON (with some error handling)

				var item_JSON = {};
				try {
					item_JSON = JSON.parse(jQuery("#item_text").val());
				} catch (er) {
					console.warn("ERROR The JSON is invalid", er);
				}

				// Make the JSON look pretty
				jQuery("#item_text").val(JSON.stringify(item_JSON, null, "\t"));

				// Add Help Text
				var itemHelp = app.game._toolsHelpText.text;
				jQuery("#item_text")
					.siblings(".help-block")
					.html(itemHelp)
					.css("display", "block");

				// PROPERTIES GUIs

				// When adding new Items (from tools), the Properties and Object are not valid, so all this code below will fail.
				try {
					var name = jQuery("#item_title")[0].value;
					var type = app.game.getType(name);

					var guiWidth = jQuery("#edit_item .control-group:last").css("width");
					var object = app.game[type][name];
					var mainProps = {};

					// Add some extra properties to the JSON
					// Take the full JSON and remove body,data,comments
					try {
						// Make sure there is a data property
						if (!item_JSON.hasOwnProperty("data")) {
							item_JSON.data = {};
						}

						// Add hidden property
						item_JSON.hidden = false;
						if (
							String(jQuery("#style_costumclases").val()).match(/phaser-hidden/)
						) {
							item_JSON.hidden = true;
						}

						// Config objects get Scale
						if (type == "config" && !item_JSON.hasOwnProperty("scale")) {
							item_JSON.scale = {
								mode: "Phaser.Scale.FIT",
								autoCenter: "Phaser.Scale.CENTER_BOTH",
							};
						}

						// For groups, andd staticGroup property
						if (
							String(jQuery("#style_costumclases").val()).match(/phaser-group/)
						) {
							item_JSON.staticGroup = false;
						}
						if (
							String(jQuery("#style_costumclases").val()).match(
								/phaser-staticGroup/
							)
						) {
							item_JSON.staticGroup = true;
						}

						// Visible types require certain property
						if (app.game._visibleTypes.includes(type)) {
							// list the required properties for Main, and their default values
							var _visibleTypesitem_JSON = {
								group: {
									default: "",
								},
								x: {
									default: 100,
								},
								y: {
									default: 100,
								},
								width: {
									default: object.width,
								},
								height: {
									default: object.height,
								},
							};

							// Make sure visible types these properties
							jQuery.each(
								_visibleTypesitem_JSON,
								function (property, settings) {
									try {
										if (!item_JSON.hasOwnProperty(property)) {
											item_JSON[property] = settings["default"];
										}
									} catch (er) {
										console.warn(
											"ERROR app.game._visibleTypesitem_JSON",
											property,
											settings
										);
									}
								}
							);
						}

						// Audio - add allowSimultaneous
						if (
							type == "audio" &&
							!item_JSON.hasOwnProperty("allowSimultaneous")
						) {
							item_JSON.allowSimultaneous = false; // by default don't allow simultaneous playing
						}

						// if action can be delayed, add some delay an repeat properties
						if (app.game._delayActionTypes.includes(type)) {
							// delay before first calling this method
							if (!item_JSON.hasOwnProperty("delay")) {
								item_JSON.delay = 0;
							}

							// TODO

							// Maximum times this function will be called (-1 is unlimited, 0 means first time then no repeats.)
							if (!item_JSON.hasOwnProperty("maxRepeats")) {
								//item_JSON.maxRepeats = -1;
							}
							// Delay between repeat calls of this method in milliseconds
							if (!item_JSON.hasOwnProperty("delayRepeatCalls")) {
								//item_JSON.delayRepeatCalls = 0;
							}
						}

						// Add all Comments properties
						if (!item_JSON.hasOwnProperty("comments")) {
							item_JSON.comments = {};
						}
						// and all the properties are present
						jQuery.each(app.game._jsonCommentProperties, function (i, val) {
							if (!item_JSON.comments.hasOwnProperty(val)) {
								item_JSON.comments[val] = "";
							}
						});

						// Now update the text field with the new JSON
						jQuery("#item_text").val(JSON.stringify(item_JSON, null, "\t"));

						// MAIN properties
						// Now remove other property groups (data,body,comments etc) leaving just Main Properties
						mainProps = item_JSON;
						jQuery.each(app.game._jsonPropertyGroups, function (i, val) {
							if (mainProps.hasOwnProperty(val)) {
								delete mainProps[val];
							}
						});
					} catch (er) {
						console.warn("Get Main Variables ERROR", er);
					}

					// ====================================
					// Create GUIs
					// ====================================

					var el = "";
					var params = {
						width: guiWidth,
						type: type,
						name: name,
						collection: "",
					};

					// Create GUI Main Properties
					// if not present

					if (jQuery(".gui-main").length == 0) {
						var el = jQuery('<div class="help-block">No Main properties</div>');
						try {
							if (mainProps && Object.keys(mainProps).length) {
								params.collection = "main";
								//var gui = app.game._createGui(mainProps,params);
								app.game._guis["main"] = app.game._createGui(mainProps, params);
								el = jQuery(app.game._guis["main"].domElement);
							}
						} catch (er) {
							console.warn("Create GUI Main Properties ERROR", er);
						}

						// Only Show Main Properties if there are some
						if (el > "") {
							// put this before the JSON text field
							jQuery("#edit_item .control-group")
								.has("label[for*=item_text]")
								.before(
									'<div class="control-group dat-gui gui-main"><fieldset><legend class="gui-label">Main Properties:</legend></fieldset></div>'
								);

							jQuery(".gui-main fieldset").append(el);
							jQuery(".gui-main .dg.main.a").css(
								"height",
								jQuery(".gui-main .dg.main.a").css("height")
							);
						}
					}

					// Create GUI Data Variables
					// if not present

					if (jQuery(".gui-data").length == 0) {
						var el = jQuery('<div class="help-block">No data variables</div>');
						try {
							if (
								object.hasOwnProperty("data") &&
								object.data.getAll &&
								Object.keys(object.data.getAll()).length
							) {
								params.collection = "data";
								app.game._guis["data"] = app.game._createGui(
									object.data.getAll(),
									params
								);
								el = jQuery(app.game._guis["data"].domElement);
							} else {
								// if not data
								el = jQuery('<div class="help-block">No data variables</div>');
							}
						} catch (er) {
							console.warn("Create GUI Data Variables ERROR", er);
						}

						// Only Show Data Properties if there are some
						if (el > "") {
							// put this before the JSON text field
							jQuery("#edit_item .control-group")
								.has("label[for*=item_text]")
								.before(
									'<div class="control-group dat-gui gui-data"><fieldset><legend class="gui-label">Data Variables:</legend></fieldset></div>'
								);
							jQuery(".gui-data fieldset").append(el);
							jQuery(".gui-data .dg.main.a").css(
								"height",
								jQuery(".gui-data .dg.main.a").css("height")
							);
						}
					}

					// Create GUI Body Properties
					// if not present

					if (jQuery(".gui-body").length == 0) {
						var el = "";
						try {
							if (object.hasOwnProperty("body")) {
								// this will throw an error for new objects, as they don't exist in the game cache yet, and objects without body
								params.collection = "body";
								app.game._guis["body"] = app.game._createGui(
									object.body,
									params
								);
								el = jQuery(app.game._guis["body"].domElement);
							}
						} catch (er) {
							console.warn("Create GUI Body Properties ERROR", er);
						}

						// Only Show Body Properties if there are some
						if (el > "") {
							// put this before the JSON text field
							jQuery("#edit_item .control-group")
								.has("label[for*=item_text]")
								.before(
									'<div class="control-group dat-gui gui-body"><fieldset><legend class="gui-label">Body Properties:</legend></fieldset></div>'
								);

							jQuery(".gui-body fieldset").append(el);
							jQuery(".gui-body .dg.main.a").css(
								"height",
								jQuery(".gui-body .dg.main.a").css("height")
							);
						}
					}

					// Create GUI Comments (for Super Users)
					// if not present
					if (app._isSuperUser()) {
						if (jQuery(".gui-comments").length == 0) {
							var el = "";
							try {
								if (object.JSON.hasOwnProperty("comments")) {
									params.collection = "comments";
									app.game._guis["comments"] = app.game._createGui(
										object.JSON.comments,
										params
									);
									el = jQuery(app.game._guis["comments"].domElement);
								}
							} catch (er) {
								console.warn("Create GUI Comments ERROR", er);
							}

							// Only Show Comments Properties if there are some
							if (el > "") {
								// put this before the JSON text field
								jQuery("#edit_item .control-group")
									.has("label[for*=item_text]")
									.before(
										'<div class="control-group dat-gui gui-comments"><fieldset><legend class="gui-label">Comments:</legend></fieldset></div>'
									);

								jQuery(".gui-comments fieldset").append(el);
								jQuery(".gui-comments .dg.main.a").css(
									"height",
									jQuery(".gui-comments .dg.main.a").css("height")
								);
							}
						}
					}

					// a bit of space before the JSON
					jQuery("#edit_item .control-group")
						.has("label[for*=item_text]")
						.before("<br><br><br>");

					// Any properties with a select needs the options class
					jQuery(".dg li.string")
						.has("select")
						.each(function () {
							jQuery(this).addClass("options");
						});
				} catch (er) {
					console.warn("_prepareEditPanel ERROR", er);
				}

				// fix it now
				jQuery("#item_title").val(
					app.game._fixTitle(jQuery("#item_title").val())
				);
				// and fix if it is changed
				jQuery("#item_title").change(function () {
					jQuery("#item_title").val(
						app.game._fixTitle(jQuery("#item_title").val(), true)
					);
				});

				// ================================================================
				// SAVE CLOSE DELETE
				// ================================================================

				// On Save or other button in GM, some extra tasks
				jQuery(".gamemaker #popup-container .edit-btns button").click(
					function () {
						app.game._onClickEditButtons.call(this);
					}
				);

				if (callback) {
					console.warn("_prepareEditPanel callback");
					callback.call();
				}
			},

			_prepareGameFuncs: function () {
				// prepare the functions

				app.game._prepareFuncs("preload", ".phaser-preload.item");
				app.game._prepareFuncs("create", ".phaser-create.item");
				app.game._prepareFuncs("update", ".phaser-update.item", "time,delta");
				app.game._prepareFuncs("render", ".phaser-render.item");

				app.game._prepareFuncs(
					"collider",
					".phaser-collider.item",
					"objectA,objectB"
				);
				app.game._prepareFuncs(
					"overlap",
					".phaser-overlap.item",
					"objectA,objectB"
				);
				app.game._prepareFuncs(
					"otherFunction",
					".phaser-otherFunction.item",
					"param1,param2,param3,param4,param5,param6,param7,param8,param9,param10"
				);
				app.game._prepareFuncs(
					"pointer",
					".phaser-pointer.item",
					"pointer,gameObject"
				);
				app.game._prepareFuncs("joystick", ".phaser-joystick.item");
				app.game._prepareFuncs("keyboard", ".phaser-keyboard.item");

				app.game._prepareFuncs("group", ".phaser-group.item");
				app.game._prepareFuncs("staticGroup", ".phaser-staticGroup.item");

				app.game._prepareFuncs("image", ".phaser-image.item");
				app.game._prepareFuncs("sprite", ".phaser-sprite.item");
				app.game._prepareFuncs("spriteSheet", ".phaser-spriteSheet.item");
				app.game._prepareFuncs("tileSprite", ".phaser-tileSprite.item");
				app.game._prepareFuncs("text", ".phaser-text.item");

				app.game._prepareFuncs("arc", ".phaser-arc.item");
				app.game._prepareFuncs("circle", ".phaser-circle.item");
				app.game._prepareFuncs("ellipse", ".phaser-ellipse.item");
				app.game._prepareFuncs("line", ".phaser-line.item");
				app.game._prepareFuncs("multiline", ".phaser-multiline.item");
				app.game._prepareFuncs("polygon", ".phaser-polygon.item");
				app.game._prepareFuncs("rectangle", ".phaser-rectangle.item");
			},

			_prepareFuncs: function (type, selector, argStr) {
				// prepare the functions for game, e.g. update()
				//
				// Functions are called like this
				//
				//    app.game._funcs.updateCaller.call(this,time,delta)
				//
				// Injects functions into a <script> tag at the end of the body
				// This avoids use of eval and expensive loops within update()
				// The context of `this` is the `this` from the create() function

				// type: What function type.
				//  Valid values: preload, create, update, render,
				//    collider, overlap, function, pointer, joystick, keyboard
				//    group, staticGroup,
				//    image, sprite, spriteSheet, tileSprite, text
				//	  "arc", "circle", "ellipse", "line", "multiline", "polygon", "rectangle"
				//
				// selector: The jQuery selector to use to find items
				//
				// argStr: a string for the arguments to pass to the function
				//   e.g. 'time,delta'
				//
				// object: Some of the functions will have access to a variable called 'object'
				// This is the object associated with the item, for example:
				//     var object = app.game['sprite']['sprite1'];
				//
				// data: Some functions will also have access to a variable called 'data'
				//    This holds the data properties as listed in the JSON

				var str = ""; // create a string to hold the functions
				var strCaller = ""; // a string for the caller function. This will call all the functions within that group. Used e.g. for sprites during _createEnd
				var argStr = argStr || "";

				// this holds the function that will call each individual function - by type
				strCaller +=
					"\n\n app.game._funcs['" +
					type +
					"Caller'] = function(" +
					argStr +
					"){ \n";

				// EACH
				// Inject scripts for all phaser-create Items
				jQuery(selector).each(function () {
					try {
						var j = jQuery(this);

						// try get this JSON
						var thisJSON = {};
						try {
							var item_JSON = JSON.parse(j.find(">.text").text());
							if (typeof item_JSON === "object") {
								thisJSON = item_JSON;
							}
						} catch (er) {}

						// Delay
						var delay = 0;
						if (
							thisJSON.hasOwnProperty("delay") &&
							!isNaN(thisJSON.delay) &&
							parseInt(thisJSON.delay) > 0
						) {
							delay = parseInt(thisJSON.delay);
						}

						var code = "";
						if (j.data("linktype") == "jscode") {
							code =
								appbuilder.app.api.phone.navigator.screenObj.javascripts[
									this.id
								];
						} else if (j.data("linktype") > "") {
							// TODO This is not very efficient... Better to get the JavaScript equivalent for the action
							// if the linktype is tab or screen (i.e. navigating away from the game) then stop the game.
							if (["tab", "screen"].contains(j.data("linktype"))) {
								code += "app.game.stop(); ";
							}
							code += "app.getItem('" + this.id + "').callActions();\n";
						}

						// skip if no code to run
						if (code == "") {
							return;
						}

						var item = app.getItem(this.id);
						var name = item.getTitle();

						// JavaScript error If Code has an error, JSLint
						// Show message us linter, and skip if code has an error

						var hasError = true; // set to true... skip the Function test below
						try {
							// this line throws an error if there is a problem with the code
							// but sometimes this does not pick up all errors
							(function () {
								new Function(code);
							})();
						} catch (er) {
							hasError = true;
						}

						if (hasError) {
							var msg = app._getJSLintMessages(code);
							/*
							let option = Object.create(null);
							["devel","browser","fudge","convert","eval","for","getset","long","single","this","white"].forEach(function (title) {
								option[title] = true;
							});

							var result = app.jslint(
								code,option,
								["object","item","data","app","jQuery"]
							);
							
							var msg = '';
							jQuery(result.warnings).each(function(i,val){
								msg += "<cite><address>Line "+ (parseInt(val.line)+1) +"</address>"+val.message+"</cite><samp>"+ result.lines[val.line]+ "</samp>  \n<br>";
							})
							*/

							if (msg > "") {
								app.warn(0, msg, null, [item.id + ""]);
							}
						}

						// skip if the title contains non word characters
						// (as this causes error when used as variable name)
						if (name.match(/\W/)) {
							throw (
								"Invalid function name " + name + " for object type " + type
							);
						}

						// Start creating the function...

						str +=
							"\n\n app.game._funcs['" +
							type +
							this.id +
							"'] = function(" +
							argStr +
							"){ \n";

						// If the object has a delay...
						if (delay) {
							//str += " \n setTimeout(function(){ \n";
							// create a temp fn
							str += " \n var fn = function(){ \n";
						}

						// add the object
						str +=
							" var object; try{object = app.game['" +
							type +
							"']['" +
							name +
							"'];}catch(er){} \n";
						str +=
							" var item; try{item = app.getItem(object.item.id)}catch(er){} \n";
						str +=
							" var data; try{data = app.game['" +
							type +
							"']['" +
							name +
							"'].data;}catch(er){} \n";
						// add all the object refrences
						str += app.game._prepareFuncsObjectList();

						// Start the try-catch
						str += " \n try{ \n";

						// Add the code
						str += code;

						// End the try-catch
						str +=
							" \n\n}catch(er){ \n  console.warn('Error in function (" +
							type +
							this.id +
							")',er); \n} \n";

						// End the delay
						if (delay) {
							//str += " \n },"+delay+"); \n";
							// bind a temp fn to this, so that it is called with this (game) context
							str += " \n } \n  setTimeout(fn.bind(this)," + delay + "); \n";
						}

						// end function
						str += "\n} \n";

						// add to the caller
						strCaller +=
							" \n  app.game._funcs['" +
							type +
							this.id +
							"'].call(app.game.this," +
							argStr +
							") \n";
					} catch (er) {
						console.log("error with _prepareFuncs", this, er);
					}
				});

				// end the caller
				strCaller += "\n} \n";

				// Remove the existing script if present
				jQuery(".phaser_scripts_" + type).remove();

				// Add a script element for this type.
				// jQuery does not allow adding of scripts

				try {
					var code = str + strCaller;

					// this line throws an error if there is a problem with the code
					(function () {
						new Function(code);
					})();

					var script = document.createElement("script");
					script.setAttribute("class", "phaser_scripts_" + type);
					script.text = code;
					document.body.appendChild(script);
				} catch (er) {
					console.warn("ERROR _prepareFuncs inject script", er);
					app.warn(
						0,
						"One of the game objects has a JavaScript error: " +
							type +
							"(" +
							selector +
							")"
					);
				}
			},

			_prepareFuncsObjectList: function (refresh) {
				// returns a string describing all the objects in the game
				// These can be used in Actions for easy reference
				// For example var sprite1 = app.game.sprite['sprite1']

				if (refresh) {
					app.game._funcsObjectListDone = false;
				}

				if (app.game._funcsObjectListDone) {
					return app.game._funcsObjectList;
				}

				var types = [
					"audio",
					"collider",
					"collision",
					"config",
					"group",
					"image",
					"joystick",
					"keyboard",
					"overlap",
					"otherFunction",
					"pointer",
					"settings",
					"sprite",
					"staticGroup",
					"text",
					"tileset",
					"tileSprite",
				];
				// add graphic types
				types = types.concat([
					"arc",
					"circle",
					"ellipse",
					"line",
					"multiline",
					"polygon",
					"rectangle",
				]);
				var str = "\n\n";

				jQuery.each(types, function (i, type) {
					try {
						jQuery(".phaser-" + type).each(function () {
							var key = jQuery(this).find(".title").text();

							// make sure the key is valid - cannot have non-word characters
							if (key.match(/\W/)) {
								app.warn(
									0,
									"Invalid object name (Object names must not contain special characters): " +
										key
								);
								throw "Invalid object name " + key;
							} else {
								// Special Case for Other Functions...
								if (type == "otherFunction") {
									// Add a variable for the Function Object
									// e.g. function1Obj
									// This will provide access to the Object data etc
									str +=
										"var " +
										key +
										"Obj = app.game." +
										type +
										'["' +
										key +
										'"]; \n';

									// Create a function that can be called directly
									str +=
										"var " +
										key +
										" = function(param1,param2,param3,param4,param5,param6,param7,param8,param9,param10){ \n";
									str +=
										"return app.game._funcs['otherFunction" +
										this.id +
										"'].apply(app.game.this,arguments) \n";
									//app.game.'+type+'["'+key+'"].call(app.game.this,param1,param2,param3,param4,param5,param6,param7,param8,param9,param10)}; \n';
									str += "}; \n";
								} else {
									str +=
										"var " +
										key +
										" = app.game." +
										type +
										'["' +
										key +
										'"]; \n';
								}
							}
						});
					} catch (er) {}
				});

				app.game._funcsObjectList = str + "\n\n";
				app.game._funcsObjectListDone = true;

				return app.game._funcsObjectList;
			},

			press: function (key) {
				// handler for key presses, to make it easy to control the game from JavaScript external to the game
				if (["up", "down", "left", "right"].indexOf(key) != -1) {
					acursors[key].isDown = true;
				}
				return this;
			},

			/*
		pressButtonA: function() {
			game.spaceKey.isDown=true;
			// Play the default audo.
			// If the built in audio has been replaced with an Item, call the action
			if(app.game.audio.jump.play){
				app.game.audio.jump.play();
			}else if(app.game.audio.jump.callActions){
				app.game.audio.jump.callActions();
			}
		},
	
	
	
		pressButtonB: function() {
			game.spaceKey.isDown=true;
			if(app.game.audio.shoot.play){
				app.game.audio.shoot.play();
			}else if(app.game.audio.shoot.callActions){
				app.game.audio.shoot.callActions();
			}
		},
	
		pressButtonC: function() {
			game.shiftKey.isDown=true;     
			if(app.game.audio.flick.play){
				app.game.audio.flick.play();
			}else if(app.game.audio.flick.callActions){
				app.game.audio.flick.callActions();
			}
		},
	
		*/

			release: function (key) {
				// handler for key presses, to make it easy to control the game from JavaScript external to the game
				if (["up", "down", "left", "right"].indexOf(key) != -1) {
					acursors[key].isDown = false;
				}
				return this;
			},

			_resetObjectContainers: function () {
				this.preload = {};
				this.create = {};
				this.update = {};
				this.render = {};

				this.score = 0;
				this.scoreText = "";

				this.audio = {};
				this.cameraAdjust = {
					tileSprite: {},
					sprite: {},
				};
				this.collider = {};
				this.collision = {};
				this.functions = {};
				this.group = {};
				this.image = {};
				this.joystick = {};
				this.keyboard = {};
				this.keyCode = {};
				this.overlap = {};
				this.pointer = {};
				this.settings = {};
				this.sprite = {};
				this.staticGroup = {};
				this.text = {};
				this.tileset = {};
				this.tileSprite = {};

				window.game = {}; // this will hold the Phaser game object
				window.player = {}; // in most games this is used for the main character

				this._funcsObjectListDone = false;
			},

			resume: function () {
				app.game.state = "resume";

				app.game._pause = false;
				app.game.show();

				if (app.game.this && app.game.this.scene) {
					app.game.this.scene.resume("default");
					return app.game.state;
				}
			},

			run: function (config) {
				// Returns the String that can be eval'd to run the game
				// `config` is optional. This can include any of the built in Phaser 3 config properties
				// Usage: add `eval(app.game.run(config))` at the top of the Phaser script

				var sceneName = null;

				// If config has scene.name = '...' or config.scene = [ {name: ''} ]
				if (config && config.hasOwnProperty("scene")) {
					if (config.scene.hasOwnProperty("name")) {
						sceneName = config.scene.name;
					} else if (
						config.scene.length &&
						config.scene[0] &&
						config.scene[0].hasOwnProperty("name")
					) {
						sceneName = config.scene[0].name;
					}
				}

				// if in Game Maker, do some UI setup
				if (app.isAppBuilder && app.game._ide == "game") {
					app.game._setUIGame();
				}

				// if the game is running, resume/wake/show
				if (
					window.game &&
					window.game.hasOwnProperty("isBooted") &&
					window.game.isBooted
				) {
					app.game.show();
					app.game.wake();
					app.game.resume();
					return ""; // return empty for the eval
				}

				// Make sure canvas container is the right height
				jQuery("#phaser-canvas").css(
					"height",
					jQuery(".app-navigator").css("height")
				);

				var config = app.game.init(config);

				// this code presumes that the scene methods (e.g. scene.preload) simply calls an inline function by the same name preload().

				if (sceneName) {
					var strConfig = JSON.stringify(config);
					strConfig = strConfig.replace(
						/"scene":\[null\]/,
						'"scene": [' + sceneName + "]"
					);
					strConfig = strConfig.replace(/"scene":null/, '"scene":' + sceneName);
					console.warn("run scene", strConfig);

					return (
						"config = " +
						strConfig +
						';   config.scene.preloadOrig = config.scene.preload;  config.scene.preload = function(){ app.game.this = this.game; try{app.game._preloadStart.call(this);              app.game.loadPhaserItems(this); config.scene.preloadOrig() }catch(er){app.handleError(er,"preload()")}}   ;    config.scene.createOrig = config.scene.create;     config.scene.create = function(){ try{app.game._createStart.call(this);  app.game.createPhaserObjects(this); config.scene.createOrig(); app.game._createEnd.call(this)}catch(er){app.handleError(er,"create()")}};     config.scene.updateOrig = config.scene.update;   config.scene.update = function(time,delta){ try{app.game._updateStart.call(this,time,delta); config.scene.updateOrig(); app.game._updateEnd.call(this,time,delta) }catch(er){app.handleError(er,"update()")}};     config.scene.renderOrig = config.scene.render;    config.scene.render = function(){ try{config.scene.renderOrig() }catch(er){app.handleError(er,"render()")} } ;  app.game._prepareGameFuncs()    ; game = new Phaser.Game(config); app.game.resize(); app.game.start();'
					);
				} else {
					return (
						" config = " +
						JSON.stringify(config) +
						';    config.scene.preload = function(){ app.game.this = this; try{app.game._preloadStart.call(this);     					app.game.loadPhaserItems(this); if(typeof preload != "undefined"){preload.call(this)}}catch(er){app.handleError(er,"preload()")}}   ;         config.scene.create = function(){ try{app.game._createStart.call(this);  app.game.createPhaserObjects(this); if(typeof create != "undefined"){create.call(this)}; app.game._createEnd.call(this)}catch(er){app.handleError(er,"create()")}};        config.scene.update = function(time,delta){ try{app.game._updateStart.call(this,time,delta); if(typeof update != "undefined"){update.call(this,time,delta)}; app.game._updateEnd.call(this,time,delta) }catch(er){app.handleError(er,"update()")}};         config.scene.render = function(){ try{if(typeof render != "undefined"){render.call(this)} }catch(er){app.handleError(er,"render()")} } ;  app.game._prepareGameFuncs()    ; game = new Phaser.Game(config); app.game.resize(); app.game.start();'
					);
				}
			},

			resize: function (scale) {
				return;

				// resize the game according to the required `scale`
				// `scale` (optional) Default "stretch"
				//    Options:
				//      none: no resizing. The game dimensions remain unchanged. If the game is bigger than the screen, parts of the game will extend beyond the visible screen area.
				//      stretch: reize without respecting proportions so that the game fills the available width and height
				//      fit: resize proportionately so that the  game fits into the screen (no parts extended out of the screen) (if the game ratio is different to the screen ratio, unused screen space will be visible )
				//      fill: resize proportionately so that the screen is filled with the game (if the game ratio is different to the screen ratio, then parts of the game will extend beyond the visible screen area)
				//      Returns `this`

				var scale =
					scale ||
					(app.game.getConfig().hasOwnProperty("scale")
						? app.game.getConfig().scale
						: "fit");

				var pc = jQuery("#phaser-canvas");
				var canvas = jQuery("#phaser-canvas canvas");
				var container = jQuery(".app-navigator");
				var maxWidth = parseInt(container.css("width"));
				var maxHeight = parseInt(container.css("height"));

				var newWidth = maxWidth;
				var newHeight = maxHeight;

				var gameRatio = game.config.width / game.config.height;

				if (scale == "none") {
					newWidth = game.config.width;
					newHeight = game.config.height;
				} else if (scale == "stretch") {
					newWidth = maxWidth;
					newHeight = maxHeight;
				} else if (scale == "fill") {
					// try fix width
					var newWidth = maxWidth;
					var newHeight = maxWidth / gameRatio;

					// if too small, fix height
					if (newHeight < maxHeight) {
						newHeight = maxHeight;
						newWidth = maxHeight * gameRatio;
					}
				} else {
					// if (scale == "fit") is the default

					// try fit width
					newWidth = maxWidth;
					newHeight = maxWidth / gameRatio;

					// if too big, limit to height
					if (newHeight > maxHeight) {
						newHeight = maxHeight;
						newWidth = maxHeight * gameRatio;
					}
				}

				canvas.css("width", newWidth).css("height", newHeight);
				return this;
			},

			saveObject: function (name, obj) {
				// Save an obj to the game collection for later reference

				if (name && obj) {
					app.game.object[name] = obj;
				}
			},

			scale: function (w, h) {
				// fit to the screen

				game.scale.setGameSize(w, h);
				game.scale.scaleMode = Phaser.ScaleManager.EXACT_FIT;
				game.scale.pageAlignVertically = true;
				game.scale.pageAlignHorizontally = true;
			},

			setEmptyMessage: function (countHidden) {
				// show messages below Object List
				// (optional) `countHidden` shows how many hidden items there are

				// if on app listing screen, hide msg
				if (app.id <= 1) {
					jQuery(".items-msg").addClass("hidden");
					return;
				}

				jQuery(".items-msg").removeClass("hidden");

				var msg = "";

				if (countHidden > 0) {
					msg =
						"There are " +
						countHidden +
						" hidden items.<br> Use the selector on the left to reveal hidden items.";
				} else if (countHidden == -1) {
					msg =
						"There might be hidden items.<br> Use the selector on the left to reveal hidden items.";
				}

				jQuery(".items-msg-has-hidden").html(msg);
			},

			_setFilters: function () {
				// Set the filters
				// Use the localStorage currentFilters if present
				// Otherwise default to all

				if (
					localStorage["currentFilters"] &&
					localStorage["currentFilters"].length
				) {
					var currentFilters = JSON.parse(localStorage["currentFilters"]);

					// go through each filter and set it
					jQuery("#gm-filter-all").prop(
						"checked",
						currentFilters["gm-filter-all"]
					);
					jQuery("#gm-filter-hidden").prop(
						"checked",
						currentFilters["gm-filter-hidden"]
					);

					jQuery(".gm-filter-collection").each(function () {
						// save the state in currentFilters
						jQuery(this).prop(
							"checked",
							currentFilters[jQuery(this).data("class")]
						);
					});

					this._applyFilter();
				} else {
					// Make sure the View All filter is clicked to apply filters
					// Might need to click twice if currently checked
					if (jQuery("#gm-filter-all").prop("checked")) {
						jQuery("#gm-filter-all").click();
					}
					jQuery("#gm-filter-all").click();
				}
			},

			setObjectData: function (object, settings) {
				// Set the data for object as defined by settings
				// settings must have a property called 'data'
				// settings.data contains key-value pairs for each data item to be saved within the object
				// can be used with Actions, e.g.
				//   app.game.sprite['staticGroup1'].data.get('rows')

				// add the data property to the object
				// If the Phaser class does not provide support for data, use _dataClass as a workaround
				if (object.setDataEnabled) {
					object.setDataEnabled();
				} else {
					object.data = app.game._dataClass();
				}

				// if nothing to add
				if (
					!settings ||
					!settings.hasOwnProperty("data") ||
					typeof settings.data !== "object"
				) {
					return;
				}

				jQuery.each(settings.data, function (key, val) {
					try {
						// use 0x for hex values
						if (String(key).match(/color/i)) {
							val = val.replace(/#/, "0x");
						}
						object.data.set(key, val);
					} catch (er) {}
				});
			},

			setObjectProperties: function (object, props) {
				// Set the properties for object as defined by props (safe)
				// keys in props might be non-standard, e.g. 'body.immovable' (which is supported by Phaser.group.set())
				// If no props passed in, use the object.JSON by default

				if (!props && object && object.JSON) {
					props = object.JSON;
				}

				// Set the Data
				if (props && props.hasOwnProperty("data")) {
					app.game.setObjectData(object, props);
				}

				jQuery.each(props, function (key, value) {
					try {
						// ignore the keys 'data' 'comments' - this is handled by setobjectData
						// and dots in the key
						// and starting with _ (private properties)
						if (
							["data", "comments", "item", "__proto__"].includes(key) ||
							String(key).match(/^_/) ||
							String(key).match(/\./)
						) {
							return;
						}

						if (typeof value === "object" && !Array.isArray(value)) {
							return app.game.setObjectProperties(object[key], value);
						} else {
							object[key] = value;
						}
					} catch (er) {
						// we expect many errors here, because we might be trying to set properties intended for Sprites on the Group. But we are doing this to make it easier for beginners to add the Sprite properties to a group for "setAll" puporses
					}
				});
			},

			setAllObjectProperties: function (that) {
				// Set the properties for all objects.
				// The order is important. First do groups.setAll, and then Sprites etc.
				// This ensures that granular settings done on Sprites will override group settings.
				// For all groups, call setAll for any properties as required
				// Parameters for setAll must be present in the JSON.
				// The key is 'params_setAll'

				jQuery.each(app.game.group, function (i, group) {
					try {
						if (group.JSON.hasOwnProperty("params_setAll")) {
							app.game.callGroupSetAll(group, group.JSON.params_setAll);
						}

						// Workaround: support for a simplified notation...
						// setting a property on a group will setAll on children
						// e.g. "body.immovable": true   on the group, will set all children immovable
						jQuery.each(group.JSON, function (key, value) {
							try {
								group.setAll(key, value);
							} catch (er) {}
						});
					} catch (er) {
						console.warn("setAllObjectProperties", i, group, er);
					}
				});

				// now also set Sprite properties.
				// This was already done when creating the sprite, but do again in case there are properties that the group overwrote... we want the sprite properties to override group
				jQuery.each(app.game.sprite, function (i, sprite) {
					try {
						app.game.setObjectProperties(sprite);
					} catch (er) {
						console.warn("setAllObjectProperties sprite", i, er);
					}
				});

				jQuery.each(app.game.tileSprite, function (i, tileSprite) {
					try {
						app.game.setObjectProperties(tileSprite);
					} catch (er) {
						console.warn("setAllObjectProperties tileSprite", i, er);
					}
				});
			},

			_setUIGame: function () {
				app.game._ide = "game";
				jQuery("body").removeClass("gm-objects").addClass("gm-game");

				jQuery(".view-mode-box button").removeClass("active");
				jQuery("#gm-play-game").addClass("active");
			},

			_setUIObjects: function () {
				app.game._ide = "objects";
				jQuery("body").removeClass("gm-game").addClass("gm-objects");

				jQuery(".view-mode-box button").removeClass("active");
				jQuery("#gm-view-objects").addClass("active");
			},

			_createHandles: function () {
				try {
					// create some shortcut handles to make coding easier
					// These are Globals, so need to keep an eye on conflicts. But for beginners it really helps
					scene = app.game.this.scene.manager.scenes[0];
					world = scene.physics.world;
				} catch (er) {
					console.warn("_createHandles()", er);
				}
			},

			show: function () {
				jQuery("#phaser-canvas").show();
				jQuery(".app-navigator-inner").hide();
			},

			_showGameTools: function () {
				// Show the Game Tools,

				// Empty Message (to show when Object list is empty)
				if (jQuery(".items-msg").length == 0) {
					jQuery(".items-inner").append(
						'<div class="items-msg hidden ">  <p class="items-msg-build">Select an item (on right)<br>to build your Game</p>    <br><br>    <p class="items-msg-build">Change the filters (on left)<br>to view Objects</p>  <br><br> 	<p class="items-msg-has-hidden "></p>   </div>'
					);
				}
				app.game.setEmptyMessage();

				// hide active tool tab
				jQuery(".toolbox ul.nav-tabs li").each(function () {
					jQuery(this).removeClass("active");
				});

				// make game tab active
				jQuery(".toolbox #nav-tabs_game").addClass("active");

				// hide active pane
				jQuery(".toolbox .tab-pane.active").removeClass("active");

				// make game panel active
				jQuery(".toolbox #tab_games").addClass("active");
			},

			_showItemTools: function () {
				// just click on the Item tab
				jQuery('.nav-tabs li a[data-target="tab_items"]')[0].click();
			},

			_showObjects: function () {
				app.game.sleep();
				app.game.hide();
			},

			_showProduct: function (prod) {
				app._showProduct(prod);
			},

			sleep: function () {
				// Sleep all scenes
				app.game.state = "sleep";

				try {
					app.game.this.scene.sleep("default");

					// If in app, show tab bar
					if (!app.isAppBuilder) {
						app.showTabBar();
					}
				} catch (er) {}
			},

			start: function () {
				//app.log("Phaser version " + Phaser.VERSION);

				app.hideTabBar();

				// make sure the Menu is available
				//app.game._addMenu();

				game.paused = false;
				app.game.show();
			},

			stop: function () {
				// if in Game Maker, do some UI setup
				/*
				if(app.isAppBuilder && app.game._ide != "objects"){
					app.game._setUIObjects();
				}
				*/

				// cancel if no active game
				if (
					!app.game.this ||
					!app.game.hasOwnProperty("this") ||
					!app.game.hasOwnProperty("this")
				) {
					return;
				}

				app.game._resetObjectContainers();

				try {
					app.game.this.game.destroy(true);
				} catch (er) {
					console.error("ERROR app.game.stop", er);
				}

				// sometimes the canvas is not removed
				jQuery("#phaser-canvas").html("");

				// Reset some variables
				app.game._menuAdded = false;

				// Untick "Edit on click"
				try {
					if (jQuery("#gm-setting-editOnClick").prop("checked")) {
						jQuery("#gm-setting-editOnClick").click();
					}
				} catch (er) {}

				//game.destroy();
				game = {};
				game.run = app.game.run;

				app.game.hide();

				jQuery(".event.onGameStop.item").each(function () {
					app.getItem(app.getIdFromDOMId(this.id)).callActions();
				});

				// If in app, show tab bar
				if (!app.isAppBuilder) {
					setTimeout(() => {
						app.showTabBar();
						app.game.hide();
					}, 300);
				} else {
					// if in Game Maker, do some UI setup
					if (app.currentProduct == "gamemaker") {
						app.game._launchGameShowGameTools();
					}
				}
			},

			upButtonA: function () {
				game.spaceKey.isDown = false;
			},

			upButtonB: function () {
				game.spaceKey.isDown = false;
			},

			upButtonC: function () {
				game.shiftKey.isDown = false;
			},

			_updateEnd: function (time, delta) {
				// called at the end of scence.update()
				// The context of `this` is the `this` from the create() function

				try {
					// The functions should have been added by _prepareGameFuncs
					// to a script tag on the body
					// Call the caller function that will call each update function
					app.game._funcs.updateCaller.call(this, time, delta);
				} catch (er) {}

				// Keyboard items
				// Check all keys and run code

				// the keyCode holds an array of objects related to each key
				// keys support these events:
				//   isDown, isUp, keyup, keydown
				jQuery.each(app.game.keyCode, function (key, objArr) {
					// handle isDown event

					// for each key, go through the array of code scripts
					jQuery.each(objArr, function (i, ofunc) {
						// ofunc is a descriptor {functionName, event}
						// check if this func is up/down and the script event matches
						if (
							(ofunc.event == "isDown" && app.game.keys[key].isDown) ||
							(ofunc.event == "isUp" && app.game.keys[key].isUp)
						) {
							// call each function
							try {
								app.game._funcs[ofunc.functionName].call(app.game.this);
							} catch (er) {}
						}
					});

					// check if the key has jusst been released
					if (Phaser.Input.Keyboard.JustUp(key)) {
					}
				});

				// run joystick updates
				// This function must be called on every update, and onChange, because change doesn't fire if position remains constant
				if (this.joystick && this.joystick.hasOwnProperty("force")) {
					app.game._onJoystickUpdate();
				}
			},

			updateKey: function () {
				// old
			},

			_updateStart: function (time, delta) {
				// called at the start of scence.update()
				// The context of `this` is the `this` from the create() function

				// sometimes a game is closed and this loop is still called.so exit if no game
				if (!app.game.hasOwnProperty("this") || app.game.this == null) {
					return;
				}

				if (app.game._pause) {
					app.game.pause(app.game._onPause);
					return; // don't do anything else
				}

				// Try update the Score text
				// If there is a Text Object called score, it will automatically get updated with the app.game.score
				try {
					app.game.text["score"].setText("Score: " + app.game.score);
				} catch (er) {}
			},

			wake: function () {
				app.game.state = "wake";
				app.game._pause = false;

				// Wake all scenes
				if (app.game.this && app.game.this.scene) {
					app.game.this.scene.wake("default");
					return app.game.state;
				}
			},
		};

		// Temporary workaround ... some modules use game.run() instead of app.game.run()
		game.run = app.game.run;

		app.game.Game = function (game) {};

		app.game.Game.prototype = {
			preload: function () {
				try {
					preload();
				} catch (er) {
					console.log(er);
				}
			},

			create: function () {
				try {
					create();
				} catch (er) {
					console.log(er);
				}
			},

			update: function () {
				try {
					update();
				} catch (er) {
					console.log(er);
				}
			},

			render: function () {
				try {
					render();
				} catch (er) {
					console.log(er);
				}
			},
		};

		Device.prototype.toString = function deviceToString() {
			var ret = "Device " + this.id;
			return ret;
		};

		// INITIALISE App
		// But on testappjs, load overrides first. this allows you to use local overrides just on this file: appjs_overrides.js
		if (window._appjs_test == true) {
			try {
				var url =
					"https://s3.eu-west-1.amazonaws.com/staticmedia.appshed.com/includes/appbuilder/test/appjs_overrides.js";
				// on local file, use a local url
				if (window.location.origin == "file://") {
					url = "appjs_overrides.js";
				}
				var currentlinks = document.getElementsByTagName("script");
				var exists = false;
				for (var j = 0; j < currentlinks.length; j++) {
					if (currentlinks[j].href == url || currentlinks[j].src == url) {
						exists = true;
					}
				}

				// inject a script element into the head
				if (!exists) {
					var fileref = document.createElement("script");
					fileref.setAttribute("type", "text/javascript");
					fileref.setAttribute("src", url);

					// add the error callback
					fileref.onerror = function (err) {
						console.error("Error loading appjs_overrides.js", err);
					};

					// add the success callback
					if (fileref.readyState) {
						//IE
						fileref.onreadystatechange = function () {
							if (
								fileref.readyState === "loaded" ||
								fileref.readyState === "complete"
							) {
								fileref.onreadystatechange = null;
								app._init();
							}
						};
					} else {
						//Others
						fileref.onload = function () {
							app._init();
						};
					}

					document.getElementsByTagName("head")[0].appendChild(fileref);
				}
			} catch (error) {
				console.error("window._appjs_test", error);
			}
		} else {
			app._init();
		}
	} catch (er) {
		console.log("ERROR IN app.js", er);
	}

	if (!window.appjsconsolelog) {
		window.appjsconsolelog = true;

		/*
     _               ____  _              _ 
    / \   _ __  _ __/ ___|| |__   ___  __| |
   / _ \ | '_ \| '_ \___ \| '_ \ / _ \/ _` |
  / ___ \| |_) | |_) |__) | | | |  __/ (_| |
 /_/   \_\ .__/| .__/____/|_| |_|\___|\__,_|
         |_|   |_|                          					
		*/
		// launched 25-02-2023
		console.log(
			"     _               ____  _              _ \n    / \\   _ __  _ __/ ___|| |__   ___  __| |\n   / _ \\ | '_ \\| '_ \\___ \\| '_ \\ / _ \\/ _` |\n  / ___ \\| |_) | |_) |__) | | | |  __/ (_| |\n /_/   \\_\\ .__/| .__/____/|_| |_|\\___|\\__,_|\n         |_|   |_|                          "
		);

		console.log(
			"%c AppShed app.js v" + app.version,
			"background: #111; color: #EEE"
		);
	}

	// Mautic
	/* Now handled by GTM event app_userInitDone
	mt('send', 'pageview', {
		email: app.getUser().getEmail(),
		firstname: app.getUser().getName()
	});
    */
} // END window.addEventListner _initAppShed

/* 
========================================================================================================
        Device object Device Class
========================================================================================================
*/

function Device(props) {
	// Class definition for `Device`
	// Create a new `Device` object: `var obj = new Device(props)`
	// Must call `obj.init()` after creating the new `Device`
	// `props` is a JSON object of properties used to instantiate the Device
	// - `props.id` The `id` is mandatory and is used to identify the device.
	// - `props.local_ip` Optional Local IP Address of the device
	// - `props.layoutId` Optional board layout ID (from AppShed IoT Builder)

	/*
	Default JSON structure from AppShed firmware
	{
		"variables": {
			"build": 55,
			"WiFiIP": "",
			"WiFiSSID": "AppShed",
			"APIP": "192.168.4.1",
			"logoQueueIndex": 0,
			"analogValues": "1",
			"digitalValues": "0,0,0,0,0,0,0,0,0",
			"other": "{		// A string containing JSON formatted data for various other variables

			}"
		},
		"id": "local",
		"name": "device_name",
		"hardware": "esp8266",
		"connected": true
	}

	Dfault JSON from aREST
	{
		"variables": {
			"temperature": 24,
			"humidity": 40
		},
		"id": "1",
		"name": "esp8266",
		"hardware": "esp8266",
		"connected": true
	}

	*/

	// TODO
	// * run checks on localIP to make sure the app is on same subdomain, before using it.
	// * support IOIO calls or aREST calls... and Arduino calls
	// * do setPinMode when required... on calling read/write methods... and use callback if changing pinMode.

	this._maxPins = 50; // Maximum number of pins - used in updateTiedVariables()
	this.address = "";
	this._ajaxProperties = {
		// holds various properties for the ajax calls made to a device
		analogRead: {
			status: 0, // status can be 0 - inactive, 1 - sending
		},
		analogWrite: {
			status: 0,
		},
		callFunction: {
			status: 0,
		},
		digitalRead: {
			status: 0,
		},
		digitalWrite: {
			status: 0,
		},
		getInfo: {
			status: 0,
		},
		getVariable: {
			status: 0,
		},
		setPinMode: {
			status: 0,
		},
	};
	this._appshedFirmware = true; // presume that the appshed firmware is used (epxects to find a 'build' variable). Otherwise expect an aREST firmware without appshed features
	this.connected = false; // This value is passed in from the device
	this.deadZoneAdjustment = 0;
	this.logoErrors = []; // hold all the logo errors
	this.logoErrorsCaptured = ""; // hold the errors that have been captured and saved in this.logoErrors
	this.logoErrorsClearAfter = 10000; // send a clearErrors command after n seconds
	this.logoErrorsGotAt = 0; // The time when new errors were received
	this.id = "";
	this.handle_ioBatchCommands = null; // a handle for the timeout to send batch commands
	this.hardware = ""; // This value is passed in from the device
	this.hasTestedLocalIPFromRemote = false;
	this.info = {}; // Holds the data returned by `getInfo()`
	this.ioBatchCommands = []; // Array of commands to be sent as a batch to the device
	this.ioBatchMode = app._ioBatchMode; // Send IO commands to devices in batches, defaults to `true`
	this.ioBatchTimeout = app._ioBatchTimeout; // how long to wait while collecting IO commands (e.g. from multiple Blockly commands), Defaults to `100`
	this.ioMaxCommandsPerBatch = app._ioMaxCommandsPerBatch = 4;
	this.isTestingLocalIP = false;
	this.isTestingLocalIPFromRemote = false;
	this.isValidLocalIP = false;
	this.isValidLocalIPFromRemote = false;
	this.lastSetPinValue = {}; // records the last value that was set for a pin - used by togglePin()
	this._lastTieAllPins = 0; // keep a record when we last tied all pins
	this.layout = null;
	this.local_ipFromRemote = null; // Stores the local IP Address received from Remote
	this._logoExpressions = []; // Array to hold the logo expressions to DISPLAY
	this._logoErrorStatus = ""; // a status of what the device is currently doing
	this._maxAnalogPinNum = 0; // Presume NodeMCU which only has A0
	this._maxDigitalPinNum = 8; // Presume ModeMCU
	this.name = ""; // This value is passed in from the device
	this.pendingMethods = {
		analogRead: {},
		analogWrite: {},
		digitalRead: {},
		digitalWrite: {},
	}; // An object of objects for each of the IO methods. This holds a flag when a certain method is pending (i.e. AJAX call in process)
	this.properties = props; // Stores the `props` passed in when the device is instantiated
	this.pinFormats = {};
	this.pinNames = []; // An array of pin names (from the layout)
	this.pinModes = {};
	//this.pinValues = {}; deprecated - use this[D1]
	this.pinVariableTies = {}; // each pin can have an array of variables tied to that pin
	this.pollActive = false; // flag if pollin is active for this device (repeatedly reading pin values)
	this.pollTimeout = 500; // How long to wait between polling
	this.pollStarted = 0; // The time when the last poll started
	this._readIndividuallyDigitalQueue = []; // holds a queue of digital pins to read
	this._readIndividuallyAnalogQueue = []; // holds a queueu of analog pins to read
	this.statusGetInfo = "ready"; // Status of the getInfo calls
	this.remoteAddress = "";
	this.tiePinsToVariables = true; // Default true. If true, variables in the app are tied to pins by the same name
	this.updated = 0; // timestamp when the last update was returned from the device
	this.variables = {}; // This object is passed in from the device

	this.init = function () {
		// Initialize the object
		// Set defaults
		this.hasTestedLocalIPFromRemote = false;
		this.isTestingLocalIP = false;
		this.isTestingLocalIPFromRemote = false;
		this.isValidLocalIP = false;
		this.isValidLocalIPFromRemote = false;
		this.pendingMethods = {
			analogRead: {},
			analogWrite: {},
			digitalRead: {},
			digitalWrite: {},
		};

		// Set dynamic properties
		this.id = this.properties.id;
		this.key = this.properties.key; // Optional key for the aREST Pro account

		// Update remote address
		this.updateRemoteAddress();

		// Update the device info using properties passed in
		this.updateInfo(this.properties);

		// Call setup methods
		this.configureAddress();
		this.configureLayout();

		if (this.tiePinsToVariables) {
			this.tieAllPinsToVariables();
		}

		// add a loop command to update when status icon when sending
		var that = this;
		app.loop(function () {
			that.updateStatusIndicator();
		}, 500);

		return this;
	};

	this.addBatchCommand = function (format, pin, value, duration) {
		// Add a command to the batch, and send after a timeout
		// This allows multiple commands issued in close succession to be batched up, reducing dealys in multiple API calls

		this.ioBatchCommands[this.ioBatchCommands.length] = [
			format,
			pin,
			value,
			duration,
		];

		// start the timeout if not already running
		if (!this.handle_ioBatchCommands) {
			var deviceId = this.id;

			this.handle_ioBatchCommands = setTimeout(function () {
				app.getDevice(deviceId).sendCommands().handle_ioBatchCommands =
					undefined;
			}, this.ioBatchTimeout);
		}
	};

	this.alertPinValue = function (pin, format) {
		// Shows a screen alert message with the value of the pin.
		// Optional `format` can be `a` (for analog) or `d` (for digital) value (Default: `d`)
		// Returns `this`

		var format = format || "d";

		if (format == "d")
			this.digitalRead(pin, function (data) {
				appbuilder.app.alert("Pin " + pin + " = " + data.return_value);
			});
		if (format == "a")
			this.analogRead(pin, function (data) {
				appbuilder.app.alert("Pin " + pin + " = " + data.return_value);
			});

		return this;
	};

	this.analogRead = function (pin, callback) {
		// DONT set pin mode for analog... this is only for the D pins
		// this.setPinMode(pin,"i")
		this.setPinFormat(pin, "a");

		//app.console.warn('Device.analogRead', (this.address + '/analog/' + pin + '?key=' + this.key));

		/*
		CHANGE: now using /analog/a
		jQuery.ajaxq(this.id, {
		  url: this.address + '/analog/' + pin +'?key='+this.key,
		  crossDomain: true
		}).done(function(data) {
		  if(callback != null) callback(data);
		});
		*/

		var that = this;
		this._ajaxProperties.analogRead.status = 1;

		jQuery
			.ajaxq(this.id, {
				url: this.address + "/analog/a?key=" + this.key,
				timeout: app._ajaxTimeout,
				crossDomain: true,
			})
			.always(function (data, textStatus, jqXHR) {
				that._ajaxProperties.analogRead.status = 0;
			})
			.done(function (data) {
				// Set the device A pin to the value
				that["A" + pin] = data["A" + pin];

				//  add return_value to the data, for legacy support... /analog/0 provided data.return_value
				data.return_value = data["A" + pin];

				if (callback != null) callback(data);
			});

		return this;
	};

	this.analogWrite = function (pin, state, noBatch) {
		// Send an API call to the device to write an analog `value` to `pin`.
		// Optionally If `useBatchCommands` is true the command is cached and sent after a short delay in a batch

		this.setPinMode(pin, "o").setPinFormat(pin, "a");

		if (noBatch || !this.ioBatchMode) {
			this._ajaxProperties.analogWrite.status = 1;
			var that = this;

			jQuery
				.ajaxq(this.id, {
					url:
						this.address + "/analog/" + pin + "/" + state + "?key=" + this.key,
					timeout: app._ajaxTimeout,
					crossDomain: true,
				})
				.always(function (data, textStatus, jqXHR) {
					that._ajaxProperties.analogWrite.status = 0;
				})
				.done(function (data) {});
		} else {
			this.addBatchCommand(0, pin, state, 0);
		}
		return this;
	};

	this.attachDHT = function (pinNumber, type) {
		// Attach DHT to pin
		// optional type: (default) DHT11 (0), DHT22 (1), DHT21 (2)

		var type = type || 0;
		this.callFunction("attachDHT", pinNumber + "," + type); // pass pin,type

		return this;
	};

	this.attachServos = function (attachArray) {
		// Attach servos to pins
		// `attachArray` is a two-dimensional array [x][2]
		// For each x, the array has the servo number (e.g. 1) and the pin number (e.g. 7)

		var params = ""; // Build up the params to send to the board to attach the required arrays

		for (var i = 0; i < attachArray.length; i++) {
			// for first one add
			if (i > 0) params += ":"; // `:` is the separator between servo definitions
			params += attachArray[0] + "," + attachArray[1];
		}

		if (params > "") this.callFunction("attachServos", params);

		return this;
	};

	this.blink = function (number, duration, noBgChange) {
		// Blink the built-in LED
		// Optional `number` specifies how many blinks (default 5)
		// Optional `duration` specifies the time to stay on and off (default 1 second)
		// Optional `noBgChange` ensures that the Screen BackgroundColor is not changed during blink

		var number = number || 5;
		var duration = duration || 1000;
		var deviceId = this.id;
		var noBgChange = noBgChange || false;
		var origColor = app.getScreen().getBackgroundColor();

		app.setInterval(
			function () {
				app.getDevice(deviceId).setLED(1);
				if (!noBgChange) app.getScreen().setBackgroundColor("Red");

				setTimeout(function () {
					app.getDevice(deviceId).setLED(0);
					if (!noBgChange) app.getScreen().setBackgroundColor("Gray");
				}, duration);
			},
			duration * 2,
			duration * 2 * number
		);

		// Put the Screen Bg back
		if (!noBgChange)
			setTimeout(function () {
				app.getScreen().setBackgroundColor(origColor);
			}, duration * 2 * (number + 1));

		return this;
	};

	this.callFunction = function (called_function, options, onSuccess, onFail) {
		/*
		Calls a function defined on the device
		`options` Either a String containins parameters, or an object, with options and parameter
			options.timeout - timeout for the AJAX call
			options.useCaller - boolean, use the caller function
		NB The Device can only contain a max 10 functions and 10 variables
		NUMBER_FUNCTIONS AREST_NUMBER_FUNCTIONS
		*/

		// cancel if not connected
		// actually try anyway
		/*
		if (!this.connected) {
			return;
		}
		*/

		var parameters = ""; // by default the options holds a string with parameters
		var timeout = app._ajaxTimeout;
		var func = called_function;
		var useCaller = false;

		if (typeof options === "string") {
			parameters = options;
		}

		// If options object passed in, assign the options
		if (typeof options === "object" && options !== null) {
			if (options.hasOwnProperty("parameters")) {
				parameters = options.parameters;
			}
			if (options.hasOwnProperty("timeout")) {
				timeout = options.timeout;
			}
			if (options.hasOwnProperty("useCaller") && options.useCaller) {
				useCaller = true;
			}
		}

		// The _deviceCallerFunctions need to go to the /caller endpoint (see firmware for details)
		if (
			app._deviceCallerFunctions.indexOf(called_function) != -1 ||
			useCaller
		) {
			func = "caller";
			// prepend the func to the parameters
			if (parameters.length) {
				parameters = called_function + "|" + parameters;
			} else {
				parameters = called_function;
			}
		}

		var thisURL = this.address + "/" + func;
		if (parameters) {
			thisURL += "?params=" + parameters;
		}
		if (this.id != "local" && this.key) {
			thisURL += "%26key=" + this.key;
		}

		var that = this;
		this._ajaxProperties.callFunction.status = 1;

		jQuery
			.ajaxq(this.id, {
				url: thisURL,
				crossDomain: true,
				timeout: timeout,
			})
			.always(function (data, textStatus, jqXHR) {
				that._ajaxProperties.callFunction.status = 0;
			})
			.done(function (data, textStatus, jqXHR) {
				if (onSuccess != null) {
					//onSuccess( data, textStatus, jqXHR)
					onSuccess.apply(that, [data, textStatus, jqXHR]);
				}
			})
			.fail(function (a, textStatus, b) {
				if (onFail != null) onFail.apply(that, [a, textStatus, b]);
			});

		return this;
	};

	this.cancelPending = function (method, pin, state) {
		// Cancels the `method`,`pin`,`state` combination from the pending methods.
		// Return `this`

		this.pendingMethods[method][pin + "_" + state] = false;

		return this;
	};

	this.clear = function () {
		// Clear the device data

		// Clear logoLoop code
		app.setLogoLoopSettings({
			code: "",
		});

		// reset the device using firmware function
		this.callFunction("clear");

		return this;
	};

	this.configureAddress = function () {
		// Configures which address to use for calls to this device.
		// Priority for which `address` to use is given in the following order:
		// * `192.168.4.1` for `local` deviceID when using softAP
		// * `localIP`
		// * `localIPFromRemote`
		// * The default cloud webservice

		if (this.id == "local") {
			this.address = "http://192.168.4.1";
		} else if (this.variables.local_ip && this.variables.local_ip > "") {
			if (this.isValidLocalIP)
				this.address = "http://" + this.variables.local_ip;
			else this.testLocalIP();
		} else if (
			this.local_ipFromRemote &&
			this.local_ipFromRemote != "undefined"
		) {
			if (this.isValidLocalIPFromRemote)
				this.address = "http://" + this.local_ipFromRemote;
			else this.testLocalIP(1);
		} else {
			this.updateRemoteAddress();
			this.address = this.remoteAddress;
			if (!this.hasTestedLocalIPFromRemote) this.getLocalIPFromRemote();
		}

		return this;
	};

	this.configureLayout = function () {
		// configures the board layout using the IoT Builder layout settings
		// Using a layout makes it much simpler for novice users as they make use of the IoT Builder to configure the board.
		// Using a layout is optional. The app can simply set pins using pin numbers directly.
		if (
			(this.properties.layoutId && this.properties.layoutId > "") ||
			app.getDefaultLayoutId()
		) {
			// attempt to get the board layout
			this.getLayout();
		} else {
			// remove the layout object to make sure it is not used.
			this.layout = null;
		}

		return this;
	};

	this.connect = function (onConnect, onFail) {
		// Connects to the device.
		// Optional function `onConnect` called once connected
		// Optionalfunction `onFail` called if connection fails
		// Returns `this`

		this.getInfo(onConnect, null, onFail);

		return this;
	};

	this.digitalRead = function (pin, callback) {
		// Reads the digital value of `pin`
		// Optional `callback(data)` function is called passing the `data` from the Response
		// Returns `this`

		this.setPinMode(pin, "i").setPinFormat(pin, "d");
		this._ajaxProperties.digitalRead.status = 1;
		var that = this;
		//var aUrl = this.address + '/digital/' +  that.getGPIO(pin) + '?key=' + this.key;
		// aREST no longer uses GPIO
		var aURL = this.address + "/digital/" + pin + "?key=" + this.key;

		jQuery
			.ajaxq(this.id, {
				url: aURL,
				timeout: app._ajaxTimeout,
				crossDomain: true,
			})
			.always(function (data, textStatus, jqXHR) {
				that._ajaxProperties.digitalRead.status = 0;
			})
			.done(function (data) {
				if (callback != null) callback(data);
			});
		return this;
	};

	this.digitalWrite = function (pin, state, noBatch) {
		// Sets the digital output on `pin` to `state`
		// `state` must be either `1` or `0`
		// Optionally If `noBatch` is true the command is not cached else  sent after a short delay in a batch

		this.setPinMode(pin, "o").setPinFormat(pin, "d");

		if (noBatch || !this.ioBatchMode) {
			if (this.isPending("digitalWrite", pin, state)) {
				return this;
			}

			this.setPending("digitalWrite", pin, state);
			var deviceId = this.id;
			this._ajaxProperties.digitalWrite.status = 1;
			var that = this;
			var aURL =
				this.address + "/digital/" + pin + "/" + state + "?key=" + this.key; // was that.getGPIO(pin) aREST no longer uses GPIO

			jQuery
				.ajaxq(this.id, {
					url: aURL,
					timeout: app._ajaxTimeout,
					crossDomain: true,
					id: this.id,
				})
				.always(function (data) {
					that._ajaxProperties.digitalWrite.status = 0;
					app.getDevice(deviceId).cancelPending("digitalWrite", pin, state);
				});
		} else {
			this.addBatchCommand(1, pin, state, 0);
		}
		return this;
	};

	this.fade = function (pin, direction, duration, noBgChange) {
		// Fade `pin` on or off, depending on `direction`.
		// Optional `pin` is the pin number (Default: 5, except on RaspberryPi: 7)
		// If `direction` is "on" or 1, the pin will fade from 0 to 100%
		// If `direction` is "out", "off" or 0, the pin will fade from 100% to 0
		// Default `direction` is 1
		// Optional `duration` determines how long the fade should take (Default: 5 seconds)
		// Optional `noBgChange` ensures that the Screen BackgroundColor is not changed during blink
		// Returns `this`

		var pin = pin || (this.hardware == "rpi" ? 7 : 5);
		var direction =
			direction != null &&
			(direction == 0 || direction == "off" || direction == "out")
				? 0
				: 1;
		var deviceId = this.id;

		if (direction) {
			this.analogWrite(pin, 0);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 20);
			}, 1000);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 40);
			}, 2000);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 60);
			}, 3000);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 80);
			}, 4000);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 100);
			}, 5000);
		} else {
			this.analogWrite(pin, 100);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 80);
			}, 1000);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 60);
			}, 2000);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 40);
			}, 3000);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 20);
			}, 4000);
			setTimeout(function () {
				app.getDevice(deviceId).analogWrite(pin, 0);
			}, 5000);
		}

		return this;
	};

	this.fireEvents = function () {
		// Fire off actions for any events that are true

		//						jQuery.each(appbuilder.EventsList.app,function(idx,val){
		//							jQuery.each(val,function(i,v){

		for (var i = 0; i < appbuilder.EventsList.app.length; i++) {
			var v = appbuilder.EventsList.app[i].event;

			if (v.type == "iot") {
				appbuilder.EventsList.app[i].event.currentCompare = app.utils.compare(
					this.getPin(v.variable),
					v.value,
					v.method,
					v.range
				);

				// only do action if current and previous val differ, or
				// or if no previous, and current true
				if (v.currentCompare) {
					if (v.previousCompare === null || !v.previousCompare) {
						appbuilder.app.ActionHandler.fireAction(v.action);
					}
				}

				appbuilder.EventsList.app[i].event.previousCompare = v.currentCompare;
			}
			//	})
			//})
		}
	};

	this.getGPIO = function (pin) {
		// Returns the GPIO value for pin
		// Will depend on the hardware being used, e.g. ESP8266

		if (this.hardware == "UNO") {
			// TODO future support for other devices
		} else {
			// default is ESP8266
			return app._gpioESP8266[pin];
		}
	};

	this.getInfo = function (onSuccess, address, onFail) {
		// Queries the device to get basic info
		// `onSuccess` is the function run when the `data` is returned from the device (arguments: data, textStatus, jqXHR)
		// Optional `address` can be passed in, the default address is `this.address`
		// Optional `onFail` is the function called when the connection fails (arguments: a, textStatus, b)
		// Returns `this` or null if not ready

		// If not ready, return
		if (this.statusGetInfo != "ready") {
			return null;
		}

		this.statusGetInfo = "running";

		var d = this;
		var address = address || this.address;

		if (!address || address == "" || address == "undefined") return;

		if (!address.match(/http/)) address = "http://" + address;

		var deviceId = this.id;
		this._ajaxProperties.getInfo.status = 1;
		var that = this;

		jQuery
			.ajaxq(this.id, {
				url: address + "/info" + "?key=" + this.key,
				crossDomain: true,
				timeout: app._ajaxTimeout,
			})
			.always(function () {
				that._ajaxProperties.getInfo.status = 0;

				// save the updated time
				d.updated = Date.now();

				// Delay before making device ready - to avoid overloading
				setTimeout(function () {
					d.statusGetInfo = "ready";
				}, app._deviceDelayBetweenInfo);
			})
			.done(function (data, textStatus, jqXHR) {
				try {
					d.updateHistory(deviceId, address, "done", data, textStatus, jqXHR);
					app.getDevice(deviceId).updateInfo(data).info = data;
					if (onSuccess != null && data.connected) {
						onSuccess.call(d, data, textStatus, jqXHR);
					} else if (onFail != null && !data.connected) {
						onFail.call(d, data, textStatus, jqXHR);
					}
				} catch (er) {
					app.handleError(er, "Device.getInfo()");
				}
			})
			.fail(function (jqXHR, textStatus, errorThrown) {
				try {
					d.updateHistory(
						deviceId,
						address,
						"done",
						null,
						textStatus,
						jqXHR,
						errorThrown
					);
					app.getDevice(deviceId).connected = false;
					if (onFail != null) {
						onFail.call(d, jqXHR, textStatus, errorThrown);
					}
				} catch (er) {
					app.handleError(er, "Device.getInfo()");
				}
			});

		return this;
	};

	this.getLayout = function (callback) {
		if (!this.properties.layoutId) {
			// If no layoutId, try get from Attached data-board attribute (linked board)
			if (!isNaN(app.getDefaultLayoutId())) {
				this.properties.layoutId = app.getDefaultLayoutId();
			} else {
				// can't find an attached board, so cancel
				return this;
			}
		}

		var address = app._url_boardWithPins + this.properties.layoutId;
		var deviceId = this.id;

		jQuery
			.ajax({
				url: address,
				crossDomain: true,
			})
			.done(function (data) {
				if (callback != null) {
					callback(data);
				} else {
					// Check the data to see if it has error
					// save the data in local storage
					localStorage["layout" + deviceId] = JSON.stringify(data);

					var d = app.getDevice(deviceId);
					d.setLayout(data);

					if (d.tiePinsToVariables) {
						d.tieAllPinsToVariables();
					}
				}
			})
			.fail(function (jqXHR, textStatus, errorThrown) {
				// the call failed. Check if layout in LocalStorage
				var strLayout = localStorage["layout" + deviceId];
				if (strLayout && strLayout.length) {
					try {
						localData = JSON.parse(localStorage["layout" + deviceId]);
					} catch (er) {
						console.error("Device.getLayout", er);
					}
				}
				// if localData is valid use it
				if (typeof localData != "undefined") {
					app.getDevice(deviceId).setLayout(localData);
				}
			});
	};

	this.getLEDPin = function () {
		// Returns the `pinNumber` for the built-in LED for this device

		// Need to know the hardware type - from the "name" parameter or "hardware" variable
		if (this.hardware == "esp8266") return 0;

		switch (this.name) {
			case "ArduinoCytron":
				return 13;
				break;
			case "esp8266":
				return 0;
				break;
			default:
				return 1;
		}
	};

	this.getLocalIPFromRemote = function () {
		// Try to get the LocalIP from the Remote address;

		this.hasTestedLocalIPFromRemote = true; // This is to ensure that the test is only performed once
		var address = this.remoteAddress;
		var deviceId = this.id;

		this.getInfo(function (data) {
			try {
				if (typeof data.variables.local_ip != "undefined") {
					var device = app.getDevice(deviceId);
					device.local_ipFromRemote = data.variables.local_ip;
					device.configureAddress();
				}
			} catch (er) {}
		}, address);
	};

	this.getPin = function (pinNameOrNumber) {
		// Redundant function
		// Returns `this.getPinValue()`

		return this.getPinValue(pinNameOrNumber);
	};

	this.getPinFormat = function (pinNumber) {
		return this.pinFormats[pinNumber];
	};

	this.getPinMode = function (pinNumber) {
		return this.pinModes[pinNumber];
	};

	this.getPinLayout = function (pinName) {
		// Returns the pin layout object for `pinName`
		// If a pin name is passed in, this will search for the name in the board layout

		// Check to see if we are using a board Layout
		if (this.layout) {
			// go through inputs and outputs and search for name
			var pins = this.layout.inputs.concat(this.layout.outputs);

			for (var i = 0; i < pins.length; i++) {
				if (pins[i].variable == pinName) {
					// a named pin matches, so use this pin number
					return pins[i];
				}
			}
		}
	};

	this.getPinNumber = function (pinNameOrNumber) {
		// Returns the pin number for `pinNameOrNumber`
		// If a pin name is passed in, this will search for the name in the board layout

		var pinNumber = parseInt(pinNameOrNumber);

		// if pinNameOrNumber is not a pinNumber
		if (pinNameOrNumber != pinNumber) {
			// Check to see if we are using a board Layout
			if (this.layout) {
				// go through inputs and outputs and search for name
				var pins = this.layout.inputs.concat(this.layout.outputs);

				for (var i = 0; i < pins.length; i++) {
					if (pins[i].variable == pinNameOrNumber) {
						// a named pin matches, so use this pin number
						pinNumber = pins[i].pin;

						// Special Case: Analog pins have A0 on pin 40.
						// So you need to subtract 40 from pin number
						if (pins[i].type == "analog" && pinNumber >= 40) {
							pinNumber -= 40;
						}

						// Special Case: D0 mapped to pin 30.
						// So you need to subtract 30 from pin number
						if (pins[i].type == "digital" && pinNumber == 30) {
							pinNumber = 0;
						}
					}
				}
			}
		}

		return pinNumber;
	};

	this.getPinValue = function (pinNameOrNumber) {
		// Returns the value of pin `pinNameOrNumber`
		// If a `name` is passed in, then this device must have a `layout` with a pin named accordingly
		// If  polling has not started, this function starts polling the pin values

		// make sure polling is active
		this.poll();

		// presume a pin number passed in

		var pinLayout = this.getPinLayout(pinNameOrNumber);
		var pinNumber = this.getPinNumber(pinNameOrNumber);

		// no Layout - or invalid pinName, so check to see if it's a pin number
		if (isNaN(pinNumber)) {
			// not a number, do nothing
		} else {
			// return the value saved for this pin
			// Determine A or D
			if (pinLayout) {
				if (pinLayout.type == "analog") {
					return this["A" + pinNumber];
				} else {
					return this["D" + pinNumber];
				}
			} else if (this.getPinFormat(pinNumber) == "a") {
				return this["A" + pinNumber];
			} else {
				return this["D" + pinNumber];
			}
		}

		return null;
	};

	this.getVariable = function (variable, callback) {
		this._ajaxProperties.getVariable.status = 1;
		var that = this;

		jQuery
			.ajaxq(this.id, {
				url: this.address + "/" + variable + "?key=" + this.key,
				timeout: app._ajaxTimeout,
				crossDomain: true,
			})
			.always(function (data) {
				that._ajaxProperties.getVariable.status = 0;
			})
			.done(function (data) {
				callback(data);
			});
	};

	/*
		handleLogoErrors
		If errors passed back from device, save them in this.errors
		After a certain time, clear errors so that device error string doesn't overflow

	*/
	this.handleLogoErrors = function () {
		var now = Date.now();

		try {
			if (
				this.variables.hasOwnProperty("otherObj") &&
				this.variables.otherObj.hasOwnProperty("error") &&
				this.variables.otherObj.error.length
			) {
				var other = this.variables.otherObj;

				// the logo errors are not cleared each time, so might be getting same errors many times
				// make sure that these errors have not been captured yet
				if (JSON.stringify(other.error) == this.logoErrorsCaptured) {
					// do nothing, same error
				} else {
					this.logoErrorsCaptured = JSON.stringify(other.error);
					this.logoErrors = this.logoErrors.concat(other.error);

					// update the gotAt if not set already
					if (this.logoErrorsGotAt == 0) {
						this.logoErrorsGotAt = now;
					}
				}

				// Has the time  come to clear logo errors
				if (now >= this.logoErrorsGotAt + this.logoErrorsClearAfter) {
					this.callFunction("clearErrors", null, function () {
						// onSuccess - reset the status variables
						this.logoErrorsCaptured = "";
						this.logoErrorsGotAt = 0;
					});
				}
			}

			this.updateLogoErrorsStatus();
		} catch (er) {}
	};

	/*
	isAjaxSending
	Returns true if the ajax calls are in a sending state
	`method` Optional - check only one method. Default checks if any method is sending
	*/
	this.isAjaxSending = function (method) {
		if (method && this._ajaxProperties.hasOwnProperty(method)) {
			return this._ajaxProperties[method].status == 1; // return true of status is 1
		}

		// check all methods
		var methods = Object.keys(this._ajaxProperties);
		for (var i = 0; i < methods.length; i++) {
			if (this._ajaxProperties[methods[i]].status == 1) {
				return true;
			}
		}
		return false;
	};

	this.isPending = function (method, pin, state) {
		// Returns true if the `method`,`pin`,`state` combination is pending.

		try {
			return this.pendingMethods[method][pin + "_" + state];
		} catch (er) {}

		// If error then the key does not exist, so pending must be false because the AJAX wasn't started
		return false;
	};

	/*
	logoDisplay
	exp - A string expression that will be converted to a value to display
	*/
	this.logoDisplay = function (exp) {
		// a few fixes to the expression
		var orig = exp;
		orig = orig.replace(/\n/g, "");
		orig = orig.replace(/ /g, "");

		// Save the expression in a list, make sure doesn't exist already
		var allExp = JSON.stringify(this._logoExpressions);
		if (allExp.indexOf('"' + orig + '"') == -1) {
			this._logoExpressions.push(orig);
		}

		// Get all the digital pins
		var exp2 = exp;
		// add spaces around operators
		exp2 = exp2.replace(/([\/\*\+-])/, " $1 ");
		// look for D pins
		var pins = exp2.match(/\bD\d+\b/);
		if (pins && pins.length) {
			for (var i = 0; i < pins.length; i++) {
				var pinNumber = pins[i].replace(/[D\s]/g, "");
				this.setPinMode(pinNumber, "i");
			}
		}
		return this;
	};

	/*
	logoDisplayUpdate
	Update the form fields with the logo expressions and values
	*/
	this.logoDisplayUpdate = function () {
		// only do this if there are expressions and logodisplay fields
		if (
			jQuery(".item.logodisplay input,.item.logodisplay textarea").length ==
				0 ||
			this._logoExpressions.length == 0
		) {
			return this;
		}

		var str = "";
		var expToRemove = []; // if expressions give errors we will remove them

		//jQuery.each(this._logoExpressions, function(i,orig){
		for (var e = 0; e < this._logoExpressions.length; e++) {
			var orig = this._logoExpressions[e];
			var exp = orig;

			// replace all A values
			for (var i = 0; i <= 0; i++) {
				var myRE = new RegExp("A" + i, "gi");
				exp = exp.replace(myRE, this["A" + i]);
			}
			// replace all D values
			for (var i = 0; i <= 8; i++) {
				var myRE = new RegExp("D" + i, "gi");
				exp = exp.replace(myRE, this["D" + i]);
			}
			// replace all DHT values
			for (var i = 0; i <= 8; i++) {
				if (
					this.hasOwnProperty("DHT" + i) &&
					this["DHT" + i].hasOwnProperty("TEMP") &&
					this["DHT" + i].hasOwnProperty("HUM")
				) {
					// use shorthand for temp and hum but allow long with users
					exp = exp.replace(/temperature/i, "TEMP");
					exp = exp.replace(/humidity/i, "HUM");
					exp = exp.replace(/relative_humidity/i, "HUM");
					var myRE = new RegExp("DHT" + i + ".TEMP", "gi");
					exp = exp.replace(myRE, this["DHT" + i]["TEMP"]);
					var myRE = new RegExp("DHT" + i + ".HUM", "gi");
					exp = exp.replace(myRE, this["DHT" + i]["HUM"]);
				}
			}

			var val = "";
			try {
				eval("val = " + exp);
				// check val is a number
				if (isNaN(val)) {
					val = "Not a number";
				} else {
					// round 2 decimal places
					val = parseInt(val * 100) / 100;
				}

				str += orig + " = " + val + "\n";
			} catch (er) {
				expToRemove.push(e);

				if (er.message.match(/Unexpected token ':'/)) {
					//val = "Error: Cannot use variables";
					this.logoErrors.push(["501", orig]);
				} else if (er.message.match(/ReferenceError:/)) {
					this.logoErrors.push(["502", orig]);
					//var msg = er.message.replace(/ReferenceError:/,"");
					//val = "Error: "+msg;
				} else if (er.message.match(/Invalid or unexpected token/)) {
					this.logoErrors.push(["503", orig]);
					//var msg = er.message.replace(/ReferenceError:/,"");
					//val = "Error: "+msg;
				} else {
					this.logoErrors.push(["500", er + " " + orig]);
					//val = "Error: "+er
				}
			}
		}

		// Remove the exp that caused errors
		for (var e = 0; e < expToRemove.length; e++) {
			this._logoExpressions.splice(expToRemove[e], 1);
		}

		// Set the value of any logodisplay input and textarea with the str
		jQuery(".item.logodisplay input,.item.logodisplay textarea").val(str);

		return this;
	};

	this.motionDriving = function (state, settings) {
		// Drive the car using motion control (accelerometer)
		// (Optional) `state` indicates if you are turning Motion Driving on (1) or off (0), Default: `1`
		// (Optional) `settings` passes an object of settings
		// returns `this`

		if (state == null) state = 1;

		// if process not running, start it
		if (this.handler_motionDriving == null) {
			var deviceId = this.id;
			this.handler_motionDriving = setTimeout(function () {
				app.getDevice(deviceId).motionDrivingLoop();
			}, 200);
		}
	};

	this.motionDrivingLoop = function () {
		// run the motion driving process and keep looping

		// calibrate PWM

		// run logo command

		// if process not running, start it
		var deviceId = this.id;
		this.handler_motionDriving = setTimeout(function () {
			app.getDevice(deviceId).motionDrivingLoop();
		}, 200);
	};

	this.motionDrivingSettings = function () {
		// Adjusts the settings for motion driving based on the current device accelration properties

		var dZA = this.deadZoneAdjustment;

		acceleration = app.deviceMotionEvent;

		//document.getElementById("vector").innerHTML ="vector2";
		//acceleration = eventData.accelerationIncludingGravity;
		var left = 0;
		var right = 0;
		if (Math.abs(acceleration.y) > 1) {
			// back-/forward
			var speed = acceleration.y * 100;
			if (acceleration.y > 0) {
				// add 300 to decrease dead zone
				left = Math.min(1023, speed + acceleration.x * 40 + dZA);
				right = Math.min(1023, speed - acceleration.x * 40 + dZA);
			} else {
				left = Math.max(-1023, speed + acceleration.x * 40 - dZA);
				right = Math.max(-1023, speed - acceleration.x * 40 - dZA);
			}
		} else if (Math.abs(acceleration.x) > 1) {
			// circle only
			var speed = Math.min(1023, Math.abs(acceleration.x) * 100);
			if (acceleration.x > 0) {
				left = Math.min(1023, speed + dZA);
				right = Math.max(-1023, -speed - dZA);
			} else {
				left = Math.max(-1023, -speed - dZA);
				right = Math.min(1023, speed + dZA);
			}
		}
		if (Math.abs(left) > 200 || Math.abs(right) > 200) {
			// orig. 100,100
			move_car(left, right);
		}
		var direction = "stop";
		// if direction is opposite, change sign of +left and +right
		var acc_x = Math.round(acceleration.x);
		var acc_y = Math.round(acceleration.y);
		var acc_z = Math.round(acceleration.z);
		var leftD = Math.round(-left);
		var rightD = Math.round(-right);
	};

	this.poll = function () {
		// Starts the polling for this device.
		// Repeatedly updates the pin values for tied pins
		// Returns `this`

		if (!this.pollActive) {
			this.pollActive = true;
			this.pollRepeat();
		}

		var self = this;
		// Check every few seconds to make sure pollRepeat hasn't stalled
		setInterval(function () {
			// If pollRepeat hasn't run in the last while, run it now, it's probably stalled
			var now = Date.now();
			if (now > self.pollStarted + 3500) {
				self.pollRepeat();
			}
		}, 3000);
		return this;
	};

	this.pollRepeat = function () {
		// Runs on a loop, Reads pin values and updates tied variables
		// Returns `null`

		this.pollStarted = Date.now();
		var thisDevice = this;

		// every x seconds tie all pins again (to make sure.. might lose ties if device not connected)
		if (this._lastTieAllPins + 3000 < this.pollStarted) {
			this._lastTieAllPins = this.pollStarted;
			this.tieAllPinsToVariables();
		}

		var fnRelaunch = function () {
			var now = Date.now();
			// Start after pollTimeout.
			var delay = thisDevice.pollStarted + thisDevice.pollTimeout - now;
			// if delay is negative, then timeout expired, so start immediately
			if (delay < 0) {
				delay = 0;
			}

			setTimeout(function () {
				thisDevice.pollRepeat();
			}, delay);
		};

		this.readPins(
			function () {
				// onSuccess
				thisDevice.updateTiedVariables();
				thisDevice.fireEvents();
				//window.appbuilder.events.iot.processPins();

				fnRelaunch();
			},
			function () {
				// onFail
				fnRelaunch();
			}
		);

		return this;
	};

	this.readPins = function (onSuccess, onFail) {
		// Reads all the pins and updates the `device info`
		// Optional `onSuccess` called once the info has been updated
		// Optional `onFail` called if the info can't be updated
		// Returns `this`

		var deviceId = this.id;

		try {
			// if appshed firmware, all pins come back from getInfo
			if (this._appshedFirmware) {
				this.getInfo(onSuccess, null, onFail);
			} else {
				this.readPinsIndividually(onSuccess, onFail);
			}
		} catch (er) {
			if (onFail) {
				onFail();
			}
		}

		return this;
	};

	this.readPinsIndividually = function (onSuccess, onFail) {
		// Read all output pins one after the next, separate AJAX calls
		// This is needed for non-appshed firmware

		// create a list of all the digital and analog pins that must be read
		this._readIndividuallyDigitalQueue = [];
		this._readIndividuallyAnalogQueue = [];

		for (var n = 0; n <= this._maxDigitalPinNum; n++) {
			// Check if the pin mode is input, then add to queue
			if (this.pinModes[n] == "i") {
				this._readIndividuallyDigitalQueue.push("" + n);
			}
		}
		// Analog from 0 - 9
		for (var n = 0; n <= this._maxAnalogPinNum; n++) {
			this._readIndividuallyAnalogQueue.push("" + n);
		}

		// Start the process by calling the function to process the first one in the queue
		this.readPinsIndividuallyNext(onSuccess, onFail);
	};

	this.readPinsIndividuallyNext = function (onSuccess, onFail) {
		// Read the next pin in the queue
		// Once done, call the success/fail methods

		// look in the digital queue
		if (this._readIndividuallyDigitalQueue.length) {
			var n = this._readIndividuallyDigitalQueue.shift();
			var thisId = this.id;
			return this.digitalRead(n, function (data) {
				var d = app.getDevice(thisId);
				// save the value in the device.Dn property
				d["D" + n] = data.return_value;
				d.readPinsIndividuallyNext(onSuccess, onFail);
			});
			// then look in analog queue
		} else if (this._readIndividuallyAnalogQueue.length) {
			var n = this._readIndividuallyAnalogQueue.shift();
			var thisId = this.id;
			return this.analogRead(n, function (data) {
				var d = app.getDevice(thisId);
				// save the value in the device.Dn property
				d["A" + n] = data.return_value;
				d.readPinsIndividuallyNext(onSuccess, onFail);
			});
		} else {
			// we're done, so call success. This should do pollRepeat
			if (onSuccess != null) {
				onSuccess.call();
			}
			// don't know when we would call onFail in this complex scenario
		}
	};

	this.reset = function () {
		// Resets the device

		// Clear logoLoop code
		app.setLogoLoopSettings({
			code: "",
		});

		// reset the device using firmware function
		this.callFunction("reset");

		return this;
	};

	this.restart = function () {
		// Restart the device

		// Clear logoLoop code
		app.setLogoLoopSettings({
			code: "",
		});

		// reset the device using firmware function
		this.callFunction("restart");

		return this;
	};

	this.sendCommands = function (cmds, callback) {
		// Sends the next batch of commands
		// Optional `cmds` arary holds the commands to send, otherwise uses `this.ioBatchCommands`
		// `cmds` expect an array of `command` arrays, where each `command` array contains 4 items: `[format,pin,value,duration]`
		// Optional `callback` is the callback function - this might be called multiple times if the commands are sent in multiple batches.

		var commands;
		if (cmds) commands = cmds;
		else {
			commands = this.ioBatchCommands.slice(); // create a copy of the commands
			this.ioBatchCommands = []; // empty the commands array (so it can be added to again)
		}

		// send up to maxCommandsPerBatch
		var i = 0;
		var params = "";

		while (commands.length && i < this.ioMaxCommandsPerBatch) {
			var next = commands.shift();
			if (params > "") params += ":";
			params += next[0] + "," + next[1] + "," + next[2] + "," + next[3];
			i++;
		}

		this.callFunction("commands", params, callback);

		// If some commands still in the array, send those.
		if (commands.length) return this.sendCommands(commands, callback);

		return this;
	};

	this.setLayout = function (data) {
		// sets the `layout` to `data` (expecting a JSON object)

		this.layout = data;
		return this;
	};

	this.setLED = function (val) {
		// Sets the built-in LED to `val`
		// `val` can be 1/0 or ON/OFF or true/false
		// NB: Setting the LED "ON" in some cases pulls the Pin down (i.e. "OFF")!
		// Returns `this`

		var pinNumber = this.getLEDPin();
		var invert = true; // most boards turn the LED by pulling the pin down.

		if (this.hardware == "arduino") invert = false;

		// Invert the val if required
		if (invert) {
			if (val == 1 || val == true || val == "true" || String(val).match(/on/i))
				val = 0;
			else val = 1;
		}

		this.setPin(pinNumber, val);

		return this;
	};

	/*
	setLogoErrorsStatus
	Optional `options` {
		"msg": "" - message to display
		"status": checkingForErrors || ... - 
	}
	*/
	this.updateLogoErrorsStatus = function (options) {
		var options = options || {};

		// Save status if passed in
		if (options.hasOwnProperty("status")) {
			this._logoErrorStatus = options.status;
		} else {
			// If the status is something, e.g. "checkingForErrors", but this was not passed in options, then it was passed in previously. So this time we can reset status. i.e. it only stays at that status for one cycle
			if (this._logoErrorStatus > "") {
				this._logoErrorStatus = "";
			}
		}

		// Update logocodestatus elements on the screen
		// Look for logocodestatus class
		jQuery(".logocodestatus").each(function () {
			// Add the text div if not present
			if (!jQuery(this).find(".logocodestatustext").length) {
				jQuery(this).append('<div class="logocodestatustext"></div>');
			}
		});

		// update the message
		var msg = "";

		// If there is no special status
		if (this._logoErrorStatus == "") {
			var num = this.logoErrors.length;
			if (num > 0) {
				msg =
					this.logoErrors.length +
					" error" +
					(num > 1 ? "s" : "") +
					" (more info)";
				jQuery(".logocodestatus .logocodestatustext").addClass("haserrors");
			} else {
				// no errors
				msg = "No errors";
				jQuery(".logocodestatus .logocodestatustext").removeClass("haserrors");
			}
		}

		// Override msg?
		if (options.hasOwnProperty("msg")) {
			msg = options.msg;
		}

		// Update the UI
		if (msg > "") {
			jQuery(".logocodestatus .logocodestatustext").html(msg);
		}
		jQuery(".logocodestatus .logocodestatustext").click(function () {
			app.showStatusMessage({ panel: "CodeErrors" });
		});
	};

	this.setMotorDriver = function (type, callback) {
		// Sets the Motor Driver to `type`;
		// Options are:
		//   `0` (default) Motor Shield
		//   `1` L298N
		//   `2` L9110

		return this.callFunction("setMotorDriver", type, callback);
	};

	this.setPending = function (method, pin, state) {
		// Sets a flag to indicate that a `method`,`pin`,`state` combination is pending (i.e. the AJAX request is running)
		// This is used to stop duplicate requests being sent continuously thereby overloading the device
		// `method` must be one of:
		// * `analogRead`
		// * `analogWrite`
		// * `digitalRead`
		// * `digitalWrite`
		// Return `this`

		// Create a key using pin_state
		this.pendingMethods[method][pin + "_" + state] = true;

		return this;
	};

	this.setPin = function (pinNameOrNumber, val) {
		// Sets the pin number `pinNameOrNumber` to `val`
		// Returns `this`

		// presume a pin number passed in

		var pinNumber = this.getPinNumber(pinNameOrNumber);

		// no Layout - or invalid pinName, so check to see if it's a pin number
		if (isNaN(pinNumber)) {
			// not a number, do nothing
		} else {
			// Save this as the lastSetPinValue

			// if val is boolean then use digital output
			if (val == true || val == "true" || String(val).match(/on/i)) {
				this.digitalWrite(pinNumber, 1);
				this.lastSetPinValue[pinNumber] = true;
			} else if (val == false || val == "false" || String(val).match(/of/i)) {
				this.digitalWrite(pinNumber, 0);
				this.lastSetPinValue[pinNumber] = false;
			} else if (val == 1 || val == 0) {
				// special case: 1/0 might be digital or analog.
				// Presume digital unless analog specified.
				if (this.getPinFormat(pinNumber) == "a") {
					this.analogWrite(pinNumber, val);
					this.lastSetPinValue[pinNumber] = val;
				} else {
					this.digitalWrite(pinNumber, val);
					if (val == 1) {
						this.lastSetPinValue[pinNumber] = true;
					} else {
						this.lastSetPinValue[pinNumber] = false;
					}
				}
			} else {
				// everything else presume analog
				this.analogWrite(pinNumber, val);
				this.lastSetPinValue[pinNumber] = val;
			}
		}
		return this;
	};

	this.setPinFormat = function (pinNumber, format) {
		// Sets the format of `pinNumber` to `format`
		// `format` must be either `d` for digital or `a` for analog

		this.pinFormats[pinNumber] = format;
		return this;
	};

	this.setPinMode = function (pin, state) {
		// Set the mode of `pin` to `state`
		// `state` must be either `i` for input or `o` for output.

		if (typeof pin == "unedfined" || typeof state == "undefined") {
			return;
		}

		// Skip the AJAX call if already set
		if (this.pinModes[pin] == state) {
			return this;
		}

		this.pinModes[pin] = state;
		var deviceId = this.id;
		this._ajaxProperties.setPinMode.status = 1;
		var that = this;
		var aURL = this.address + "/mode/" + pin + "/" + state + "?key=" + this.key; // was that.getGPIO(pin) aREST no longer uses GPIO

		jQuery
			.ajaxq(this.id, {
				url: aURL,
				timeout: app._ajaxTimeout,
				crossDomain: true,
			})
			.always(function (data, textStatus, jqXHR) {
				that._ajaxProperties.setPinMode.status = 0;
			})
			.done(function (data) {
				var device = app.getDevice(deviceId);
				device.pinModes[pin] = state;

				// If all variables tied to pins, then tie this if input
				if (device.tiePinsToVariables && state == "i") {
					device.tie(pin, pin); // use the pin number as the name of the variable
					device.poll(pin);
				}
			});

		return this;
	};

	this.setRGB = function (color, pins) {
		// Sets an RGB LED to `color`
		// Optional `pins`  specifies the pins to use, default is 5,6,7 for r,g,b
		// `color` can be a HEX color or an object with properties `r,g,b` specifying a value 0-255
		// `pins` is an object with properties `r,g,b` specifying the pin numbers
		// returns `this`

		if (typeof color == "string") color = app.toRGB(color);

		if (!pins)
			pins = {
				r: 5,
				g: 6,
				b: 7,
			};

		this.analogWrite(pins.r, color.r);
		this.analogWrite(pins.g, color.g);
		this.analogWrite(pins.b, color.b);

		return this;
	};

	this.testLocalIP = function (fromRemote) {
		// Tests `this.local_ip` to determine if the app can use it instead of the Remote address
		// Optional: If `fromRemote` is true it will test `this.local_ipFromRemote`
		// Returns `this`

		if (fromRemote) {
			// If already testing, return
			if (this.isTestingLocalIPFromRemote) return;
			this.isTestingLocalIPFromRemote = true;
			this.isValidLocalIPFromRemote = false;
		} else {
			if (this.isTestingLocalIP) {
				return;
			}
			this.isTestingLocalIP = true;
			this.isValidLocalIP = false;
		}

		var originalID = this.id;

		var testIP = this.variables.local_ip;
		if (fromRemote) testIP = this.local_ipFromRemote;

		// Query the IP and see if it is valid
		this.getInfo(function (data) {
			// If the device is connected to over local network, the id will be "local"
			if (data.id == originalID || data.id == "local") {
				if (fromRemote) {
					app.getDevice(originalID).isValidLocalIPFromRemote = true;
				} else {
					app.getDevice(originalID).isValidLocalIP = true;
				}

				app.getDevice(originalID).configureAddress();
			}
		}, testIP);

		return this;
	};

	this.tie = function (pinNameOrNumber, variable, obj) {
		// Ties the pin `pinNameOrNumber` to a `variable`
		// The variable is updated every time the pin is polled
		// Optional obj is the _pinVariables object {format, pinNumber, property}
		// Returns `this`

		// presume a pin number passed in

		var pinNumber = null;
		var input = {}; // a JSON object with the input data
		var obj = obj || {};

		// if pinNameOrNumber is a number, use that
		if (parseInt(pinNameOrNumber) == pinNameOrNumber) {
			pinNumber = parseInt(pinNameOrNumber);
		} else {
			// Check to see if we are using a board Layout
			if (this.layout) {
				// go through inputs and search for name
				var inputs = this.layout.inputs;

				for (var i = 0; i < inputs.length; i++) {
					// if we don't have a pinNumber, try match the variable
					// otherwise look for the pin number
					if (isNaN(pinNumber)) {
						if (inputs[i].variable == pinNameOrNumber) {
							// a named pin matches, so use this pin number
							pinNumber = inputs[i].pin;
							input = inputs[i];
						}
					} else {
						if (inputs[i].pin == pinNumber) {
							// pin number matches, so use this pin for the input
							input = inputs[i];
						}
					}
				}
			}
		}

		// no Layout - or invalid pinName, so check to see if it's a pin number
		if (isNaN(pinNumber)) {
			// not a number, do nothing
		} else {
			// mark this pin as an input (for analog and digital. DHT is handled with attachDHT)
			if (obj && obj.format == "dht") {
				this.callFunction("attachDHT", pinNumber + ",0"); // pass pin,type (type 0 = DHT11)
			} else {
				this.setPinMode(pinNumber, "i");
			}

			var exists = false;

			// Check if any ties yet for this pin
			if (!this.pinVariableTies.hasOwnProperty(pinNumber)) {
				// create an array for this pinNumber. There might be a few variables tied to the same pin
				this.pinVariableTies[pinNumber] = [];
			} else {
				// check if this appVariable already tied, then skip
				// each pin can have multiple variables tied
				for (var p = 0; p < this.pinVariableTies[pinNumber].length; p++) {
					if (this.pinVariableTies[pinNumber][p].appVariable == variable) {
						exists = true;
					}
				}
			}

			if (!exists) {
				// save the app variable name on the input and set it to the variable
				input.appVariable = variable;

				// add the input to the array of ties
				this.pinVariableTies[pinNumber].push(input);
				this.poll();
			}
		}
		return this;
	};

	this.tieAllPinsToVariables = function () {
		// Ties all input pins to variables by the same name
		// Either uses a board-layout linked to the device (to determine which pins are inputs)
		// Also Naming Convention pins: allows you to name variables using the `pin+[D/A]+n`, e.g. pinD3 or pinA0
		// Allows for easy moniotring of pins: simply create form fields (variables) with the same names as the pins
		// Returns `this`

		this.tiePinsToVariables = true; // remember this setting, might need to tie later (e.g. in setPinMode())

		if (this.layout) {
			// go through inputs
			var inputs = this.layout.inputs;

			for (var i = 0; i < inputs.length; i++) {
				// TODO need to check if this is analog, and add 40
				this.tie(inputs[i].pin, inputs[i].variable);
			}
		}

		// go through all variables matching naming convention
		var self = this;
		jQuery.each(app._pinVariables, function (variable, obj) {
			// obj will have properties for format and pinNumber
			// if it's analog, add 40 to the pinNumber (A0 == 40)
			var num = obj.pinNumber;
			if (obj.format == "a") {
				num += 40;
			}
			self.tie(num, variable, obj);
		});

		return this;
	};

	this.togglePin = function (pinNameOrNumber) {
		var pinNumber = this.getPinNumber(pinNameOrNumber);

		try {
			if (this.lastSetPinValue[pinNumber] == 1)
				return this.setPin(pinNumber, 0);
			else if (
				!this.lastSetPinValue[pinNumber] ||
				this.lastSetPinValue[pinNumber] == 0
			)
				return this.setPin(pinNumber, 1);
			else return null;
		} catch (er) {}
	};

	this.toString = function () {
		return JSON.stringify({
			id: this.id,
			name: this.name,
			hardware: this.hardware,
			connected: this.connected,
			variables: this.variables,
		});
	};

	this.updateHistory = function (
		deviceId,
		address,
		returnMethod,
		data,
		textStatus,
		jqXHR,
		errorThrown
	) {
		// Updates the local storage history
		// returnMethod: done | fail

		// identifier e.g. "local_http192_168_4_1"
		var identifier = String(app.device.id + "_" + app.device.address)
			.replace(/\./g, "_")
			.replace(/[^\d\w_]/g, "");

		// Save WiFiIP in localStorage
		try {
			if (
				returnMethod == "done" &&
				data.connected &&
				data.variables.WiFiIP > ""
			) {
				if (localStorage.hasOwnProperty("deviceWiFiIPs")) {
					// array of ip addresses
					deviceWiFiIPs = JSON.parse(localStorage["deviceWiFiIPs"]);
					// if this ip not present, then add it
					if (jQuery.inArray(data.variables.WiFiIP, deviceWiFiIPs) === -1) {
						//if (data.variables.WiFiIP != deviceWiFiIPs[deviceWiFiIPs.length-1]){
						deviceWiFiIPs.push(data.variables.WiFiIP);
						localStorage["deviceWiFiIPs"] = JSON.stringify(deviceWiFiIPs);
					}
				} else {
					localStorage["deviceWiFiIPs"] = JSON.stringify([
						data.variables.WiFiIP + "",
					]);
				}
			}
		} catch (er) {}

		return this;
	};

	this.updateInfo = function (data) {
		// Update the basic Info of the device using `data`

		if (data) {
			if (data.name) this.name = data.name;
			if (data.connected) this.connected = data.connected;
			if (data.hardware) this.hardware = data.hardware;
			if (data.variables) {
				// update any variables that are in data

				var keys = Object.keys(data.variables);
				for (var k = 0; k < keys.length; k++) {
					this.variables[keys[k]] = data.variables[keys[k]];
				}

				// look for the variables.build. If not found, then this is probably the aREST sketch which doesn't support _ioBatchMode
				if (!data.variables.hasOwnProperty("build")) {
					this.ioBatchMode = false;
					// if no build, presume it's a not appshed firmware
					this._appshedFirmware = false;
				}

				//this.variables = data.variables; // this line overwrites good keys in variables not passed in data
				// A0.... analog values
				if (data.variables.analogValues) {
					//this.A0 = parseInt(data.variables.analogValues)
					var vals = data.variables.analogValues.split(",");
					for (var i = 0; i < vals.length; i++) {
						try {
							this["A" + i] = parseInt(vals[i]);
						} catch (er) {}
					}
				}
				// D0... digital values
				if (data.variables.digitalValues) {
					var vals = data.variables.digitalValues.split(",");
					for (var i = 0; i < vals.length; i++) {
						try {
							this["D" + i] = parseInt(vals[i]);
						} catch (er) {}
					}
				}

				// handle "other"
				// other is a stringify json
				this.variables.otherObj = {};

				if (data && data.variables && data.variables.other) {
					var str = String(data.variables.other);
					// fix format of string to make valid JSON
					// put error value into array
					var errStr = str.replace(/.*?\"error\": (.*)?}/, "$1");
					errStr = errStr.replace(/\'/g, '"');
					str = str.replace(/\"error\": (.*)?}/, '"error": [' + errStr + "]}");

					// might be malformed
					try {
						this.variables.otherObj = JSON.parse(str);

						// DHT0... DHT values
						if (
							this.variables.otherObj &&
							this.variables.otherObj.hasOwnProperty("dht")
						) {
							var that = this;
							jQuery.each(this.variables.otherObj.dht, function (key, dhtObj) {
								try {
									// Add an object to the device for each DHT with TEMP and HUM
									// e.g. devive.DHT1.TEMP
									that[key] = {};
									that[key].TEMP = dhtObj.temperature;
									that[key].HUM = dhtObj.relative_humidity;
								} catch (er) {
									console.error("device.updateInfo DHT", key, er);
								}
							});
						}
					} catch (er) {
						console.error("device.updateInfo otherObj", str, er);
					}
				}

				// handle logoErrors
				this.handleLogoErrors();
			}

			// Special cases (These might be passed in props when instantiating)
			if (data.local_ip) {
				this.variables.local_ip = data.local_ip;
			}
			if (data.isValidLocalIP) {
				this.isValidLocalIP = data.isValidLocalIP;
			}

			// Might need to update logodisplay
			this.logoDisplayUpdate();
		}

		return this;
	};

	this.updateProperties = function (props) {
		var addressChanges = false;
		var layoutChanges = false;

		// has the localIP changed?
		if (
			typeof props.local_ip == "string" &&
			(!this.variables.local_ip || this.variables.local_ip != props.local_ip) &&
			!props.isValidLocalIP
		) {
			// save the local_ip in variables
			this.variables.local_ip = props.local_ip;
			this.isTestingLocalIP = false;
			this.isValidLocalIP = false;
			addressChanges = true;
		}

		// has the layout changed
		if (
			(props.layoutId && props.layoutID != this.properties.layoutId) ||
			!props.layoutId ||
			props.layoutId == ""
		)
			layoutChanges = true;

		// update each property using values passed in
		for (var k in props) {
			this.properties[k] = props[k];
		}

		if (props.key) this.key = props.key;
		this.updateRemoteAddress();

		if (addressChanges) this.configureAddress();

		if (layoutChanges) this.configureLayout();

		return this;
	};

	this.updateRemoteAddress = function () {
		var protocol = "http";
		if (window && window.location && window.location.protocol) {
			protocol = window.location.protocol;
		}

		this.remoteAddress =
			protocol + "//cors.appshed.com/?u=https://cloud.arest.io/" + this.id;
		if (this.key)
			this.remoteAddress =
				protocol + "//cors.appshed.com/?u=https://pro.arest.io/" + this.id;

		return this;
	};

	/*
	updateStatusIndicator
	If this is the default device, update the statusIndocator to show current status
	If Ajax busy sending, flash blue/gree
	*/
	this.updateStatusIndicator = function () {
		// only change the indicator if this is the default device
		if (app._defaultDevice == this.id) {
			var sI = jQuery("#statusIndicator .symbol");

			// flash the indicator
			if (this.isAjaxSending()) {
				// consecutively add/remove the sending class
				if (sI.hasClass("sending")) {
					sI.removeClass("sending");
				} else {
					sI.addClass("sending");
				}

				// On Settings panel, show/hide sending
				jQuery("#logMessages div._settingsDeviceDetails_sending").css(
					"visibility",
					"visible"
				);
			} else {
				// not sending so remove class
				sI.removeClass("sending");

				jQuery("#logMessages div._settingsDeviceDetails_sending").css(
					"visibility",
					"hidden"
				);
			}
		}
	};

	this.updateTiedVariables = function () {
		// Update all variables tied to pins with the latest pin value
		// Return `this`

		var self = this;

		jQuery.each(this.pinVariableTies, function (pin, arr) {
			// each pin has an array of ties
			jQuery.each(arr, function (i, input) {
				// for each variable tied...
				try {
					var pinNumber = parseInt(pin);
					var prefix = "D";
					var setPin = pinNumber;

					// remap pinNumbers

					// special case for IoT Builder which uses 30 for pin 0
					if (pinNumber == 30) {
						setPin = 0;
					}
					// analog pins are 40...46 , matching A0...A6
					if (pinNumber >= 40) {
						setPin = pinNumber - 40;
						prefix = "A";
					}

					// Board layout identifies this as analog
					if (input.type == "analog") {
						prefix = "A";
					}

					// We are expecting the device to have pin values as properties, e.g. device.D4
					app.setVariable(input.appVariable, self[prefix + setPin]);
				} catch (er) {
					console.error("ERROR device.updateTiedVariables", er);
				}
			});
		});

		/* 
			Old code
			
			for(var p=0;p<this._maxPins;p++){
				var pinNumber = p;


				if(this.pinVariableTies[p] && this.pinVariableTies[p].length){
					for(var i=0;i<this.pinVariableTies[p].length;i++){
						try{
							var input = this.pinVariableTies[p][i];
							var prefix = "D";
	
							// remap pinNumbers
							if(pinNumber == 30){
								pinNumber = 0;
							}
							if(pinNumber >= 40){
								pinNumber = p-40; // analog pins are 40...46 , matching A0...A6
							}
	
							if(input.type == "analog"){
								prefix = "A";
							}
							app.setVariable(input.appVariable,this[prefix+pinNumber]);
						}catch(er){}
					}
				}
				
			}
			*/

		return this;
	};

	// ************************************************************
	// We must call init() on the Device
	// ************************************************************
	this.init();
} // END Device Object

/* 
========================================================================================================
        Data object Data Class
========================================================================================================
*/

/*
Data Table concept 

Using https://bossanova.uk/jspreadsheet/v4/

*/
function jspreadsheet() {
	jQuery("#spreadsheet2-container").remove();
	jQuery(
		'<div class="item html" id="spreadsheet2-container"><div class="data-loading" style="position: relative;     width: 100%;      height: 100px;     background-color: rgba(255, 255, 255); ">      <div style="     width: 50%;     margin: 0 auto;     /* opacity: 1; */     height: 100%;     text-align: center;     margin-top: 50px; ">                     <i style="       zoom: 2;     opacity: 1; " class="icon-spinner icon-spin "></i>          </div>     </div><div class="html" id="spreadsheet2"></div></div>'
	).appendTo(".app .screen .items-inner");

	app.loadScript(
		"https://bossanova.uk/jspreadsheet/v4/jexcel.js",
		function () {
			app.loadScript(
				"https://bossanova.uk/jspreadsheet/v4/jexcel.css",
				function () {
					app.loadScript(
						"https://jsuites.net/v4/jsuites.js",
						function () {
							app.loadScript(
								"https://jsuites.net/v4/jsuites.css",
								function () {
									jQuery
										.ajax(
											"https://cors.appshed.com/?u=https://data.appshed.com/api.php/records/games"
										)
										.done((a, b, c) => {
											jQuery("#spreadsheet2-container .data-loading").hide();
											jspreadsheet(document.getElementById("spreadsheet2"), {
												data: a.records,
												columns: [
													{ type: "text", width: 100 },
													{ type: "text", width: 100 },
													{ type: "text", width: 100 },
													{ type: "text", width: 100 },
													{ type: "text", width: 100 },
												],
											});
										});
								},
								"css"
							);
						},
						"script"
					);
				},
				"css"
			);
		},
		"script"
	);
} // END jspreadshett

function AppShedData(idOrClassName, options) {
	// Class definition for Data Object Data Class
	// Optional `idOrClassName` specifies which data to retrieve
	// Defaults to the data on the current screen.
	// Optional `options` - an object
	// 		{isAppData: <boolean> if true this is app data not screen data}
	// Could use data.appshed.com   https://github.com/mevdschee/php-crud-api or sql-stprage extension https://storage-extension.appshed.com/

	this.idOrClassName = idOrClassName;
	this.options = options || {};
	this.type = "Data Object";
	this.emailKey = "43kjbv934kjds9fwf34erf098uerj8nj63no7r94m4773jk"; // secret key to avoid abuse of the email service

	this.avg = function (variable) {
		// Return the average of the values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.avg(this.getNumbers(variable));
	};

	this.clearData = function () {
		// Clears the data
		// returns `bool true` if successful

		return this.getScreen().setLocalProperty("data", []);
	};

	this.count = function (variable, notEmpty) {
		// Return the count of values for `variable`
		// Optional `bool notEmpty` specifies that only non-empty values should be counted
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		var count = 0;
		this.rows().forEach(function (el) {
			if (notEmpty) {
				if (el[variable] > "") count++;
			} else count++;
		});
		return count;
	};

	this.countNumbers = function (variable) {
		// Return the count of numeric values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return this.getNumbers(variable).length;
	};

	this.email = function (to, from, subject, body, arg_callback) {
		// Email the data on the current `Screen`
		// Optional arguments `to,from,subject,body,callback`
		// It is also possible to pass in form fields for `to,from,subject,body`
		// Form fields will take precedence over arguments for `to,from,subject,body`
		// Overload: the callback function can be passed as any of the arguments
		// e.g. email('to',callback) is valid

		var callback;
		var fieldData = "";

		if (typeof to == "function") {
			callback = to;
			to = "";
		}
		if (typeof from == "function") {
			callback = from;
			from = "";
		}
		if (typeof subject == "function") {
			callback = subject;
			subject = "";
		}
		if (typeof body == "function") {
			callback = body;
			body = "";
		}
		if (typeof arg_callback == "function") callback = arg_callback;

		app.showLoader(10000);

		var fData = new FormData();

		// Add the email Key
		fData.append("key", this.emailKey);

		// look for input (text, checkbox, radio), textarea , .item.select .selected, .item.picker .picked
		jQuery(app._formItemsCSSSelector).each(function (index) {
			var el = this;
			var data = app.getVariable(el.dataset.variable);

			try {
				if (el.type == "file") {
					data = el.files[0];
					fData.append(el.dataset.variable, data);
				}

				fieldData += el.dataset.variable + " = " + data + "\n";

				// Check the arguments and override with form data if present
				if (el.dataset.variable == "to" && data > "")
					to = data + (to ? "," + to : "");
				if (el.dataset.variable == "from" && data > "")
					from = data + (from ? "," + from : "");
				if (el.dataset.variable == "subject" && data > "")
					subject = data + (subject ? " " + subject : "");
				if (el.dataset.variable == "body" && data > "")
					body = data + (body ? " " + body : "");
			} catch (er) {}
		});

		fieldData =
			"\n\n\n__________________________\n\nForm Fields\n__________________________\n\n" +
			fieldData;

		// add the arguments
		fData.append("to", to ? to : "");
		fData.append("from", from ? from : "");
		fData.append("subject", subject ? subject : "");
		fData.append("body", (body ? body : "") + fieldData);

		jQuery
			.ajax({
				url: "https://appshed.us/extensions/email/send.php", // Url to which the request is send
				type: "POST", // Type of request to be send, called as method
				data: fData,
				contentType: false, // The content type used when sending data to the server.
				cache: false, // To unable request pages to be cached
				processData: false, // To send DOMDocument or non processed data file it is set to false
			})
			.done(function (data) {})
			.always(function (data) {
				if (callback) {
					callback(data);
				}
				app.hideLoader();
			});
	};

	this.emailData = function (to, from, subject, body, arg_callback) {
		// Email all the saved data

		var data = this.rows();

		var body =
			"\n__________________________\n\nSaved Data\n__________________________\n\n";

		for (var i = 0; i < data.length; i++) {
			var keys = Object.keys(data[i]);
			body += "\n\n" + (i + 1) + ":\n\n";
			for (var k = 0; k < keys.length; k++) {
				body += keys[k] + " = " + data[i][keys[k]] + "\n";
			}
		}

		return this.email(to, from, subject, body, arg_callback);
	};

	this.getFirstVariable = function () {
		// Return the name of the first `variable` in the data
		// If there is no saved data, it will return null

		return this.getVariables()[0];
	};

	this.getNumbers = function (variable) {
		// Return an array of the numeric values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		var arr = [];

		this.rows().forEach(function (el) {
			if (!isNaN(el[variable]) && String(el[variable]).length > 0)
				arr.push(Number(el[variable]));
		});

		return arr;
	};

	this.getScreen = function () {
		// Returns the `Screen` for this data
		// Defaults to the current screen

		return app.getScreen(this.idOrClassName);
	};

	this.getValues = function (variable) {
		// Return an array of the values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		var arr = [];

		this.rows().forEach(function (el) {
			arr.push(el[variable]);
		});

		return arr;
	};

	this.getVariables = function () {
		// Returns an array of `variables` in the data

		var variables = [];

		this.rows().forEach(function (el) {
			variables = variables.concat(Object.keys(el));
		});

		// get unique variable names
		variables = variables.filter(function (value, index, self) {
			return self.indexOf(value) === index;
		});

		return variables;
	};

	this.hideData = function () {
		// Hide the data that was shown with `showData()`
		// Returns `this`

		var scn = this.getScreen();

		if (jQuery("#data-" + scn.id).length) jQuery("#data-" + scn.id).remove();

		return this;
	};

	this.insert = function (thisData) {
		// Saves the provided `thisData`
		// `thisData` can be an array (of data objects) or a single data object
		// The format of the data object is:
		// {
		//		variable1: value1,
		//		variable2: value2,
		//		...
		//	}
		// Example as an array:
		// 		[{dataobject1},{dataobject2},...]
		// This function allows for programatic insertion of data, as opposed to this.save() which saves form input.
		// Returns `this`

		data = this.rows();

		if (Array.isArray(thisData)) {
			for (var i = 0; i < thisData.length; i++) data.push(thisData[i]);
		} else {
			data.push(thisData);
		}

		//this.getScreen().setLocalProperty("data",data);
		this.setLocalData(data);

		return this;
	};

	this.max = function (variable) {
		// Return the maximum value for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.max(this.getNumbers(variable));
	};

	this.meanAbsoluteDeviation = function (variable) {
		// Return the standardDeviation of the values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.meanAbsoluteDeviation(this.getNumbers(variable));
	};

	this.median = function (variable) {
		// Return the median value for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.median(this.getNumbers(variable));
	};

	this.midrange = function (variable) {
		// Return the midrange  for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.midrange(this.getNumbers(variable));
	};

	this.min = function (variable) {
		// Return the minimum value for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.min(this.getNumbers(variable));
	};

	this.modes = function (variable) {
		// Return an array providing the modes for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.modes(this.getNumbers(variable));
	};

	this.removeVariable = function (variable) {
		// Removes all the data for `variable` from localStorage
		// Returns `this`

		var data = this.rows();
		var newData = data.map(function (thisObj) {
			try {
				delete thisObj[variable];
				return thisObj;
			} catch (er) {}
		});

		this.getScreen().setLocalProperty("data", newData);

		return this;
	};

	this.range = function (variable) {
		// Return the range for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.range(this.getNumbers(variable));
	};

	this.getLocalData = function () {
		// Returns the data JSON object
		// The source differes if this is app data or screen data

		var data;
		if (this.options && this.options.isAppData) {
			data = app.getLocalData(this.idOrClassName);
		} else {
			data = this.getScreen().getLocalProperty("data");
		}

		return data;
	};

	this.setLocalData = function (data) {
		// Sets the data JSON object
		// The destination differes if this is app data or screen data

		if (this.options && this.options.isAppData) {
			app.setLocalData(this.idOrClassName, data);
		} else {
			this.getScreen().setLocalProperty("data", data);
		}

		return data;
	};

	this.rows = function (selectors, filters) {
		// Returns the saved data as an array of objects
		// Format:
		//	[
		//	  {
		//		variable1: "value1",
		//		variable2: "value2",
		//		...
		//	  },
		//	  ...
		//	]
		// Optional `selectors` is an array of variable names to be included in the returned data
		//   Example: `["textbox","number"]`
		// Optional `filters` specifies any filter criteria
		// `filters` is an array of filter objects in the format:
		//   [
		//      {
		//			variable: "name", 	// the variable to apply the filter on
		//			comparison: "==,!=,<>,>,<,>=,<=",
		//			value: "xxx",		// alphanumeric value
		//			logic: "AND|OR"		// optional, determines how to join multiple filters
		//		}
		//   ]
		// Example: `filters' = [{variable:"textbox",comparison:"!=",value:"some text", logic:"AND"},{variable:"number",comparison:"="}]

		// Get the data from the screen or app localstorage

		/*
		var data;
		if(this.options && this.options.isAppData){
			data = app.getLocalProperty("datasets")[this.idOrClassName];
		}else{
			data = this.getScreen().getLocalProperty("data");
		}
		*/
		var data = this.getLocalData();

		// Get Selectors from the current Item
		if (!selectors) selectors = [];
		try {
			jQuery("#data_select" + app._currentItemId + " input").each(function () {
				// remove "data_select_variable_" from the input name
				if (this.checked)
					selectors.push(this.name.replace(/data_select_variable_/, ""));
			});
		} catch (er) {}

		// If the current Item is a `data_filter` then add the filter conditions
		try {
			if (app.getItem().containsClass("data_filter")) {
				var variable = jQuery(
					"#item" + app._currentItemId + " .data_filter_variable select"
				).val();
				var comparison = jQuery(
					"#item" + app._currentItemId + " .data_filter_comparison select"
				).val();
				var value = jQuery(
					"#item" + app._currentItemId + " .data_filter_value input"
				).val();

				if (variable > "" && comparison > "") {
					if (!filters) filters = [];

					filters.push({
						variable: variable,
						comparison: comparison,
						value: value,
					});
				}
			}
		} catch (er) {}

		if (filters) {
			for (var f = 0; f < filters.length; f++) {
				var filter = filters[f];

				// Create an array of data conforming to this filter
				var filteredData = [];

				for (var i = 0; i < data.length; i++) {
					// find out which variable this filter applies to
					var vars = Object.keys(data[i]);
					var index = vars.indexOf(filter.variable);

					if (index != -1) {
						var result;
						var str;
						// fix single =
						if (filter.comparison == "=") filter.comparison = "==";

						if (isNaN(data[i][vars[index]]) || isNaN(filter.value))
							str =
								"result = ('" +
								data[i][vars[index]] +
								"' " +
								filter.comparison +
								" '" +
								filter.value +
								"')";
						else
							str =
								"result = (" +
								data[i][vars[index]] +
								" " +
								filter.comparison +
								" " +
								filter.value +
								")";

						try {
							eval(str);
						} catch (er) {
							app.handleError(er, "Data.rows eval filter " + str);
						}
						if (result) {
							filteredData.push(data[i]);
						}
					}
				}

				// replace the data with this data (presume AND join)
				data = filteredData;
			}
		}

		// Selectors
		var selectedData = data;

		if (selectors && selectors.length) {
			for (var i = 0; i < selectedData.length; i++) {
				var keys = Object.keys(selectedData[i]);
				for (var k = 0; k < keys.length; k++) {
					// delete the key if not in selectors
					if (selectors.indexOf(keys[k]) == -1) delete selectedData[i][keys[k]];
				}
			}
		}

		return selectedData;
	};

	this.save = function () {
		// Save the data
		// Returns `this`

		data = this.rows();

		var thisData = {};

		// go through all Form items
		jQuery(app._formItemsCSSSelector).each(function (index) {
			// If there is no dataset.variable, it is not an Item so skip
			if (this.dataset.variable && this.dataset.variable != "undefined")
				thisData[this.dataset.variable] = app.getVariable(
					this.dataset.variable
				);
		});

		// Special Case: any variable starting with "data_" has special meaning
		try {
			for (var key in thisData) {
				if (thisData.hasOwnProperty(key) && key.match(/^data_/)) {
					var name = key;
					var val = thisData[key];

					// Remove this key
					delete thisData[key];

					try {
						// Calculations

						if (name.match(/^data_calculation_/)) {
							// the name of the field follows `data_calculation_`
							name = name.replace(/^data_calculation_/, "");
							var formula = val;

							// the formula is saved in the `val`
							// remove the arithmetic operators to get a list of variables
							var variables = formula.replace(/[+\-*/%() ]/g, ",").split(",");

							// repalce all variables in the formula with values from the other fields
							for (var k in thisData) {
								if (
									thisData.hasOwnProperty(k) &&
									!k.match(/^data_/) &&
									!isNaN(thisData[k])
								) {
									// if k appears in the formula, replace all occurences with the numeric value
									if (variables.indexOf(k) != -1) {
										var thisVal = parseFloat(thisData[k]);
										var myRE = new RegExp(k, "g");

										formula = formula.replace(myRE, thisVal);
									}
								}
							}

							// Now try evaluate the formula
							try {
								var outcome;
								eval("outcome = " + formula);
								if (!isNaN(outcome)) thisData[name] = outcome;
							} catch (er) {}
						}
					} catch (er) {
						//
					}
				}
			}
		} catch (er) {
			app.handleError(er, "data.save() data_");
		}

		// Add thisData to the saved data
		data.push(thisData);
		this.getScreen().setLocalProperty("data", data);

		return this;
	};

	this.showData = function (selectors, filters, idOrClassName) {
		// Shows the data in an HTML table on the screen.
		// Optional `selectors` is an array of variable names to be shown (Default all)
		// Optional `filters` applies conditions to filter the data (see this.rows() for details on filters)
		// Optional `idOrClassName` identifies the attachment item (default to current Item)
		// Returns `this`

		var scn = this.getScreen();

		if (jQuery("#data-" + scn.id).length) jQuery("#data-" + scn.id).remove();

		var div = document.createElement("div");
		div.id = "data-" + scn.id;
		div.className = "datatable";
		div.appendChild(this._htmlBuildTable(this.rows(selectors, filters)));
		div.style += "; overflow: scroll; ";

		try {
			jQuery("#" + app.getItem(idOrClassName).domId).after(div);
		} catch (er) {
			app.handleError(er, "Data.showData() jQuery.after()");
		}

		app.refreshScroll();
	};

	this.standardDeviation = function (variable) {
		// Return the standardDeviation of the values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.standardDeviation(this.getNumbers(variable));
	};

	this.sum = function (variable) {
		// Return the sum of the values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.sum(this.getNumbers(variable));
	};

	this.variance = function (variable) {
		// Return the variance of the values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.variance(this.getNumbers(variable));
	};

	this.zScores = function (variable) {
		// Return an array of zScores for the values for `variable`
		// If `variable` not passed in use the first column

		variable = variable || this.getFirstVariable();
		if (!variable) return null;

		return app.stats.zScores(this.getNumbers(variable));
	};

	// Builds the HTML Table
	this._htmlBuildTable = function (arr) {
		var _table_ = document.createElement("table"),
			_tr_ = document.createElement("tr"),
			_th_ = document.createElement("th"),
			_td_ = document.createElement("td");

		var table = _table_.cloneNode(false),
			columns = this._htmlAddAllColumnHeaders(arr, table);
		for (var i = 0, maxi = arr.length; i < maxi; ++i) {
			var tr = _tr_.cloneNode(false);
			for (var j = 0, maxj = columns.length; j < maxj; ++j) {
				var td = _td_.cloneNode(false);
				cellValue = arr[i][columns[j]];
				td.appendChild(document.createTextNode(arr[i][columns[j]] || ""));
				tr.appendChild(td);
			}
			table.appendChild(tr);
		}
		return table;
	};

	// Adds a header row to the table and returns the set of columns.
	// Need to do union of keys from all records as some records may not contain
	// all records
	this._htmlAddAllColumnHeaders = function (arr, table) {
		var _table_ = document.createElement("table"),
			_tr_ = document.createElement("tr"),
			_th_ = document.createElement("th"),
			_td_ = document.createElement("td");
		var columnSet = [],
			tr = _tr_.cloneNode(false);
		for (var i = 0, l = arr.length; i < l; i++) {
			for (var key in arr[i]) {
				if (arr[i].hasOwnProperty(key) && columnSet.indexOf(key) === -1) {
					columnSet.push(key);
					var th = _th_.cloneNode(false);
					th.appendChild(document.createTextNode(key));
					tr.appendChild(th);
				}
			}
		}
		table.appendChild(tr);
		return columnSet;
	};
} // end AppShedData class

/* 
========================================================================================================
        UI CHANGES install30
========================================================================================================
*/


function install30(install30_success) {
	if (window._30_installed) {
		return;
	}

	window._30_installed = true;

	app.setInterval(
		function () {
			try {
				// make sure phaser and dat have loaded
				if (parseFloat(Phaser.VERSION) > 3 && dat && dat.gui) {
					app.clearInterval("load-phaser-3");

					// sometimes this glitches and runs multiple times
					// in addition to the clearInterval, block repeats

					if (app._load_phaser_3_done) {
						return;
					}

					app._load_phaser_3_done = true;

					app.addCSS(
						"https://appshed.com/media/zoo/applications/cookbook/templates/default/assets/css/category.css"
					);
					app.addCSS(
						"https://appshed.com/media/zoo/applications/cookbook/templates/default/assets/css/item.css"
					);

					// Change navbar a bit
					// For admin userm abbreviate some top-menu items to stop wrapping
					if (jQuery(".nav .dropdown>a:contains('Admin Tools')")) {
						jQuery(".nav .dropdown>a:contains('Tools')").each(function () {
							// abbreviate
							try {
								var j = jQuery(this);
								j.html(j.html().replace(/Tools/, ""));
							} catch (er) {
								console.error("install30", er);
							}
						});
					}

					// EDU menu remove tracking (links broken)
					jQuery(".nav .dropdown li:contains('Track courses')").remove();
					jQuery(".nav .dropdown li:contains('Track app progress')").remove();

					// change user dropdown - stop overflow
					jQuery(".navbar .dropdown>a>i.icon-user").each(function () {
						jQuery(this).parent().parent().addClass("user");
					});
					var username = "";
					try {
						username = jQuery(".navbar .dropdown.user>a")
							.text()
							.replace(/[\n ]/g, "");
					} catch (er) {
						console.error("install30", er);
					}
					var thisHTML = jQuery(".navbar .dropdown.user>a").html();
					var myRE = new RegExp(username);

					// remove a text
					if (thisHTML) {
						jQuery(".navbar .dropdown.user>a").html(thisHTML.replace(myRE, ""));
					}
					// Create a div to hold the username text
					// in most cases if there is _ it's the schoolCode, so remove it
					username = username.replace(/\w+_(.*)/, "$1");
					jQuery(".navbar .dropdown.user>a>i.icon-user").after(
						'<div class="txt-username">' + username + "</div>"
					);

					// change tab label
					jQuery(".content-items.modules").html(
						'<i class="icon-copy"></i> Templates'
					);

					// change button label
					jQuery("#tab_modules a:contains('New Module')").text("New Template");

					// Add a search box to Modules search
					jQuery("#search-form-modules input[name='srch']").attr(
						"placeholder",
						"Search Templates"
					);
					if (jQuery("#search-form-modules-button").length == 0) {
						jQuery("#search-form-modules input").after(
							'<button id="search-form-modules-button" style="margin-left: 4px; margin-bottom: 10px; height: 30px" type="submit">Search</button>'
						);
					}

					// ================================================================================

					// ================================================================================


					if (app.isAppBuilder || app.isPreview) {

						// Add iPhone X support

						app.addStyles(
							"   .iphoneX.background{      padding-top: 27px;      padding-bottom: 28px;      padding-left: 26px;      padding-right: 26px;      background-image: url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/appbuilder/devices/apple-iphonex-bl-320png.png);  }    .iphoneX .phone-navigator .app .app-navigator .screen.appsscreen {      background-image: url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/appbuilder/devices/pv-iphonex-homejpg.jpg);      border-radius: 20px;  }  .app40 .iphoneX .phone-navigator .app .app-navigator .screen.appsscreen {      background-image: url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/appbuilder/devices/orbs-blue-lightjpg.jpg);      border-radius: 20px;  }   .iphoneX .phone-inner {      border-radius: 30px;   overflow: hidden;  }      .iphoneX {      width: 320px;      height: 691px;  }    .iphoneX.ios7style .phone-navigator .app .app-navigator .screen.appsscreen .items .home-bar-bg {      background: transparent;  }    .iphoneX.ios7style.status .phone-navigator .app .app-navigator .screen.hide-header .items .items-inner {      padding-top: 40px;  }    .iphoneX.ios7style .app-icon {      box-shadow: none;  }   .gamemaker .iphoneX .phone-inner {border-radius: 0px}   "
						);

						// iPhone 14
						app.addStyles(
							" .iphone14.background {     padding-top: 28px;     padding-bottom: 34px;     padding-left: 24px;     padding-right: 26px;     background-image: url(https://s3-eu-west-1.amazonaws.com/staticmedia.appshed.com/appbuilder/devices/apple-iphone14-rd-320png.png); }  .app40 .iphone14 .phone-navigator .app .app-navigator .screen.appsscreen {      background-image: unset;      border-radius: 38px;   }   .iphone14 .phone-inner {      border-radius: 38px;   overflow: hidden;  }      .iphone14 {      width: 320px;      height: 691px;  }    .iphone14.ios7style .phone-navigator .app .app-navigator .screen.appsscreen .items .home-bar-bg {      background: transparent;  }    .iphone14.ios7style.status .phone-navigator .app .app-navigator .screen.hide-header .items .items-inner {      padding-top: 40px;  }    .iphone14.ios7style .app-icon {      box-shadow: none;  }   .gamemaker .iphone14 .phone-inner {border-radius: 0px}   "
						);

						// remove iPhone14 from other device clicks
						jQuery(".navbar li.dropdown>a:contains(Device)").parent().find("ul.dropdown-menu>li>a").click(function () {
							jQuery(".phone.background").removeClass("iphone14 ios7style");
						});

						jQuery(".navbar li.dropdown:contains(Device) li>a").click(
							function () {
								jQuery(".phone.background").removeClass("iphoneX");
							}
						);

						var nodeX = jQuery(
							".navbar li.dropdown:contains(Device) li:contains(iPhone 5S)"
						).clone();
						nodeX
							.find("a")
							.html('<i class="icon-mobile-phone"></i> iPhone X')
							.click(function () {
								jQuery(".phone.background")
									.removeClass(
										"iphone iphone5 iphone5s ipad ipadair android androidsm nexus7 blackberry blackberry10 playbook"
									)
									.addClass("iphoneX ios7style");
							});
						jQuery(
							".navbar li.dropdown:contains(Device) li:contains(iPhone 5S)"
						).after(nodeX);

						//jQuery('.navbar li.dropdown:contains(Device) li:contains(iPhone X)>a').click();

						var node14 = jQuery(
							".navbar li.dropdown:contains(Device) li:contains(iPhone 5S)"
						).clone();
						node14
							.find("a")
							.html('<i class="icon-mobile-phone"></i> iPhone 14')
							.click(function () {
								jQuery(".phone.background")
									.removeClass(
										"iphone iphone5 iphone5s ipad ipadair android androidsm nexus7 blackberry blackberry10 playbook iphoneX"
									)
									.addClass("iphone14 ios7style");
							});

						jQuery(
							".navbar li.dropdown:contains(Device) li:contains(iPhone X)"
						).after(node14);

						jQuery(
							".navbar li.dropdown:contains(Device) li:contains(iPhone 14)>a"
						).click();
					} // end if (app.isAppBuilder || app.isPreview) {

					if (app.isAppBuilder && !app.isPreview) {
						// resources panel
						jQuery(".row>.span-toolbox").after(
							'<div class="span-resourcepanel"><div class="resourcepanel-container"><div class="resourcepanel docked"></div></div></div>'
						);
					}

					// ==============================================================================
					// Change Top Menu

					// Top menubar, product launcher links
					var jLinks = jQuery(".navbar .nav.pull-right");
					jQuery(
						'<li id="product-link-gm" class="product-selector"><a style="cursor: pointer;"><div style="position: relative;height: 0px;"><div style="position: relative;top: 16px;font-size: 11px;left: 3px;font-weight: 800;">BETA</div></div><i class="icon-gamepad"></i> Game Maker</a></li>'
					).prependTo(jLinks);
					jQuery(
						'<li id="product-link-ab" class="product-selector"><a style="cursor: pointer;"><i class="icon-plus"></i> App Builder</a></li>'
					).prependTo(jLinks);

					// Courses
					jQuery(
						'<li id="product-link-courses" class="courses-selector product-selector"><a style="cursor: pointer;"><i class="icon-info"></i> Courses</a></li>'
					).prependTo(jLinks);
					jQuery('<li style=" width: 80px; ">&nbsp; </li>').appendTo(jLinks);

					jQuery(".product-selector").click(function () {
						jQuery(".product-selector.active").each(function () {
							jQuery(this).removeClass("active");
						});
						jQuery(this).addClass("active");
					});
					jQuery("#product-link-gm").click(function () {
						app._showProduct("gamemaker");
					});
					jQuery("#product-link-ab").click(function () {
						app._showProduct("appbuilder");
					});
					jQuery("#product-link-courses").click(function () {
						app._showProduct("courses");
					});
					// add class to Iot button
					jQuery('.navbar-fixed-top li:contains("Iot")')
						.first()
						.addClass("product-selector")
						.attr("id", "product-link-ib");

					// Rename Academy to Dashboard
					jQuery('.navbar .nav.pull-right li>a:contains("Academy")').html(
						'<i class="icon-signal"></i> Dashboard <i class="icon-caret-down"></i>'
					);

					// Dashboard Menu changes
					try {
						var jMenu = jQuery(
							'.navbar ul.dropdown-menu:contains("Register my School")'
						);
						jMenu
							.find('li:contains("Register my School")')
							.clone()
							.prependTo(jMenu)
							.find("a")
							.text("EDU Features")
							.attr("href", "/teach/edu-features")
							.attr("target", "_blank");
						jMenu
							.find('li:contains("Register my School")')
							.clone()
							.prependTo(jMenu)
							.find("a")
							.text("Get Trial/Demo")
							.attr("href", "/teach/edu-free-trial")
							.attr("target", "_blank");
						// Remove the icons from this menu
						jMenu.find("a>i").remove();
					} catch (er) {
						console.log(er);
					}

					
					// Dev Menu changes

					var jDev = jQuery(
						'.navbar ul.dropdown-menu:contains("App Tree")'
					);

					var jDevice = jQuery(
						'.navbar ul.dropdown-menu:contains("iOS")'
					);
                    // use innerHTML not .clone(), as the HTML for icon not cloned
					var mEd = jQuery(jDevice
						.find('li:last')[0].outerHTML)
					    .prependTo(jDevice)
						.find("a")
                        .html('<i class="icon-edit"></i> Mobile Editor')
						.click((e)=>{
                            // Make sure scrolled to top
                            window.scrollTo(0,0);
							jQuery('body').addClass('mobileeditor');
							jQuery(".span-toolbox").css("display","none");
                            app.refreshScroll()
                            e.preventDefault();
                            return null;
						});



					// Help Menu changes

					// add MasterClasses, Telephone Support and Academy
					var jHelp = jQuery(
						'.navbar ul.dropdown-menu:contains("Quick Guide IoT")'
					);
					jHelp
						.find('li:contains("Quick Guide IoT")')
						.clone()
						.prependTo(jHelp)
						.find("a")
						.text("EDU Support")
						.attr("href", "/appbuilder/academy/support");
					/*		
				jHelp.find('li:contains("Quick Guide IoT")').clone().prependTo(jHelp).find('a').text('AppShed Academy').attr('href', '#').attr('target', '').click(function () {
					jQuery('#academy .button').click();
				});
				jHelp.find('li:contains("Quick Guide IoT")').clone().prependTo(jHelp).find('a').text('Tel./Online Support').attr('href', '#');
				jHelp.find('li:contains("Quick Guide IoT")').clone().prependTo(jHelp).find('a').text('Master Classes').attr('href', '#');
				*/
					// Remove Latest News and others
					jHelp.find('li:contains("Latest News")').remove();
					jHelp.find('li:contains("Quick Guide IoT")').remove();
					jHelp.find('li:contains("Quick Guide AppBuilder")').remove();

					// Help Centre new href Help Center
					jHelp.find('li>a:contains("Help Cent")').attr("href", "/support");
					// Developer Docs
					jHelp
						.find('li>a:contains("Developer Doc")')
						.attr("href", "/docs")
						.text("Developer Docs");

					// ================================================================================
					// EDU Badges

					// on the Templates and Images tabs
					jQuery('.nav-tabs li a[data-target="tab_modules"]').prepend(
						'<div class="edubadge">EDU</div>'
					);
					jQuery('.nav-tabs li a[data-target="tab_images"]').prepend(
						'<div class="edubadge">EDU</div>'
					);
					// on the Dashboard and Help menus
					jQuery('.navbar ul.nav.pull-right a:contains("Dashboard")').prepend(
						'<div class="edubadge" style="top: 3px; right: 24px;">EDU</div>'
					);
					jQuery('.navbar ul.nav.pull-right>li>a:contains("Help")').prepend(
						'<div class="edubadge" style="top: 3px; right: 12px;">EDU</div>'
					);
					// sub items in Help menu
					jQuery(
						'.navbar ul.dropdown-menu a:contains("AppShed Academy")'
					).prepend(
						'<div class="edubadge" style="top: 4px; right: 4px;">EDU</div>'
					);
					jQuery(
						'.navbar ul.dropdown-menu a:contains("Online Support")'
					).prepend(
						'<div class="edubadge" style="top: 4px; right: 4px;">EDU</div>'
					);
					jQuery(
						'.navbar ul.dropdown-menu a:contains("Master Classes")'
					).prepend(
						'<div class="edubadge" style="top: 4px; right: 4px;">EDU</div>'
					);
					jQuery('.navbar ul.dropdown-menu a:contains("EDU Support")').prepend(
						'<div class="edubadge" style="top: 4px; right: 4px;">EDU</div>'
					);
					// on the Academy tab
					jQuery('#academy .button span:contains("Academy")').prepend(
						'<div class="edubadge" style="top: 6px; right: 39px;">EDU</div>'
					);

					// Delay this task, as other badges might be added during Game Maker install
					setTimeout(function () {
						jQuery(".edubadge").click(function () {
							app.asa.start('tour-edu',{force: true});
							app._resourcepanelSetTab('upgrade')
							//window.open("https://appshed.com/edu");
						});
					}, 3000);

					// ================================================================================
					// Hide App Gallery
					jQuery('.navbar ul.dropdown-menu a:contains("App gallery")').hide();

					// ================================================================================
					// UI IDE Behaviour & Styles

					app.addStyles(
						' .box2 .app-controls {        background-color: rgba(170,170,170,0.02); margin: 10px 0 10px 0;    border: 1px solid silver;    padding: 11px 0 5px 0;  }   .box2 .app-controls li i  {font-size: 22px;    line-height: 15px;}  .box2 .app-controls li i.icon-share {    font-size: 22px;    padding: 10px; }   .box2 .app-controls li i.icon-appshed-iot {    font-size: 18px;    padding-right: 10px; }  .box2 h1 {     height: 20px;     line-height: 30px;     font-size: 16px;     font-weight: normal;  }   .toolbox .tool {    font-size: 18px;  }    .box2 .content .icon {    width: 56px;    padding: 1px;    height: 56px;   }  .toolbox a.item.icon[data-screentype="map list"] { _display: none;}  .upload-picker a[data-file-browser="edit"] {display: none; } .ios7style .map-holder { margin-top: 63px; }'
					);

					// add a note to Share menu
					jQuery(".dropdown .share-menu").append(
						'<a style="padding: 10px;background-color: var(--gm-panel-border);color: white;">Remember to Publish your app to see the changes you have made.</a>'
					);

					// ================================================================================
					// AppShed Academy fixes

					jQuery("#academy .header").after(
						'<div class="academyLoader invisible" style="     width: 100%;     z-index: 3;     position: absolute;     height: 100%;     background-color: rgba(255, 255, 255); ">      <div style="     width: 50%;     margin: 0 auto;     /* opacity: 1; */     height: 150px;     text-align: center;     margin-top: 67px; ">                     <i style="     /* width: 300px; */     zoom: 11;     opacity: 1; " class="icon-spinner icon-spin "></i>          </div>     </div>'
					);

					app.addStyles(
						" #academy .page>.item>.text{  font-size: 14px; background-color: #d3d3d3;  min-height: 235px;}  "
					);

					app.addStyles(
						'.w3-image{max-width:100%;height:auto}img{vertical-align:middle}a{color:inherit} .w3-table,.w3-table-all{border-collapse:collapse;border-spacing:0;width:100%;display:table}.w3-table-all{border:1px solid #ccc} .w3-bordered tr,.w3-table-all tr{border-bottom:1px solid #ddd}.w3-striped tbody tr:nth-child(even){background-color:#f1f1f1} .w3-table-all tr:nth-child(odd){background-color:#fff}.w3-table-all tr:nth-child(even){background-color:#f1f1f1} .w3-hoverable tbody tr:hover,.w3-ul.w3-hoverable li:hover{background-color:#ccc}.w3-centered tr th,.w3-centered tr td{text-align:center} .w3-table td,.w3-table th,.w3-table-all td,.w3-table-all th{padding:8px 8px;display:table-cell;text-align:left;vertical-align:top} .w3-table th:first-child,.w3-table td:first-child,.w3-table-all th:first-child,.w3-table-all td:first-child{padding-left:16px} .w3-btn,.w3-button{border:none;display:inline-block;padding:8px 16px;vertical-align:middle;overflow:hidden;text-decoration:none;color:inherit;background-color:inherit;text-align:center;cursor:pointer;white-space:nowrap} .w3-btn:hover{box-shadow:0 8px 16px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19)} .w3-btn,.w3-button{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}    .w3-disabled,.w3-btn:disabled,.w3-button:disabled{cursor:not-allowed;opacity:0.3}.w3-disabled *,:disabled *{pointer-events:none} .w3-btn.w3-disabled:hover,.w3-btn:disabled:hover{box-shadow:none} .w3-badge,.w3-tag{background-color:#000;color:#fff;display:inline-block;padding-left:8px;padding-right:8px;text-align:center}.w3-badge{border-radius:50%} .w3-ul{list-style-type:none;padding:0;margin:0}.w3-ul li{padding:8px 16px;border-bottom:1px solid #ddd}.w3-ul li:last-child{border-bottom:none} .w3-tooltip,.w3-display-container{position:relative}.w3-tooltip .w3-text{display:none}.w3-tooltip:hover .w3-text{display:inline-block} .w3-ripple:active{opacity:0.5}.w3-ripple{transition:opacity 0s} .w3-input{padding:8px;display:block;border:none;border-bottom:1px solid #ccc;width:100%} .w3-select{padding:9px 0;width:100%;border:none;border-bottom:1px solid #ccc} .w3-dropdown-click,.w3-dropdown-hover{position:relative;display:inline-block;cursor:pointer} .w3-dropdown-hover:hover .w3-dropdown-content{display:block} .w3-dropdown-hover:first-child,.w3-dropdown-click:hover{background-color:#ccc;color:#000} .w3-dropdown-hover:hover > .w3-button:first-child,.w3-dropdown-click:hover > .w3-button:first-child{background-color:#ccc;color:#000} .w3-dropdown-content{cursor:auto;color:#000;background-color:#fff;display:none;position:absolute;min-width:160px;margin:0;padding:0;z-index:1} .w3-check,.w3-radio{width:24px;height:24px;position:relative;top:6px} .w3-sidebar{height:100%;width:200px;background-color:#fff;position:fixed!important;z-index:1;overflow:auto} .w3-bar-block .w3-dropdown-hover,.w3-bar-block .w3-dropdown-click{width:100%} .w3-bar-block .w3-dropdown-hover .w3-dropdown-content,.w3-bar-block .w3-dropdown-click .w3-dropdown-content{min-width:100%} .w3-bar-block .w3-dropdown-hover .w3-button,.w3-bar-block .w3-dropdown-click .w3-button{width:100%;text-align:left;padding:8px 16px} .w3-main,#main{transition:margin-left .4s} .w3-modal{z-index:3;display:none;padding-top:100px;position:fixed;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgb(0,0,0);background-color:rgba(0,0,0,0.4)} .w3-modal-content{margin:auto;background-color:#fff;position:relative;padding:0;outline:0;width:600px} .w3-bar{width:100%;overflow:hidden}.w3-center .w3-bar{display:inline-block;width:auto} .w3-bar .w3-bar-item{padding:8px 16px;float:left;width:auto;border:none;display:block;outline:0} .w3-bar .w3-dropdown-hover,.w3-bar .w3-dropdown-click{position:static;float:left} .w3-bar .w3-button{white-space:normal} .w3-bar-block .w3-bar-item{width:100%;display:block;padding:8px 16px;text-align:left;border:none;white-space:normal;float:none;outline:0} .w3-bar-block.w3-center .w3-bar-item{text-align:center}.w3-block{display:block;width:100%} .w3-responsive{display:block;overflow-x:auto} .w3-container:after,.w3-container:before,.w3-panel:after,.w3-panel:before,.w3-row:after,.w3-row:before,.w3-row-padding:after,.w3-row-padding:before, .w3-cell-row:before,.w3-cell-row:after,.w3-clear:after,.w3-clear:before,.w3-bar:before,.w3-bar:after{content:"";display:table;clear:both} .w3-col,.w3-half,.w3-third,.w3-twothird,.w3-threequarter,.w3-quarter{float:left;width:100%} .w3-col.s1{width:8.33333%}.w3-col.s2{width:16.66666%}.w3-col.s3{width:24.99999%}.w3-col.s4{width:33.33333%} .w3-col.s5{width:41.66666%}.w3-col.s6{width:49.99999%}.w3-col.s7{width:58.33333%}.w3-col.s8{width:66.66666%} .w3-col.s9{width:74.99999%}.w3-col.s10{width:83.33333%}.w3-col.s11{width:91.66666%}.w3-col.s12{width:99.99999%} @media (min-width:601px){.w3-col.m1{width:8.33333%}.w3-col.m2{width:16.66666%}.w3-col.m3,.w3-quarter{width:24.99999%}.w3-col.m4,.w3-third{width:33.33333%} .w3-col.m5{width:41.66666%}.w3-col.m6,.w3-half{width:49.99999%}.w3-col.m7{width:58.33333%}.w3-col.m8,.w3-twothird{width:66.66666%} .w3-col.m9,.w3-threequarter{width:74.99999%}.w3-col.m10{width:83.33333%}.w3-col.m11{width:91.66666%}.w3-col.m12{width:99.99999%}} @media (min-width:993px){.w3-col.l1{width:8.33333%}.w3-col.l2{width:16.66666%}.w3-col.l3{width:24.99999%}.w3-col.l4{width:33.33333%} .w3-col.l5{width:41.66666%}.w3-col.l6{width:49.99999%}.w3-col.l7{width:58.33333%}.w3-col.l8{width:66.66666%} .w3-col.l9{width:74.99999%}.w3-col.l10{width:83.33333%}.w3-col.l11{width:91.66666%}.w3-col.l12{width:99.99999%}} .w3-rest{overflow:hidden}.w3-stretch{margin-left:-16px;margin-right:-16px} .w3-content,.w3-auto{margin-left:auto;margin-right:auto}.w3-content{max-width:980px}.w3-auto{max-width:1140px} .w3-cell-row{display:table;width:100%}.w3-cell{display:table-cell} .w3-cell-top{vertical-align:top}.w3-cell-middle{vertical-align:middle}.w3-cell-bottom{vertical-align:bottom} .w3-hide{display:none!important}.w3-show-block,.w3-show{display:block!important}.w3-show-inline-block{display:inline-block!important} @media (max-width:1205px){.w3-auto{max-width:95%}} @media (max-width:600px){.w3-modal-content{margin:0 10px;width:auto!important}.w3-modal{padding-top:30px} .w3-dropdown-hover.w3-mobile .w3-dropdown-content,.w3-dropdown-click.w3-mobile .w3-dropdown-content{position:relative}	 .w3-hide-small{display:none!important}.w3-mobile{display:block;width:100%!important}.w3-bar-item.w3-mobile,.w3-dropdown-hover.w3-mobile,.w3-dropdown-click.w3-mobile{text-align:center} .w3-dropdown-hover.w3-mobile,.w3-dropdown-hover.w3-mobile .w3-btn,.w3-dropdown-hover.w3-mobile .w3-button,.w3-dropdown-click.w3-mobile,.w3-dropdown-click.w3-mobile .w3-btn,.w3-dropdown-click.w3-mobile .w3-button{width:100%}} @media (max-width:768px){.w3-modal-content{width:500px}.w3-modal{padding-top:50px}} @media (min-width:993px){.w3-modal-content{width:900px}.w3-hide-large{display:none!important}.w3-sidebar.w3-collapse{display:block!important}} @media (max-width:992px) and (min-width:601px){.w3-hide-medium{display:none!important}} @media (max-width:992px){.w3-sidebar.w3-collapse{display:none}.w3-main{margin-left:0!important;margin-right:0!important}.w3-auto{max-width:100%}} .w3-top,.w3-bottom{position:fixed;width:100%;z-index:1}.w3-top{top:0}.w3-bottom{bottom:0} .w3-overlay{position:fixed;display:none;width:100%;height:100%;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.5);z-index:2} .w3-display-topleft{position:absolute;left:0;top:0}.w3-display-topright{position:absolute;right:0;top:0} .w3-display-bottomleft{position:absolute;left:0;bottom:0}.w3-display-bottomright{position:absolute;right:0;bottom:0} .w3-display-middle{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%)} .w3-display-left{position:absolute;top:50%;left:0%;transform:translate(0%,-50%);-ms-transform:translate(-0%,-50%)} .w3-display-right{position:absolute;top:50%;right:0%;transform:translate(0%,-50%);-ms-transform:translate(0%,-50%)} .w3-display-topmiddle{position:absolute;left:50%;top:0;transform:translate(-50%,0%);-ms-transform:translate(-50%,0%)} .w3-display-bottommiddle{position:absolute;left:50%;bottom:0;transform:translate(-50%,0%);-ms-transform:translate(-50%,0%)} .w3-display-container:hover .w3-display-hover{display:block}.w3-display-container:hover span.w3-display-hover{display:inline-block}.w3-display-hover{display:none} .w3-display-position{position:absolute} .w3-circle{border-radius:50%} .w3-round-small{border-radius:2px}.w3-round,.w3-round-medium{border-radius:4px}.w3-round-large{border-radius:8px}.w3-round-xlarge{border-radius:16px}.w3-round-xxlarge{border-radius:32px} .w3-row-padding,.w3-row-padding>.w3-half,.w3-row-padding>.w3-third,.w3-row-padding>.w3-twothird,.w3-row-padding>.w3-threequarter,.w3-row-padding>.w3-quarter,.w3-row-padding>.w3-col{padding:0 8px} .w3-container,.w3-panel{padding:0.01em 16px}.w3-panel{margin-top:16px;margin-bottom:16px} .w3-code,.w3-codespan{font-family:Consolas,"courier new";font-size:16px} .w3-code{width:auto;background-color:#fff;padding:8px 12px;border-left:4px solid #4CAF50;word-wrap:break-word} .w3-codespan{color:crimson;background-color:#f1f1f1;padding-left:4px;padding-right:4px;font-size:110%} .w3-card,.w3-card-2{box-shadow:0 2px 5px 0 rgba(0,0,0,0.16),0 2px 10px 0 rgba(0,0,0,0.12)} .w3-card-4,.w3-hover-shadow:hover{box-shadow:0 4px 10px 0 rgba(0,0,0,0.2),0 4px 20px 0 rgba(0,0,0,0.19)} .w3-spin{animation:w3-spin 2s infinite linear}@keyframes w3-spin{0%{transform:rotate(0deg)}100%{transform:rotate(359deg)}} .w3-animate-fading{animation:fading 10s infinite}@keyframes fading{0%{opacity:0}50%{opacity:1}100%{opacity:0}} .w3-animate-opacity{animation:opac 0.8s}@keyframes opac{from{opacity:0} to{opacity:1}} .w3-animate-top{position:relative;animation:animatetop 0.4s}@keyframes animatetop{from{top:-300px;opacity:0} to{top:0;opacity:1}} .w3-animate-left{position:relative;animation:animateleft 0.4s}@keyframes animateleft{from{left:-300px;opacity:0} to{left:0;opacity:1}} .w3-animate-right{position:relative;animation:animateright 0.4s}@keyframes animateright{from{right:-300px;opacity:0} to{right:0;opacity:1}} .w3-animate-bottom{position:relative;animation:animatebottom 0.4s}@keyframes animatebottom{from{bottom:-300px;opacity:0} to{bottom:0;opacity:1}} .w3-animate-zoom {animation:animatezoom 0.6s}@keyframes animatezoom{from{transform:scale(0)} to{transform:scale(1)}} .w3-animate-input{transition:width 0.4s ease-in-out}.w3-animate-input:focus{width:100%!important} .w3-opacity,.w3-hover-opacity:hover{opacity:0.60}.w3-opacity-off,.w3-hover-opacity-off:hover{opacity:1} .w3-opacity-max{opacity:0.25}.w3-opacity-min{opacity:0.75} .w3-greyscale-max,.w3-grayscale-max,.w3-hover-greyscale:hover,.w3-hover-grayscale:hover{filter:grayscale(100%)} .w3-greyscale,.w3-grayscale{filter:grayscale(75%)}.w3-greyscale-min,.w3-grayscale-min{filter:grayscale(50%)} .w3-sepia{filter:sepia(75%)}.w3-sepia-max,.w3-hover-sepia:hover{filter:sepia(100%)}.w3-sepia-min{filter:sepia(50%)} .w3-tiny{font-size:10px!important}.w3-small{font-size:12px!important}.w3-medium{font-size:15px!important}.w3-large{font-size:18px!important} .w3-xlarge{font-size:24px!important}.w3-xxlarge{font-size:36px!important}.w3-xxxlarge{font-size:48px!important}.w3-jumbo{font-size:64px!important} .w3-left-align{text-align:left!important}.w3-right-align{text-align:right!important}.w3-justify{text-align:justify!important}.w3-center{text-align:center!important} .w3-border-0{border:0!important}.w3-border{border:1px solid #ccc!important}'
					);

					app.addStyles(
						" .w3-border-top{border-top:1px solid #ccc!important}.w3-border-bottom{border-bottom:1px solid #ccc!important} .w3-border-left{border-left:1px solid #ccc!important}.w3-border-right{border-right:1px solid #ccc!important} .w3-topbar{border-top:6px solid #ccc!important}.w3-bottombar{border-bottom:6px solid #ccc!important} .w3-leftbar{border-left:6px solid #ccc!important}.w3-rightbar{border-right:6px solid #ccc!important} .w3-section,.w3-code{margin-top:16px!important;margin-bottom:16px!important} .w3-margin{margin:16px!important}.w3-margin-top{margin-top:16px!important}.w3-margin-bottom{margin-bottom:16px!important} .w3-margin-left{margin-left:16px!important}.w3-margin-right{margin-right:16px!important} .w3-padding-small{padding:4px 8px!important}.w3-padding{padding:8px 16px!important}.w3-padding-large{padding:12px 24px!important} .w3-padding-16{padding-top:16px!important;padding-bottom:16px!important}.w3-padding-24{padding-top:24px!important;padding-bottom:24px!important} .w3-padding-32{padding-top:32px!important;padding-bottom:32px!important}.w3-padding-48{padding-top:48px!important;padding-bottom:48px!important} .w3-padding-64{padding-top:64px!important;padding-bottom:64px!important} .w3-left{float:left!important}.w3-right{float:right!important} .w3-button:hover{color:#000!important;background-color:#ccc!important} .w3-transparent,.w3-hover-none:hover{background-color:transparent!important} .w3-hover-none:hover{box-shadow:none!important} /* Colors */ .w3-amber,.w3-hover-amber:hover{color:#000!important;background-color:#ffc107!important} .w3-aqua,.w3-hover-aqua:hover{color:#000!important;background-color:#00ffff!important} .w3-blue,.w3-hover-blue:hover{color:#fff!important;background-color:#2196F3!important} .w3-light-blue,.w3-hover-light-blue:hover{color:#000!important;background-color:#87CEEB!important} .w3-brown,.w3-hover-brown:hover{color:#fff!important;background-color:#795548!important} .w3-cyan,.w3-hover-cyan:hover{color:#000!important;background-color:#00bcd4!important} .w3-blue-grey,.w3-hover-blue-grey:hover,.w3-blue-gray,.w3-hover-blue-gray:hover{color:#fff!important;background-color:#607d8b!important} .w3-green,.w3-hover-green:hover{color:#fff!important;background-color:#4CAF50!important} .w3-light-green,.w3-hover-light-green:hover{color:#000!important;background-color:#8bc34a!important} .w3-indigo,.w3-hover-indigo:hover{color:#fff!important;background-color:#3f51b5!important} .w3-khaki,.w3-hover-khaki:hover{color:#000!important;background-color:#f0e68c!important} .w3-lime,.w3-hover-lime:hover{color:#000!important;background-color:#cddc39!important} .w3-orange,.w3-hover-orange:hover{color:#000!important;background-color:#ff9800!important} .w3-deep-orange,.w3-hover-deep-orange:hover{color:#fff!important;background-color:#ff5722!important} .w3-pink,.w3-hover-pink:hover{color:#fff!important;background-color:#e91e63!important} .w3-purple,.w3-hover-purple:hover{color:#fff!important;background-color:#9c27b0!important} .w3-deep-purple,.w3-hover-deep-purple:hover{color:#fff!important;background-color:#673ab7!important} .w3-red,.w3-hover-red:hover{color:#fff!important;background-color:#f44336!important} .w3-sand,.w3-hover-sand:hover{color:#000!important;background-color:#fdf5e6!important} .w3-teal,.w3-hover-teal:hover{color:#fff!important;background-color:#009688!important} .w3-yellow,.w3-hover-yellow:hover{color:#000!important;background-color:#ffeb3b!important} .w3-white,.w3-hover-white:hover{color:#000!important;background-color:#fff!important} .w3-black,.w3-hover-black:hover{color:#fff!important;background-color:#000!important} .w3-grey,.w3-hover-grey:hover,.w3-gray,.w3-hover-gray:hover{color:#000!important;background-color:#9e9e9e!important} .w3-light-grey,.w3-hover-light-grey:hover,.w3-light-gray,.w3-hover-light-gray:hover{color:#000!important;background-color:#f1f1f1!important} .w3-dark-grey,.w3-hover-dark-grey:hover,.w3-dark-gray,.w3-hover-dark-gray:hover{color:#fff!important;background-color:#616161!important} .w3-pale-red,.w3-hover-pale-red:hover{color:#000!important;background-color:#ffdddd!important} .w3-pale-green,.w3-hover-pale-green:hover{color:#000!important;background-color:#ddffdd!important} .w3-pale-yellow,.w3-hover-pale-yellow:hover{color:#000!important;background-color:#ffffcc!important} .w3-pale-blue,.w3-hover-pale-blue:hover{color:#000!important;background-color:#ddffff!important} .w3-text-amber,.w3-hover-text-amber:hover{color:#ffc107!important} .w3-text-aqua,.w3-hover-text-aqua:hover{color:#00ffff!important} .w3-text-blue,.w3-hover-text-blue:hover{color:#2196F3!important} .w3-text-light-blue,.w3-hover-text-light-blue:hover{color:#87CEEB!important} .w3-text-brown,.w3-hover-text-brown:hover{color:#795548!important} .w3-text-cyan,.w3-hover-text-cyan:hover{color:#00bcd4!important} .w3-text-blue-grey,.w3-hover-text-blue-grey:hover,.w3-text-blue-gray,.w3-hover-text-blue-gray:hover{color:#607d8b!important} .w3-text-green,.w3-hover-text-green:hover{color:#4CAF50!important} .w3-text-light-green,.w3-hover-text-light-green:hover{color:#8bc34a!important} .w3-text-indigo,.w3-hover-text-indigo:hover{color:#3f51b5!important} .w3-text-khaki,.w3-hover-text-khaki:hover{color:#b4aa50!important} .w3-text-lime,.w3-hover-text-lime:hover{color:#cddc39!important} .w3-text-orange,.w3-hover-text-orange:hover{color:#ff9800!important} .w3-text-deep-orange,.w3-hover-text-deep-orange:hover{color:#ff5722!important} .w3-text-pink,.w3-hover-text-pink:hover{color:#e91e63!important} .w3-text-purple,.w3-hover-text-purple:hover{color:#9c27b0!important} .w3-text-deep-purple,.w3-hover-text-deep-purple:hover{color:#673ab7!important} .w3-text-red,.w3-hover-text-red:hover{color:#f44336!important} .w3-text-sand,.w3-hover-text-sand:hover{color:#fdf5e6!important} .w3-text-teal,.w3-hover-text-teal:hover{color:#009688!important} .w3-text-yellow,.w3-hover-text-yellow:hover{color:#d2be0e!important} .w3-text-white,.w3-hover-text-white:hover{color:#fff!important} .w3-text-black,.w3-hover-text-black:hover{color:#000!important} .w3-text-grey,.w3-hover-text-grey:hover,.w3-text-gray,.w3-hover-text-gray:hover{color:#757575!important} .w3-text-light-grey,.w3-hover-text-light-grey:hover,.w3-text-light-gray,.w3-hover-text-light-gray:hover{color:#f1f1f1!important} .w3-text-dark-grey,.w3-hover-text-dark-grey:hover,.w3-text-dark-gray,.w3-hover-text-dark-gray:hover{color:#3a3a3a!important} .w3-border-amber,.w3-hover-border-amber:hover{border-color:#ffc107!important} .w3-border-aqua,.w3-hover-border-aqua:hover{border-color:#00ffff!important} .w3-border-blue,.w3-hover-border-blue:hover{border-color:#2196F3!important} .w3-border-light-blue,.w3-hover-border-light-blue:hover{border-color:#87CEEB!important} .w3-border-brown,.w3-hover-border-brown:hover{border-color:#795548!important} .w3-border-cyan,.w3-hover-border-cyan:hover{border-color:#00bcd4!important} .w3-border-blue-grey,.w3-hover-border-blue-grey:hover,.w3-border-blue-gray,.w3-hover-border-blue-gray:hover{border-color:#607d8b!important} .w3-border-green,.w3-hover-border-green:hover{border-color:#4CAF50!important} .w3-border-light-green,.w3-hover-border-light-green:hover{border-color:#8bc34a!important} .w3-border-indigo,.w3-hover-border-indigo:hover{border-color:#3f51b5!important} .w3-border-khaki,.w3-hover-border-khaki:hover{border-color:#f0e68c!important} .w3-border-lime,.w3-hover-border-lime:hover{border-color:#cddc39!important} .w3-border-orange,.w3-hover-border-orange:hover{border-color:#ff9800!important} .w3-border-deep-orange,.w3-hover-border-deep-orange:hover{border-color:#ff5722!important} .w3-border-pink,.w3-hover-border-pink:hover{border-color:#e91e63!important} .w3-border-purple,.w3-hover-border-purple:hover{border-color:#9c27b0!important} .w3-border-deep-purple,.w3-hover-border-deep-purple:hover{border-color:#673ab7!important} .w3-border-red,.w3-hover-border-red:hover{border-color:#f44336!important} .w3-border-sand,.w3-hover-border-sand:hover{border-color:#fdf5e6!important} .w3-border-teal,.w3-hover-border-teal:hover{border-color:#009688!important} .w3-border-yellow,.w3-hover-border-yellow:hover{border-color:#ffeb3b!important} .w3-border-white,.w3-hover-border-white:hover{border-color:#fff!important} .w3-border-black,.w3-hover-border-black:hover{border-color:#000!important} .w3-border-grey,.w3-hover-border-grey:hover,.w3-border-gray,.w3-hover-border-gray:hover{border-color:#9e9e9e!important} .w3-border-light-grey,.w3-hover-border-light-grey:hover,.w3-border-light-gray,.w3-hover-border-light-gray:hover{border-color:#f1f1f1!important} .w3-border-dark-grey,.w3-hover-border-dark-grey:hover,.w3-border-dark-gray,.w3-hover-border-dark-gray:hover{border-color:#616161!important} .w3-border-pale-red,.w3-hover-border-pale-red:hover{border-color:#ffe7e7!important}.w3-border-pale-green,.w3-hover-border-pale-green:hover{border-color:#e7ffe7!important} .w3-border-pale-yellow,.w3-hover-border-pale-yellow:hover{border-color:#ffffcc!important}.w3-border-pale-blue,.w3-hover-border-pale-blue:hover{border-color:#e7ffff!important}"
					);

					// ================================================================================
					// Various other fixes

					// Add class ti  Item Type tab (to hide in GM
					jQuery(
						'.span-toolbox .popup-embed ul.nav-tabs>li:contains("Item Type")'
					).addClass("tab-itemtype");

					//app.currentProduct = "appbuilder";

					jQuery(".academyLoader").click(function () {
						app.hideAcademyLoader();
					});

					app.game._installGameMaker();

					app._installEDU40();

					app._highlightProductLink();
				} // end If once Phaser 3 ready
			} catch (er) {
				console.error("install30", er);
			}

			if (install30_success) {
				install30_success.call();
			}
		},
		300,
		30000,
		"load-phaser-3"
	);
} // END install30


/* 
========================================================================================================
        AppShedUser Class User Object AppShedUser Object
========================================================================================================
*/

/*

AppShedUser
Class to provide functoinality for the current user

v 1.0 29-02-2020 Initial version

*/




function AppShedUser(props) {
	// NB NB NB NB If adding new variables, make sure to add them to the _resetFromSessionInfo() function
	this.appshedlogin = "";
	this.email = "";
	this.emailDomain = "";
	this.emailDomainString = "";
	this.id = "";
	this.name = "";
	this.school = {
		// holds the school info
		name: "",
		code: "",
		enddate: "",
		paid: false,
		trial: false,
		trialInfo: {}, // info about the trial
	};
	this.schoolCode = "";
	this.schoolId = "";
    this.state = {}; // holds a variety of state properties
	this.type = "";
	this.username = "";
	this.sessionInfo = {};

	this._init = function () {

		// get all the properties. Some will be temporary/inaccurate since we haven't done the ajax call yet
		// we Want to do this so that the properties are available "statically" in the app object. This allows GTM to access them without calling methods.
		this._getAll();

		// fallback in case something doesn't work, load the resource panel after long delay
		setTimeout(function () {
			// Make sure to Load the resource panel
			app._resourcepanelInit();
		}, 20000);

		// whenDone will be called when all the user init stuff is done
		var whenDone = function () {
			// trigger the event, use the last mutation as the node (.sliding-inner)
			document.dispatchEvent(app.events["ase-user-init-done"]);
		};

		// Session info, include a callback function for the session call
		this._requestSessionUserInfo(
			null,
			function (a, b, c) {
				// Callback
				// Reset all the user data again, because some will have changed based on session data
				app.getUser()._resetFromSessionInfo();

				// update the username in the UI
                if(app.user.isVerified()){
                    jQuery(".navbar .txt-username").text(app.user.username);
                }else{
                    jQuery(".navbar .txt-username").text('Email not verified');
                    jQuery('body').addClass('unverified');

                    // add Verify menu option
                    var nb = jQuery('.navbar-fixed-top .dropdown.user');
                    if(nb.find('li.verify').length == 0){
                        jQuery('<li class="verify"><a href="#"><i class="icon-user"></i> Verify email address</a></li>').click(function(){
                            // if the email is invalid, show a different ASA
                            try {
                                if(app.user.sessionInfo.params.email_status == 0){
                                    app.asa.start("invalid-email",{force: true});
                                }else{
                                    app.asa.start("verify-email",{force: true});
                                }
                                
                            } catch (error) {
                                app.asa.start("verify-email",{force: true});
                            }
                        }).prependTo(nb.find('ul.dropdown-menu'));
                    }
                }

                // Different tasks for EDU or Starter
				if (app.user.schoolCode.length && app.isEDUTeacher) {
					// there is a school, so need to check the trial status
					// pass whenDone as the callback for all success and fail
					//app.user._trialUpdateStatus(null,function(){
					app.user._requestSchool(null, whenDone, whenDone);
					//},whenDone);
                
                // If not school
				} else if (!app.user.hasOwnProperty('schoolCode') || app.user.schoolCode.length == 0) {
                    
                    // If there is an EDU order in "processing" stage, the account needs to be upgraded to EDU
                    if(app.user.sessionInfo.params.hasOwnProperty('orders')){
                        // go through all orders
                        for(const o in app.user.sessionInfo.params.orders){

                            // Look for type: edu and status: processing 
                            if(app.user.sessionInfo.params.orders[o].status == 'processing' && app.user.sessionInfo.params.orders[o].type == 'edu'){
                                app.user.state['hasEDUOrderProcessing'] = true;
                            }
                        }
                    }


					whenDone();
				}
			},
			whenDone
		);
	};

	this.asl = function () {
		if (this.appshedlogin == "") {
			// Check if there is an appshedlogin in the cookie (user might have logged in)
			if (app.getCookieVal("appshedlogin")) {
				this.appshedlogin = app.utils.urldecode(
					app.getCookieVal("appshedlogin")
				);
			}
		}
		return this.appshedlogin;
	};

	this._getAll = function () {
		try {
			// Get all the properties
			// we Want to do this so that the properties are available "statically" in the app object. This allows GTM to access them without calling methods.
			this.getSchoolId(); // do this first as we might need the output
			this.getEmail();
			this.getId();
			this.getName();
			this.getUsername();
			this.getType();
			//this.getSchoolCode(); this is done by getUsername
		} catch (error) {
			console.error("app.user._getAll", error);
		}
	};

	this._getCookie = function (name) {
		var value = "; " + document.cookie;
		var parts = value.split("; " + name + "=");
		if (parts.length == 2) return parts.pop().split(";").shift();
	};

	this.getEmail = function () {
		// returns the email for the current user, if it exists
		if (this.email == "") {
			if (this.sessionInfo.hasOwnProperty("email") &&
				this.sessionInfo.email.length) {
				this.email = this.sessionInfo.email;
			}

			// if still no email, Check if there is an email in the cookie (user might have logged in)
			if (this.email == "") {
				if (this.asl()) {
					if (/\w@\w/.test(this.asl())) {
						this.email = this.asl();
					}
				}
			}
		}

		// Set the email domain
		this.emailDomain = this.email.replace(/.*@/, "");
		this.emailDomainString = this.emailDomain.replace(/\./g, "_");

		return this.email;
	};

	this.getId = function () {
		// returns the id for the current user, if it exists
		if (this.id == "") {
			if (appbuilder && appbuilder.user && appbuilder.user.id) {
				this.id = appbuilder.user.id;
			}
		}
		return this.id;
	};

	this.getName = function () {
		// returns the id for the current user, if it exists
		if (this.name == "") {
			try {
				this.name = String.trim(
					jQuery(
						".navbar-fixed-top .navbar-inner .nav .dropdown .dropdown-toggle .icon-user"
					)
						.parent()
						.text()
				);
			} catch (er) {
				console.error("app.user.getName", er);
			}
		}
		return this.name;
	};

	this.getSchoolCode = function () {
		// The getUsername method does the heavy lifting and sets SchoolCode if there is on
		this.getUsername();
		return this.schoolCode;
	};

	this.getSchoolId = function () {
		try {
			// If this is an EDU user, there will be a link to the Apps Gallery which contains the school ID
			if (
				app.isEDUUser &&
				jQuery('.navbar-fixed-top ul>li>a[href*="appsgallery"]').length
			) {
				var id = jQuery('.navbar-fixed-top ul>li>a[href*="appsgallery"]')
					.attr("href")
					.replace(/.*school=(\d+).*/, "$1");
				if (id && id.length && !isNaN(app.user.schoolId)) {
					// save as a number
					this.schoolId = parseInt(id);
					//app.user.schoolId = parseInt(id);
				}
			}
			return this.schoolId;
		} catch (error) {
			console.error("app.user.getSchoolId", error);
		}
	};

	/*
        Get info from the Joomla server for the current user, based on the session cookie
        Session cookie is named 'fd80d3664c1b48eccd2de275919ca98c'
        This includes params such as  appbuilder-userinfo
        Returns the whole sessionInfo object, 
            or if `key` supplied returns only that value
        `callback` - (Optional) if passed in, this is run once the Ajax call returns.

        Sample
        {
            client: 884009,
            email: "demoedu_demoStudent@no-email.com",
            id: 884208,
            name: "demoedu_demoStudent",
            params: {appbuilder-userinfo: true, is_instructor: false, public-params: Array(0)} // might not all be present
            roles: ['ROLE_USER'],
            username: "demoedu_demoStudent" 
        }
    */
	this._requestSessionUserInfo = function (key, success, fail) {

		try {
			// Force ajax if callback passed in
			if (
				success ||
				!this.sessionInfo ||
				Object.keys(this.sessionInfo).length == 0
			) {

				jQuery.ajax({
                    url:
                        "https://api.appshed.com/user/session?sessionId=" +
                        app.getCookieVal("fd80d3664c1b48eccd2de275919ca98c"),
                    xhrFields: { withCredentials: true },
                })
                .done(function (a, b, c) {
                    // got the sessionInfo with params

                    app.user.sessionInfo = a;

                    // Some extra changes to sessionInfo
                    app.user.sessionInfo.paramsString = JSON.stringify(app.user.sessionInfo.params);
                    app.user.sessionInfo.rolesString = JSON.stringify(app.user.sessionInfo.roles);


					app.setInterval(function(){
						if(app.getCookieVal('mtc_id') != null){
							app.clearInterval('_mtcWaitHandler');
							
							// Look for email_status and email_verified keys - if not present, this is first login
							if(!app.user.sessionInfo.params.hasOwnProperty("email_status")){
								jQuery.ajax({
									url: "https://workflow.appshed.com/webhook/ab9fdf41-592e-42d0-b104-af8e2ce764dc?user_id=" + app.user.id,
									type: "POST",
									xhrFields: { withCredentials: true },
									data: {
										"email":app.user.email,
										"name": app.user.name,
										"user_id":app.user.id,
										"mtc_id":app.getCookieVal('mtc_id')+''
									}
								}).done(function (aa, bb, cc) {
									// The response includes params

									app.user.sessionInfo.params = aa.params ;
									app.user.sessionInfo.paramsString = JSON.stringify( aa.params );

									if (success) {
										success.call(null, a, b, c);
									}
			
								})
							}else{

								// if the email and username don't match, the user probably changed their email.
								// We want to keep these the same, so update the username through a webhook

								/* DEPRECATED - 
								// we can have username not the same. 
								//  changing username makes student accounts incorrect (schoolcode_loginname)


								if(app.user.sessionInfo.email != app.user.sessionInfo.username){

									jQuery.ajax({
										url: "https://workflow.appshed.com/webhook/79cce32d-e656-48b4-9554-0131cd8a9e17",
										type: "POST",
										xhrFields: { withCredentials: true },
										data: {
											"user_id":app.user.id,
											"mtc_id":app.getCookieVal('mtc_id')+''
										}
									}).always(function (aa, bb, cc) {
										if (success) {
											success.call(null, a, b, c);
										}
									}).done(function (aa, bb, cc) {
										// The response includes sessionInfo attributes
										if(aa.hasOwnProperty("sessionInfo") && Object.keys(aa.sessionInfo).length){
											for (const p in aa.sessionInfo) {
												app.user.sessionInfo[p] = aa.sessionInfo[p];
											}

										}

									}).fail(function (aa, bb, cc) {
									})    
									

								}else{
									if (success) {
										success.call(null, a, b, c);
									}        
								}
								*/


								if (success) {
									success.call(null, a, b, c);
								}

							}


						}
					},100,10000,'_mtcWaitHandler')
                

                })
                .fail(function (a, b, c) {
                    if (fail) {
                        fail.call(null, a, b, c);
                    }
                });

				return null; // so we know it didn't get anything
			} else {
				if (this.sessionInfo && key && this.sessionInfo.hasOwnProperty(key)) {
					return this.sessionInfo[key];
				} else {
					return this.sessionInfo;
				}
			}
		} catch (error) {
			console.error("_requestSessionUserInfo", error);
		}
	};

	/*
		user.getType
		Returns a string describing the user type
	*/
	this.getType = function () {
		var rVal = "starter"; // default type

		if (app.isStarter) {
		} else if (app.isEDUStudent && app.isEDUExpired) {
			rVal = "stuexp";
		} else if (app.isEDUStudent) {
			rVal = "stu";
		} else if (app.isTrEDU && app.isEDUExpired) {
			rVal = "treduexp";
		} else if (app.isTrEDU) {
			rVal = "tredu";
		} else if (app.isEDUExpired || !app.isEDUActive) {
			rVal = "eduexp";
		} else if (app.isEDUUser) {
			rVal = "edu";
		}

		// Can add types for teacher, admin and group admin
		this.type = rVal;

		return rVal;
	};

	this.getUsername = function () {
		// returns the  username for the current user. Also sets the schoolCode
		// This method also extracts the schoolCode
		// There are multiple ways to try find the username!!!
		if (this.username == "") {
			// if we have session data, use that
			if (this.sessionInfo.hasOwnProperty("username")) {
				/*
                could include a schoolCode_ (check for existing schoolId)
                could include an email (the email address might also include _ so match first _)
                    username: 'demoedu_demo_edu_appshed@gmail.com' email: 'demoedu@appshed.com''
                Or
                    username: 'demoedu_test', email: 'test@appshed.co'
                Or
                    username: 'my_email@gmail.com', email: 'my_email@gmail.com'
                */

				// This is not valid : the email might have changed so might not match username

				// // if the session email is contained in the session username,
				// if(String(this.sessionInfo.username).indexOf(this.sessionInfo.email)!= -1){
				// 	//  if there is a schoolCode prefix
				// 	if(this.sessionInfo.username.length > this.sessionInfo.email.length && /^\w+_/.test(this.sessionInfo.username) ){

				// 		this.schoolCode = this.sessionInfo.username.replace(/^(\w+)_.*/,"$1");
				// 		this.username = this.sessionInfo.username.replace(/^\w+_(.*)/,"$1");
				// 	}else{
				// 		// No schoolCode so just the username
				// 		this.username = this.sessionInfo.username;
				// 	}
				// }

				if (this.getSchoolId() && this.getSchoolId() > 0) {
					// get the schoolCode appended to the username
					this.schoolCode = this.sessionInfo.username.replace(
						/^(\w+)_.*/,
						"$1"
					);
				}
				// if the username has no email (probably a student) and it has a schoolCode prefix
				else if (
					!/@/.test(this.sessionInfo.username) &&
					/^\w+_/.test(this.sessionInfo.username)
				) {
					this.schoolCode = this.sessionInfo.username.replace(
						/^(\w+)_.*/,
						"$1"
					);
					this.username = this.sessionInfo.username.replace(/^\w+_(.*)/, "$1");
				}

				// if isEDUUser and the username has has a schoolCode prefix
				else if (app.isEDUUser && /^\w+_/.test(this.sessionInfo.username)) {
					this.schoolCode = this.sessionInfo.username.replace(
						/^(\w+)_.*/,
						"$1"
					);
					this.username = this.sessionInfo.username.replace(/^\w+_(.*)/, "$1");
				}
			}

			// if the username is empty, try get it from the UI, nav bar
			if (this.username == "") {
				try {
					var str = jQuery(".navbar .dropdown.user>a")
						.text()
						.replace(/[\n ]/g, "");

					var str = jQuery(".navbar .dropdown.user>a")
						.text()
						.replace(/[\n ]/g, "");
					/* For EDU users, the first part of the appshedlogin MIGHT have the schoolCode,
                        schoolCode_username 
                        But some schools use email addresses, then the username is their email address
                        So won't always get the schoolcode from here
                    */
					if (app.isEDUUser) {
						// If it is of the right format without email @
						if (/^\w+_\w+/.test(str)) {
							this.schoolCode = str.replace(/^(\w+)_.*/, "$1");
							this.username = str.replace(/^\w+_(.*)/, "$1");
						}
					}
				} catch (error) {}
			}

			// If the username is still empty, something went wrong, so use the cookie appshedlogin
			if (this.username == "") {
				// Check if there is an appshedlogin in the cookie (user might have logged in)
				if (this.asl().length) {
					this.username = this.asl();
				}
			}
		}
		return this.username;
	};




    /*
        app.user.isVerified

        Returns: Boolean, true if the user has verfied their email address
    */

    this.isVerified = function(){
    
        try {

            // treat all students as verified (since email not required for student accounts)
            if(app.isEDUStudent){
                return true;
            }

            // check the sessionInfo for email_verified
            if(app.user && app.user.hasOwnProperty("sessionInfo") && app.user.sessionInfo.params.hasOwnProperty("email_verified") && app.user.sessionInfo.params.email_verified == 1){
                return true;
            }

            return false;

        } catch (error) {
            console.error('app.user.isVerified ',error)
        }
    
        return false;
    }
    
    

	/*
        requestSchool
        This method makes an AJAX request for the school data
        It uses the current user to find the school
    */
	this._requestSchool = function (options, success, fail) {
		var options = options || {};

		return app._request(
			"school",
			options,
			function (a, b, c) {
				// success callback

				try {
					// the response is in param a
					var resp = JSON.parse(a).results[0].json;

					// put all the properties into the school
					for (const p in resp) {
						//console.warn(`${p}: ${resp[p]}`);
						// modify some values
						var val = resp[p];

						switch (p) {
							case "enddate":
								val = new Date(val); // save enddate as a Date object
								break;

							default:
								break;
						}

						// add the property to the school object
						app.user.school[p] = val;
					}

					// Some state checks
					app.isEDUExpired = app.user.school.enddate.valueOf() < Date.now();
					app.isTrEDU = app.user.school.trial == 1;
					app.user.school.trialInfo.daysRemaining = Math.round(
						(app.user.school.enddate - Date.now()) / (24 * 60 * 60 * 1000)
					);
					if (app.user.school.trialInfo.daysRemaining < 0) {
						app.user.school.trialInfo.daysRemaining = 0;
					}
				} catch (error) {
					console.warn("ERROR _requestSchool callback", error);
				}

				if (success) {
					success.call(a, b, c);
				}
			},
			fail
		);
	};

	/*
        this._requestTrialLogs
        Get the status of the trial for the current user
        Parameters
            `options` - (optional) object
                {

                }
            `calback` - function called when the AJAX call returns
        Returns
                boolean - true if the request was made. 
                    NOTE: this does not mean the trial is given, just that the request was made.
                    This starts an asynchronous request via AJAX
                    
    */
	this._requestTrialLogs = function (options, success, fail) {
		var options = options || {};

		return app._request(
			"trialLogs",
			options,
			function (a, b, c) {
				try {
					var resp = JSON.parse(a);

					// save the logs
					app.user.school.trialInfo.logs = resp;

					if (success) {
						success.call(null, a, b, c);
					}
				} catch (error) {
					console.error("app.user._requestTrialLogs", error);
				}
			},
			fail
		);
	};

	this._resetFromSessionInfo = function () {
		try {
			// reset all properties
			// This is used when we want to refersh values based on ajax session call
			this.appshedlogin = "";
			this.email = "";
			this.emailDomain = "";
			this.emailDomainString = "";
			this.id = "";
			this.name = "";
			this.schoolCode = "";
			this.type = "";
			this.username = "";

			this._getAll();
		} catch (error) {
			console.error("app.user._resetFromSessionInfo", error);
		}
	};

	/*
        setTrialInfo
        Set the properties of the trial in this.school
        If the trial status has changed, carry out neccesary actions
        Params
            `props` - the properties of the trial
    */
	this.trialSetInfo = function (props) {
		// Set the school properties
		for (const p in props) {
			this.school.trialInfo[p] = props[p];
		}
	};

	this._trialUpdateStatus = function (options, success, fail) {
		// get the status, and then process the log files

		this._requestTrialLogs(
			options,
			function (a, b, c) {
				try {
					var resp = JSON.parse(a);

					// save the logs
					app.user.school.trialInfo.logs = resp;

					if (c.status == 200) {
						if (resp.hasOwnProperty("results") && resp.results.length) {
							jQuery(resp.results).each((i, val) => {
								// 3002 is Free trial assigned to school
								if (val.json.type == 3002) {
									if (val.json.integer3 > 0) {
										// integer3 is the duration

										// set the isTrEDU - even if the trial is expired, or upgraded, we know they had a trial sometime
										//app.isTrEDU = true;

										var trStart = new Date(val.json.createdtime);
										var trEnd = new Date(trStart.valueOf());
										trEnd.setDate(trEnd.getDate() + 5);

										// if we have an end date, break. any other trial will be ignored, superseded by this one
										app.user.trialSetInfo({
											requestedById: val.json.integer1,
											schoolId: val.json.integer2,
											duration: val.json.integer3,
											startDate: trStart,
											endDate: trEnd,
											active: trEnd > new Date(), // true if end date in the future
										});
									}

									return false;
								} else {
								}
							});
						}
					}
				} catch (er) {
					console.warn("ERROR", er);
				}

				if (success) {
					success.call(null, a, b, c);
				}
			},
			fail
		);
	};

	/*
        this.trialRequest
        Request a trial subscription for the current user
        To check the status of a trial request use this._requestTrialLogs
        Parameters
            `options` - (optional) object
                {

                }
            `calback` - function called when the AJAX call returns
                Passed the parameters from done(a,b,c)
        Returns
                jqXHR - the AJAX request object (or null if failed)
                    NOTE: this does not mean the trial is given, just that the request was made.
                    This starts an asynchronous request via AJAX
                    
    */
	this.trialRequest = function (options, success, fail) {
		// only request trial under certain conditions
		if (app.isEDUUser && !app.isEDUActive) {
			// Show a message in the resources
			if (jQuery(".resources-home-top-tredurequest-container").length == 0) {
				jQuery(
					'<div class="mt-dwc resources-home-top-tredurequest-container"><div data-slot="dwc" data-param-slot-name="resources-home-top-tredurequest"></div></div>'
				).prependTo(
					'.as-edu-popup-tab-container[data-tab="home"] .as-edu-popup-content'
				);
			}

			// hide the normal EDU expired content while requesting trial
			jQuery(".mt-dwc.resources-home-top-eduexp-container").hide();
			jQuery(".mt-dwc.resources-home-top-treduexp-container").hide();

			app._mtLoadDWC("resources-home-top-tredurequest");

			// make a trial request
			app._request(
				"trialRequest",
				null,
				function () {
					// reload the home tab

					var trialNotActivated = function () {
						// show the original containers
						jQuery(".mt-dwc.resources-home-top-eduexp-container").show();
						jQuery(".mt-dwc.resources-home-top-treduexp-container").show();
						// hide the trrequest container
						jQuery(".mt-dwc.resources-home-top-tredurequest-container").hide();
					};

					// set up an interval to look for the trial enabled.
					// could take quite a few seconds. Fallback after timeout
					app.setInterval(
						function () {
							// Check the Trial status

							app.user._trialUpdateStatus(null, function (a, b, c) {
								// success

								// if the trial was activated, and it has days remaining. (it's possible that the trial was reduced, which would make it "active" with 0 days remaining)
								if (app.user.school.trialInfo.active) {
									// get the latest school info
									app.user._requestSchool(null, function () {
										if (
											app.user.school.trial &&
											app.user.school.trialInfo.daysRemaining > 0
										) {
											app.updateState();
											app._resourcepanelInit({ reload: true });
											if (
												confirm(
													"Your EDU Trial is now active. Refresh the browser to activate all features."
												)
											) {
												window.location.reload();
											}
										}
									});
								} else {
									// Something about the trial is not valid, so show expired message
									// Let the interval continue, it can take a while
								}
							});
						},
						3000,
						30000,
						"trialRequestStatusCheck",
						function () {
							//after timeout
							trialNotActivated.call();
						}
					);

					if (success) {
						success.call();
					}
				},
				fail
			);
		}
	};
} // END AppShedUser Object


/* 
========================================================================================================
        GLOBAL SETUP TASKS
========================================================================================================
*/

// The standard Mautic call. This will initiate Mautic campaign acitons, Focus Items etc
//mt('send', 'pageview');

mt(
	"send",
	"pageview",
	{},
	{
		onload: function () {
			if(!(!app || !app._mtSendOnLoad)){ // only do if the function exists/ready
				app._mtSendOnLoad();
			}
		},
		onerror: function () {
			if(!(!app || !app._mtSendOnError)){ // only do if the function exists/ready
				app._mtSendOnError();
			}
		},
	}
);

/*
 Save the original hash
 The built in code will change it to /1/1... but it might contain courses or something else
*/
localStorage["original_hash"] = window.location.hash;

// Set product based on URL parameter
// If the product is passed as a URL parameter, save it in local storage
// e.g. ?product=gamemaker
if (typeof jQuery !== "undefined") {
	jQuery.each(
		String(window.location.search).replace(/\?/, "").split("&"),
		function (i, val) {
			if (val.split("=")[0] == "product") {
				localStorage["product"] = val.split("=")[1];
			}
		}
	);
}
